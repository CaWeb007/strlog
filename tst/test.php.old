<?
require($_SERVER["DOCUMENT_ROOT"]."/bitrix/header.php");
$APPLICATION->SetTitle("Title");
?><?
/*$NS['custom']['lastId'] = 21379;
$arFilter = array(
			'IBLOCK_ID' => 16,
			'ACTIVE' => 'Y'
		);

		$res = CIBlockElement::GetList(array('ID' => 'ASC'), array_merge($arFilter, array('ID' => $NS['custom']['lastId'])), false, false, ['ID','XML_ID','PROPERTY_CML2_TRAITS']);
		$errorMessage = null;
	 $VALUES = "";
    $res = CIBlockElement::GetProperty(16, 21379, "sort", "asc", array("CODE" => "CML2_TRAITS"));
    while ($ob = $res->GetNext())
    {
		if($ob["DESCRIPTION"] === "ВидНоменклатуры"){
			$VALUES = $ob['VALUE'];
			var_dump("<pre>",$VALUES);
		}//$ob['VALUE'];

		//	while ($arItem = $res->Fetch()) {


			/*
			// Что-нибудь делаем
			if (updateElement($arItem['ID']) === false) {
				$error = true;
			}
			*
			$arItem["PROPERTY_OBEM_M3_VALUE"] = (float)$arItem["PROPERTY_OBEM_M3_VALUE"];
			if($arItem["PROPERTY_OBEM_M3_VALUE"]>0 && $arItem['ID']>0){
				$totalQuantity = 0;
				$itemStore = [];
				$rsStore = \CCatalogStoreProduct::GetList(array(), array('PRODUCT_ID' =>$arItem['ID']), false, false, array('ID','STORE_ID','AMOUNT')); 
				while($arStore = $rsStore->Fetch())
				{   
					$arStore['AMOUNT'] = (float)$arStore['AMOUNT'];
					if($arStore['AMOUNT'] > 0){
						if(fmod($arStore['AMOUNT'], 1)!==0){
							$itemStore[$arStore['ID']] = [
								'AMOUNT' => $arStore['AMOUNT'],
								'STORE_ID' => $arStore['STORE_ID']
							];
						} else {
							$totalQuantity += $arStore['AMOUNT'];
						}
					}
				}
	
				if(count($itemStore)>0){
	
					$V = (float)$arItem["PROPERTY_OBEM_M3_VALUE"];

					if($V>0){
						foreach($itemStore as $sID=>$ST){
							$amount = $ST['AMOUNT']/$V;
							$arFields = Array(
								"PRODUCT_ID" => $arItem['ID'],
								"STORE_ID" => $ST['STORE_ID'],
								"AMOUNT" => $amount
							);
							if($amount > 0) {
								$totalQuantity += $amount;
								$Update = \CCatalogStoreProduct::Update($sID, $arFields);
							}
						}
	
						if($totalQuantity>0){
							$arFields = array('QUANTITY' => $totalQuantity);
							\CCatalogProduct::Update($arItem['ID'], $arFields);
						}
					}
				}

			}
*/


		}
/*global $USER, $DB;
$user = new CUser;
$res = CUser::GetList(($by="id"), ($order="asc"));
	while ($row = $res->Fetch()) {
		//$strSql = "UPDATE b_user SET `PERSONAL_PROFESSION` = 'КП(ФИЗ)' WHERE `id` = '".$row['ID']."';";
		//$res = $DB->Query($strSql, false);
		$ID = $row['ID'];
		$fields = Array( 
			"PERSONAL_PROFESSION" => 'КП(ФИЗ)', 
		); 
		$user->Update($ID, $fields);
	}
*/

// Выведем все свойства заказа с кодом $ID, сгруппированые по группам свойств


/*
$ID = 22;

$db_sales = CSaleOrderUserProps::GetList(
        array("DATE_UPDATE" => "DESC"),
        array("USER_ID" => $USER->GetID())
    );

while ($ar_sales = $db_sales->Fetch())
{
	echo"</pre><pre>"; print_r($ar_sales); echo "<br>";
	$db_propVals = CSaleOrderUserPropsValue::GetList(array("ID" => "ASC"), Array("USER_PROPS_ID"=>$ar_sales['ID']),false,false,['USER_PROPS_ID']);
	while ($arPropVals = $db_propVals->Fetch())
	{
	print_r($arPropVals);
	}
}
*/
/*
$obProps = Bitrix\Sale\Internals\OrderPropsValueTable::getList(array('filter' => array('ORDER_ID' => $ID)));
while($prop = $obProps->Fetch()){
   echo $prop['NAME'].': '.$prop['VALUE']."<br>";
}
/*
$db_props = CSaleOrderPropsValue::GetOrderProps($ID);
$iGroup = -1;
while ($arProps = $db_props->Fetch())
{
   if ($iGroup!=IntVal($arProps["PROPS_GROUP_ID"]))
   {
      echo "<b>".$arProps["GROUP_NAME"]."</b><br>";
      $iGroup = IntVal($arProps["PROPS_GROUP_ID"]);
   }

   echo $arProps["NAME"].": ";

   if ($arProps["TYPE"]=="CHECKBOX")
   {
      if ($arProps["VALUE"]=="Y")
         echo "Да";
      else
         echo "Нет";
   }
   elseif ($arProps["TYPE"]=="TEXT" || $arProps["TYPE"]=="TEXTAREA")
   {
      echo htmlspecialchars($arProps["VALUE"]);
   }
   elseif ($arProps["TYPE"]=="SELECT" || $arProps["TYPE"]=="RADIO")
   {
      $arVal = CSaleOrderPropsVariant::GetByValue($arProps["ORDER_PROPS_ID"], $arProps["VALUE"]);
      echo htmlspecialchars($arVal["NAME"]);
   }
   elseif ($arProps["TYPE"]=="MULTISELECT")
   {
      $curVal = split(",", $arProps["VALUE"]);
      for ($i = 0; $i<count($curVal); $i++)
      {
         $arVal = CSaleOrderPropsVariant::GetByValue($arProps["ORDER_PROPS_ID"], $curVal[$i]);
         if ($i>0) echo ", ";
         echo htmlspecialchars($arVal["NAME"]);
      }
   }
   elseif ($arProps["TYPE"]=="LOCATION")
   {
      $arVal = CSaleLocation::GetByID($arProps["VALUE"], LANGUAGE_ID);
      echo htmlspecialchars($arVal["COUNTRY_NAME"]." - ".$arVal["CITY_NAME"]);
   }

   echo "<br>";
}*/

/*
if($USER->IsAdmin() && 3 > 2){
	require_once ($_SERVER["DOCUMENT_ROOT"]."/bitrix/modules/main/classes/general/csv_data.php");
	$csvFile = new CCSVData('R', true);
	$csvFile->LoadFile($_SERVER['DOCUMENT_ROOT']."/export_users.csv");
	$csvFile->SetDelimiter(';');
	
	$userAdd = new CUser;
	while ($row = $csvFile->Fetch()) {
		//var_dump($row);break;
			$userAddFields = array(
				"LID" => "ru",
				"ACTIVE" => "Y",
				"PASSWORD" => "01012018",
				"CONFIRM_PASSWORD" => "01012018",
	
				//'ID' => $row[0],
				'LOGIN' => $row[2],
				'ACTIVE' => $row[5],
				'NAME' => $row[6],
				'LAST_NAME' => $row[7],
				'EMAIL' => $row[8],
				"GROUP_ID" => array(2, 3, 4, 5, 6, 9),
				'PERSONAL_GENDER' => $row[10],
				'PERSONAL_PHONE' => $row[11],
				'PERSONAL_BIRTHDAY' => $row[12],
				'UF_BONUS' => $row[14],
				'UF_BONUS_PARTNER' => $row[15],
				'UF_CONFIRM_PHONE' => $row[16],
				'UF_LEGAL_FORM' => 1
			);
		$ID = $userAdd->Add($userAddFields);
		
		if(intval($ID) > 0){
			echo " Пользователь ".$row[6]." с ИД: ".$ID." успешно добавлен"."<br>";
		} else {
			echo " Ошибка добавления пользователя ".$row[6].": " . $userAdd->LAST_ERROR ."<br>";
		}
	
		global $DB;
		
		$strSql = "UPDATE b_user SET `password` = '".$row[3]."', "
								  ." `checkword` = '".$row[4]."', "
								  ." `checkword_time` = '".$row[13]."', "
								  ." `date_register` = '".$row[9]."', "
								  ." `timestamp_x` = '".$row[1]."', "
			//." `id` = '".$row[0]."', "
								  ." `PERSONAL_PROFESSION` = 'КП(ФИЗ)' "
								  ." WHERE `login` = '".$row[2]."';";
		$res = $DB->Query($strSql, false);
	
		if($res){
			echo " Пароль пользователя ".$row[6]." с ИД: ".$ID." успешно обновлен"."<br>";
		} else {
			echo " Ошибка обновления пользователя ".$row[6]." с ИД: ".$ID.""."<br>";
		}
	
	
	}
}*/

?><?require($_SERVER["DOCUMENT_ROOT"]."/bitrix/footer.php");?>