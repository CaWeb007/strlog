BX.namespace("BX.Sale.component.location.selector"),void 0===BX.Sale.component.location.selector.steps&&void 0!==BX.ui&&void 0!==BX.ui.widget&&(BX.Sale.component.location.selector.steps=function(e,t){this.parentConstruct(BX.Sale.component.location.selector.steps,e),BX.merge(this,{opts:{bindEvents:{"after-select-item":function(e){"string"==typeof this.opts.callback&&0<this.opts.callback.length&&this.opts.callback in window&&window[this.opts.callback].apply(this,[e,this])}},disableKeyboardInput:!1,dontShowNextChoice:!1,pseudoValues:[],provideLinkBy:"id"},vars:{cache:{nodesByCode:{}}},sys:{code:"slst"}}),this.handleInitStack(t,BX.Sale.component.location.selector.steps,e)},BX.extend(BX.Sale.component.location.selector.steps,BX.ui.chainedSelectors),BX.merge(BX.Sale.component.location.selector.steps.prototype,{init:function(){this.pushFuncStack("buildUpDOM",BX.Sale.component.location.selector.steps),this.pushFuncStack("bindEvents",BX.Sale.component.location.selector.steps)},buildUpDOM:function(){},bindEvents:function(){var e=this;this.opts.disableKeyboardInput&&this.bindEvent("after-control-placed",function(e){var t=e.getControl();BX.unbindAll(t.ctrls.toggle),BX.bind(t.ctrls.scope,"click",function(e){t.toggleDropDown()})}),BX.bindDelegate(this.getControl("quick-locations",!0),"click",{tag:"a"},function(){e.setValueByLocationId(BX.data(this,"id"))})},setValueByLocationId:function(e){BX.Sale.component.location.selector.steps.superclass.setValue.apply(this,[e])},setValueByLocationCode:function(o){var s=this.vars;if(null==o||0==o||void 0===o||0==o.toString().length)return this.displayRoute([]),this.setValueVariable(""),this.setTargetValue(""),void this.fireEvent("after-clear-selection");this.fireEvent("before-set-value",[o]);var e=new BX.deferred,t=this;e.done(BX.proxy(function(e){this.displayRoute(e);var t=s.cache.nodesByCode[o].VALUE;s.value=t,this.setTargetValue(this.checkCanSelectItem(t)?t:this.getLastValidValue())},this)),e.fail(function(e){"notfound"==e&&(t.displayRoute([]),t.setValueVariable(""),t.setTargetValue(""),t.showError({errors:[t.opts.messages.nothingFound],type:"server-logic",options:{}}))}),this.hideError(),this.getRouteToNodeByCode(o,e)},setValue:function(e){"id"==this.opts.provideLinkBy?BX.Sale.component.location.selector.steps.superclass.setValue.apply(this,[e]):this.setValueByLocationCode(e)},setTargetValue:function(e){this.setTargetInputValue("code"==this.opts.provideLinkBy?e?this.vars.cache.nodes[e].CODE:"":e),this.fireEvent("after-select-item",[e])},getValue:function(){return"id"==this.opts.provideLinkBy?!1===this.vars.value?"":this.vars.value:this.vars.value?this.vars.cache.nodes[this.vars.value].CODE:""},getNodeByLocationId:function(e){return this.vars.cache.nodes[e]},getSelectedPath:function(){var e=this.vars,t=[];if(void 0===e.value||0==e.value||""==e.value)return t;if(void 0!==e.cache.nodes[e.value])for(var o=e.cache.nodes[e.value];void 0!==o;){var s=BX.clone(o),i=s.PARENT_VALUE;if(delete s.PATH,delete s.PARENT_VALUE,delete s.IS_PARENT,void 0!==s.TYPE_ID&&void 0!==this.opts.types&&(s.TYPE=this.opts.types[s.TYPE_ID].CODE),t.push(s),void 0===i||void 0===e.cache.nodes[i])break;o=e.cache.nodes[i]}return t},setInitialValue:function(){!1!==this.opts.selectedItem?this.setValueByLocationId(this.opts.selectedItem):0<this.ctrls.inputs.origin.value.length&&("id"==this.opts.provideLinkBy?this.setValueByLocationId(this.ctrls.inputs.origin.value):this.setValueByLocationCode(this.ctrls.inputs.origin.value))},getRouteToNodeByCode:function(o,s){var i=this.vars,n=this;if(void 0!==o&&!1!==o&&0<o.toString().length){var a=[];void 0!==i.cache.nodesByCode[o]&&(a=this.getRouteToNodeFromCache(i.cache.nodesByCode[o].VALUE)),0==a.length?n.downloadBundle({request:{CODE:o},callbacks:{onLoad:function(e){for(var t in e)void 0===i.cache.links[t]&&(i.cache.incomplete[t]=!0);n.fillCache(e,!0),a=[],void 0!==i.cache.nodesByCode[o]&&(a=this.getRouteToNodeFromCache(i.cache.nodesByCode[o].VALUE)),0==a.length?s.reject("notfound"):s.resolve(a)},onError:function(){s.reject("internal")}},options:{}}):s.resolve(a)}else s.resolve([])},addItem2Cache:function(e){this.vars.cache.nodes[e.VALUE]=e,this.vars.cache.nodesByCode[e.CODE]=e},controlChangeActions:function(e,t){var o=this,s=this.opts,i=this.vars;this.ctrls;if(this.hideError(),0==t.length)o.truncateStack(e),i.value=o.getLastValidValue(),o.setTargetValue(i.value),this.fireEvent("after-select-real-value");else if(BX.util.in_array(t,s.pseudoValues))o.truncateStack(e),o.setTargetValue(o.getLastValidValue()),this.fireEvent("after-select-item",[t]),this.fireEvent("after-select-pseudo-value");else{var n=i.cache.nodes[t];if(void 0===n)throw new Error("Selected node not found in the cache");o.truncateStack(e),s.dontShowNextChoice?n.IS_UNCHOOSABLE&&o.appendControl(t):(void 0!==i.cache.links[t]||n.IS_PARENT)&&o.appendControl(t),o.checkCanSelectItem(t)&&(i.value=t,o.setTargetValue(t),this.fireEvent("after-select-real-value"))}},refineRequest:function(e){var t={},o={VALUE:"ID",DISPLAY:"NAME.NAME",1:"TYPE_ID",2:"CODE"},s={};return void 0!==e.PARENT_VALUE&&(t["=PARENT_ID"]=e.PARENT_VALUE,o[10]="IS_PARENT"),void 0!==e.VALUE&&(t["=ID"]=e.VALUE,s[1]="PATH"),BX.type.isNotEmptyString(e.CODE)&&(t["=CODE"]=e.CODE,s[1]="PATH"),BX.type.isNotEmptyString(this.opts.query.BEHAVIOUR.LANGUAGE_ID)&&(t["=NAME.LANGUAGE_ID"]=this.opts.query.BEHAVIOUR.LANGUAGE_ID),BX.type.isNotEmptyString(this.opts.query.FILTER.SITE_ID)&&(void 0===this.vars.cache.nodes[e.PARENT_VALUE]||this.vars.cache.nodes[e.PARENT_VALUE].IS_UNCHOOSABLE)&&(t["=SITE_ID"]=this.opts.query.FILTER.SITE_ID),{select:o,filter:t,additionals:s,version:"2"}},refineResponce:function(e,t){if(0==e.length)return e;if(void 0!==t.PARENT_VALUE){var o={};o[t.PARENT_VALUE]=e.ITEMS,e=o}else if(void 0!==t.VALUE||void 0!==t.CODE){var s={};if(void 0!==e.ITEMS[0]&&void 0!==e.ETC.PATH_ITEMS){for(var i=0,n=e.ITEMS[0].PATH.length-1;0<=n;n--){var a=e.ITEMS[0].PATH[n],r=e.ETC.PATH_ITEMS[a];r.IS_PARENT=!0,s[i]=[r],i=r.VALUE}s[i]=[e.ITEMS[0]]}e=s}return e},showError:function(e){"server-logic"!=e.type&&(e.errors=[this.opts.messages.error]),this.ctrls.errorMessage.innerHTML='<p><font class="errortext">'+BX.util.htmlspecialchars(e.errors.join(", "))+"</font></p>",BX.show(this.ctrls.errorMessage),BX.debug(e)}}));