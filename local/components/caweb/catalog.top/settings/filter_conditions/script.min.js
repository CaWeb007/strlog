function initFilterConditionsControl(b){var a=JSON.parse(b.data);if(a){window["filter_conditions_"+b.propertyID]=new FilterConditionsParameterControl(a,b)}}function FilterConditionsParameterControl(c,d){var a=BX.util.getRandomString(5),b=this;this.params=d||{};this.message=JSON.parse(d.propertyParams.JS_MESSAGES)||{};this.data=c||{};this.nodes={};this.ids={form:"limit_cond_form_"+this.params.propertyID+"_"+a,container:"limit_cond_container_"+this.params.propertyID+"_"+a,treeObject:"limit_cond_obj_"+this.params.propertyID+"_"+a};this.path=this.getPath();this.buildNodes();BX.addCustomEvent("onTreeConditionsInit",BX.proxy(this.modifyTreeParams,this));BX.addCustomEvent("onAdminTabsDeleteLevel",BX.proxy(this.onChangeForm,this));BX.addCustomEvent("onNextVisualChange",BX.proxy(this.onChangeForm,this));BX.addCustomEvent("onTreeCondPopupClose",BX.proxy(this.onChangeForm,this));BX.addCustomEvent("onTreeCondItemDelete",BX.proxy(this.onChangeForm,this));BX.addCustomEvent("onWindowClose",BX.proxy(this.onChangeForm,this));BX.loadScript("/bitrix/js/catalog/core_tree.js",function(){BX.ajax({timeout:60,method:"POST",dataType:"html",url:b.path+"/ajax.php",data:{action:"init",condition:b.params.oInput.value,ids:b.ids,sessid:BX.bitrix_sessid()},onsuccess:BX.proxy(this.saveData,this)})});BX.loadCSS("/bitrix/panel/catalog/catalog_cond.css")}FilterConditionsParameterControl.prototype={getPath:function(){var a=this.params.propertyParams.JS_FILE.split("/");a.pop();return a.join("/")},deleteFromArray:function(b,c){if(!BX.type.isArray(b)||!BX.type.isArray(c)){return}for(var a=c.length;--a;){if(!!c[a]&&c.hasOwnProperty(a)){if(BX.util.in_array(a,b)){c.splice(a,1)}}}},onChangeForm:function(){if(!this.nodes.form){return}BX.fireEvent(this.nodes.form,"change")},modifyTreeParams:function(d,a,c){if(!c){return}var b,e,f=[];for(b in c){if(c.hasOwnProperty(b)){e=c[b];if(e.group){this.modifyCondGroup(e)}else{if(this.modifyCondValueGroup(e)){f.push(b)}}}}this.deleteFromArray(f,c)},modifyCondGroup:function(b){var a;if(b.visual){for(a in b.visual.values){if(b.visual.values.hasOwnProperty(a)){if(b.visual.values[a].True==="False"){b.visual.values.splice(a,1);b.visual.logic.splice(a,1)}}}}if(b.control){for(a in b.control){if(b.control.hasOwnProperty(a)){b.control[a].dontShowFirstOption=true;if(b.control[a].id==="True"){delete b.control[a].values.False}}}}},modifyCondValueGroup:function(f){if(!f||!f.children||!f.children.length){return}var e="CondIBProp",d=["CondIBXmlID","CondIBSection","CondIBElement","CondIBDateActiveFrom","CondIBDateActiveTo","CondIBSort","CondIBDateCreate","CondIBCreatedBy","CondIBTimestampX","CondIBModifiedBy","CondIBTags","CondCatQuantity","CondCatWeight"],a,g,c;for(var b in f.children){if(f.children.hasOwnProperty(b)){g=f.children[b];a=true;if(BX.util.in_array(g.controlId,d)){a=false}else{c=g.controlId.split(":");if(c[1]&&c[1]!=this.data.iblockId&&c[1]!=this.data.offersIblockId){return true}if(c[0]===e&&c[2]){a=false}}if(a){delete f.children[b]}}}f.children=f.children.filter(function(h){return h});return false},buildNodes:function(){this.nodes.warning=BX.create("DIV",{props:{className:"bx-filter-conditions-warning"},text:this.message.invalid,style:{display:"none",color:"red"}});this.nodes.container=BX.create("DIV",{props:{id:this.ids.container}});this.nodes.form=BX.create("FORM",{props:{id:this.ids.form,name:this.ids.form},children:[this.nodes.container],events:{change:BX.proxy(function(){this.saveData()},this)}});this.params.oCont.appendChild(BX.create("DIV",{children:[this.nodes.warning,this.nodes.form]}))},saveData:function(){var a={action:"save",ids:this.ids,sessid:BX.bitrix_sessid()};BX.ajax({timeout:60,method:"POST",dataType:"json",url:this.path+"/ajax.php",data:BX.merge(this.getAllFormData(),a),onsuccess:BX.proxy(function(b){if(b===""){this.nodes.warning.style.display="block"}else{this.nodes.warning.style.display="none";this.params.oInput.value=JSON.stringify(b)}},this)})},getAllFormData:function(){var b=BX.ajax.prepareForm(this.nodes.form);for(var a in b.data){if(b.data.hasOwnProperty(a)&&a==""){delete b.data[a]}}return !!b&&b.data?b.data:{}}};