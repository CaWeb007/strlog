var ProfitCalc=function(a){this.wrapper=a.wrapper;this.topBlockWrapper=a.topBlockWrapper;this.cellParams=a.cellParams;this.topBlockParams=a.topBlockParams;this.titleText=a.calcTitleText;this.btnText=a.calcBtnText;this.valueNodeList=[];this.objList=[];this.cellOrderObjList=[];this.isEditableOn=false;this.toggleBtn=null;this.isError=false;this.errorClassName="adm-profit-error";this.init()};ProfitCalc.prototype={init:function(){this.createObjList();this.createObjNodeList();this.createCalcNode();this.firstCounting();this.painting();this.setFixSize()},createObjNodeList:function(){this.budget_1={title:this.cellParams.budget.title,isEditable:true,node:null,getMainObj:BX.proxy(function(){return this.budget},this),field:null};this.clickPrice_2={title:this.cellParams.clickPrice.title,isEditable:true,node:null,getMainObj:BX.proxy(function(){return this.clickPrice},this),field:null};this.amountClicks_3={title:this.cellParams.amountClicks.title,addClass:"adm-profit-calc-cel-yellow",node:null,getMainObj:BX.proxy(function(){return this.amountClicks},this)};this.amountClicks_4={title:this.cellParams.amountClicks.title,node:null,getMainObj:BX.proxy(function(){return this.amountClicks},this)};this.amountOrders_5={title:this.cellParams.amountOrders.title,node:null,getMainObj:BX.proxy(function(){return this.amountOrders},this)};this.conversion_6={title:this.cellParams.conversion.title,isEditable:true,addClass:"adm-profit-calc-cel-yellow",node:null,getMainObj:BX.proxy(function(){return this.conversion},this),field:null};this.grossProfit_7={title:this.cellParams.grossProfit.title,node:null,getMainObj:BX.proxy(function(){return this.grossProfit},this)};this.amountOrders_8={title:this.cellParams.amountOrders.title,node:null,getMainObj:BX.proxy(function(){return this.amountOrders},this)};this.averageBill_9={title:this.cellParams.averageBill.title,isEditable:true,addClass:"adm-profit-calc-cel-red",node:null,getMainObj:BX.proxy(function(){return this.averageBill},this),field:null};this.budget_10={title:this.cellParams.budget.title,node:null,getMainObj:BX.proxy(function(){return this.budget},this)};this.amountOrders_11={title:this.cellParams.amountOrders.title,node:null,getMainObj:BX.proxy(function(){return this.amountOrders},this)};this.orderPrice_12={title:this.cellParams.orderPrice.title,addClass:"adm-profit-calc-cel-red",node:null,getMainObj:BX.proxy(function(){return this.orderPrice},this)};this.budget_13={title:this.cellParams.budget.title,node:null,getMainObj:BX.proxy(function(){return this.budget},this)};this.markup_14={title:this.cellParams.markup.title,isEditable:true,node:null,getMainObj:BX.proxy(function(){return this.markup},this),field:null};this.roi_15={title:this.cellParams.roi.title,addClass:"adm-profit-calc-cel-violet",node:null,getMainObj:BX.proxy(function(){return this.roi},this)};this.other_16={title:this.cellParams.other.title,isEditable:true,node:null,getMainObj:BX.proxy(function(){return this.other},this),field:null};this.cost_17={title:this.cellParams.cost.title,isEditable:true,node:null,getMainObj:BX.proxy(function(){return this.cost},this),field:null};this.cellOrderObjList=[this.budget_1,this.clickPrice_2,this.amountClicks_3,this.amountClicks_4,this.amountOrders_5,this.conversion_6,this.grossProfit_7,this.amountOrders_8,this.averageBill_9,this.budget_10,this.amountOrders_11,this.orderPrice_12,this.budget_13,this.markup_14,this.roi_15,this.other_16,this.cost_17];this.topGrossProfit={node:this.topBlockParams.topGrossProfit,getMainObj:BX.proxy(function(){return this.grossProfit},this)};this.topBudget={node:this.topBlockParams.topBudget,getMainObj:BX.proxy(function(){return this.budget},this)};this.topOther={node:this.topBlockParams.topOther,getMainObj:BX.proxy(function(){return this.other},this)};this.topTotal={node:this.topBlockParams.topTotal,getMainObj:BX.proxy(function(){return this.total},this)};this.topConversion={node:this.topBlockParams.topConversion,getMainObj:BX.proxy(function(){return this.conversion},this)};for(var a=this.cellOrderObjList.length-1;a>=0;a--){this.valueNodeList.push(this.cellOrderObjList[a])}this.valueNodeList.push(this.topGrossProfit);this.valueNodeList.push(this.topBudget);this.valueNodeList.push(this.topOther);this.valueNodeList.push(this.topTotal);this.valueNodeList.push(this.topConversion)},createObjList:function(){this.budget={firstValue:this.cellParams.budget.value,value:this.cellParams.budget.value,getValue:BX.proxy(function(){return this.budget_1.field.value},this),directDependence:BX.proxy(function(){return this.amountClicks},this),isEditable:false};this.objList.push(this.budget);this.clickPrice={firstValue:this.cellParams.clickPrice.value,value:this.cellParams.clickPrice.value,getValue:BX.proxy(function(){return this.clickPrice_2.field.value},this),directDependence:BX.proxy(function(){return this.amountClicks},this),isEditable:false};this.objList.push(this.clickPrice);this.amountClicks={firstValue:null,value:null,round:function(a){return Math.ceil(a)},formula:BX.proxy(function(){return this.clickPrice.value?this.budget.value/this.clickPrice.value:this.budget.value},this),isEditable:false};this.objList.push(this.amountClicks);this.amountOrders={firstValue:this.cellParams.amountOrders.value,value:this.cellParams.amountOrders.value,round:function(a){return Math.ceil(a)},formula:BX.proxy(function(){return this.amountClicks.value?this.conversion.value*this.amountClicks.value/100:this.amountClicks.value},this),isEditable:false};this.objList.push(this.amountOrders);this.conversion={firstValue:null,value:null,round:BX.proxy(function(a){return this.round100(a)},this),formula:BX.proxy(function(){return this.amountClicks.value?this.amountOrders.value/this.amountClicks.value*100:this.amountOrders.value},this),getValue:BX.proxy(function(){return this.conversion_6.field.value},this),directDependence:BX.proxy(function(){return this.amountOrders},this),isEditable:false};this.objList.push(this.conversion);this.grossProfit={firstValue:this.cellParams.grossProfit.value,value:this.cellParams.grossProfit.value,round:function(a){return Math.ceil(a)},formula:BX.proxy(function(){var a;if(this.markup.isActive){a=this.cost.value+(this.cost.value/100*this.markup.value);this.markup.isActive=false;this.averageBill.value=this.amountOrders.value?a/this.amountOrders.value:a;this.averageBill.isEditable=true}else{a=this.averageBill.value*this.amountOrders.value}return a},this),isEditable:false};this.objList.push(this.grossProfit);this.averageBill={firstValue:null,value:null,round:BX.proxy(function(a){return this.round100(a)},this),formula:BX.proxy(function(){return this.amountOrders.value?this.grossProfit.value/this.amountOrders.value:this.grossProfit.value},this),getValue:BX.proxy(function(){return this.averageBill_9.field.value},this),directDependence:BX.proxy(function(){return this.grossProfit},this),isEditable:false};this.objList.push(this.averageBill);this.orderPrice={firstValue:null,value:null,round:BX.proxy(function(a){return this.round100(a)},this),formula:BX.proxy(function(){return this.amountOrders.value?this.budget.value/this.amountOrders.value:this.budget.value},this),isEditable:false};this.objList.push(this.orderPrice);this.markup={firstValue:this.cellParams.markup.value,value:this.cellParams.markup.value,prevValue:this.cellParams.markup.value,getValue:BX.proxy(function(){return this.markup_14.field.value},this),directDependence:BX.proxy(function(){return this.grossProfit},this),isActive:false,isEditable:false};this.objList.push(this.markup);this.cost={firstValue:null,value:null,round:function(a){return Math.round(a)},formula:BX.proxy(function(){return this.grossProfit.value-(this.grossProfit.value/(100+this.markup.value)*this.markup.value)},this),getValue:BX.proxy(function(){return this.cost_17.field.value},this),isEditable:false};this.objList.push(this.cost);this.roi={firstValue:null,value:null,round:BX.proxy(function(a){return this.round100(a)},this),formula:BX.proxy(function(){return this.budget.value||this.other.value?(this.grossProfit.value-this.cost.value)/(this.budget.value+this.other.value)*100:this.grossProfit.value-this.cost.value},this),isEditable:false};this.objList.push(this.roi);this.other={firstValue:this.cellParams.other.value,value:this.cellParams.other.value,getValue:BX.proxy(function(){return this.other_16.field.value},this),isEditable:false};this.objList.push(this.other);this.total={firstValue:null,value:null,round:function(a){return Math.ceil(a)},formula:BX.proxy(function(){return this.grossProfit.value-(this.budget.value+this.other.value)},this),isEditable:false};this.objList.push(this.total)},showFields:function(){for(var a=this.cellOrderObjList.length-1;a>=0;a--){if(this.cellOrderObjList[a].isEditable){this.cellOrderObjList[a].field.style.fontSize=BX.style(this.cellOrderObjList[a].node,"font-size");this.cellOrderObjList[a].field.style.display="block";(function(b){setTimeout(function(){b.style.opacity=1},100)})(this.cellOrderObjList[a].field)}}},hideFields:function(){for(var a=this.cellOrderObjList.length-1;a>=0;a--){if(this.cellOrderObjList[a].isEditable){this.cellOrderObjList[a].field.style.fontSize=BX.style(this.cellOrderObjList[a].node,"font-size");this.cellOrderObjList[a].field.style.display="none";this.cellOrderObjList[a].field.style.opacity=0}}},editToggle:function(){if(!this.isEditableOn){this.isEditableOn=true;BX.addClass(this.toggleBtn,"adm-profit-calc-toggle-active");BX.addClass(this.wrapper,"adm-profit-block-part-active");this.showFields()}else{this.isEditableOn=false;BX.removeClass(this.toggleBtn,"adm-profit-calc-toggle-active");BX.removeClass(this.wrapper,"adm-profit-block-part-active");this.hideFields();this.returnValue()}},toggleButton:function(){this.toggleBtn=BX.create("div",{props:{className:"adm-profit-calc-toggle"},children:[BX.create("span",{props:{className:"adm-profit-calc-toggle-text"},text:this.btnText}),BX.create("span",{props:{className:"adm-profit-calc-toggle-btn"}})]});BX.bind(this.toggleBtn,"click",BX.proxy(this.editToggle,this));return this.toggleBtn},createCalcNode:function(){var f=[];var a=1;var e;var d=BX.create("div",{props:{className:"adm-profit-title-wrap"},children:[BX.create("div",{props:{className:"adm-profit-title adm-profit-title-calc"},text:this.titleText}),this.toggleButton()]});for(var c=0;c<this.cellOrderObjList.length;c++){if(a==1){e=BX.create("div",{props:{className:"adm-profit-calc-row"}});f.push(e)}e.appendChild(this.createCell(this.cellOrderObjList[c]));a=a==3?1:++a}var b=BX.create("div",{props:{className:"adm-profit-calc-block"},children:f});this.wrapper.appendChild(d);this.wrapper.appendChild(b)},setFixSize:function(){var a=[];for(var b=this.cellOrderObjList.length-1;b>=0;b--){a.push({node:this.cellOrderObjList[b].node,maxFontSize:23,smallestValue:true})}a.push({node:this.topGrossProfit.node,maxFontSize:45});a.push({node:this.topBudget.node,maxFontSize:29});a.push({node:this.topOther.node,maxFontSize:29});a.push({node:this.topTotal.node,maxFontSize:45});a.push({node:this.topConversion.node,maxFontSize:19});BX.FixFontSize.init({objList:a,onresize:true})},createField:function(){var a;if(!BX.browser.IsIE8()){a=BX.debounce(this.reCounting,500,this)}else{a=BX.proxy(this.reCounting,this)}return BX.create("input",{props:{type:"text",className:"adm-profit-calc-inp"},events:{keyup:a}})},createCell:function(b){var e,a,g,h,c=[];var d=b.addClass?"adm-profit-calc-cel "+b.addClass:"adm-profit-calc-cel";g=b.isEditable?"adm-profit-calc-cont adm-profit-calc-cont-inp":"adm-profit-calc-cont";var f=BX.create("div",{props:{className:"adm-profit-calc-cel-header"},text:b.title});a=BX.create("div",{props:{className:g}});c.push(f);if(b==this.other_16||b==this.cost_17){d=d+" adm-profit-calc-footer"}if(b.isEditable){e=this.createField();c.push(a,e);b.field=e}else{c.push(a)}b.node=a;return BX.create("div",{props:{className:d},children:c})},round100:function(a){return(Math.ceil(a*100)/100)},firstCounting:function(){for(var a=0;a<this.objList.length;a++){if(this.objList[a].firstValue===null){this.objList[a].value=this.objList[a].firstValue=this.objList[a].formula()}}this.conversion.formula=null;this.averageBill.formula=null},reCounting:function(e){e=e||window.event;var g=e.target||e.srcElement;var c,f=this.validation(g.value);if(!f&&f!==0){BX.addClass(g,this.errorClassName);return}else{BX.removeClass(g,this.errorClassName)}for(var d=this.cellOrderObjList.length-1;d>=0;d--){if(this.cellOrderObjList[d].field==g){c=this.cellOrderObjList[d].getMainObj()}}c.value=f;c.isEditable=true;if(c==this.markup){this.markup.isActive=true}if(c.directDependence){c.directDependence().value=c.directDependence().formula();c.directDependence().isEditable=true}for(var a=0;a<this.objList.length;a++){if(this.objList[a].formula&&!this.objList[a].isEditable){this.objList[a].value=this.objList[a].formula()}else{if(this.objList[a].isEditable){this.objList[a].isEditable=false}}}this.painting()},validation:function(a){a=a.replace(",",".");return parseFloat(a)},painting:function(){for(var b=this.valueNodeList.length-1;b>=0;b--){var a=this.valueNodeList[b].getMainObj();var c=a.value;c=a.round?a.round(c):c;this.valueNodeList[b].node.innerHTML=this.addBit(c.toString());if(this.valueNodeList[b].field){this.valueNodeList[b].field.value=c;if(this.valueNodeList[b]==this.averageBill_9&&this.grossProfit.value===0){this.valueNodeList[b].node.innerHTML=0;this.valueNodeList[b].node.style.transition="none";this.valueNodeList[b].node.style.color="#000";this.valueNodeList[b].field.style.opacity=0}else{this.valueNodeList[b].field.style.opacity=1;this.valueNodeList[b].node.style.color="";this.valueNodeList[b].node.style.transition=""}}}},addBit:function(d){var c=d.indexOf(".");var a=0;var b=c!=-1?c-1:d.length-1;for(b;b>=0;b--){a++;if(a==3){d=d.slice(0,b)+" "+d.slice(b);a=0}}return d},returnValue:function(){for(var d=this.valueNodeList.length-1;d>=0;d--){var c=this.valueNodeList[d].getMainObj();var e=c.firstValue;e=c.round?c.round(e):e;if(this.valueNodeList[d].field){this.valueNodeList[d].field.value=e;BX.removeClass(this.valueNodeList[d].field,this.errorClassName)}this.valueNodeList[d].node.innerHTML=this.addBit(e.toString())}for(var a=this.objList.length-1;a>=0;a--){this.objList[a].value=this.objList[a].firstValue}}};ProfitCalc.create=function(a){return new ProfitCalc(a)};