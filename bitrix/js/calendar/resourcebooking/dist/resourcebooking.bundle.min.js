this.BX=this.BX||{};(function(aa,K,D,ae,i){function G(){var aj=babelHelpers.taggedTemplateLiteral(['<div data-bx-resource-data-wrap="Y"></div>']);ai=function ai(){return aj};return aj}var af=function(){function at(aw){babelHelpers.classCallCheck(this,at);if((this instanceof at?this.constructor:void 0)===at){throw new TypeError("Cannot construct Abstract instances directly")}this.name=null;this.classNames={wrap:aw.wrapClassName||"calendar-resbook-webform-block",innerWrap:"calendar-resbook-webform-block-inner",title:"calendar-resbook-webform-block-title",field:"calendar-resbook-webform-block-field"};this.DOM={outerWrap:aw.outerWrap,wrap:null,dataWrap:null,innerWrap:null,labelWrap:null};this.data=aw.data;this.shown=false}babelHelpers.createClass(at,[{key:"isDisplayed",value:function ai(){return this.data.show!=="N"}},{key:"isShown",value:function aq(){return this.shown}},{key:"display",value:function ao(){this.DOM.wrap=this.DOM.outerWrap.appendChild(K.Dom.create("div",{props:{className:this.classNames.wrap}}));this.DOM.dataWrap=this.DOM.wrap.appendChild(K.Tag.render(G()));if(this.isDisplayed()){this.show({animation:false})}}},{key:"refresh",value:function ap(aw){this.refreshLabel(aw);this.data=aw;if(this.setDataConfig()){if(this.isDisplayed()){this.show({animation:true})}else{this.hide({animation:true})}}this.data=aw}},{key:"setDataConfig",value:function av(){return true}},{key:"refreshLabel",value:function ak(aw){if(this.data.label!==aw.label){K.Dom.adjust(this.DOM.labelWrap,{text:aw.label})}}},{key:"show",value:function au(){if(this.DOM.innerWrap){this.hide()}this.DOM.innerWrap=this.DOM.wrap.appendChild(K.Dom.create("div",{props:{className:this.classNames.innerWrap}}));if(this.data.label||this.label){this.DOM.labelWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:this.classNames.title},text:this.data.label||this.label}))}this.DOM.controlWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:this.classNames.field}}));this.displayControl();this.shown=true}},{key:"hide",value:function am(){K.Dom.remove(this.DOM.innerWrap);this.DOM.innerWrap=null;this.shown=false}},{key:"displayControl",value:function ar(){}},{key:"showWarning",value:function an(aw){if(this.shown&&this.DOM.wrap&&this.DOM.innerWrap){K.Dom.addClass(this.DOM.wrap,"calendar-resbook-webform-block-error");this.displayErrorText(aw||K.Loc.getMessage("WEBF_RES_BOOKING_REQUIRED_WARNING"))}}},{key:"hideWarning",value:function al(){if(this.DOM.wrap){K.Dom.removeClass(this.DOM.wrap,"calendar-resbook-webform-block-error");if(this.DOM.errorTextWrap){K.Dom.remove(this.DOM.errorTextWrap)}}}},{key:"displayErrorText",value:function aj(aw){if(this.DOM.errorTextWrap){K.Dom.remove(this.DOM.errorTextWrap)}this.DOM.errorTextWrap=this.DOM.innerWrap.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-error-text"},text:aw}))}}]);return at}();var W=function(){function aj(ax){babelHelpers.classCallCheck(this,aj);this.id="viewform-dropdown-select-"+Math.round(Math.random()*100000);this.DOM={wrap:ax.wrap};this.maxHeight=ax.maxHeight;this.selectAllMessage=K.Loc.getMessage("WEBF_RES_SELECT_ALL");this.setSettings(ax)}babelHelpers.createClass(aj,[{key:"build",value:function au(){this.DOM.select=this.DOM.wrap.appendChild(K.Dom.create("div",{attrs:{className:"calendar-resbook-webform-block-input calendar-resbook-webform-block-input-dropdown"},events:{click:this.openPopup.bind(this)}}));this.setSelectedValues(this.selected)}},{key:"setSettings",value:function ap(ax){this.handleChangesCallback=K.Type.isFunction(ax.handleChangesCallback)?ax.handleChangesCallback:null;this.values=ax.values;this.selected=!K.Type.isArray(ax.selected)?[ax.selected]:ax.selected;this.multiple=ax.multiple}},{key:"openPopup",value:function am(){if(this.isPopupShown()){return this.closePopup()}var ax=[];this.values.forEach(function(az){var ay="menu-popup-no-icon";if(K.Type.isArray(this.selected)&&this.selected.includes(parseInt(az.id))){ay+=" menu-item-selected"}ax.push({id:az.id,className:ay,text:K.Text.encode(az.title),onclick:this.menuItemClick.bind(this)})},this);if(this.multiple&&ax.length<=1){this.multiple=false}if(this.multiple){ax.push({id:"select-all",text:this.selectAllMessage,onclick:this.selectAllItemClick.bind(this)})}this.popup=i.MenuManager.create(this.id,this.DOM.select,ax,{className:"calendar-resbook-form-popup"+(this.multiple?" popup-window-resource-select":""),closeByEsc:true,autoHide:!this.multiple,offsetTop:0,offsetLeft:0,cacheable:false});this.popup.show(true);this.popupContainer=this.popup.popupWindow.popupContainer;this.popupContainer.style.width=parseInt(this.DOM.select.offsetWidth)+"px";if(this.multiple){this.popup.menuItems.forEach(function(ay){var az;if(ay.id==="select-all"){this.selectAllChecked=!this.values.find(function(aA){return !this.selected.find(function(aB){return aB===aA.id})},this);ay.layout.item.className="menu-popup-item menu-popup-item-resource-all";ay.layout.item.innerHTML='<div class="menu-popup-item-inner"><div class="menu-popup-item-resource"><input class="menu-popup-item-resource-checkbox menu-popup-item-all-resources-checkbox" type="checkbox"'+(this.selectAllChecked?'checked="checked"':"")+' id="'+ay.id+'"><label class="menu-popup-item-text" for="'+ay.id+'">'+ay.text+"</label></div></div>"}else{az=this.selected.find(function(aA){return aA===ay.id});ay.layout.item.className="menu-popup-item";ay.layout.item.innerHTML='<div class="menu-popup-item-inner"><div class="menu-popup-item-resource"><input class="menu-popup-item-resource-checkbox" type="checkbox"'+(az?'checked="checked"':"")+' id="'+ay.id+'"><label class="menu-popup-item-text" for="'+ay.id+'">'+ay.text+"</label></div></div>"}},this);K.Event.unbind(document,"click",this.handleClick.bind(this));setTimeout(function(){K.Event.bind(document,"click",this.handleClick.bind(this))}.bind(this),50)}}},{key:"closePopup",value:function at(){if(this.isPopupShown()){this.popup.close();if(this.multiple){K.Event.unbind(document,"click",this.handleClick.bind(this))}}}},{key:"isPopupShown",value:function al(){return this.popup&&this.popup.popupWindow&&this.popup.popupWindow.isShown&&this.popup.popupWindow.isShown()&&this.popup.popupWindow.popupContainer&&K.Dom.isShown(this.popup.popupWindow.popupContainer)}},{key:"menuItemClick",value:function aq(aC,az){var ay,aB=aC.target||aC.srcElement,ax,aA;if(this.multiple){ax=this.values.find(function(aD){return aD.id==az.id});aA=az.layout.item.querySelector(".menu-popup-item-resource-checkbox");if(ax&&aB&&(K.Dom.hasClass(aB,"menu-popup-item")||K.Dom.hasClass(aB,"menu-popup-item-resource-checkbox")||K.Dom.hasClass(aB,"menu-popup-item-inner"))){if(!K.Dom.hasClass(aB,"menu-popup-item-resource-checkbox")){aA.checked=!aA.checked}if(aA.checked){this.selectItem(ax)}else{this.deselectItem(ax);ay=this.popupContainer.querySelector(".menu-popup-item-all-resources-checkbox");this.selectAllChecked=false;if(ay){ay.checked=false}}this.setSelectedValues(this.selected);this.handleControlChanges()}}else{this.setSelectedValues([az.id]);this.handleControlChanges();this.closePopup()}}},{key:"selectItem",value:function aw(ax){if(!this.selected.includes(ax.id)){this.selected.push(ax.id)}}},{key:"deselectItem",value:function av(ay){var ax=this.selected.indexOf(parseInt(ay.id));if(ax>=0){this.selected=this.selected.slice(0,ax).concat(this.selected.slice(ax+1))}}},{key:"selectAllItemClick",value:function ar(aC,ay){var aB=aC.target||aC.srcElement;if(aB&&(K.Dom.hasClass(aB,"menu-popup-item")||K.Dom.hasClass(aB,"menu-popup-item-resource-checkbox"))){var aA=ay.layout.item.querySelector(".menu-popup-item-resource-checkbox");if(K.Dom.hasClass(aB,"menu-popup-item")){aA.checked=!aA.checked}var ax,az=this.popupContainer.querySelectorAll("input.menu-popup-item-resource-checkbox");this.selectAllChecked=aA.checked;for(ax=0;ax<az.length;ax++){az[ax].checked=this.selectAllChecked}this.selected=[];if(this.selectAllChecked){this.values.forEach(function(aD){this.selected.push(aD.id)},this)}this.setSelectedValues(this.selected);this.handleControlChanges()}}},{key:"handleClick",value:function ao(ax){if(this.isPopupShown()&&!this.popupContainer.contains(ax.target||ax.srcElement)){this.closePopup({animation:true})}this.handleControlChanges()}},{key:"getSelectedValues",value:function an(){return this.selected}},{key:"setSelectedValues",value:function ai(az){var aB,aA,ax=[],ay=[];for(aB=0;aB<az.length;aB++){aA=this.values.find(function(aC){return aC.id===az[aB]});if(aA){ax.push(aA.title);ay.push(aA.id)}}this.selected=ay;K.Dom.adjust(this.DOM.select,{text:ax.length?ax.join(", "):K.Loc.getMessage("USER_TYPE_RESOURCE_LIST_PLACEHOLDER")})}},{key:"handleControlChanges",value:function ak(){if(this.handleChangesCallback){this.handleChangesCallback(this.getSelectedValues())}}}]);return aj}();var n=function(ak){babelHelpers.inherits(al,ak);function al(aq){var ar;babelHelpers.classCallCheck(this,al);ar=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(al).call(this,aq));ar.name="UserSelector";ar.data=aq.data||{};ar.userList=[];ar.userIndex={};ar.values=[];ar.defaultMode="auto";ar.previewMode=aq.previewMode===undefined;ar.autoSelectDefaultValue=aq.autoSelectDefaultValue;ar.changeValueCallback=aq.changeValueCallback;ar.handleSettingsData(ar.data,aq.userIndex);return ar}babelHelpers.createClass(al,[{key:"displayControl",value:function an(){this.selectedValue=this.getSelectedUser();this.dropdownSelect=new W({wrap:this.DOM.controlWrap,values:this.userList,selected:this.selectedValue,handleChangesCallback:this.handleChanges.bind(this)});this.dropdownSelect.build()}},{key:"refresh",value:function ao(ar,aq){this.refreshLabel(ar);this.data=ar;this.handleSettingsData(this.data,aq);this.selectedValue=this.getSelectedUser();if(this.dropdownSelect){this.dropdownSelect.setSettings({values:this.userList,selected:this.selectedValue})}if(this.setDataConfig()){if(this.isDisplayed()){this.show({animation:true})}else{this.hide({animation:true})}}}},{key:"handleSettingsData",value:function ai(ar,aq){if(K.Type.isPlainObject(aq)){for(var av in aq){if(aq.hasOwnProperty(av)){this.userIndex[av]=aq[av]}}}this.defaultMode=this.data.defaultMode==="none"?"none":"auto";var at=[];this.userList=[];if(this.data.value){var au=K.Type.isArray(this.data.value)?this.data.value:this.data.value.split("|");au.forEach(function(aw){aw=parseInt(aw);if(aw>0){at.push(aw);if(this.userIndex[aw]){this.userList.push({id:aw,title:this.userIndex[aw].displayName})}}},this)}this.values=at}},{key:"getSelectedUser",value:function aj(){var aq=null;if(this.dropdownSelect){aq=this.dropdownSelect.getSelectedValues();aq=K.Type.isArray(aq)&&aq.length?aq[0]:null}if(!aq&&this.previewMode&&this.data.defaultMode==="auto"&&this.userList&&this.userList[0]){aq=this.userList[0].id}if(!aq&&this.autoSelectDefaultValue){aq=this.autoSelectDefaultValue}return aq}},{key:"setSelectedUser",value:function am(aq){if(this.dropdownSelect){this.dropdownSelect.setSelectedValues([aq])}else{this.autoSelectDefaultValue=parseInt(aq)}}},{key:"handleChanges",value:function ap(aq){if(!this.previewMode&&K.Type.isFunction(this.changeValueCallback)){this.changeValueCallback(aq[0]||null)}}}]);return al}(af);var y=function(al){babelHelpers.inherits(ao,al);function ao(aq){var ar;babelHelpers.classCallCheck(this,ao);ar=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(ao).call(this,aq));ar.name="ResourceSelector";ar.data=aq.data;ar.allResourceList=aq.resourceList;ar.autoSelectDefaultValue=aq.autoSelectDefaultValue;ar.changeValueCallback=aq.changeValueCallback;ar.handleSettingsData(aq.data);return ar}babelHelpers.createClass(ao,[{key:"handleSettingsData",value:function ak(aq){if(!K.Type.isArray(aq.value)){var ar=[];if(aq.value){aq.value.split("|").forEach(function(at){if(parseInt(at)>0){ar.push(parseInt(at))}})}this.data.value=ar}this.resourceList=[];if(K.Type.isArray(this.allResourceList)&&K.Type.isArray(this.data.value)){this.allResourceList.forEach(function(at){if(this.data.value.includes(parseInt(at.id))){this.resourceList.push(at)}},this)}this.setSelectedValues(this.getSelectedValues())}},{key:"displayControl",value:function am(){this.dropdownSelect=new W({wrap:this.DOM.controlWrap,values:this.resourceList,selected:this.selectedValues,multiple:this.data.multiple==="Y",handleChangesCallback:this.changeValueCallback});this.dropdownSelect.build()}},{key:"refresh",value:function an(aq){this.refreshLabel(aq);this.data=aq;this.handleSettingsData(this.data);this.setSelectedValues(this.getSelectedValues());if(this.dropdownSelect){this.dropdownSelect.setSettings({values:this.resourceList,selected:this.selectedValues,multiple:this.data.multiple==="Y"})}if(this.setDataConfig()){if(this.isDisplayed()){this.show({animation:true})}else{this.hide({animation:true})}}}},{key:"getSelectedValues",value:function ap(){var aq=null;if(this.dropdownSelect){aq=this.dropdownSelect.getSelectedValues()}if(!aq&&this.autoSelectDefaultValue){aq=[this.autoSelectDefaultValue]}if(!aq&&this.data.defaultMode==="auto"){if(this.resourceList&&this.resourceList[0]){aq=[this.resourceList[0].id]}}return aq}},{key:"setSelectedValues",value:function aj(aq){this.selectedValues=aq}},{key:"setSelectedResource",value:function ai(aq){if(this.dropdownSelect){this.dropdownSelect.setSelectedValues([aq])}else{this.autoSelectDefaultValue=parseInt(aq);this.selectedValues=[aq]}}}]);return ao}(af);var ag=function(ak){babelHelpers.inherits(am,ak);function am(aq){var ar;babelHelpers.classCallCheck(this,am);ar=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(am).call(this,aq));ar.name="ServiceSelector";ar.data=aq.data;ar.serviceList=[];ar.allServiceList=aq.serviceList||[];ar.values=[];ar.changeValueCallback=K.Type.isFunction(aq.changeValueCallback)?aq.changeValueCallback:null;if(aq.selectedValue){ar.setSelectedService(aq.selectedValue)}ar.handleSettingsData(ar.data);return ar}babelHelpers.createClass(am,[{key:"displayControl",value:function al(){this.dropdownSelect=new W({wrap:this.DOM.controlWrap,values:this.serviceList,selected:this.getSelectedService(),handleChangesCallback:function(aq){if(aq&&aq[0]){this.setSelectedService(aq[0]);if(this.changeValueCallback){this.changeValueCallback()}}}.bind(this)});this.dropdownSelect.build()}},{key:"refresh",value:function an(aq){this.refreshLabel(aq);this.data=aq;this.handleSettingsData(this.data);if(this.dropdownSelect){this.dropdownSelect.setSettings({values:this.serviceList,selected:this.getSelectedService()})}if(this.setDataConfig()){if(this.isDisplayed()){this.show({animation:true})}else{this.hide({animation:true})}}}},{key:"handleSettingsData",value:function aj(){this.serviceIndex={};if(K.Type.isArray(this.allServiceList)){this.allServiceList.forEach(function(ar){if(K.Type.isPlainObject(ar)&&K.Type.isString(ar.name)&&ar.name.trim()!==""){this.serviceIndex[this.prepareServiceId(ar.name)]=ar}},this)}this.serviceList=[];if(this.data.value){var aq=K.Type.isArray(this.data.value)?this.data.value:this.data.value.split("|");aq.forEach(function(at){var ar=this.serviceIndex[this.prepareServiceId(at)];if(K.Type.isPlainObject(ar)&&K.Type.isString(ar.name)&&ar.name.trim()!==""){this.serviceList.push({id:this.prepareServiceId(ar.name),title:ar.name+" - "+E.getDurationLabel(ar.duration)})}},this)}}},{key:"setSelectedService",value:function ap(aq){this.selectedService=aq}},{key:"getSelectedService",value:function ao(aq){return aq!==true?this.selectedService||null:this.serviceIndex[this.prepareServiceId(this.selectedService)]||null}},{key:"prepareServiceId",value:function ai(aq){return E.translit(aq)}}]);return am}(af);var ad=function(ak){babelHelpers.inherits(an,ak);function an(ao){var ap;babelHelpers.classCallCheck(this,an);ap=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(an).call(this,ao));ap.name="DurationSelector";ap.data=ao.data;ap.durationList=E.getDurationList(ao.fullDay);ap.changeValueCallback=ao.changeValueCallback;ap.defaultValue=ao.defaultValue||ap.data.defaultValue;ap.handleSettingsData(ao.data);return ap}babelHelpers.createClass(an,[{key:"handleSettingsData",value:function ai(){this.durationItems=[];if(K.Type.isArray(this.durationList)){this.durationList.forEach(function(ao){this.durationItems.push({id:ao.value,title:ao.label})},this)}}},{key:"displayControl",value:function al(){this.DOM.durationInput=this.DOM.controlWrap.appendChild(K.Dom.create("INPUT",{attrs:{value:this.data.defaultValue||null,type:"text"},props:{className:"calendar-resbook-webform-block-input calendar-resbook-webform-block-input-dropdown"}}));this.durationControl=new J({input:this.DOM.durationInput,values:this.durationList,value:this.data.defaultValue||null,editable:this.data.manualInput==="Y",defaultValue:this.defaultValue,setFirstIfNotFound:true,onChangeCallback:this.changeValueCallback})}},{key:"refresh",value:function am(ao){this.refreshLabel(ao);this.data=ao;this.handleSettingsData(this.data);if(this.setDataConfig()){if(this.isDisplayed()){this.show({animation:true});if(this.durationControl){this.durationControl.setValue(this.data.defaultValue||null)}}else{this.hide({animation:true})}}}},{key:"getSelectedValue",value:function aj(){var ao=null;if(this.durationControl){ao=E.parseDuration(this.durationControl.getValue())}else{ao=parseInt(this.defaultValue)}return ao}}]);return an}(af);function ah(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-arrow-container" \n></div>']);ai=function ai(){return aj};return aj}function a(){var aj=babelHelpers.taggedTemplateLiteral(['<input type="hidden" \nvalue=""/>']);ai=function ai(){return aj};return aj}function d(){var ai=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-date-range-inner-wrap" \n></div>']);aj=function aj(){return ai};return ai}function g(){var ai=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-date-range-static-wrap" \n></div>']);aj=function aj(){return ai};return ai}function L(){var aj=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-strip-arrow calendar-resbook-webform-block-strip-arrow-next" data-bx-resbook-date-meta="next"/>']);ai=function ai(){return aj};return aj}function M(){var aj=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-strip-day"/>']);ai=function ai(){return aj};return aj}function N(){var ai=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-strip-date"/>']);aj=function aj(){return ai};return ai}function O(){var ai=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-strip-text" data-bx-resbook-date-meta="calendar"/>']);aj=function aj(){return ai};return ai}function P(){var ai=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-strip-arrow calendar-resbook-webform-block-strip-arrow-prev" data-bx-resbook-date-meta="previous"/>']);aj=function aj(){return ai};return ai}function Q(){var aj=babelHelpers.taggedTemplateLiteral(['<input type="hidden" \nvalue=""/>']);ai=function ai(){return aj};return aj}function R(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-date"></div>']);ai=function ai(){return aj};return aj}function S(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-inner"></div>']);ai=function ai(){return aj};return aj}function x(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block"></div>']);x=function ai(){return aj};return aj}var U=function(au){babelHelpers.inherits(aj,au);function aj(az){var aA;babelHelpers.classCallCheck(this,aj);aA=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(aj).call(this,az));aA.DOM={outerWrap:az.outerWrap,wrap:null};aA.data=az.data||{};aA.changeValueCallback=az.changeValueCallback;aA.requestDataCallback=az.requestDataCallback;aA.previewMode=az.previewMode===undefined;aA.allowOverbooking=az.allowOverbooking;aA.setDataConfig();aA.displayed=true;return aA}babelHelpers.createClass(aj,[{key:"display",value:function ar(az){az=az||{};this.setDateIndex(az.availableDateIndex);this.setCurrentDate(az.selectedValue);this.DOM.wrap=this.DOM.outerWrap.appendChild(K.Tag.render(x()));this.DOM.innerWrap=this.DOM.wrap.appendChild(K.Tag.render(S()));if(this.data.label){this.DOM.labelWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-title"},text:this.data.label+"*"}))}this.displayControl();this.shown=true}},{key:"refresh",value:function at(az,aA){aA=aA||{};this.setDateIndex(aA.availableDateIndex);this.setCurrentDate(aA.selectedValue);this.data=az;K.Dom.adjust(this.DOM.labelWrap,{text:this.data.label+"*"});if(this.setDataConfig()){K.Dom.remove(this.DOM.controlWrap);this.displayControl()}if(this.style==="line"){this.lineDateControl.refreshDateAvailability()}}},{key:"setDataConfig",value:function ay(){var az=this.data.style==="line"?"line":"popup",aB=this.data.start==="today"?"today":"free",aA=this.style!==az||this.start!==aB;this.style=az;this.start=aB;return aA}},{key:"hide",value:function ap(){K.Dom.remove(this.DOM.innerWrap);this.DOM.innerWrap=null}},{key:"displayControl",value:function av(){this.DOM.controlWrap=this.DOM.innerWrap.appendChild(K.Tag.render(R()));if(this.style==="popup"){this.DOM.controlWrap.className="calendar-resbook-webform-block-calendar";this.popupSateControl=new Z({wrap:this.DOM.controlWrap,isDateAvailable:this.isDateAvailable.bind(this),onChange:function(az){this.onChange(az)}.bind(this)});this.popupSateControl.build();this.popupSateControl.setValue(this.getValue())}else{if(this.style==="line"){this.DOM.controlWrap.className="calendar-resbook-webform-block-date";this.lineDateControl=new c({wrap:this.DOM.controlWrap,isDateAvailable:this.isDateAvailable.bind(this),onChange:this.onChange.bind(this)});this.lineDateControl.build();this.lineDateControl.setValue(this.getValue())}}}},{key:"setCurrentDate",value:function aw(az){if(K.Type.isDate(az)){this.currentDate=az}}},{key:"setDateIndex",value:function al(az){if(K.Type.isPlainObject(az)){this.availableDateIndex=az}}},{key:"isDateLoaded",value:function ao(az){if(K.Type.isDate(az)&&!this.isItPastDate(az)&&this.availableDateIndex){if(this.availableDateIndex[E.formatDate(null,az)]!==undefined){return true}if(K.Type.isFunction(this.requestDataCallback)){this.requestDataCallback({date:az})}}return false}},{key:"isDateAvailable",value:function ax(az){if(this.previewMode||this.allowOverbooking){return true}if(K.Type.isDate(az)&&!this.isItPastDate(az)&&this.availableDateIndex){var aA=E.formatDate(null,az);if(this.availableDateIndex[aA]===undefined){if(K.Type.isFunction(this.requestDataCallback)){this.requestDataCallback({date:az})}return false}else{return this.availableDateIndex[aA]}}return false}},{key:"isItPastDate",value:function ai(aA){if(K.Type.isDate(aA)){var az=new Date(),aB=new Date(aA.getTime());az.setHours(0,0,0,0);aB.setHours(0,0,0,0);return aB.getTime()<az.getTime()}return false}},{key:"refreshCurrentValue",value:function ak(){this.onChange(this.getDisplayedValue())}},{key:"getDisplayedValue",value:function am(){return this.style==="popup"?this.popupSateControl.getValue():this.lineDateControl.getValue()}},{key:"onChange",value:function aq(aA){if(K.Type.isFunction(this.changeValueCallback)){var az=aA;if(!K.Type.isDate(az)){az=this.getDisplayedValue()}this.setCurrentDate(aA);this.changeValueCallback(aA,az,this.isDateAvailable(az))}}},{key:"getValue",value:function an(){if(!this.currentDate){this.currentDate=new Date()}return this.currentDate}}]);return aj}(af);var Z=function(){function ak(at){babelHelpers.classCallCheck(this,ak);this.DOM={outerWrap:at.wrap,wrap:null};this.value=null;this.datePicker=null;this.isDateAvailable=K.Type.isFunction(at.isDateAvailable)?at.isDateAvailable:function(){return true};this.onChange=K.Type.isFunction(at.onChange)?at.onChange:function(){}}babelHelpers.createClass(ak,[{key:"build",value:function ar(){this.DOM.wrap=this.DOM.outerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-strip"},events:{click:this.handleClick.bind(this)}}));this.DOM.valueInput=this.DOM.wrap.appendChild(K.Tag.render(Q()));this.DOM.previousArrow=this.DOM.wrap.appendChild(K.Tag.render(P()));this.DOM.stateWrap=this.DOM.wrap.appendChild(K.Tag.render(O()));this.DOM.stateWrapDate=this.DOM.stateWrap.appendChild(K.Tag.render(N()));this.DOM.stateWrapDay=this.DOM.stateWrap.appendChild(K.Tag.render(M()));this.DOM.nextArrow=this.DOM.wrap.appendChild(K.Tag.render(L()))}},{key:"getValue",value:function al(){return this.value}},{key:"setValue",value:function ai(at){this.value=at;K.Dom.adjust(this.DOM.stateWrapDate,{text:E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_DATE_LINE"),at)});K.Dom.adjust(this.DOM.stateWrapDay,{text:E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_DAY_LINE"),at)});if(!this.isDateAvailable(at)||!K.Type.isDate(at)){this.onChange(false)}else{this.onChange(this.value)}}},{key:"handleClick",value:function am(aw){var at,av=aw.target||aw.srcElement;if(av.hasAttribute("data-bx-resbook-date-meta")||(av=av.closest("[data-bx-resbook-date-meta]"))){var au=av.getAttribute("data-bx-resbook-date-meta");if(au==="previous"){at=this.getValue();at.setDate(at.getDate()-1);this.setValue(at)}else{if(au==="next"){at=this.getValue();at.setDate(at.getDate()+1);this.setValue(at)}else{if(au==="calendar"){this.openCalendarPopup()}}}}}},{key:"openCalendarPopup",value:function aj(){this.DOM.valueInput.value=E.formatDate(null,this.getValue().getTime()/1000);if(ak.isExternalDatePickerEnabled()){this.openExternalDatePicker()}else{this.openBxCalendar()}}},{key:"openBxCalendar",value:function an(){BX.calendar({node:this.DOM.stateWrap,field:this.DOM.valueInput,bTime:false});if(BX.calendar.get().popup){E.unbindCustomEvent(BX.calendar.get().popup,"onPopupClose",this.handleCalendarClose.bind(this));E.bindCustomEvent(BX.calendar.get().popup,"onPopupClose",this.handleCalendarClose.bind(this))}}},{key:"handleCalendarClose",value:function ao(){this.setValue(E.parseDate(this.DOM.valueInput.value))}},{key:"openExternalDatePicker",value:function aq(){if(K.Type.isNull(this.datePicker)){this.datePicker=new BX.UI.Vue.Components.DatePick({node:this.DOM.stateWrap,hasTime:false,events:{change:function(at){this.DOM.valueInput.value=at;this.handleCalendarClose()}.bind(this)}})}this.datePicker.value=this.DOM.valueInput.value;this.datePicker.toggle()}}],[{key:"isExternalDatePickerEnabled",value:function ap(){if(K.Type.isNull(ak.externalDatePickerIsEnabled)){ak.externalDatePickerIsEnabled=!!(window.BX&&BX.UI&&BX.UI.Vue&&BX.UI.Vue.Components&&BX.UI.Vue.Components.DatePick)}return ak.externalDatePickerIsEnabled}}]);return ak}();babelHelpers.defineProperty(Z,"externalDatePickerIsEnabled",null);var c=function(){function ax(aA){babelHelpers.classCallCheck(this,ax);aA=aA||{};this.DOM={outerWrap:aA.wrap,wrap:null};this.value=null;this.isDateAvailable=K.Type.isFunction(aA.isDateAvailable)?aA.isDateAvailable:function(){return true};this.onChange=K.Type.isFunction(aA.onChange)?aA.onChange:function(){};this.DAYS_DISPLAY_SIZE=30;this.DOM.dayNodes={};this.dayNodeIndex={}}babelHelpers.createClass(ax,[{key:"build",value:function aw(){this.DOM.monthTitle=this.DOM.outerWrap.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-date-month"}}));this.DOM.wrap=this.DOM.outerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-date-range"},events:{click:this.handleClick.bind(this)}}));this.DOM.controlStaticWrap=this.DOM.wrap.appendChild(K.Tag.render(g()));this.DOM.controlInnerWrap=this.DOM.controlStaticWrap.appendChild(K.Tag.render(d()));this.DOM.valueInput=this.DOM.wrap.appendChild(K.Tag.render(a()));this.fillDays();this.initCustomScroll()}},{key:"fillDays",value:function ap(){var aC,aA=this.getStartLoadDate(),aB=new Date(aA.getTime());for(aC=0;aC<this.DAYS_DISPLAY_SIZE;aC++){this.addDateSlot(aB);aB.setDate(aB.getDate()+1)}this.innerWidth=parseInt(this.DOM.controlInnerWrap.offsetWidth)}},{key:"addDateSlot",value:function al(aA){var aB=E.formatDate("Y-m-d",aA.getTime()/1000);this.dayNodeIndex[aB]=new Date(aA.getTime());this.DOM.dayNodes[aB]=this.DOM.controlInnerWrap.appendChild(K.Dom.create("div",{attrs:{className:"calendar-resbook-webform-block-date-item"+(this.isDateAvailable(aA)?"":" calendar-resbook-webform-block-date-item-off"),"data-bx-resbook-date-meta":aB},html:'<div class="calendar-resbook-webform-block-date-item-inner"><span class="calendar-resbook-webform-block-date-number">'+E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_DATE"),aA)+'</span><span class="calendar-resbook-webform-block-date-day">'+E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_DAY_OF_THE_WEEK"),aA)+"</span></div>"}))}},{key:"refreshDateAvailability",value:function aj(){for(var aA in this.DOM.dayNodes){if(this.DOM.dayNodes.hasOwnProperty(aA)){if(this.isDateAvailable(this.dayNodeIndex[aA])){K.Dom.removeClass(this.DOM.dayNodes[aA],"calendar-resbook-webform-block-date-item-off")}else{K.Dom.addClass(this.DOM.dayNodes[aA],"calendar-resbook-webform-block-date-item-off")}}}}},{key:"handleClick",value:function an(aD){var aA,aC=aD.target||aD.srcElement;if(aC.hasAttribute("data-bx-resbook-date-meta")||(aC=aC.closest("[data-bx-resbook-date-meta]"))){var aB=aC.getAttribute("data-bx-resbook-date-meta");if(aB&&(aA=E.parseDate(aB,false,"YYYY-MM-DD"))){this.setValue(aA)}}}},{key:"setValue",value:function ak(aB){if(K.Type.isDate(aB)){this.value=aB;var aA=this.getDayNode(aB);if(aA){this.setSelected(aA)}this.onChange(this.value)}}},{key:"getValue",value:function am(){return this.value}},{key:"getDayNode",value:function az(aA){var aB=E.formatDate("Y-m-d",aA.getTime()/1000);if(this.DOM.dayNodes[aB]){return this.DOM.dayNodes[aB]}else{this.fillDays(aA);if(this.DOM.dayNodes[aB]){return this.DOM.dayNodes[aB]}}return null}},{key:"setSelected",value:function ar(aA){if(this.currentSelected){K.Dom.removeClass(this.currentSelected,"calendar-resbook-webform-block-date-item-select")}this.currentSelected=aA;K.Dom.addClass(aA,"calendar-resbook-webform-block-date-item-select")}},{key:"getStartLoadDate",value:function ai(){if(!this.startLoadDate){this.startLoadDate=new Date()}else{this.startLoadDate.setDate(this.startLoadDate.getDate()+this.DAYS_DISPLAY_SIZE)}return this.startLoadDate}},{key:"initCustomScroll",value:function aq(){var aA=this.DOM.wrap.appendChild(K.Tag.render(ah()));this.DOM.leftArrow=aA.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-arrow calendar-resbook-webform-block-arrow-prev"},events:{click:this.handlePreletrowClick.bind(this)}}));this.DOM.rightArrow=aA.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-arrow calendar-resbook-webform-block-arrow-next"},events:{click:this.handleNextArrowClick.bind(this)}}));this.outerWidth=parseInt(this.DOM.controlStaticWrap.offsetWidth);this.innerWidth=parseInt(this.DOM.controlInnerWrap.offsetWidth);if("onwheel" in document){K.Event.bind(this.DOM.controlStaticWrap,"wheel",this.mousewheelScrollHandler.bind(this))}else{K.Event.bind(this.DOM.controlStaticWrap,"mousewheel",this.mousewheelScrollHandler.bind(this))}this.checkScrollPosition()}},{key:"handleNextArrowClick",value:function au(){this.DOM.controlStaticWrap.scrollLeft=this.DOM.controlStaticWrap.scrollLeft+100;this.checkScrollPosition()}},{key:"handlePreletrowClick",value:function av(){this.DOM.controlStaticWrap.scrollLeft=Math.max(this.DOM.controlStaticWrap.scrollLeft-100,0);this.checkScrollPosition()}},{key:"mousewheelScrollHandler",value:function ay(aA){aA=aA||window.event;var aB=aA.deltaY||aA.detail||aA.wheelDelta;if(Math.abs(aB)>0){if(!K.Browser.isMac()){aB=aB*3}this.DOM.controlStaticWrap.scrollLeft=Math.max(this.DOM.controlStaticWrap.scrollLeft+aB,0);this.checkScrollPosition();if(aA.stopPropagation){aA.preventDefault();aA.stopPropagation()}return false}}},{key:"checkScrollPosition",value:function at(){if(this.outerWidth<=this.innerWidth){this.DOM.leftArrow.style.display=this.DOM.controlStaticWrap.scrollLeft===0?"none":"";if(this.innerWidth-this.outerWidth-4<=this.DOM.controlStaticWrap.scrollLeft){this.fillDays()}}this.updateMonthTitle()}},{key:"updateMonthTitle",value:function ao(){if(!this.dayNodeOuterWidth){this.dayNodeOuterWidth=this.DOM.controlInnerWrap.childNodes[1].offsetLeft-this.DOM.controlInnerWrap.childNodes[0].offsetLeft;if(!this.dayNodeOuterWidth){return setTimeout(this.updateMonthTitle.bind(this),100)}}var aF,aE,aD,aB,aA=Math.floor(this.DOM.controlStaticWrap.scrollLeft/this.dayNodeOuterWidth),aC=Math.floor((this.DOM.controlStaticWrap.scrollLeft+this.outerWidth)/this.dayNodeOuterWidth);if(this.DOM.controlInnerWrap.childNodes[aA]){aD=this.DOM.controlInnerWrap.childNodes[aA].getAttribute("data-bx-resbook-date-meta");if(aD&&(aB=E.parseDate(aD,false,"YYYY-MM-DD"))){aF=aE=E.formatDate("f",aB)}}if(this.DOM.controlInnerWrap.childNodes[aC]){aD=this.DOM.controlInnerWrap.childNodes[aC].getAttribute("data-bx-resbook-date-meta");if(aD&&(aB=E.parseDate(aD,false,"YYYY-MM-DD"))){aE=E.formatDate("f",aB)}}if(aF&&aE){K.Dom.adjust(this.DOM.monthTitle,{text:aE===aF?aF:aF+" - "+aE})}}}]);return ax}();function j(){var ai=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-arrow-container" />']);j=function aj(){return ai};return ai}function p(){var ai=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-col-list-inner"></div>']);p=function aj(){return ai};return ai}function F(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-col-list"></div>']);F=function ai(){return aj};return aj}function I(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-time-inner-wrap"></div>']);I=function ai(){return aj};return aj}function T(){var ai=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-time-static-wrap"></div>']);T=function aj(){return ai};return ai}function X(){var ai=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-notice-icon"/>']);X=function aj(){return ai};return ai}function ac(){var ai=babelHelpers.taggedTemplateLiteral(['<span class="calendar-resbook-webform-block-notice-date"/>']);ac=function aj(){return ai};return ai}function f(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-title-timezone"></div>']);f=function ai(){return aj};return aj}function m(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-title-timezone"></div>']);m=function ai(){return aj};return aj}function w(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-inner"></div>']);w=function ai(){return aj};return aj}function v(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block"></div>']);v=function ai(){return aj};return aj}var C=function(aj){babelHelpers.inherits(at,aj);function at(aQ){var aR;babelHelpers.classCallCheck(this,at);aR=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(at).call(this,aQ));aR.DOM={outerWrap:aQ.outerWrap,wrap:null};aR.data=aQ.data||{};aR.setDataConfig();aR.timeFrom=aR.data.timeFrom||aQ.timeFrom||7;if(aQ.timeFrom!==undefined){aR.timeFrom=aQ.timeFrom}aR.timeTo=aR.data.timeTo||20;if(aQ.timeTo!==undefined){aR.timeTo=aQ.timeTo}aR.SLOTS_ROW_AMOUNT=6;aR.id="time-selector-"+Math.round(Math.random()*1000);aR.popupSelectId=aR.id+"-select-popup";aR.previewMode=aQ.previewMode===undefined;aR.changeValueCallback=aQ.changeValueCallback;aR.timezone=aQ.timezone;aR.timezoneOffset=aQ.timezoneOffset;aR.timezoneOffsetLabel=aQ.timezoneOffsetLabel;aR.timeMidday=12;aR.timeEvening=17;aR.displayed=true;return aR}babelHelpers.createClass(at,[{key:"setDataConfig",value:function aF(){var aR=this.data.style==="select"?"select":"slots",aU=this.data.showOnlyFree!=="N",aQ=this.data.showFinishTime==="Y",aT=parseInt(this.data.scale||30),aS=this.style!==aR||this.showOnlyFree!==aU||this.showFinishTime!==aQ||this.scale!==aT;this.style=aR;this.showOnlyFree=aU;this.showFinishTime=aQ;this.scale=aT;return aS}},{key:"display",value:function aL(){this.DOM.wrap=this.DOM.outerWrap.appendChild(K.Tag.render(v()));this.DOM.innerWrap=this.DOM.wrap.appendChild(K.Tag.render(w()));if(this.data.label){this.DOM.labelWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-title"},text:this.data.label+"*"}));if(this.timezone){this.DOM.timezoneLabelWrap=this.DOM.labelWrap.appendChild(K.Tag.render(m()));K.Dom.adjust(this.DOM.timezoneLabelWrap,{html:K.Loc.getMessage("USER_TYPE_RESOURCE_TIMEZONE").replace("#TIMEZONE#",this.timezone+" "+this.timezoneOffsetLabel)})}}this.displayControl();this.setValue(this.getValue());this.shown=true}},{key:"refresh",value:function au(aQ,aR){aR=aR||{};this.setSlotIndex(aR.slotIndex);this.currentDate=aR.currentDate||new Date();this.data=aQ;if(!this.isShown()){this.setDataConfig();this.display()}else{if(this.DOM.labelWrap&&this.data.label){K.Dom.adjust(this.DOM.labelWrap,{text:this.data.label+"*"})}if(this.timezone){if(!this.DOM.timezoneLabelWrap||!this.DOM.labelWrap.contains(this.DOM.timezoneLabelWrap)){this.DOM.timezoneLabelWrap=this.DOM.labelWrap.appendChild(K.Tag.render(f()))}K.Dom.adjust(this.DOM.timezoneLabelWrap,{html:K.Loc.getMessage("USER_TYPE_RESOURCE_TIMEZONE").replace("#TIMEZONE#",this.timezone+" "+this.timezoneOffsetLabel)})}if(this.setDataConfig()||aR.slotIndex||aR.selectedValue){K.Dom.remove(this.DOM.controlWrap);this.displayControl()}}this.setCurrentValue(aR.selectedValue||this.getValue())}},{key:"setSlotIndex",value:function aH(aQ){if(K.Type.isPlainObject(aQ)){this.availableSlotIndex=aQ}}},{key:"setCurrentValue",value:function an(aQ){if(aQ&&(this.previewMode||this.availableSlotIndex[aQ])){this.setValue(aQ)}else{this.setValue(null)}}},{key:"showEmptyWarning",value:function az(){if(this.DOM.labelWrap){this.DOM.labelWrap.style.display="none"}if(!this.DOM.warningWrap){this.DOM.warningTextNode=K.Tag.render(ac());this.DOM.warningWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-notice"},children:[K.Tag.render(X()),this.DOM.warningTextNode,K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-notice-detail"},text:K.Loc.getMessage("WEBF_RES_BOOKING_BUSY_DAY_WARNING")})]}))}if(this.DOM.warningWrap){K.Dom.adjust(this.DOM.warningTextNode,{text:E.formatDate(K.Loc.getMessage("WEBF_RES_BUSY_DAY_DATE_FORMAT"),this.currentDate)});this.DOM.warningWrap.style.display="";this.noSlotsAvailable=true}}},{key:"hideEmptyWarning",value:function av(){this.noSlotsAvailable=false;if(this.DOM.labelWrap){this.DOM.labelWrap.style.display=""}if(this.DOM.warningWrap){this.DOM.warningWrap.style.display="none"}}},{key:"displayControl",value:function aK(){var aQ=this.getSlotsInfo();this.slots=aQ.slots;if(!aQ.freeSlotsCount){this.showEmptyWarning()}else{this.hideEmptyWarning();if(this.style==="select"){this.createSelectControl()}else{if(this.style==="slots"){this.createSlotsControl()}}}}},{key:"hide",value:function aC(){if(this.DOM.innerWrap){this.DOM.innerWrap.style.display="none"}}},{key:"show",value:function aO(){if(this.DOM.innerWrap){this.DOM.innerWrap.style.display=""}}},{key:"createSlotsControl",value:function aI(){if(this.DOM.controlWrap){K.Dom.remove(this.DOM.controlWrap)}this.DOM.controlWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-time"},events:{click:this.handleClick.bind(this)}}));if(!this.showFinishTime&&!E.isAmPmMode()){K.Dom.addClass(this.DOM.controlWrap,"calendar-resbook-webform-block-time-sm")}else{if(!this.showFinishTime&&E.isAmPmMode()){K.Dom.addClass(this.DOM.controlWrap,"calendar-resbook-webform-block-time-md")}else{if(E.isAmPmMode()){K.Dom.addClass(this.DOM.controlWrap,"calendar-resbook-webform-block-time-lg")}}}this.DOM.controlStaticWrap=this.DOM.controlWrap.appendChild(K.Tag.render(T()));this.DOM.controlInnerWrap=this.DOM.controlStaticWrap.appendChild(K.Tag.render(I()));var aR,aQ=3,aV={},aU=0,aT;this.slots.forEach(function(aW){if(!aV[aW.partOfTheDay]){aV[aW.partOfTheDay]={items:[]}}aV[aW.partOfTheDay].items.push(aW)});this.slots.forEach(function(aW){if(!aV[aW.partOfTheDay].wrap){aU=0;aR=6;aV[aW.partOfTheDay].wrap=K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-col"},html:'<span class="calendar-resbook-webform-block-col-title">'+K.Loc.getMessage("WEBF_RES_PART_OF_THE_DAY_"+aW.partOfTheDay.toUpperCase())+"</span>"});aV[aW.partOfTheDay].itemsWrap=aV[aW.partOfTheDay].wrap.appendChild(K.Tag.render(F()));if(aV[aW.partOfTheDay].items.length>aQ*aR){aR=Math.ceil(aV[aW.partOfTheDay].items.length/aQ)}}if(aU%aR===0){aT=aV[aW.partOfTheDay].itemsWrap.appendChild(K.Tag.render(p()))}if(aT&&(!aW.booked||!this.showOnlyFree)){aT.appendChild(K.Dom.create("div",{attrs:{"data-bx-resbook-time-meta":"slot"+(aW.booked?"-off":""),"data-bx-resbook-slot":aW.time.toString(),className:"calendar-resbook-webform-block-col-item"+(aW.selected?" calendar-resbook-webform-block-col-item-select":"")+(aW.booked?" calendar-resbook-webform-block-col-item-off":"")},html:'<div class="calendar-resbook-webform-block-col-item-inner"><span class="calendar-resbook-webform-block-col-time">'+aW.fromTime+"</span>"+(this.showFinishTime?'- <span class="calendar-resbook-webform-block-col-time calendar-resbook-webform-block-col-time-end">'+aW.toTime+"</span>":"")+"</div>"}));aU++}aV[aW.partOfTheDay].itemsAmount=aU},this);var aS;for(aS in aV){if(aV.hasOwnProperty(aS)&&aV[aS].itemsAmount>0){this.DOM.controlInnerWrap.appendChild(aV[aS].wrap)}}this.initCustomScrollForSlots()}},{key:"createSelectControl",value:function ar(){if(this.DOM.controlWrap){K.Dom.remove(this.DOM.controlWrap)}this.DOM.controlWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-field"},events:{click:this.handleClick.bind(this)}}));this.DOM.timeSelectWrap=this.DOM.controlWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-block-strip"}}));this.DOM.valueInput=this.DOM.timeSelectWrap.appendChild(K.Dom.create("input",{attrs:{type:"hidden",value:""}}));this.DOM.previousArrow=this.DOM.timeSelectWrap.appendChild(K.Dom.create("span",{attrs:{className:"calendar-resbook-webform-block-strip-arrow calendar-resbook-webform-block-strip-arrow-prev","data-bx-resbook-time-meta":"previous"}}));this.DOM.stateWrap=this.DOM.timeSelectWrap.appendChild(K.Dom.create("span",{attrs:{className:"calendar-resbook-webform-block-strip-text","data-bx-resbook-time-meta":"select"}}));this.DOM.stateWrap=this.DOM.stateWrap.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-strip-date"}}));this.DOM.nextArrow=this.DOM.timeSelectWrap.appendChild(K.Dom.create("span",{attrs:{className:"calendar-resbook-webform-block-strip-arrow calendar-resbook-webform-block-strip-arrow-next","data-bx-resbook-time-meta":"next"}}));this.setValue(this.getValue())}},{key:"setValue",value:function ao(aQ){var aR=this.getSlotByTime(aQ);if(aR){if(this.style==="select"&&K.Type.isDomNode(this.DOM.stateWrap)){K.Dom.adjust(this.DOM.stateWrap,{text:this.getTimeTextBySlot(aR)})}else{if(this.style==="slots"){this.setSelected(this.getSlotNode(aR.time))}}this.value=aR.time}else{this.value=null}if(!this.previewMode&&K.Type.isFunction(this.changeValueCallback)){this.changeValueCallback(this.value)}}},{key:"getValue",value:function ap(){if(!this.value&&(this.previewMode||this.style==="select")){this.value=this.slots[0].time}return this.value}},{key:"hasAvailableSlots",value:function aw(){return !this.noSlotsAvailable}},{key:"getTimeTextBySlot",value:function aB(aQ){return aQ.fromTime+(this.showFinishTime?" - "+aQ.toTime:"")}},{key:"getSlotByTime",value:function aN(aQ){return K.Type.isArray(this.slots)?this.slots.find(function(aR){return parseInt(aR.time)===parseInt(aQ)}):null}},{key:"handleClick",value:function ay(aS){var aR=aS.target||aS.srcElement;if(aR.hasAttribute("data-bx-resbook-time-meta")||(aR=aR.closest("[data-bx-resbook-time-meta]"))){var aQ=aR.getAttribute("data-bx-resbook-time-meta");if(this.style==="select"){if(aQ==="previous"){this.setValue(this.getValue()-this.scale)}else{if(aQ==="next"){this.setValue(this.getValue()+this.scale)}else{if(aQ==="select"){this.openSelectPopup()}}}}else{if(aQ==="slot"){this.setValue(parseInt(aR.getAttribute("data-bx-resbook-slot")))}}}}},{key:"getSlotsInfo",value:function aG(){var aW=[],aY,aV=0,aS,aX,aZ,aU,a0,aQ="morning",aT=0,aR=this.timeFrom*60;while(aR<this.timeTo*60){if(aR>=this.timeEvening*60){aQ="evening"}else{if(aR>=this.timeMidday*60){aQ="afternoon"}}aX=Math.floor(aR/60);aZ=aR-aX*60;aS=aR+this.scale;aU=Math.floor(aS/60);a0=aS-aU*60;aY={time:aR,fromTime:E.formatTime(aX,aZ),toTime:E.formatTime(aU,a0),partOfTheDay:aQ};if(this.previewMode){if(!aT){aY.selected=true}else{if(Math.round(Math.random()*10)<=3){aY.booked=true}}}else{if(this.availableSlotIndex){aY.booked=!this.availableSlotIndex[aR]}}if(!aY.booked){aV++}aW.push(aY);aR+=this.scale;aT++}return{slots:aW,freeSlotsCount:aV}}},{key:"initCustomScrollForSlots",value:function aE(){var aQ=this.DOM.controlWrap.appendChild(K.Tag.render(j()));this.DOM.leftArrow=aQ.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-arrow calendar-resbook-webform-block-arrow-prev"},events:{click:this.handlePreletrowClick.bind(this)}}));this.DOM.rightArrow=aQ.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-arrow calendar-resbook-webform-block-arrow-next"},events:{click:this.handleNextArrowClick.bind(this)}}));this.outerWidth=parseInt(this.DOM.controlStaticWrap.offsetWidth);this.innerWidth=parseInt(this.DOM.controlInnerWrap.offsetWidth);if("onwheel" in document){K.Event.bind(this.DOM.controlStaticWrap,"wheel",this.mousewheelScrollHandler.bind(this))}else{K.Event.bind(this.DOM.controlStaticWrap,"mousewheel",this.mousewheelScrollHandler.bind(this))}this.checkSlotsScroll()}},{key:"handleNextArrowClick",value:function al(){this.DOM.controlStaticWrap.scrollLeft=this.DOM.controlStaticWrap.scrollLeft+100;this.checkSlotsScroll()}},{key:"handlePreletrowClick",value:function aA(){this.DOM.controlStaticWrap.scrollLeft=Math.max(this.DOM.controlStaticWrap.scrollLeft-100,0);this.checkSlotsScroll()}},{key:"mousewheelScrollHandler",value:function ak(aQ){aQ=aQ||window.event;var aR=aQ.deltaY||aQ.detail||aQ.wheelDelta;if(Math.abs(aR)>0){if(!K.Browser.isMac()){aR=aR*5}this.DOM.controlStaticWrap.scrollLeft=Math.max(this.DOM.controlStaticWrap.scrollLeft+aR,0);this.checkSlotsScroll();if(aQ.stopPropagation){aQ.preventDefault();aQ.stopPropagation()}return false}}},{key:"checkSlotsScroll",value:function aJ(){if(this.outerWidth<=this.innerWidth){this.DOM.leftArrow.style.display=this.DOM.controlStaticWrap.scrollLeft?"":"none";if(this.innerWidth-this.outerWidth-4<=this.DOM.controlStaticWrap.scrollLeft){this.DOM.rightArrow.style.display="none"}else{this.DOM.rightArrow.style.display=""}}}},{key:"openSelectPopup",value:function aD(){if(this.isSelectPopupShown()){return this.closeSelectPopup()}this.popup=i.MenuManager.create(this.popupSelectId,this.DOM.stateWrap,this.getTimeSelectItems(),{className:"calendar-resbook-time-select-popup",angle:true,closeByEsc:true,autoHide:true,offsetTop:5,offsetLeft:10,cacheable:false});this.popup.show(true)}},{key:"closeSelectPopup",value:function am(){if(this.isSelectPopupShown()){this.popup.close();K.Event.unbind(document,"click",this.handleClick.bind(this))}}},{key:"isSelectPopupShown",value:function ax(){return this.popup&&this.popup.popupWindow&&this.popup.popupWindow.isShown&&this.popup.popupWindow.isShown()}},{key:"getTimeSelectItems",value:function aq(){var aQ=[];this.slots.forEach(function(aS){if(this.showOnlyFree&&aS.booked){return}var aR="menu-popup-no-icon";if(aS.booked){aR+=" menu-item-booked"}if(aS.selected){aR+=" menu-item-selected"}aQ.push({className:aR,text:this.getTimeTextBySlot(aS),dataset:{value:aS.time,booked:!!aS.booked},onclick:this.menuItemClick.bind(this)})},this);return aQ}},{key:"menuItemClick",value:function aP(aR,aQ){if(aQ&&aQ.dataset&&aQ.dataset.value){if(!aQ.dataset.booked){this.setValue(aQ.dataset.value)}}this.closeSelectPopup()}},{key:"getSlotNode",value:function ai(aS){var aR,aQ=this.DOM.controlInnerWrap.querySelectorAll(".calendar-resbook-webform-block-col-item");for(aR=0;aR<aQ.length;aR++){if(parseInt(aQ[aR].getAttribute("data-bx-resbook-slot"))===parseInt(aS)){return aQ[aR]}}return null}},{key:"setSelected",value:function aM(aQ){if(K.Type.isDomNode(aQ)){if(this.currentSelected){K.Dom.removeClass(this.currentSelected,"calendar-resbook-webform-block-col-item-select")}this.currentSelected=aQ;K.Dom.addClass(aQ,"calendar-resbook-webform-block-col-item-select")}}}]);return at}(af);function l(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-result-value"></div>']);l=function ai(){return aj};return aj}function u(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-result-inner"></div>']);u=function ai(){return aj};return aj}function t(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-block-result" style="display: none" \n></div>']);t=function ai(){return aj};return aj}var z=function(){function an(aq){babelHelpers.classCallCheck(this,an);this.DOM={outerWrap:aq.outerWrap};this.timezone=aq.timezone;this.timezoneOffsetLabel=aq.timezoneOffsetLabel;this.shown=false;this.built=false}babelHelpers.createClass(an,[{key:"isShown",value:function ao(){return this.shown}},{key:"build",value:function ap(){this.DOM.wrap=this.DOM.outerWrap.appendChild(K.Tag.render(t()));this.DOM.innerWrap=this.DOM.wrap.appendChild(K.Tag.render(u()));this.DOM.labelWrap=this.DOM.innerWrap.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-result-text"},text:K.Loc.getMessage("WEBF_RES_BOOKING_STATUS_LABEL")}));this.DOM.statusWrap=this.DOM.innerWrap.appendChild(K.Tag.render(l()));this.DOM.statusTimezone=this.DOM.innerWrap.appendChild(K.Dom.create("span",{props:{className:"calendar-resbook-webform-block-result-timezone"},text:this.timezoneOffsetLabel||"",style:{display:"none"}}));this.built=true}},{key:"refresh",value:function am(aq){if(!this.built){this.build()}if(!this.isShown()){this.show()}if(aq.dateFrom){this.DOM.labelWrap.style.display="";K.Dom.removeClass(this.DOM.wrap,"calendar-resbook-webform-block-result-error");if(this.timezone){this.DOM.statusTimezone.style.display=""}K.Dom.adjust(this.DOM.statusWrap,{text:this.getStatusText(aq)})}else{if(!aq.dateFrom&&aq.fullDay){this.DOM.labelWrap.style.display="none";this.DOM.statusTimezone.style.display="none";K.Dom.addClass(this.DOM.wrap,"calendar-resbook-webform-block-result-error");K.Dom.adjust(this.DOM.statusWrap,{text:K.Loc.getMessage("WEBF_RES_BOOKING_STATUS_DATE_IS_NOT_AVAILABLE")})}else{this.DOM.labelWrap.style.display="none";this.DOM.statusTimezone.style.display="none";K.Dom.removeClass(this.DOM.wrap,"calendar-resbook-webform-block-result-error");K.Dom.adjust(this.DOM.statusWrap,{text:K.Loc.getMessage("WEBF_RES_BOOKING_STATUS_NO_TIME_SELECTED")})}}}},{key:"getStatusText",value:function aj(au){var at=au.dateFrom,aq=new Date(at.getTime()+au.duration*60*1000+(au.fullDay?-1:0)),ar="";if(au.fullDay){if(E.formatDate("Y-m-d",at.getTime()/1000)===E.formatDate("Y-m-d",aq.getTime()/1000)){ar=E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_STATUS"),at)}else{ar=K.Loc.getMessage("WEBF_RES_DATE_FORMAT_FROM_TO").replace("#DATE_FROM#",E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_STATUS_SHORT"),at)).replace("#DATE_TO#",E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_STATUS_SHORT"),aq))}}else{if(E.formatDate("Y-m-d",at.getTime()/1000)===E.formatDate("Y-m-d",aq.getTime()/1000)){ar=E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_STATUS"),at)+" "+K.Loc.getMessage("WEBF_RES_TIME_FORMAT_FROM_TO").replace("#TIME_FROM#",E.formatTime(at.getHours(),at.getMinutes())).replace("#TIME_TO#",E.formatTime(aq.getHours(),aq.getMinutes()))}else{ar=K.Loc.getMessage("WEBF_RES_DATE_FORMAT_FROM_TO").replace("#DATE_FROM#",E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_STATUS_SHORT"),at)+" "+E.formatTime(at.getHours(),at.getMinutes())).replace("#DATE_TO#",E.formatDate(K.Loc.getMessage("WEBF_RES_DATE_FORMAT_STATUS_SHORT"),aq)+" "+E.formatTime(aq.getHours(),aq.getMinutes()))}}return ar}},{key:"hide",value:function ak(){if(this.built&&this.shown){this.DOM.wrap.style.display="none";this.shown=false}}},{key:"show",value:function ai(){if(this.built&&!this.shown){this.DOM.wrap.style.display="";this.shown=true}}},{key:"setError",value:function al(aq){if(this.DOM.labelWrap){this.DOM.labelWrap.style.display="none"}K.Dom.addClass(this.DOM.wrap,"calendar-resbook-webform-block-result-error");K.Dom.adjust(this.DOM.statusWrap,{text:aq})}}]);return an}();function V(){var ai=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-wrapper-loader-wrap"></div>']);V=function aj(){return ai};return ai}function ab(){var ai=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<input \n\t\t\t\t\t\tname="','"\n\t\t\t\t\t\tvalue="empty" \n\t\t\t\t\t\ttype="hidden"\n\t\t\t\t\t\t>\n\t\t\t\t\t']);ab=function aj(){return ai};return ai}function b(){var aj=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<input \n\t\t\t\t\t\tname="','"\n\t\t\t\t\t\tvalue="','" \n\t\t\t\t\t\ttype="hidden"\n\t\t\t\t\t\t>\n\t\t\t\t\t']);b=function ai(){return aj};return aj}function k(){var aj=babelHelpers.taggedTemplateLiteral(["<div></div>"]);k=function ai(){return aj};return aj}function s(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-inner"></div>']);s=function ai(){return aj};return aj}function r(){var aj=babelHelpers.taggedTemplateLiteral(['<div class="calendar-resbook-webform-wrapper"></div>']);r=function ai(){return aj};return aj}var o=function(a5){babelHelpers.inherits(ay,a5);function ay(bb){var bc;babelHelpers.classCallCheck(this,ay);bc=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(ay).call(this,bb));bc.setEventNamespace("BX.Calendar.LiveFieldController");bc.params=bb;bc.actionAgent=bb.actionAgent||BX.ajax.runAction;bc.timeFrom=bb.timeFrom||7;bc.timeTo=bb.timeTo||20;bc.scale=parseInt(bb.field.settings_data.time.scale)||60;bc.inputName=bb.field.name+"[]";bc.DATE_FORMAT=E.getDateFormat();bc.DATETIME_FORMAT=E.getDateTimeFormat();bc.userIndex=null;bc.timezoneOffset=null;bc.timezoneOffsetLabel=null;bc.userFieldParams=null;bc.loadedDates=[];bc.accessibility={user:{},resource:{}};bc.busySlotMatrix={user:{},resource:{}};bc.DOM={wrap:bc.params.wrap,valueInputs:[]};return bc}babelHelpers.createClass(ay,[{key:"init",value:function a2(){var bb=this;this.DOM.outerWrap=this.DOM.wrap.appendChild(K.Tag.render(r()));this.showMainLoader();this.requireFormData().then(function(){bb.hideMainLoader();bb.buildFormControls();bb.onChangeValues()})}},{key:"check",value:function aM(){var bb=true;if(this.usersDisplayed()&&!this.getSelectedUser()){this.userControl.showWarning();bb=false}if(bb&&this.resourcesDisplayed()&&!this.getSelectedResources()){this.resourceControl.showWarning();bb=false}if(bb&&!this.getCurrentDuration()){if(this.durationControl){this.durationControl.showWarning()}else{if(this.serviceControl){this.serviceControl.showWarning()}}bb=false}if(bb&&!this.dateControl.getValue()){this.dateControl.showWarning();bb=false}if(bb&&this.timeSelectorDisplayed()&&!this.timeControl.getValue()){this.timeControl.showWarning();bb=false}return bb}},{key:"buildFormControls",value:function ao(){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(K.Tag.render(s()));this.DOM.inputsWrap=this.DOM.innerWrap.appendChild(K.Tag.render(k()));if(!this.getFieldParams()){this.statusControl=new z({outerWrap:this.DOM.innerWrap});this.statusControl.refresh({});this.statusControl.setError("[UF_NOT_FOUND] "+K.Loc.getMessage("WEBF_RES_BOOKING_UF_WARNING"))}else{this.preparaAutoSelectValues();this.displayUsersControl();this.displayResourcesControl();this.displayServicesControl();this.displayDurationControl();this.displayDateTimeControl();if(this.selectedUserId||this.selectedResourceId){this.refreshControlsState()}}}},{key:"refreshControlsState",value:function a4(){if(this.selectorCanBeShown("resources")&&this.resourceControl&&!this.resourceControl.isShown()){this.resourceControl.display()}if(this.selectorCanBeShown("services")&&this.serviceControl&&!this.serviceControl.isShown()){this.serviceControl.display()}if(this.selectorCanBeShown("duration")&&this.durationControl&&!this.durationControl.isShown()){this.durationControl.display()}var bc=this.getSettingsData();if(this.selectorCanBeShown("date")&&this.dateControl){if(this.dateControl.isShown()){this.dateControl.refresh(bc.date,{availableDateIndex:this.getAvailableDateIndex({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})});if(this.timeControl){this.timeControl.refresh(bc.time,{slotIndex:this.getSlotIndex({date:this.dateControl.getValue()}),currentDate:this.dateControl.getValue()})}}else{var bb;if(bc.date.start==="free"){bb=this.getFreeDate({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})}else{bb=new Date()}this.dateControl.display({selectedValue:bb,availableDateIndex:this.getAvailableDateIndex({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})})}}this.updateStatusControl();this.onChangeValues();E.fireCustomEvent(window,"crmWebFormFireResize")}},{key:"onChangeValues",value:function aD(){var bh=[],bg="",bi=this.getCurrentDate(),bf=this.getCurrentDuration()*60,bd=this.getCurrentServiceName(),bb=[];K.Dom.clean(this.DOM.inputsWrap);this.DOM.valueInputs=[];if(K.Type.isDate(bi)){var be=this.getSelectedResources();if(K.Type.isArray(be)){be.forEach(function(bj){bb=bb.concat({type:"resource",id:bj})})}var bc=this.getSelectedUser();if(bc){bb=bb.concat({type:"user",id:bc})}bg=E.formatDate(this.DATETIME_FORMAT,bi.getTime()/1000);bb.forEach(function(bj){var bk=bj.type+"|"+bj.id+"|"+bg+"|"+bf+"|"+bd;bh.push(bk);this.DOM.valueInputs.push(this.DOM.inputsWrap.appendChild(K.Tag.render(b(),K.Text.encode(this.inputName),K.Text.encode(bk))))},this)}if(!bb.length){this.DOM.valueInputs.push(this.DOM.inputsWrap.appendChild(K.Tag.render(ab(),K.Text.encode(this.inputName))))}this.emit("change",bh)}},{key:"showMainLoader",value:function az(){if(this.DOM.wrap){this.hideMainLoader();var bb=K.Tag.render(V());bb.appendChild(E.getLoader(160));this.DOM.mainLoader=this.DOM.outerWrap.appendChild(bb)}}},{key:"hideMainLoader",value:function at(){K.Dom.remove(this.DOM.mainLoader)}},{key:"showStatusLoader",value:function a1(){this.showMainLoader()}},{key:"hideStatusLoader",value:function aw(){this.hideMainLoader()}},{key:"requestAccessibilityData",value:function aA(bd){var bb=this;if(!this.requestedFormData){this.showStatusLoader();this.requestedFormData=true;var bc={from:bd.date};this.requireFormData(bc).then(function(){bb.hideStatusLoader();bb.refreshControlsState();bb.dateControl.refreshCurrentValue();bb.onChangeValues();bb.requestedFormData=false})}}},{key:"requireFormData",value:function aX(bc){var bb=this;bc=K.Type.isPlainObject(bc)?bc:{};return new Promise(function(bf,be){var bd={settingsData:bb.getSettingsData()||null};if(!bb.userFieldParams){bd.fieldName=bb.params.field.entity_field_name}var bh=K.Type.isDate(bc.from)?bc.from:new Date(),bg;if(K.Type.isDate(bc.to)){bg=bc.to}else{bg=new Date(bh.getTime());bg.setDate(bh.getDate()+60)}bd.from=E.formatDate(bb.DATE_FORMAT,bh);bd.to=E.formatDate(bb.DATE_FORMAT,bg);bb.setLoadedDataLimits(bh,bg);bb.actionAgent("calendar.api.resourcebookingajax.getfillformdata",{data:bd}).then(function(bi){if(!K.Type.isPlainObject(bi)||!bi.data){bf(bi)}else{if(K.Type.isNumber(bi.data.timezoneOffset)){bb.timezoneOffset=bi.data.timezoneOffset;bb.timezoneOffsetLabel=bi.data.timezoneOffsetLabel}if(bi.data.workTimeStart!==undefined&&bi.data.workTimeEnd!==undefined){bb.timeFrom=parseInt(bi.data.workTimeStart);bb.timeTo=parseInt(bi.data.workTimeEnd)}if(bi.data.fieldSettings){bb.userFieldParams=bi.data.fieldSettings}if(bi.data.userIndex){bb.userIndex=bi.data.userIndex}bb.handleAccessibilityData(bi.data.usersAccessibility,"user");bb.handleAccessibilityData(bi.data.resourcesAccessibility,"resource");bf(bi.data)}},function(bi){bf(bi)})})}},{key:"setLoadedDataLimits",value:function aU(be,bd){this.loadedDataFrom=K.Type.isDate(be)?be:E.parseDate(be);this.loadedDataTo=K.Type.isDate(bd)?bd:E.parseDate(bd);this.loadedDates=this.loadedDates||[];this.loadedDatesIndex=this.loadedDatesIndex||{};var bc,bb=new Date(this.loadedDataFrom.getTime());while(true){bc=E.formatDate(this.DATE_FORMAT,bb);this.loadedDatesIndex[bc]=this.loadedDates.length;this.loadedDates.push({key:E.formatDate(this.DATE_FORMAT,bb),slots:{},slotsCount:{}});bb.setDate(bb.getDate()+1);if(bb.getTime()>this.loadedDataTo.getTime()){break}}}},{key:"fillDataIndex",value:function a9(bd,bf,be,bc){var bb=this.loadedDatesIndex[bd];if(this.loadedDates[bb]){if(!this.loadedDates[bb].slots[bf]){this.loadedDates[bb].slots[bf]={}}if(this.loadedDates[bb].slotsCount[be+bc]===undefined){this.loadedDates[bb].slotsCount[be+bc]=0}this.loadedDates[bb].slots[bf][be+bc]=true;this.loadedDates[bb].slotsCount[be+bc]++}}},{key:"handleAccessibilityData",value:function aJ(be,bd){var bc=this;if(K.Type.isPlainObject(be)&&(bd==="user"||bd==="resource")){var bf=function bf(bg){if(be.hasOwnProperty(bg)){be[bg].forEach(function(bh){if(!bh.from){bh.from=E.parseDate(bh.dateFrom);if(bh.from){bh.from.setSeconds(0,0);bh.fromTimestamp=bh.from.getTime()}}if(!bh.to){bh.to=E.parseDate(bh.dateTo);if(bh.to){if(bh.fullDay){bh.to.setHours(23,59,0,0)}else{bh.to.setSeconds(0,0)}bh.toTimestamp=bh.to.getTime()}}if(bh.from&&bh.to){this.fillBusySlotMatrix(bh,bd,bg)}},bc)}};for(var bb in be){bf(bb)}this.accessibility[bd]=E.mergeEx(this.accessibility[bd],be)}}},{key:"fillBusySlotMatrix",value:function aP(bl,be,bh){if(!this.busySlotMatrix[be][bh]){this.busySlotMatrix[be][bh]={}}var bk=new Date(bl.from.getTime()),bg=E.formatDate(this.DATE_FORMAT,bk),bc=E.formatDate(this.DATE_FORMAT,bl.to),bm=bk.getHours()*60+bk.getMinutes(),bd=Math.round((bl.toTimestamp-bl.fromTimestamp)/60000),bb=bm+bd,bj=this.getTimeSlots(),bi=0,bf;if(bd>0){while(true){if(!this.busySlotMatrix[be][bh][bg]){this.busySlotMatrix[be][bh][bg]={}}for(bf=0;bf<bj.length;bf++){if(bm<bj[bf].time+this.scale&&bb>bj[bf].time){this.busySlotMatrix[be][bh][bg][bj[bf].time]=true;this.fillDataIndex(bg,bj[bf].time,be,bh)}}if(bg===bc){break}else{bk.setDate(bk.getDate()+1);bg=E.formatDate(this.DATE_FORMAT,bk);bm=0;if(bg===bc){bb=bl.to.getHours()*60+bl.to.getMinutes()}else{bb=1440}}bi++;if(bi>10000){break}}}}},{key:"getCaption",value:function ar(){return this.params.field.caption}},{key:"getSettingsData",value:function aB(){return this.params.field.settings_data}},{key:"getUserIndex",value:function aG(){return this.userIndex}},{key:"getFieldParams",value:function al(){return this.userFieldParams}},{key:"getSettings",value:function aZ(){return{caption:this.getCaption(),data:this.getSettingsData()}}},{key:"isUserSelectorInAutoMode",value:function aq(){return this.usersDisplayed()&&this.getSettingsData().users.show==="N"}},{key:"isResourceSelectorInAutoMode",value:function aS(){return this.resourcesDisplayed()&&this.getSettingsData().resources.show==="N"}},{key:"autoAdjustUserSelector",value:function a8(){var bc=this.dateControl.getValue(),be=this.timeControl.getValue();if(K.Type.isDate(bc)&&be){var bd,bb=this.loadedDates[this.loadedDatesIndex[E.formatDate(this.DATE_FORMAT,bc)]];if(bb.slots[be]){for(bd=0;bd<this.userControl.values.length;bd++){if(!bb.slots[be]["user"+this.userControl.values[bd]]){this.userControl.setSelectedUser(this.userControl.values[bd]);break}}}}}},{key:"autoAdjustResourceSelector",value:function a6(){var bc=this.dateControl.getValue(),be=this.timeControl.getValue();if(K.Type.isDate(bc)&&be){var bd,bf,bb=this.loadedDates[this.loadedDatesIndex[E.formatDate(this.DATE_FORMAT,bc)]];if(bb.slots[be]){for(bd=0;bd<this.resourceControl.resourceList.length;bd++){bf=parseInt(this.resourceControl.resourceList[bd].id);if(!bb.slots[be]["resource"+bf]){this.resourceControl.setSelectedResource(bf);break}}}}}},{key:"preparaAutoSelectValues",value:function ba(){var bg=this.getSettingsData(),bh=this.usersDisplayed()&&(bg.users.defaultMode==="auto"||bg.users.show==="N"),bd=this.resourcesDisplayed()&&(bg.resources.defaultMode==="auto"||bg.resources.show==="N"),bb=bg.date.start==="free",bc=60,be,bf;this.selectedUserId=false;this.selectedResourceId=false;be=new Date();for(bf=0;bf<=bc;bf++){this.getFreeEntitiesForDate(be,{autoSelectUser:bh,autoSelectResource:bd,slotsAmount:this.getDefaultDurationSlotsAmount()});if((this.selectedUserId||!bh)&&(this.selectedResourceId||!bd)){break}if(!bb){break}be.setDate(be.getDate()+1)}}},{key:"getFreeEntitiesForDate",value:function ax(bc,bh){var bf=this.getSettingsData(),bg=bh.slotsAmount||1,be,bb,bd;if(bh.autoSelectUser){bb=K.Type.isArray(bf.users.value)?bf.users.value:bf.users.value.split("|");for(be=0;be<bb.length;be++){if(this.checkSlotsForDate(bc,bg,{user:parseInt(bb[be])})){this.selectedUserId=parseInt(bb[be]);break}}}if(bh.autoSelectResource){bd=K.Type.isArray(bf.resources.value)?bf.resources.value:bf.resources.value.split("|");for(be=0;be<bd.length;be++){if(this.checkSlotsForDate(bc,bg,{resources:[parseInt(bd[be])],user:this.selectedUserId||null})){this.selectedResourceId=parseInt(bd[be]);break}}}}},{key:"displayUsersControl",value:function aQ(){if(this.usersDisplayed()){this.userControl=new n({outerWrap:this.DOM.innerWrap,data:this.getSettingsData().users,userIndex:this.getUserIndex(),previewMode:false,autoSelectDefaultValue:this.selectedUserId,changeValueCallback:function(bb){this.emit("BX.Calendar.Resourcebooking.LiveFieldController:userChanged",new D.BaseEvent({data:{userId:bb}}));this.refreshControlsState()}.bind(this)});this.userControl.display()}}},{key:"displayResourcesControl",value:function aV(){var be={},bb=this.getFieldParams(),bc=this.getSettingsData();if(this.resourcesDisplayed()){bc.resources.value.split("|").forEach(function(bf){bf=parseInt(bf);if(bf>0){be[bf]=true}});var bd=[];bb.SELECTED_RESOURCES.forEach(function(bf){bf.id=parseInt(bf.id);if(be[bf.id]){bd.push(bf)}},this);this.resourceControl=new y({outerWrap:this.DOM.innerWrap,data:{show:bc.resources.show,defaultMode:bc.resources.defaultMode,label:bc.resources.label,multiple:bc.resources.multiple,value:bc.resources.value},resourceList:bd,autoSelectDefaultValue:this.selectedResourceId,changeValueCallback:function(){this.emit("BX.Calendar.Resourcebooking.LiveFieldController:resourceChanged");this.refreshControlsState()}.bind(this)});if(this.selectorCanBeShown("resources")){this.resourceControl.display()}}}},{key:"displayServicesControl",value:function a7(){var bb=this.getFieldParams(),bc=this.getSettingsData();if(bb.USE_SERVICES==="Y"&&bc.services.value){var bd=K.Type.isArray(bc.services.value)?bc.services.value:bc.services.value.split("|");this.serviceControl=new ag({outerWrap:this.DOM.innerWrap,data:bc.services,serviceList:bb.SERVICE_LIST,selectedValue:K.Type.isArray(bd)&&bd.length>0?bd[0]:null,changeValueCallback:function(){this.emit("BX.Calendar.Resourcebooking.LiveFieldController:serviceChanged");this.refreshControlsState()}.bind(this)});if(this.selectorCanBeShown("services")){this.serviceControl.display()}}}},{key:"displayDurationControl",value:function ai(){var bb=this.getFieldParams(),bc=this.getSettingsData();if(!this.serviceControl){this.durationControl=new ad({outerWrap:this.DOM.innerWrap,data:bc.duration,fullDay:bb.FULL_DAY==="Y",changeValueCallback:function(){this.emit("BX.Calendar.Resourcebooking.LiveFieldController:durationChanged");this.refreshControlsState()}.bind(this)});if(this.selectorCanBeShown("duration")){this.durationControl.display()}}}},{key:"displayDateTimeControl",value:function aL(){var be=false,bc=null,bf=this.getSettingsData(),bb=this.getFieldParams();this.dateControl=new U({outerWrap:this.DOM.innerWrap,data:bf.date,previewMode:false,allowOverbooking:bb.ALLOW_OVERBOOKING==="Y",changeValueCallback:this.handleDateChanging.bind(this),requestDataCallback:this.requestAccessibilityData.bind(this)});if(this.timeSelectorDisplayed()){if(bb.USE_USER_TIMEZONE==="N"){var bd=-new Date().getTimezoneOffset()*60;if(bd!==this.timezoneOffset){be=bb.TIMEZONE}}this.timeControl=new C({outerWrap:this.DOM.innerWrap,data:bf.time,previewMode:false,changeValueCallback:this.handleSelectedDateTimeChanging.bind(this),timeFrom:this.timeFrom,timeTo:this.timeTo,timezone:be,timezoneOffset:this.timezoneOffset,timezoneOffsetLabel:this.timezoneOffsetLabel})}this.statusControl=new z({outerWrap:this.DOM.innerWrap,timezone:be,timezoneOffsetLabel:this.timezoneOffsetLabel});if(this.selectorCanBeShown("date")){this.statusControl.show();if(bf.date.start==="free"){bc=this.getFreeDate({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})}this.dateControl.display({selectedValue:bc});if(this.timeControl&&!this.timeControl.isShown()){this.timeControl.display()}}else{this.statusControl.hide()}}},{key:"handleDateChanging",value:function au(be,bd){this.emit("BX.Calendar.Resourcebooking.LiveFieldController:dateChanged");if(this.timeSelectorDisplayed()){if(bd){this.timeControl.show();var bc,bb=this.getCurrentDate();if(bb){bc=bb.getHours()*60+bb.getMinutes()}this.timeControl.refresh(this.getSettingsData().time,{slotIndex:this.getSlotIndex({date:bd}),currentDate:bd,selectedValue:bc})}}else{this.handleSelectedDateTimeChanging(null,true)}this.onChangeValues()}},{key:"handleSelectedDateTimeChanging",value:function ak(bc,bb){if(bb!==false){if(this.updateTimeStatusTimeout){this.updateTimeStatusTimeout=clearTimeout(this.updateTimeStatusTimeout)}this.updateTimeStatusTimeout=setTimeout(function(){this.handleSelectedDateTimeChanging(bc,false)}.bind(this),100)}else{if(this.isUserSelectorInAutoMode()){this.autoAdjustUserSelector()}if(this.isResourceSelectorInAutoMode()){this.autoAdjustResourceSelector()}this.updateStatusControl();E.fireCustomEvent(window,"crmWebFormFireResize")}this.onChangeValues()}},{key:"updateStatusControl",value:function aR(){if(this.statusControl&&this.selectorCanBeShown("date")){var bb=this.getCurrentDate();if(this.dateControl.isItPastDate(bb)){this.statusControl.setError(K.Loc.getMessage("WEBF_RES_BOOKING_PAST_DATE_WARNING"))}else{if(this.timeSelectorDisplayed()){if(this.timeControl.hasAvailableSlots()){var bc=this.timeControl.getValue();this.statusControl.refresh({dateFrom:bc?bb:null,duration:bc?this.getCurrentDuration():null,fullDay:false})}else{this.statusControl.hide()}}else{this.statusControl.refresh({dateFrom:this.dateControl.isDateAvailable(bb)?bb:null,duration:this.getCurrentDuration(),fullDay:true})}}}}},{key:"getFreeDate",value:function aI(bd){var bc=Math.ceil(bd.duration/this.scale),be=null,bb=this.loadedDataFrom;while(true){if(this.checkSlotsForDate(bb,bc,{resources:bd.resources,user:bd.user})){be=bb;break}bb.setDate(bb.getDate()+1);if(bb.getTime()>=this.loadedDataTo.getTime()){break}}return be}},{key:"getAvailableDateIndex",value:function aF(bf){var bk,bj,bl={};if(this.timeSelectorDisplayed()){var bi=Math.ceil(bf.duration/this.scale);this.loadedDates.forEach(function(bm){bl[bm.key]=this.checkSlotsForDate(bm.key,bi,{resources:bf.resources,user:bf.user})},this)}else{var bh,be,bd,bg,bb=bf.user?"user"+bf.user:null,bc=Math.ceil(bf.duration/1440);be=1;for(bh=this.loadedDates.length;bh--;bh>=0){bk=true;bj=true;bd=this.loadedDates[bh];if(bb){bk=!bd.slotsCount[bb]}if(bk&&bf.resources&&bf.resources.length>0){for(bg=0;bg<bf.resources.length;bg++){bj=bj&&!bd.slotsCount["resource"+bf.resources[bg]];if(!bj){break}}}if(bk&&bj){be++}else{be=0}bl[bd.key]=bk&&bj&&bc<=be}}return bl}},{key:"getSlotIndex",value:function aj(be){if(be.date){be.date=this.dateControl.getValue()}var bl={};if(K.Type.isDate(be.date)){if(this.getFieldParams().ALLOW_OVERBOOKING!=="Y"&&(this.isUserSelectorInAutoMode()||this.isResourceSelectorInAutoMode())){var bq,bh,bf,bc,bi=this.getSettingsData(),bk=1,bm=0,bp=this.getTimeSlots(),bg=E.formatDate(this.DATE_FORMAT,be.date),bb=this.loadedDates[this.loadedDatesIndex[bg]],bj=Math.ceil(this.getCurrentDuration()/this.scale);if(this.checkIsTodayDate(bg)){var bn=new Date();bm=bn.getHours()*60+bn.getMinutes()}bp.forEach(function(br){bl[br.time]=true},this);if(this.isUserSelectorInAutoMode()){var bd=K.Type.isArray(bi.users.value)?bi.users.value:bi.users.value.split("|");for(bh=bp.length;bh--;bh>=0){bc=bp[bh].time;bq=false;if(bm&&bc<bm){bl[bc]=false;continue}for(bf=0;bf<bd.length;bf++){if(!bb.slots[bc]||!bb.slots[bc]["user"+bd[bf]]){bq=true;break}}bl[bc]=bl[bc]&&bq&&bj<=bk;bk=bq?bk+1:1}}if(this.isResourceSelectorInAutoMode()){var bo=K.Type.isArray(bi.resources.value)?bi.resources.value:bi.resources.value.split("|");for(bh=bp.length;bh--;bh>=0){bc=bp[bh].time;bq=false;if(bm&&bc<bm){bl[bc]=false;continue}for(bf=0;bf<bo.length;bf++){if(!bb.slots[bc]||!bb.slots[bc]["resource"+bo[bf]]){bq=true;break}}bl[bc]=bl[bc]&&bq&&bj<=bk;bk=bq?bk+1:1}}}else{bl=this.getAvailableSlotIndex({date:be.date||this.dateControl.getValue(),resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})}}return bl}},{key:"getAvailableSlotIndex",value:function aC(bf){var bh,bd,bi,bg,be,bm=0,bl,bb=bf.user?"user"+bf.user:null,bk=Math.ceil(bf.duration/this.scale),bp,bo,bq=this.getTimeSlots(),bc=this.getFieldParams().ALLOW_OVERBOOKING==="Y",bj={};bq.forEach(function(br){bj[br.time]=true},this);if(K.Type.isDate(bf.date)){bh=E.formatDate(this.DATE_FORMAT,bf.date);bd=this.loadedDates[this.loadedDatesIndex[bh]];bl=1;if(this.checkIsTodayDate(bh)){var bn=new Date();bm=bn.getHours()*60+bn.getMinutes()}for(bi=bq.length;bi--;bi>=0){be=bq[bi].time;if(bm&&be<bm){bj[be]=false;continue}if(bc){bj[be]=bk<=bl;bl++}else{bp=true;bo=true;if(bb){bp=!bd.slots[be]||!bd.slots[be][bb]}if(bf.resources&&bf.resources.length>0){for(bg=0;bg<bf.resources.length;bg++){bo=bo&&(!bd.slots[be]||!bd.slots[be]["resource"+bf.resources[bg]]);if(!bo){break}}}bj[be]=bp&&bo&&bk<=bl;if(bp&&bo){bl++}else{bl=1}}}}return bj}},{key:"checkSlotsForDate",value:function aE(bd,bf,bg){var bb=true,bc=true,be=K.Type.isDate(bd)?E.formatDate(this.DATE_FORMAT,bd):bd;bg=bg||{};if(this.usersDisplayed()&&bg.user){if(this.busySlotMatrix.user[bg.user]&&!this.entityHasSlotsForDate({entityType:"user",entityId:bg.user,dateKey:be,slotsAmount:bf})){bb=false}}if(this.resourcesDisplayed()&&bb&&K.Type.isArray(bg.resources)&&bg.resources.length>0){bg.resources.forEach(function(bh){if(bc&&this.busySlotMatrix.resource[bh]&&!this.entityHasSlotsForDate({entityType:"resource",entityId:bh,dateKey:be,slotsAmount:bf})){bc=false}},this)}return bb&&bc}},{key:"entityHasSlotsForDate",value:function aY(bg){var bf,bc,bb,be=0,bd=false;if(this.busySlotMatrix[bg.entityType][bg.entityId]&&this.busySlotMatrix[bg.entityType][bg.entityId][bg.dateKey]){bf=this.busySlotMatrix[bg.entityType][bg.entityId][bg.dateKey];bc=this.getTimeSlots();for(bb=0;bb<bc.length;bb++){if(!bf[bc[bb].time]){be++;if(be>=bg.slotsAmount){bd=true;break}}else{be=0}}}else{bd=true}return bd}},{key:"getSelectedResources",value:function ap(){var bb=null;if(this.resourceControl){bb=this.resourceControl.getSelectedValues();if(K.Type.isArray(bb)&&!bb.length){bb=null}}return bb}},{key:"getSelectedUser",value:function aK(){var bb=null;if(this.userControl){bb=this.userControl.getSelectedUser()}return bb}},{key:"getCurrentDuration",value:function av(){var bc=null;if(this.durationControl){bc=this.durationControl.getSelectedValue()}else{if(this.serviceControl){var bb=this.serviceControl.getSelectedService(true);if(bb&&bb.duration){bc=parseInt(bb.duration)}}}return bc}},{key:"getDefaultDurationSlotsAmount",value:function aW(){var be=this.getSettingsData(),bb=this.getFieldParams(),bg,bd,bf;if(bb.USE_SERVICES==="Y"&&be.services.value){var bc=be.services.value.split("|");if(K.Type.isArray(bb.SERVICE_LIST)&&K.Type.isArray(bc)&&bc.length>0){for(bd=0;bd<bb.SERVICE_LIST.length;bd++){if(E.translit(bb.SERVICE_LIST[bd].name)===bc[0]){bg=parseInt(bb.SERVICE_LIST[bd].duration);break}}}}else{bg=parseInt(be.duration.defaultValue)}bf=Math.ceil(bg/this.scale);return bf}},{key:"getCurrentServiceName",value:function aH(){var bc="";if(this.serviceControl){var bb=this.serviceControl.getSelectedService(true);if(bb&&bb.name){bc=bb.name}}return bc}},{key:"getCurrentDate",value:function aN(){var bb=null;if(this.dateControl&&this.dateControl.isShown()){bb=this.dateControl.getValue();if(this.timeSelectorDisplayed()){var bc,bd,be=this.timeControl.getValue();if(be){bc=Math.floor(be/60);bd=be-bc*60;bb.setHours(bc,bd,0,0)}}else{bb.setHours(0,0,0,0)}}return bb}},{key:"getTimeSlots",value:function a0(){if(!this.slots){this.slots=[];var bd,bb,bc=this.timeFrom*60;while(bc<this.timeTo*60){bb=bc+this.scale;bd={time:bc};this.slots.push(bd);bc+=this.scale}}return this.slots}},{key:"usersDisplayed",value:function aO(){if(this.useUsers===undefined){this.useUsers=!!(this.getFieldParams()["USE_USERS"]==="Y"&&this.getSettingsData().users.value)}return this.useUsers}},{key:"resourcesDisplayed",value:function am(){if(this.useResources===undefined){var bb=this.getFieldParams();this.useResources=!!(bb.USE_RESOURCES==="Y"&&bb.SELECTED_RESOURCES&&this.getSettingsData().resources.value)}return this.useResources}},{key:"timeSelectorDisplayed",value:function an(){if(this.useTime===undefined){this.useTime=this.getFieldParams().FULL_DAY!=="Y"}return this.useTime}},{key:"selectorCanBeShown",value:function a3(bc){var bb=false;if(bc==="resources"){if(this.resourcesDisplayed()&&!this.usersDisplayed()){bb=true}else{if(this.usersDisplayed()){bb=this.getSelectedUser()}}}else{if(bc==="date"||bc==="services"||bc==="duration"){if(this.usersDisplayed()&&this.resourcesDisplayed()){bb=this.getSelectedUser()&&this.getSelectedResources()}else{if(this.usersDisplayed()){bb=this.getSelectedUser()}else{if(this.resourcesDisplayed()){bb=this.getSelectedResources()}}}}}return bb}},{key:"checkIsTodayDate",value:function aT(bc){if(!this.todayDateKey){var bb=new Date();this.todayDateKey=E.formatDate(this.DATE_FORMAT,bb)}return this.todayDateKey===bc}}]);return ay}(D.EventEmitter);var e=function(){function aj(){babelHelpers.classCallCheck(this,aj)}babelHelpers.createClass(aj,null,[{key:"run",value:function al(au){var aq="_",av=/[A-Z0-9]/i,an=/\s/,am=100,ar=au.length,ax="",aw="",ap;for(ap=0;ap<ar;ap++){var at=void 0,ao=au.charAt(ap);if(av.test(ao)){at=ao}else{if(an.test(ao)){if(ap>0&&aw!==aq){at=aq}else{at=""}}else{at=aj.getChar(ao);if(at===null){if(ap>0&&ap!==ar-1&&aw!==aq){at=aq}else{at=""}}}}if(null!=at&&at.length>0){at=at.toLowerCase();ax+=at;aw=at}if(ax.length>=am){break}}return ax}},{key:"generateReplacementCharTable",value:function ai(){var aq=",",ao=(K.Loc.getMessage("TRANSLIT_FROM")||"").split(aq),an=(K.Loc.getMessage("TRANSLIT_TO")||"").split(aq),ap,am;aj.replacementCharTable=[];for(ap=0,am=ao.length;ap<am;ap++){aj.replacementCharTable[ap]=[ao[ap],an[ap]]}}},{key:"getChar",value:function ak(ao){if(aj.replacementCharTable===null){aj.generateReplacementCharTable()}for(var an=0,am=aj.replacementCharTable.length;an<am;an++){if(ao===aj.replacementCharTable[an][0]){return aj.replacementCharTable[an][1]}}return null}}]);return aj}();babelHelpers.defineProperty(e,"replacementCharTable",null);function q(){var aj=babelHelpers.taggedTemplateLiteral(['\n\t\t<div class="','">\n\t\t\t<svg class="calendar-loader-circular"\n\t\t\t\tstyle="width:',"px; height:",'px;"\n\t\t\t\tviewBox="25 25 50 50">\n\t\t\t\t\t<circle class="calendar-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t\t\t<circle class="calendar-loader-inner-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/>\n\t\t\t</svg>\n\t\t</div>\n']);q=function ai(){return aj};return aj}var E=function(){function at(){babelHelpers.classCallCheck(this,at)}babelHelpers.createClass(at,null,[{key:"getDateFormat",value:function au(){if(K.Type.isNull(at.DATE_FORMAT)){at.DATE_FORMAT=H.convertBitrixFormat(K.Loc.getMessage("FORMAT_DATE"))}return at.DATE_FORMAT}},{key:"getDateTimeFormat",value:function am(){if(K.Type.isNull(at.DATETIME_FORMAT)){at.DATETIME_FORMAT=H.convertBitrixFormat(K.Loc.getMessage("FORMAT_DATETIME"))}return at.DATETIME_FORMAT}},{key:"getTimeFormat",value:function an(){if(K.Type.isNull(at.TIME_FORMAT)){var aG=at.getDateTimeFormat();var aF=at.getDateFormat();if(aG.substr(0,aF.length)===aF){at.TIME_FORMAT=aG.substr(aF.length).trim()}else{at.TIME_FORMAT=H.convertBitrixFormat(H.isAmPmMode()?"H:MI:SS T":"HH:MI:SS")}at.TIME_FORMAT_SHORT=at.TIME_FORMAT.replace(":s","")}return at.TIME_FORMAT}},{key:"getTimeFormatShort",value:function ar(){if(K.Type.isNull(at.TIME_FORMAT_SHORT)){at.TIME_FORMAT_SHORT=at.getTimeFormat().replace(":s","")}return at.TIME_FORMAT_SHORT}},{key:"formatDate",value:function av(aI,aH,aF,aG){if(aI===null){aI=at.getDateFormat()}if(K.Type.isDate(aH)){aH=aH.getTime()/1000}return H.format(aI,aH,aF,aG)}},{key:"parseDate",value:function aE(aI,aH,aG,aF){return H.parse(aI,aH,aG,aF)}},{key:"formatTime",value:function aD(aG,aF){var aH=new Date();aH.setHours(aG,aF,0);return H.format(at.getTimeFormatShort(),aH.getTime()/1000)}},{key:"translit",value:function aC(aF){return K.Type.isString(aF)?e.run(aF).replace(/[^a-z0-9_]/ig,"_"):aF}},{key:"getLoader",value:function ao(aF,aG){return K.Tag.render(q(),aG||"calendar-loader",parseInt(aF),parseInt(aF))}},{key:"fireCustomEvent",value:function al(aF,aG,aI,aH){if(window.BX&&K.Type.isFunction(BX.onCustomEvent)){return BX.onCustomEvent(aF,aG,aI,aH)}}},{key:"bindCustomEvent",value:function az(aF,aG,aH){if(window.BX&&K.Type.isFunction(BX.addCustomEvent)){return BX.addCustomEvent(aF,aG,aH)}}},{key:"unbindCustomEvent",value:function ai(aF,aG,aH){if(window.BX&&K.Type.isFunction(BX.removeCustomEvent)){return BX.removeCustomEvent(aF,aG,aH)}}},{key:"isAmPmMode",value:function aB(){return H.isAmPmMode()}},{key:"mergeEx",value:function ak(){var aG=Array.prototype.slice.call(arguments);if(aG.length<2){return{}}var aF=aG.shift();for(var aI=0;aI<aG.length;aI++){for(var aH in aG[aI]){if(typeof aG[aI]==="undefined"||aG[aI]==null||!aG[aI].hasOwnProperty(aH)){continue}if(K.Type.isPlainObject(aG[aI][aH])&&K.Type.isPlainObject(aF[aH])){at.mergeEx(aF[aH],aG[aI][aH])}else{aF[aH]=K.Type.isPlainObject(aG[aI][aH])?K.Runtime.clone(aG[aI][aH]):aG[aI][aH]}}}return aF}},{key:"getDurationList",value:function aw(aF){var aG=[5,10,15,20,25,30,40,45,50,60,90,120,180,240,300,360,1440,1440*2,1440*3,1440*4,1440*5,1440*6,1440*7,1440*10],aJ,aI,aH=[];for(aI=0;aI<aG.length;aI++){aJ=aG[aI];if(aF&&aJ%1440!==0){continue}aH.push({value:aJ,label:at.getDurationLabel(aJ)})}return aH}},{key:"getDurationLabel",value:function ap(aG){var aF;if(aG%1440===0){aF=K.Loc.getMessage("USER_TYPE_DURATION_X_DAY").replace("#NUM#",aG/1440)}else{if(aG%60===0&&aG!==60){aF=K.Loc.getMessage("USER_TYPE_DURATION_X_HOUR").replace("#NUM#",aG/60)}else{aF=K.Loc.getMessage("USER_TYPE_DURATION_X_MIN").replace("#NUM#",aG)}}return aF}},{key:"parseDuration",value:function ay(aJ){var aG=aJ,aK=parseInt(aJ),aH=false,aF=new RegExp("(\\d)\\s*("+K.Loc.getMessage("USER_TYPE_DURATION_REGEXP_DAY")+").*","ig"),aI=new RegExp("(\\d)\\s*("+K.Loc.getMessage("USER_TYPE_DURATION_REGEXP_HOUR")+").*","ig");aJ=aJ.replace(aF,function(aM,aL){aH=true;return aL});if(aH){aJ=aK*1440}else{aJ=aG.replace(aI,function(aM,aL){aH=true;return aL});if(aH){aJ=aK*60}else{aJ=aK}}return parseInt(aJ)||0}},{key:"getSimpleTimeList",value:function aA(){if(K.Type.isNull(at.simpleTimeList)){var aG,aF=[];for(aG=0;aG<24;aG++){aF.push({value:aG*60,label:this.formatTime(aG,0)});aF.push({value:aG*60+30,label:this.formatTime(aG,30)})}at.simpleTimeList=aF}return at.simpleTimeList}},{key:"adaptTimeValue",value:function aj(aG){aG=parseInt(aG.h*60)+parseInt(aG.m);var aJ=at.getSimpleTimeList(),aI=24*60,aH=false,aF;for(aF=0;aF<aJ.length;aF++){if(Math.abs(aJ[aF].value-aG)<aI){aI=Math.abs(aJ[aF].value-aG);aH=aF;if(aI<=15){break}}}return aJ[aH||0]}},{key:"getDayLength",value:function ax(){return at.DAY_LENGTH}},{key:"showLimitationPopup",value:function aq(){if(top.BX.getClass("BX.UI.InfoHelper")){top.BX.UI.InfoHelper.show("limit_crm_booking")}}}]);return at}();babelHelpers.defineProperty(E,"simpleTimeList",null);babelHelpers.defineProperty(E,"DAY_LENGTH",86400000);babelHelpers.defineProperty(E,"TIME_FORMAT",null);babelHelpers.defineProperty(E,"TIME_FORMAT_SHORT",null);babelHelpers.defineProperty(E,"DATE_FORMAT",null);babelHelpers.defineProperty(E,"DATETIME_FORMAT",null);var A=function(aw){babelHelpers.inherits(ay,aw);function ay(az){var aA;babelHelpers.classCallCheck(this,ay);aA=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(ay).call(this,az));aA.settings=az.settings||{};aA.showTitle=az.displayTitle!==false;aA.title=az.title||"";aA.DOM={wrap:az.wrap};return aA}babelHelpers.createClass(ay,[{key:"build",value:function av(){this.controls={};this.DOM.outerWrap=this.DOM.wrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-wrapper calendar-resbook-webform-wrapper-form"}}));this.DOM.innerWrap=this.DOM.outerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-inner"}}));if(this.settings.userfieldSettings.useUsers||this.settings.userfieldSettings.useResources){this.displayTitle();this.displayUsersControl();this.displayResourcesControl();this.displayServicesControl();this.displayDurationControl();this.displayDateControl();this.displayTimeControl()}else{this.displayWarning(K.Loc.getMessage("WEBF_RES_BOOKING_WARNING"))}}},{key:"destroy",value:function au(){K.Dom.remove(this.DOM.outerWrap)}},{key:"displayTitle",value:function ao(){if(this.showTitle){this.DOM.titleWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-title"}})).appendChild(K.Dom.create("div",{props:{className:"calendar-resbook-webform-title-text"}}));this.updateTitle(this.title)}}},{key:"updateTitle",value:function aq(az){if(this.showTitle){this.title=az;K.Dom.adjust(this.DOM.titleWrap,{text:this.title})}}},{key:"displayWarning",value:function aj(az){this.DOM.warningWrap=this.DOM.innerWrap.appendChild(K.Dom.create("div",{props:{className:"ui-alert ui-alert-warning ui-alert-text-center ui-alert-icon-warning"},style:{marginBottom:0},html:'<span class="ui-alert-message">'+az+"</span>"}))}},{key:"displayUsersControl",value:function at(){if(this.settings.userfieldSettings.useUsers){if(this.settings.data.users.value===null&&K.Type.isArray(this.settings.userfieldSettings.users)){this.settings.data.users.value=this.settings.userfieldSettings.users}this.controls.users=new n({outerWrap:this.DOM.innerWrap,data:this.settings.data.users,userIndex:this.settings.userfieldSettings.userIndex});this.controls.users.display()}}},{key:"displayResourcesControl",value:function al(){if(this.settings.userfieldSettings.useResources){if(this.settings.data.resources.value===null&&K.Type.isArray(this.settings.userfieldSettings.resources)){this.settings.data.resources.value=[];this.settings.userfieldSettings.resources.forEach(function(az){this.settings.data.resources.value.push(parseInt(az.id))},this)}this.controls.resources=new y({outerWrap:this.DOM.innerWrap,data:this.settings.data.resources,resourceList:this.settings.userfieldSettings.resources});this.controls.resources.display()}}},{key:"displayServicesControl",value:function ar(){if(this.settings.userfieldSettings.useServices){if(this.settings.data.services.value===null&&K.Type.isArray(this.settings.userfieldSettings.services)){this.settings.data.services.value=[];this.settings.userfieldSettings.services.forEach(function(az){this.settings.data.services.value.push(az.name)},this)}this.controls.services=new ag({outerWrap:this.DOM.innerWrap,data:this.settings.data.services,serviceList:this.settings.userfieldSettings.services});this.controls.services.display()}}},{key:"displayDurationControl",value:function ai(){if(!this.settings.userfieldSettings.useServices){this.controls.duration=new ad({outerWrap:this.DOM.innerWrap,data:this.settings.data.duration,fullDay:this.settings.userfieldSettings.fullDay});this.controls.duration.display()}}},{key:"displayDateControl",value:function an(){this.controls.date=new U({outerWrap:this.DOM.innerWrap,data:this.settings.data.date});this.controls.date.display()}},{key:"displayTimeControl",value:function ap(){if(!this.settings.userfieldSettings.fullDay){this.controls.time=new C({outerWrap:this.DOM.innerWrap,data:this.settings.data.time});this.controls.time.display()}}},{key:"refreshLayout",value:function ak(aA){for(var az in this.controls){if(this.controls.hasOwnProperty(az)&&K.Type.isFunction(this.controls[az].refresh)){this.controls[az].refresh(aA[az]||this.settings.data[az])}}}},{key:"getInnerWrap",value:function am(){return this.DOM.innerWrap}},{key:"getOuterWrap",value:function ax(){return this.DOM.outerWrap}}]);return ay}(K.Event.EventEmitter);var B=function(ai){babelHelpers.inherits(aj,ai);function aj(ak){babelHelpers.classCallCheck(this,aj);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(aj).call(this,ak))}return aj}(A);var Y=function(ai){babelHelpers.inherits(aj,ai);function aj(al){babelHelpers.classCallCheck(this,aj);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(aj).call(this,al))}babelHelpers.createClass(aj,[{key:"build",value:function ak(){babelHelpers.get(babelHelpers.getPrototypeOf(aj.prototype),"build",this).call(this);this.DOM.outerWrap.className="calendar-resbook-webform-wrapper calendar-resbook-webform-wrapper-preview calendar-resbook-webform-wrapper-dark"}}]);return aj}(A);var J=function(au){babelHelpers.inherits(ak,au);function ak(ax){var aw;babelHelpers.classCallCheck(this,ak);aw=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(ak).call(this,ax));aw.id=ax.id||"bx-select-input-"+Math.round(Math.random()*1000000);if(K.Type.isFunction(ax.getValues)){aw.getValues=ax.getValues;aw.values=aw.getValues()}else{aw.values=ax.values||false}aw.input=ax.input;aw.defaultValue=ax.defaultValue||"";aw.openTitle=ax.openTitle||"";aw.className=ax.className||"";aw.currentValue=ax.value;aw.currentValueIndex=ax.valueIndex;aw.onChangeCallback=K.Type.isFunction(ax.onChangeCallback)?ax.onChangeCallback:null;aw.onAfterMenuOpen=ax.onAfterMenuOpen||null;aw.zIndex=ax.zIndex||1200;aw.disabled=ax.disabled;aw.editable=ax.editable!==false;aw.setFirstIfNotFound=!!ax.setFirstIfNotFound;if(aw.onChangeCallback){K.Event.bind(aw.input,"change",aw.onChangeCallback);K.Event.bind(aw.input,"keyup",aw.onChangeCallback)}aw.curInd=false;if(K.Type.isArray(aw.values)){K.Event.bind(aw.input,"click",aw.onClick.bind(babelHelpers.assertThisInitialized(aw)));if(aw.editable){K.Event.bind(aw.input,"focus",aw.onFocus.bind(babelHelpers.assertThisInitialized(aw)));K.Event.bind(aw.input,"blur",aw.onBlur.bind(babelHelpers.assertThisInitialized(aw)));K.Event.bind(aw.input,"keyup",aw.onKeyup.bind(babelHelpers.assertThisInitialized(aw)))}else{K.Event.bind(aw.input,"focus",function(){this.input.blur()}.bind(babelHelpers.assertThisInitialized(aw)))}if(aw.currentValueIndex===undefined&&aw.currentValue!==undefined){aw.currentValueIndex=-1;for(var av=0;av<aw.values.length;av++){if(parseInt(aw.values[av].value)===parseInt(aw.currentValue)){aw.currentValueIndex=av;break}}if(aw.currentValueIndex===-1){aw.currentValueIndex=aw.setFirstIfNotFound?0:undefined}}}if(aw.currentValueIndex!==undefined&&aw.values[aw.currentValueIndex]){aw.input.value=aw.values[aw.currentValueIndex].label}return aw}babelHelpers.createClass(ak,[{key:"showPopup",value:function ao(){if(this.getValues){this.values=this.getValues()}if(this.shown||this.disabled||!this.values.length){return}var aA=0,av=0,ax=[],aw,aB=this;for(aw=0;aw<this.values.length;aw++){if(this.values[aw].delimiter){ax.push(this.values[aw])}else{if(this.currentValue&&this.values[aw]&&this.values[aw].value===this.currentValue.value||this.input.value===this.values[aw].label){aA=av}ax.push({id:this.values[aw].value+"_"+aw,text:this.values[aw].label,onclick:this.values[aw].callback||function(aD,aC){return function(){aB.input.value=aC;aB.popupMenu.close();aB.onChange(aD,aC)}}(this.values[aw].value,this.values[aw].labelRaw||this.values[aw].label)});av++}}this.popupMenu=i.MenuManager.create(this.id,this.input,ax,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:0,cacheable:false});this.popupMenu.popupWindow.setWidth(this.input.offsetWidth-2);var az=this.popupMenu.layout.menuContainer;K.Dom.addClass(this.popupMenu.layout.menuContainer,"calendar-resourcebook-select-popup");this.popupMenu.show();var ay=this.popupMenu.menuItems[aA];if(ay&&ay.layout){az.scrollTop=ay.layout.item.offsetTop-2}E.bindCustomEvent(this.popupMenu.popupWindow,"onPopupClose",function(){this.shown=false}.bind(this));this.input.select();if(K.Type.isFunction(this.onAfterMenuOpen)){this.onAfterMenuOpen(aA,this.popupMenu)}this.shown=true}},{key:"closePopup",value:function ar(){i.MenuManager.destroy(this.id);this.shown=false}},{key:"onFocus",value:function ap(){setTimeout(function(){if(!this.shown){this.showPopup()}}.bind(this),200)}},{key:"onClick",value:function an(){if(this.shown){this.closePopup()}else{this.showPopup()}}},{key:"onBlur",value:function ai(){setTimeout(this.closePopup.bind(this),200)}},{key:"onKeyup",value:function at(){setTimeout(this.closePopup.bind(this),50)}},{key:"onChange",value:function am(av){var aw=this.input.value;this.emit("BX.Calendar.Resourcebooking.SelectInput:changed",new K.Event.BaseEvent({data:{selectinput:this,value:aw,realValue:av}}));if(this.onChangeCallback){this.onChangeCallback({value:aw,realValue:av})}}},{key:"destroy",value:function aq(){if(this.onChangeCallback){K.Event.unbind(this.input,"change",this.onChangeCallback);K.Event.unbind(this.input,"keyup",this.onChangeCallback)}K.Event.unbind(this.input,"click",this.onClick.bind(this));K.Event.unbind(this.input,"focus",this.onFocus.bind(this));K.Event.unbind(this.input,"blur",this.onBlur.bind(this));K.Event.unbind(this.input,"keyup",this.onKeyup.bind(this));if(this.popupMenu){this.popupMenu.close()}i.MenuManager.destroy(this.id);this.shown=false}},{key:"setValue",value:function aj(ax){this.input.value=ax;if(K.Type.isArray(this.values)){var av=-1;for(var aw=0;aw<this.values.length;aw++){if(this.values[aw].value===ax){av=aw;break}}if(av!==-1){this.input.value=this.values[av].label;this.currentValueIndex=av}}}},{key:"getValue",value:function al(){return this.input.value}}]);return ak}(K.Event.EventEmitter);var H=window.BX&&BX.Main&&BX.Main.Date?BX.Main.Date:null;var h=function(){function aj(){babelHelpers.classCallCheck(this,aj)}babelHelpers.createClass(aj,null,[{key:"getLiveField",value:function ai(am){if(!am.wrap||!K.Type.isDomNode(am.wrap)){throw new Error('The argument "params.wrap" must be a DOM node.')}if(K.Type.isNull(H)){throw new Error("The error occured during Date extention loading")}var al=new o(am);al.init();return al}},{key:"getPreviewField",value:function ak(al){}}]);return aj}();aa.Type=K.Type;aa.Loc=K.Loc;aa.Dom=K.Dom;aa.Event=K.Event;aa.Tag=K.Tag;aa.Browser=K.Browser;aa.Text=K.Text;aa.Runtime=K.Runtime;aa.PopupManager=i.PopupManager;aa.MenuManager=i.MenuManager;aa.CoreDate=H;aa.BookingUtil=E;aa.FieldViewControllerEdit=B;aa.FieldViewControllerPreview=Y;aa.SelectInput=J;aa.Resourcebooking=h}((this.BX.Calendar=this.BX.Calendar||{}),BX,BX.Event,BX,BX.Main));