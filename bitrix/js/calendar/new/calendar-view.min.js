(function(d){function f(h){this.calendar=h;this.util=h.util;this.entryController=h.entryController;this.name="#calendar view#";this.title=this.name;this.enabled=true;this.contClassName="";this.isBuilt=false;this.animateClass="calendar-grid-animate";this.collapseOffHours=this.util.getUserOption("collapseOffHours","Y")=="Y";this.entries=[];this.entriesIndex={};BX.addCustomEvent(this.calendar,"viewOnClick",BX.proxy(this.handleClick,this))}f.prototype={build:function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName}})},show:function(){if(!this.isBuilt){this.build();this.isBuilt=true}this.viewCont.style.display="";this.setTitle()},refresh:function(){this.displayEntries()},hide:function(){this.viewCont.style.display="none"},getName:function(){return this.name},getContainer:function(){return this.viewCont},setTitle:function(h){this.calendar.viewTitle.innerHTML=h.replace("#GRAY_START#",'<span class="calendar-top-title-gray">').replace("#GRAY_END#","</span>")},getIsBuilt:function(){return this.isBuilt},fadeAnimation:function(h,i,j){new BX.easing({duration:i||200,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(k){h.style.opacity=k.opacity/100},complete:function(){if(j&&BX.type.isFunction(j)){j()}}}).animate()},showAnimation:function(h,i,j){new BX.easing({duration:i||200,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(k){h.style.opacity=k.opacity/100},complete:function(){h.removeAttribute("style");if(j&&BX.type.isFunction(j)){j()}}}).animate()},getArrow:function(i,h,k){var n=BX.util.urlencode(h),m=k?BX.util.urlencode(h):"none",l="",j;if(i=="left"){j=BX.create("DIV",{props:{className:"calendar-event-angle-start-yesterday"}});l="url(data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2215px%22%20height%3D%2218px%22%20viewBox%3D%220%200%2015%2018%22%20version%3D%221.1%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%0A%3Cpath%20fill%3D%22"+m+"%22%20stroke%3D%22"+n+"%22%20stroke-width%3D%221%22%20d%3D%22M14.5%2C17.5%20L14.5%2C0.5%20L2.00049088%2C0.5%20C1.78697323%2C0.5%201.57591593%2C0.545584%201.38143042%2C0.633704227%20C0.626846099%2C0.975601882%200.292297457%2C1.86447615%200.634195112%2C2.61906047%20L3.05787308%2C7.96823256%20C3.35499359%2C8.62399158%203.35499359%2C9.37600842%203.05787308%2C10.0317674%20L0.634195112%2C15.3809395%20C0.546074885%2C15.575425%200.500490885%2C15.7864823%200.500490885%2C16%20C0.500490885%2C16.8284271%201.17206376%2C17.5%202.00049088%2C17.5%20L14.5%2C17.5%20Z%22/%3E%0A%3C/svg%3E)"}else{j=BX.create("DIV",{props:{className:"calendar-event-angle-finish-tomorrow"}});l="url(data:image/svg+xml;charset=US-ASCII,%3Csvg%20width%3D%2215px%22%20height%3D%2218px%22%20viewBox%3D%220%200%2015%2018%22%20version%3D%221.1%22%20xmlns%3D%22http%3A//www.w3.org/2000/svg%22%3E%0A%3Cpath%20fill%3D%22"+m+"%22%20stroke%3D%22"+n+"%22%20stroke-width%3D%221%22%20d%3D%22M0.5%2C0.5%20L0.5%2C17.5%20L8.7031205%2C17.5%20C9.65559352%2C17.5%2010.5253145%2C16.9587787%2010.9460243%2C16.1042565%20L13.8991717%2C10.1059895%20C14.2418971%2C9.40986472%2014.2419701%2C8.59406382%2013.8993692%2C7.89787777%20L10.9458495%2C1.89614482%20C10.5252214%2C1.04140271%209.65538246%2C0.5%208.70274816%2C0.5%20L0.5%2C0.5%20Z%22/%3E%0A%3C/svg%3E)"}j.style.backgroundImage=l;return j},occupySlot:function(j){if(this.days){var h;for(h=j.startIndex;h<j.endIndex;h++){if(this.days[h]){this.days[h].slots[j.slotIndex]=false}}}},showSimplePopup:function(h){if(!this.simpleEntryPopup){this.simpleEntryPopup=new d.BXEventCalendar.SimpleAddPopup(this.calendar)}this.simpleEntryPopup.show(h)},showSimpleViewPopup:function(h){if(!this.simpleViewPopup){this.simpleViewPopup=new d.BXEventCalendar.SimpleViewPopup(this.calendar)}else{if(this.simpleViewPopup.isShown()){this.simpleViewPopup.close()}}this.simpleViewPopup.show(h)},showEditSlider:function(h){if(this.simpleViewPopup){this.simpleViewPopup.close()}if(!h||!h.entry){h={}}if(this.simpleEntryPopup){h.newEntryData=this.simpleEntryPopup.getPopupData();this.simpleEntryPopup.close()}if(!this.calendar.editSlider){this.calendar.editSlider=new d.BXEventCalendar.EditEntrySlider(this.calendar)}this.calendar.editSlider.show(h)},handleEntryClick:function(i){var h=i.entry||this.getEntryById(i.uid);i.entry=i.entry||this.getEntryById(i.uid);if(i.entry.isSelected()){if(i.entry.isTask()){BX.SidePanel.Instance.open(this.calendar.util.getViewTaskPath(i.entry.id),{loader:"task-new-loader"})}else{this.showViewSlider({entry:i.entry})}}this.deselectEntry();this.selectEntry(i.entry);if(this.name=="week"||this.name=="month"){this.showSimpleViewPopup(i)}},showViewSlider:function(h){if(!this.calendar.viewSlider){this.calendar.viewSlider=new d.BXEventCalendar.ViewEntrySlider(this.calendar)}this.calendar.viewSlider.show(h);if(this.simpleViewPopup){this.simpleViewPopup.close()}setTimeout(BX.delegate(function(){if(this.simpleViewPopup){this.simpleViewPopup.close()}},this),200)},isActive:function(){return this.calendar.currentViewName===this.name},getEntryById:function(h){if(h&&this.entriesIndex[h]!==undefined&&this.entries[this.entriesIndex[h]]){return this.entries[this.entriesIndex[h]]}return false},selectEntry:function(h){if(h&&h.parts){if(h.select){h.select()}h.parts.forEach(function(i){i.params=this.selectEntryPart(i.params,h.color,h.isExpired())},this);this.selectedEntry=h;if(this.name!=="week"&&this.name!=="month"){this.showAdditionalInfo(h)}}},selectEntryPart:function(i,h){if(i.wrapNode){i.backupWrapZIndex=i.wrapNode.style.zIndex||"";i.wrapNode.style.zIndex=4000;i.backupWrapNodeClass=i.wrapNode.className;BX.addClass(i.wrapNode,"calendar-event-line-fill");BX.addClass(i.wrapNode,"active")}if(i.blockBackgroundNode){i.backupBlockOpacity=i.blockBackgroundNode.style.opacity;i.blockBackgroundNode.style.opacity=1}if(i.innerContainer){i.backupBackground=i.innerContainer.style.background;i.backupBorderColor=i.innerContainer.style.borderColor;i.innerContainer.style.backgroundColor=h;i.innerContainer.style.borderColor=h}if(i.nameNode){i.backupNameColor=i.nameNode.style.color;i.nameNode.style.color="#fff"}if(i.timeNode){i.backupTimeColor=i.timeNode.style.color;i.backupTimeZIndex=i.timeNode.style.zIndex||0;i.timeNode.style.color="#fff";i.timeNode.style.zIndex=200}return i},deselectEntry:function(h){if(!h&&this.selectedEntry){h=this.selectedEntry}if(h){if(h.deselect){h.deselect()}h.parts.forEach(function(i){if(i.params.wrapNode){i.params.wrapNode.className=i.params.backupWrapNodeClass;i.params.wrapNode.style.zIndex=i.params.backupWrapZIndex}if(i.params.innerContainer){i.params.innerContainer.style.backgroundColor=i.params.backupBackground;i.params.innerContainer.style.borderColor=i.params.backupBorderColor}if(i.params.blockBackgroundNode){i.params.blockBackgroundNode.style.opacity=i.params.backupBlockOpacity}if(i.params.nameNode){i.params.nameNode.style.color=i.params.backupNameColor}if(i.params.timeNode){i.params.timeNode.style.color=i.params.backupTimeColor;i.params.timeNode.style.zIndex=i.params.backupTimeZIndex}},this)}BX.remove(this.calendar.additionalInfoOuter);this.selectedEntry=false},getSelectedEntry:function(){return this.selectedEntry||false},preloadEntries:function(){},showAllEventsInPopup:function(l){var k,h;k=BX.create("DIV",{props:{className:"calendar-all-events-popup calendar-custom-scroll"},events:{click:BX.proxy(this.calendar.handleViewsClick,this.calendar)}});l.day.entries.list.sort(this.calendar.entryController.sort);var i,j;l.day.entries.list.forEach(function(m){if(m.entry){if(m.entry.isTask()){if(!i){k.appendChild(BX.create("DIV",{props:{className:"calendar-event-title"},text:BX.message("EC_ENTRIES_TASKS")}));i=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-block"}}))}this.displayEntryPiece({entry:m.entry,part:m.part,holder:i,popupMode:true})}else{if(!j){k.appendChild(BX.create("DIV",{props:{className:"calendar-event-title"},text:BX.message("EC_ENTRIES_EVENTS")}));j=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-block"}}))}this.displayEntryPiece({entry:m.entry,part:m.part,holder:j,popupMode:true})}}},this);h=BX.PopupWindowManager.create(this.calendar.id+"-all-events-popup",l.day.hiddenStorage,{autoHide:true,closeByEsc:true,offsetTop:-2,offsetLeft:this.getDayWidth()/2+4,lightShadow:true,content:k});h.setAngle({offset:118});h.show(true);this.allEventsPopup=h;BX.addCustomEvent(h,"onPopupClose",function(){h.destroy()})},showAdditionalInfo:function(h){BX.remove(this.calendar.additionalInfoOuter);this.calendar.additionalInfoOuter=this.calendar.rightBlock.appendChild(BX.create("DIV",{props:{className:"calendar-right-block hide"}}));if(!this.simpleViewPopup){this.simpleViewPopup=new d.BXEventCalendar.SimpleViewPopup(this.calendar)}this.calendar.additionalInfoOuter.appendChild(this.simpleViewPopup.createContent({entry:h}))},showNavigationCalendar:function(){setTimeout(BX.delegate(function(){if(this.calendar.rightBlock){if(!this.calendar.navCalendar){this.calendar.navCalendar=new d.BXEventCalendar.NavigationCalendar(this.calendar,{wrap:this.calendar.rightBlock.appendChild(BX.create("DIV",{props:{className:"calendar-right-block"}}))})}if(this.calendar.initialViewShow){BX.addClass(this.calendar.mainCont,"calendar-main-container-small-calendar");this.calendar.initialViewShow=false}this.calendar.navCalendar.show()}},this),0)},getDayWidth:function(){var h=200;if(this.days&&this.days[0]&&this.days[0].node){h=this.days[0].node.offsetWidth||h}return Math.min(h,400)}};function e(){f.apply(this,arguments);this.initConfig();this.preBuild()}e.prototype=Object.create(f.prototype);e.prototype.constructor=e;e.prototype.initConfig=function(){this.name="day";this.gridLineHeight=60;this.slotHeight=20;this.title=BX.message("EC_VIEW_DAY");this.entryWidthOffset=2;this.lastEntryWidthOffset=14;this.contClassName="calendar-day-view";this.gridWrapClass="calendar-grid-wrap";this.fullDayContClass="calendar-grid-day-full-days-events-holder";this.fullDayContHolderClass="calendar-grid-week-full-days-events-holder-grid";this.topEntryHolderClass="calendar-grid-day-events-holder";this.outerGridClass="calendar-grid-day-container";this.gridClass="calendar-grid-day";this.gridClassCurrent="calendar-grid-day-current";this.gridClassNext="calendar-grid-day-left-slide";this.gridClassPrevious="calendar-grid-day-right-slide";this.changeNextClass="calendar-change-day-left-slide";this.changePreviousClass="calendar-change-day-right-slide";this.gridRowClass="calendar-grid-day-row";this.gridCellClass="calendar-grid-day-cell";this.gridTimelinesClass="calendar-grid-day-time-lines";this.gridTimelineHourClass="calendar-grid-day-time-line-hour";this.gridTimelineHourLabelClass="calendar-grid-day-time-line-hour-label";this.gridTimelineHourLabelClassInner="calendar-grid-week-time-line-hour-label-inner";this.gridNowTimeClass="calendar-grid-day-time-line-hour-now";this.gridNowTimeLabelClass="calendar-grid-day-time-line-hour-label";this.gridNowTimeLineClass="calendar-grid-day-time-line-hour-now-line";this.gridNowTimeDotClass="calendar-grid-day-time-line-hour-now-dot";this.gridTimeTranslucentClass="calendar-grid-time-line-translucent";this.offHoursClass="calendar-grid-off-hours";this.offHoursCollapseClass="calendar-grid-off-hours-collapse";this.offHoursAnimateClass="calendar-grid-off-hours-animate";this.offHoursFastAnimateClass="calendar-grid-off-hours-fast-animate";this.dayCount=1};e.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}})};e.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-week-row-days-week"}}));var h=this.util.getWorkTime();this.checkTimelineScroll(!this.collapseOffHours||(h.end-h.start)*this.gridLineHeight+20>this.util.getViewHeight());this.fullDayEventsCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:this.fullDayContClass}}));this.gridWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:this.gridWrapClass},style:{height:this.util.getViewHeight()+"px"}}));this.outerGrid=this.gridWrap.appendChild(BX.create("DIV",{props:{className:this.outerGridClass}}));this.grid=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassCurrent}}));BX.bind(this.gridWrap,"mousedown",BX.proxy(this.handleMousedown,this))};e.prototype.show=function(){f.prototype.show.apply(this,arguments);this.buildDaysGrid();this.showNavigationCalendar();BX.remove(this.calendar.additionalInfoOuter);this.displayEntries()};e.prototype.hide=function(){f.prototype.hide.apply(this,arguments)};e.prototype.setFullDayHolderSize=function(h){this.fullDayEventsCont.style.height=(h*(this.slotHeight+1))+"px"};e.prototype.increaseViewRangeDate=function(){this.changeViewRangeDate(this.dayCount);this.setTitle();if(this.gridWrap){this.gridWrap.style.overflowX="hidden"}var h=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassNext+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.buildDaysGrid({grid:h});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.outerGrid,this.changeNextClass);setTimeout(BX.delegate(function(){BX.removeClass(this.outerGrid,this.changeNextClass);BX.removeClass(h,this.gridClassNext);BX.addClass(h,this.gridClassCurrent);BX.remove(this.grid);this.grid=h;BX.removeClass(this.grid,this.animateClass);this.gridWrap.style.overflowX="";this.displayEntries()},this),400)},this),0)};e.prototype.decreaseViewRangeDate=function(){this.changeViewRangeDate(-this.dayCount);this.setTitle();this.gridWrap.style.overflowX="hidden";var h=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassPrevious+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.buildDaysGrid({grid:h});setTimeout(BX.delegate(function(){BX.addClass(this.outerGrid,this.changePreviousClass);setTimeout(BX.delegate(function(){BX.removeClass(this.outerGrid,this.changePreviousClass);BX.removeClass(h,this.gridClassPrevious);BX.addClass(h,this.gridClassCurrent);BX.remove(this.grid);this.grid=h;BX.removeClass(this.grid,this.animateClass);this.gridWrap.style.overflowX="";this.displayEntries()},this),400)},this),0)};e.prototype.changeViewRangeDate=function(j){var i=this.calendar.getViewRangeDate(),h=new Date(i.getTime());h.setDate(h.getDate()+j);this.calendar.setViewRangeDate(h);return h};e.prototype.getViewRange=function(){var h=this.calendar.getViewRangeDate(),i=new Date(h.getTime());i.setDate(i.getDate()+this.dayCount);return{start:h,end:i}};e.prototype.getAdjustedDate=function(i,h){if(!i){i=new Date()}if(h&&i.getTime()<h.start.getTime()){i=new Date(h.start.getTime())}if(h&&i.getTime()>h.end.getTime()){i=new Date(h.end.getTime())}var j=false;if(i&&i.getTime){i.setHours(0,0,0,0);j=new Date(i.getTime())}return j};e.prototype.adjustViewRangeToDate=function(i,h){var j=this.calendar.getViewRangeDate(),k=false;if(i&&i.getTime){i.setHours(0,0,0,0);var l=(i.getTime()-j.getTime())/this.calendar.util.dayLength;if(l==this.dayCount){this.increaseViewRangeDate()}else{if(l==-this.dayCount){this.decreaseViewRangeDate()}else{k=new Date(i.getTime());k.setHours(0,0,0,0);this.calendar.setViewRangeDate(k);if(h===false){this.show()}else{this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}}}}return k};e.prototype.buildDaysGrid=function(n){if(!n){n={}}var l,j,k=n.grid||this.grid,m=this.calendar.getViewRangeDate(),h=new Date(m.getTime());if(this.dayCount>1){h=this.getAdjustedDate(h)}BX.cleanNode(k);BX.cleanNode(this.fullDayEventsCont);this.holderTitle=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-day-full-days-events-holder-title"},text:BX.message("EC_VIEW_DAY")}));this.fullDayEventsHolderCont=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:this.fullDayContHolderClass}}));this.topEntryHolder=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:this.topEntryHolderClass}}));this.gridRow=k.appendChild(BX.create("DIV",{props:{className:this.gridRowClass+" "+this.animateClass},style:{height:this.getDayGridHeight()+"px"}}));this.dayIndex={};this.days=[];if(this.titleCont){BX.cleanNode(this.titleCont)}this.gridRowShadow=BX.create("DIV",{props:{className:"calendar-grid-week-row-shadow"}});for(l=0;l<this.dayCount;l++){j=this.util.getDayCode(h);this.fullDayEventsHolderCont.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-week-day":j},props:{className:this.gridCellClass}}));this.buildDayCell({date:h,month:"previous",grid:k});if(this.dayCount>1){h.setDate(h.getDate()+1)}this.gridRowShadow.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-timeline-day":j},props:{className:"calendar-grid-week-cell"},html:'<span class="calendar-grid-cell-inner"></span>'}))}this.timeLinesCont=this.gridRow.appendChild(BX.create("DIV",{props:{className:this.gridTimelinesClass}}));this.timelineEntryHolder=this.gridRow.appendChild(BX.create("DIV",{props:{className:this.topEntryHolderClass}}));this.timeLinesIndex=[];for(l=0;l<=24;l++){this.timeLinesIndex[l]=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourClass},html:'<div class="'+this.gridTimelineHourLabelClass+'">'+this.calendar.util.formatTime(l,0,true)+"</div>",style:{top:((l)*this.gridLineHeight)+"px"}}))}this.gridRow.appendChild(this.gridRowShadow);setTimeout(BX.delegate(function(){if(!this.gridWrap.scrollTop&&!this.collapseOffHours){var i=this.util.getWorkTime();this.gridWrap.scrollTop=i.start*this.gridLineHeight-5}},this),0);this.showOffHours();this.showNowTime(this.timeLinesCont);this.gridRow.appendChild(BX.create("DIV",{props:{className:"calendar-grid-day-events-holder"}}))};e.prototype.buildDayCell=function(o){var k=o.date,l="",m="",n=Math.round(k.getTime()/1000)*1000,h=k.getDay(),j=this.util.getDayCode(k),i=this.util.getWeekDayByInd(h);if(o.month=="previous"){m+=" calendar-grid-previous-month-day"}else{if(o.month=="next"){m+=" calendar-grid-next-month-day"}}if(this.util.isHoliday(k)){m+=" calendar-grid-holiday"}if(this.util.isToday(k)){l+=" calendar-grid-today"}if(this.titleCont&&this.name=="week"){this.titleCont.appendChild(BX.create("DIV",{props:{className:this.gridCellClass+l},html:'<span class="calendar-grid-cell-inner" data-bx-calendar-date="'+n+'">'+(BX.message("EC_WEEK_TITLE").replace("#DAY_OF_WEEK#",BX.date.format("D",n/1000)).replace("#DATE#",k.getDate()))+"</span>"}))}else{if(this.titleCont){this.titleCont.appendChild(BX.create("DIV",{props:{className:this.gridCellClass+l},html:'<span class="calendar-grid-cell-inner" data-bx-calendar-date="'+n+'"><span class="calendar-day-of-week-day">'+BX.date.format("l",n/1000)+"</span></span>"}))}}this.days.push({date:new Date(k.getTime()),dayOffset:this.util.getWeekDayOffset(i),node:this.gridRow.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-timeline-day":j},props:{className:this.gridCellClass+m+" a1"},html:'<span class="calendar-grid-cell-inner"></span>'})),dayCode:j});this.dayIndex[this.days[this.days.length-1].dayCode]=this.days.length-1;this.calendar.dragDrop.registerTimelineDay(this.days[this.days.length-1])};e.prototype.setTitle=function(){var h=this.calendar.getViewRangeDate(),i=h.getTime()/1000;f.prototype.setTitle.apply(this,[BX.date.format(BX.message("EC_DATE_FORMAT_1_MAY"),i)+" #GRAY_START#"+BX.date.format("Y",i)+"#GRAY_END#"])};e.prototype.displayEntries=function(m){var n,r,j,o,p,h,k=0,q=this.getViewRange();if(!m){m={}}if(m.reloadEntries!==false){this.entries=this.entryController.getList({startDate:new Date(q.start.getFullYear(),q.start.getMonth(),1),finishDate:new Date(q.end.getFullYear(),q.end.getMonth()+1,1),viewRange:q,finishCallback:BX.proxy(this.displayEntries,this)})}this.partsStorage=[];this.timelinePartsStorage=[];BX.cleanNode(this.topEntryHolder);BX.cleanNode(this.timelineEntryHolder);this.fullDayEventsCont.style.height="";this.days.forEach(function(i){i.slots=[];i.timelineMap={};i.entries={topList:[],started:[],timeline:[],hidden:[]}});if(this.entries&&this.entries.length){for(n=0;n<this.entries.length;n++){r=this.entries[n];this.entriesIndex[r.uid]=n;r.cleanParts();h=false;for(o=this.dayIndex[r.startDayCode];o<this.days.length;o++){p=this.days[o];if(!r.isLongWithTime()&&p.dayCode==r.startDayCode&&p.dayCode==r.endDayCode&&!r.fullDay){j=r.startPart({from:p,to:p,daysCount:0,fromTimeValue:this.util.getTimeValue(r.from),toTimeValue:this.util.getTimeValue(r.to)});p.entries.timeline.push({entry:r,part:j});this.timelinePartsStorage.push({part:j,entry:r});break}else{if(p.dayCode==r.startDayCode){h=true;j=r.startPart({from:p,daysCount:0});p.entries.started.push({entry:r,part:j})}if(h){p.entries.topList.push({entry:r,part:j});j.daysCount++;j.to=p;if(p.entries.topList.length>k){k=p.entries.topList.length}if(p.dayCode==r.endDayCode||p.dayOffset==this.dayCount-1||this.dayCount==1){this.partsStorage.push({part:j,entry:r});if(p.dayCode==r.endDayCode){break}}}}}}}this.setFullDayHolderSize(Math.max(k,1));if(this.entries&&this.entries.length){this.displayTopEntries();this.displayTimelineEntries();this.slotsCount=100;this.arrangeTopEntries();this.arrangeTimelineEntries()}BX.addClass(this.grid,"calendar-events-holder-show");BX.addClass(this.fullDayEventsCont,"calendar-events-holder-show");var l=this.util.getWorkTime();this.checkTimelineScroll(!this.collapseOffHours||(l.end-l.start)*this.gridLineHeight+20>this.util.getViewHeight())};e.prototype.arrangeTopEntries=function(){var m,l,p,k,o,n,h;for(p=0;p<this.days.length;p++){k=this.days[p];if(k.entries.started.length>0){k.entries.started.sort(this.calendar.entryController.sort);for(m=0;m<k.entries.started.length;m++){if(k.entries.started[m]){o=k.entries.started[m].entry;n=k.entries.started[m].part;if(!o.checkPartIsRegistered(n)){continue}h=false;for(l=0;l<this.slotsCount;l++){if(k.slots[l]!==false){this.occupySlot({slotIndex:l,startIndex:p,endIndex:p+n.daysCount});h=true;o.getWrap(n.partIndex).style.top=(l*this.slotHeight)+"px";break}}}if(k.hiddenStorage&&k.entries.hidden.length>0){k.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" ("+k.entries.list.length+")"}}}}};e.prototype.arrangeTimelineEntries=function(){var s=30,F=33,M=20,q=40,B=23,z=6,y=2,K,v,A,p,H,D,G,O,m,I,x,E,w,C,h,N,J,k,j;function o(P){var i,l;for(i=P.timeFrom;i<P.timeTo;i++){if(!P.layers[i]){P.layers[i]=[]}l=P.day.layers[i][P.layerIndex]||{entries:[],start:[]};l.entries.push(P.entryIndex);if(i==P.timeFrom){l.start.push(P.entryIndex);P.entryPart.layerParallels=l.start.length}P.day.layers[i][P.layerIndex]=l}P.entryPart.layerIndex=P.layerIndex}function r(l,P){var i=G.layers[l][P];return i&&i.entries&&i.entries.length==i.start.length}function n(i){return !i}function L(S){var i,Q,l,P=[],R={};for(i=S.timeFrom;i<S.timeTo;i++){if(S.layerIndex>0&&S.day.layers[i][S.layerIndex-1]){Q=S.day.layers[i][S.layerIndex-1].entries;if(Q.length>0){l=Q[Q.length-1];if(!R[l]){R[l]=true;P.push(l)}}}}return P}function u(i,l){if(!l){l=s}return i.getHours()*60+Math.floor(i.getMinutes()/l)*l}for(D=0;D<this.days.length;D++){G=this.days[D];G.entries.timeline.sort(function(l,i){if(l.part.fromTimeValue==i.part.fromTimeValue){return(i.part.toTimeValue-i.part.fromTimeValue)-(l.part.toTimeValue-l.part.fromTimeValue)}return l.part.fromTimeValue-i.part.fromTimeValue});K=0;A="";v=0;E=0;G.layers=[];for(p=0;p<G.entries.timeline.length;p++){k=G.entries.timeline[p].entry;j=G.entries.timeline[p].part;I=u(k.from);x=u(k.to,1);if(I==x){x+=1}if(!G.layers){G.layers=[]}w=0;while(true){if(!G.layers[I]||r(I,w)||n(G.layers[I][w])){o({day:G,timeFrom:I,timeTo:x,layers:G.layers,entryIndex:p,layerIndex:w,entryPart:j});break}w++}}for(p=0;p<G.entries.timeline.length;p++){if(G.entries.timeline[p]){k=G.entries.timeline[p].entry;j=G.entries.timeline[p].part;I=u(k.from);x=u(k.to,1);if(I==x){x+=1}if(!k.checkPartIsRegistered(j)||!G.layers[I]||!G.layers[I][j.layerIndex]){continue}m=G.layers[I][j.layerIndex].start;if(j.params&&j.params.wrapNode){j.params.wrapNode.style.zIndex=I}j.absoluteLeftOffset=y;if(j.layerIndex>0){J=L({day:G,entryIndex:p,layerIndex:j.layerIndex,timeFrom:I,timeTo:x});for(H=0;H<J.length;H++){C=G.entries.timeline[J[H]];if(C&&C.part&&C.part.params&&j.params.wrapNode){h=parseInt(j.params.wrapNode.style.top)-parseInt(C.part.params.wrapNode.style.top);if(h>F){j.offsetFractionLeft=C.part.offsetFractionWidth*0.1}else{j.offsetFractionLeft=C.part.offsetFractionWidth*0.45}j.offsetFractionLeftTotal=C.part.offsetFractionLeftTotal+j.offsetFractionLeft;j.offsetFractionWidth=1-j.offsetFractionLeftTotal;if(this.dayCount>1){j.offsetLeftRate=j.from.dayOffset+j.offsetFractionLeftTotal}else{j.offsetLeftRate=j.offsetFractionLeftTotal}j.absoluteLeftOffset=(C.absoluteLeftOffset||y)+z;N=1-j.offsetFractionLeftTotal;if(h<=F){if(h<M){C.part.params.timeNode.style.maxWidth="calc("+((1-j.offsetFractionWidth)*100)+"% - 4px)";if(C.part.params.timeNode.offsetWidth<q){C.part.params.timeNode.style.textOverflow="clip";C.part.params.timeNode.style.maxWidth=q+"px"}}C.part.params.nameNode.style.maxWidth="calc("+((1-j.offsetFractionWidth)*100)+"% - 4px)";if(C.part.params.nameNode.offsetWidth<q){C.part.params.nameNode.style.textOverflow="clip";C.part.params.nameNode.style.maxWidth="calc("+((1-j.offsetFractionWidth)*100)+"% + 5px)";this.checkTimelineEntrySize(C.part,C.entry,true)}}else{C.part.params.nameNode.style.maxHeight=(h-B)+"px"}j.params.wrapNode.style.left="calc((100% / "+this.dayCount+") * "+j.offsetLeftRate+")";j.params.wrapNode.style.width="calc(100% / ("+this.dayCount+") * "+j.offsetFractionWidth+" - "+this.lastEntryWidthOffset+"px)";BX.addClass(j.params.wrapNode,"calendar-bordered-block")}}}if(m.length>1){O=BX.util.array_search(p,G.layers[I][j.layerIndex].start);var t=this.entryWidthOffset;if(O==G.layers[I][j.layerIndex].start.length-1){t=this.lastEntryWidthOffset;if(j.absoluteLeftOffset>y){t+=(j.absoluteLeftOffset/m.length)+1}}if(this.dayCount>1){j.params.wrapNode.style.width="calc(100% / ("+this.dayCount+" * "+m.length+") - "+t+"px)";j.params.wrapNode.style.left="calc((100% / "+this.dayCount+") * "+j.from.dayOffset+" + 100% * "+O+"/ ("+this.dayCount+" * "+m.length+") + "+j.absoluteLeftOffset+"px)"}else{j.params.wrapNode.style.width="calc(100% / ("+this.dayCount+" * "+m.length+") - "+t+"px)";j.params.wrapNode.style.left="calc(100% * "+O+"/ "+m.length+" + "+j.absoluteLeftOffset+"px)"}}this.checkTimelineEntrySize(j,k,true)}}}};e.prototype.fillTimelineMap=function(l,k,h){var j,n=k.from.getHours()*60+k.from.getMinutes(),m=k.to.getHours()*60+k.to.getMinutes();for(j=n;j<m;j++){if(!l[j]){l[j]=[]}l[j].push(h)}};e.prototype.displayTopEntry=function(l){var p,t=l.entry,s=l.part.from,k=l.part.daysCount,u,r,v,h,o,j,m,w="calendar-event-line-wrap",n=0,i,q;if(t.isFullDay()){w+=" calendar-event-line-fill"}else{if(t.isLongWithTime()){w+=" calendar-event-line-border"}}if(t.isExternal()){w+=" calendar-event-line-intranet"}if(this.util.getDayCode(t.from)!==this.util.getDayCode(s.date)){w+=" calendar-event-line-start-yesterday";n+=8;i=this.getArrow("left",t.color,t.isFullDay())}if(this.util.getDayCode(t.to)!==this.util.getDayCode(l.part.to.date)){w+=" calendar-event-line-finish-tomorrow";q=this.getArrow("right",t.color,t.isFullDay());n+=12}if(i&&!q){n+=4}if(n==0){n=5}u=BX.create("DIV",{attrs:{"data-bx-calendar-entry":t.uid},props:{className:w},style:{top:0,left:this.dayCount>1?"calc((100% / "+this.dayCount+") * ("+(s.dayOffset+1)+" - 1) + 2px)":"2px",width:"calc("+k+" * 100% / "+this.dayCount+" - "+n+"px)"}});if(i){u.appendChild(i);u.style.left="9px"}if(q){u.appendChild(q)}m=u.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));v=m.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));r=v.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-dot"}}));if(t.isFullDay()){v.style.maxWidth="calc(200% / "+k+" - "+this.lastEntryWidthOffset+"px)"}else{if(t.isLongWithTime()){u.style.borderColor=t.color;v.style.maxWidth="calc(200% / "+k+" - "+this.lastEntryWidthOffset+"px)";if(l.part.partIndex==0){if(k>1){o=v.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(t.from.getHours(),t.from.getMinutes())}))}v.style.width="calc(100% / "+k+" - "+this.lastEntryWidthOffset+"px)"}if(!o&&k==1&&this.util.getDayCode(t.from)==l.part.from.dayCode){o=v.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(t.from.getHours(),t.from.getMinutes())}))}if(l.part.partIndex==t.parts.length-1){if(k>1&&t.parts.length>1){v.style.width="calc("+(k-1)+"00% / "+k+" - "+this.lastEntryWidthOffset+"px)"}if(k>1){j=v.appendChild(BX.create("SPAN",{props:{className:(t.parts.length>1&&k==1)?"calendar-event-line-time":"calendar-event-line-expired-time"},text:this.calendar.util.formatTime(t.to.getHours(),t.to.getMinutes())}))}}if(!j&&k==1&&this.util.getDayCode(t.to)==l.part.to.dayCode){j=v.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(t.to.getHours(),t.to.getMinutes())}))}}else{o=v.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(t.from.getHours(),t.from.getMinutes())}))}}h=v.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:l.entry.name}));if(t.isFullDay()){m.style.backgroundColor=this.calendar.util.hexToRgba(t.color,0.3);m.style.borderColor=this.calendar.util.hexToRgba(t.color,0.3)}else{if(t.isLongWithTime()){m.style.borderColor=this.calendar.util.hexToRgba(t.color,0.5)}r.style.backgroundColor=t.color}this.topEntryHolder.appendChild(u);p={wrapNode:u,nameNode:h,innerNode:v,innerContainer:m,timeNode:o||false,endTimeNode:j||false,dotNode:r};if(!l.popupMode){l.entry.registerPartNode(l.part,p)}this.calendar.dragDrop.registerEntry(u,l);return p};e.prototype.displayTopEntries=function(){var h;for(h=0;h<this.partsStorage.length;h++){this.displayTopEntry(this.partsStorage[h])}};e.prototype.displayTimelineEntries=function(){this.zIndexTimeline=100;this.timelinePartsStorage.sort(function(j,i){if(j.part.fromTimeValue==i.part.fromTimeValue){return(i.part.toTimeValue-i.part.fromTimeValue)-(j.part.toTimeValue-j.part.fromTimeValue)}return j.part.fromTimeValue-i.part.fromTimeValue});var h;for(h=0;h<this.timelinePartsStorage.length;h++){this.displayTimelineEntry(this.timelinePartsStorage[h])}};e.prototype.displayTimelineEntry=function(m){var r=false,t,k,w,h,p,j,o,s,q,l=this.util.getWorkTime(),v=m.entry,u=m.part.from,i=m.part.fromTimeValue,n=m.part.toTimeValue,x="calendar-event-block-wrap";if(v.isExternal()){x+=" calendar-event-block-intranet"}if(!this.collapseOffHours||(n>l.start&&i<l.end)){if(this.collapseOffHours){i=Math.max(m.part.fromTimeValue,l.start);n=Math.min(m.part.toTimeValue,l.end);t=((i-l.start)*this.gridLineHeight+1)+"px"}else{t=(i*this.gridLineHeight+1)+"px"}k=BX.create("DIV",{attrs:{"data-bx-calendar-entry":v.uid},props:{className:x},style:{top:t,height:((n-i)*this.gridLineHeight-3)+"px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+u.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}});q=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-border"}}));w=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"}}));s=w.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-background"}}));j=this.calendar.util.formatTime(v.from)+" &ndash; "+this.calendar.util.formatTime(v.to);p=w.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-time"},html:j+'<span class="calendar-event-block-time-shadow">'+j+"</span>"}));h=w.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-text"},text:m.entry.name}));q.style.backgroundColor=v.color;s.style.backgroundColor=v.color;if(this.calendar.entryController.canDo(v,"edit")){o=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-resizer"}}))}this.timelineEntryHolder.appendChild(k);r={wrapNode:k,nameNode:h,innerNode:w,timeNode:p,blockBackgroundNode:s,resizerNode:o};m.part.offsetFractionRate=1;m.part.offsetFractionLeft=0;m.part.offsetFractionWidth=1;m.part.offsetFractionLeftTotal=0;m.entry.registerPartNode(m.part,r);this.calendar.dragDrop.registerEntry(k,m)}return r};e.prototype.checkTimelineEntrySize=function(i,h,j){if(i.params.innerNode.offsetHeight){this.setEntryBlockCompact(i,h)}if(j===true){setTimeout(BX.proxy(function(){this.checkTimelineEntrySize(i,h,false)},this),100)}};e.prototype.setEntryBlockCompact=function(n,q){var s,p,i,o=16,k=23,m=60,h=n.params.nameNode,r=n.params.innerNode,j=r.offsetWidth,l=parseInt(h.style.maxHeight);if(l){s=Math.floor((Math.min(r.offsetHeight-k,l))/o)}else{s=Math.floor((r.offsetHeight-k)/o)}if(l||h.offsetHeight+k>r.offsetHeight||j<m){if(s<1||j<m){p=(q.entry&&q.entry.from)?q.entry.from:q.from;if(p){i=this.calendar.util.formatTime(p.getHours(),p.getMinutes());n.params.timeNode.innerHTML=i+'<span class="calendar-event-block-time-shadow">'+i+"</span>"}BX.addClass(n.params.wrapNode,"calendar-event-block-compact");if(j<m){BX.addClass(n.params.wrapNode,"narrow-block")}}else{if(s==1){h.style.whiteSpace="nowrap";h.style.display="block"}else{if(BX.browser.IsChrome()){h.style.WebkitLineClamp=s;h.style.display="-webkit-box"}else{h.style.height=s*o+"px"}}}}};e.prototype.showNowTime=function(h){this.nowTimeCont=h.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeClass}}));this.nowTimeLine=this.nowTimeCont.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeLineClass}}));this.nowTimeLine.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeDotClass}}));this.nowTimeLabel=this.nowTimeCont.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeLabelClass}}));if(this.nowTimeInterval){clearInterval(this.nowTimeInterval)}this.updateNowTime();this.nowTimeInterval=setInterval(BX.proxy(this.updateNowTime,this),15000)};e.prototype.hideNowTime=function(){BX.cleanNode(this.nowTimeCont,1);delete this.nowTimeCont;if(this.nowTimeInterval){clearInterval(this.nowTimeInterval)}};e.prototype.updateNowTime=function(){if(!this.nowTimeCont){return}var k=10,m=15,j=this.util.getWorkTime(),i=new Date(),p=this.getViewRange(),h=this.util.getTimeValue(i),o=true,q=Math.round(h);var l=document.querySelector("."+this.gridTimeTranslucentClass);if(l){BX.removeClass(l,this.gridTimeTranslucentClass)}if(i.getTime()>p.start.getTime()&&i.getTime()<p.end.getTime()){if(!this.nowTimeCont){this.showNowTime()}if(this.dayCount>1){var r=this.util.getWeekDayOffset(this.util.getWeekDayByInd(i.getDay()));if(r==0){this.nowTimeLine.style.left=0}else{this.nowTimeLine.style.left="calc("+r+" * 100% / "+this.dayCount+")"}}}else{return this.hideNowTime()}var n=this.calendar.util.formatTime(i.getHours(),i.getMinutes());if(BX.isAmPmMode()){n=n.replace(/(\sam|pm)/ig,"<small>$1<small>")}this.nowTimeLabel.innerHTML=n;if(this.collapseOffHours){if(h<j.start){o=false;this.nowTimeLabel.style.display="none";this.nowTimeCont.style.top="-5px"}else{if(h>j.end){o=false;this.nowTimeLabel.style.display="none";this.nowTimeCont.style.top=((j.end-j.start)*this.gridLineHeight)+4+"px"}else{if(h<j.start+k/this.gridLineHeight||h>j.end-k/this.gridLineHeight){this.nowTimeLabel.style.display="none"}else{this.nowTimeLabel.style.display=""}this.nowTimeCont.style.top=((h-j.start)*this.gridLineHeight+1)+"px"}}}else{if((h<j.start+m/this.gridLineHeight&&h>j.start)||(h>j.end-m/this.gridLineHeight&&h<j.end)){o=false;this.nowTimeLabel.style.display="none"}this.nowTimeCont.style.top=(h*this.gridLineHeight+1)+"px"}if(o&&Math.abs((q-h)*this.gridLineHeight)<k){if(this.timeLinesIndex[q]){BX.addClass(this.timeLinesIndex[q],this.gridTimeTranslucentClass)}}};e.prototype.getTimeByPos=function(k,i){var h=this.util.getWorkTime(),j=k/this.gridLineHeight,l=this.util.getTimeByFraction(j,i||10);if(this.collapseOffHours){l.h+=h.start}return l};e.prototype.showOffHours=function(){var h=this.util.getWorkTime();this.topOffHours=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.offHoursClass+" "+this.offHoursAnimateClass},style:{top:0,height:(h.start*this.gridLineHeight+1)+"px"}}));this.topOffHoursLabel=this.topOffHours.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourLabelClass},children:[BX.create("DIV",{props:{className:this.gridTimelineHourLabelClassInner},html:this.calendar.util.formatTime(0,0,true)+"<br>"+this.calendar.util.formatTime(h.start,0,true)})]}));this.topOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-active"},events:{click:BX.proxy(this.switchOffHours,this),mouseover:BX.proxy(function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this),mouseout:BX.proxy(function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this)}}));this.topOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-drag-down"},attrs:{"data-bx-calendar-off-time-drag":"top"},events:{mousedown:BX.proxy(this.offHoursMousedown,this)}}));this.bottomOffHours=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.offHoursClass+" "+this.offHoursAnimateClass},style:{top:(h.end*this.gridLineHeight+1)+"px",height:((24-h.end)*this.gridLineHeight+1)+"px"}}));this.bottomOffHoursLabel=this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourLabelClass},children:[BX.create("DIV",{props:{className:this.gridTimelineHourLabelClassInner},html:this.calendar.util.formatTime(h.end,0,true)+"<br>"+this.calendar.util.formatTime(24,0,true)})]}));this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-active"},events:{click:BX.proxy(this.switchOffHours,this),mouseover:BX.proxy(function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this),mouseout:BX.proxy(function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this)}}));this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-drag-up"},attrs:{"data-bx-calendar-off-time-drag":"bottom"},events:{mousedown:BX.proxy(this.offHoursMousedown,this)}}));BX.bind(this.topOffHours,"click",BX.proxy(function(){if(this.collapseOffHours){this.switchOffHours(true)}},this));BX.bind(this.bottomOffHours,"click",BX.proxy(function(){if(this.collapseOffHours){this.switchOffHours(true)}},this));if(this.collapseOffHours){this.gridRow.style.height=(this.gridLineHeight*(h.end-h.start))+30+"px";this.collapseOffHours=!this.collapseOffHours;this.switchOffHours(false);this.updateGridRowShadowHeight()}else{this.gridRow.style.height=(this.gridLineHeight*24)+40+"px";this.updateGridRowShadowHeight()}};e.prototype.offHoursMousedown=function(i){var h=i.target||i.srcElement;this.lastWorkTime=false;this.lastTopCount=false;if(h&&h.getAttribute){this.lastWorkTime=BX.clone(this.util.getWorkTime());BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.bind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.bind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.removeClass(this.topOffHours,this.offHoursAnimateClass);BX.removeClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursFastAnimateClass);BX.addClass(this.bottomOffHours,this.offHoursFastAnimateClass);if(h.getAttribute("data-bx-calendar-off-time-drag")=="top"){this.offtimeTuneMode="top"}else{this.offtimeTuneMode="bottom"}this.offtimeTuneBaseZeroPos=BX.pos(this.timeLinesCont).top}};e.prototype.offHoursMousemove=function(j){if(this.offtimeTuneMode){var h=this.util.getMousePos(j),i=Math.max(Math.round((h.y-this.offtimeTuneBaseZeroPos)/this.gridLineHeight),0);if(this.lastTopCount!==i){if(this.offtimeTuneMode=="top"){i=Math.min(this.lastWorkTime.end-1,i);this.topOffHours.style.height=(i*this.gridLineHeight+1)+"px";this.lastWorkTime.start=i}else{i=Math.max(this.lastWorkTime.start+1,i);this.bottomOffHours.style.top=i*this.gridLineHeight+"px";this.bottomOffHours.style.height=((24-i)*this.gridLineHeight+1)+"px";this.lastWorkTime.end=i}this.lastTopCount=i}}};e.prototype.offHoursMouseup=function(){BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.removeClass(this.topOffHours,this.offHoursFastAnimateClass);BX.removeClass(this.bottomOffHours,this.offHoursFastAnimateClass);var h=this.util.setWorkTime(this.lastWorkTime);this.topOffHoursLabel.innerHTML=this.calendar.util.formatTime(0,0,true)+"<br>"+this.calendar.util.formatTime(h.start,0,true);this.bottomOffHoursLabel.innerHTML=this.calendar.util.formatTime(h.end,0,true)+"<br>"+this.calendar.util.formatTime(24,0,true);this.offtimeTuneMode=false;delete this.lastWorkTime;delete this.lastTopCount;this.collapseOffHours=false;this.switchOffHours(true)};e.prototype.switchOffHours=function(h){if(this.denySwitch){return}h=h!==false;if(this.nowTimeCont){this.nowTimeCont.display="none"}BX.cleanNode(this.timelineEntryHolder);this.hideNowTime();if(h){BX.removeClass(this.grid,"calendar-events-holder-show");BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.timeLinesCont,this.offHoursAnimateClass)}else{BX.removeClass(this.bottomOffHours,this.offHoursAnimateClass);BX.removeClass(this.topOffHours,this.offHoursAnimateClass);BX.removeClass(this.timeLinesCont,this.offHoursAnimateClass)}this.denySwitch=true;var m=this,j=300,l,r,k=this.util.getWorkTime();setTimeout(BX.delegate(function(){this.denySwitch=false;if(this.collapseOffHours){}else{for(l in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(l)){this.timeLinesIndex[l].style.opacity="";this.timeLinesIndex[l].style.display=""}}}BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.timeLinesCont,this.offHoursAnimateClass);if(this.scrollTopInterval){clearTimeout(this.scrollTopInterval)}if(this.timeLinesCont&&!this.nowTimeCont){this.showNowTime(this.timeLinesCont)}if(h){BX.addClass(this.grid,"calendar-events-holder-show");this.displayEntries()}},this),h?500:10);function q(i){if(h){setTimeout(function(){i.style.opacity=1},j)}else{i.style.opacity=1}}function o(i){if(h){setTimeout(function(){i.style.display="none"},j)}else{i.style.display="none"}}function p(){m.gridWrap.scrollTop=m.savedScrollTop||(k.start*m.gridLineHeight-5);m.scrollTopInterval=setTimeout(p,5)}var n=true;if(!this.collapseOffHours&&(k.end-k.start)*this.gridLineHeight+20<=this.util.getViewHeight()){n=false}this.checkTimelineScroll(n);if(this.collapseOffHours){this.gridRow.style.height=(this.gridLineHeight*24)+40+"px";this.topOffHours.style.height=(this.gridLineHeight*k.start)+1+"px";this.bottomOffHours.style.height=(this.gridLineHeight*(24-k.end))+1+"px";this.bottomOffHours.style.top=(this.gridLineHeight*k.end)+"px";for(l in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(l)){if(l>=k.start&&l<=k.end){o(this.timeLinesIndex[l])}else{this.timeLinesIndex[l].style.display="block";q(this.timeLinesIndex[l])}this.timeLinesIndex[l].style.top=(l*this.gridLineHeight)+"px"}}if(h&&this.savedScrollTop){this.scrollTopInterval=setTimeout(p,5)}}else{this.gridRow.style.height=(this.gridLineHeight*(k.end-k.start))+30+"px";this.topOffHours.style.height="10px";this.bottomOffHours.style.height=(this.gridLineHeight*(24-k.end))+1+"px";this.bottomOffHours.style.top=(this.gridLineHeight*k.end)+"px";for(l in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(l)){if((l<=k.start||l>=k.end)){r=this.timeLinesIndex[l];this.timeLinesIndex[l].style.opacity=0;o(this.timeLinesIndex[l])}else{q(this.timeLinesIndex[l])}if(l>=k.end){this.timeLinesIndex[l].style.top=((k.end-k.start)*this.gridLineHeight)+"px"}else{this.timeLinesIndex[l].style.top=((l-k.start)*this.gridLineHeight)+"px"}}}this.bottomOffHours.style.height="10px";this.bottomOffHours.style.top=((k.end-k.start)*this.gridLineHeight)+9+"px";this.savedScrollTop=parseInt(this.gridWrap.scrollTop)}this.collapseOffHours=!this.collapseOffHours;BX.toggleClass(this.topOffHours,[this.offHoursCollapseClass,this.offHoursClass]);BX.toggleClass(this.bottomOffHours,[this.offHoursCollapseClass,this.offHoursClass]);this.util.setUserOption("collapseOffHours",this.collapseOffHours?"Y":"N");this.updateGridRowShadowHeight()};e.prototype.checkTimelineScroll=function(i){var h=i?this.util.getScrollbarWidth():0;if(this.titleCont){this.titleCont.style.paddingRight=h+"px"}if(this.fullDayEventsHolderCont&&this.topEntryHolder){new BX.easing({duration:100,start:{width:h,paddingRight:0},finish:{width:0,paddingRight:h},transition:BX.easing.makeEaseOut(BX.easing.transitions.linear),step:BX.delegate(function(j){this.gridWrap.style.width="calc(100% + "+j.width+"px)";this.topEntryHolder.style.right=j.paddingRight+"px";this.fullDayEventsHolderCont.style.paddingRight=j.paddingRight+"px"},this),complete:function(){}}).animate()}};e.prototype.getDayGridHeight=function(){return 1040};e.prototype.updateGridRowShadowHeight=function(){if(this.collapseOffHours){this.gridRowShadow.style.height=(parseInt(this.gridRow.style.height)-38)+"px";BX.removeClass(this.gridRowShadow,"calendar-grid-week-row-shadow-off-hours")}else{this.gridRowShadow.style.height=(parseInt(this.gridRow.style.height)-40)+"px";BX.addClass(this.gridRowShadow,"calendar-grid-week-row-shadow-off-hours")}};e.prototype.handleClick=function(j){if(this.isActive()){if(!j){j={}}var h,i;if(j.specialTarget&&(i=j.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:i,specialTarget:j.specialTarget,target:j.target,e:j.e})}else{if(j.specialTarget&&(h=j.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){}else{if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(h=j.specialTarget&&j.specialTarget.getAttribute("data-bx-calendar-week-day"))){this.showSimplePopupForNewEntry({entry:this.buildTopNewEntryWrap({dayFrom:this.days[this.dayIndex[h]],holder:this.topEntryHolder})})}}}}};e.prototype.handleMousedown=function(l){if(!this.isActive()){return}var j,k=this.calendar.util.findTargetNode(l.target||l.srcElement);if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(j=k&&k.getAttribute("data-bx-calendar-timeline-day"))){BX.unbind(document,"mousemove",BX.proxy(this.handleMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.handleMouseup,this));BX.bind(document,"mousemove",BX.proxy(this.handleMousemove,this));BX.bind(document,"mouseup",BX.proxy(this.handleMouseup,this));BX.addCustomEvent(this.calendar,"keyup",BX.proxy(this.checkKeyup,this));this.createEntryMode=true;this.offtimeTuneBaseZeroPos=BX.pos(this.timeLinesCont).top;this.offtimeBottomBasePos=BX.pos(this.bottomOffHours).bottom-2;this.startMousePos=Math.max(this.offtimeTuneBaseZeroPos+this.gridWrap.scrollTop,this.calendar.util.getMousePos(l).y);this.newEntry=this.buildTimelineNewEntryWrap({dayFrom:this.days[this.dayIndex[j]],holder:this.timelineEntryHolder});this.newEntry.dayFrom=this.days[this.dayIndex[j]];this.newEntry.timeFrom=this.getTimeByPos(this.startMousePos-this.offtimeTuneBaseZeroPos,30,true);var i=this.util.getWorkTime(),h=this.newEntry.timeFrom.h+this.newEntry.timeFrom.m/60;if(this.collapseOffHours){h=Math.max(h,i.start);this.startMousePos=this.offtimeTuneBaseZeroPos+((h-i.start)*this.gridLineHeight+1)}else{this.startMousePos=this.offtimeTuneBaseZeroPos+(h*this.gridLineHeight+1)}if(this.newEntry.timeFrom.h==23){this.newEntry.timeTo={h:23,m:59}}else{this.newEntry.timeTo={h:this.newEntry.timeFrom.h+1,m:this.newEntry.timeFrom.m}}this.newEntry.changeTimeCallback(this.newEntry.timeFrom,this.newEntry.timeTo);this.newEntry.entryNode.style.top=this.startMousePos+"px"}};e.prototype.handleMousemove=function(j){if(this.createEntryMode){var i=this.calendar.util.getMousePos(j).y,h=Math.min(Math.max(i-this.startMousePos,10),this.offtimeBottomBasePos-parseInt(this.newEntry.entryNode.style.top));this.newEntry.entryNode.style.height=h+"px";this.newEntry.timeTo=this.getTimeByPos(h+this.startMousePos-this.offtimeTuneBaseZeroPos);this.newEntry.changeTimeCallback(this.newEntry.timeFrom,this.newEntry.timeTo)}};e.prototype.handleMouseup=function(j){BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.removeCustomEvent(this.calendar,"keyup",BX.proxy(this.checkKeyup,this));if(this.createEntryMode){var i=new Date(this.newEntry.dayFrom.date.getTime()),h=new Date(this.newEntry.dayFrom.date.getTime());i.setHours(this.newEntry.timeFrom.h,this.newEntry.timeFrom.m,0,0);h.setHours(this.newEntry.timeTo.h,this.newEntry.timeTo.m,0,0);this.showSimplePopupForNewEntry({entry:this.newEntry,entryTime:{from:i,to:h}});this.createEntryMode=false}};e.prototype.checkKeyup=function(i){var h=this.util.getKeyCodes();if(i.keyCode==h.escape&&this.createEntryMode&&this.newEntry){BX.remove(this.newEntry.entryNode);this.createEntryMode=false;this.handleMouseup()}};e.prototype.buildTopNewEntryWrap=function(y){var r=this,u,o,m,p,x,i="calendar-event-line-wrap",j=0,q=y.dayFrom,s,w,n=1,l=this.calendar.sectionController.getCurrentSection(),t=l.color;u=this.entryController.getTimeForNewEntry(q.date);o=this.entryController.getDefaultEntryName();m=y.holder.appendChild(BX.create("DIV",{props:{className:i},style:{top:0,left:this.dayCount>1?"calc((100% / "+this.dayCount+") * ("+(q.dayOffset+1)+" - 1) + 2px)":"2px",width:"calc("+n+" * 100% / "+this.dayCount+" - "+j+"px)"}}));x=m.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));p=x.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));p.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(u.from.getHours(),u.from.getMinutes())}));p.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:o}));m.style.backgroundColor=t;m.style.borderColor=t;m.style.opacity=0;var k=BX.pos(m);var v=BX.adjust(document.body.appendChild(m.cloneNode(true)),{props:{className:"calendar-event-line-clone"},style:{width:(k.width+1)+"px",height:k.height+"px",top:k.top+"px",left:k.left+"px",opacity:1}});if(m){BX.remove(m,true)}w=v.querySelector(".calendar-event-line-text");s=v.querySelector(".calendar-event-line-time");p=v.querySelector(".calendar-event-line-inner");var h={entryNode:v,innerNode:p,section:l,entryName:o,entryTime:u,changeTimeCallback:function(A,z){if(A.getHours&&z.getHours){s.innerHTML=r.calendar.util.formatTime(A.getHours(),A.getMinutes())}else{s.innerHTML=r.calendar.util.formatTime(A.h,A.m)}},changeNameCallback:function(z){w.innerHTML=BX.util.htmlspecialchars(z)}};this.selectEntryPart(h,t,false);return h};e.prototype.buildTimelineNewEntryWrap=function(z){var s=this,v,o,m,p,i="calendar-event-block-wrap",r=z.dayFrom,q,n,j,t,y,w,l=this.calendar.sectionController.getCurrentSection(),u=l.color;v=this.entryController.getTimeForNewEntry(r.date);o=this.entryController.getDefaultEntryName();m=z.holder.appendChild(BX.create("DIV",{props:{className:i},style:{top:top,height:this.gridLineHeight+"px",minHeight:"20px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+r.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}}));q=m.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-border"}}));p=m.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"}}));n=p.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-background"}}));j=this.calendar.util.formatTime(v.from.getHours(),v.from.getMinutes())+" &ndash; "+this.calendar.util.formatTime(v.to.getHours(),v.to.getMinutes());p.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-time"},style:{color:"#fff"},html:j+'<span class="calendar-event-block-time-shadow">'+j+"</span>"}));p.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-text"},style:{color:"#fff"},text:o}));q.style.backgroundColor=u;n.style.backgroundColor=u;var k=BX.pos(m);var x=BX.adjust(document.body.appendChild(m.cloneNode(true)),{props:{className:"calendar-event-line-clone calendar-event-block-wrap active"},style:{width:(k.width+1)+"px",height:k.height+"px",top:k.top+"px",left:k.left+"px",opacity:1}});if(m){BX.remove(m,true)}y=x.querySelector(".calendar-event-block-text");t=x.querySelector(".calendar-event-block-time");p=x.querySelector(".calendar-event-block-inner");q=x.querySelector(".calendar-event-block-border");n=x.querySelector(".calendar-event-block-background");w=x.appendChild(BX.create("DIV",{props:{className:"calendar-event-bind-node"}}));if(this.dayCount==1){w.style.right="10%"}else{w.style.left="0"}var h={entryNode:x,innerNode:p,section:l,entryName:o,bindNode:w,borderNode:q,blockBackgroundNode:n,changeTimeCallback:function(C,B){var A;if(C.getHours&&B.getHours){A=s.calendar.util.formatTime(C.getHours(),C.getMinutes())+" &ndash; "+s.calendar.util.formatTime(B.getHours(),B.getMinutes())}else{A=s.calendar.util.formatTime(C.h,C.m)+" &ndash; "+s.calendar.util.formatTime(B.h,B.m)}t.innerHTML=A+'<span class="calendar-event-block-time-shadow">'+A+"</span>"},changeNameCallback:function(A){y.innerHTML=BX.util.htmlspecialchars(A)}};this.selectEntryPart(h,u,false);return h};e.prototype.showSimplePopupForNewEntry=function(h){this.showSimplePopup({entryNode:h.entry.entryNode,bindNode:h.entry.bindNode,section:h.entry.section,entryTime:h.entryTime||h.entry.entryTime,entryName:h.entry.entryName,changeTimeCallback:h.entry.changeTimeCallback,changeNameCallback:h.entry.changeNameCallback,closeCallback:BX.delegate(function(){BX.remove(h.entry.entryNode)},this),changeDateCallback:BX.delegate(function(i){},this),changeSectionCallback:function(j){var i=j.color;if(h.entry.borderNode){h.entry.borderNode.style.backgroundColor=i}if(h.entry.blockBackgroundNode){h.entry.blockBackgroundNode.style.backgroundColor=i}},saveCallback:function(){},cancelCallback:function(){},fullFormCallback:BX.delegate(this.showEditSlider,this)})};function a(){f.apply(this,arguments);this.initConfig();this.preBuild()}a.prototype=Object.create(e.prototype);a.prototype.constructor=a;a.prototype.show=function(){f.prototype.show.apply(this,arguments);this.buildDaysGrid();if(this.calendar.navCalendar){this.calendar.navCalendar.hide()}this.displayEntries();this.calendar.initialViewShow=false};a.prototype.initConfig=function(){e.prototype.initConfig.apply(this,arguments);this.name="week";this.title=BX.message("EC_VIEW_WEEK");this.contClassName="calendar-week-view";this.gridWrapClass="calendar-grid-wrap";this.fullDayContClass="calendar-grid-week-full-days-events-holder";this.outerGridClass="calendar-grid-week-container";this.gridClass="calendar-grid-week";this.gridClassCurrent="calendar-grid-week-current";this.gridClassNext="calendar-grid-week-left-slide";this.gridClassPrevious="calendar-grid-week-right-slide";this.changeNextClass="calendar-change-week-left-slide";this.changePreviousClass="calendar-change-week-right-slide";this.gridRowClass="calendar-grid-week-row";this.gridCellClass="calendar-grid-week-cell";this.gridTimelinesClass="calendar-grid-week-time-lines";this.gridTimelineHourClass="calendar-grid-week-time-line-hour";this.gridTimelineHourLabelClass="calendar-grid-week-time-line-hour-label";this.topEntryHolderClass="calendar-grid-week-events-holder";this.gridNowTimeClass="calendar-grid-week-time-line-hour-now";this.gridNowTimeLabelClass="calendar-grid-week-time-line-hour-label";this.gridNowTimeLineClass="calendar-grid-week-time-line-hour-now-line";this.gridNowTimeDotClass="calendar-grid-week-time-line-hour-now-dot";this.dayCount=7};a.prototype.setTitle=function(){var h=this.calendar.getViewRangeDate(),j=h.getTime()/1000,i=new Date(h.getTime()+this.dayCount*this.calendar.util.dayLength);if(h.getMonth()!=i.getMonth()){f.prototype.setTitle.apply(this,[BX.date.format("f",j)+" - "+BX.date.format("f",i.getTime()/1000)+(this.util.showWeekNumber()?", #GRAY_START#"+BX.message("EC_DATE_WEEK_NUMBER").replace("#WEEK_NUMBER#",BX.date.format("W",j))+"#GRAY_END#":"")])}else{f.prototype.setTitle.apply(this,[BX.date.format("f",j)+(this.util.showWeekNumber()?", #GRAY_START#"+BX.message("EC_DATE_WEEK_NUMBER").replace("#WEEK_NUMBER#",BX.date.format("W",j))+"#GRAY_END#":"")])}};a.prototype.getAdjustedDate=function(j,i,h){if(!j){j=new Date()}if(i&&j.getTime()<i.start.getTime()){j=new Date(i.start.getTime())}if(i&&j.getTime()>i.end.getTime()){j=new Date(i.end.getTime())}var k=this.util.getWeekStart();while(this.util.getWeekDayByInd(j.getDay())!=k){j.setDate(j.getDate()-1)}if(h){i.start.setDate(j.getTime());i.end.setDate(j.getTime()+this.calendar.util.dayLength*this.dayCount)}return e.prototype.getAdjustedDate.apply(this,[j,i])};a.prototype.adjustViewRangeToDate=function(h){var i=this.util.getWeekStart();while(this.util.getWeekDayByInd(h.getDay())!=i){h.setDate(h.getDate()-1)}return e.prototype.adjustViewRangeToDate.apply(this,[h])};function g(){f.apply(this,arguments);this.name="month";this.title=BX.message("EC_VIEW_MONTH");this.contClassName="calendar-month-view";this.dayCount=7;this.slotHeight=20;this.eventHolderTopOffset=25;this.preBuild()}g.prototype=Object.create(f.prototype);g.prototype.constructor=g;g.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}})};g.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row-days-week"}}));this.gridWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-wrap"}}));this.gridMonthContainer=this.gridWrap.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-container"}}));this.grid=this.gridMonthContainer.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-current"}}))};g.prototype.show=function(){f.prototype.show.apply(this,arguments);this.buildDaysTitle();this.buildDaysGrid();if(this.calendar.navCalendar){this.calendar.navCalendar.hide()}this.displayEntries();this.calendar.initialViewShow=false};g.prototype.hide=function(){f.prototype.hide.apply(this,arguments)};g.prototype.increaseViewRangeDate=function(){this.changeViewRangeDate(1);var h=this.gridMonthContainer.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-next "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.setTitle();this.buildDaysGrid({grid:h});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.gridMonthContainer,"calendar-change-month-next");setTimeout(BX.delegate(function(){BX.removeClass(this.gridMonthContainer,"calendar-change-month-next");BX.removeClass(h,"calendar-grid-month-next");BX.addClass(h,"calendar-grid-month-current");BX.remove(this.grid);this.grid=h;BX.removeClass(this.grid,this.animateClass);this.displayEntries()},this),400)},this),0)};g.prototype.decreaseViewRangeDate=function(){this.changeViewRangeDate(-1);var h=this.gridMonthContainer.insertBefore(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-previous "+this.animateClass}}),this.grid);BX.addClass(this.grid,this.animateClass);this.setTitle();this.buildDaysGrid({grid:h});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.gridMonthContainer,"calendar-change-month-previous");setTimeout(BX.delegate(function(){BX.removeClass(this.gridMonthContainer,"calendar-change-month-previous");BX.removeClass(h,"calendar-grid-month-previous");BX.addClass(h,"calendar-grid-month-current");BX.remove(this.grid);this.grid=h;BX.removeClass(this.grid,this.animateClass);this.displayEntries()},this),400)},this),0)};g.prototype.getViewRange=function(){var h=this.calendar.getViewRangeDate(),i=new Date(h.getTime());i.setMonth(h.getMonth()+1);return{start:h,end:i}};g.prototype.changeViewRangeDate=function(j){var i=this.calendar.getViewRangeDate(),h=new Date(i.getTime());h.setMonth(h.getMonth()+j);this.calendar.setViewRangeDate(h);return h};g.prototype.adjustViewRangeToDate=function(h){var i=this.calendar.getViewRangeDate(),j=false;var k=h.getMonth()-i.getMonth();if(k==1){this.increaseViewRangeDate()}else{if(k==-1){this.decreaseViewRangeDate()}else{if(h&&h.getTime){j=new Date(h.getTime());j.setDate(1);j.setHours(0,0,0,0);this.calendar.setViewRangeDate(j)}this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}}return j};g.prototype.getAdjustedDate=function(i,h){if(!i){i=new Date()}if(i.getTime()<h.start.getTime()){i=new Date(h.start.getTime())}if(i.getTime()>h.end.getTime()){i=new Date(h.end.getTime())}var j=this.calendar.getViewRangeDate(),k=false;if(i&&i.getTime){k=new Date(i.getTime());k.setDate(1);k.setHours(0,0,0,0)}return k};g.prototype.buildDaysTitle=function(){BX.cleanNode(this.titleCont);var j,h,k=this.util.getWeekDays();for(j=0;j<k.length;j++){h=k[j];this.titleCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-cell"},html:'<span class="calendar-grid-cell-inner">'+BX.message("EC_MONTH_WEEK_TITLE").replace("#DAY_OF_WEEK#",h[1])+"</span>"}))}};g.prototype.buildDaysGrid=function(k){if(!k){k={}}var l,r,h=k.grid||this.grid,p=this.calendar.getViewRangeDate(),o=p.getFullYear(),n=p.getMonth(),q=this.util.getViewHeight(),m=BX.clone(this.getViewRange(),true),j=new Date();BX.cleanNode(h);j.setFullYear(o,n,1);this.dayIndex={};this.days=[];this.entryHolders=[];this.currentMonthRow=false;this.monthRows=[];if(this.util.getWeekStart()!=this.util.getWeekDayByInd(j.getDay())){r=this.util.getWeekDayOffset(this.util.getWeekDayByInd(j.getDay()));j.setDate(j.getDate()-r);m.start=new Date(j.getTime());m.start.setHours(0,0,0,0);for(l=0;l<r;l++){this.buildDayCell({date:j,month:"previous",grid:h});j.setDate(j.getDate()+1)}}j.setFullYear(o,n,1);while(j.getMonth()==n){this.buildDayCell({date:j,grid:h});j.setDate(j.getDate()+1)}if(this.util.getWeekStart()!=this.util.getWeekDayByInd(j.getDay())){r=this.util.getWeekDayOffset(this.util.getWeekDayByInd(j.getDay()));j.setFullYear(o,n+1,1);for(l=r;l<7;l++){this.buildDayCell({date:j,month:"next",grid:h});j.setDate(j.getDate()+1)}m.end=new Date(j.getTime());m.end.setHours(23,59,59,59)}this.calendar.setDisplayedViewRange(m);if(this.monthRows.length>0){this.rowHeight=Math.round(q/this.monthRows.length);this.slotsCount=Math.floor((this.rowHeight-this.eventHolderTopOffset)/this.slotHeight);for(l=0;l<this.monthRows.length;l++){this.monthRows[l].style.height=this.rowHeight+"px"}}};g.prototype.buildDayCell=function(l){var k=l.date,n="",j=Math.round(k.getTime()/1000)*1000,o=k.getDay(),p=this.util.getDayCode(k),m=this.util.getWeekDayByInd(o),h=false,i=this.util.getWeekStart()==m;if(i){this.currentMonthRow=l.grid.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row"}}));this.monthRows.push(this.currentMonthRow);if(this.util.showWeekNumber()){h=BX.date.format("W",j/1000)}}if(l.month=="previous"){n+=" calendar-grid-previous-month-day"}else{if(l.month=="next"){n+=" calendar-grid-next-month-day"}}if(this.util.isHoliday(k)){n+=" calendar-grid-holiday"}if(this.util.isToday(k)){n+=" calendar-grid-today"}this.days.push({date:new Date(k.getTime()),dayOffset:this.util.getWeekDayOffset(m),rowIndex:this.monthRows.length-1,holderIndex:this.entryHolders.length,node:this.currentMonthRow.appendChild(BX.create("DIV",{props:{className:BX.util.trim("calendar-grid-month-cell"+n)},attrs:{"data-bx-calendar-month-day":p},html:'<span class="calendar-grid-cell-inner"><span class="calendar-num-day" data-bx-calendar-date="'+j+'">'+(k.getDate()==1?BX.message("EC_MONTH_SHORT").replace("#MONTH#",BX.date.format("M",j/1000)).replace("#DATE#",k.getDate()):k.getDate())+"</span>"+(h?'<span class="calendar-num-week"  data-bx-cal-time="'+j+'" data-bx-calendar-weeknumber="'+h+'">'+h+"</span>":"")+"</span>"})),dayCode:p});this.dayIndex[this.days[this.days.length-1].dayCode]=this.days.length-1;this.calendar.dragDrop.registerDay(this.days[this.days.length-1]);if(this.currentMonthRow&&this.util.getWeekEnd()==m){this.entryHolders.push(this.currentMonthRow.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-events-holder"}})))}};g.prototype.setTitle=function(){var h=this.calendar.getViewRangeDate();f.prototype.setTitle.apply(this,[BX.date.format("f",h.getTime()/1000)+", #GRAY_START#"+h.getFullYear()+"#GRAY_END#"])};g.prototype.displayEntries=function(m){var w,o,n,v,l,q,s,r,h,k=[],p,u,t=this.calendar.getDisplayedViewRange();if(!m){m={}}if(m.reloadEntries!==false){this.entries=this.entryController.getList({startDate:new Date(t.start.getFullYear(),t.start.getMonth(),1),finishDate:new Date(t.end.getFullYear(),t.end.getMonth()+1,1),viewRange:t,finishCallback:BX.proxy(this.displayEntries,this)})}this.entryHolders.forEach(function(i){BX.cleanNode(i)});this.days.forEach(function(i){i.slots=[];i.entries={list:[],started:[],hidden:[]}});if(this.entries===false||!this.entries||!this.entries.length){return}for(o=0;o<this.entries.length;o++){v=this.entries[o];this.entriesIndex[v.uid]=o;v.cleanParts();h=false;for(q=this.dayIndex[v.startDayCode];q<this.days.length;q++){r=this.days[q];if(r.dayCode==v.startDayCode||h&&r.dayOffset==0){h=true;l=v.startPart({from:r,daysCount:0});r.entries.started.push({entry:v,part:l})}if(h){r.entries.list.push({entry:v,part:l});l.daysCount++;l.to=r;if(r.dayCode==v.endDayCode||r.dayOffset==this.dayCount-1){k.push({part:l,entry:v});if(r.dayCode==v.endDayCode){break}}}}}for(o=0;o<k.length;o++){this.displayEntryPiece(k[o])}for(q=0;q<this.days.length;q++){r=this.days[q];if(r.entries.started.length>0){if(r.entries.started.length>0){r.entries.started.sort(this.calendar.entryController.sort)}for(o=0;o<r.entries.started.length;o++){element=r.entries.started[o];if(element){v=element.entry;s=element.part;p=false;for(n=0;n<this.slotsCount;n++){if(r.slots[n]!==false){this.occupySlot({slotIndex:n,startIndex:q,endIndex:q+s.daysCount});p=true;v.getWrap(s.partIndex).style.top=(n*this.slotHeight)+"px";break}}if(!p){w=r.entries.started[o-1];if(w){r.entries.hidden.push(w);w.entry.getWrap(w.part.partIndex).style.display="none"}r.entries.hidden.push(element);v.getWrap(s.partIndex).style.display="none"}}}}if(r.entries.list.length>0){u=false;for(o=0;o<r.entries.list.length;o++){if(r.entries.list[o].part.params.wrapNode.style.display=="none"){u=true;break}}if(u){r.hiddenStorage=this.entryHolders[r.holderIndex].appendChild(BX.create("DIV",{props:{className:"calendar-event-line-wrap calendar-event-more-btn-container"},attrs:{"data-bx-calendar-show-all-events":r.dayCode},style:{top:(this.rowHeight-42)+"px",left:"calc((100% / "+this.dayCount+") * ("+(r.dayOffset+1)+" - 1) + 2px)",width:"calc(100% / "+this.dayCount+" - 3px)"}}));r.hiddenStorageText=r.hiddenStorage.appendChild(BX.create("span",{props:{className:"calendar-event-more-btn"}}));r.hiddenStorage.style.display="block";r.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" "+r.entries.list.length}else{if(r.hiddenStorage){r.hiddenStorage.style.display="none"}}}}BX.addClass(this.gridMonthContainer,"calendar-events-holder-show")};g.prototype.displayEntryPiece=function(l){var p=false,u=l.entry,t=l.part.from,k=l.part.daysCount,v,s,w,h,o,j,m,x="calendar-event-line-wrap",n=0,i,r,q=l.holder||this.entryHolders[t.holderIndex];if(q){if(u.isFullDay()){x+=" calendar-event-line-fill"}else{if(u.isLongWithTime()){x+=" calendar-event-line-border"}}if(u.isExternal()){x+=" calendar-event-line-intranet"}if(!l.popupMode&&this.util.getDayCode(u.from)!==this.util.getDayCode(t.date)){x+=" calendar-event-line-start-yesterday";n+=8;i=this.getArrow("left",u.color,u.isFullDay())}if(!l.popupMode&&this.util.getDayCode(u.to)!==this.util.getDayCode(l.part.to.date)){x+=" calendar-event-line-finish-tomorrow";r=this.getArrow("right",u.color,u.isFullDay());n+=12}if(i&&!r){n+=4}if(n==0){n=5}v=BX.create("DIV",{attrs:{"data-bx-calendar-entry":u.uid},props:{className:x},style:{top:0,left:"calc((100% / "+this.dayCount+") * ("+(t.dayOffset+1)+" - 1) + 2px)",width:"calc("+k+" * 100% / "+this.dayCount+" - "+n+"px)"}});if(i){v.appendChild(i);v.style.left="9px"}if(r){v.appendChild(r)}m=v.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));w=m.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));s=w.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-dot"}}));if(u.isFullDay()){w.style.maxWidth="calc(200% / "+k+" - 3px)"}else{if(u.isLongWithTime()){v.style.borderColor=u.color;w.style.maxWidth="calc(200% / "+k+" - 3px)";if(l.part.partIndex==0){o=w.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(u.from.getHours(),u.from.getMinutes())}));w.style.width="calc(100% / "+k+" - 3px)"}if(l.part.partIndex==u.parts.length-1){if(k>1&&u.parts.length>1){w.style.width="calc("+(k-1)+"00% / "+k+" - 3px)"}if(!l.popupMode){j=w.appendChild(BX.create("SPAN",{props:{className:(u.parts.length>1&&k==1)?"calendar-event-line-time":"calendar-event-line-expired-time"},text:this.calendar.util.formatTime(u.to.getHours(),u.to.getMinutes())}))}}}else{o=w.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(u.from.getHours(),u.from.getMinutes())}))}}h=w.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:l.entry.name}));if(u.isFullDay()){m.style.backgroundColor=this.calendar.util.hexToRgba(u.color,0.3);m.style.borderColor=this.calendar.util.hexToRgba(u.color,0.3)}else{if(u.isLongWithTime()){m.style.borderColor=this.calendar.util.hexToRgba(u.color,0.5)}s.style.backgroundColor=u.color}q.appendChild(v);if(u.opacity!==undefined){v.style.opacity=u.opacity}p={wrapNode:v,nameNode:h,innerContainer:m,innerNode:w,timeNode:o||false,endTimeNode:j||false,dotNode:s};if(!l.popupMode){l.entry.registerPartNode(l.part,p)}this.calendar.dragDrop.registerEntry(v,l)}return p};g.prototype.refreshEventsOnWeek=function(l){var z=l*7,m=(l+1)*7,w,q,o,n,p,v,u,t,s=[],r=5,h=0;for(p=0;p<r;p++){s[p]=0}for(q=z;q<m;q++){w=this.activeDateObjDays[q];if(!w){continue}w.arEvents.hidden=[];n=w.arEvents.begining;t=[];if(n.length>0){n.sort(function(j,i){if(i.daysCount==j.daysCount&&j.daysCount==1){return j.oEvent.DT_FROM_TS-i.oEvent.DT_FROM_TS}return i.daysCount-j.daysCount});eventloop:for(o=0;o<n.length;o++){v=n[o];if(!v){continue}if(!this.arEvents[v.oEvent.ind]){w.arEvents.begining=n=BX.util.deleteFromArray(n,o);v=n[o];if(!v){continue}}for(p=0;p<this.maxEventCount;p++){if(s[p]-h<=0){s[p]=h+v.daysCount;this.ShowEventOnLevel(v.oEvent.oParts[v.partInd],p,l);continue eventloop}}t[v.oEvent.ID]=true;w.arEvents.hidden.push(v)}}u=w.arEvents.all;for(var y=0;y<u.length;y++){v=u[y];if(!v||t[v.oEvent.ID]){continue}if(!this.arEvents[v.oEvent.ind]){w.arEvents.all=u=BX.util.deleteFromArray(u,y);v=u[y];if(!v){continue}}if(v.oEvent.oParts&&v.partInd!=undefined&&v.oEvent.oParts[v.partInd]&&v.oEvent.oParts[v.partInd].style.display=="none"){w.arEvents.hidden.push(v)}}h++}};g.prototype.handleClick=function(j){if(this.isActive()){if(!j){j={}}var h,i;if(j.specialTarget&&(i=j.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:i,specialTarget:j.specialTarget,target:j.target,e:j.e})}else{if(j.specialTarget&&(h=j.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){this.deselectEntry();if(this.dayIndex[h]!==undefined&&this.days[this.dayIndex[h]]){this.showAllEventsInPopup({day:this.days[this.dayIndex[h]]})}}else{if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(false,"add_event")&&(h=j.specialTarget&&j.specialTarget.getAttribute("data-bx-calendar-month-day"))){this.deselectEntry();if(this.dayIndex[h]!==undefined&&this.days[this.dayIndex[h]]){this.showNewEntryWrap({dayFrom:this.days[this.dayIndex[h]]})}}}}}};g.prototype.showNewEntryWrap=function(j){var t,m,s,u,k,v="calendar-event-line-wrap",l=0,r=j.dayFrom,h=1,o=this.entryHolders[r.holderIndex],q=this.calendar.sectionController.getCurrentSection(),i=q.color;t=this.entryController.getTimeForNewEntry(r.date);m=this.entryController.getDefaultEntryName();s=BX.create("DIV",{props:{className:v},style:{opacity:0,top:0,left:"calc((100% / "+this.dayCount+") * ("+(r.dayOffset+1)+" - 1) + 2px)",width:"calc("+h+" * 100% / "+this.dayCount+" - "+l+"px)"}});k=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));u=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));u.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},style:{color:"#fff"},text:this.calendar.util.formatTime(t.from.getHours(),t.from.getMinutes())}));u.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},style:{color:"#fff"},text:m}));s.style.backgroundColor=i;s.style.borderColor=i;o.appendChild(s);var n=BX.pos(s);var p=BX.adjust(document.body.appendChild(s.cloneNode(true)),{props:{className:"calendar-event-line-clone"},style:{width:(n.width-6)+"px",height:n.height+"px",top:n.top+"px",left:(n.left+1)+"px"}});BX.addClass(o,"shifted");o.style.height=(this.slotsCount-1)*this.slotHeight+"px";setTimeout(function(){p.style.opacity="1"},100);setTimeout(BX.delegate(function(){this.showSimplePopup({entryTime:t,entryName:m,nameNode:p.querySelector(".calendar-event-line-text"),timeNode:p.querySelector(".calendar-event-line-time"),entryNode:p,section:q,closeCallback:function(){BX.cleanNode(p,true);BX.cleanNode(s,true);BX.removeClass(o,"shifted");o.style.height="1px"},changeDateCallback:BX.delegate(function(x){var w=this.util.getDayCode(x);if(w&&this.dayIndex[w]!==undefined&&this.days[this.dayIndex[w]]){var y=this.days[this.dayIndex[w]];s.style.left="calc((100% / "+this.dayCount+") * ("+(y.dayOffset+1)+" - 1) + 2px)";this.entryHolders[y.holderIndex].appendChild(s);var z=BX.pos(s);BX.adjust(p,{style:{width:(z.width+1)+"px",height:z.height+"px",top:z.top+"px",left:z.left+"px"}})}},this),saveCallback:function(){},changeSectionCallback:function(x){var w=x.color;if(p){p.style.background=w;p.style.borderColor=w}},fullFormCallback:BX.delegate(this.showEditSlider,this)})},this),200)};function c(h){f.apply(this,arguments);this.name="year";this.title=BX.message("EC_VIEW_YEAR");this.contClassName="calendar-year-view";this.build()}c.prototype=Object.create(f.prototype);c.prototype.constructor=c;function b(){f.apply(this,arguments);this.name="list";this.filterMode=false;this.title=BX.message("EC_VIEW_LIST");this.contClassName="calendar-list-view";this.loadDaysBefore=30;this.animateAmount=5;this.loadLimitPrevious=5;this.loadLimit=15;this.loadDaysAfter=60;this.SCROLL_DELTA_HEIGHT=200;this.todayCode=this.calendar.util.getDayCode(new Date());this.preBuild()}b.prototype=Object.create(f.prototype);b.prototype.constructor=b;b.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}});BX.addCustomEvent(this.calendar,"afterSetView",BX.delegate(function(h){if(h.viewName!==this.name&&this.filterMode){this.resetFilterMode()}},this))};b.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row-days-week"}}));this.streamScrollWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-container calendar-custom-scroll"},style:{height:this.util.getViewHeight()+"px"},events:{scroll:BX.proxy(this.scrollHandle,this)}}));this.streamContentWrap=this.streamScrollWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-container-content"}}));this.topLoaderBlock=this.streamContentWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-loader-block"}}));this.listWrap=this.streamContentWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-container-list"}}));this.bottomLoaderBlock=this.streamContentWrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-loader-block"}}))};b.prototype.setTitle=function(){var h=this.calendar.getViewRangeDate();f.prototype.setTitle.apply(this,[BX.date.format("f",h.getTime()/1000)+", #GRAY_START#"+h.getFullYear()+"#GRAY_END#"])};b.prototype.show=function(h){if(!h){h={}}f.prototype.show.apply(this,arguments);this.showNavigationCalendar();BX.remove(this.calendar.additionalInfoOuter);this.displayedRange=this.calendar.entryController.getLoadedEntiesLimits();this.calendar.setDisplayedViewRange(this.displayedRange);if(h.displayEntries!==false){this.displayEntries()}this.nothingToLoadNext=false;this.nothingToLoadPrevious=false};b.prototype.displayEntries=function(h){if(!h){h={}}if(h.reloadEntries!==false){this.entries=this.entryController.getList({startDate:this.displayedRange.start,finishDate:this.displayedRange.end,viewRange:this.displayedRange,finishCallback:BX.proxy(this.displayEntries,this)})}BX.cleanNode(this.listWrap);this.dateGroupIndex={};this.groups=[];this.groupsDayCodes=[];this.groupsIndex={};this.entryListIndex={};if(this.entries===false||!this.entries||!this.entries.length){this.showEmptyBlock();return}if(this.noEntriesWrap){this.noEntriesWrap.style.display="none"}this.streamContentWrap.style.display="";this.entryParts=[];this.attachEntries(this.entries,false,BX.delegate(this.focusOnDate,this));setTimeout(BX.delegate(this.focusOnDate,this),100)};b.prototype.displayResult=function(h){this.streamContentWrap.style.display="";if(this.filterLoaderWrap){this.filterLoaderWrap.style.display="none"}BX.addClass(this.streamContentWrap,"calendar-timeline-stream-search-result");BX.cleanNode(this.listWrap);this.dateGroupIndex={};this.groups=[];this.groupsDayCodes=[];this.groupsIndex={};this.entryListIndex={};this.resultEntries=h;this.resultEntriesIndex={};h.forEach(function(j,i){this.resultEntriesIndex[j.uid]=i},this);if(h===false||!h||!h.length){this.showEmptyBlock();return}if(this.noEntriesWrap){this.noEntriesWrap.style.display="none"}this.streamContentWrap.style.display="";this.entryParts=[];this.attachEntries(h,"next")};b.prototype.attachEntries=function(l,j,h){if(!l&&!l.length){return}var i=this.entries.length-l.length,q=i,p,m,n,k;l.forEach(function(r){r.globalIndex=q++;n=this.calendar.util.getDayCode(r.from);k=this.calendar.util.getDayCode(r.to);m=0;this.entryParts.push({index:m,dayCode:n,from:r.from,entry:r});if(n!=k){p=new Date(r.from.getTime()+this.calendar.util.dayLength);while(p.getTime()<r.to.getTime()){this.entryParts.push({index:++m,dayCode:this.calendar.util.getDayCode(p),from:p,entry:r});p=new Date(p.getTime()+this.calendar.util.dayLength)}r.lastPartIndex=m}},this);var o=false;this.entryParts.sort(function(s,r){if(s.dayCode==r.dayCode){if(s.entry.isTask()!==r.entry.isTask()){if(s.entry.isTask()){return 1}if(r.entry.isTask()){return -1}}if(s.entry.isFullDay()!==r.entry.isFullDay()){if(s.entry.isFullDay()){return -1}if(r.entry.isFullDay()){return 1}}}if(s.index>0||r.index>0){return !o?s.index-r.index:r.index-s.index}return !o?s.entry.from.getTime()-r.entry.from.getTime():r.entry.from.getTime()-s.entry.from.getTime()});this.today=new Date();this.animationMode=j;this.currentDisplayedEntry=0;this.actuallyAnimatedEntryCount=0;this.displayEntry(this.entryParts[this.currentDisplayedEntry],j,h)};b.prototype.displayEntry=function(m,o,j){var u;if(m.from.getTime()>this.today.getTime()&&!this.groups[this.groupsIndex[this.todayCode]]&&!this.filterMode){this.createEntryGroupForDate(this.today,o)}u=this.groups[this.groupsIndex[m.dayCode]];if(!u){this.createEntryGroupForDate(m.from,o);u=this.groups[this.groupsIndex[m.dayCode]]}if(u.emptyWarning){BX.remove(u.emptyWarning)}var q=this.getUniqueId(m);if(this.actuallyAnimatedEntryCount>this.animateAmount){o=false;this.animationMode=false}var t=!this.entryListIndex[q];if(t){this.entryListIndex[q]=true;var l,k,p,n,h,i,s=m.entry;this.entriesIndex[s.uid]=s.globalIndex;if(s.isFullDay()){l=BX.message("EC_ALL_DAY")}else{if(s.isLongWithTime()){if(m.index===0){l=this.calendar.util.formatTime(s.from)}else{if(m.index===s.lastPartIndex){l=BX.message("EC_TILL_TIME").replace("#TIME#",this.calendar.util.formatTime(s.to))}else{l=BX.message("EC_ALL_DAY")}}}else{l=this.calendar.util.formatTime(s.from.getHours(),s.from.getMinutes())+" &ndash; "+this.calendar.util.formatTime(s.to.getHours(),s.to.getMinutes())}}k=u.content.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-entry":s.uid},props:{className:"calendar-timeline-stream-content-event"+(o?" calendar-timeline-stream-section-event-animate-"+o:"")}}));p=k.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-content-event-time"},html:'<span class="calendar-timeline-stream-content-event-time-link">'+l+"</span>"}));var r=this.calendar.util.getTextLocation(s.location)||"";if(r){r='<span class="calendar-timeline-stream-content-event-location">('+BX.util.htmlspecialchars(r)+")</span>"}n=k.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-content-event-name"},html:'<span class="calendar-timeline-stream-content-event-color" style="background-color: '+s.color+'"></span><span class="calendar-timeline-stream-content-event-name-link">'+BX.util.htmlspecialchars(s.name)+"</span>"+r}));h=k.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-content-event-members"}}));if(s.isMeeting()&&s.getAttendees().length>0){this.showAttendees(h,s.getAttendees().filter(function(v){return v.STATUS=="Y"||v.STATUS=="H"}),s.getAttendees().length)}else{if(s.isPersonal()){h.innerHTML=BX.message("EC_EVENT_IS_MINE")}}m.DOM={};if(m.dayCode==this.todayCode&&BX.type.isFunction(j)){j()}}if(this.currentDisplayedEntry<this.entryParts.length-1){this.currentDisplayedEntry++;if(o&&t){this.actuallyAnimatedEntryCount++;setTimeout(BX.delegate(function(){this.displayEntry(this.entryParts[this.currentDisplayedEntry],o,j)},this),300)}else{if(this.currentDisplayedEntry%30==0){setTimeout(BX.delegate(function(){this.displayEntry(this.entryParts[this.currentDisplayedEntry],o,j)},this),1000)}else{this.displayEntry(this.entryParts[this.currentDisplayedEntry],o,j)}}}else{if(this.currentDisplayedEntry==this.entryParts.length-1&&!this.filterMode){this.animationMode=false;if(!this.groups[this.groupsIndex[this.todayCode]]){this.createEntryGroupForDate(this.today,o)}this.groupsDayCodes.sort();if(BX.type.isFunction(j)){j()}}}};b.prototype.showAttendees=function(j,h,q){var m,l,n=5,p=h.length,o=7;if(p>0){if(p>o){p=n}for(m=0;m<p;m++){l=h[m]||{};j.appendChild(BX.create("IMG",{attrs:{id:"simple_view_popup_"+l.ID,src:l.AVATAR||""},props:{title:l.DISPLAY_NAME,className:"calendar-member"}}));(function(i){setTimeout(function(){BX.tooltip(i,"simple_view_popup_"+i)},100)})(l.ID)}if(p<h.length){var k=j.appendChild(BX.create("SPAN",{props:{className:"calendar-member-more-count"},text:" "+BX.message("EC_ATTENDEES_MORE").replace("#COUNT#",h.length-p),events:{click:BX.delegate(function(){this.showUserListPopup(k,h)},this)}}))}}};b.prototype.showUserListPopup=function(i,h){if(this.userListPopup){this.userListPopup.close()}this.popup.setAutoHide(false);if(!h||!h.length){return}this.DOM.userListPopupWrap=BX.create("DIV",{props:{className:"calendar-user-list-popup-block"}});h.forEach(function(j){var k=this.DOM.userListPopupWrap.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-container calendar-slider-sidebar-user-card"}}));k.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-avatar"}})).appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-item"}})).appendChild(BX.create("IMG",{props:{width:34,height:34,src:j.AVATAR}}));k.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-info"}})).appendChild(BX.create("A",{props:{href:j.URL?j.URL:"#",className:"calendar-slider-sidebar-user-info-name"},text:j.DISPLAY_NAME}))},this);this.userListPopup=new BX.PopupWindow(this.calendar.id+"-view-user-list-popup",i,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,width:200,resizable:false,lightShadow:true,content:this.DOM.userListPopupWrap,className:"calendar-user-list-popup"});this.userListPopup.setAngle({offset:36});this.userListPopup.show();BX.addCustomEvent(this.userListPopup,"onPopupClose",BX.delegate(function(){this.popup.setAutoHide(true);this.userListPopup.destroy()},this))};b.prototype.appendDateGroup=function(h,i,l){var r,j,o,t,s,k,q=i.getDate(),n=i.getMonth()+1,p=i.getFullYear();if(!this.dateGroupIndex[p]){t=Infinity;s=p;for(r in this.dateGroupIndex){if(this.dateGroupIndex.hasOwnProperty(r)){if(Math.abs(p-r)<t){t=Math.abs(p-r);s=r}if(t==1){break}}}this.dateGroupIndex[p]={node:BX.create("DIV",{attrs:{"data-bx-calendar-list-year":p}}),monthIndex:{}};if(s==p){this.listWrap.appendChild(this.dateGroupIndex[p].node)}else{if(p-s>0){if(this.dateGroupIndex[s].node.nextSibling){BX.insertAfter(this.dateGroupIndex[p].node,this.dateGroupIndex[s].node)}else{this.listWrap.appendChild(this.dateGroupIndex[p].node)}}else{this.listWrap.insertBefore(this.dateGroupIndex[p].node,this.dateGroupIndex[s].node)}}}if(!this.dateGroupIndex[p].monthIndex[n]){t=Infinity;s=n;for(j in this.dateGroupIndex[p].monthIndex){if(this.dateGroupIndex[p].monthIndex.hasOwnProperty(j)){if(Math.abs(n-j)<t){t=Math.abs(n-j);s=j}if(t==1){break}}}this.dateGroupIndex[p].monthIndex[n]={node:BX.create("DIV",{attrs:{"data-bx-calendar-list-month":n}}),dayIndex:{}};if(s==n){this.dateGroupIndex[p].node.appendChild(this.dateGroupIndex[p].monthIndex[n].node)}else{if(n-s>0){if(this.dateGroupIndex[p].monthIndex[s].node.nextSibling){BX.insertAfter(this.dateGroupIndex[p].monthIndex[n].node,this.dateGroupIndex[p].monthIndex[s].node)}else{this.dateGroupIndex[p].node.appendChild(this.dateGroupIndex[p].monthIndex[n].node)}}else{this.dateGroupIndex[p].monthIndex[s].node.parentNode.insertBefore(this.dateGroupIndex[p].monthIndex[n].node,this.dateGroupIndex[p].monthIndex[s].node)}}}if(!this.dateGroupIndex[p].monthIndex[n].dayIndex[q]){t=Infinity;s=q;k=this.dateGroupIndex[p].monthIndex;for(o in k[n].dayIndex){if(k[n].dayIndex.hasOwnProperty(o)){if(Math.abs(q-o)<t){t=Math.abs(q-o);s=o}if(t==1){break}}}k[n].dayIndex[q]={node:BX.create("DIV",{props:{className:"calendar-timeline-stream-day"},attrs:{"data-bx-calendar-list-day":q}})};if(s==q){k[n].node.appendChild(k[n].dayIndex[q].node)}else{if(q-s>0){if(k[n].dayIndex[s].node.nextSibling){BX.insertAfter(k[n].dayIndex[q].node,k[n].dayIndex[s].node)}else{k[n].node.appendChild(k[n].dayIndex[q].node)}}else{k[n].node.insertBefore(k[n].dayIndex[q].node,k[n].dayIndex[s].node)}}}if(k[n].dayIndex[q].node){k[n].dayIndex[q].node.appendChild(h)}else{}setTimeout(function(){h.style.opacity="1"},0)};b.prototype.hide=function(){f.prototype.hide.apply(this,arguments)};b.prototype.getAdjustedDate=function(i,h){if(!i){i=new Date()}var j=this.calendar.getViewRangeDate(),k=false;if(i&&i.getTime){k=new Date(i.getTime())}return k};b.prototype.adjustViewRangeToDate=function(j,h){if(this.viewCont.style.display=="none"){var l=false;if(j&&j.getTime){l=new Date(j.getTime());l.setHours(0,0,0,0);this.currentDate=l;this.calendar.setViewRangeDate(l)}if(h!==false){this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}else{this.show()}}else{var i=this.calendar.util.getDayCode(j);var k=BX.util.array_search(i,this.groupsDayCodes);if(k>=0&&this.groupsDayCodes[k]){this.focusOnDate(this.groupsDayCodes[k],true)}}return l};b.prototype.getViewRange=function(){var h=this.calendar.getViewRangeDate(),i=new Date(h.getTime());return{start:h,end:i}};b.prototype.increaseViewRangeDate=function(){var h=BX.util.array_search(this.focusedDayCode,this.groupsDayCodes);if(h>=0&&this.groupsDayCodes[h+1]){this.focusOnDate(this.groupsDayCodes[h+1],true)}};b.prototype.decreaseViewRangeDate=function(){var h=BX.util.array_search(this.focusedDayCode,this.groupsDayCodes);if(h>0&&this.groupsDayCodes[h-1]){this.focusOnDate(this.groupsDayCodes[h-1],true)}};b.prototype.createEntryGroupForDate=function(i,j){var h=this.calendar.util.getDayCode(i),l=Math.round(i.getTime()/1000)*1000,k={dayCode:h,wrap:BX.create("DIV",{props:{className:"calendar-timeline-stream-section-wrap"}})};k.titleNode=k.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-section calendar-timeline-section-date-label"},html:'<div data-bx-calendar-date="'+l+'" class="calendar-timeline-stream-section-content"><div class="'+(h==this.todayCode?"calendar-timeline-stream-today-label":"calendar-timeline-stream-label")+'">'+this.calendar.util.formatDateUsable(i)+"</div></div>"}));k.groupNode=k.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-section"}}));k.content=k.groupNode.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-stream-section-content"}}));k.emptyWarning=k.content.appendChild(BX.create("DIV",{props:{className:"calendar-timeline-empty-section"},text:BX.message("EC_NO_EVENTS")}));this.groups.push(k);this.groupsIndex[h]=this.groups.length-1;this.groupsDayCodes.push(h);this.appendDateGroup(this.groups[this.groups.length-1].wrap,i,j)};b.prototype.focusOnDate=function(j,h){var i=false;if(BX.type.isDate(j)){i=this.calendar.util.getDayCode(j)}else{if(BX.type.isString(j)){i=j}else{i=this.todayCode}}this.focusedDayCode=i;if(this.groupsIndex&&this.groups[this.groupsIndex[i]]){this.bottomLoaderBlock.style.height=(this.SCROLL_DELTA_HEIGHT+Math.max(0,this.util.getViewHeight()+this.groups[this.groupsIndex[i]].wrap.offsetTop-this.bottomLoaderBlock.offsetTop))+"px";if(h&&this.streamScrollWrap){new BX.easing({duration:300,start:{scrollTop:this.streamScrollWrap.scrollTop},finish:{scrollTop:this.groups[this.groupsIndex[i]].wrap.offsetTop},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate(function(k){this.streamScrollWrap.scrollTop=k.scrollTop},this),complete:BX.delegate(function(){this.streamScrollWrap.scrollTop=this.groups[this.groupsIndex[i]].wrap.offsetTop},this)}).animate()}else{setTimeout(BX.delegate(function(){if(this.streamScrollWrap&&this.groupsIndex[i]!==undefined&&this.groups[this.groupsIndex[i]]){this.streamScrollWrap.scrollTop=this.groups[this.groupsIndex[i]].wrap.offsetTop}},this),200)}}};b.prototype.scrollHandle=function(){if(!this.filterMode){if(this.streamScrollWrap.scrollHeight-this.util.getViewHeight()-this.streamScrollWrap.scrollTop<this.SCROLL_DELTA_HEIGHT&&!this.nothingToLoadNext){this.loadMoreEntries({mode:"next"})}else{if(this.streamScrollWrap.scrollTop<this.SCROLL_DELTA_HEIGHT&&!this.nothingToLoadPrevious){this.loadMoreEntries({mode:"previous"})}}}};b.prototype.loadMoreEntries=function(h){if(this.currentLoadMode||this.filterMode){return}this.currentLoadMode=h.mode;if(h.mode=="next"){this.loader=this.bottomLoaderBlock.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"180px"}}));this.entryController.getList({loadNext:true,loadLimit:this.loadLimit,startDate:new Date(this.displayedRange.end.getFullYear(),this.displayedRange.end.getMonth(),this.displayedRange.end.getDate()+1),finishCallback:BX.proxy(this.loadMoreCallback,this)})}else{this.loader=this.topLoaderBlock.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"180px"}}));this.entryController.getList({loadPrevious:true,loadLimit:this.loadLimitPrevious,finishDate:new Date(this.displayedRange.start.getFullYear(),this.displayedRange.start.getMonth(),this.displayedRange.start.getDate()-1),finishCallback:BX.proxy(this.loadMoreCallback,this)})}};b.prototype.loadMoreCallback=function(i){BX.remove(this.loader);this.displayedRange=this.calendar.entryController.getLoadedEntiesLimits();var h=this.entryController.getList({startDate:this.displayedRange.start,finishDate:this.displayedRange.end,finishCallback:BX.proxy(this.loadMoreCallback,this)});if(this.currentLoadMode=="next"&&i.finish){this.nothingToLoadNext=true}if(this.currentLoadMode=="previous"&&i.finish){this.nothingToLoadPrevious=true}if(!this.entries){this.entries=[]}if(h&&h.length){this.entries=this.entries.concat(h);this.attachEntries(h,this.currentLoadMode=="next"?"next":false)}this.currentLoadMode=false};b.prototype.getUniqueId=function(h){return h.entry.uid+"|"+h.dayCode};b.prototype.handleClick=function(j){if(this.isActive()){if(!j){j={}}var h,i;if(j.specialTarget&&(i=j.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:i,specialTarget:j.specialTarget,target:j.target,e:j.e})}else{if(j.specialTarget&&(h=j.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){}else{if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(h=j.specialTarget&&j.specialTarget.getAttribute("data-bx-calendar-week-day"))){this.showSimplePopupForNewEntry({entry:this.buildTopNewEntryWrap({dayFrom:this.days[this.dayIndex[h]],holder:this.topEntryHolder})})}}}}};b.prototype.showEmptyBlock=function(i){if(!this.noEntriesWrap){this.noEntriesWrap=this.streamScrollWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-main"},style:{height:this.util.getViewHeight()+"px"}}));var h=this.noEntriesWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-empty"},html:'<div class="calendar-search-empty-name">'+BX.message("EC_NO_EVENTS")+"</div>"}));if(!this.calendar.util.readOnlyMode()){this.addButton=h.appendChild(BX.create("SPAN",{props:{className:"calendar-search-empty-link"},text:BX.message("EC_CREATE_EVENT"),events:{click:BX.proxy(function(){if(!this.calendar.editSlider){this.calendar.editSlider=new d.BXEventCalendar.EditEntrySlider(this.calendar)}this.calendar.editSlider.show({})},this)}}))}}this.streamContentWrap.style.display="none";this.noEntriesWrap.style.display=""};b.prototype.applyFilterMode=function(){this.filterMode=true;this.calendar.viewTitleContainer.style.display="none";this.calendar.navigationWrap.style.display="none";if(this.searchHead){BX.remove(this.searchHead)}this.searchHead=this.calendar.topBlock.appendChild(BX.create("DIV",{props:{className:"calendar-search-head"},html:'<div class="calendar-search-name">'+BX.message("EC_SEARCH_RESULT")+"</div>"}));if(this.resettFilterWrap){BX.remove(this.resettFilterWrap)}this.resettFilterWrap=this.searchHead.appendChild(BX.create("DIV",{props:{className:"calendar-search-cancel"},html:BX.message("EC_SEARCH_RESET_RESULT"),events:{click:BX.proxy(this.resetFilterMode,this)}}));if(this.streamScrollWrap){if(!this.filterLoaderWrap){this.filterLoaderWrap=this.streamScrollWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-main"},style:{height:this.util.getViewHeight()+"px"}}));var h=this.filterLoaderWrap.appendChild(BX.create("DIV",{props:{className:"calendar-search-empty"},html:'<div class="calendar-search-empty-name">'+BX.message("EC_NO_EVENTS")+"</div>"}))}this.streamContentWrap.style.display="none";this.filterLoaderWrap.style.display=""}};b.prototype.resetFilterMode=function(h){this.filterMode=false;this.resultEntries=[];this.calendar.viewTitleContainer.style.display="";this.calendar.navigationWrap.style.display="";this.setTitle();if(this.searchHead){BX.remove(this.searchHead)}if(this.resettFilterWrap){BX.remove(this.resettFilterWrap)}this.streamContentWrap.style.display="";if(this.filterLoaderWrap){this.filterLoaderWrap.style.display="none"}if(!h||h.resetSearchFilter!==false){this.calendar.search.resetFilter()}if(this.isActive()){this.displayEntries()}};b.prototype.handleEntryClick=function(h){if(this.filterMode){if(this.resultEntriesIndex[h.uid]!==undefined){h.entry=this.resultEntries[this.resultEntriesIndex[h.uid]]}}f.prototype.handleEntryClick.apply(this,arguments)};if(d.BXEventCalendar){d.BXEventCalendar.CalendarView=f;d.BXEventCalendar.CalendarDayView=e;d.BXEventCalendar.CalendarWeekView=a;d.BXEventCalendar.CalendarMonthView=g;d.BXEventCalendar.CalendarYearView=c;d.BXEventCalendar.CalendarListView=b}else{BX.addCustomEvent(d,"onBXEventCalendarInit",function(){d.BXEventCalendar.CalendarView=f;d.BXEventCalendar.CalendarDayView=e;d.BXEventCalendar.CalendarWeekView=a;d.BXEventCalendar.CalendarMonthView=g;d.BXEventCalendar.CalendarYearView=c;d.BXEventCalendar.CalendarListView=b})}})(window);