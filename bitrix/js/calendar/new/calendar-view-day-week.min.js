(function(b){var e=b.BXEventCalendarView;function d(){e.apply(this,arguments);this.initConfig();this.preBuild()}d.prototype=Object.create(e.prototype);d.prototype.constructor=d;d.prototype.initConfig=function(){this.name="day";this.gridLineHeight=60;this.slotHeight=20;this.title=BX.message("EC_VIEW_DAY");this.entryWidthOffset=2;this.lastEntryWidthOffset=8;this.hotkey="D";this.contClassName="calendar-day-view";this.gridWrapClass="calendar-grid-wrap";this.fullDayContClass="calendar-grid-day-full-days-events-holder";this.fullDayContHolderClass="calendar-grid-week-full-days-events-holder-grid";this.topEntryHolderClass="calendar-grid-day-events-holder";this.outerGridClass="calendar-grid-day-container";this.gridClass="calendar-grid-day";this.gridClassCurrent="calendar-grid-day-current";this.gridClassNext="calendar-grid-day-left-slide";this.gridClassPrevious="calendar-grid-day-right-slide";this.changeNextClass="calendar-change-day-left-slide";this.changePreviousClass="calendar-change-day-right-slide";this.gridRowClass="calendar-grid-day-row";this.gridCellClass="calendar-grid-day-cell";this.gridTimelinesClass="calendar-grid-day-time-lines";this.gridTimelineHourClass="calendar-grid-day-time-line-hour";this.gridTimelineHourLabelClass="calendar-grid-day-time-line-hour-label";this.gridTimelineHourLabelClassInner="calendar-grid-week-time-line-hour-label-inner";this.gridNowTimeClass="calendar-grid-day-time-line-hour-now";this.gridNowTimeLabelClass="calendar-grid-day-time-line-hour-label";this.gridNowTimeLineClass="calendar-grid-day-time-line-hour-now-line";this.gridNowTimeDotClass="calendar-grid-day-time-line-hour-now-dot";this.gridTimeTranslucentClass="calendar-grid-time-line-translucent";this.offHoursClass="calendar-grid-off-hours";this.offHoursCollapseClass="calendar-grid-off-hours-collapse";this.offHoursAnimateClass="calendar-grid-off-hours-animate";this.offHoursFastAnimateClass="calendar-grid-off-hours-fast-animate";this.dayCount=1};d.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}})};d.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-week-row-days-week"}}));var f=this.util.getWorkTime();this.checkTimelineScroll(!this.collapseOffHours||(f.end-f.start)*this.gridLineHeight+20>this.util.getViewHeight());this.fullDayEventsCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:this.fullDayContClass}}));this.gridWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:this.gridWrapClass},style:{height:this.util.getViewHeight()+"px"}}));this.outerGrid=this.gridWrap.appendChild(BX.create("DIV",{props:{className:this.outerGridClass}}));this.grid=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassCurrent}}));BX.bind(this.gridWrap,"mousedown",BX.proxy(this.handleMousedown,this))};d.prototype.show=function(){e.prototype.show.apply(this,arguments);this.buildDaysGrid();this.showNavigationCalendar();BX.remove(this.calendar.additionalInfoOuter);this.displayEntries()};d.prototype.hide=function(){e.prototype.hide.apply(this,arguments)};d.prototype.setFullDayHolderSize=function(f){this.fullDayEventsCont.style.height=(f*(this.slotHeight+1))+"px"};d.prototype.increaseViewRangeDate=function(){this.changeViewRangeDate(this.dayCount);this.setTitle();if(this.gridWrap){this.gridWrap.style.overflowX="hidden"}var f=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassNext+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.buildDaysGrid({grid:f});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.outerGrid,this.changeNextClass);setTimeout(BX.delegate(function(){BX.removeClass(this.outerGrid,this.changeNextClass);BX.removeClass(f,this.gridClassNext);BX.addClass(f,this.gridClassCurrent);BX.remove(this.grid);this.grid=f;BX.removeClass(this.grid,this.animateClass);this.gridWrap.style.overflowX="";this.displayEntries()},this),400)},this),0)};d.prototype.decreaseViewRangeDate=function(){this.changeViewRangeDate(-this.dayCount);this.setTitle();this.gridWrap.style.overflowX="hidden";var f=this.outerGrid.appendChild(BX.create("DIV",{props:{className:this.gridClass+" "+this.gridClassPrevious+" "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.buildDaysGrid({grid:f});setTimeout(BX.delegate(function(){BX.addClass(this.outerGrid,this.changePreviousClass);setTimeout(BX.delegate(function(){BX.removeClass(this.outerGrid,this.changePreviousClass);BX.removeClass(f,this.gridClassPrevious);BX.addClass(f,this.gridClassCurrent);BX.remove(this.grid);this.grid=f;BX.removeClass(this.grid,this.animateClass);this.gridWrap.style.overflowX="";this.displayEntries()},this),400)},this),0)};d.prototype.changeViewRangeDate=function(h){var g=this.calendar.getViewRangeDate(),f=new Date(g.getTime());f.setDate(f.getDate()+h);this.calendar.setViewRangeDate(f);return f};d.prototype.getViewRange=function(){var f=this.calendar.getViewRangeDate(),g=new Date(f.getTime());g.setDate(g.getDate()+this.dayCount);return{start:f,end:g}};d.prototype.getAdjustedDate=function(g,f){if(!g){g=new Date()}if(f&&g.getTime()<f.start.getTime()){g=new Date(f.start.getTime())}if(f&&g.getTime()>f.end.getTime()){g=new Date(f.end.getTime())}var h=false;if(g&&g.getTime){g.setHours(0,0,0,0);h=new Date(g.getTime())}return h};d.prototype.adjustViewRangeToDate=function(g,f){var h=this.calendar.getViewRangeDate(),i=false;if(g&&g.getTime){g.setHours(0,0,0,0);var j=(g.getTime()-h.getTime())/this.calendar.util.dayLength;if(j===this.dayCount){this.increaseViewRangeDate()}else{if(j===-this.dayCount){this.decreaseViewRangeDate()}else{i=new Date(g.getTime());i.setHours(0,0,0,0);this.calendar.setViewRangeDate(i);if(f===false){this.show()}else{this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}}}}return i};d.prototype.buildDaysGrid=function(l){if(!l){l={}}var j,g,h=l.grid||this.grid,k=this.calendar.getViewRangeDate(),f=new Date(k.getTime());if(this.dayCount>1){f=this.getAdjustedDate(f)}BX.cleanNode(h);BX.cleanNode(this.fullDayEventsCont);this.holderTitle=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-day-full-days-events-holder-title"},text:BX.message("EC_VIEW_DAY")}));this.fullDayEventsHolderCont=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:this.fullDayContHolderClass}}));this.topEntryHolder=this.fullDayEventsCont.appendChild(BX.create("DIV",{props:{className:this.topEntryHolderClass}}));this.gridRow=h.appendChild(BX.create("DIV",{props:{className:this.gridRowClass+" "+this.animateClass},style:{height:this.getDayGridHeight()+"px"}}));this.dayIndex={};this.days=[];if(this.titleCont){BX.cleanNode(this.titleCont)}this.gridRowShadow=BX.create("DIV",{props:{className:"calendar-grid-week-row-shadow"}});for(j=0;j<this.dayCount;j++){g=this.util.getDayCode(f);this.fullDayEventsHolderCont.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-week-day":g},props:{className:this.gridCellClass}}));this.buildDayCell({date:f,month:"previous",grid:h});if(this.dayCount>1){f.setDate(f.getDate()+1)}this.gridRowShadow.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-timeline-day":g},props:{className:"calendar-grid-week-cell"},html:'<span class="calendar-grid-cell-inner"></span>'}))}this.timeLinesCont=this.gridRow.appendChild(BX.create("DIV",{props:{className:this.gridTimelinesClass}}));this.timelineEntryHolder=this.gridRow.appendChild(BX.create("DIV",{props:{className:this.topEntryHolderClass}}));this.timeLinesIndex=[];for(j=0;j<=24;j++){this.timeLinesIndex[j]=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourClass},html:'<div class="'+this.gridTimelineHourLabelClass+'">'+this.calendar.util.formatTime(j,0,true)+"</div>",style:{top:((j)*this.gridLineHeight)+"px"}}))}this.gridRow.appendChild(this.gridRowShadow);setTimeout(BX.delegate(function(){if(!this.gridWrap.scrollTop&&!this.collapseOffHours){var i=this.util.getWorkTime();this.gridWrap.scrollTop=i.start*this.gridLineHeight-5}},this),0);this.showOffHours();this.showNowTime(this.gridRow);this.gridRow.appendChild(BX.create("DIV",{props:{className:"calendar-grid-day-events-holder"}}))};d.prototype.buildDayCell=function(m){var i=m.date,j="",k="",l=Math.round(i.getTime()/1000)*1000,f=i.getDay(),h=this.util.getDayCode(i),g=this.util.getWeekDayByInd(f);if(m.month==="previous"){k+=" calendar-grid-previous-month-day"}else{if(m.month==="next"){k+=" calendar-grid-next-month-day"}}if(this.util.isHoliday(i)){k+=" calendar-grid-holiday"}if(this.util.isToday(i)){j+=" calendar-grid-today"}if(this.titleCont&&this.name==="week"){this.titleCont.appendChild(BX.create("DIV",{props:{className:this.gridCellClass+j},html:'<span class="calendar-grid-cell-inner" data-bx-calendar-date="'+l+'">'+(BX.message("EC_WEEK_TITLE").replace("#DAY_OF_WEEK#",BX.date.format("D",l/1000)).replace("#DATE#",i.getDate()))+"</span>"}))}else{if(this.titleCont){this.titleCont.appendChild(BX.create("DIV",{props:{className:this.gridCellClass+j},html:'<span class="calendar-grid-cell-inner" data-bx-calendar-date="'+l+'"><span class="calendar-day-of-week-day">'+BX.date.format("l",l/1000)+"</span></span>"}))}}this.days.push({date:new Date(i.getTime()),dayOffset:this.util.getWeekDayOffset(g),node:this.gridRow.appendChild(BX.create("DIV",{attrs:{"data-bx-calendar-timeline-day":h},props:{className:this.gridCellClass+k+" a1"},html:'<span class="calendar-grid-cell-inner"></span>'})),dayCode:h});this.dayIndex[this.days[this.days.length-1].dayCode]=this.days.length-1;this.calendar.dragDrop.registerTimelineDay(this.days[this.days.length-1])};d.prototype.setTitle=function(){var f=this.calendar.getViewRangeDate(),g=f.getTime()/1000;e.prototype.setTitle.apply(this,[BX.date.format(BX.message("EC_DATE_FORMAT_1_MAY"),g)+" #GRAY_START#"+BX.date.format("Y",g)+"#GRAY_END#"])};d.prototype.displayEntries=function(k){var l,q,g,m,n,f,h=0,p=this.getViewRange();if(!k){k={}}if(k.reloadEntries!==false){this.entries=this.entryController.getList({startDate:new Date(p.start.getFullYear(),p.start.getMonth(),1),finishDate:new Date(p.end.getFullYear(),p.end.getMonth()+1,1),viewRange:p,finishCallback:BX.proxy(this.displayEntries,this)})}this.partsStorage=[];this.timelinePartsStorage=[];BX.cleanNode(this.topEntryHolder);BX.cleanNode(this.timelineEntryHolder);this.fullDayEventsCont.style.height="";this.days.forEach(function(i){i.slots=[];i.timelineMap={};if(i.collapsedWrap&&i.collapsedWrap.top){i.collapsedWrap.top.destroy()}if(i.collapsedWrap&&i.collapsedWrap.bottom){i.collapsedWrap.bottom.destroy()}i.collapsedWrap={top:null,bottom:null};i.entries={topList:[],started:[],timeline:[],hidden:[]}});if(this.entries&&this.entries.length){for(l=0;l<this.entries.length;l++){q=this.entries[l];this.entriesIndex[q.uid]=l;q.cleanParts();f=false;for(m=this.dayIndex[q.startDayCode];m<this.days.length;m++){n=this.days[m];if(!q.isLongWithTime()&&n.dayCode===q.startDayCode&&n.dayCode===q.endDayCode&&!q.fullDay){g=q.startPart({from:n,to:n,daysCount:0,fromTimeValue:this.util.getTimeValue(q.from),toTimeValue:this.util.getTimeValue(q.to)});n.entries.timeline.push({entry:q,part:g});this.timelinePartsStorage.push({part:g,entry:q});break}else{if(n.dayCode===q.startDayCode){f=true;g=q.startPart({from:n,daysCount:0});n.entries.started.push({entry:q,part:g})}if(f){n.entries.topList.push({entry:q,part:g});g.daysCount++;g.to=n;if(n.entries.topList.length>h){h=n.entries.topList.length}if(n.dayCode===q.endDayCode||n.dayOffset===this.dayCount-1||this.dayCount===1){this.partsStorage.push({part:g,entry:q});if(n.dayCode===q.endDayCode){break}}}}}}}if(this.entries&&this.entries.length){this.displayTopEntries();this.displayTimelineEntries();this.SLOTS_COUNT=10;this.arrangeTopEntries();this.arrangeTimelineEntries()}this.setFullDayHolderSize(Math.min(Math.max(h,1),this.SLOTS_COUNT));var o;for(m=0;m<this.days.length;m++){n=this.days[m];if(n.entries.topList.length>0){o=false;for(l=0;l<n.entries.topList.length;l++){if(n.entries.topList[l].part.params.wrapNode.style.display==="none"){o=true;break}}if(o){n.hiddenStorage=this.topEntryHolder.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-wrap calendar-event-more-btn-container"},attrs:{"data-bx-calendar-show-all-events":n.dayCode},style:{top:(parseInt(this.fullDayEventsCont.style.height)-20)+"px",left:this.dayCount===1?"0":"calc((100% / "+this.dayCount+") * ("+(n.dayOffset+1)+" - 1) + 2px)",width:"calc(100% / "+this.dayCount+" - 3px)"}}));n.hiddenStorageText=n.hiddenStorage.appendChild(BX.create("span",{props:{className:"calendar-event-more-btn"}}));n.hiddenStorage.style.display="block";n.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" "+n.entries.topList.length}else{if(n.hiddenStorage){n.hiddenStorage.style.display="none"}}}}BX.addClass(this.grid,"calendar-events-holder-show");BX.addClass(this.fullDayEventsCont,"calendar-events-holder-show");var j=this.util.getWorkTime();this.checkTimelineScroll(!this.collapseOffHours||(j.end-j.start)*this.gridLineHeight+20>this.util.getViewHeight())};d.prototype.arrangeTopEntries=function(){var g,p,h,f,l,m,o,n,k;for(l=0;l<this.days.length;l++){m=this.days[l];if(m.entries.started.length>0){m.entries.started.sort(this.calendar.entryController.sort);for(h=0;h<m.entries.started.length;h++){g=m.entries.started[h];if(g){o=g.entry;n=g.part;if(!o.checkPartIsRegistered(n)){continue}k=false;for(f=0;f<this.SLOTS_COUNT;f++){if(m.slots[f]!==false){this.occupySlot({slotIndex:f,startIndex:l,endIndex:l+n.daysCount});k=true;o.getWrap(n.partIndex).style.top=(f*this.slotHeight)+"px";break}}if(!k){p=m.entries.started[h-1];if(p){m.entries.hidden.push(p);p.entry.getWrap(p.part.partIndex).style.display="none"}m.entries.hidden.push(g);o.getWrap(n.partIndex).style.display="none"}}if(m.hiddenStorage&&m.entries.hidden.length>0){m.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" ("+m.entries.topList.length+")"}}}}};d.prototype.arrangeTimelineEntries=function(){var q=30,D=33,K=20,o=40,z=23,x=6,w=2,I,t,y,n,F,B,E,M,j,G,v,C,u,A,f,L,H,h,g;function m(N){var i,l;for(i=N.timeFrom;i<N.timeTo;i++){if(!N.layers[i]){N.layers[i]=[]}l=N.day.layers[i][N.layerIndex]||{entries:[],start:[]};l.entries.push(N.entryIndex);if(i==N.timeFrom){l.start.push(N.entryIndex);N.entryPart.layerParallels=l.start.length}N.day.layers[i][N.layerIndex]=l}N.entryPart.layerIndex=N.layerIndex}function p(l,N){var i=E.layers[l][N];return i&&i.entries&&i.entries.length===i.start.length}function k(i){return !i}function J(Q){var i,O,l,N=[],P={};for(i=Q.timeFrom;i<Q.timeTo;i++){if(Q.layerIndex>0&&Q.day.layers[i][Q.layerIndex-1]){O=Q.day.layers[i][Q.layerIndex-1].entries;if(O.length>0){l=O[O.length-1];if(!P[l]){P[l]=true;N.push(l)}}}}return N}function s(i,l){if(!l){l=q}return i.getHours()*60+Math.floor(i.getMinutes()/l)*l}for(B=0;B<this.days.length;B++){E=this.days[B];E.entries.timeline.sort(function(l,i){if(l.part.fromTimeValue===i.part.fromTimeValue){return(i.part.toTimeValue-i.part.fromTimeValue)-(l.part.toTimeValue-l.part.fromTimeValue)}return l.part.fromTimeValue-i.part.fromTimeValue});I=0;y="";t=0;C=0;E.layers=[];for(n=0;n<E.entries.timeline.length;n++){h=E.entries.timeline[n].entry;g=E.entries.timeline[n].part;G=s(h.from,1);v=s(h.to,1);if(G===v){v+=1}if(!E.layers){E.layers=[]}u=0;while(true){if(!E.layers[G]||p(G,u)||k(E.layers[G][u])){m({day:E,timeFrom:G,timeTo:v,layers:E.layers,entryIndex:n,layerIndex:u,entryPart:g});break}u++}}for(n=0;n<E.entries.timeline.length;n++){if(E.entries.timeline[n]){h=E.entries.timeline[n].entry;g=E.entries.timeline[n].part;G=s(h.from,1);v=s(h.to,1);if(G===v){v+=1}if(!h.checkPartIsRegistered(g)||!E.layers[G]||!E.layers[G][g.layerIndex]){continue}j=E.layers[G][g.layerIndex].start;if(g.params&&g.params.wrapNode){g.params.wrapNode.style.zIndex=G}g.absoluteLeftOffset=w;if(g.layerIndex>0){H=J({day:E,entryIndex:n,layerIndex:g.layerIndex,timeFrom:G,timeTo:v});for(F=0;F<H.length;F++){A=E.entries.timeline[H[F]];if(A&&A.part&&A.part.params&&g.params.wrapNode){f=parseInt(g.params.wrapNode.style.top)-parseInt(A.part.params.wrapNode.style.top);if(f>D){g.offsetFractionLeft=A.part.offsetFractionWidth*0.1}else{g.offsetFractionLeft=A.part.offsetFractionWidth*0.45}g.offsetFractionLeftTotal=A.part.offsetFractionLeftTotal+g.offsetFractionLeft;g.offsetFractionWidth=1-g.offsetFractionLeftTotal;if(this.dayCount>1){g.offsetLeftRate=g.from.dayOffset+g.offsetFractionLeftTotal}else{g.offsetLeftRate=g.offsetFractionLeftTotal}g.absoluteLeftOffset=(A.absoluteLeftOffset||w)+x;L=1-g.offsetFractionLeftTotal;if(f<=D){if(f<K){A.part.params.timeNode.style.maxWidth="calc("+((1-g.offsetFractionWidth)*100)+"% - 4px)";if(A.part.params.timeNode.offsetWidth<o){A.part.params.timeNode.style.textOverflow="clip";A.part.params.timeNode.style.maxWidth=o+"px"}}A.part.params.nameNode.style.maxWidth="calc("+((1-g.offsetFractionWidth)*100)+"% - 4px)";if(A.part.params.nameNode.offsetWidth<o){A.part.params.nameNode.style.textOverflow="clip";A.part.params.nameNode.style.maxWidth="calc("+((1-g.offsetFractionWidth)*100)+"% + 5px)";this.checkTimelineEntrySize(A.part,A.entry,true)}}else{if(A.part.params.nameNode){A.part.params.nameNode.style.maxHeight=(f-z)+"px"}}g.params.wrapNode.style.left="calc((100% / "+this.dayCount+") * "+g.offsetLeftRate+")";g.params.wrapNode.style.width="calc(100% / ("+this.dayCount+") * "+g.offsetFractionWidth+" - "+this.lastEntryWidthOffset+"px)";BX.addClass(g.params.wrapNode,"calendar-bordered-block")}}}if(j.length>1){M=BX.util.array_search(n,E.layers[G][g.layerIndex].start);var r=this.entryWidthOffset;if(M==E.layers[G][g.layerIndex].start.length-1){r=this.lastEntryWidthOffset;if(g.absoluteLeftOffset>w){r+=(g.absoluteLeftOffset/j.length)+1}}if(this.dayCount>1){g.params.wrapNode.style.width="calc(100% / ("+this.dayCount+" * "+j.length+") - "+r+"px)";g.params.wrapNode.style.left="calc((100% / "+this.dayCount+") * "+g.from.dayOffset+" + 100% * "+M+"/ ("+this.dayCount+" * "+j.length+") + "+g.absoluteLeftOffset+"px)"}else{g.params.wrapNode.style.width="calc(100% / ("+this.dayCount+" * "+j.length+") - "+r+"px)";g.params.wrapNode.style.left="calc(100% * "+M+"/ "+j.length+" + "+g.absoluteLeftOffset+"px)"}}this.checkTimelineEntrySize(g,h,true)}}}};d.prototype.fillTimelineMap=function(j,h,f){var g,l=h.from.getHours()*60+h.from.getMinutes(),k=h.to.getHours()*60+h.to.getMinutes();for(g=l;g<k;g++){if(!j[g]){j[g]=[]}j[g].push(f)}};d.prototype.displayTopEntry=function(j){var n,r=j.entry,q=j.part.from,i=j.part.daysCount,s,p,t,f,m,h,k,u="calendar-event-line-wrap",l=0,g,o;if(r.isFullDay()){u+=" calendar-event-line-fill"}else{if(r.isLongWithTime()){u+=" calendar-event-line-border"}}if(this.util.getDayCode(r.from)!==this.util.getDayCode(q.date)){u+=" calendar-event-line-start-yesterday";l+=8;g=this.getArrow("left",r.color,r.isFullDay())}if(this.util.getDayCode(r.to)!==this.util.getDayCode(j.part.to.date)){u+=" calendar-event-line-finish-tomorrow";o=this.getArrow("right",r.color,r.isFullDay());l+=12}if(g&&!o){l+=4}if(l===0){l=5}s=BX.create("DIV",{attrs:{"data-bx-calendar-entry":r.uid},props:{className:u},style:{top:0,left:this.dayCount>1?"calc((100% / "+this.dayCount+") * ("+(q.dayOffset+1)+" - 1) + 2px)":"2px",width:"calc("+i+" * 100% / "+this.dayCount+" - "+l+"px)"}});if(g){s.appendChild(g);s.style.left="9px"}if(o){s.appendChild(o)}k=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));t=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));p=t.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-dot"}}));if(r.isFullDay()){t.style.maxWidth="calc(200% / "+i+" - "+this.lastEntryWidthOffset+"px)"}else{if(r.isLongWithTime()){s.style.borderColor=r.color;t.style.maxWidth="calc(200% / "+i+" - "+this.lastEntryWidthOffset+"px)";if(j.part.partIndex===0){if(i>1){m=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(r.from.getHours(),r.from.getMinutes())}))}t.style.width="calc(100% / "+i+" - "+this.lastEntryWidthOffset+"px)"}if(!m&&i===1&&this.util.getDayCode(r.from)===j.part.from.dayCode){m=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(r.from.getHours(),r.from.getMinutes())}))}if(j.part.partIndex===r.parts.length-1){if(i>1&&r.parts.length>1){t.style.width="calc("+(i-1)+"00% / "+i+" - "+this.lastEntryWidthOffset+"px)"}if(i>1){h=t.appendChild(BX.create("SPAN",{props:{className:(r.parts.length>1&&i===1)?"calendar-event-line-time":"calendar-event-line-expired-time"},text:this.calendar.util.formatTime(r.to.getHours(),r.to.getMinutes())}))}}if(!h&&i===1&&this.util.getDayCode(r.to)===j.part.to.dayCode){h=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(r.to.getHours(),r.to.getMinutes())}))}}else{m=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(r.from.getHours(),r.from.getMinutes())}))}}f=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:j.entry.name}));if(r.isFullDay()){k.style.backgroundColor=this.calendar.util.hexToRgba(r.color,0.3);k.style.borderColor=this.calendar.util.hexToRgba(r.color,0.3)}else{if(r.isLongWithTime()){k.style.borderColor=this.calendar.util.hexToRgba(r.color,0.5)}p.style.backgroundColor=r.color}(j.holder||this.topEntryHolder).appendChild(s);n={wrapNode:s,nameNode:f,innerNode:t,innerContainer:k,timeNode:m||false,endTimeNode:h||false,dotNode:p};if(!j.popupMode){j.entry.registerPartNode(j.part,n)}this.calendar.dragDrop.registerEntry(s,j);return n};d.prototype.displayTopEntries=function(){var f;for(f=0;f<this.partsStorage.length;f++){this.displayTopEntry(this.partsStorage[f])}};d.prototype.displayTimelineEntries=function(){this.zIndexTimeline=100;this.timelinePartsStorage.sort(function(h,g){if(h.part.fromTimeValue===g.part.fromTimeValue){return(g.part.toTimeValue-g.part.fromTimeValue)-(h.part.toTimeValue-h.part.fromTimeValue)}return h.part.fromTimeValue-g.part.fromTimeValue});for(var f=0;f<this.timelinePartsStorage.length;f++){this.displayTimelineEntry(this.timelinePartsStorage[f])}};d.prototype.displayTimelineEntry=function(k){var o=false,q,i,t,f,n,h,m,p,j=this.util.getWorkTime(),s=k.entry,r=k.part.from,g=k.part.fromTimeValue,l=k.part.toTimeValue,u="calendar-event-block-wrap";if(s.hasEmailAttendees()||s.ownerIsEmailUser()){u+=" calendar-event-block-wrap-icon"}if(s.isExpired()){u+=" calendar-event-block-wrap-past"}if(!this.collapseOffHours||(l>j.start&&g<j.end)){if(this.collapseOffHours){g=Math.max(k.part.fromTimeValue,j.start);l=Math.min(k.part.toTimeValue,j.end);q=((g-j.start)*this.gridLineHeight+1)+"px"}else{q=(g*this.gridLineHeight+1)+"px"}i=BX.create("DIV",{attrs:{"data-bx-calendar-entry":s.uid},props:{className:u},style:{top:q,height:((l-g)*this.gridLineHeight-3)+"px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+r.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}});t=i.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"}}));p=t.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-background"}}));h=this.calendar.util.formatTime(s.from)+" &ndash; "+this.calendar.util.formatTime(s.to);if(s.hasEmailAttendees()||s.ownerIsEmailUser()){t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-icon-mail"}}))}f=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-text"},text:k.entry.name}));if(!this.calendar.util.isDarkColor(s.color)){BX.Dom.addClass(t,"calendar-event-text-dark")}n=t.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-time"},html:h}));p.style.backgroundColor=s.color;if(this.calendar.entryController.canDo(s,"edit")){m=i.appendChild(BX.create("DIV",{props:{className:"calendar-event-resizer"}}))}this.timelineEntryHolder.appendChild(i);o={wrapNode:i,nameNode:f,innerNode:t,timeNode:n,blockBackgroundNode:p,resizerNode:m};k.part.offsetFractionRate=1;k.part.offsetFractionLeft=0;k.part.offsetFractionWidth=1;k.part.offsetFractionLeftTotal=0;k.entry.registerPartNode(k.part,o);this.calendar.dragDrop.registerEntry(i,k)}else{this.addHiddenEntry({position:g<j.end?"top":"bottom",entry:s})}return o};d.prototype.addHiddenEntry=function(f){this.getCollapsedWrap({position:f.position,dayCode:this.util.getDayCode(f.entry.from)}).addEntry(f.entry)};d.prototype.getCollapsedWrap=function(g){if(this.dayIndex[g.dayCode]!==undefined&&this.days[this.dayIndex[g.dayCode]]){var f=this.days[this.dayIndex[g.dayCode]];if(!f.collapsedWrap[g.position]||!f.collapsedWrap[g.position].inited()){f.collapsedWrap[g.position]=new c({position:g.position,wrap:this.timelineEntryHolder,workTime:this.util.getWorkTime(),dayOffset:f.dayOffset,dayCount:this.dayCount,lastEntryWidthOffset:this.lastEntryWidthOffset,gridLineHeight:this.gridLineHeight,labelMessage:this.calendar.collapsedLabelMessage,clickHandler:function(){if(this.collapseOffHours){this.switchOffHours(true)}}.bind(this),mouseoverHandler:function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")}.bind(this),mouseoutHandler:function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")}.bind(this)})}return f.collapsedWrap[g.position]}return null};d.prototype.displayTimelineCollapsedEntry=function(f){};d.prototype.checkTimelineEntrySize=function(g,f,h){if(g.params.innerNode){if(g.params.innerNode.offsetHeight){this.setEntryBlockCompact(g,f)}if(h===true){setTimeout(BX.proxy(function(){this.checkTimelineEntrySize(g,f,false)},this),100)}}};d.prototype.setEntryBlockCompact=function(l,o){var q,n,g,m=16,i=23,k=60,f=l.params.nameNode,p=l.params.innerNode,h=p.offsetWidth,j=parseInt(f.style.maxHeight);if(j){q=Math.floor((Math.min(p.offsetHeight-i,j))/m)}else{q=Math.floor((p.offsetHeight-i)/m)}if(j||f.offsetHeight+i>p.offsetHeight||h<k){if(q<1||h<k){n=(o.entry&&o.entry.from)?o.entry.from:o.from;if(n){g=this.calendar.util.formatTime(n.getHours(),n.getMinutes());l.params.timeNode.innerHTML=g}BX.addClass(l.params.wrapNode,"calendar-event-block-compact");if(h<k){BX.addClass(l.params.wrapNode,"narrow-block")}}else{if(q===1){f.style.whiteSpace="nowrap";f.style.display="block"}else{if(BX.browser.IsChrome()){f.style.WebkitLineClamp=q;f.style.display="-webkit-box"}else{f.style.height=q*m+"px"}}}}};d.prototype.showNowTime=function(f){this.nowTimeCont=f.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeClass}}));this.nowTimeLine=this.nowTimeCont.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeLineClass}}));this.nowTimeLine.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeDotClass}}));this.nowTimeLabel=this.nowTimeCont.appendChild(BX.create("DIV",{props:{className:this.gridNowTimeLabelClass}}));if(this.nowTimeInterval){clearInterval(this.nowTimeInterval)}this.updateNowTime();this.nowTimeInterval=setInterval(BX.proxy(this.updateNowTime,this),15000)};d.prototype.hideNowTime=function(){BX.cleanNode(this.nowTimeCont,1);delete this.nowTimeCont;if(this.nowTimeInterval){clearInterval(this.nowTimeInterval)}};d.prototype.updateNowTime=function(){if(!this.nowTimeCont){return}var i=10,k=15,h=this.util.getWorkTime(),g=new Date(),n=this.getViewRange(),f=this.util.getTimeValue(g),m=true,o=Math.round(f);var j=document.querySelector("."+this.gridTimeTranslucentClass);if(j){BX.removeClass(j,this.gridTimeTranslucentClass)}if(g.getTime()>n.start.getTime()&&g.getTime()<n.end.getTime()){if(this.dayCount>1){var p=this.util.getWeekDayOffset(this.util.getWeekDayByInd(g.getDay()));if(p==0){this.nowTimeLine.style.left=0}else{this.nowTimeLine.style.left="calc("+p+" * 100% / "+this.dayCount+" - 4px)"}}}else{return this.hideNowTime()}var l=this.calendar.util.formatTime(g.getHours(),g.getMinutes());if(BX.isAmPmMode()){l=l.replace(/(\sam|pm)/ig,"<small>$1<small>")}this.nowTimeLabel.innerHTML=l;if(this.collapseOffHours){if(f<h.start){m=false;this.nowTimeLabel.style.display="none";this.nowTimeCont.style.top="-5px"}else{if(f>h.end){m=false;this.nowTimeLabel.style.display="none";this.nowTimeCont.style.top=((h.end-h.start)*this.gridLineHeight)+4+"px"}else{if(f<h.start+i/this.gridLineHeight||f>h.end-i/this.gridLineHeight){this.nowTimeLabel.style.display="none"}else{this.nowTimeLabel.style.display=""}this.nowTimeCont.style.top=((f-h.start)*this.gridLineHeight+this.timeLinesCont.offsetTop)+"px"}}}else{if((f<h.start+k/this.gridLineHeight&&f>h.start)||(f>h.end-k/this.gridLineHeight&&f<h.end)){m=false;this.nowTimeLabel.style.display="none"}this.nowTimeCont.style.top=(f*this.gridLineHeight+this.timeLinesCont.offsetTop)+"px"}if(m&&Math.abs((o-f)*this.gridLineHeight)<i){if(this.timeLinesIndex[o]){BX.addClass(this.timeLinesIndex[o],this.gridTimeTranslucentClass)}}};d.prototype.getTimeByPos=function(i,g){var f=this.util.getWorkTime(),h=i/this.gridLineHeight,j=this.util.getTimeByFraction(h,g||10);if(this.collapseOffHours){j.h+=f.start}return j};d.prototype.showOffHours=function(){var f=this.util.getWorkTime();this.topOffHours=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.offHoursClass+" "+this.offHoursAnimateClass},style:{top:0,height:(f.start*this.gridLineHeight+1)+"px"}}));this.topOffHoursLabel=this.topOffHours.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourLabelClass},html:"<span>"+this.calendar.util.formatTime(0,0,true)+"</span><span>"+this.calendar.util.formatTime(f.start,0,true)+"</span>"}));this.topOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-active"},events:{click:BX.proxy(this.switchOffHours,this),mouseover:BX.proxy(function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this),mouseout:BX.proxy(function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this)}}));this.topOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-drag-down"},attrs:{"data-bx-calendar-off-time-drag":"top"},events:{mousedown:BX.proxy(this.offHoursMousedown,this)}}));this.bottomOffHours=this.timeLinesCont.appendChild(BX.create("DIV",{props:{className:this.offHoursClass+" "+this.offHoursAnimateClass},style:{top:(f.end*this.gridLineHeight+1)+"px",height:((24-f.end)*this.gridLineHeight+1)+"px"}}));this.bottomOffHoursLabel=this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:this.gridTimelineHourLabelClass},html:"<span>"+this.calendar.util.formatTime(f.end,0,true)+"</span><span>"+this.calendar.util.formatTime(24,0,true)+"</span>"}));this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-active"},events:{click:BX.proxy(this.switchOffHours,this),mouseover:BX.proxy(function(){BX.addClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.addClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this),mouseout:BX.proxy(function(){BX.removeClass(this.topOffHours,"calendar-grid-off-hours-hover");BX.removeClass(this.bottomOffHours,"calendar-grid-off-hours-hover")},this)}}));this.bottomOffHours.appendChild(BX.create("DIV",{props:{className:"calendar-grid-off-hours-drag-up"},attrs:{"data-bx-calendar-off-time-drag":"bottom"},events:{mousedown:BX.proxy(this.offHoursMousedown,this)}}));BX.bind(this.topOffHours,"click",BX.proxy(function(){if(this.collapseOffHours){this.switchOffHours(true)}},this));BX.bind(this.bottomOffHours,"click",BX.proxy(function(){if(this.collapseOffHours){this.switchOffHours(true)}},this));if(this.collapseOffHours){this.gridRow.style.height=(this.gridLineHeight*(f.end-f.start))+30+"px";this.collapseOffHours=!this.collapseOffHours;this.switchOffHours(false);this.updateGridRowShadowHeight()}else{this.gridRow.style.height=(this.gridLineHeight*24)+40+"px";this.updateGridRowShadowHeight()}};d.prototype.offHoursMousedown=function(g){var f=g.target||g.srcElement;this.lastWorkTime=false;this.lastTopCount=false;if(f&&f.getAttribute){this.lastWorkTime=BX.clone(this.util.getWorkTime());BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.bind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.bind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.removeClass(this.topOffHours,this.offHoursAnimateClass);BX.removeClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursFastAnimateClass);BX.addClass(this.bottomOffHours,this.offHoursFastAnimateClass);if(f.getAttribute("data-bx-calendar-off-time-drag")=="top"){this.offtimeTuneMode="top"}else{this.offtimeTuneMode="bottom"}this.offtimeTuneBaseZeroPos=BX.pos(this.timeLinesCont).top}};d.prototype.offHoursMousemove=function(h){if(this.offtimeTuneMode){var f=this.util.getMousePos(h),g=Math.max(Math.round((f.y-this.offtimeTuneBaseZeroPos)/this.gridLineHeight),0);if(this.lastTopCount!==g){if(this.offtimeTuneMode=="top"){g=Math.min(this.lastWorkTime.end-1,g);this.topOffHours.style.height=(g*this.gridLineHeight+1)+"px";this.lastWorkTime.start=g}else{g=Math.max(this.lastWorkTime.start+1,g);this.bottomOffHours.style.top=g*this.gridLineHeight+"px";this.bottomOffHours.style.height=((24-g)*this.gridLineHeight+1)+"px";this.lastWorkTime.end=g}this.lastTopCount=g}}};d.prototype.offHoursMouseup=function(){BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.removeClass(this.topOffHours,this.offHoursFastAnimateClass);BX.removeClass(this.bottomOffHours,this.offHoursFastAnimateClass);var f=this.util.setWorkTime(this.lastWorkTime);this.topOffHoursLabel.innerHTML=this.calendar.util.formatTime(0,0,true)+"<br>"+this.calendar.util.formatTime(f.start,0,true);this.bottomOffHoursLabel.innerHTML=this.calendar.util.formatTime(f.end,0,true)+"<br>"+this.calendar.util.formatTime(24,0,true);this.offtimeTuneMode=false;delete this.lastWorkTime;delete this.lastTopCount;this.collapseOffHours=false;this.switchOffHours(true)};d.prototype.switchOffHours=function(f){if(this.denySwitch){return}f=f!==false;if(this.nowTimeCont){this.nowTimeCont.display="none"}var k=20;BX.cleanNode(this.timelineEntryHolder);this.hideNowTime();if(f){BX.removeClass(this.grid,"calendar-events-holder-show");BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.timeLinesCont,this.offHoursAnimateClass)}else{BX.removeClass(this.bottomOffHours,this.offHoursAnimateClass);BX.removeClass(this.topOffHours,this.offHoursAnimateClass);BX.removeClass(this.timeLinesCont,this.offHoursAnimateClass)}this.denySwitch=true;var l=this,g=300,j,q,h=this.util.getWorkTime();setTimeout(BX.delegate(function(){this.denySwitch=false;if(this.collapseOffHours){}else{for(j in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(j)){this.timeLinesIndex[j].style.opacity="";this.timeLinesIndex[j].style.display=""}}}BX.addClass(this.bottomOffHours,this.offHoursAnimateClass);BX.addClass(this.topOffHours,this.offHoursAnimateClass);BX.addClass(this.timeLinesCont,this.offHoursAnimateClass);if(this.scrollTopInterval){clearTimeout(this.scrollTopInterval)}if(this.timeLinesCont&&!this.nowTimeCont){this.showNowTime(this.gridRow)}if(f){BX.addClass(this.grid,"calendar-events-holder-show");this.displayEntries()}},this),f?500:10);function p(i){if(f){setTimeout(function(){i.style.opacity=1},g)}else{i.style.opacity=1}}function n(i){if(f){setTimeout(function(){i.style.display="none"},g)}else{i.style.display="none"}}function o(){l.gridWrap.scrollTop=l.savedScrollTop||(h.start*l.gridLineHeight-5);l.scrollTopInterval=setTimeout(o,5)}var m=true;if(!this.collapseOffHours&&(h.end-h.start)*this.gridLineHeight+20<=this.util.getViewHeight()){m=false}this.checkTimelineScroll(m);if(this.collapseOffHours){this.gridRow.style.height=(this.gridLineHeight*24)+40+"px";this.topOffHours.style.height=(this.gridLineHeight*h.start)+1+"px";this.bottomOffHours.style.height=(this.gridLineHeight*(24-h.end))+1+"px";this.bottomOffHours.style.top=(this.gridLineHeight*h.end)+"px";for(j in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(j)){if(j>=h.start&&j<=h.end){n(this.timeLinesIndex[j])}else{this.timeLinesIndex[j].style.display="block";p(this.timeLinesIndex[j])}this.timeLinesIndex[j].style.top=(j*this.gridLineHeight)+"px"}}if(f&&this.savedScrollTop){this.scrollTopInterval=setTimeout(o,5)}}else{this.gridRow.style.height=(this.gridLineHeight*(h.end-h.start))+30+"px";this.topOffHours.style.height=k+"px";this.bottomOffHours.style.height=(this.gridLineHeight*(24-h.end))+1+"px";this.bottomOffHours.style.top=(this.gridLineHeight*h.end)+"px";for(j in this.timeLinesIndex){if(this.timeLinesIndex.hasOwnProperty(j)){if((j<=h.start||j>=h.end)){q=this.timeLinesIndex[j];this.timeLinesIndex[j].style.opacity=0;n(this.timeLinesIndex[j])}else{p(this.timeLinesIndex[j])}if(j>=h.end){this.timeLinesIndex[j].style.top=((h.end-h.start)*this.gridLineHeight)+"px"}else{this.timeLinesIndex[j].style.top=((j-h.start)*this.gridLineHeight)+"px"}}}this.bottomOffHours.style.height=k+"px";this.bottomOffHours.style.top=((h.end-h.start)*this.gridLineHeight)+9+"px";this.savedScrollTop=parseInt(this.gridWrap.scrollTop)}this.collapseOffHours=!this.collapseOffHours;BX.toggleClass(this.topOffHours,[this.offHoursCollapseClass,this.offHoursClass]);BX.toggleClass(this.bottomOffHours,[this.offHoursCollapseClass,this.offHoursClass]);this.util.setUserOption("collapseOffHours",this.collapseOffHours?"Y":"N");this.updateGridRowShadowHeight()};d.prototype.checkTimelineScroll=function(g){var f=g?this.util.getScrollbarWidth():0;if(this.titleCont){this.titleCont.style.paddingRight=f+"px"}if(this.fullDayEventsHolderCont&&this.topEntryHolder){new BX.easing({duration:100,start:{width:f,paddingRight:0},finish:{width:0,paddingRight:f},transition:BX.easing.makeEaseOut(BX.easing.transitions.linear),step:BX.delegate(function(h){this.gridWrap.style.width="calc(100% + "+h.width+"px)";this.topEntryHolder.style.right=h.paddingRight+"px";this.fullDayEventsHolderCont.style.paddingRight=h.paddingRight+"px"},this),complete:function(){}}).animate()}};d.prototype.getDayGridHeight=function(){return 1040};d.prototype.updateGridRowShadowHeight=function(){if(this.collapseOffHours){this.gridRowShadow.style.height=(parseInt(this.gridRow.style.height)-38)+"px";BX.removeClass(this.gridRowShadow,"calendar-grid-week-row-shadow-off-hours")}else{this.gridRowShadow.style.height=(parseInt(this.gridRow.style.height)-40)+"px";BX.addClass(this.gridRowShadow,"calendar-grid-week-row-shadow-off-hours")}};d.prototype.handleClick=function(h){if(this.isActive()){if(!h){h={}}var f,g;if(h.specialTarget&&(g=h.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:g,specialTarget:h.specialTarget,target:h.target,e:h.e})}else{if(h.specialTarget&&(f=h.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){this.deselectEntry();if(this.dayIndex[f]!==undefined&&this.days[this.dayIndex[f]]){this.showAllEventsInPopup({day:this.days[this.dayIndex[f]],entrieList:this.days[this.dayIndex[f]].entries.topList})}}else{if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(f=h.specialTarget&&h.specialTarget.getAttribute("data-bx-calendar-week-day"))){this.deselectEntry();this.showCompactEditFormForNewEntry({entry:this.buildTopNewEntryWrap({dayFrom:this.days[this.dayIndex[f]],holder:this.topEntryHolder})})}}}}};d.prototype.handleMousedown=function(k){if(!this.isActive()){return}var h=BX.Calendar.EntryManager.getCompactViewForm(false);if(h&&h.isShown()){return}var i,j=this.calendar.util.findTargetNode(k.target||k.srcElement);if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")&&(i=j&&j.getAttribute("data-bx-calendar-timeline-day"))){BX.unbind(document,"mousemove",BX.proxy(this.handleMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.handleMouseup,this));BX.bind(document,"mousemove",BX.proxy(this.handleMousemove,this));BX.bind(document,"mouseup",BX.proxy(this.handleMouseup,this));BX.addCustomEvent(this.calendar,"keyup",BX.proxy(this.checkKeyup,this));this.createEntryMode=true;this.offtimeTuneBaseZeroPos=BX.pos(this.timeLinesCont).top;this.offtimeBottomBasePos=BX.pos(this.bottomOffHours).bottom-2;this.startMousePos=Math.max(this.offtimeTuneBaseZeroPos+this.gridWrap.scrollTop,this.calendar.util.getMousePos(k).y);this.newEntry=this.buildTimelineNewEntryWrap({dayFrom:this.days[this.dayIndex[i]],holder:this.timelineEntryHolder});this.newEntry.dayFrom=this.days[this.dayIndex[i]];this.newEntry.timeFrom=this.getTimeByPos(this.startMousePos-this.offtimeTuneBaseZeroPos,30,true);var g=this.util.getWorkTime(),f=this.newEntry.timeFrom.h+this.newEntry.timeFrom.m/60;if(this.collapseOffHours){f=Math.max(f,g.start);this.startMousePos=this.offtimeTuneBaseZeroPos+((f-g.start)*this.gridLineHeight+1)}else{this.startMousePos=this.offtimeTuneBaseZeroPos+(f*this.gridLineHeight+1)}if(this.newEntry.timeFrom.h==23){this.newEntry.timeTo={h:23,m:59}}else{this.newEntry.timeTo={h:this.newEntry.timeFrom.h+1,m:this.newEntry.timeFrom.m}}this.newEntry.changeTimeCallback(this.newEntry.timeFrom,this.newEntry.timeTo);this.newEntry.entryNode.style.top=this.startMousePos+"px"}};d.prototype.handleMousemove=function(h){if(this.createEntryMode){var g=this.calendar.util.getMousePos(h).y,f=Math.min(Math.max(g-this.startMousePos,10),this.offtimeBottomBasePos-parseInt(this.newEntry.entryNode.style.top));this.newEntry.entryNode.style.height=f+"px";this.newEntry.timeTo=this.getTimeByPos(f+this.startMousePos-this.offtimeTuneBaseZeroPos);this.newEntry.changeTimeCallback(this.newEntry.timeFrom,this.newEntry.timeTo)}};d.prototype.handleMouseup=function(h){BX.unbind(document,"mousemove",BX.proxy(this.offHoursMousemove,this));BX.unbind(document,"mouseup",BX.proxy(this.offHoursMouseup,this));BX.removeCustomEvent(this.calendar,"keyup",BX.proxy(this.checkKeyup,this));if(this.createEntryMode){var g=new Date(this.newEntry.dayFrom.date.getTime()),f=new Date(this.newEntry.dayFrom.date.getTime());g.setHours(this.newEntry.timeFrom.h,this.newEntry.timeFrom.m,0,0);f.setHours(this.newEntry.timeTo.h,this.newEntry.timeTo.m,0,0);this.deselectEntry();this.showCompactEditFormForNewEntry({entry:this.newEntry,entryTime:{from:g,to:f}});this.createEntryMode=false}};d.prototype.checkKeyup=function(g){var f=this.util.getKeyCodes();if(g.keyCode===f.escape&&this.createEntryMode&&this.newEntry){BX.remove(this.newEntry.entryNode);this.createEntryMode=false;this.handleMouseup()}};d.prototype.buildTopNewEntryWrap=function(w){var p=this,s,m,k,n,v,g="calendar-event-line-wrap",h=0,o=w.dayFrom,q,u,l=1,j=this.calendar.sectionController.getCurrentSection(),r=j.color;s=this.entryController.getTimeForNewEntry(o.date);m=this.entryController.getDefaultEntryName();k=w.holder.appendChild(BX.create("DIV",{props:{className:g},style:{top:0,left:this.dayCount>1?"calc((100% / "+this.dayCount+") * ("+(o.dayOffset+1)+" - 1) + 2px)":"2px",width:"calc("+l+" * 100% / "+this.dayCount+" - "+h+"px)"}}));v=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));n=v.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));n.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(s.from.getHours(),s.from.getMinutes())}));n.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},text:m}));k.style.backgroundColor=r;k.style.borderColor=r;k.style.opacity=0;var i=BX.pos(k);var t=BX.adjust(document.body.appendChild(k.cloneNode(true)),{props:{className:"calendar-event-line-clone"},style:{width:(i.width+1)+"px",height:i.height+"px",top:i.top+"px",left:i.left+"px",opacity:1}});if(k){BX.remove(k,true)}u=t.querySelector(".calendar-event-line-text");q=t.querySelector(".calendar-event-line-time");n=t.querySelector(".calendar-event-line-inner");var f={entryNode:t,innerNode:n,section:j,entryName:m,entryTime:s,changeTimeCallback:function(y,x){if(y.getHours&&x.getHours){q.innerHTML=p.calendar.util.formatTime(y.getHours(),y.getMinutes())}else{q.innerHTML=p.calendar.util.formatTime(y.h,y.m)}},changeNameCallback:function(x){u.innerHTML=BX.util.htmlspecialchars(x)}};this.selectEntryPart(f,r,false);return f};d.prototype.buildTimelineNewEntryWrap=function(w){var p=this,s,m,k,n,g="calendar-event-block-wrap",o=w.dayFrom,l,h,q,v,t,j=this.calendar.sectionController.getCurrentSection(),r=j.color;s=this.entryController.getTimeForNewEntry(o.date);m=this.entryController.getDefaultEntryName();k=w.holder.appendChild(BX.create("DIV",{props:{className:g},style:{height:this.gridLineHeight+"px",minHeight:"20px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+o.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}}));n=k.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"}}));l=n.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-background"}}));h=this.calendar.util.formatTime(s.from.getHours(),s.from.getMinutes())+" &ndash; "+this.calendar.util.formatTime(s.to.getHours(),s.to.getMinutes());n.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-text"},style:{color:"#fff"},text:m}));n.appendChild(BX.create("SPAN",{props:{className:"calendar-event-block-time"},style:{color:"#fff"},html:h}));l.style.backgroundColor=r;var i=BX.pos(k);var u=BX.adjust(document.body.appendChild(k.cloneNode(true)),{props:{className:"calendar-event-line-clone calendar-event-block-wrap active"},style:{width:(i.width+1)+"px",height:i.height+"px",top:i.top+"px",left:i.left+"px",opacity:1}});if(k){BX.remove(k,true)}v=u.querySelector(".calendar-event-block-text");q=u.querySelector(".calendar-event-block-time");n=u.querySelector(".calendar-event-block-inner");l=u.querySelector(".calendar-event-block-background");t=u.appendChild(BX.create("DIV",{props:{className:"calendar-event-bind-node"}}));if(this.dayCount===1){t.style.right="10%"}else{t.style.left="0"}var f={entryNode:u,innerNode:n,section:j,entryName:m,bindNode:t,blockBackgroundNode:l,changeTimeCallback:function(z,y){var x;if(z.getHours&&y.getHours){x=p.calendar.util.formatTime(z.getHours(),z.getMinutes())+" &ndash; "+p.calendar.util.formatTime(y.getHours(),y.getMinutes())}else{x=p.calendar.util.formatTime(z.h,z.m)+" &ndash; "+p.calendar.util.formatTime(y.h,y.m)}q.innerHTML=x},changeNameCallback:function(x){v.innerHTML=BX.util.htmlspecialchars(x)}};this.selectEntryPart(f,r,false);return f};d.prototype.showCompactEditFormForNewEntry=function(f){this.showCompactEditForm({entryNode:f.entry.entryNode,bindNode:f.entry.bindNode,section:f.entry.section,entryTime:f.entryTime||f.entry.entryTime,entryName:f.entry.entryName,changeTimeCallback:f.entry.changeTimeCallback,changeNameCallback:f.entry.changeNameCallback,closeCallback:BX.delegate(function(){BX.remove(f.entry.entryNode)},this)});BX.Event.EventEmitter.unsubscribeAll("BX.Calendar.CompactEventForm:onChange");BX.Event.EventEmitter.subscribe("BX.Calendar.CompactEventForm:onChange",function(g){if(g instanceof BX.Event.BaseEvent){var i=g.getData();var h=i.form.dateTimeControl.getValue()}}.bind(this))};d.prototype.showAllEventsInPopup=function(k){var f=k.entrieList||k.day.entries.list,j,g;j=BX.create("DIV",{props:{className:"calendar-all-events-popup calendar-custom-scroll"},events:{click:BX.proxy(this.calendar.handleViewsClick,this.calendar)}});f.sort(this.calendar.entryController.sort);var h,i;f.forEach(function(l){if(l.entry){if(l.entry.isTask()){if(!h){j.appendChild(BX.create("DIV",{props:{className:"calendar-event-title"},text:BX.message("EC_ENTRIES_TASKS")}));h=j.appendChild(BX.create("DIV",{props:{className:"calendar-event-block"}}))}this.displayTopEntry({entry:l.entry,part:l.part,holder:h,popupMode:true})}else{if(!i){j.appendChild(BX.create("DIV",{props:{className:"calendar-event-title"},text:BX.message("EC_ENTRIES_EVENTS")}));i=j.appendChild(BX.create("DIV",{props:{className:"calendar-event-block"}}))}this.displayTopEntry({entry:l.entry,part:l.part,holder:i,popupMode:true})}}},this);g=BX.PopupWindowManager.create(this.calendar.id+"-all-events-popup",k.day.hiddenStorageText,{autoHide:true,closeByEsc:true,offsetTop:-2,offsetLeft:-50,lightShadow:true,content:j});g.setAngle({offset:118});g.show(true);this.allEventsPopup=g;BX.addCustomEvent(g,"onPopupClose",function(){g.destroy()})};function a(){e.apply(this,arguments);this.initConfig();this.preBuild()}a.prototype=Object.create(d.prototype);a.prototype.constructor=a;a.prototype.show=function(){e.prototype.show.apply(this,arguments);this.buildDaysGrid();if(this.calendar.navCalendar){this.calendar.navCalendar.hide()}this.displayEntries();this.calendar.initialViewShow=false};a.prototype.initConfig=function(){d.prototype.initConfig.apply(this,arguments);this.name="week";this.title=BX.message("EC_VIEW_WEEK");this.contClassName="calendar-week-view";this.hotkey="W";this.gridWrapClass="calendar-grid-wrap";this.fullDayContClass="calendar-grid-week-full-days-events-holder";this.outerGridClass="calendar-grid-week-container";this.gridClass="calendar-grid-week";this.gridClassCurrent="calendar-grid-week-current";this.gridClassNext="calendar-grid-week-left-slide";this.gridClassPrevious="calendar-grid-week-right-slide";this.changeNextClass="calendar-change-week-left-slide";this.changePreviousClass="calendar-change-week-right-slide";this.gridRowClass="calendar-grid-week-row";this.gridCellClass="calendar-grid-week-cell";this.gridTimelinesClass="calendar-grid-week-time-lines";this.gridTimelineHourClass="calendar-grid-week-time-line-hour";this.gridTimelineHourLabelClass="calendar-grid-week-time-line-hour-label";this.topEntryHolderClass="calendar-grid-week-events-holder";this.gridNowTimeClass="calendar-grid-week-time-line-hour-now";this.gridNowTimeLabelClass="calendar-grid-week-time-line-hour-label";this.gridNowTimeLineClass="calendar-grid-week-time-line-hour-now-line";this.gridNowTimeDotClass="calendar-grid-week-time-line-hour-now-dot";this.dayCount=7};a.prototype.setTitle=function(){var f=this.calendar.getViewRangeDate(),h=f.getTime(),g=new Date(f.getTime()+this.dayCount*this.calendar.util.dayLength);if(f.getMonth()!==g.getMonth()){e.prototype.setTitle.apply(this,[BX.date.format("f",h/1000)+" - "+BX.date.format("f",g.getTime()/1000)+(this.util.showWeekNumber()?", #GRAY_START#"+BX.message("EC_DATE_WEEK_NUMBER").replace("#WEEK_NUMBER#",this.util.getWeekNumber(h))+"#GRAY_END#":"")])}else{e.prototype.setTitle.apply(this,[BX.date.format("f",h/1000)+(this.util.showWeekNumber()?", #GRAY_START#"+BX.message("EC_DATE_WEEK_NUMBER").replace("#WEEK_NUMBER#",this.util.getWeekNumber(h))+"#GRAY_END#":"")])}};a.prototype.getAdjustedDate=function(h,g,f){if(!h){h=new Date()}if(g&&h.getTime()<g.start.getTime()){h=new Date(g.start.getTime())}if(g&&h.getTime()>g.end.getTime()){h=new Date(g.end.getTime())}var i=this.util.getWeekStart();while(this.util.getWeekDayByInd(h.getDay())!=i){h.setDate(h.getDate()-1)}if(f){g.start.setDate(h.getTime());g.end.setDate(h.getTime()+this.calendar.util.dayLength*this.dayCount)}return d.prototype.getAdjustedDate.apply(this,[h,g])};a.prototype.adjustViewRangeToDate=function(f){var g=this.util.getWeekStart();while(this.util.getWeekDayByInd(f.getDay())!=g){f.setDate(f.getDate()-1)}return d.prototype.adjustViewRangeToDate.apply(this,[f])};if(b.BXEventCalendar){b.BXEventCalendar.CalendarDayView=d;b.BXEventCalendar.CalendarWeekView=a}else{BX.addCustomEvent(b,"onBXEventCalendarInit",function(){b.BXEventCalendar.CalendarDayView=d;b.BXEventCalendar.CalendarWeekView=a})}function c(f){this.position=f.position;this.outerWrap=f.wrap;this.workTime=f.workTime;this.dayOffset=f.dayOffset;this.dayCount=f.dayCount;this.lastEntryWidthOffset=f.lastEntryWidthOffset;this.gridLineHeight=f.gridLineHeight;this.labelMessage=f.labelMessage;this.clickHandler=f.clickHandler;this.mouseoutHandler=f.mouseoutHandler;this.mouseoverHandler=f.mouseoverHandler;this.isInited=false;this.entryCount=0;this.create()}c.prototype={create:function(){this.wrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-event-block-wrap calendar-event-block-wrap-more"},style:{top:(this.position==="bottom")?((this.workTime.end-this.workTime.start)*this.gridLineHeight)+"px":"-9px",left:this.dayCount>1?"calc((100% / "+this.dayCount+") * "+this.dayOffset+" + 2px)":"2px",width:"calc(100% / "+this.dayCount+" - "+this.lastEntryWidthOffset+"px)"}})).appendChild(BX.create("DIV",{props:{className:"calendar-event-block-inner"},html:'<div class="calendar-event-block-background" style="background-color: #808080;"></div>'}));if(BX.type.isFunction(this.clickHandler)){BX.bind(this.wrap,"click",this.clickHandler)}if(BX.type.isFunction(this.mouseoverHandler)){BX.bind(this.wrap,"mouseover",this.mouseoverHandler)}if(BX.type.isFunction(this.mouseoutHandler)){BX.bind(this.wrap,"mouseout",this.mouseoutHandler)}this.countContainer=this.wrap.appendChild(BX.create("span",{props:{className:"calendar-event-block-text"},html:'<span class="calendar-event-block-text-subtitle">'+this.labelMessage+"</span>"})).appendChild(BX.create("span",{props:{className:"calendar-event-block-text-total"}}));this.isInited=true},inited:function(){return this.isInited&&BX.isNodeInDom(this.wrap)},destroy:function(){BX.remove(this.wrap);this.isInited=false},addEntry:function(f){this.entryCount++;this.countContainer.innerHTML=this.entryCount}}})(window);