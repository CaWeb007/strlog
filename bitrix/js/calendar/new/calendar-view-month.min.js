(function(a){var b=a.BXEventCalendarView;function c(){b.apply(this,arguments);this.name="month";this.title=BX.message("EC_VIEW_MONTH");this.contClassName="calendar-month-view";this.dayCount=7;this.slotHeight=20;this.eventHolderTopOffset=25;this.hotkey="M";this.preBuild()}c.prototype=Object.create(b.prototype);c.prototype.constructor=c;c.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}})};c.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row-days-week"}}));this.gridWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-wrap"}}));this.gridMonthContainer=this.gridWrap.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-container"}}));this.grid=this.gridMonthContainer.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-current"}}))};c.prototype.show=function(){b.prototype.show.apply(this,arguments);this.buildDaysTitle();this.buildDaysGrid();if(this.calendar.navCalendar){this.calendar.navCalendar.hide()}this.displayEntries();this.calendar.initialViewShow=false};c.prototype.hide=function(){b.prototype.hide.apply(this,arguments)};c.prototype.increaseViewRangeDate=function(){this.changeViewRangeDate(1);var d=this.gridMonthContainer.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-next "+this.animateClass}}));BX.addClass(this.grid,this.animateClass);this.setTitle();this.buildDaysGrid({grid:d});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.gridMonthContainer,"calendar-change-month-next");setTimeout(BX.delegate(function(){BX.removeClass(this.gridMonthContainer,"calendar-change-month-next");BX.removeClass(d,"calendar-grid-month-next");BX.addClass(d,"calendar-grid-month-current");BX.remove(this.grid);this.grid=d;BX.removeClass(this.grid,this.animateClass);this.displayEntries()},this),400)},this),0)};c.prototype.decreaseViewRangeDate=function(){this.changeViewRangeDate(-1);var d=this.gridMonthContainer.insertBefore(BX.create("DIV",{props:{className:"calendar-grid-month calendar-grid-month-previous "+this.animateClass}}),this.grid);BX.addClass(this.grid,this.animateClass);this.setTitle();this.buildDaysGrid({grid:d});this.preloadEntries();setTimeout(BX.delegate(function(){BX.addClass(this.gridMonthContainer,"calendar-change-month-previous");setTimeout(BX.delegate(function(){BX.removeClass(this.gridMonthContainer,"calendar-change-month-previous");BX.removeClass(d,"calendar-grid-month-previous");BX.addClass(d,"calendar-grid-month-current");BX.remove(this.grid);this.grid=d;BX.removeClass(this.grid,this.animateClass);this.displayEntries()},this),400)},this),0)};c.prototype.getViewRange=function(){var d=this.calendar.getViewRangeDate(),e=new Date(d.getTime());e.setMonth(d.getMonth()+1);return{start:d,end:e}};c.prototype.changeViewRangeDate=function(f){var e=this.calendar.getViewRangeDate(),d=new Date(e.getTime());d.setMonth(d.getMonth()+f);this.calendar.setViewRangeDate(d);return d};c.prototype.adjustViewRangeToDate=function(d){var e=this.calendar.getViewRangeDate(),f=false;var g=d.getMonth()-e.getMonth();if(g==1){this.increaseViewRangeDate()}else{if(g==-1){this.decreaseViewRangeDate()}else{if(d&&d.getTime){f=new Date(d.getTime());f.setDate(1);f.setHours(0,0,0,0);this.calendar.setViewRangeDate(f)}this.fadeAnimation(this.getContainer(),100,BX.delegate(function(){this.show();this.getContainer().style.opacity=0;this.showAnimation(this.getContainer(),300)},this))}}return f};c.prototype.getAdjustedDate=function(e,d){if(!e){e=new Date()}if(e.getTime()<d.start.getTime()){e=new Date(d.start.getTime())}if(e.getTime()>d.end.getTime()){e=new Date(d.end.getTime())}var f=false;if(e&&e.getTime){f=new Date(e.getTime());f.setDate(1);f.setHours(0,0,0,0)}return f};c.prototype.buildDaysTitle=function(){BX.cleanNode(this.titleCont);var e,d,f=this.util.getWeekDays();for(e=0;e<f.length;e++){d=f[e];this.titleCont.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-cell"},html:'<span class="calendar-grid-cell-inner">'+BX.message("EC_MONTH_WEEK_TITLE").replace("#DAY_OF_WEEK#",d[1])+"</span>"}))}};c.prototype.buildDaysGrid=function(f){if(!f){f={}}var g,n,d=f.grid||this.grid,l=this.calendar.getViewRangeDate(),k=l.getFullYear(),j=l.getMonth(),m=this.util.getViewHeight(),h=BX.clone(this.getViewRange(),true),e=new Date();BX.cleanNode(d);e.setFullYear(k,j,1);this.dayIndex={};this.days=[];this.entryHolders=[];this.currentMonthRow=false;this.monthRows=[];if(this.util.getWeekStart()!=this.util.getWeekDayByInd(e.getDay())){n=this.util.getWeekDayOffset(this.util.getWeekDayByInd(e.getDay()));e.setDate(e.getDate()-n);h.start=new Date(e.getTime());h.start.setHours(0,0,0,0);for(g=0;g<n;g++){this.buildDayCell({date:e,month:"previous",grid:d});e.setDate(e.getDate()+1)}}e.setFullYear(k,j,1);while(e.getMonth()==j){this.buildDayCell({date:e,grid:d});e.setDate(e.getDate()+1)}if(this.util.getWeekStart()!=this.util.getWeekDayByInd(e.getDay())){n=this.util.getWeekDayOffset(this.util.getWeekDayByInd(e.getDay()));e.setFullYear(k,j+1,1);for(g=n;g<7;g++){this.buildDayCell({date:e,month:"next",grid:d});e.setDate(e.getDate()+1)}h.end=new Date(e.getTime());h.end.setHours(23,59,59,59)}this.calendar.setDisplayedViewRange(h);if(this.monthRows.length>0){this.rowHeight=Math.round(m/this.monthRows.length);this.slotsCount=Math.floor((this.rowHeight-this.eventHolderTopOffset)/this.slotHeight);for(g=0;g<this.monthRows.length;g++){this.monthRows[g].style.height=this.rowHeight+"px"}}};c.prototype.buildDayCell=function(h){var g=h.date,j="",f=Math.round(g.getTime()/1000)*1000,k=g.getDay(),l=this.util.getDayCode(g),i=this.util.getWeekDayByInd(k),d=false,e=this.util.getWeekStart()==i;if(e){this.currentMonthRow=h.grid.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-row"}}));this.monthRows.push(this.currentMonthRow);if(this.util.showWeekNumber()){d=this.util.getWeekNumber(f)}}if(h.month==="previous"){j+=" calendar-grid-previous-month-day"}else{if(h.month==="next"){j+=" calendar-grid-next-month-day"}}if(this.util.isHoliday(g)){j+=" calendar-grid-holiday"}if(this.util.isToday(g)){j+=" calendar-grid-today"}this.days.push({date:new Date(g.getTime()),dayOffset:this.util.getWeekDayOffset(i),rowIndex:this.monthRows.length-1,holderIndex:this.entryHolders.length,node:this.currentMonthRow.appendChild(BX.create("DIV",{props:{className:BX.util.trim("calendar-grid-month-cell"+j)},attrs:{"data-bx-calendar-month-day":l},html:'<span class="calendar-grid-cell-inner"><span class="calendar-num-day" data-bx-calendar-date="'+f+'">'+(g.getDate()==1?BX.message("EC_MONTH_SHORT").replace("#MONTH#",BX.date.format("M",f/1000)).replace("#DATE#",g.getDate()):g.getDate())+"</span>"+(d?'<span class="calendar-num-week"  data-bx-cal-time="'+f+'" data-bx-calendar-weeknumber="'+d+'">'+d+"</span>":"")+"</span>"})),dayCode:l});this.dayIndex[this.days[this.days.length-1].dayCode]=this.days.length-1;this.calendar.dragDrop.registerDay(this.days[this.days.length-1]);if(this.currentMonthRow&&this.util.getWeekEnd()===i){this.entryHolders.push(this.currentMonthRow.appendChild(BX.create("DIV",{props:{className:"calendar-grid-month-events-holder"}})))}};c.prototype.setTitle=function(){var d=this.calendar.getViewRangeDate();b.prototype.setTitle.apply(this,[BX.date.format("f",d.getTime()/1000)+", #GRAY_START#"+d.getFullYear()+"#GRAY_END#"])};c.prototype.displayEntries=function(g){var t,k,l,h,s,f,n,p,o,d,e=[],m,r,q=this.calendar.getDisplayedViewRange();if(!g){g={}}if(g.reloadEntries!==false){this.entries=this.entryController.getList({startDate:new Date(q.start.getFullYear(),q.start.getMonth(),1),finishDate:new Date(q.end.getFullYear(),q.end.getMonth()+1,1),viewRange:q,finishCallback:BX.proxy(this.displayEntries,this)})}this.entryHolders.forEach(function(i){BX.cleanNode(i)});this.days.forEach(function(i){i.slots=[];i.entries={list:[],started:[],hidden:[]}});if(this.entries===false||!this.entries||!this.entries.length){return}for(l=0;l<this.entries.length;l++){s=this.entries[l];this.entriesIndex[s.uid]=l;s.cleanParts();d=false;for(n=this.dayIndex[s.startDayCode];n<this.days.length;n++){o=this.days[n];if(o.dayCode===s.startDayCode||d&&o.dayOffset===0){d=true;f=s.startPart({from:o,daysCount:0});o.entries.started.push({entry:s,part:f})}if(d){o.entries.list.push({entry:s,part:f});f.daysCount++;f.to=o;if(o.dayCode===s.endDayCode||o.dayOffset===this.dayCount-1){e.push({part:f,entry:s});if(o.dayCode===s.endDayCode){break}}}}}for(l=0;l<e.length;l++){this.displayEntryPiece(e[l])}for(n=0;n<this.days.length;n++){o=this.days[n];if(o.entries.started.length>0){if(o.entries.started.length>0){o.entries.started.sort(this.calendar.entryController.sort)}for(l=0;l<o.entries.started.length;l++){k=o.entries.started[l];if(k){s=k.entry;p=k.part;m=false;for(h=0;h<this.slotsCount;h++){if(o.slots[h]!==false){this.occupySlot({slotIndex:h,startIndex:n,endIndex:n+p.daysCount});m=true;s.getWrap(p.partIndex).style.top=(h*this.slotHeight)+"px";break}}if(!m){t=o.entries.started[l-1];if(t){o.entries.hidden.push(t);t.entry.getWrap(t.part.partIndex).style.display="none"}o.entries.hidden.push(k);s.getWrap(p.partIndex).style.display="none"}}}}if(o.entries.list.length>0){r=false;for(l=0;l<o.entries.list.length;l++){if(o.entries.list[l].part.params.wrapNode.style.display==="none"){r=true;break}}if(r){o.hiddenStorage=this.entryHolders[o.holderIndex].appendChild(BX.create("DIV",{props:{className:"calendar-event-line-wrap calendar-event-more-btn-container"},attrs:{"data-bx-calendar-show-all-events":o.dayCode},style:{top:(this.rowHeight-47)+"px",left:"calc((100% / "+this.dayCount+") * ("+(o.dayOffset+1)+" - 1) + 2px)",width:"calc(100% / "+this.dayCount+" - 3px)"}}));o.hiddenStorageText=o.hiddenStorage.appendChild(BX.create("span",{props:{className:"calendar-event-more-btn"}}));o.hiddenStorage.style.display="block";o.hiddenStorageText.innerHTML=BX.message("EC_SHOW_ALL")+" "+o.entries.list.length}else{if(o.hiddenStorage){o.hiddenStorage.style.display="none"}}}}BX.addClass(this.gridMonthContainer,"calendar-events-holder-show")};c.prototype.displayEntryPiece=function(h){var l=false,q=h.entry,p=h.part.from,g=h.part.daysCount,r,o,s,d,k,f,i,t="calendar-event-line-wrap",j=0,e,n,m=h.holder||this.entryHolders[p.holderIndex];if(m){if(q.isFullDay()){t+=" calendar-event-line-fill"}else{if(q.isLongWithTime()){t+=" calendar-event-line-border"}}if(q.isExpired()){t+=" calendar-event-line-past"}if(!h.popupMode&&this.util.getDayCode(q.from)!==this.util.getDayCode(p.date)){t+=" calendar-event-line-start-yesterday";j+=8;e=this.getArrow("left",q.color,q.isFullDay())}if(!h.popupMode&&this.util.getDayCode(q.to)!==this.util.getDayCode(h.part.to.date)){t+=" calendar-event-line-finish-tomorrow";n=this.getArrow("right",q.color,q.isFullDay());j+=12}if(e&&!n){j+=4}if(j==0){j=5}r=BX.create("DIV",{attrs:{"data-bx-calendar-entry":q.uid},props:{className:t},style:{top:0,left:"calc((100% / "+this.dayCount+") * ("+(p.dayOffset+1)+" - 1) + 2px)",width:"calc("+g+" * 100% / "+this.dayCount+" - "+j+"px)"}});if(e){r.appendChild(e);r.style.left="9px"}if(n){r.appendChild(n)}i=r.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));s=i.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));o=s.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-dot"}}));if(q.isFullDay()){s.style.maxWidth="calc(200% / "+g+" - 3px)"}else{if(q.isLongWithTime()){r.style.borderColor=q.color;s.style.maxWidth="calc(200% / "+g+" - 3px)";if(h.part.partIndex==0){k=s.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(q.from.getHours(),q.from.getMinutes())}));s.style.width="calc(100% / "+g+" - 3px)"}if(h.part.partIndex==q.parts.length-1){if(g>1&&q.parts.length>1){s.style.width="calc("+(g-1)+"00% / "+g+" - 3px)"}if(!h.popupMode){f=s.appendChild(BX.create("SPAN",{props:{className:(q.parts.length>1&&g==1)?"calendar-event-line-time":"calendar-event-line-expired-time"},text:this.calendar.util.formatTime(q.to.getHours(),q.to.getMinutes())}))}}}else{k=s.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},text:this.calendar.util.formatTime(q.from.getHours(),q.from.getMinutes())}))}}d=s.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"}})).appendChild(BX.create("SPAN",{text:h.entry.name}));if(q.isFullDay()){i.style.backgroundColor=this.calendar.util.hexToRgba(q.color,0.3);i.style.borderColor=this.calendar.util.hexToRgba(q.color,0.3)}else{if(q.isLongWithTime()){i.style.borderColor=this.calendar.util.hexToRgba(q.color,0.5)}o.style.backgroundColor=q.color}m.appendChild(r);if(q.opacity!==undefined){r.style.opacity=q.opacity}l={wrapNode:r,nameNode:d,innerContainer:i,innerNode:s,timeNode:k||false,endTimeNode:f||false,dotNode:o};if(!h.popupMode){h.entry.registerPartNode(h.part,l)}this.calendar.dragDrop.registerEntry(r,h)}return l};c.prototype.refreshEventsOnWeek=function(e){var u=e*7,f=(e+1)*7,s,m,h,g,l,r,q,p,o=[],n=5,d=0;for(l=0;l<n;l++){o[l]=0}for(m=u;m<f;m++){s=this.activeDateObjDays[m];if(!s){continue}s.arEvents.hidden=[];g=s.arEvents.begining;p=[];if(g.length>0){g.sort(function(j,i){if(i.daysCount==j.daysCount&&j.daysCount==1){return j.oEvent.DT_FROM_TS-i.oEvent.DT_FROM_TS}return i.daysCount-j.daysCount});eventloop:for(h=0;h<g.length;h++){r=g[h];if(!r){continue}if(!this.arEvents[r.oEvent.ind]){s.arEvents.begining=g=BX.util.deleteFromArray(g,h);r=g[h];if(!r){continue}}for(l=0;l<this.maxEventCount;l++){if(o[l]-d<=0){o[l]=d+r.daysCount;this.ShowEventOnLevel(r.oEvent.oParts[r.partInd],l,e);continue eventloop}}p[r.oEvent.ID]=true;s.arEvents.hidden.push(r)}}q=s.arEvents.all;for(var t=0;t<q.length;t++){r=q[t];if(!r||p[r.oEvent.ID]){continue}if(!this.arEvents[r.oEvent.ind]){s.arEvents.all=q=BX.util.deleteFromArray(q,t);r=q[t];if(!r){continue}}if(r.oEvent.oParts&&r.partInd!=undefined&&r.oEvent.oParts[r.partInd]&&r.oEvent.oParts[r.partInd].style.display=="none"){s.arEvents.hidden.push(r)}}d++}};c.prototype.handleClick=function(f){if(this.isActive()){if(!f){f={}}var d,e;if(f.specialTarget&&(e=f.specialTarget.getAttribute("data-bx-calendar-entry"))){this.handleEntryClick({uid:e,specialTarget:f.specialTarget,target:f.target,e:f.e})}else{if(f.specialTarget&&(d=f.specialTarget.getAttribute("data-bx-calendar-show-all-events"))){this.deselectEntry();if(this.dayIndex[d]!==undefined&&this.days[this.dayIndex[d]]){this.showAllEventsInPopup({day:this.days[this.dayIndex[d]]})}}else{if(!this.calendar.util.readOnlyMode()&&this.entryController.canDo(false,"add_event")&&(d=f.specialTarget&&f.specialTarget.getAttribute("data-bx-calendar-month-day"))){this.deselectEntry();if(this.dayIndex[d]!==undefined&&this.days[this.dayIndex[d]]){this.showNewEntryWrap({dayFrom:this.days[this.dayIndex[d]]})}}}}}};c.prototype.showNewEntryWrap=function(g){var q,j,p,r,h,s="calendar-event-line-wrap",i=0,o=g.dayFrom,e=1,l=this.entryHolders[o.holderIndex],n=this.calendar.sectionController.getCurrentSection(),f=n.color;var d=BX.Calendar.EntryManager.getCompactViewForm(false);if(d&&d.isShown()){return}q=this.entryController.getTimeForNewEntry(o.date);j=this.entryController.getDefaultEntryName();p=BX.create("DIV",{props:{className:s},style:{opacity:0,top:0,left:"calc((100% / "+this.dayCount+") * ("+(o.dayOffset+1)+" - 1) + 2px)",width:"calc("+e+" * 100% / "+this.dayCount+" - "+i+"px)"}});h=p.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner-container"}}));r=h.appendChild(BX.create("DIV",{props:{className:"calendar-event-line-inner"}}));r.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-time"},style:{color:"#fff"},text:this.calendar.util.formatTime(q.from.getHours(),q.from.getMinutes())}));r.appendChild(BX.create("SPAN",{props:{className:"calendar-event-line-text"},style:{color:"#fff"},text:j}));p.style.backgroundColor=f;p.style.borderColor=f;l.appendChild(p);var k=BX.pos(p);var m=BX.adjust(document.body.appendChild(p.cloneNode(true)),{props:{className:"calendar-event-line-clone"},style:{width:(k.width-6)+"px",height:k.height+"px",top:k.top+"px",left:(k.left+1)+"px"}});BX.addClass(l,"shifted");l.style.height=(this.slotsCount-1)*this.slotHeight+"px";setTimeout(function(){m.style.opacity="1"},100);setTimeout(BX.delegate(function(){this.showCompactEditForm({entryTime:q,entryName:j,nameNode:m.querySelector(".calendar-event-line-text"),timeNode:m.querySelector(".calendar-event-line-time"),entryNode:m,section:n,closeCallback:function(){BX.cleanNode(m,true);BX.cleanNode(p,true);BX.removeClass(l,"shifted");l.style.height="1px"}});BX.Event.EventEmitter.unsubscribeAll("BX.Calendar.CompactEventForm:onChange");BX.Event.EventEmitter.subscribe("BX.Calendar.CompactEventForm:onChange",function(v){if(v instanceof BX.Event.BaseEvent){var y=v.getData();var x=y.form.dateTimeControl.getValue();var u=this.util.getDayCode(x.from);if(u&&this.dayIndex[u]!==undefined&&this.days[this.dayIndex[u]]){var w=this.days[this.dayIndex[u]];p.style.left="calc((100% / "+this.dayCount+") * ("+(w.dayOffset+1)+" - 1) + 2px)";BX.removeClass(this.entryHolders[w.holderIndex],"shifted");this.entryHolders[w.holderIndex].appendChild(p);var z=BX.pos(p);if(m){BX.adjust(m,{style:{width:(z.width-6)+"px",height:z.height+"px",top:z.top+"px",left:z.left+"px"}})}}var t=y.form.colorSelector.getValue();if(m){m.style.background=t;m.style.borderColor=t}}}.bind(this))},this),200)};if(a.BXEventCalendar){a.BXEventCalendar.CalendarMonthView=c}else{BX.addCustomEvent(a,"onBXEventCalendarInit",function(){a.BXEventCalendar.CalendarMonthView=c})}})(window);