(function(b){var c=b.BXEventCalendarView;function a(e,d){c.apply(this,arguments);this.appView=d;this.name="custom_"+d.ID;this.type="custom";this.placementCode=this.calendar.util.config.placementParams.gridPlacementCode;this.title=d.TITLE||this.appView.APP_NAME||BX.message("EC_REQUEST_APP_NONAME_TAB");this.contClassName="calendar-custom-view";this.preBuild()}a.prototype=Object.create(c.prototype);a.prototype.constructor=a;a.prototype.preBuild=function(){this.viewCont=BX.create("DIV",{props:{className:this.contClassName},style:{display:"none"}});var d=BX.rest.AppLayout.initializePlacement(this.placementCode);if(d){d.prototype.getEvents=BX.proxy(this.appGetEntries,this);d.prototype.viewEvent=BX.proxy(this.appViewEvent,this);d.prototype.addEvent=BX.proxy(this.appAddEvent,this);d.prototype.editEvent=BX.proxy(this.appEditEvent,this);d.prototype.deleteEvent=BX.proxy(this.appDeleteEvent,this);d.prototype.events.push("Calendar.customView:refreshEntries");d.prototype.events.push("Calendar.customView:decreaseViewRangeDate");d.prototype.events.push("Calendar.customView:increaseViewRangeDate");d.prototype.events.push("Calendar.customView:adjustToDate")}};a.prototype.build=function(){this.titleCont=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-custom-view-title"}}));this.appWrap=this.viewCont.appendChild(BX.create("DIV",{props:{className:"calendar-app-wrap"},style:{height:this.calendar.util.getViewHeight()+"px"}}))};a.prototype.adjustViewRangeToDate=function(e){if(this.calendar.currentViewName!==this.name||!this.isBuilt){this.show();if(this.name){this.appLoader=this.appWrap.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"100px"}}))}var d=this.calendar.getDisplayedViewRange();this.appRequestIsRunning=true;BX.ajax({url:this.calendar.util.config.placementParams.serviceUrl,method:"POST",dataType:"html",data:{LOADER_ID:Math.round(Math.random()*1000000),PARAMS:{params:{ID:this.appView.APP_ID,PLACEMENT:this.calendar.util.config.placementParams.gridPlacementCode,PLACEMENT_ID:this.appView.ID,PLACEMENT_OPTIONS:{viewRangeFrom:BX.date.format("Y-m-d",d?d.start:this.calendar.getViewRangeDate()),viewRangeTo:BX.date.format("Y-m-d",d?d.end:this.calendar.getViewRangeDate())}}}},onsuccess:BX.delegate(this.appRequestOnSuccess,this),onfailure:BX.delegate(this.appRequestOnFailure,this)})}BX.onCustomEvent("Calendar.customView:adjustToDate",[BX.date.format("Y-m-d",e)])};a.prototype.appRequestOnSuccess=function(d){BX.remove(this.appLoader);this.appRequestIsRunning=false;BX.html(this.appWrap,d).then(BX.defer(function(){var e=BX.rest.AppLayout.get(this.calendar.util.config.placementParams.gridPlacementCode);if(e){e.allowInterface(["resizeWindow"])}},this))};a.prototype.appRequestOnFailure=function(){BX.remove(this.appLoader);this.appRequestIsRunning=false;this.appWrap.innerHTML='<div class="ui-alert ui-alert-warning"><span class="ui-alert-message">'+BX.message("EC_REQUEST_APP_FAILURE").replace("#APPNAME#",this.appView.APP_NAME)+"</span></div>"};a.prototype.appGetEntries=function(j,k){var h=new Date(j.dateFrom)||new Date(),g=new Date(j.dateTo)||(new Date(h.getFullYear(),h.getMonth()+1,h.getDate()));h.setHours(0,0,0,0);g.setHours(0,0,0,0);this.calendar.setDisplayedViewRange({start:h,end:g});this.entries=this.entryController.getList({startDate:h,finishDate:g,viewRange:this.calendar.getDisplayedViewRange(),finishCallback:BX.delegate(function(n){n.entries.forEach(function(i){i.UID=this.calendar.entryController.getUniqueId(i)},this);this.entries=this.entryController.getList({startDate:h,finishDate:g,viewRange:this.calendar.getDisplayedViewRange()});if(BX.type.isArray(this.entries)){var l,m;for(l=0;l<this.entries.length;l++){m=this.entries[l];this.entriesIndex[m.uid]=l}}k(n.entries)},this)});if(BX.type.isArray(this.entries)){var d=[];this.entries.forEach(function(i){i.data.UID=this.calendar.entryController.getUniqueId(i.data);d.push(i.data)},this);k(d);var e,f;for(e=0;e<this.entries.length;e++){f=this.entries[e];this.entriesIndex[f.uid]=e}}};a.prototype.getEntryByParams=function(e){var d=e.uid;if(!d&&e.id){if(e.dateFrom&&this.getEntryById(e.id+"|"+e.dateFrom)){d=e.id+"|"+e.dateFrom}else{if(this.getEntryById(e.id)){d=e.id}}}return this.getEntryById(d)||false};a.prototype.appViewEvent=function(e,f){var d=this.getEntryByParams(e);if(d){this.showViewSlider({entry:d})}f({result:!!d})};a.prototype.appAddEvent=function(d,e){this.showEditSlider();e({result:true})};a.prototype.appEditEvent=function(e,f){var d=this.getEntryByParams(e);if(d){this.calendar.entryController.editEntry({entry:d})}f({result:!!d})};a.prototype.appDeleteEvent=function(e,f){var d=this.getEntryByParams(e);if(d){this.calendar.entryController.deleteEntry(d)}f()};a.prototype.displayEntries=function(){BX.onCustomEvent("Calendar.customView:refreshEntries",[{}])};a.prototype.decreaseViewRangeDate=function(){BX.onCustomEvent("Calendar.customView:decreaseViewRangeDate",[{}])};a.prototype.increaseViewRangeDate=function(){BX.onCustomEvent("Calendar.customView:increaseViewRangeDate",[{}])};if(b.BXEventCalendar){b.BXEventCalendar.CalendarCustomView=a}else{BX.addCustomEvent(b,"onBXEventCalendarInit",function(){b.BXEventCalendar.CalendarCustomView=a})}})(window);