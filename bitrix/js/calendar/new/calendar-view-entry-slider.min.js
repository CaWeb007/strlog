(function(c){function b(d){this.calendar=d;this.id="calendar_view_slider_"+Math.round(Math.random()*1000000);this.sliderId="calendar:view-entry-slider";this.zIndex=3100;this.DOM={}}b.prototype={show:function(d){this.entry=d.entry;this.formType=d.formType||"slider_main";BX.SidePanel.Instance.open(this.sliderId,{contentCallback:BX.delegate(this.createContent,this)});this.calendar.keyHandlerEnabled=false;BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this));BX.addCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.bind(document,"click",BX.proxy(this.calendar.util.applyHacksForPopupzIndex,this.calendar.util));this.opened=true},hide:function(d){if(d&&d.getSliderPage&&d.getSliderPage().getUrl()===this.sliderId){if(this.denyClose){d.denyAction()}else{BX.removeCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this))}}},destroy:function(d){if(d&&d.getSliderPage&&d.getSliderPage().getUrl()===this.sliderId){BX.unbind(document,"click",BX.proxy(this.calendar.util.applyHacksForPopupzIndex,this.calendar.util));BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.onCustomEvent("OnCalendarPlannerDoUninstall",[{plannerId:this.plannerId}]);BX.SidePanel.Instance.destroy(this.sliderId);this.calendar.keyHandlerEnabled=true;if(this.userListPopup){this.userListPopup.close()}setTimeout(BX.delegate(function(){this.calendar.getView().deselectEntry()},this),300);this.opened=false}},isOpened:function(){return this.opened},close:function(){BX.SidePanel.Instance.close()},createContent:function(){var d=new BX.Promise();BX.ajax.get(this.calendar.util.getActionUrl(),{action:"get_view_slider",unique_id:this.id,form_type:this.formType,sessid:BX.bitrix_sessid(),bx_event_calendar_request:"Y",entry_id:this.entry.id,date_from:this.entry.data["~CURRENT_DATE"]||this.entry.data.DATE_FROM,section_name:this.entry.getSectionName(),date_from_offset:this.entry.data.TZ_OFFSET_FROM,reqId:Math.round(Math.random()*1000000)},BX.delegate(function(e){d.fulfill(BX.util.trim(e));this.initControls()},this));return d},initControls:function(){this.initPlannerControl();this.initUserListControl();this.DOM.buttonSet=BX(this.id+"_buttonset");this.DOM.editButton=BX(this.id+"_but_edit");this.DOM.delButton=BX(this.id+"_but_del");if(BX(this.id+"_time_inner_wrap").offsetHeight>50){BX.addClass(BX(this.id+"_time_wrap"),"calendar-slider-sidebar-head-long-time")}if(this.calendar.entryController.canDo(this.entry,"edit")){BX.bind(this.DOM.editButton,"click",BX.delegate(function(){BX.SidePanel.Instance.close(false,BX.delegate(function(){this.calendar.entryController.editEntry({entry:this.entry})},this))},this))}else{BX.remove(this.DOM.editButton)}if(this.calendar.entryController.canDo(this.entry,"delete")){BX.bind(this.DOM.delButton,"click",BX.delegate(function(){this.calendar.entryController.deleteEntry(this.entry)},this))}else{BX.remove(this.DOM.delButton)}BX.viewElementBind(this.id+"_"+this.entry.id+"_files_wrap",{showTitle:true},function(f){return BX.type.isElementNode(f)&&(f.getAttribute("data-bx-viewer")||f.getAttribute("data-bx-image"))});if(this.entry&&this.entry.getCurrentStatus()){this.initAcceptMeetingControll()}var e=BX(this.id+"_sidebar_inner");if(e){var d=e.querySelectorAll(".calendar-slider-sidebar-border-bottom");if(d.length>=2){BX.removeClass(d[d.length-1],"calendar-slider-sidebar-border-bottom")}}this.DOM.copyButton=BX(this.id+"_copy_url_btn");if(this.DOM.copyButton){BX.bind(this.DOM.copyButton,"click",BX.proxy(this.copyEventUrl,this))}},initPlannerControl:function(){this.plannerId=this.id+"_view_slider_planner";this.DOM.plannerWrap=BX(this.id+"_view_planner_wrap");setTimeout(BX.delegate(function(){if(this.DOM.plannerWrap){BX.removeClass(this.DOM.plannerWrap,"hidden")}},this),500);setTimeout(BX.delegate(function(){if(this.DOM.plannerWrap&&this.DOM.plannerWrap.offsetWidth){BX.onCustomEvent("OnCalendarPlannerDoResize",[{plannerId:this.plannerId,timeoutCheck:true,width:this.DOM.plannerWrap.offsetWidth}])}},this),200);BX.bind(c,"resize",BX.delegate(function(){if(this.DOM.plannerWrap&&this.DOM.plannerWrap.offsetWidth){BX.onCustomEvent("OnCalendarPlannerDoResize",[{plannerId:this.plannerId,timeoutCheck:true,width:this.DOM.plannerWrap.offsetWidth}])}},this))},initUserListControl:function(){var d={y:[],i:[],q:[],n:[]};if(this.entry.isMeeting()){this.entry.getAttendees().forEach(function(e){if(e.STATUS=="H"){d.y.push(e)}else{if(d[e.STATUS.toLowerCase()]){d[e.STATUS.toLowerCase()].push(e)}}},this)}BX.bind(BX(this.id+"_attendees_y"),"click",BX.delegate(function(){this.showUserListPopup(BX(this.id+"_attendees_y"),d.y)},this));BX.bind(BX(this.id+"_attendees_n"),"click",BX.delegate(function(){this.showUserListPopup(BX(this.id+"_attendees_n"),d.n)},this));BX.bind(BX(this.id+"_attendees_q"),"click",BX.delegate(function(){this.showUserListPopup(BX(this.id+"_attendees_q"),d.q)},this));BX.bind(BX(this.id+"_attendees_i"),"click",BX.delegate(function(){this.showUserListPopup(BX(this.id+"_attendees_i"),d.i)},this))},showUserListPopup:function(e,d){if(this.userListPopup){this.userListPopup.close()}if(!d||!d.length){return}this.DOM.userListPopupWrap=BX.create("DIV",{props:{className:"calendar-user-list-popup-block"}});d.forEach(function(f){var g=this.DOM.userListPopupWrap.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-container calendar-slider-sidebar-user-card"}}));g.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-avatar"}})).appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-item"}})).appendChild(BX.create("IMG",{props:{width:34,height:34,src:f.AVATAR}}));g.appendChild(BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-info"}})).appendChild(BX.create("A",{props:{href:f.URL?f.URL:"#",className:"calendar-slider-sidebar-user-info-name"},text:f.DISPLAY_NAME}))},this);this.userListPopup=BX.PopupWindowManager.create(this.calendar.id+"-user-list-popup",e,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,width:200,resizable:false,lightShadow:true,content:this.DOM.userListPopupWrap,className:"calendar-user-list-popup"});this.userListPopup.setAngle({offset:36});this.userListPopup.show();BX.addCustomEvent(this.userListPopup,"onPopupClose",BX.delegate(function(){this.userListPopup.destroy()},this))},initAcceptMeetingControll:function(){this.setStatus=new a({calendar:this.calendar,wrap:BX(this.id+"_status_buttonset"),currentStatus:BX(this.id+"_current_status").value||this.entry.getCurrentStatus(),changeStatusCallback:BX.delegate(function(d){this.calendar.entryController.setMeetingStatus(this.entry,d)},this)})},copyEventUrl:function(){var e=this.calendar.util.getEventPath(this.entry);if(!BX.clipboard.copy(e)){return}this.timeoutIds=this.timeoutIds||[];var f={content:BX.message("CALENDAR_TIP_TEMPLATE_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1000,angle:true,offsetLeft:20};var d=new BX.PopupWindow("calendar_clipboard_copy",this.DOM.copyButton,f);d.show();var g;while(g=this.timeoutIds.pop()){clearTimeout(g)}g=setTimeout(function(){d.close()},1500);this.timeoutIds.push(g)}};function a(d){this.calendar=d.calendar;this.wrap=d.wrap;this.id=this.calendar.id+"_set_status_button";this.status=d.currentStatus;this.changeStatusCallback=d.changeStatusCallback;this.zIndex=3100;this.create();this.updateStatus()}a.prototype={create:function(){this.selectorButton=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button webform-small-button-transparent webform-small-button-dropdown"},events:{click:BX.proxy(this.showPopup,this)}}));this.selectorButtonText=this.selectorButton.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-text"}}));this.selectorButtonIcon=this.selectorButton.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-icon"}}));this.buttonY=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button webform-small-button-accept"},events:{click:BX.proxy(function(){this.setStatus("Y")},this)},html:BX.message("EC_VIEW_DESIDE_BUT_Y")}));this.buttonI=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button webform-small-button-transparent"},style:{display:"none"},events:{click:BX.proxy(function(){this.setStatus("I")},this)},html:BX.message("EC_VIEW_DESIDE_BUT_I")}));this.buttonN=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-link"},events:{click:BX.proxy(function(){this.setStatus("N")},this)},html:BX.message("EC_VIEW_DESIDE_BUT_N")}))},updateStatus:function(){if(this.status=="Q"){this.selectorButton.style.display="none";this.buttonY.style.display="";this.buttonN.style.display=""}else{this.selectorButton.style.display="";this.selectorButtonText.innerHTML=BX.message("EC_VIEW_STATUS_BUT_"+this.status);this.buttonY.style.display="none";this.buttonI.style.display="none";this.buttonN.style.display="none"}},setStatus:function(d){this.status=d;if(this.menuPopup){this.menuPopup.close()}if(this.changeStatusCallback&&typeof this.changeStatusCallback=="function"){this.changeStatusCallback(this.status)}this.updateStatus()},showPopup:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){return this.menuPopup.close()}var d;if(this.status=="Y"||this.status=="H"){d=[{text:BX.message("EC_VIEW_DESIDE_BUT_N"),onclick:BX.proxy(function(){this.setStatus("N")},this)}]}else{if(this.status=="N"){d=[{text:BX.message("EC_VIEW_DESIDE_BUT_Y"),onclick:BX.proxy(function(){this.setStatus("Y")},this)}]}else{if(this.status=="I"){d=[{text:BX.message("EC_VIEW_DESIDE_BUT_Y"),onclick:BX.proxy(function(){this.setStatus("Y")},this)},{text:BX.message("EC_VIEW_DESIDE_BUT_N"),onclick:BX.proxy(function(){this.setStatus("N")},this)}]}}}this.menuPopup=BX.PopupMenu.create(this.id,this.selectorButtonIcon,d,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:15,offsetLeft:5,angle:true});this.menuPopup.show();BX.addCustomEvent(this.menuPopup.popupWindow,"onPopupClose",BX.delegate(function(){BX.PopupMenu.destroy(this.id)},this))}};if(c.BXEventCalendar){c.BXEventCalendar.ViewEntrySlider=b}else{BX.addCustomEvent(c,"onBXEventCalendarInit",function(){c.BXEventCalendar.ViewEntrySlider=b})}})(window);