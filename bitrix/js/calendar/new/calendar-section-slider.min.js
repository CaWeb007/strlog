(function(c){function b(g){this.calendar=g.calendar;this.button=g.button;this.zIndex=g.zIndex||3100;this.SLIDER_WIDTH=400;this.SLIDER_DURATION=80;this.sliderId="calendar:section-slider";this.denyClose=false;BX.bind(this.button,"click",BX.delegate(this.show,this))}b.prototype={show:function(){BX.SidePanel.Instance.open(this.sliderId,{contentCallback:BX.delegate(this.create,this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION});BX.addCustomEvent("SidePanel.Slider:onCloseByEsc",BX.proxy(this.escHide,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this));BX.addCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.addCustomEvent("BXCalendar:onSectionDelete",BX.proxy(this.deleteSectionHandler,this));BX.addCustomEvent("BXCalendar:onSectionChange",BX.proxy(this.changeSectionHandler,this));BX.addCustomEvent("BXCalendar:onSectionAdd",BX.proxy(this.addSectionHandler,this));this.calendar.keyHandlerEnabled=false},escHide:function(g){if(g&&g.getSliderPage&&g.getSliderPage().getUrl()===this.sliderId&&this.denyClose){g.denyAction()}},hide:function(g){if(g&&g.getSliderPage&&g.getSliderPage().getUrl()===this.sliderId){this.closeForms();BX.removeCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this));BX.removeCustomEvent("SidePanel.Slider:onCloseByEsc",BX.proxy(this.escHide,this));BX.removeCustomEvent("BXCalendar:onSectionDelete",BX.proxy(this.deleteSectionHandler,this));BX.removeCustomEvent("BXCalendar:onSectionChange",BX.proxy(this.changeSectionHandler,this));BX.removeCustomEvent("BXCalendar:onSectionAdd",BX.proxy(this.addSectionHandler,this))}},close:function(){BX.SidePanel.Instance.close()},destroy:function(g){if(g&&g.getSliderPage&&g.getSliderPage().getUrl()===this.sliderId){BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.SidePanel.Instance.destroy(this.sliderId);delete this.sectionListWrap;this.calendar.keyHandlerEnabled=true;if(this.sectionActionMenu){this.sectionActionMenu.close()}}},create:function(){this.outerWrap=BX.create("DIV",{props:{className:"calendar-list-slider-wrap"}});this.titleWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-title-container"},html:'<div class="calendar-list-slider-title">'+BX.message("EC_SECTION_BUTTON")+"</div>"}));if(!this.calendar.util.readOnlyMode()){this.createAddButton();this.editSectionFormWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-widget calendar-list-slider-form-wrap"},html:'<div class="calendar-list-slider-card-widget-title"><span class="calendar-list-slider-card-widget-title-text">'+BX.message("EC_SEC_SLIDER_NEW_SECTION")+"</span></div>"}));this.trackingCompanyFormWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-widget calendar-list-slider-form-wrap"},html:'<div class="calendar-list-slider-card-widget-title"><span class="calendar-list-slider-card-widget-title-text">'+BX.message("EC_SEC_SLIDER_POPUP_MENU_ADD_COMP")+"</span></div>"}));this.trackingUsersFormWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-widget calendar-list-slider-form-wrap"},html:'<div class="calendar-list-slider-card-widget-title"><span class="calendar-list-slider-card-widget-title-text">'+BX.message("EC_SEC_SLIDER_POPUP_MENU_ADD_USER")+"</span></div>"}));this.trackingGroupsFormWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-widget calendar-list-slider-form-wrap"},html:'<div class="calendar-list-slider-card-widget-title"><span class="calendar-list-slider-card-widget-title-text">'+BX.message("EC_SEC_SLIDER_POPUP_MENU_ADD_GROUP")+"</span></div>"}))}this.createSectionList();return this.outerWrap},createSectionList:function(){var h,g;this.sliderSections=this.calendar.sectionController.getSectionList();if(this.calendar.util.type=="user"){g=BX.message("EC_SEC_SLIDER_MY_CALENDARS_LIST")}else{if(this.calendar.util.type=="group"){g=BX.message("EC_SEC_SLIDER_GROUP_CALENDARS_LIST")}else{g=BX.message("EC_SEC_SLIDER_TYPE_CALENDARS_LIST")}}if(this.sectionListWrap){BX.cleanNode(this.sectionListWrap);BX.adjust(this.sectionListWrap,{props:{className:"calendar-list-slider-card-widget"},html:'<div class="calendar-list-slider-card-widget-title"><span class="calendar-list-slider-card-widget-title-text">'+g+"</span></div>"})}else{this.sectionListWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-widget"},html:'<div class="calendar-list-slider-card-widget-title"><span class="calendar-list-slider-card-widget-title-text">'+g+"</span></div>"}))}this.createSectionBlock({wrap:this.sectionListWrap,sectionList:this.sliderSections.filter(function(i){return i.belongsToView()||i.isPseudo()})});h=this.sliderSections.filter(function(i){return i.isCompanyCalendar()&&!i.belongsToView()});if(h.length>0){this.sectionListWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-section-title"},html:'<span class="calendar-list-slider-card-section-title-text">'+BX.message("EC_SEC_SLIDER_TITLE_COMP_CAL")+"</span>"}));this.createSectionBlock({wrap:this.sectionListWrap,sectionList:this.sliderSections.filter(function(i){return i.isCompanyCalendar()})})}this.calendar.util.getSuperposedTrackedUsers().forEach(function(i){var j=this.sliderSections.filter(function(k){return !k.belongsToView()&&k.isSuperposed()&&k.type=="user"&&k.data.OWNER_ID==i.ID});if(j.length>0){this.sectionListWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-section-title"},html:'<span class="calendar-list-slider-card-section-title-text">'+BX.util.htmlspecialchars(i.FORMATTED_NAME)+"</span>"}));this.createSectionBlock({wrap:this.sectionListWrap,sectionList:j})}},this);h=this.sliderSections.filter(function(i){return !i.belongsToView()&&i.type=="group"&&i.isSuperposed()});if(h.length>0){this.sectionListWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-section-title"},html:'<span class="calendar-list-slider-card-section-title-text">'+BX.message("EC_SEC_SLIDER_TITLE_GROUP_CAL")+"</span>"}));this.createSectionBlock({wrap:this.sectionListWrap,sectionList:h})}},createAddButton:function(){this.addButtonOuter=this.titleWrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-separate-wrap"},style:{marginRight:0}}));this.addButton=this.addButtonOuter.appendChild(BX.create("SPAN",{props:{className:"webform-small-button"},text:BX.message("EC_ADD")}));this.addButtonMore=this.addButtonOuter.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-right-part"}}));this.addButtonMorePopupId="add_btn_popup_"+this.calendar.id;BX.bind(this.addButtonMore,"click",BX.proxy(this.showAddBtnPopup,this));BX.bind(this.addButton,"click",BX.proxy(this.showEditSectionForm,this))},showAddBtnPopup:function(i){if(this.addBtnMenu&&this.addBtnMenu.popupWindow&&this.addBtnMenu.popupWindow.isShown()){return this.addBtnMenu.close()}var j=this,h="main-buttons-submenu-separator main-buttons-submenu-item main-buttons-hidden-label",g=[{text:"<span>"+BX.message("EC_SEC_SLIDER_POPUP_NEW_TITLE")+"</span>",className:h},{text:BX.message("EC_SEC_SLIDER_POPUP_NEW_MENU"),onclick:BX.proxy(function(){this.addBtnMenu.close();this.showEditSectionForm()},this)},{text:"<span>"+BX.message("EC_SEC_SLIDER_POPUP_EXIST_TITLE")+"</span>",className:h},{text:BX.message("EC_SEC_SLIDER_POPUP_MENU_ADD_COMP"),onclick:BX.proxy(function(){this.addBtnMenu.close();this.showTrackingTypesForm()},this)},{text:BX.message("EC_SEC_SLIDER_POPUP_MENU_ADD_USER"),onclick:BX.proxy(function(){this.addBtnMenu.close();this.showTrackingUsersForm()},this)},{text:BX.message("EC_SEC_SLIDER_POPUP_MENU_ADD_GROUP"),onclick:BX.proxy(function(){this.addBtnMenu.close();this.showTrackingGroupsForm()},this)}];this.addBtnMenu=BX.PopupMenu.create(this.addButtonMorePopupId,this.addButtonMore,g,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:15,angle:true});this.addBtnMenu.show();this.denySliderClose();BX.addCustomEvent(this.addBtnMenu.popupWindow,"onPopupClose",function(){j.allowSliderClose();BX.PopupMenu.destroy(j.addButtonMorePopupId)})},createSectionBlock:function(o){var h=false;if(o.sectionList&&o.sectionList.length){var k=o.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-widget-content"}})).appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-widget-content-block"}})).appendChild(BX.create("UL",{props:{className:"calendar-list-slider-container"}}));BX.bind(k,"click",BX.proxy(this.sectionClickHandler,this));var j,g,l,n,m;for(j=0;j<o.sectionList.length;j++){g=k.appendChild(BX.create("LI",{props:{className:"calendar-list-slider-item"},attrs:{"data-bx-calendar-section":o.sectionList[j].id.toString()}}));l=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-item-checkbox"+(o.sectionList[j].isShown()?" calendar-list-slider-item-checkbox-checked":"")},style:{backgroundColor:o.sectionList[j].color}}));n=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-item-name"},text:o.sectionList[j].name}));m=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-item-actions-container"},attrs:{"data-bx-calendar-section-menu":o.sectionList[j].id.toString()},html:'<span class="calendar-list-slider-item-context-menu"></span>'}));if(!o.sectionList[j].DOM){o.sectionList[j].DOM={}}o.sectionList[j].DOM.item=g;o.sectionList[j].DOM.checkbox=l;o.sectionList[j].DOM.title=n;o.sectionList[j].DOM.actionCont=m}}return h},sectionClickHandler:function(h){var g=this.calendar.util.findTargetNode(h.target||h.srcElement,this.outerWrap);if(g&&g.getAttribute){if(g.getAttribute("data-bx-calendar-section-menu")!==null){this.showSectionMenu(this.calendar.sectionController.getSection(g.getAttribute("data-bx-calendar-section-menu")))}else{if(g.getAttribute("data-bx-calendar-section")!==null){this.switchSection(this.calendar.sectionController.getSection(g.getAttribute("data-bx-calendar-section")))}}}},switchSection:function(g){if(BX.hasClass(g.DOM.checkbox,"calendar-list-slider-item-checkbox-checked")){BX.removeClass(g.DOM.checkbox,"calendar-list-slider-item-checkbox-checked");g.hide()}else{BX.addClass(g.DOM.checkbox,"calendar-list-slider-item-checkbox-checked");g.show()}this.calendar.refresh()},showSectionMenu:function(h){var j=this,g=[],i=this.calendar.id+"_section_"+h.id;BX.addClass(h.DOM.item,"active");if(h.getLink()&&!h.belongsToView()){g.push({text:BX.message("EC_SEC_OPEN_LINK"),href:h.getLink()})}if(!this.calendar.util.readOnlyMode()&&h.canDo("edit_section")&&!h.isPseudo()){g.push({text:BX.message("EC_SEC_EDIT"),onclick:function(){j.sectionActionMenu.close();j.showEditSectionForm({section:h})}})}if(h.isSuperposed()&&!h.belongsToView()){g.push({text:BX.message("EC_SEC_HIDE"),onclick:function(){j.hideSuperposedHandler(h);j.sectionActionMenu.close()}})}if(h.canBeConnectedToOutlook()){g.push({text:BX.message("EC_SEC_CONNECT_TO_OUTLOOK"),onclick:function(){j.sectionActionMenu.close();h.connectToOutlook();j.close()}})}if(!h.isPseudo()&&h.data.EXPORT.LINK){g.push({text:BX.message("EC_ACTION_EXPORT"),onclick:BX.delegate(function(){j.sectionActionMenu.close();if(!j.calendar.syncSlider){j.calendar.syncSlider=new c.BXEventCalendar.SyncSlider({calendar:j.calendar})}j.calendar.syncSlider.showICalExportDialog(h)},this)})}if(h.canDo("edit_section")&&h.belongsToView()&&!h.isPseudo()){g.push({text:BX.message("EC_SEC_DELETE"),onclick:function(){j.sectionActionMenu.close();h.remove()}})}if((h.isGoogle()||h.isCalDav())&&h.canDo("edit_section")){g.push({text:BX.message("EC_ACTION_REFRESH"),onclick:BX.delegate(function(){this.sectionActionMenu.close();this.calendar.reload({syncGoogle:true});this.close()},this)});if(this.calendar.syncSlider){g.push({text:BX.message("EC_ACTION_EXTERNAL_ADJUST"),onclick:function(){j.sectionActionMenu.close();j.calendar.syncSlider.showCalDavSyncDialog()}})}g.push({text:BX.message("EC_ACTION_HIDE"),onclick:BX.delegate(function(){this.sectionActionMenu.close();h.hideGoogle()},this)})}if(g&&g.length>0){this.sectionActionMenu=BX.PopupMenu.create(i,h.DOM.actionCont,g,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:9,angle:true});this.sectionActionMenu.show();this.denySliderClose();BX.addCustomEvent(this.sectionActionMenu.popupWindow,"onPopupClose",function(){if(h.DOM.item){BX.removeClass(h.DOM.item,"active")}j.allowSliderClose();BX.PopupMenu.destroy(i)})}},denySliderClose:function(){this.denyClose=true},allowSliderClose:function(){this.denyClose=false},closeForms:function(){if(this.addBtnMenu){this.addBtnMenu.close()}if(this.editSectionForm){this.editSectionForm.close()}if(this.trackingUsersForm){this.trackingUsersForm.close()}if(this.trackingGroupsForm){this.trackingGroupsForm.close()}if(this.trackingTypesForm){this.trackingTypesForm.close()}},showEditSectionForm:function(h){if(!h){h={}}if(this.editSectionForm&&this.editSectionForm.isOpenedState){return this.closeForms()}this.closeForms();this.editSectionFormTitle=this.editSectionFormWrap.querySelector(".calendar-list-slider-card-widget-title-text");this.editSectionForm=new f({calendar:this.calendar,wrap:this.editSectionFormWrap,zIndex:this.zIndex,closeCallback:BX.delegate(function(){this.allowSliderClose()},this)});var g=true;if(h.section&&(!h.section.belongsToView()||h.section.isPseudo())){this.editSectionFormTitle.innerHTML=BX.message("EC_SEC_SLIDER_EDIT_SECTION_PERSONAL");g=false}else{if(h.section&&h.section.id){this.editSectionFormTitle.innerHTML=BX.message("EC_SEC_SLIDER_EDIT_SECTION")}else{this.editSectionFormTitle.innerHTML=BX.message("EC_SEC_SLIDER_NEW_SECTION")}}this.editSectionForm.show({showAccess:g,section:h.section||{color:this.calendar.sectionController.getDefaultSectionColor(),access:this.calendar.sectionController.getDefaultSectionAccess()}});this.denySliderClose()},showTrackingTypesForm:function(){this.closeForms();if(!this.trackingTypesForm){this.trackingTypesForm=new d({calendar:this.calendar,wrap:this.trackingCompanyFormWrap,superposedSections:this.calendar.sectionController.getSuperposedSectionList(),closeCallback:BX.delegate(function(){this.allowSliderClose()},this)})}this.trackingTypesForm.show();this.denySliderClose()},showTrackingUsersForm:function(){this.closeForms();if(!this.trackingUsersForm){this.trackingUsersForm=new e({calendar:this.calendar,wrap:this.trackingUsersFormWrap,trackingUsers:this.calendar.util.getSuperposedTrackedUsers(),superposedSections:this.calendar.sectionController.getSuperposedSectionList(),closeCallback:BX.delegate(function(){this.allowSliderClose()},this)})}this.trackingUsersForm.show();this.denySliderClose()},showTrackingGroupsForm:function(){this.closeForms();if(!this.trackingGroupsForm){var g=this.calendar.sectionController.getSuperposedSectionList(),h=this.calendar.util.getSuperposedTrackedGroups();if(!h.length){g.forEach(function(j){if(j.type=="group"){var i=j.data.OWNER_ID;if(!BX.util.in_array(i,h)){h.push(i)}}},this)}this.trackingGroupsForm=new a({calendar:this.calendar,wrap:this.trackingGroupsFormWrap,trackingGroups:h,superposedSections:g})}this.trackingGroupsForm.show()},deleteSectionHandler:function(g){this.sliderSections.forEach(function(i,h){if(i.id==g&&i.DOM&&i.DOM.item){BX.addClass(i.DOM.item,"calendar-list-slider-item-disappearing");setTimeout(BX.delegate(function(){BX.cleanNode(i.DOM.item,true);this.sliderSections=BX.util.deleteFromArray(this.sliderSections,h)},this),300)}},this)},hideSuperposedHandler:function(h){var j=this.calendar.sectionController.getSuperposedSectionList(),k=[],g;for(g=0;g<j.length;g++){if(h.id!=parseInt(j[g].id)){k.push(parseInt(j[g].id))}}this.calendar.request({data:{action:"set_tracking_sections",sect:k},handler:BX.delegate(function(i){BX.reload()},this)})},changeSectionHandler:function(g,h){this.sliderSections.forEach(function(i){if(i.id==g&&i.DOM&&i.DOM.item){i.DOM.title.innerHTML=BX.util.htmlspecialchars(h.name);i.DOM.checkbox.style.backgroundColor=h.color}},this)},addSectionHandler:function(){this.createSectionList()}};function f(g){this.calendar=g.calendar;this.outerWrap=g.wrap;this.zIndex=g.zIndex;this.closeCallback=g.closeCallback;this.isCreated=false}f.prototype={show:function(g){this.create();this.showAccess=g.showAccess!==false;if(this.showAccess){this.accessLink.style.display="";this.accessWrap.style.display=""}else{this.accessLink.style.display="none";this.accessWrap.style.display="none"}BX.bind(document,"keydown",BX.proxy(this.keyHandler,this));BX.addClass(this.outerWrap,"show");this.section=g.section;if(g.section){if(g.section.color){this.setColor(g.section.color)}this.setAccess(g.section.access||g.section.data.ACCESS||{});if(g.section.name){this.sectionTitleInput.value=g.section.name}}BX.focus(this.sectionTitleInput);if(this.sectionTitleInput.value!==""){this.sectionTitleInput.select()}this.isOpenedState=true},close:function(){this.isOpenedState=false;BX.unbind(document,"keydown",BX.proxy(this.keyHandler,this));BX.removeClass(this.outerWrap,"show");if(this.closeCallback){this.closeCallback()}},isOpened:function(){return this.isOpenedState},create:function(){this.wrap=this.outerWrap.querySelector(".calendar-form-content");if(this.wrap){BX.cleanNode(this.wrap)}else{this.wrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-form-content"}}))}this.formFieldsWrap=this.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-widget-content"}})).appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-widget-content-block"}}));this.sectionTitleInput=this.formFieldsWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-container calendar-field-container-string"}})).appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}})).appendChild(BX.create("INPUT",{attrs:{type:"text",placeholder:BX.message("EC_SEC_SLIDER_SECTION_TITLE")},props:{className:"calendar-field calendar-field-string"}}));var g=this.formFieldsWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-new-calendar-options-container"}}));this.colorContWrap=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-new-calendar-option-color"},html:BX.message("EC_SEC_SLIDER_COLOR")}));this.colorIcon=this.colorContWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-list-slider-new-calendar-option-color-selected"}}));this.colorChangeLink=this.colorContWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-list-slider-new-calendar-option-color-change"},html:BX.message("EC_SEC_SLIDER_CHANGE")}));this.initSectionColorSelector();this.accessLink=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-new-calendar-option-more"},html:BX.message("EC_SEC_SLIDER_ACCESS")}));this.accessWrap=this.formFieldsWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-access-container"}}));this.initAccessController();this.buttonsWrap=this.formFieldsWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-btn-container"}}));this.saveBtn=this.buttonsWrap.appendChild(BX.create("DIV",{props:{className:"webform-small-button webform-small-button-blue"},text:BX.message("EC_SEC_SLIDER_SAVE"),events:{click:BX.proxy(this.save,this)}}));this.cancelBtn=this.buttonsWrap.appendChild(BX.create("SPAN",{props:{className:"webform-button-link"},text:BX.message("EC_SEC_SLIDER_CANCEL"),events:{click:BX.proxy(this.checkClose,this)}}));this.isCreated=true},keyHandler:function(g){if(g.keyCode==this.calendar.util.KEY_CODES.escape){this.checkClose()}else{if(g.keyCode==this.calendar.util.KEY_CODES.enter){this.save()}}},checkClose:function(){this.close()},save:function(){this.calendar.sectionController.saveSection(this.sectionTitleInput.value,this.color,this.access,{section:this.section});this.close()},initSectionColorSelector:function(){BX.bind(this.colorIcon,"click",BX.delegate(this.showSimplePicker,this));BX.bind(this.colorChangeLink,"click",BX.delegate(this.showSimplePicker,this))},showSimplePicker:function(l){var g=BX.clone(this.calendar.util.getDefaultColors(),true),m=BX.create("DIV",{props:{className:"calendar-simple-color-wrap calendar-field-container-colorpicker-square"}}),h=m.appendChild(BX.create("DIV",{events:{click:BX.delegate(this.simplePickerClick,this)}})),k=m.appendChild(BX.create("DIV",{props:{className:"calendar-simple-color-more-link-wrap"}})),n=k.appendChild(BX.create("SPAN",{props:{className:"calendar-simple-color-more-link"},html:BX.message("EC_COLOR"),events:{click:BX.delegate(this.showFullPicker,this)}}));this.simplePickerColorWrap=h;this.colors=[];if(!BX.util.in_array(this.color,g)){g.push(this.color)}for(var j=0;j<g.length;j++){this.colors.push({color:g[j],node:h.appendChild(BX.create("SPAN",{props:{className:"calendar-field-colorpicker-color-item"},style:{backgroundColor:g[j]},attrs:{"data-bx-calendar-color":g[j]},html:'<span class="calendar-field-colorpicker-color"></span>'}))})}this.lastActiveNode=this.colors[BX.util.array_search(this.color,g)||0].node;BX.addClass(this.lastActiveNode,"active");this.simpleColorPopup=BX.PopupWindowManager.create(this.calendar.id+"-simple-color-popup",this.colorIcon,{zIndex:this.zIndex,autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:9,lightShadow:true,content:m});this.simpleColorPopup.setAngle({offset:10});this.simpleColorPopup.show(true);BX.addCustomEvent(this.simpleColorPopup,"onPopupClose",BX.delegate(function(){this.simpleColorPopup.destroy()},this))},simplePickerClick:function(i){var h=this.calendar.util.findTargetNode(i.target||i.srcElement,this.outerWrap);if(h&&h.getAttribute){var g=h.getAttribute("data-bx-calendar-color");if(g!==null){if(this.lastActiveNode){BX.removeClass(this.lastActiveNode,"active")}BX.addClass(h,"active");this.lastActiveNode=h;this.setColor(g)}}},showFullPicker:function(){if(this.simpleColorPopup){this.simpleColorPopup.close()}if(!this.fullColorPicker){this.fullColorPicker=new BX.ColorPicker({bindElement:this.colorIcon,onColorSelected:BX.delegate(function(g){this.setColor(g)},this),popupOptions:{zIndex:this.zIndex,events:{onPopupClose:BX.delegate(function(){},this)}}})}this.fullColorPicker.open()},setColor:function(g){this.colorIcon.style.backgroundColor=g;this.color=g},setAccess:function(i){var g=0;for(var h in i){if(i.hasOwnProperty(h)){g++}}this.accessRowsCount=g;this.access=i;for(h in i){if(i.hasOwnProperty(h)){this.insertAccessRow(this.calendar.util.getAccessName(h),h,i[h])}}},initAccessController:function(){this.accessControls={};this.accessTasks=this.calendar.util.getSectionAccessTasks();BX.bind(this.accessLink,"click",BX.delegate(function(){if(BX.hasClass(this.accessWrap,"shown")){BX.removeClass(this.accessWrap,"shown")}else{BX.addClass(this.accessWrap,"shown")}},this));BX.Access.Init();this.accessWrapInner=this.accessWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-access-inner-wrap"}}));this.accessTable=this.accessWrapInner.appendChild(BX.create("TABLE",{props:{className:"calendar-section-slider-access-table"}}));this.accessButtonWrap=this.accessWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-new-calendar-options-container"}}));this.accessButton=this.accessButtonWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-list-slider-new-calendar-option-add"},html:BX.message("EC_SEC_SLIDER_ACCESS_ADD")}));BX.bind(this.accessButton,"click",BX.proxy(function(){BX.Access.ShowForm({callback:BX.proxy(function(g){var i,h;for(i in g){if(g.hasOwnProperty(i)){for(h in g[i]){if(g[i].hasOwnProperty(h)){this.insertAccessRow(BX.Access.GetProviderName(i)+" "+g[i][h].name,h)}}}}},this),bind:this.accessButton});if(BX.Access.popup&&BX.Access.popup.popupContainer){BX.Access.popup.popupContainer.style.zIndex=this.zIndex+10}},this));BX.bind(this.accessWrapInner,"click",BX.proxy(function(i){var g,h=this.calendar.util.findTargetNode(i.target||i.srcElement,this.outerWrap);if(h&&h.getAttribute){if(h.getAttribute("data-bx-calendar-access-selector")!==null){g=h.getAttribute("data-bx-calendar-access-selector");if(this.accessControls[g]){this.showAccessSelectorPopup({node:this.accessControls[g].removeIcon,setValueCallback:BX.delegate(function(j){if(this.accessTasks[j]&&this.accessControls[g]){this.accessControls[g].valueNode.innerHTML=BX.util.htmlspecialchars(this.accessTasks[j].title);this.access[g]=j}},this)})}}else{if(h.getAttribute("data-bx-calendar-access-remove")!==null){g=h.getAttribute("data-bx-calendar-access-remove");if(this.accessControls[g]){BX.cleanNode(this.accessControls[g].rowNode,true);delete this.access[g]}}}}},this))},insertAccessRow:function(m,g,n){if(n===undefined){n=this.calendar.util.getDefaultSectionAccessTask()}var h=BX.adjust(this.accessTable.insertRow(-1),{props:{className:"calendar-section-slider-access-table-row"}}),j=BX.adjust(h.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},html:'<span class="calendar-section-slider-access-title">'+BX.util.htmlspecialchars(m)+":</span>"}),k=BX.adjust(h.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},attrs:{"data-bx-calendar-access-selector":g}}),i=k.appendChild(BX.create("SPAN",{props:{className:"calendar-section-slider-access-value"}})),o=i.appendChild(BX.create("SPAN",{text:this.accessTasks[n]?this.accessTasks[n].title:""})),l=i.appendChild(BX.create("SPAN",{props:{className:"calendar-section-slider-access-remove"},attrs:{"data-bx-calendar-access-remove":g}}));this.accessControls[g]={rowNode:h,titleNode:j,valueNode:o,removeIcon:l}},showAccessSelectorPopup:function(i){if(this.accessPopupMenu&&this.accessPopupMenu.popupWindow&&this.accessPopupMenu.popupWindow.isShown()){return this.accessPopupMenu.close()}var k=this.calendar.id+"_section_access_popup",h,j=this,g=[];for(h in this.accessTasks){if(this.accessTasks.hasOwnProperty(h)){g.push({text:this.accessTasks[h].title,onclick:(function(l){return function(){i.setValueCallback(l);j.accessPopupMenu.close()}})(h)})}}this.accessPopupMenu=BX.PopupMenu.create(k,i.node,g,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:-5,offsetLeft:0,angle:true});this.accessPopupMenu.show();BX.addCustomEvent(this.accessPopupMenu.popupWindow,"onPopupClose",function(){BX.PopupMenu.destroy(k)})}};function e(g){this.calendar=g.calendar;this.outerWrap=g.wrap;this.trackingUsers=g.trackingUsers||[];this.selectedCodes={};this.CHECKED_CLASS="calendar-list-slider-item-checkbox-checked";this.selectorId=this.calendar.id+"_tracking_users";this.selectGroups=false;this.selectUsers=true;this.addLinkMessage=BX.message("EC_SEC_SLIDER_SELECT_USERS");this.closeCallback=g.closeCallback;this.selected={};g.superposedSections.forEach(function(h){this.selected[h.id]=true},this);this.isCreated=false}e.prototype={show:function(){this.trackingUsers.forEach(function(g){this.selectedCodes["U"+g.ID]="users"},this);if(!this.isCreated){this.create()}BX.addClass(this.outerWrap,"show");BX.bind(document,"keydown",BX.proxy(this.keyHandler,this));this.updateSectionList();this.isOpenedState=true},close:function(){BX.bind(document,"keydown",BX.proxy(this.keyHandler,this));this.isOpenedState=false;BX.removeClass(this.outerWrap,"show");if(this.closeCallback){this.closeCallback()}},isOpened:function(){return this.isOpenedState},create:function(){this.selectorWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-selector-wrap"}}));this.destinationSelector=new c.BXEventCalendar.DestinationSelector(this.selectorId,{calendar:this.calendar,wrapNode:this.selectorWrap,itemsSelected:this.selectedCodes,addLinkMessage:this.addLinkMessage,selectGroups:this.selectGroups,selectUsers:this.selectUsers});BX.addCustomEvent("OnDestinationAddNewItem",BX.proxy(this.updateSectionList,this));BX.addCustomEvent("OnDestinationUnselect",BX.proxy(this.updateSectionList,this));this.sectionsWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-sections-wrap"}}));this.buttonsWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-btn-container"}}));this.saveBtn=this.buttonsWrap.appendChild(BX.create("DIV",{props:{className:"webform-small-button webform-small-button-blue"},text:BX.message("EC_SEC_SLIDER_SAVE"),events:{click:BX.proxy(this.save,this)}}));this.cancelBtn=this.buttonsWrap.appendChild(BX.create("SPAN",{props:{className:"webform-button-link"},text:BX.message("EC_SEC_SLIDER_CANCEL"),events:{click:BX.proxy(this.close,this)}}));this.isCreated=true},save:function(){var h=this.calendar.sectionController.getSuperposedSectionList(),l=[],k=[],j,g;for(g=0;g<h.length;g++){if(h[g].type!="user"){l.push(parseInt(h[g].id))}}for(j in this.sectionIndex){if(this.sectionIndex.hasOwnProperty(j)){if(BX.hasClass(this.sectionIndex[j].checkbox,this.CHECKED_CLASS)){if(!BX.util.in_array(j,l)){l.push(parseInt(j))}}else{if(BX.util.in_array(j,l)){l=BX.util.deleteFromArray(l,BX.util.array_search(j,l))}}}}this.calendar.request({data:{action:"set_tracking_sections",codes:this.destinationSelector.getCodes(),sect:l,type:"users"},handler:BX.delegate(function(i){BX.reload()},this)});this.close()},updateSectionList:function(){var g=this.destinationSelector.getCodes();this.sectionsWrap.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"140px"}}));this.calendar.request({data:{action:"get_tracking_sections",codes:g||[],type:"users"},handler:BX.delegate(function(h){BX.cleanNode(this.sectionsWrap);this.sectionIndex={};h.users.forEach(function(i){var j=h.sections.filter(function(k){return k.OWNER_ID==i.ID});this.sectionsWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-card-section-title"},html:'<span class="calendar-list-slider-card-section-title-text">'+BX.util.htmlspecialchars(i.FORMATTED_NAME)+"</span>"}));if(j.length>0){this.createSectionBlock({sectionList:j,wrap:this.sectionsWrap})}else{this.sectionsWrap.appendChild(BX.create("DIV",{props:{className:""},html:'<span class="">'+BX.message("EC_SEC_SLIDER_NO_SECTIONS")+"</span>"}))}},this)},this)})},createSectionBlock:function(n){var h=false;if(n.sectionList&&n.sectionList.length){var k=n.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-widget-content"}})).appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-widget-content-block"}})).appendChild(BX.create("UL",{props:{className:"calendar-list-slider-container"}}));BX.bind(k,"click",BX.proxy(this.sectionClick,this));var j,g,l,m,o;for(j=0;j<n.sectionList.length;j++){o=n.sectionList[j].ID.toString();g=k.appendChild(BX.create("LI",{props:{className:"calendar-list-slider-item"},attrs:{"data-bx-calendar-section":o}}));l=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-item-checkbox"},style:{backgroundColor:n.sectionList[j].COLOR}}));m=g.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-item-name"},text:n.sectionList[j].NAME}));this.sectionIndex[o]={item:g,checkbox:l};if(this.selected[o]){BX.addClass(l,this.CHECKED_CLASS)}}}return h},sectionClick:function(h){var g=this.calendar.util.findTargetNode(h.target||h.srcElement,this.outerWrap);if(g&&g.getAttribute){if(g.getAttribute("data-bx-calendar-section")!==null){var i=g.getAttribute("data-bx-calendar-section");if(this.sectionIndex[i]&&this.sectionIndex[i].checkbox){if(BX.hasClass(this.sectionIndex[i].checkbox,this.CHECKED_CLASS)){BX.removeClass(this.sectionIndex[i].checkbox,this.CHECKED_CLASS)}else{BX.addClass(this.sectionIndex[i].checkbox,this.CHECKED_CLASS)}}}}},keyHandler:function(g){if(g.keyCode==this.calendar.util.KEY_CODES.escape){this.close()}else{if(g.keyCode==this.calendar.util.KEY_CODES.enter){this.save()}}}};function d(g){e.apply(this,arguments);this.trackingGroups=g.trackingGroups||[];this.selectGroups=true;this.selectUsers=false;this.addLinkMessage=BX.message("EC_SEC_SLIDER_SELECT_GROUPS")}d.prototype=Object.create(e.prototype);d.prototype.constructor=d;d.prototype.create=function(){this.sectionsWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-sections-wrap"}}));this.buttonsWrap=this.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-list-slider-btn-container"}}));this.saveBtn=this.buttonsWrap.appendChild(BX.create("DIV",{props:{className:"webform-small-button webform-small-button-blue"},text:BX.message("EC_SEC_SLIDER_SAVE"),events:{click:BX.proxy(this.save,this)}}));this.cancelBtn=this.buttonsWrap.appendChild(BX.create("SPAN",{props:{className:"webform-button-link"},text:BX.message("EC_SEC_SLIDER_CANCEL"),events:{click:BX.proxy(this.close,this)}}));this.isCreated=true};d.prototype.show=function(){if(!this.isCreated){this.create()}this.updateSectionList();this.isOpenedState=true;BX.addClass(this.outerWrap,"show")};d.prototype.updateSectionList=function(){this.sectionsWrap.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"140px"}}));this.calendar.request({data:{action:"get_tracking_sections",type:"company"},handler:BX.delegate(function(g){BX.cleanNode(this.sectionsWrap);this.sectionIndex={};this.createSectionBlock({sectionList:g.sections,wrap:this.sectionsWrap})},this)})};d.prototype.save=function(){var h=this.calendar.sectionController.getSuperposedSectionList(),k=[],j,g;for(g=0;g<h.length;g++){k.push(parseInt(h[g].id))}for(j in this.sectionIndex){if(this.sectionIndex.hasOwnProperty(j)){if(BX.hasClass(this.sectionIndex[j].checkbox,this.CHECKED_CLASS)){if(!BX.util.in_array(j,k)){k.push(parseInt(j))}}else{if(BX.util.in_array(j,k)){k=BX.util.deleteFromArray(k,BX.util.array_search(j,k))}}}}this.calendar.request({data:{action:"set_tracking_sections",sect:k},handler:BX.delegate(function(i){BX.reload()},this)});this.close()};function a(g){e.apply(this,arguments);this.trackingGroups=g.trackingGroups||[];this.selectorId=this.calendar.id+"_tracking_groups";this.selectGroups=true;this.selectUsers=false;this.addLinkMessage=BX.message("EC_SEC_SLIDER_SELECT_GROUPS")}a.prototype=Object.create(e.prototype);a.prototype.constructor=a;a.prototype.show=function(){this.trackingGroups.forEach(function(g){this.selectedCodes["SG"+g]="sonetgroups"},this);e.prototype.show.apply(this,arguments)};a.prototype.save=function(){var h=this.calendar.sectionController.getSuperposedSectionList(),k=[],j,g;for(g=0;g<h.length;g++){k.push(parseInt(h[g].id))}for(j in this.sectionIndex){if(this.sectionIndex.hasOwnProperty(j)){if(BX.hasClass(this.sectionIndex[j].checkbox,this.CHECKED_CLASS)){if(!BX.util.in_array(j,k)){k.push(parseInt(j))}}else{if(BX.util.in_array(j,k)){k=BX.util.deleteFromArray(k,BX.util.array_search(j,k))}}}}this.calendar.request({data:{action:"set_tracking_sections",codes:this.destinationSelector.getCodes(),sect:k,type:"groups"},handler:BX.delegate(function(i){BX.reload()},this)});this.close()};a.prototype.updateSectionList=function(){var g=this.destinationSelector.getCodes();this.sectionsWrap.appendChild(BX.adjust(this.calendar.util.getLoader(),{style:{height:"140px"}}));this.calendar.request({data:{action:"get_tracking_sections",codes:g||[],type:"groups"},handler:BX.delegate(function(h){BX.cleanNode(this.sectionsWrap);this.sectionIndex={};this.createSectionBlock({sectionList:h.sections,wrap:this.sectionsWrap})},this)})};if(c.BXEventCalendar){c.BXEventCalendar.SectionSlider=b}else{BX.addCustomEvent(c,"onBXEventCalendarInit",function(){c.BXEventCalendar.SectionSlider=b})}})(window);