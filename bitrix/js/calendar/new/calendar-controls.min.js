(function(h){function f(i){this.calendar=i.calendar;this.wrap=i.wrap;this.id=this.calendar.id+"_top_add_button";this.create()}f.prototype={create:function(){this.button=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button webform-small-button-blue"},html:BX.message("EC_ADD"),events:{click:BX.proxy(this.addEntry,this)}}));this.menuItems=[{text:BX.message("EC_ADD_EVENT"),onclick:BX.proxy(this.addEntry,this)}];if(this.calendar.showTasks){this.menuItems.push({text:BX.message("EC_ADD_TASK"),onclick:BX.proxy(this.addTask,this)})}if(this.menuItems.length>1){BX.addClass(this.wrap,"webform-small-button-separate-wrap");this.addButtonMore=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-right-part"},events:{click:BX.proxy(this.showPopup,this)}}))}},showPopup:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){return this.menuPopup.close()}this.menuPopup=BX.PopupMenu.create(this.id,this.addButtonMore,this.menuItems,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:15,angle:true});this.menuPopup.show();BX.addCustomEvent(this.menuPopup.popupWindow,"onPopupClose",BX.delegate(function(){BX.PopupMenu.destroy(this.addButtonMorePopupId)},this))},addEntry:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){this.menuPopup.close()}if(!this.calendar.editSlider){this.calendar.editSlider=new h.BXEventCalendar.EditEntrySlider(this.calendar)}this.calendar.editSlider.show({})},addTask:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){this.menuPopup.close()}BX.SidePanel.Instance.open(this.calendar.util.getEditTaskPath(),{loader:"task-new-loader"})}};function b(i){this.id=i.id||"bx-select-input-"+Math.round(Math.random()*1000000);this.values=i.values||false;this.input=i.input;this.defaultValue=i.defaultValue||"";this.openTitle=i.openTitle||"";this.className=i.className||"";this.currentValue=i.value;this.currentValueIndex=i.valueIndex;this.onChangeCallback=i.onChangeCallback||null;this.zIndex=i.zIndex||1200;this.disabled=i.disabled;if(this.onChangeCallback){BX.bind(this.input,"change",this.onChangeCallback);BX.bind(this.input,"keyup",this.onChangeCallback)}if(this.currentValueIndex!==undefined&&this.values[this.currentValueIndex]){this.input.value=this.values[this.currentValueIndex].label}this.curInd=false;if(this.values){BX.bind(this.input,"click",BX.proxy(this.onClick,this));BX.bind(this.input,"focus",BX.proxy(this.onFocus,this));BX.bind(this.input,"blur",BX.proxy(this.onBlur,this));BX.bind(this.input,"keyup",BX.proxy(this.onKeyup,this))}}b.prototype={showPopup:function(){if(this.shown||this.disabled){return}var p=0,k=0,m=[],l,q=this;for(l=0;l<this.values.length;l++){if(this.values[l].delimiter){m.push(this.values[l])}else{if(this.currentValue&&this.values[l]&&this.values[l].value==this.currentValue.value){p=k}m.push({id:this.values[l].value,text:this.values[l].label,onclick:this.values[l].callback||(function(j,i){return function(){q.input.value=i;q.popupMenu.close();q.onChange()}})(this.values[l].value,this.values[l].labelRaw||this.values[l].label)});k++}}this.popupMenu=BX.PopupMenu.create(this.id,this.input,m,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:0});this.popupMenu.popupWindow.setWidth(this.input.offsetWidth-2);var o=this.popupMenu.layout.menuContainer;BX.addClass(this.popupMenu.layout.menuContainer,"calendar-select-popup");this.popupMenu.show();var n=this.popupMenu.menuItems[p];if(n&&n.layout){o.scrollTop=n.layout.item.offsetTop-n.layout.item.offsetHeight}BX.addCustomEvent(this.popupMenu.popupWindow,"onPopupClose",function(){BX.PopupMenu.destroy(q.id);q.shown=false});this.input.select();this.shown=true},closePopup:function(){BX.PopupMenu.destroy(this.id);this.shown=false},onFocus:function(){setTimeout(BX.delegate(function(){if(!this.shown){this.showPopup()}},this),200)},onClick:function(){if(this.shown){this.closePopup()}else{this.showPopup()}},onBlur:function(){setTimeout(BX.delegate(this.closePopup,this),200)},onKeyup:function(){setTimeout(BX.delegate(this.closePopup,this),50)},onChange:function(){var i=this.input.value;BX.onCustomEvent(this,"onSelectInputChanged",[this,i]);if(this.onChangeCallback&&typeof this.onChangeCallback=="function"){this.onChangeCallback({value:i})}},destroy:function(){if(this.onChangeCallback){BX.unbind(this.input,"change",this.onChangeCallback);BX.unbind(this.input,"keyup",this.onChangeCallback)}BX.unbind(this.input,"click",BX.proxy(this.onClick,this));BX.unbind(this.input,"focus",BX.proxy(this.onFocus,this));BX.unbind(this.input,"blur",BX.proxy(this.onBlur,this));BX.unbind(this.input,"keyup",BX.proxy(this.onKeyup,this));if(this.popupMenu){this.popupMenu.close()}BX.PopupMenu.destroy(this.id);this.shown=false}};function a(k){this.controlList={};this.selectedValues=[];this.values=k.values;this.addButton=k.addButtonNode;this.valuesWrap=k.valuesContainerNode;this.changeCallack=k.changeCallack;this.showPopupCallBack=k.showPopupCallBack;this.hidePopupCallBack=k.hidePopupCallBack;this.id=k.id||"reminder-"+Math.round(Math.random()*1000000);this.zIndex=k.zIndex||3200;BX.unbind(this.addButton,"click",BX.proxy(this.showPopup,this));BX.bind(this.addButton,"click",BX.proxy(this.showPopup,this));if(k.selectedValues&&k.selectedValues.length>0){for(var j=0;j<k.selectedValues.length;j++){this.addValue(k.selectedValues[j])}}}a.prototype={showPopup:function(){var l=this,k,j=[];for(k=0;k<this.values.length;k++){if(!BX.util.in_array(this.values[k].value,this.selectedValues)){j.push({text:this.values[k].label,onclick:(function(i){return function(){l.addValue(i);l.reminderMenu.close()}})(this.values[k].value)})}}this.reminderMenu=BX.PopupMenu.create(this.id,this.addButton,j,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:9,angle:true});this.reminderMenu.show();if(this.showPopupCallBack){this.showPopupCallBack()}BX.addCustomEvent(l.reminderMenu.popupWindow,"onPopupClose",function(){if(l.hidePopupCallBack){l.hidePopupCallBack()}BX.PopupMenu.destroy(l.id)})},addValue:function(m){var j,k,l,n=this;for(j=0;j<this.values.length;j++){if(this.values[j].value==m&&m>=0&&!BX.util.in_array(m,this.selectedValues)){if(!this.selectedValues.length){BX.cleanNode(this.valuesWrap)}k=this.valuesWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-reminder-item"},text:this.values[j].shortLabel||this.values[j].label}));l=k.appendChild(BX.create("SPAN",{props:{className:"calendar-reminder-clear-icon"},events:{click:function(){n.removeValue(m)}}}));this.selectedValues.push(m);this.controlList[m]=k;break}}if(this.selectedValues.length==this.values.length){this.addButton.style.display="none"}if(this.changeCallack){this.changeCallack(this.selectedValues)}},removeValue:function(i){if(this.controlList[i]&&BX.isNodeInDom(this.controlList[i])){BX.cleanNode(this.controlList[i],true)}this.selectedValues=BX.util.deleteFromArray(this.selectedValues,BX.util.array_search(i,this.selectedValues));if(this.selectedValues.length<this.values.length){this.addButton.style.display=""}if(!this.selectedValues.length){this.valuesWrap.appendChild(BX.create("SPAN",{props:{className:""},text:" "+BX.message("EC_REMIND_NO")}))}if(this.changeCallack){this.changeCallack(this.selectedValues)}}};function e(j,i){this.params=i;this.id=j;this.calendar=i.calendar;this.zIndex=i.zIndex||3100;this.wrapNode=i.wrapNode;this.destinationInputName=i.inputName||"EVENT_DESTINATION";if(this.params.itemsSelected&&this.params.itemsSelected.length){this.params.itemsSelected=this.convertAttendeesCodes(this.params.itemsSelected)}this.create()}e.prototype={create:function(){var i=this.id;this.socnetDestinationWrap=this.wrapNode.appendChild(BX.create("DIV",{props:{className:"event-grid-dest-wrap"},events:{click:function(j){BX.SocNetLogDestination.openDialog(i);BX.PreventDefault(j)}}}));this.socnetDestinationItems=this.socnetDestinationWrap.appendChild(BX.create("SPAN",{props:{className:""},events:{click:function(k){var j=k.target||k.srcElement;if(j.className=="feed-event-del-but"){BX.SocNetLogDestination.deleteItem(j.getAttribute("data-item-id"),j.getAttribute("data-item-type"),i);k.preventDefault();k.stopPropagation()}},mouseover:function(k){var j=k.target||k.srcElement;if(j.className=="feed-event-del-but"){BX.addClass(j.parentNode,"event-grid-dest-hover")}},mouseout:function(k){var j=k.target||k.srcElement;if(j.className=="feed-event-del-but"){BX.removeClass(j.parentNode,"event-grid-dest-hover")}}}}));this.socnetDestinationInputWrap=this.socnetDestinationWrap.appendChild(BX.create("SPAN",{props:{className:"feed-add-destination-input-box"}}));this.socnetDestinationInput=this.socnetDestinationInputWrap.appendChild(BX.create("INPUT",{props:{id:i+"-inp",className:"feed-add-destination-inp"},attrs:{value:"",type:"text"},events:{keydown:function(j){return BX.SocNetLogDestination.searchBeforeHandler(j,{formName:i,inputId:i+"-inp"})},keyup:function(j){return BX.SocNetLogDestination.searchHandler(j,{formName:i,inputId:i+"-inp",linkId:"event-grid-dest-add-link",sendAjax:true})}}}));this.socnetDestinationLink=this.socnetDestinationWrap.appendChild(BX.create("SPAN",{html:this.params.addLinkMessage||BX.message("EC_DESTINATION_ADD_USERS"),props:{id:i+"-link",className:"feed-add-destination-link"},events:{keydown:function(j){return BX.SocNetLogDestination.searchBeforeHandler(j,{formName:i,inputId:i+"-inp"})},keyup:function(j){return BX.SocNetLogDestination.searchHandler(j,{formName:i,inputId:i+"-inp",linkId:"event-grid-dest-add-link",sendAjax:true})}}}));this.params.items=this.calendar.util.getSocnetDestinationConfig("items");this.params.itemsLast=this.calendar.util.getSocnetDestinationConfig("itemsLast");if(this.params.itemsSelected&&!this.checkItemsSelected(this.params.items,this.params.itemsLast,this.params.itemsSelected,BX.proxy(this.init,this))){return}this.init()},init:function(){if(!this.socnetDestinationInput||!this.socnetDestinationWrap){return}var i=this;if(this.params.selectGroups===false){this.params.items.groups={};this.params.items.department={};this.params.items.sonetgroups={}}if(this.params.selectUsers===false){this.params.items.users={};this.params.items.groups={};this.params.items.department={}}BX.SocNetLogDestination.init({name:this.id,searchInput:this.socnetDestinationInput,extranetUser:false,userSearchArea:"I",bindMainPopup:{node:this.socnetDestinationWrap,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:this.socnetDestinationWrap,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.proxy(this.selectCallback,this),unSelect:BX.proxy(this.unSelectCallback,this),openDialog:BX.proxy(this.openDialogCallback,this),closeDialog:BX.proxy(this.closeDialogCallback,this),openSearch:BX.proxy(this.openDialogCallback,this),closeSearch:function(){i.closeDialogCallback(true)}},items:this.params.items,itemsLast:this.params.itemsLast,itemsSelected:this.params.itemsSelected,departmentSelectDisable:this.params.selectGroups===false})},checkItemsSelected:function(k,n,l,o){var j=[];for(var m in l){if(l.hasOwnProperty(m)){if(l[m]=="users"&&!k.users[m]){j.push(m)}}}if(j.length>0){var i=this.socnetDestinationWrap.appendChild(BX.adjust(this.calendar.util.getLoader(40),{style:{height:"50px"}}));this.calendar.request({type:"get",data:{action:"get_destination_items",codes:j},handler:BX.delegate(function(p){if(i){BX.remove(i)}this.calendar.util.mergeSocnetDestinationConfig(p.destinationItems);this.params.items=this.calendar.util.getSocnetDestinationConfig("items");this.params.itemsLast=this.calendar.util.getSocnetDestinationConfig("itemsLast");if(o&&typeof o=="function"){o()}},this)});return false}return true},closeAll:function(){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()},selectCallback:function(k,j){var i=j,l="S";if(j=="sonetgroups"){l="SG"}else{if(j=="groups"){l="UA";i="all-users"}else{if(j=="users"){l="U"}else{if(j=="department"){l="DR"}}}}this.socnetDestinationItems.appendChild(BX.create("span",{attrs:{"data-id":k.id},props:{className:"event-grid-dest event-grid-dest-"+i},children:[BX.create("input",{attrs:{type:"hidden",name:this.destinationInputName+"["+l+"][]",value:k.id}}),BX.create("span",{props:{className:"event-grid-dest-text"},html:k.name}),BX.create("span",{props:{className:"feed-event-del-but"},attrs:{"data-item-id":k.id,"data-item-type":j}})]}));BX.onCustomEvent("OnDestinationAddNewItem",[k]);this.socnetDestinationInput.value="";this.socnetDestinationLink.innerHTML=this.params.addLinkMessage||(BX.SocNetLogDestination.getSelectedCount(this.id)>0?BX.message("EC_DESTINATION_ADD_MORE"):BX.message("EC_DESTINATION_ADD_USERS"))},unSelectCallback:function(m,l,k){var n=BX.findChildren(this.socnetDestinationItems,{attribute:{"data-id":m.id}},true);if(n!=null){for(var i=0;i<n.length;i++){BX.remove(n[i])}}BX.onCustomEvent("OnDestinationUnselect");this.socnetDestinationInput.value="";this.socnetDestinationLink.innerHTML=this.params.addLinkMessage||(BX.SocNetLogDestination.getSelectedCount(this.id)>0?BX.message("EC_DESTINATION_ADD_MORE"):BX.message("EC_DESTINATION_ADD_USERS"))},openDialogCallback:function(){if(BX.SocNetLogDestination.popupWindow){BX.SocNetLogDestination.popupWindow.params.zIndex=this.zIndex;BX.SocNetLogDestination.popupWindow.popupContainer.style.zIndex=this.zIndex}if(BX.SocNetLogDestination.popupSearchWindow){BX.SocNetLogDestination.popupSearchWindow.params.zIndex=this.zIndex;BX.SocNetLogDestination.popupSearchWindow.popupContainer.style.zIndex=this.zIndex}BX.style(this.socnetDestinationInputWrap,"display","inline-block");BX.style(this.socnetDestinationLink,"display","none");BX.focus(this.socnetDestinationInput)},closeDialogCallback:function(i){if(!BX.SocNetLogDestination.isOpenSearch()&&this.socnetDestinationInput.value.length<=0){BX.style(this.socnetDestinationInputWrap,"display","none");BX.style(this.socnetDestinationLink,"display","inline-block");if(i===true){this.socnetDestinationInput.value=""}if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!=null){BX.unbind(h,"keydown",BX.SocNetLogDestination.backspaceDisable)}BX.bind(h,"keydown",BX.SocNetLogDestination.backspaceDisable=function(j){if(j.keyCode==8){j.preventDefault();return false}});setTimeout(function(){BX.unbind(h,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5000)}},getCodes:function(){var l=this.socnetDestinationItems.getElementsByTagName("INPUT"),j=[],k;for(k=0;k<l.length;k++){j.push(l[k].value)}return j},getAttendeesCodes:function(){var m=this.socnetDestinationItems.getElementsByTagName("INPUT"),j=[],k,l;for(k=0;k<m.length;k++){j.push(m[k].value)}return this.convertAttendeesCodes(j)},convertAttendeesCodes:function(i){var j={};i.forEach(function(k){if(k.substr(0,2)=="DR"){j[k]="department"}else{if(k.substr(0,2)=="UA"){j[k]="groups"}else{if(k.substr(0,2)=="SG"){j[k]="sonetgroups"}else{if(k.substr(0,1)=="U"){j[k]="users"}}}}});return j},getAttendeesCodesList:function(k){var j=[];if(!k){k=this.getAttendeesCodes()}for(var l in k){if(k.hasOwnProperty(l)){j.push(l)}}return j}};function d(k,j,i){this.params=j;this.id=k;this.zIndex=j.zIndex||3100;this.DOM={wrapNode:j.wrapNode};this.calendar=i;this.disabled=!this.calendar.util.isRichLocationEnabled();this.value={type:"",text:"",value:""};if(j.value&&typeof j.value==="object"){this.value.text=j.value.text||"";this.value.type=j.value.type||"";this.value.value=j.value.value||""}else{if(j.value&&j.value!==""){this.value=this.calendar.util.parseLocation(j.value)}}this.create()}d.prototype={create:function(){this.DOM.inputWrap=this.DOM.wrapNode.appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}}));if(this.disabled){BX.addClass(this.DOM.wrapNode,"locked");this.DOM.inputWrap.appendChild(BX.create("DIV",{props:{className:"calendar-lock-icon"},events:{click:function(){B24.licenseInfoPopup.show("calendar_location",BX.message("EC_B24_LOCATION_LIMITATION_TITLE"),BX.message("EC_B24_LOCATION_LIMITATION"))}}}))}this.DOM.input=this.DOM.inputWrap.appendChild(BX.create("INPUT",{attrs:{name:this.params.inputName||"",placeholder:BX.message("EC_LOCATION_LABEL"),type:"text"},props:{className:"calendar-field calendar-field-select"}}));this.setValues()},setValues:function(){if(this.selectContol){this.selectContol.destroy()}var l=[],m=this.calendar.util.getMeetingRoomList(),n=this.calendar.util.getLocationList(),j=false;if(m&&m.length){for(k=0;k<m.length;k++){l.push({ID:parseInt(m[k].ID),label:BX.util.htmlspecialchars(m[k].NAME),value:m[k].ID,type:"mr"});if(this.value.type=="mr"&&this.value.value==m[k].ID){j=l.length-1}}l.push({delimiter:true})}if(!n||!n.length){l.push({label:BX.message("EC_ADD_LOCATION"),callback:BX.delegate(this.editMeetingRooms,this)})}else{var k;for(k=0;k<n.length;k++){l.push({ID:parseInt(n[k].ID),label:BX.util.htmlspecialchars(n[k].NAME),labelRaw:n[k].NAME,value:parseInt(n[k].ID),type:"calendar"});if(this.value.type=="calendar"&&this.value.value==n[k].ID){j=l.length-1}}l.push({delimiter:true});l.push({label:BX.message("EC_LOCATION_MEETING_ROOM_SET"),callback:BX.delegate(this.editMeetingRooms,this)})}if(this.value){this.DOM.input.value=this.value.str||"";if(this.value.type&&this.value.str==this.calendar.util.getTextLocation(this.value)){this.DOM.input.value=BX.message("EC_LOCATION_404")}}if(this.selectContol){this.selectContol.destroy()}this.selectContol=new b({input:this.DOM.input,values:l,valueIndex:j,zIndex:this.zIndex,disabled:this.disabled,onChangeCallback:BX.delegate(function(){var o,p=this.DOM.input.value;this.value={text:p};for(o=0;o<l.length;o++){if(l[o].label===p){this.value.type=l[o].type;this.value.value=l[o].value;break}}if(this.params.onChangeCallback&&typeof this.params.onChangeCallback=="function"){this.params.onChangeCallback()}},this)})},editMeetingRooms:function(){var i={};if(this.params.getControlContentCallback){i.wrap=this.params.getControlContentCallback()}if(!i.wrap){i.wrap=this.showEditMeetingRooms()}this.buildLocationEditControl(i)},showEditMeetingRooms:function(){var i=this;if(this.editDialog){this.editDialog.destroy()}this.editDialogContent=BX.create("DIV");this.editDialog=new BX.PopupWindow(this.id+"_popup",null,{overlay:{opacity:10},autoHide:true,closeByEsc:true,zIndex:this.zIndex,offsetLeft:0,offsetTop:0,draggable:true,bindOnResize:false,titleBar:BX.message("EC_MEETING_ROOM_LIST_TITLE"),closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButton({text:BX.message("EC_SEC_SLIDER_SAVE"),events:{click:function(){i.saveValues();if(i.editDialog){i.editDialog.close()}}}}),new BX.PopupWindowButtonLink({text:BX.message("EC_SEC_SLIDER_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){if(i.editDialog){i.editDialog.close()}}}})],content:this.editDialogContent,events:{}});this.editDialog.show();return this.editDialogContent},buildLocationEditControl:function(l){var m=this,j;this.locationEditControlShown=true;this.editDialogWrap=l.wrap;var k=this.calendar.util.getLocationList();this.locationList=[];this.addNewButtonField=false;for(j=0;j<k.length;j++){this.locationList.push({id:k[j].ID,name:k[j].NAME})}if(!this.locationList.length){this.locationList.push({id:0,name:""})}for(j=0;j<this.locationList.length;j++){this.addRoomField(this.locationList[j],l.wrap)}this.addNewButtonField={outerWrap:l.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-container calendar-field-container-container-text"}}))};this.addNewButtonField.innerWrap=this.addNewButtonField.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}}));this.addNewButtonField.innerCont=this.addNewButtonField.innerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-text"},html:'<span class="calendar-text-link">'+BX.message("EC_MEETING_ROOM_ADD")+"</span>",events:{click:function(){var i=m.locationList[m.locationList.length-1];if(i.id||i.deleted||BX.util.trim(i.field.input.value)){m.locationList.push(m.addRoomField({id:0},l.wrap))}}}}));l.wrap.appendChild(this.addNewButtonField.outerWrap)},addRoomField:function(i){i.field={outerWrap:this.editDialogWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-container calendar-field-container-string"}}))};i.field.innerWrap=i.field.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}}));var j=this;i.field.innerWrap.style.paddingRight="40px";i.field.input=i.field.innerWrap.appendChild(BX.create("INPUT",{props:{className:"calendar-field calendar-field-string"},attrs:{value:i.name||"",placeholder:BX.message("EC_MEETING_ROOM_PLACEHOLDER"),type:"text"},events:{keyup:function(k){if(k.keyCode==13){j.editRoom(i)}}}}));i.field.delRoomEntry=i.field.innerWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-remove-filed"},events:{click:function(){j.deleteField(i)}}}));if(this.addNewButtonField){this.editDialogWrap.appendChild(this.addNewButtonField.outerWrap)}if(!i.id){i.field.input.focus()}return i},editRoom:function(i){if(!this.locationEditControlShown){return}i.field.input.value=BX.util.trim(i.field.input.value);if(!i.id){if(i.field.input.value&&i.field.input.value!=i.name){i.name=i.field.input.value;this.locationList.push(this.addRoomField({id:0}))}}else{if(i.field.input.value!=i.name){i.name=i.field.input.value;i.changed=true}}},deleteField:function(i){BX.remove(i.field.outerWrap,true);i.deleted=true;i.changed=true},saveValues:function(){var j,k=[];for(j=0;j<this.locationList.length;j++){if(this.locationList[j].field&&this.locationList[j].field.input){if(this.locationList[j].name!==this.locationList[j].field.input.value&&this.locationList[j].id){this.locationList[j].changed=true}this.locationList[j].name=this.locationList[j].field.input.value}if((!this.locationList[j].deleted&&this.locationList[j].name)||this.locationList[j].id){k.push({id:this.locationList[j].id||0,name:this.locationList[j].name||"",changed:(this.locationList[j].changed||!this.locationList[j].id)?"Y":"N",deleted:(this.locationList[j].deleted||!this.locationList[j].name)?"Y":"N"})}}this.calendar.request({type:"post",data:{action:"update_location_list",data:k},handler:BX.delegate(function(i){this.calendar.util.setLocationList(i.locationList);this.setValues()},this)});this.locationEditControlShown=false},getTextValue:function(j){if(!j){j=this.value}var i=j.text||"";if(j&&j.type=="mr"){i="ECMR_"+j.value}else{if(j&&j.type=="calendar"){i="calendar_"+j.value}}return i},getValue:function(){return this.value}};function g(i,j){this.calendar=i;this.outerWrap=j.wrap;this.created=false}g.prototype={show:function(){if(!this.created){this.smallCalendar=new BX.JCCalendar();this.smallCalendar.month_popup_classname="calendar-navi-month-popup";this.smallCalendar.year_popup_classname="calendar-navi-year-popup";this.smallCalendar.Show({node:this.outerWrap,callback_after:BX.proxy(this.changeDate,this),bTime:false});this.outerWrap.appendChild(this.smallCalendar.DIV);this.smallCalendar.popup.close();this.created=true;BX.addCustomEvent(this.calendar,"changeViewRange",BX.proxy(this.setDate,this))}this.outerWrap.style.display=""},hide:function(){this.outerWrap.style.display="none"},changeDate:function(i){if(i&&this.calendar.util.getDayCode(this.calendar.getViewRangeDate())!=this.calendar.util.getDayCode(i)&&this.calendar.getView()){this.calendar.getView().adjustViewRangeToDate(i)}},setDate:function(i){if(i&&this.smallCalendar.value&&this.calendar.util.getDayCode(this.smallCalendar.value)!=this.calendar.util.getDayCode(i)){i.setHours(12,0);this.smallCalendar.SetValue(i)}}};function c(i){this.calendar=i}c.prototype={reset:function(){jsDD.Reset()},registerDay:function(i){var j=i.node;jsDD.registerDest(j);j.onbxdestdragfinish=BX.delegate(function(){if(this.draggedNode){var l=this.currentState.entry;i.date.setHours(0,0,0,0);l.from.setFullYear(i.date.getFullYear(),i.date.getMonth(),i.date.getDate());l.to=new Date(l.from.getTime()+(l.data.DT_LENGTH-(l.fullDay?1:0))*1000);l.startDayCode=l.from;l.endDayCode=l.to;l.opacity="0";this.calendar.getView().displayEntries({reloadEntries:false});var k=l.getWrap(0);BX.addClass(this.draggedNode,"animate");setTimeout(BX.delegate(function(){this.draggedNode.style.top=BX.pos(k).top+"px";this.draggedNode.style.left=BX.pos(k).left+"px"},this),1);setTimeout(BX.delegate(function(){delete l.opacity;l.parts.forEach(function(m){m.params.wrapNode.style.opacity=""});BX.remove(this.draggedNode)},this),300);this.calendar.entryController.moveEventToNewDate(this.currentState.entry,i.date);BX.removeClass(j,"calendar-grid-drag-select")}return true},this);j.onbxdestdraghover=function(){BX.addClass(j,"calendar-grid-drag-select")};j.onbxdestdraghout=function(){BX.removeClass(j,"calendar-grid-drag-select")}},registerTimelineDay:function(i){var j=i.node;jsDD.registerDest(j);j.onbxdestdragfinish=BX.delegate(function(k){if(k.getAttribute("data-bx-entry-resizer")=="Y"&&this.resizedState){this.calendar.entryController.moveEventToNewDate(this.resizedState.entry,this.resizedState.entry.from,this.resizedState.entry.to);return true}else{if(this.draggedNode){var m=this.currentState.entry;m.from.setFullYear(i.date.getFullYear(),i.date.getMonth(),i.date.getDate());m.to=new Date(m.from.getTime()+(m.data.DT_LENGTH-(m.fullDay?1:0))*1000);if(this.calendar.util.getDayCode(m.from)!=this.calendar.util.getDayCode(m.to)&&m.to.getHours()==0&&m.to.getMinutes()==0){m.to=new Date(m.to.getTime()-1000*60)}m.startDayCode=m.from;m.endDayCode=m.to;m.opacity="0";this.calendar.getView().displayEntries({reloadEntries:false});var l=m.getWrap(0);BX.addClass(this.draggedNode,"animate");setTimeout(BX.delegate(function(){var n=BX.pos(l);this.draggedNode.style.top=n.top+"px";this.draggedNode.style.left=n.left+"px";this.draggedNode.style.height=n.height+"px";this.draggedNode.style.width=n.width+"px";this.draggedNode.style.opacity="0.6"},this),1);setTimeout(BX.delegate(function(){delete m.opacity;m.parts.forEach(function(n){n.params.wrapNode.style.opacity=""});BX.remove(this.draggedNode)},this),250);this.calendar.entryController.moveEventToNewDate(this.currentState.entry,m.from,m.to);BX.removeClass(j,"calendar-timeline-drag-select")}}return true},this);j.onbxdestdraghover=BX.delegate(function(){if(this.draggedNode){var k=(BX.pos(j).left+4);if(Math.abs(k-parseInt(this.draggedNode.style.left))>30){BX.addClass(this.draggedNode,"animate");setTimeout(BX.delegate(function(){this.draggedNode.style.left=(BX.pos(j).left+4)+"px"},this),1);if(this.clearAnimateTimeout){clearTimeout(this.clearAnimateTimeout)}this.clearAnimateTimeout=setTimeout(BX.delegate(function(){BX.removeClass(this.draggedNode,"animate")},this),300)}BX.addClass(j,"calendar-timeline-drag-select")}},this);j.onbxdestdraghout=BX.delegate(function(){if(this.draggedNode){BX.removeClass(j,"calendar-timeline-drag-select")}},this)},registerEntry:function(i,k){var j=this.calendar.entryController.canDo(k.entry,"edit");jsDD.registerObject(i);i.onbxdragstart=BX.delegate(function(){if(!j){this.draggedNode=false;BX.addClass(i,"calendar-entry-shake-mode");if(this.denyDragTimeout){clearTimeout(this.denyDragTimeout)}this.denyDragTimeout=setTimeout(function(){BX.removeClass(i,"calendar-entry-shake-mode")},1000);return}this.currentState=k;this.draggedNode=document.body.appendChild(i.cloneNode(true));i.style.opacity="0.3";BX.addClass(this.draggedNode,"calendar-entry-drag-mode");BX.removeClass(this.draggedNode,"calendar-event-line-start-yesterday");BX.removeClass(this.draggedNode,"calendar-event-line-finish-tomorrow");if(this.calendar.currentViewName=="week"||this.calendar.currentViewName=="day"){this.draggedNode.style.left=(BX.pos(i).left+2)+"px";this.draggedNode.style.width=(this.calendar.getView().getDayWidth()-5)+"px";this.currentState.offtimeTuneBaseZeroPos=BX.pos(this.calendar.getView().timeLinesCont).top;this.currentState.bottomBasePos=BX.pos(this.calendar.getView().bottomOffHours).bottom-2}else{this.draggedNode.style.width=this.calendar.getView().getDayWidth()+"px"}var n=this.currentState.entry,r=n.getLengthInDays(),q=this.draggedNode.querySelector(".calendar-event-resizer"),l=this.draggedNode.querySelector(".calendar-event-line-inner-container"),m=this.draggedNode.querySelector(".calendar-event-block-background"),o=this.draggedNode.querySelector(".calendar-event-line-inner");if(r>1){var p=this.draggedNode.querySelector(".calendar-event-line-text");if(p){p.innerHTML='<span class="calendar-event-line-days-count">('+BX.message("EC_DAY_LENGTH").replace("#COUNT#",r)+")</span> "+p.innerHTML}}if(l){if(n.isFullDay()){l.style.backgroundColor=this.calendar.util.hexToRgba(n.color,0.7);l.style.borderColor=this.calendar.util.hexToRgba(n.color,0.7)}else{if(n.isLongWithTime()){l.style.borderColor=this.calendar.util.hexToRgba(n.color,0.7)}}}if(m){m.style.opacity="0.45"}if(o){o.style.maxWidth=""}if(this.calendar.getView().allEventsPopup){this.calendar.getView().allEventsPopup.close()}},this);i.onbxdrag=BX.delegate(function(s,q){if(this.draggedNode){if(this.calendar.currentViewName=="week"||this.calendar.currentViewName=="day"){var l,p,o=7,t=this.currentState.entry,r=this.calendar.getView(),m=this.draggedNode.offsetHeight,n=(q-o);if(n<this.currentState.offtimeTuneBaseZeroPos){BX.addClass(this.draggedNode,"calendar-entry-shake-mode");if(this.shakeTimeout){clearTimeout(this.shakeTimeout)}this.shakeTimeout=setTimeout(BX.proxy(function(){BX.removeClass(this.draggedNode,"calendar-entry-shake-mode")},this),400);n=this.currentState.offtimeTuneBaseZeroPos}else{if(n+m>this.currentState.bottomBasePos){BX.addClass(this.draggedNode,"calendar-entry-shake-mode");if(this.shakeTimeout){clearTimeout(this.shakeTimeout)}this.shakeTimeout=setTimeout(BX.proxy(function(){BX.removeClass(this.draggedNode,"calendar-entry-shake-mode")},this),400);n=this.currentState.bottomBasePos-m}}l=r.getTimeByPos(n-this.currentState.offtimeTuneBaseZeroPos,5);p=this.draggedNode.querySelector(".calendar-event-block-time");this.draggedNode.style.top=n+"px";if(p&&l){t.from.setHours(l.h,l.m);t.to=new Date(t.from.getTime()+(t.data.DT_LENGTH-(t.fullDay?1:0))*1000);if(this.calendar.util.getDayCode(t.from)!=this.calendar.util.getDayCode(t.to)&&t.to.getHours()==0&&t.to.getMinutes()==0){t.to=new Date(t.to.getTime()-1000)}p.innerHTML=this.calendar.util.formatTime(t.from)+" &ndash; "+this.calendar.util.formatTime(t.to)}}else{this.draggedNode.style.top=(q-10)+"px";this.draggedNode.style.left=(s-20)+"px"}}},this);i.onbxdragstop=BX.delegate(function(){setTimeout(BX.delegate(function(){BX.remove(this.draggedNode)},this),400)},this);if(k.part.params.resizerNode){this.registerResizer(k.part.params.resizerNode,k)}},registerResizer:function(i,j){i.setAttribute("data-bx-entry-resizer","Y");BX.bind(i,"mousedown",BX.delegate(function(k){k=k||h.event;this.resizedState={entry:j.entry,entryWrap:j.part.params.wrapNode,node:i,startY:k.clientY+BX.GetWindowSize().scrollTop,height:parseInt(j.part.params.wrapNode.offsetHeight)||0}},this));jsDD.registerObject(i);i.onbxdrag=BX.delegate(function(l,q){if(this.resizedState){var o=this.resizedState.entry,k=Math.max((this.resizedState.height+q-this.resizedState.startY+5),5),n=this.calendar.getView().getTimeByPos(parseInt(this.resizedState.entryWrap.style.top)+k,5),m=this.calendar.util.formatTime(o.from)+" &ndash; "+this.calendar.util.formatTime(n.h,n.m),p=this.resizedState.entryWrap.querySelector(".calendar-event-block-time");o.to.setHours(n.h,n.m,0);if(p){p.innerHTML=m+'<span class="calendar-event-block-time-shadow">'+m+"</span>"}this.resizedState.entryWrap.style.height=k+"px"}},this);i.onbxdragstop=function(){setTimeout(BX.delegate(function(){if(this.resizedState){this.resizedState=null}},this),400)}}};if(h.BXEventCalendar){h.BXEventCalendar.AddButton=f;h.BXEventCalendar.SelectInput=b;h.BXEventCalendar.ReminderSelector=a;h.BXEventCalendar.DestinationSelector=e;h.BXEventCalendar.LocationSelector=d;h.BXEventCalendar.NavigationCalendar=g;h.BXEventCalendar.DragDrop=c}else{BX.addCustomEvent(h,"onBXEventCalendarInit",function(){h.BXEventCalendar.AddButton=f;h.BXEventCalendar.SelectInput=b;h.BXEventCalendar.ReminderSelector=a;h.BXEventCalendar.DestinationSelector=e;h.BXEventCalendar.LocationSelector=d;h.BXEventCalendar.NavigationCalendar=g;h.BXEventCalendar.DragDrop=c})}})(window);