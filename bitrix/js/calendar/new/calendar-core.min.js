(function(a){function b(d,e,c){this.id=d.id;this.showTasks=d.showTasks;this.calDavConnections=d.connections;this.util=new a.BXEventCalendar.Util(this,d,c);if(this.util.isFilterEnabled()){this.search=new a.BXEventCalendar.Search(this,{filterId:d.filterId,counters:d.counters})}this.sectionController=new a.BXEventCalendar.SectionController(this,e,d);this.entryController=new a.BXEventCalendar.EntryController(this,e);this.section=new a.BXEventCalendar.Section(this,e);this.currentViewName=this.util.getUserOption("view");this.requests={};this.currentUser=d.user;this.ownerUser=d.ownerUser||false;this.viewRangeDate=new Date();this.keyHandlerEnabled=true;this.allowMeetings=true;this.build();if(d.startupEvent){this.showStartUpEntry(d.startupEvent)}if(d.showNewEventDialog&&!this.util.readOnlyMode()&&this.entryController.canDo(true,"add_event")){setTimeout(BX.delegate(function(){this.getView().showEditSlider()},this),1000)}}b.prototype={build:function(){this.mainCont=BX(this.id+"-main-container");if(this.mainCont){this.topBlock=BX.create("DIV",{props:{className:"calendar-top-block"}});this.topBlock=BX.create("DIV",{props:{className:"calendar-top-block"}});this.viewTitleContainer=this.topBlock.appendChild(BX.create("DIV",{props:{className:"calendar-top-title-container"}}));this.viewTitle=this.viewTitleContainer.appendChild(BX.create("H2",{props:{className:"calendar-top-title"}}));this.buildNavigation();this.mainCont.appendChild(this.topBlock);this.viewsCont=BX.create("DIV",{props:{className:"calendar-views-container calendar-disable-select"}});BX.bind(this.viewsCont,"click",BX.proxy(this.handleViewsClick,this));this.dragDrop=new a.BXEventCalendar.DragDrop(this);this.buildViews();if(this.util.isFilterEnabled()){this.searchCont=BX(this.id+"-search-container");if(this.searchCont){this.buildSearchControll()}}this.buildTopButtons();this.buildViewSwitcher();this.mainCont.appendChild(this.viewsCont);this.rightBlock=this.mainCont.appendChild(BX.create("DIV",{props:{className:"calendar-right-container"}}));BX.bind(document.body,"keyup",BX.proxy(this.keyUpHandler,this));BX.addCustomEvent(this,"doRefresh",BX.proxy(this.refresh,this));this.util.applyHacksHandlersForPopupzIndex()}},buildViews:function(){this.views=[new a.BXEventCalendar.CalendarDayView(this),new a.BXEventCalendar.CalendarWeekView(this),new a.BXEventCalendar.CalendarMonthView(this),new a.BXEventCalendar.CalendarListView(this)];BX.onCustomEvent(a,"onCalendarBeforeBuildViews",[this.views,this]);this.views.forEach(this.buildView,this);this.viewTransition=new a.BXEventCalendar.ViewTransition(this);BX.onCustomEvent(a,"onCalendarAfterBuildViews",[this])},buildNavigation:function(){this.navigationWrap=this.topBlock.appendChild(BX.create("DIV",{props:{className:"calendar-navigation-container"}}));this.navigationWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-navigation-previous"},events:{click:BX.delegate(this.showPrevious,this)}}));this.navigationWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-navigation-current"},text:BX.message("EC_TODAY"),events:{click:BX.delegate(this.showToday,this)}}));this.navigationWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-navigation-next"},events:{click:BX.delegate(this.showNext,this)}}));this.topBlock.appendChild(BX.create("DIV",{style:{clear:"both"}}))},showNext:function(){var c=this.getView().increaseViewRangeDate();if(c){this.triggerEvent("changeViewDate",{viewRange:c})}},showPrevious:function(){var c=this.getView().decreaseViewRangeDate();if(c){this.triggerEvent("changeViewDate",{viewRange:c})}},showToday:function(){var c=this.getView(),d=c.adjustViewRangeToDate(new Date());if(d){this.triggerEvent("changeViewDate",{viewRange:d})}},buildView:function(c){var d=c.getContainer();if(d){this.viewsCont.appendChild(d)}if(this.currentViewName==c.getName()){this.setView(c.getName(),{first:true})}},buildViewSwitcher:function(){this.viewSwitcherCont=BX(this.id+"-view-switcher-container");if(!this.viewSwitcherCont){this.viewSwitcherCont=this.mainCont.appendChild(BX.create("DIV",{props:{className:"calendar-view-switcher-container"},attrs:{id:this.id+"-view-switcher-container"}}))}var c=this.viewSwitcherCont.appendChild(BX.create("DIV",{props:{className:"calendar-view-switcher-list"},events:{click:BX.delegate(function(f){var d=f.target||f.srcElement;if(d&&d.getAttribute){var g=d.getAttribute("data-bx-calendar-view");this.setView(g,{animation:true})}},this)}}));this.views.forEach(function(d){d.switchNode=c.appendChild(BX.create("SPAN",{props:{className:"calendar-view-switcher-list-item"+(this.currentViewName==d.name?" calendar-view-switcher-list-item-active":"")},attrs:{"data-bx-calendar-view":d.name},text:d.title||d.name}))},this)},setView:function(c,e){if(c){if(!e){e={}}var g=this.getView(),d=g.getViewRange(),f=this.getView(c);if(f&&(c!=this.currentViewName||!g.getIsBuilt())){e.currentViewDate=this.getViewRangeDate();e.newViewDate=f.getAdjustedDate(e.date||false,d,true);e.currentView=g;e.newView=f;this.setViewRangeDate(e.newViewDate);this.triggerEvent("beforeSetView",{currentViewName:this.currentViewName,newViewName:c});if(e.animation){this.viewTransition.transit(e)}else{if(c!=this.currentViewName){g.hide()}if(e.first===true){this.initialViewShow=true;f.adjustViewRangeToDate(e.newViewDate,false)}else{f.adjustViewRangeToDate(e.newViewDate)}this.currentViewName=f.getName();if(f.switchNode){BX.addClass(f.switchNode,"calendar-view-switcher-list-item-active")}if(g.switchNode){BX.removeClass(g.switchNode,"calendar-view-switcher-list-item-active")}}this.util.setUserOption("view",c);this.triggerEvent("afterSetView",{viewName:c})}}},buildCounters:function(){},registerEventHandlers:function(){},request:function(f){if(!f.url){f.url=this.util.getActionUrl()}if(f.bIter!==false){f.bIter=true}if(!f.data){f.data={}}var e;f.reqId=e=Math.round(Math.random()*1000000);f.data.sessid=BX.bitrix_sessid();f.data.bx_event_calendar_request="Y";f.data.reqId=e;var g=this,c=0,d;if(f.handler){d=function(i){var h=function(){if(g.requests[e].status!=="canceled"){var l=i.toLowerCase().indexOf("bx_event_calendar_action_error");if(!i||i.length<=0||l!=-1){var k="";if(l>=0){var j=l+"BX_EVENT_CALENDAR_ACTION_ERROR:".length,n=i.indexOf("-->",j);k=i.substr(j,n-j)}if(f.onerror&&typeof f.onerror=="function"){f.onerror()}return g.displayError(k||f.errorText||"")}g.requests[e].status="complete";var m=f.handler(g.getRequestResult(e),i);if(m===false&&++c<20&&f.bIter){setTimeout(h,5)}else{delete top.BXCRES[e]}}};setTimeout(h,50)}}else{d=BX.DoNothing()}this.requests[f.reqId]={status:"sent",xhr:f.type=="post"?BX.ajax.post(f.url,f.data,d):BX.ajax.get(f.url,f.data,d)};return f},cancelRequest:function(c){if(this.requests[c]&&this.requests[c].status=="sent"){this.requests[c].status="canceled"}},getRequestResult:function(c){if(top.BXCRES&&typeof top.BXCRES[c]!="undefined"){return top.BXCRES[c]}return{}},displayError:function(d,c){var e=this;setTimeout(function(){if(!e.bOnunload){alert(d||"[Bitrix Calendar] Request error");if(c){BX.reload()}}},200)},triggerEvent:function(c,d){BX.onCustomEvent(this,c,[d])},getView:function(d){d=d||this.currentViewName;for(var c=0;c<this.views.length;c++){if(this.views[c].getName()==d){return this.views[c]}}return this.views[0]},getViewRangeDate:function(){if(!this.viewRangeDate){this.viewRangeDate=new Date()}this.viewRangeDate.setHours(0,0,0,0);return this.viewRangeDate},setViewRangeDate:function(c){this.viewRangeDate=c;this.triggerEvent("changeViewRange",c)},getDisplayedViewRange:function(){return this.displayedRange},setDisplayedViewRange:function(c){this.displayedRange=c},handleViewsClick:function(f){var d=f.target||f.srcElement,c=this.util.findTargetNode(d,this.viewsCont);if(c){if(c.getAttribute("data-bx-calendar-weeknumber")){this.setView("week",{date:new Date(parseInt(c.getAttribute("data-bx-cal-time"))),animation:true})}else{if(c.getAttribute("data-bx-calendar-date")){this.setView("day",{date:new Date(parseInt(c.getAttribute("data-bx-calendar-date"))),animation:true})}}this.triggerEvent("viewOnClick",{e:f,target:d,specialTarget:c})}},handleViewsMousedown:function(f){var d=f.target||f.srcElement,c=this.util.findTargetNode(d,this.viewsCont);if(c){this.triggerEvent("viewOnMouseDown",{e:f,target:d,specialTarget:c})}},keyUpHandler:function(g){if(this.keyHandlerEnabled){var d=this.util.getKeyCodes(),f=g.keyCode;if(f==d.escape){this.getView().deselectEntry()}else{if(f==d["delete"]){var c=this.getView().getSelectedEntry();if(c){this.entryController.deleteEntry(c)}}}if(f==d.left){this.showPrevious()}else{if(f==d.right){this.showNext()}}this.triggerEvent("keyup",{e:g,keyCode:f})}},buildSearchControll:function(){this.countersCont=BX(this.id+"-counter-container");if(!this.countersCont){this.countersCont=this.mainCont.appendChild(BX.create("DIV",{props:{className:"calendar-counter-container"},attrs:{id:this.id+"-counter-container"}}))}BX.addClass(this.countersCont,"calendar-counter");this.search.updateCounters()},buildTopButtons:function(){this.buttonsCont=BX(this.id+"-buttons-container");if(this.buttonsCont){this.sectionButton=this.buttonsCont.appendChild(BX.create("SPAN",{props:{className:"webform-small-button webform-small-button-transparent"},html:'<span class="">'+BX.message("EC_SECTION_BUTTON")+"</span>"}));new a.BXEventCalendar.SectionSlider({calendar:this,button:this.sectionButton});if(this.util.userIsOwner()){this.syncButton=this.buttonsCont.appendChild(BX.create("DIV",{props:{className:"webform-small-button webform-small-button-transparent calendar-sync-button"},html:'<span class="webform-small-button-icon"></span>'}));this.syncSlider=new a.BXEventCalendar.SyncSlider({calendar:this,button:this.syncButton})}if(this.util.userIsOwner()||this.util.config.TYPE_ACCESS){this.settingsButton=this.buttonsCont.appendChild(BX.create("DIV",{props:{className:"webform-small-button webform-small-button-transparent webform-cogwheel"},html:'<span class="webform-button-icon"></span>'}));new a.BXEventCalendar.SettingsSlider({calendar:this,button:this.settingsButton})}if(!this.util.readOnlyMode()){this.addButton=new a.BXEventCalendar.AddButton({wrap:this.buttonsCont.appendChild(BX.create("SPAN")),calendar:this})}}},refresh:function(){this.triggerEvent("beforeRefresh");this.getView().refresh();this.triggerEvent("afterRefresh")},reload:function(c){this.triggerEvent("beforeReload");if(c&&c.syncGoogle){this.reloadGoogle=true}this.entryController.clearLoadIndexCache();this.refresh();this.triggerEvent("afterReload")},showStartUpEntry:function(d){var c=new a.BXEventCalendar.Entry(this,d);this.getView().showViewSlider({entry:c})}};if(a.BXEventCalendar){a.BXEventCalendar.Core=b}else{BX.addCustomEvent(a,"onBXEventCalendarInit",function(){a.BXEventCalendar.Core=b})}})(window);