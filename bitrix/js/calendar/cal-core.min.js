function JCEC(f){this.arConfig=f;top.BXCRES={};this.dayLength=86400000;this.id=f.id;this.pCalCnt=BX(this.id+"_bxcal");this.dragDrop=new ECDragDropControl({calendar:this});this.arEvents=[];this.arAttendees={};this.arSections=f.sections;this.type=f.type;this.bSuperpose=f.bSuperpose||false;this.bTasks=f.bTasks||false;this.userId=f.userId;this.userName=f.userName;this.ownerId=f.ownerId||false;this.sectionControlsDOMId=f.sectionControlsDOMId;this.PERM=f.perm;this.permEx=f.permEx;this.settings=f.settings;this.userSettings=f.userSettings;this.pathToUser=f.pathToUser;this.bIntranet=!!f.bIntranet;this.allowMeetings=!!f.bSocNet&&this.bIntranet;this.allowReminders=!!f.bSocNet&&this.bIntranet;this.days=f.days;this.bReadOnly=!!f.readOnly;this.bAnonym=!!f.bAnonym;this.startupEvent=f.startupEvent;this.accessColors=f.accessColors;this.initMonth=f.init_month;this.initYear=f.init_year;this.weekHolidays=f.week_holidays;this.yearHolidays=f.year_holidays;this.yearWorkdays=f.year_workdays;this.new_section_access=f.new_section_access||{};this.bExtranet=!!f.bExtranet;this.Colors=f.arCalColors;this.bAMPM=f.bAMPM;this.bWideDate=f.bWideDate;this.weekStart=f.week_start;this.weekDays=f.week_days;this.lastSection=f.lastSection;this.requests={};this.DATE_FORMAT=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE"));this.DATETIME_FORMAT=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"));if((this.DATETIME_FORMAT.substr(0,this.DATE_FORMAT.length)==this.DATE_FORMAT)){this.TIME_FORMAT=BX.util.trim(this.DATETIME_FORMAT.substr(this.DATE_FORMAT.length))}else{this.TIME_FORMAT=BX.date.convertBitrixFormat(this.bAMPM?"H:MI:SS T":"HH:MI:SS")}this.TIME_FORMAT_SHORT=this.TIME_FORMAT.replace(":s","");this.bCalDAV=!!f.bCalDAV;if(this.bCalDAV){this.arConnections=f.connections}this.arSectionsInd={};this.oActiveSections={};this.dayHeight=100;this.darkColor="#E6E6E6";this.brightColor="#000000";this.arMenuItems={};this.arNames={};this.HandleAccessNames(f.accessNames);var d,e,b,a;this.activeSectionsCount=0;for(d in this.arSections){if(this.arSections.hasOwnProperty(d)){a=this.arSections[d];if(a.EXPORT&&!a.EXPORT.ALLOW){a.EXPORT=false}if(!a.TEXT_COLOR){a.TEXT_COLOR=""}e=a.ID;if(this.bCalDAV&&a.CAL_DAV_CAL&&a.CAL_DAV_CON&&this.arConnections&&this.arConnections.length>0){for(b in this.arConnections){if(this.arConnections.hasOwnProperty(b)&&this.arConnections[b].id==a.CAL_DAV_CON){a["~CAL_DAV_LAST_SYNC"]=this.arConnections[b].last_result;break}}}this.arSectionsInd[e]=d;if(a.ACTIVE!=="N"){this.oActiveSections[e]=true}if(a.ACTIVE!=="N"&&this.IsCurrentViewSect(a)){this.activeSectionsCount++}if(!this.lastSection&&a.PERM&&a.PERM.add&&a.ACTIVE!=="N"){this.lastSection=parseInt(e)}}}this.bOnunload=false;this.actionUrl=f.page;this.path=f.path;this.bUser=this.type=="user";this.meetingRooms=f.meetingRooms||[];this.allowResMeeting=!!f.allowResMeeting;this.bUseMR=this.bIntranet&&this.allowResMeeting&&this.meetingRooms.length>0;if(this.bTasks){this.taskBgColor="#F5B39A";this.taskTextColor="#000000";BX.addCustomEvent("onCalendarPopupTaskAdded",BX.delegate(this.OnTaskChanged,this));BX.addCustomEvent("onCalendarPopupTaskChanged",BX.delegate(this.OnTaskChanged,this));BX.addCustomEvent("onCalendarPopupTaskDeleted",BX.delegate(this.OnTaskKilled,this));this.oActiveSections.tasks=true}for(d in f.hiddenSections){if(f.hiddenSections.hasOwnProperty(d)){this.oActiveSections[f.hiddenSections[d]]=false}}this.typeAccess=this.PERM.access?(f.TYPE_ACCESS||{}):null;this.Init()}JCEC.prototype={Init:function(){this.DaysTitleCont=BX(this.id+"_days_title");this.DaysGridCont=BX(this.id+"_days_grid");DenyDragEx(this.DaysGridCont);this.maxEventCount=3;this.activeDateDays={};this._bScelTableSixRows=false;this.oDate=new Date();this.currentDate={date:this.oDate.getDate(),day:this.ConvertDayIndex(this.oDate.getDay()),month:this.oDate.getMonth(),year:this.oDate.getFullYear()};this.activeDate=BX.clone(this.currentDate);if(this.initMonth&&this.initYear){this.activeDate.month=this.initMonth-1;this.activeDate.year=this.initYear}this.activeDate.week=this.GetWeekByDate(this.activeDate);this.arLoadedMonth={};this.arLoadedMonth[this.activeDate.month+"."+this.activeDate.year]=true;this.arLoadedEventsId={};this.arLoadedParentId={};this.Event=new window.JSECEvent(this);this.arConfig.attendees=[];this.HandleEvents(this.arConfig.events,this.arConfig.attendees);var a,b=this;this.selectDaysMode=false;this.selectDaysStartObj=false;this.selectDaysEndObj=false;this.curTimeSelection={};this.curDayTSelection={};this.week_holidays={};for(a=0;a<this.weekHolidays.length;a++){this.week_holidays[this.weekHolidays[a]]=true}this.year_holidays={};for(a in this.yearHolidays){this.year_holidays[this.yearHolidays[a]]=true}this.year_workdays={};for(a in this.yearWorkdays){this.year_workdays[this.yearWorkdays[a]]=true}window.onbeforeunload=function(){b.bOnunload=true};BX.addCustomEvent("onPopupClose",BX.proxy(this._OnPopupCloseHandler,this));this.BuildSectionBlock();this.Selector=new ECMonthSelector(this);this.ColorPicker=new ECColorPicker({});this.BuildButtonsCont();this.pCalCnt.className="bxcal";this.InitTabControl();setTimeout(function(){BX.bind(window,"resize",BX.proxy(b.OnResize,b))},200);if(this.arConfig.syncInfo&&typeof this.arConfig.syncInfo==="object"){new ECSyncPannel(this)}if(this.arConfig.showNewEventDialog&&!this.bReadOnly){setTimeout(function(){b.ShowEditEventPopup({bChooseMR:b.arConfig.bChooseMR})},1000)}},InitTabControl:function(){this.Tabs={};this.InitTab({id:"month",tabContId:this.id+"_tab_month",bodyContId:this.id+"_scel_table_month"});this.InitTab({id:"week",tabContId:this.id+"_tab_week",bodyContId:this.id+"_scel_table_week",daysCount:7});this.InitTab({id:"day",tabContId:this.id+"_tab_day",bodyContId:this.id+"_scel_table_day",daysCount:1});this.SetTab(this.userSettings.tabId,true)},InitTab:function(b){var a=BX(b.tabContId);if(!a){return}var d=this;a.onclick=function(){d.SetTab(b.id)};this.Tabs[b.id]={id:b.id,pTabCont:a,bodyContId:b.bodyContId,daysCount:b.daysCount||false,needRefresh:false,setActiveDate:false}},SetTab:function(b,h,j){var l=this,g=this.Tabs[b];if(b==this.activeTabId){return}var t=this.activeTabId,a="";if(!g.bLoaded||h){g.pBodyCont=BX(g.bodyContId);BX.bind(g.pBodyCont,"click",BX.proxy(this.EventClick,this));DenyDragEx(g.pBodyCont)}if(this.activeTabId){BX.removeClass(this.Tabs[this.activeTabId].pTabCont,"bxec-tab-div-act");this.Tabs[this.activeTabId].pBodyCont.style.display="none"}BX.addClass(g.pTabCont,"bxec-tab-div-act");this.activeTabId=b;this.Selector.ChangeMode(b);if(!g.bLoaded||h){var s=this.activeDate,e=this.currentDate,o,q,f,p;if((s.month&&s.month!=e.month)||(s.year&&s.year!=e.year)){o=1;q=0;f=s.month;p=s.year}else{var r=(t=="day"&&s)?s:e;q=this.GetWeekByDate(r);o=r.date;f=r.month;p=r.year}switch(b){case"month":setTimeout(BX.delegate(this.BuildDaysTitle,this),0);this.SetMonth(f,p);break;case"week":this.BuildWeekDaysTable();this.SetWeek(q,f,p);break;case"day":this.BuildSingleDayTable();if(!j||j.bSetDay!==false){this.SetDay(o,f,p)}break}g.bLoaded=true}else{if(!j||j.bSetDay!==false){if(t=="day"&&b=="week"){g.setActiveDate=true}if(g.needRefresh){if(b=="month"){this.DisplayEventsMonth(true)}else{setTimeout(function(){l.ReBuildEvents(b)},20)}}else{if(g.setActiveDate){switch(b){case"month":this.SetMonth(this.activeDate.month,this.activeDate.year);break;case"week":this.SetWeek(this.GetWeekByDate(this.activeDate),this.activeDate.month,this.activeDate.year);break;case"day":this.SetDay(1,this.activeDate.month,this.activeDate.year);break}}}}}if(this.startupEvent&&!this.startupEvent.viewed){this.ShowStartUpEvent()}g.needRefresh=false;g.setActiveDate=false;this.Selector.Show(b);g.pBodyCont.style.display=a;g.bLoaded=true;if(this._bScelTableSixRows){if(this.activeTabId=="month"){BX.addClass(this.pCalCnt,"BXECSceleton-six-rows")}else{BX.removeClass(this.pCalCnt,"BXECSceleton-six-rows")}}if(!h){BX.userOptions.save("calendar","user_settings","tabId",b)}},GetWeekByDate:function(e){var g=new Date();g.setFullYear(e.year,e.month,1);var b=this.GetWeekDayByInd(g.getDay());var f=this.GetWeekDayOffset(b)-1;var a=e.date+f;var d=Math.floor(a/7);return d},SetTabNeedRefresh:function(b,e){var d,a;for(d in this.Tabs){a=this.Tabs[d];if(typeof a!="object"||a.id==b){continue}if(!e&&a.needRefresh===false){a.needRefresh=true}else{if(e&&a.setActiveDate===false){a.setActiveDate=true}}}},BuildButtonsCont:function(){this.ButtonsCont=BX(this.id+"_buttons_cont");var f=false,h=this;if(!this.bReadOnly){var g=this.ButtonsCont.appendChild(BX.create("SPAN",{props:{className:"bxec-add-but",title:EC_MESS.AddNewEvent}})),d=g.appendChild(BX.create("I")),e=g.appendChild(BX.create("SPAN",{props:{},html:EC_MESS.Add})),b=g.appendChild(BX.create("A",{props:{href:"javascript: void(0);",className:"bxec-add-more"}}));f=true;d.onclick=e.onclick=BX.proxy(this.ShowEditEventPopup,this);var a=[];a.push({text:EC_MESS.Event,title:EC_MESS.AddNewEvent,className:"bxec-menu-add-event",onclick:function(){h.ClosePopupMenu();h.ShowEditEventPopup()}});if(this.bTasks){a.push({text:EC_MESS.NewTask,title:EC_MESS.NewTaskTitle,className:"bxec-menu-add-task",onclick:function(){h.ClosePopupMenu();h.Event.Edit({bTasks:true})}})}if((this.type=="user"&&this.userId==this.ownerId)||this.permEx.section_edit){a.push({text:EC_MESS.NewSect,title:EC_MESS.NewSectTitle,className:"bxec-menu-add-sect",onclick:function(){h.ClosePopupMenu();h.ShowSectionDialog()}})}if(this.bCalDAV&&this.type=="user"&&this.userId==this.ownerId){a.push({text:EC_MESS.NewExtSect,title:EC_MESS.NewExtSectTitle,className:"bxec-menu-add-sect-ex",onclick:function(){h.ClosePopupMenu();h.ShowExternalDialog({})}})}b.onclick=function(){BX.PopupMenu.show("bxec_add_menu"+h.id,b,a,{events:{onPopupClose:function(){BX.removeClass(this.bindElement,"bxec-add-more-over")}},offsetLeft:-(g.offsetWidth-15)});BX.addClass(b,"bxec-add-more-over")}}if(!this.bAnonym){if(f){this.ButtonsCont.appendChild(BX.create("SPAN",{props:{className:"bxec-but-sep"}}))}this.ButtonsCont.appendChild(BX.create("SPAN",{props:{className:"bxec-settings-but",title:EC_MESS.Settings},events:{click:BX.proxy(this.ShowSetDialog,this)}}))}this.accessSettingsWrap=BX(this.id+"-access-settings-wrap");if(this.accessSettingsWrap&&this.type!=="group"&&this.type!=="user"&&!this.bAnonym){var h=this;this.accessSettingsWrap.style.display="block";this.accessSettingsLink=BX(this.id+"-access-settings");if(this.PERM.access){BX.bind(this.accessSettingsLink,"click",function(){h.ShowSetDialog({tabId:h.id+"set-tab-2"})})}else{new BX.CHint({parent:this.accessSettingsLink,hint:EC_MESS.accessSettingsWarn});BX.bind(this.accessSettingsLink,"click",function(){alert(EC_MESS.accessSettingsWarn)})}}},ClosePopupMenu:function(){if(BX.PopupMenu&&BX.PopupMenu.currentItem&&BX.PopupMenu.currentItem.popupWindow){BX.PopupMenu.currentItem.popupWindow.close()}},SetView:function(a){if(!bxInt(a.week)&&a.week!==0){a.week=this.activeDate.week}if(!bxInt(a.date)){a.date=this.activeDate.date}switch(this.activeTabId){case"month":return this.SetMonth(a.month,a.year);case"week":return this.SetWeek(a.week,a.month,a.year);case"day":return this.SetDay(a.date||1,a.month,a.year)}},SetMonth:function(a,d){if(!this.arLoadedMonth[a+"."+d]){return this.LoadEvents(a,d)}var b=this.activeDate.month!=a||this.activeDate.year!=d;this.activeDate.month=a;this.activeDate.year=d;if(!this.activeDate.week){this.activeDate.week=0}if(b){this.SetTabNeedRefresh("month",true)}this.Selector.OnChange(d,a);this.BuildDaysGrid(a,d)},BuildDaysTitle:function(){var d,b,a=this.DaysTitleCont.offsetWidth/7;a=Math.round(a*10)/10;for(d=0;d<7;d++){b=this.DaysTitleCont.childNodes[d];b.style.width=a+"px";if(d==6){b.style.width=Math.abs(a-2)+"px"}}this.DaysTitleCont.style.visibility="visible"},BuildDaysGrid:function(f,d){BX.cleanNode(this.DaysGridCont);var e=new Date();e.setFullYear(d,f,1);this.dragDrop.Reset();this.activeDateDays=[];this.activeDateObjDays=[];this.arWeeks=[];this.oDaysGridTable=BX.create("TABLE",{props:{className:"bxec-days-grid-table",cellPadding:0,cellSpacing:0}});if(this.GetWeekStart()!=this.GetWeekDayByInd(e.getDay())){this.BuildPrevMonthDays(this.GetWeekDayByInd(e.getDay()),f,d)}var b;while(e.getMonth()==f){b=e.getDate();this.BuildDayCell(b,this.GetWeekDayByInd(e.getDay()),true,f,d);e.setDate(b+1)}this.BuildNextMonthDays(this.GetWeekDayByInd(e.getDay()),f,d);this.DaysGridCont.appendChild(this.oDaysGridTable);var a=this.oDaysGridTable.rows.length;if(a==6&&!this._bScelTableSixRows){this._bScelTableSixRows=true;BX.addClass(this.pCalCnt,"BXECSceleton-six-rows")}else{if(this.pCalCnt&&this._bScelTableSixRows&&a<6){this._bScelTableSixRows=false;BX.removeClass(this.pCalCnt,"BXECSceleton-six-rows")}}this.BuildEventHolder()},BuildPrevMonthDays:function(b,g,e){var d,a=this.GetWeekDayOffset(b),f=new Date();f.setFullYear(e,g,1);f.setDate(f.getDate()-a);for(d=0;d<a;d++){this.BuildDayCell(f.getDate(),this.GetWeekDayByInd(f.getDay()),false,f.getMonth(),f.getFullYear());f.setDate(f.getDate()+1)}},BuildNextMonthDays:function(b,g,e){if(this.GetWeekStart()!=b){var d,a=this.GetWeekDayOffset(b);var f=new Date();f.setFullYear(e,g+1,1);for(d=a;d<7;d++){this.BuildDayCell(f.getDate(),this.GetWeekDayByInd(f.getDay()),false,f.getMonth(),f.getFullYear());f.setDate(f.getDate()+1)}}},BuildDayCell:function(b,h,a,e,f){var p,o,d=this;if(this.GetWeekStart()==h){this._curRow=this.oDaysGridTable.insertRow(-1)}var q=this.activeDateDays.length;var m=(this.week_holidays[{MO:0,TU:1,WE:2,TH:3,FR:4,SA:5,SU:6}[h]]||this.year_holidays[b+"."+e])&&!this.year_workdays[b+"."+e];o="bxec-day";if(!a&&!m){o+=" bxec-day-past"}else{if(!a){o+=" bxec-day-past-hol"}else{if(m){o+=" bxec-holiday"}}}if(b==this.currentDate.date&&e==this.currentDate.month&&f==this.currentDate.year){o+=" bxec-current-day"}p=this._curRow.insertCell(-1);p.id="bxec_ind_"+q;p.className=o;var l=p.appendChild(BX.create("DIV",{props:{className:"bxc-day"},style:{height:this.dayHeight+"px"}})),j=l.appendChild(BX.create("DIV",{props:{className:"bxc-day-title"}})),g=j.appendChild(BX.create("A",{props:{href:"javascript:void(0)",className:"bxc-day-link",title:EC_MESS.GoToDay,id:"bxec-day-lnk-"+q},html:b}));this.dragDrop.RegisterDay(l);g.onmousedown=function(r){return BX.PreventDefault(r)};g.onclick=function(s){var r=d.activeDateDays[this.id.substr("bxec-day-lnk-".length)];d.SetTab("day",false,{bSetDay:false});d.SetDay(r.getDate(),r.getMonth(),r.getFullYear());return BX.PreventDefault(s)};if(this.GetWeekDayOffset(h)==6){p.style.borderRight="0px"}if(!this.bReadOnly){p.onmouseover=function(){d.oDayOnMouseOver(this)};p.onmousedown=function(){d.oDayOnMouseDown(this)};p.onmouseup=function(){d.oDayOnMouseUp(this)}}this.activeDateDays.push(new Date(f,e,b));this.activeDateObjDays.push({pDiv:p,pDayCont:l,arEvents:{begining:[],all:[]}})},oDayOnMouseOver:function(a){if(this.selectDaysMode){this.selectDaysEndObj=a;this.SelectDays()}},oDayOnMouseDown:function(a){this.selectDaysMode=true;this.selectDaysStartObj=this.selectDaysEndObj=a;if(a.className.indexOf("bxec-day-selected")==-1){return this.SelectDays()}this.selectDaysMode=false;this.DeSelectDays();this.CloseAddEventDialog()},oDayOnMouseUp:function(a){if(!this.selectDaysMode){return}this.selectDaysEndObj=a;this.SelectDays();this.ShowAddEventDialog();this.selectDaysMode=false},oDayOnDoubleClick:function(a){},oDayOnContextMenu:function(a){},RefreshEventsOnWeeks:function(d){for(var b=0,a=d.length;b<a;b++){this.RefreshEventsOnWeek(d[b])}},RefreshEventsOnWeek:function(b){var s=b*7,d=(b+1)*7,q,h,f,e,g,p,o,m,l=[],a=0;for(g=0;g<this.maxEventCount;g++){l[g]=0}for(h=s;h<d;h++){q=this.activeDateObjDays[h];if(!q){continue}q.arEvents.hidden=[];e=q.arEvents.begining;m=[];if(e.length>0){e.sort(function(t,j){if(j.daysCount==t.daysCount&&t.daysCount==1){return t.oEvent.DT_FROM_TS-j.oEvent.DT_FROM_TS}return j.daysCount-t.daysCount});eventloop:for(f=0;f<e.length;f++){p=e[f];if(!p){continue}if(!this.arEvents[p.oEvent.ind]){q.arEvents.begining=e=BX.util.deleteFromArray(e,f);p=e[f];if(!p){continue}}for(g=0;g<this.maxEventCount;g++){if(l[g]-a<=0){l[g]=a+p.daysCount;this.ShowEventOnLevel(p.oEvent.oParts[p.partInd],g,b);continue eventloop}}m[p.oEvent.ID]=true;q.arEvents.hidden.push(p)}}o=q.arEvents.all;for(var r=0;r<o.length;r++){p=o[r];if(!p||m[p.oEvent.ID]){continue}if(!this.arEvents[p.oEvent.ind]){q.arEvents.all=o=BX.util.deleteFromArray(o,r);p=o[r];if(!p){continue}}if(p.oEvent.oParts&&p.partInd!=undefined&&p.oEvent.oParts[p.partInd]&&p.oEvent.oParts[p.partInd].style.display=="none"){q.arEvents.hidden.push(p)}}this.ShowMoreEventsSelect(q);a++}},ShowEventOnLevel:function(a,e,b){if(!this.arWeeks[b]){this.arWeeks[b]={top:parseInt(this.oDaysGridTable.rows[b].cells[0].offsetTop)+22}}var d=this.arWeeks[b].top+e*18;a.style.display="block";a.style.top=d+"px"},ShowMoreEventsSelect:function(f){var g=f.arEvents.hidden;if(g.length<=0){if(f.pMoreDiv){f.pMoreDiv.style.display="none"}return}if(!f.pMoreDiv){f.pMoreDiv=f.pDayCont.appendChild(BX.create("DIV",{props:{className:"bxc-day-more"}}))}var h=this,d,e,a,b=[];for(d=0;d<g.length;d++){e=g[d];a=e.oEvent.oParts[e.partInd];a.style.display="none";if(!e.oEvent.pMoreDivs){e.oEvent.pMoreDivs=[]}e.oEvent.pMoreDivs.push(f.pMoreDiv);b.push({pDiv:a,oEvent:e.oEvent})}BX.adjust(f.pMoreDiv,{style:{display:"block"},html:EC_MESS.MoreEvents+" ("+b.length+" "+EC_MESS.Item+")"});f.pMoreDiv.onmousedown=function(j){if(!j){j=window.event}BX.PreventDefault(j)};f.pMoreDiv.onclick=function(){h.ShowMoreEventsWin({Events:b,id:f.pDiv.id,pDay:f.pDiv,pSelect:f.pMoreDiv})}},SelectDays:function(){if(!this.arSelectedDays){this.arSelectedDays=[]}this.bInvertedDaysSelection=false;if(this.arSelectedDays.length>0){this.DeSelectDays()}if(!this.selectDaysStartObj||!this.selectDaysEndObj){return}var f=this.GetDayIndexByElement(this.selectDaysStartObj),e=this.GetDayIndexByElement(this.selectDaysEndObj),d,b,a;if(f>e){a=e;e=f;f=a;this.bInvertedDaysSelection=true}for(b=f;b<=e;b++){d=this.activeDateObjDays[b];if(!d||!d.pDiv){continue}BX.addClass(d.pDiv,"bxec-day-selected");this.arSelectedDays.push(d.pDiv)}},GetDayIndexByElement:function(a){return parseInt(a.id.substr(9))},GetDayByIndex:function(a){return this.activeDateObjDays[a]},DeSelectDays:function(){if(!this.arSelectedDays){return}var b,a;for(b=0,a=this.arSelectedDays.length;b<a;b++){BX.removeClass(this.arSelectedDays[b],"bxec-day-selected")}this.arSelectedDays=[]},DisplayError:function(b,a){var d=this;setTimeout(function(){if(!d.bOnunload){alert(b||"[Event Calendar] Error!");if(a){BX.reload()}}},200)},BuildSectionBlock:function(){this.oSections={};var a=(this.sectionControlsDOMId&&(this.pSidebar=BX(this.sectionControlsDOMId)));this.pSectCont=BX(this.id+"_sect_cont");if(!this.pSectCont){return}if(a){if(this.pSidebar.firstChild){this.pSidebar.insertBefore(this.pSectCont,this.pSidebar.firstChild)}else{this.pSidebar.appendChild(this.pSectCont)}BX.addClass(this.pSectCont,"bxec-sect-cont-side")}else{BX.addClass(this.pSectCont,"bxec-sect-cont-top")}var e=this;if(this.arSections.length<1&&this.bReadOnly){this.pSectCont.style.display="none";return}this.pSectCont.style.display="block";this.pOwnerSectCont=BX(this.id+"sections");if(this.pOwnerSectCont){this.pOwnerSectCont.onmouseover=function(){if(e._sect_over_timeout){clearInterval(e._sect_over_timeout)}BX.addClass(e.pOwnerSectCont,"bxec-hover")};this.pOwnerSectCont.onmouseout=function(){e._sect_over_timeout=setTimeout(function(){BX.removeClass(e.pOwnerSectCont,"bxec-hover")},100)}}this.pOwnerSectBlock=BX(this.id+"sections-cont");if(!this.pOwnerSectBlock){return}BX.cleanNode(this.pOwnerSectBlock);this.pOwnerSectBlock.style.display="";this.pSPSectCont=BX(this.id+"sp-sections");if(this.bSuperpose){this.pSPSectCont.onmouseover=function(){if(e._sect_over_timeout){clearInterval(e._sect_over_timeout)}BX.addClass(e.pSPSectCont,"bxec-hover")};this.pSPSectCont.onmouseout=function(){e._sect_over_timeout=setTimeout(function(){BX.removeClass(e.pSPSectCont,"bxec-hover")},100)};this.pSpSectBlock=BX(this.id+"sp-sections-cont");var d=BX(this.id+"-manage-superpose");d.onclick=function(){e.ShowSuperposeDialog()}}this.BuildSectionElements();var b=BX(this.id+"-add-section");if(this.Personal()||this.permEx.section_edit){if(b){b.onclick=function(){e.ShowSectionDialog()}}}else{if(b){BX.cleanNode(b,true)}}},BuildSectionElements:function(){var d=false,b=false,a,e;for(a=0;a<this.arSections.length;a++){e=this.arSections[a];if(!e.DOM){e.DOM={}}if(e.ACTIVE!=="N"){if(!this.bSuperpose||(e.CAL_TYPE==this.type&&e.OWNER_ID==this.ownerId)){if(e.DOM.pEl){this.BuildSectionMenu(e.ID)}else{this.BuildSectionElement(e,this.oActiveSections[e.ID])}if(!d){d=true}}if(this.bSuperpose&&!this.bAnonym){if(e.SUPERPOSED){if(e.DOM.pSPEl){this.BuildSectionMenu(e.ID,true)}else{this.BuildSectionElement(e,this.oActiveSections[e.ID],true)}}else{if(!e.SUPERPOSED&&e.DOM.pSPEl){if(e.DOM.pSPEl.parentNode){e.DOM.pSPEl.parentNode.removeChild(e.DOM.pSPEl)}var f="bxec-sect-sp-"+e.ID;if(this.arMenuItems[f]){if(BX.PopupMenu.Data[f]){BX.PopupMenu.Data[f].popupWindow.destroy();BX.PopupMenu.Data[f]=false}this.arMenuItems[f]=null;delete this.arMenuItems[f]}e.DOM.pSPEl=e.DOM.pSPWrap=e.DOM.pSPText=null;delete e.DOM.pSPEl;delete e.DOM.pSPWrap;delete e.DOM.pSPText}}if(e.SUPERPOSED&&!b){b=true}}}}if(this.bTasks&&!this.oSections.tasks){d=true;this.BuildSectionElement({ID:"tasks",CAL_TYPE:"user",COLOR:this.taskBgColor,CREATED_BY:this.userId,DESCRIPTION:EC_MESS.MyTasks,DOM:{},NAME:EC_MESS.MyTasks,OWNER_ID:this.userId,PERM:{},SORT:100,SUPERPOSED:false,TEXT_COLOR:this.taskTextColor},this.oActiveSections.tasks)}if(this.pSPSectCont){this.pSPSectCont.style.display=b?"":"none"}this.pOwnerSectCont.style.display=d?"":"none";return true},BuildSectionElement:function(d,q,e){e=!!e;if(!d.DOM){d.DOM={}}var a=this.bCalDAV&&d.CAL_DAV_CAL&&d.CAL_DAV_CON&&d["~CAL_DAV_LAST_SYNC"],o=this.bTasks&&d.ID=="tasks",h=this.pOwnerSectBlock;if(e){h=this.pSpSectBlock}else{if(o){h=BX(this.id+"tasks-sections-cont")}else{if(!this.pSectSubCont){this.pSectSubCont=this.pOwnerSectBlock.appendChild(BX.create("DIV"))}h=this.pSectSubCont}}d.bDark=this.ColorIsDark(d.COLOR);var g=this,b=[],l="bxec-sect-"+(e?"sp-":"")+d.ID,j=h.appendChild(BX.create("DIV",{props:{id:"el-"+l,className:"bxec-sect-el"}})),m=j.appendChild(BX.create("DIV",{props:{className:"bxec-sect-el-wrap"+(o?" bxec-task-el-wrap":"")}}));m.appendChild(BX.create("SPAN",{props:{className:"bxec-spr bxec-checkbox"}}));if(o){m.appendChild(BX.create("SPAN",{props:{className:"bxec-spr bxec-tasks-sect"}}))}if(a){if(d["~CAL_DAV_LAST_SYNC"].indexOf("[200]")>=0){d.DOM.pStatus=m.appendChild(BX.create("SPAN",{props:{className:"bxec-spr bxec-cal-dav-google"}}))}else{d.DOM.pStatus=m.appendChild(BX.create("SPAN",{props:{className:"bxec-spr bxec-cal-dav-google-fail",title:EC_MESS.SyncError+": "+d["~CAL_DAV_LAST_SYNC"]}}))}}var f=m.appendChild(BX.create("DIV",{text:d.NAME,props:{className:"bxc-sect-text-wrap"}})),p=j.appendChild(BX.create("A",{props:{id:l,href:"javascript: void(0);",className:"bxec-spr bxec-sect-menu",hidefocus:true}}));p.onclick=function(r){g.ShowCPopup(this.id,this);return BX.PreventDefault(r)};if(e){d.DOM.pSPEl=j;d.DOM.pSPWrap=m;d.DOM.pSPText=f}else{d.DOM.pEl=j;d.DOM.pWrap=m;d.DOM.pText=f}j.onclick=function(){g.ShowCalendar(d,this.className.indexOf("bxec-sect-el-checked")==-1)};this.oSections[d.ID]=d;this.oActiveSections[d.ID]=q;this.BuildSectionMenu(d.ID,e);this.ShowCalendar(d,q,true)},BuildSectionMenu:function(sectionId,bSuperpose){var el=this.oSections[sectionId];if(!el||(this.bTasks&&el.ID=="tasks")){return false}if(!el.PERM){el.PERM={}}var _this=this,menu=[],isGoogle=el.CAL_DAV_CAL&&el.CAL_DAV_CON,isFirstExchange=this.arConfig.bExchange&&el.IS_EXCHANGE&&el.DAV_EXCH_CAL=="calendar_"+el.OWNER_ID,pEl=bSuperpose?el.DOM.pSPEl:el.DOM.pEl,menuId="bxec-sect-"+(bSuperpose?"sp-":"")+el.ID;if(BX.PopupMenu.Data[menuId]&&BX.PopupMenu.Data[menuId].popupWindow){BX.PopupMenu.Data[menuId].popupWindow.destroy();BX.PopupMenu.Data[menuId]=false}if(el.LINK){menu.push({text:EC_MESS.OpenCalendar,href:el.LINK,className:"bxec-menu-sect-add2sp"})}if(el.PERM.edit_section&&this.permEx.section_edit&&!bSuperpose){menu.push({text:EC_MESS.Edit,title:EC_MESS.EditCalendarTitle,className:"bxec-menu-sect-edit",onclick:function(){_this.CloseCPopup();_this.ShowSectionDialog(el)}})}if(!el.SUPERPOSED){menu.push({text:EC_MESS.CalAdd2SP,title:EC_MESS.CalAdd2SPTitle,className:"bxec-menu-sect-add2sp",onclick:function(){_this.CloseCPopup();_this.SetSuperposed(el,true)}})}else{if(el.SUPERPOSED){menu.push({text:EC_MESS.CalHide,title:EC_MESS.CalHideTitle,className:"bxec-menu-sect-del-from-sp",onclick:function(){_this.CloseCPopup();_this.SetSuperposed(el,false)}})}}if(el.OUTLOOK_JS&&!isGoogle&&!BX.browser.IsMac()){menu.push({text:EC_MESS.ConnectToOutlook,title:EC_MESS.ConnectToOutlookTitle,className:"bxec-menu-sect-outlook",onclick:function(){_this.CloseCPopup();if(!window.jsOutlookUtils){BX.loadScript("/bitrix/js/calendar/outlook.js",function(){try{eval(el.OUTLOOK_JS)}catch(e){}})}else{try{eval(el.OUTLOOK_JS)}catch(e){}}}})}if(el.EXPORT&&el.EXPORT.ALLOW){menu.push({text:EC_MESS.Export,title:EC_MESS.ExportTitle,className:"bxec-menu-sect-export",onclick:function(){_this.CloseCPopup();_this.ShowExportDialog(el)}})}if(el.PERM.edit_section&&this.permEx.section_edit&&!isGoogle&&!bSuperpose&&!isFirstExchange){menu.push({text:EC_MESS.Delete,title:EC_MESS.DelCalendarTitle,className:"bxec-menu-sect-del",onclick:function(){_this.CloseCPopup();_this.DeleteSection(el)}})}if(el.PERM.edit_section&&isGoogle&&!bSuperpose){menu.push({text:EC_MESS.Refresh,className:"bxec-menu-sect-edit",onclick:function(){_this.CloseCPopup();_this.bSyncGoogle=true;_this.Event.ReloadAll()}});menu.push({text:EC_MESS.Adjust,title:EC_MESS.CalDavDialogTitle,className:"bxec-menu-sect-edit",onclick:function(){_this.CloseCPopup();_this.ShowExternalDialog({})}});menu.push({text:EC_MESS.googleHide,className:"bxec-menu-sect-del",onclick:function(){_this.CloseCPopup();_this.HideCalDavSection(el);_this.Event.ReloadAll()}})}this.arMenuItems[menuId]=menu;if(menu.length>0){pEl.onmouseover=function(){if(_this["_sect_el_over_timeout"+this.id]){clearInterval(_this["_sect_el_over_timeout"+this.id])}BX.addClass(pEl,"bxec-sect-el-hover")};pEl.onmouseout=function(){_this["_sect_el_over_timeout"+this.id]=setTimeout(function(){BX.removeClass(pEl,"bxec-sect-el-hover")},100)}}else{pEl.onmouseover=BX.False;pEl.onmouseout=BX.False}},ShowCPopup:function(b,a){if(this.arMenuItems[b]){BX.PopupMenu.show(b,a,this.arMenuItems[b],{events:{onPopupClose:function(){BX.removeClass(this.bindElement,"bxec-menu-over")}}});BX.addClass(a,"bxec-menu-over")}},CloseCPopup:function(){BX.PopupMenu.currentItem.popupWindow.close()},ColorIsDark:function(e){if(!e){return false}if(e.charAt(0)=="#"){e=e.substring(1,7)}var h=parseInt(e.substring(0,2),16),f=parseInt(e.substring(2,4),16),a=parseInt(e.substring(4,6),16),d=(h*0.8+f+a*0.2)/510*100;return d<50},AppendCalendarHint:function(b,d){if(b.oHint&&b.oHint.Destroy){b.oHint.Destroy()}var e;if(d&&b.SP_PARAMS){e="<b>"+b.SP_PARAMS.GROUP_TITLE+" > "+b.SP_PARAMS.NAME+" > "+b.NAME+"</b>"}else{e="<b>"+b.NAME+"</b>"}var a=b.DESCRIPTION.length,f=350;if(a>0){if(a<f){e+="<br>"+b.DESCRIPTION}else{e+="<br>"+b.DESCRIPTION.substr(0,f)+"..."}}b.oHint=new BX.CHintSimple({parent:b._pElement,hint:e})},ShowCalendar:function(e,d,a){if(!e){return}if(d){if(e.DOM.pEl){e.DOM.pEl.style.backgroundColor=e.COLOR;BX.addClass(e.DOM.pEl,"bxec-sect-el-checked")}var b=e.TEXT_COLOR;if(!b){b=e.bDark?this.darkColor:this.brightColor}if(e.DOM.pText){e.DOM.pText.style.color=b}if(e.DOM.pSPEl){BX.addClass(e.DOM.pSPEl,"bxec-sect-el-checked");e.DOM.pSPEl.style.backgroundColor=e.COLOR}if(e.DOM.pSPText){e.DOM.pSPText.style.color=b}}else{if(e.DOM.pEl){BX.removeClass(e.DOM.pEl,"bxec-sect-el-checked");e.DOM.pEl.style.backgroundColor="transparent"}if(e.DOM.pText){e.DOM.pText.style.color="#484848"}if(e.DOM.pSPEl){BX.removeClass(e.DOM.pSPEl,"bxec-sect-el-checked");e.DOM.pSPEl.style.backgroundColor="transparent"}if(e.DOM.pSPText){e.DOM.pSPText.style.color="#484848"}}this.oActiveSections[e.ID]=e.bShowed=!!d;if(!a){this.SetTabNeedRefresh(this.activeTabId);this.Event.ReloadAll()}},SaveSection:function(){var d=this.oSectDialog,b=d.CAL.oSect;d.CAL.DOM.Name.value=BX.util.trim(d.CAL.DOM.Name.value);if(d.CAL.DOM.Name.value==""){alert(EC_MESS.CalenNameErr);this.bEditCalDialogOver=true;return false}var a=this.GetReqData("section_edit",{name:d.CAL.DOM.Name.value,desc:d.CAL.DOM.Desc.value,color:d.CAL.Color,text_color:d.CAL.TextColor});if(d.CAL.Access){a.access=d.CAL.Access.GetValues()}if(b.ID){a.id=bxInt(b.ID)}if(d.CAL.DOM.Exch){a.is_exchange=d.CAL.DOM.Exch.checked?"Y":"N"}if(d.CAL.DOM.ExpAllow.checked){a["export"]="Y";a.exp_set=d.CAL.DOM.ExpSet?d.CAL.DOM.ExpSet.value:"all"}var e=this;this.Request({postData:a,errorText:EC_MESS.CalenSaveErr,handler:function(f){if(f&&f.calendar&&f.calendar.ID){if(f.accessNames){e.HandleAccessNames(f.accessNames)}e.SaveSectionClientSide(f.calendar);return true}return false}});return true},SaveSectionClientSide:function(f){if(f.EXPORT&&!f.EXPORT.ALLOW){f.EXPORT=false}this.arSPSections=null;if(typeof this.arSectionsInd[f.ID]=="undefined"){this.arSections.push(f);this.arSectionsInd[f.ID]=this.arSections.length-1;this.BuildSectionElement(f,true);this.SaveLastSection(f.ID);if(this.bSuperpose&&this.oSectDialog.CAL.DOM.add2SP){this.SetSuperposed(f,(!this.oSectDialog||this.oSectDialog.CAL.DOM.add2SP.checked))}}else{var d,e=this.arSections[this.arSectionsInd[f.ID]],g=e.COLOR,b=e.TEXT_COLOR,a=!e||f.COLOR!=g||f.TEXT_COLOR!=b;if(!e){return}for(d in f){if(f.hasOwnProperty(d)){e[d]=f[d]}}e.DOM.pText.innerHTML=BX.util.htmlspecialchars(e.NAME);if(e.DOM.pSPText){e.DOM.pSPText.innerHTML=BX.util.htmlspecialchars(e.NAME)}e.bDark=this.ColorIsDark(e.COLOR);this.BuildSectionMenu(f.ID);if(e.DOM.pSPEl){this.BuildSectionMenu(f.ID,true)}if(a){this.UpdateSectionColor(e,g,b)}this.ShowCalendar(e,e.bShowed,true)}},HideCalDavSection:function(a){if(a.ID&&confirm(EC_MESS.googleHideConfirm)){var b=this;this.Request({getData:this.GetReqData("section_caldav_hide",{id:a.ID}),handler:function(d){if(d.refreshView){BX.reload()}return d.result?b.DeleteSectionClientSide(a):false}})}},DeleteSection:function(a){if(!a.ID||!confirm(EC_MESS.DelCalendarConfirm)){return false}var b=this;this.Request({getData:this.GetReqData("section_delete",{id:a.ID}),errorText:EC_MESS.DelCalendarErr,handler:function(d){return d.result?b.DeleteSectionClientSide(a):false}});return true},DeleteSectionClientSide:function(b){BX.cleanNode(b.DOM.pEl,true);if(b.DOM.pSPEl){BX.cleanNode(b.DOM.pSPEl,true)}var a;for(a=0;a<this.arSections.length;a++){if(this.arSections[a].ID==b.ID){this.arSections=BX.util.deleteFromArray(this.arSections,a);break}}this.arSPSections=null;delete this.oActiveSections[b.ID];delete this.oSections[b.ID];this.Event.ReloadAll()},UpdateSectionColor:function(e,p,b){if(!e){return}var h=e.COLOR,a=e.TEXT_COLOR?e.TEXT_COLOR:(e.bDark?this.darkColor:this.brightColor);e.DOM.pEl.style.backgroundColor=h;e.DOM.pText.style.color=a;var t,d,u=[["oTLParts","week"],["oTLParts","day"],["oDaysT","week"],["oDaysT","day"]],o,g=this.arEvents.length,r,m,f,s,q;for(o=0;o<g;o++){r=this.arEvents[o];if(!r){continue}t=!r.displayColor||!p||r.displayColor===p;d=!r.displayTextColor||!b||r.displayTextColor===b;if(r.SECT_ID!=e.ID||(!t&&!d)){continue}f=r.oParts.length;for(m=0;m<f;m++){if(t){r.oParts[m].style.backgroundColor=h}if(d){r.oParts[m].style.color=a}}f=u.length;for(m=0;m<f;m++){if(r[u[m][0]]&&r[u[m][0]][u[m][1]]){q=r[u[m][0]][u[m][1]];if(typeof q=="object"&&q.nodeType){if(t){q.style.backgroundColor=h}if(d){q.style.color=a}}else{for(s=0;s<q.length;s++){if(t){q[s].style.backgroundColor=h}if(d){q[s].style.color=a}}}}}if(t){r.displayColor=h}}},ShowAllCalendars:function(e,d){var b=d?this.arSPCalendarsShow:this.arSections;var f,a=b.length;for(f=0;f<a;f++){el=b[f];this.ShowCalendar(el,e,true,!d)}this.Event.ReloadAll()},CheckCalBarGlobChecker:function(d,b){var a=b?"CalBarGlobCheckerSP":"CalBarGlobChecker";if(d=="none"){this[a].pWnd.className="bxec-cal-bar-none";this[a].pWnd.title=""}else{if(d){this[a].flag=false;this[a].pWnd.className="bxec-iconkit bxec-cal-bar-check";this[a].pWnd.title=EC_MESS.DeSelectAll}else{this[a].flag=true;this[a].pWnd.className="bxec-iconkit bxec-cal-bar-uncheck";this[a].pWnd.title=EC_MESS.SelectAll}}},SetSuperposed:function(d,e){if(d){d.SUPERPOSED=!!e}var f=this,b,a=[];for(b=0;b<this.arSections.length;b++){if(this.arSections[b].SUPERPOSED){a.push(parseInt(this.arSections[b].ID))}}this.Request({getData:this.GetReqData("set_superposed",{sect:a,trackedUser:d&&d.CAL_TYPE=="user"?d.OWNER_ID:0}),errorText:EC_MESS.AppendSPCalendarErr,handler:function(g){if(g.result){if(!f.bSuperpose){return BX.reload()}return f.BuildSectionElements()}return false}})},GetCenterWindowPos:function(a,d){if(!a){a=400}if(!d){d=300}var b=BX.GetWindowSize(document);var f=bxInt(bxInt(b.scrollTop)+(b.innerHeight-d)/2-30);var e=bxInt(bxInt(b.scrollLeft)+(b.innerWidth-a)/2-30);return{top:f,left:e}},ShowStartUpEvent:function(){var e=this,b,a,d=false;for(a=0;a<this.arEvents.length;a++){b=this.arEvents[a];if(this.startupEvent.ID==b.ID||(this.startupEvent.PARENT_ID==b.PARENT_ID)&&b["~TYPE"]!="tasks"){if(this.startupEvent.EDIT){setTimeout(function(){e.Event.Edit({oEvent:b})},1000);break}else{if(!d){d=b}if(this.startupEvent.RRULE&&this.startupEvent["~CURRENT_DATE"]&&this.FormatDate(BX.parseDate(b.DATE_FROM))==this.startupEvent["~CURRENT_DATE"]){d=b;break}}}}if(d){setTimeout(function(){e.Event.View(d)},1000)}this.startupEvent.viewed=true},SaveSettings:function(){var e=this.oSetDialog;if(e.CAL.inPersonal){this.userSettings.blink=e.CAL.DOM.Blink.checked?1:0;this.userSettings.showDeclined=e.CAL.DOM.ShowDeclined.checked?1:0;this.userSettings.meetSection=e.CAL.DOM.SectSelect.value}this.userSettings.showMuted=e.CAL.DOM.ShowMuted.checked?1:0;this.userSettings.denyBusyInvitation=e.CAL.DOM.denyBusyInvitation.checked?1:0;if(e.CAL.DOM.TimezoneSelect){this.arConfig.userTimezoneName=e.CAL.DOM.TimezoneSelect.value}var b=this.GetReqData("save_settings",{user_settings:this.userSettings,user_timezone_name:this.arConfig.userTimezoneName});if(this.PERM.access){b.type_access=e.CAL.Access.GetValues();e.CAL.Access.SetSelected(this.typeAccess);this.settings.work_time_start=e.CAL.DOM.WorkTimeStart.value;this.settings.work_time_end=e.CAL.DOM.WorkTimeEnd.value;this.settings.week_holidays=[];for(var d=0,a=e.CAL.DOM.WeekHolidays.options.length;d<a;d++){if(e.CAL.DOM.WeekHolidays.options[d].selected){this.settings.week_holidays.push(e.CAL.DOM.WeekHolidays.options[d].value)}}this.settings.year_holidays=e.CAL.DOM.YearHolidays.value;this.settings.year_workdays=e.CAL.DOM.YearWorkdays.value;b.settings=this.settings}this.Request({postData:b,handler:function(){BX.reload()}})},ClearPersonalSettings:function(){this.Request({postData:this.GetReqData("save_settings",{clear_all:1}),handler:function(){BX.reload()}})},GetUserHref:function(a){return this.pathToUser.replace(/#user_id#/ig,a)},GetUserProfileLink:function(b,d,h,g,f){var a;if(h.type=="ext"){a="";if(h.email){a=BX.util.htmlspecialchars(h.email)}else{if(h.name){a=BX.util.htmlspecialchars(h.name)}}return a}else{var e=this.arConfig.pathToUser.toLowerCase();e=e.replace("#user_id#",b);g=g?' class="'+g+'"':"";if(!d){return e}a=BX.util.htmlspecialchars(h.name);if(f){a+=' <span style="font-weight: normal !important;">('+EC_MESS.Host+")</span>"}return"<a"+g+' href="'+e+'" target="_blank" title="'+EC_MESS.UserProfile+": "+BX.util.htmlspecialchars(h.name)+'" >'+a+"</a>"}},Day:function(a){return this.days[{MO:0,TU:1,WE:2,TH:3,FR:4,SA:5,SU:6}[a]]},GetWeekDayByInd:function(a){return["SU","MO","TU","WE","TH","FR","SA"][a]},ConvertDayIndex:function(a){if(a==0){return 6}return a-1},Request:function(f){if(!f.url){f.url=this.actionUrl}if(f.bIter!==false){f.bIter=true}if(!f.postData&&!f.getData){f.getData=this.GetReqData()}var a;if(!f.errorText){a=false}var e=f.getData?f.getData.reqId:f.postData.reqId;f.reqId=e;var g=this,b=0,d;if(f.handler){d=function(j){var h=function(){if(g.requests[e].status!=="canceled"){var o=j.toLowerCase().indexOf("bx_event_calendar_action_error");if(!j||j.length<=0||o!=-1){var m="";if(o>=0){var l=o+"BX_EVENT_CALENDAR_ACTION_ERROR:".length,q=j.indexOf("-->",l);m=j.substr(l,q-l)}if(f.onerror&&typeof f.onerror=="function"){f.onerror()}return g.DisplayError(m||f.errorText||"")}g.requests[e].status="complete";var p=f.handler(g.GetRequestRes(e),j);if(p===false&&++b<20&&f.bIter){setTimeout(h,5)}else{g.ClearRequestRes(e)}}};setTimeout(h,50)}}else{d=BX.DoNothing()}this.requests[f.reqId]={status:"sent",xhr:f.postData?BX.ajax.post(f.url,f.postData,d):BX.ajax.get(f.url,f.getData,d)};return f},GetReqData:function(a,b){if(!b){b={}}if(a){b.action=a}b.sessid=BX.bitrix_sessid();b.bx_event_calendar_request="Y";b.reqId=Math.round(Math.random()*1000000);return b},CancelRequest:function(a){if(this.requests[a]&&this.requests[a].status=="sent"){this.requests[a].status="canceled"}},GetRequestRes:function(a){if(top.BXCRES&&typeof top.BXCRES[a]!="undefined"){return top.BXCRES[a]}return{}},ClearRequestRes:function(a){if(top.BXCRES){top.BXCRES[a]=null;delete top.BXCRES[a]}},ExtendUserSearchInput:function(){if(!window.SonetTCJsUtils){return}var a=this;if(!SonetTCJsUtils.EC__GetRealPos){SonetTCJsUtils.EC__GetRealPos=SonetTCJsUtils.GetRealPos}SonetTCJsUtils.GetRealPos=function(d){var b=SonetTCJsUtils.EC__GetRealPos(d);if(a.oSuperposeDialog&&a.oSuperposeDialog.bShow){scrollTop=a.oSuperposeDialog.oCont.scrollTop;b.top=bxInt(b.top)-scrollTop;b.bottom=bxInt(b.bottom)-scrollTop}return b}},ParseLocation:function(g,e){if(!g){g=""}var d={mrid:false,mrevid:false,str:g};if(g.length>5&&g.substr(0,5)=="ECMR_"){var f=g.split("_");if(f.length>=2){if(!isNaN(parseInt(f[1]))&&parseInt(f[1])>0){d.mrid=parseInt(f[1])}if(!isNaN(parseInt(f[2]))&&parseInt(f[2])>0){d.mrevid=parseInt(f[2])}}}if(d.mrid&&e===true){for(var b=0,a=this.meetingRooms.length;b<a;b++){if(this.meetingRooms[b].ID==d.mrid){d.mrind=b;d.MR=this.meetingRooms[b];break}}}return d},OnResize:function(a){if(this._resizeTimeout){this._resizeTimeout=clearTimeout(this._resizeTimeout)}var b=this;if(a!==false){this._resizeTimeout=setTimeout(function(){b.OnResize(false)},a||200)}else{switch(this.activeTabId){case"month":setTimeout(BX.delegate(this.BuildDaysTitle,this),100);break;case"week":case"day":this.ResizeTabTitle(this.Tabs[this.activeTabId]);break}this.bJustRedraw=true;this.SetView({month:this.activeDate.month,year:this.activeDate.year});setTimeout(function(){b.bJustRedraw=false},500)}},_OnPopupCloseHandler:function(a){if(a&&a.popupContainer&&a.popupContainer.id&&a.popupContainer.id.indexOf("timeman")!==-1){this.OnResize()}BX.removeCustomEvent("onPopupClose",BX.proxy(this._OnPopupCloseHandler,this))},CreateStrut:function(a){return BX.create("DIV",{style:{width:a+"px",height:"1px"}})},CheckMouseInCont:function(f,g,h){var l=BX.pos(f),b=BX.GetWindowScrollPos(),a=g.clientX+b.scrollLeft,j=g.clientY+b.scrollTop;if(typeof h=="undefined"){h=0}return(a>=l.left-h&&a<=l.right+h&&j<=l.bottom+h&&j>=l.top-h)},SaveCalDavConnections:function(g,e){var d=[],b,a;for(b=0;b<this.arConnections.length;b++){a=this.arConnections[b];var h={};for(var f in a.sections){if(!a.sections.hasOwnProperty(f)){continue}h[f]=a.sections[f].checked?"Y":"N"}d.push({id:a.id||0,name:a.name,link:a.link,user_name:a.user_name,pass:typeof a.pass=="undefined"?"bxec_not_modify_pass":a.pass,del:a.del?"Y":"N",del_calendars:a.pDelCalendars.checked?"Y":"N",sections:h})}this.Request({postData:this.GetReqData("connections_edit",{connections:d}),handler:function(){setTimeout(function(){if(g&&typeof g=="function"){g(true)}},100)},onerror:function(){if(e&&typeof e=="function"){e()}}});return true},IsDavCalendar:function(a){return this.oSections[a]&&(this.oSections[a].IS_EXCHANGE||this.oSections[a].CAL_DAV_CON)},Section:function(b){var a={};if(this.arSectionsInd[b]&&this.arSections[this.arSectionsInd[b]]){a=this.arSections[this.arSectionsInd[b]]}return a},CanDo:function(b,d){var a=this.Section(d);return a.ID&&a.PERM[b]},DefaultAction:function(a){if(typeof a=="undefined"&&!this.bDoDefault){this.bDoDefault=true;return false}if(a===false){this.bDoDefault=false}return true},OnTaskChanged:function(){if(!this.oActiveSections.tasks){return this.ShowCalendar(this.oSections.tasks,true)}this.Event.ReloadAll()},OnTaskKilled:function(d){for(var b=0,a=this.arEvents.length;b<a;b++){if(this.arEvents[b]["~TYPE"]=="tasks"&&this.arEvents[b].ID==d){this.Event.UnDisplay(this.arEvents[b]);break}}},HandleAccessNames:function(a){for(var b in a){if(a.hasOwnProperty(b)){this.arNames[b]=a[b]}}},GetAccessName:function(a){return this.arNames[a]||a},GetMeetingSection:function(){if(this.userSettings.meetSection&&this.oSections[this.userSettings.meetSection]&&this.oSections[this.userSettings.meetSection].ACTIVE!=="N"){return this.userSettings.meetSection}return this.arSections[0]["ID"]},CheckMeetingRoom:function(a,b){this.Request({postData:this.GetReqData("check_meeting_room",a),handler:function(d){if(d){if(b&&typeof b=="function"){b(d.check)}return true}}})},AddGroupMembers:function(){var b=this,a={};this.Request({postData:this.GetReqData("get_group_members",a),handler:function(d){if(d){if(d.users){BX.onCustomEvent(b,"onGetGroupMembers",[d.users])}return true}}})},ItsYou:function(a){if(a==this.userId){return'<span class="bxc-it-is-you"> ('+EC_MESS.ItIsYou+")</span>"}return""},Personal:function(){return this.type=="user"&&this.ownerId==this.userId},GetFreeDialogColor:function(){var a=this.Colors[0],e,d={},b;for(e in this.Colors){d[this.Colors[e]]=true}for(e in this.arSections){b=this.arSections[e].COLOR;if(d[b]){d[b]=false}}for(e in d){if(d[e]){a=e;break}}return a},FormatDate:function(a){return BX.date.format(this.DATE_FORMAT,a.getTime()/1000)},FormatTime:function(a,b){return BX.date.format(b===true?this.TIME_FORMAT:this.TIME_FORMAT_SHORT,a.getTime()/1000)},FormatDateTime:function(a){return BX.date.format(this.DATETIME_FORMAT,a.getTime()/1000)},ParseDate:function(l,e){var v=false;var u=BX.message("FORMAT_DATETIME");l=BX.util.trim(l);if(e!==false){u=u.replace(":SS","")}if(BX.type.isNotEmptyString(l)){var f="";for(r=1;r<=12;r++){f=f+"|"+BX.message("MON_"+r)}var b=new RegExp("([0-9]+|[a-z]+"+f+")","ig");var y=l.match(b),g=BX.message("FORMAT_DATE").match(/(DD|MI|MMMM|MM|M|YYYY)/ig),r,q,s=[],j=[],a={};if(!y){return null}if(y.length>g.length){g=u.match(/(DD|MI|MMMM|MM|M|YYYY|HH|H|SS|TT|T|GG|G)/ig)}for(r=0,q=y.length;r<q;r++){if(BX.util.trim(y[r])!=""){s[s.length]=y[r]}}for(r=0,q=g.length;r<q;r++){if(BX.util.trim(g[r])!=""){j[j.length]=g[r]}}var o=BX.util.array_search("MMMM",j);if(o>0){s[o]=BX.getNumMonth(s[o]);j[o]="MM"}else{o=BX.util.array_search("M",j);if(o>0){s[o]=BX.getNumMonth(s[o]);j[o]="MM"}}for(r=0,q=j.length;r<q;r++){var p=j[r].toUpperCase();a[p]=p=="T"||p=="TT"?s[r]:parseInt(s[r],10)}if(a.DD>0&&a.MM>0&&a.YYYY>0){var x=new Date();if(v){x.setUTCDate(1);x.setUTCFullYear(a.YYYY);x.setUTCMonth(a.MM-1);x.setUTCDate(a.DD);x.setUTCHours(0,0,0)}else{x.setDate(1);x.setFullYear(a.YYYY);x.setMonth(a.MM-1);x.setDate(a.DD);x.setHours(0,0,0)}if((!isNaN(a.HH)||!isNaN(a.GG)||!isNaN(a.H)||!isNaN(a.G))&&!isNaN(a.MI)){if(!isNaN(a.H)||!isNaN(a.G)){var w=(a.T||a.TT||"am").toUpperCase()=="PM";var t=parseInt(a.H||a.G||0,10);if(w){a.HH=t+(t==12?0:12)}else{a.HH=t<12?t:0}}else{a.HH=parseInt(a.HH||a.GG||0,10)}if(isNaN(a.SS)){a.SS=0}if(v){x.setUTCHours(a.HH,a.MI,a.SS)}else{x.setHours(a.HH,a.MI,a.SS)}}return x}}return null},FormatTimeByNum:function(e,a){var d="";if(a==undefined){a="00"}else{a=parseInt(a,10);if(isNaN(a)){a="00"}else{if(a>59){a=59}a=(a<10)?"0"+a.toString():a.toString()}}e=parseInt(e,10);if(e>24){e=24}if(isNaN(e)){e=0}if(this.bAMPM){var b="am";if(e==0){e=12}else{if(e==12){b="pm"}else{if(e>12){b="pm";e-=12}}}d=e.toString()+":"+a.toString()+" "+b}else{d=((e<10)?"0":"")+e.toString()+":"+a.toString()}return d},ParseTime:function(f){var e,b,a;f=BX.util.trim(f);f=f.toLowerCase();if(this.bAMPM){var d="pm";if(f.indexOf("am")!=-1){d="am"}f=f.replace(/[^\d:]/ig,"");a=f.split(":");e=parseInt(a[0]||0,10);b=parseInt(a[1]||0,10);if(e==12){if(d=="am"){e=0}else{e=12}}else{if(e!=0){if(d=="pm"&&e<12){e+=12}}}}else{a=f.split(":");e=a[0]||0;b=a[1]||0;if(e.toString().length>2){e=parseInt(e.toString().substr(0,2))}b=parseInt(b)}if(isNaN(e)||e>24){e=0}if(isNaN(b)||b>60){b=0}return{h:e,m:b}},CheckType:function(b,a){return this.type==b&&this.ownerId==a},CheckSectionsCount:function(){var a;for(a=0;a<this.arSections.length;a++){if(this.arSections[a].PERM.edit_section&&this.IsCurrentViewSect(this.arSections[a])){return true}}return false},GetWeekStart:function(){return this.weekStart},GetWeekDayOffset:function(a){if(!this.weekDayOffsetIndex){this.weekDayOffsetIndex={};for(var b=0;b<this.weekDays.length;b++){this.weekDayOffsetIndex[this.weekDays[b][2]]=b}}return this.weekDayOffsetIndex[a]},SaveLastSection:function(a){this.lastSection=parseInt(a);BX.userOptions.save("calendar","last_section",this.type+"_"+this.ownerId,this.lastSection)},GetLastSection:function(){return this.lastSection}};window.bxInt=function(a){return parseInt(a,10)};window.bxIntEx=function(a){a=parseInt(a,10);if(isNaN(a)){a=0}return a};window.bxSpCh=function(a){if(!a){return""}a=a.replace(/script_>/g,"script>");a=a.replace(/&/g,"&amp;");a=a.replace(/"/g,"&quot;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a};window.bxSpChBack=function(a){if(!a){return""}a=a.replace(/&lt;/g,"<");a=a.replace(/&gt;/g,">");a=a.replace(/&quot;/g,'"');a=a.replace(/&amp;/g,"&");a=a.replace(/script_>/g,"script>");return a};window.EnterAndNotTextArea=function(b,d){if(b.keyCode==13){var a=b.target||b.srcElement;if(a&&a.nodeName&&a.nodeName.toLowerCase()!="textarea"&&a.id.indexOf(d)==-1){BX.PreventDefault(b);return true}}return false};function bxGetDateFromTS(e,a){var d=new Date(e);if(!a){var f=d.getHours()||0,b=d.getMinutes()||0;d={date:d.getDate(),month:d.getMonth()+1,year:d.getFullYear(),bTime:!!(f||b),oDate:d};if(d.bTime){d.hour=f;d.min=b}}return d}window.bxFormatDate=function(e,a,f){var b=BX.message("FORMAT_DATE");b=b.replace(/YY(YY)?/ig,f);b=b.replace(/MMMM/ig,BX.message("MONTH_"+Number(a)));b=b.replace(/MM/ig,zeroInt(a));b=b.replace(/M/ig,BX.message("MON_"+Number(a)));b=b.replace(/DD/ig,zeroInt(e));return b};window.zeroInt=function(a){a=bxInt(a);if(isNaN(a)){a=0}return a<10?"0"+a.toString():a.toString()};window.DenyDragEx=function(a){a.style.MozUserSelect="none";a.ondrag=BX.False;a.ondragstart=BX.False;a.onselectstart=BX.False};JCEC.prototype.GetCurrentSections=function(){var a,b=[],e=[],d=[];for(a in this.oActiveSections){if(this.oActiveSections.hasOwnProperty(a)){if(a!="tasks"){a=parseInt(a);if(a<0||isNaN(a)){continue}}if(this.oActiveSections[a]){if(this.arSectionsInd[a]&&this.arSections[this.arSectionsInd[a]]&&this.arSections[this.arSectionsInd[a]].SUPERPOSED){b.push(a)}else{e.push(a)}}else{d.push(a)}}}return{superposed:b,active:e,hidden:d}};JCEC.prototype.LoadEvents=function(a,j,f){if(a==undefined){a=this.activeDate.month}if(j==undefined){j=this.activeDate.year}if(f==undefined){f={}}var b,e,h=this,g=this.GetCurrentSections();var d=this.Request({getData:this.GetReqData("load_events",{month:parseInt(a,10)+1,year:j,usecl:"Y",active_sect:g.active,hidden_sect:g.hidden,sup_sect:g.superposed,cal_dav_data_sync:this.bSyncGoogle?"Y":"N"}),errorText:EC_MESS.LoadEventsErr,handler:function(l){if(h.loadEventsLastRequestId){if(h.loadEventsLastRequestId==d.reqId){h.loadEventsLastRequestId=false}else{h.CancelRequest(h.loadEventsLastRequestId)}}var m=h.GetCurrentSections();if(!h.CompareArrays(g.superposed,m.superposed)||!h.CompareArrays(g.active,m.active)||!h.CompareArrays(g.hidden,m.hidden)){return}if(h.bCalDAV&&h.bSyncGoogle&&l.connections&&l.connections.length>0){h.arConnections=l.connections;for(e in h.arSections){if(h.arSections.hasOwnProperty(e)){b=h.arSections[e];if(b.CAL_DAV_CAL&&b.CAL_DAV_CON&&b.DOM.pStatus){for(i in h.arConnections){if(h.arConnections.hasOwnProperty(i)&&h.arConnections[i].id==b.CAL_DAV_CON){b["~CAL_DAV_LAST_SYNC"]=h.arConnections[i].last_result;if(b["~CAL_DAV_LAST_SYNC"].indexOf("[200]")>=0){b.DOM.pStatus.className="bxec-spr bxec-cal-dav-google";b.DOM.pStatus.title=""}else{b.DOM.pStatus.className="bxec-spr bxec-cal-dav-google-fail";b.DOM.pStatus.title=EC_MESS.SyncError+": "+el["~CAL_DAV_LAST_SYNC"]}break}}}}}}h.bSyncGoogle=false;h.HandleLoadedEvents({events:l.events,attendees:l.attendees,month:a,year:j,Params:f})}});this.loadEventsLastRequestId=d.reqId};JCEC.prototype.HandleLoadedEvents=function(a){this.HandleEvents(a.events,a.attendees);this.arLoadedMonth[a.month+"."+a.year]=true;if(!a.Params){a.Params={}}if(isNaN(bxInt(a.Params.month))){a.Params.month=a.month}if(isNaN(bxInt(a.Params.year))){a.Params.year=a.year}this.SetView(a.Params)};JCEC.prototype.HandleEvents=function(g,h){var f,j,d,b,l;if(g&&g.length){for(f=0;f<g.length;f++){j=this.Event.PreHandle(g[f]);b=this.Event.SmartId(j);if(!j.ID){continue}if(this.arLoadedEventsId[b]){continue}this.arEvents.push(j);this.arLoadedEventsId[b]=true}}if(h){for(f in h){l=parseInt(f,10);d=h[f];if(!isNaN(l)&&d&&d.length){this.arAttendees[l]=d}}}};JCEC.prototype.HandleAccessibility=function(d){var b,a;if(d){for(a in d){if(d.hasOwnProperty(a)&&d[a].length>0){for(b=0;b<d[a].length;b++){d[a][b]=this.Event.PreHandle(d[a][b])}}}}return d};JCEC.prototype.FilterAccessibility=function(a,d,b){return a};JCEC.prototype.BuildEventHolder=function(){if(this.EventHolderCont){BX.cleanNode(this.EventHolderCont,true);this.EventHolderCont=null}this.EventHolderCont=this.DaysGridCont.appendChild(BX.create("DIV",{props:{className:"bxec-event-holder"}}));var b=this;var a=this.oDaysGridTable.rows[0].cells[0];setTimeout(function(){b.arCellCoords={};for(var e=0;e<7;e++){b.arCellCoords[e]={left:bxInt(b.oDaysGridTable.rows[0].cells[e].offsetLeft),width:bxInt(b.oDaysGridTable.rows[0].cells[e].offsetWidth)}}b.dayCellHeight=parseInt(a.offsetHeight);b.dayCellWidth=parseInt(a.offsetWidth);b.DisplayEventsMonth()},10)};JCEC.prototype.EventClick=function(g){if(!g){g=window.event}var d,b,f,a,h=g.target||g.srcElement;while(h){if(h.getAttribute){d=parseInt(h.getAttribute("data-bx-event-ind"));b=h.getAttribute("data-bx-event-action");if(b){f=b}if(!isNaN(d)&&this.arEvents[d]){a=this.arEvents[d];if(!f||f=="view"){this.Event.View(a)}else{if(f=="edit"){this.Event.Edit({oEvent:a})}else{if(f=="del"){if(this.Event.IsAttendee(a)&&!this.Event.IsHost(a)){if(a.MEETING_STATUS!="N"){this.Event.SetMeetingStatus(false,{eventId:bxInt(a.ID),comment:""})}}else{if(a["~TYPE"]!="tasks"){this.Event.Delete(a)}}}}}if(this.MoreEventsWin){this.MoreEventsWin.close()}break}}h=h.parentNode}};JCEC.prototype.DisplayEventsMonth=function(b){var a;if(b||this.bJustRedraw){BX.cleanNode(this.EventHolderCont);for(a=0;a<this.activeDateObjDays.length;a++){this.activeDateObjDays[a].arEvents={begining:[],all:[]}}}else{this.activeFirst=this.activeDateDays[0].getTime();this.activeLast=this.activeDateDays[this.activeDateDays.length-1].getTime()}for(a=0;a<this.arEvents.length;a++){if(this.arEvents[a]){this.HandleEventMonth(this.arEvents[a],a)}}this.RefreshEventsOnWeeks([0,1,2,3,4,5])};JCEC.prototype.HandleEventMonth=function(h,e,l){var f,g,j,b;h=this.HandleEventCommon(h,e);if(!h){return}h.oParts=[];h.oWeeks=[];if(!l){f=bxGetDateFromTS(h.DT_FROM_TS);g=bxGetDateFromTS(h.DT_TO_TS);if(f.bTime&&!g.bTime){g=bxGetDateFromTS(h.DT_TO_TS-60*60*24)}f={date:f.date,month:f.month-1,year:f.year};g={date:g.date,month:g.month-1,year:g.year};j=new Date(f.year,f.month,f.date).getTime();b=new Date(g.year,g.month,g.date).getTime()}else{f=l.d_from;g=l.d_to;j=l._d_from;b=l._d_to}if(j>b||b<this.activeFirst||j>this.activeLast){return}var d={real_from:f,real_to:g,from:j,to:b,real_from_t:j,real_to_t:b};if(j<this.activeFirst&&b<this.activeLast){d.from=this.activeFirst}else{if(j>this.activeFirst&&b>this.activeLast){d.to=this.activeLast}else{if(j<this.activeFirst&&b>this.activeLast){d.from=this.activeFirst;d.to=this.activeLast}}}h.display=true;var a=(h.DT_TO_TS+(h.DT_SKIP_TIME=="Y"?this.dayLength:300000))<new Date().getTime();h.bMuted=this.userSettings.showMuted&&a;this.DisplayEvent_M(d,h);if(!a){this.Event.Blink(h,true,true)}};JCEC.prototype.HandleEventCommon=function(a,b){if((!this.userSettings.showDeclined||a.CREATED_BY!==this.userId)&&a.MEETING_STATUS=="N"&&(!this.startupEvent||(this.startupEvent&&this.startupEvent.ID!=a.ID))){return false}if(!a.oParts){a.oParts=[]}if(!a.oWeeks){a.oWeeks=[]}a.ind=b;a=this.Event.SetColor(a);return a};JCEC.prototype.DisplayEvent_M=function(a,l){var d,e,b,m,f={partDaysCount:0},h=false,g=false;for(e=0,b=this.activeDateDays.length;e<b;e++){d=this.activeDateDays[e];m=this.GetWeekDayOffset(this.GetWeekDayByInd(d.getDay()));if(d.getTime()==a.from){h=true;f={left:this.arCellCoords[m].left+1,arInit:a,dayIndex:e,partDaysCount:0}}f.partDaysCount++;if(!h){continue}this.activeDateObjDays[e].arEvents.all.push({oEvent:l,partInd:l.oParts.length,daysCount:f.partDaysCount});if(m==6){g=d.getTime()==a.to;f.width=this.arCellCoords[m].left+this.arCellCoords[m].width-f.left-3;f.bEnd=g&&a.to==a.real_to_t;this.BuildEventDiv(f,l);if(g){break}}if(!g&&m==0&&d.getTime()!=a.from){f={left:this.arCellCoords[0].left+1,arInit:a,dayIndex:e,partDaysCount:1}}if(d.getTime()==a.to){g=true;f.width=this.arCellCoords[m].left+this.arCellCoords[m].width-f.left-3;f.bEnd=true;this.BuildEventDiv(f,l);break}}};JCEC.prototype.BuildEventDiv=function(h,e){if(parseInt(h.width)<=0){return}var d,s,a;this.activeDateObjDays[h.dayIndex].arEvents.begining.push({oEvent:e,partInd:e.oParts.length,daysCount:h.partDaysCount});var j=this.Event.IsTask(e),b=this.Event.IsCrm(e);var l="bxec-event";if(e.bMuted){l+=" bxec-event-muted"}d=BX.create("DIV",{props:{className:l},style:{left:h.left+"px",width:bxInt(h.width)+"px",minWidth:bxInt(h.width)+"px",display:"none",backgroundColor:e.displayColor,color:e.displayTextColor}});s=d.appendChild(BX.create("TABLE"));a=s.insertRow(-1);var g=this;if(e.oParts.length>0||h.arInit.real_from_t<h.arInit.from){BX.adjust(a.insertCell(-1),{props:{className:"bxec-event-ar"},html:"<i></i>"})}var o,m=this.Event.IsMeeting(e),q=this.Event.GetQuestIcon(e),p=a.insertCell(-1),f="";if(m){f='<i class="bxc-e-meeting"></i>'}if(j){f='<i class="bxc-e-task"></i>'}if(b&&!j){f='<i class="bxc-e-crm"></i>'}p.innerHTML='<div class="bxec-event-title">'+f+'<span class="bxec-event-label"'+this.Event.GetLabelStyle(e)+">"+q+BX.util.htmlspecialchars(e.NAME)+"</span></div>";this.Event.BuildActions({cont:p,oEvent:e,evCont:d});if(!h.bEnd){BX.adjust(a.insertCell(-1),{props:{className:"bxec-event-ar"},html:"<b></b>"})}d.onmouseover=function(){g.HighlightEvent_M(e,this)};d.onmouseout=function(){g.HighlightEvent_M(e,this,true)};d.ondblclick=function(){g.Event.View(e)};d.setAttribute("data-bx-event-ind",e.ind);this.dragDrop.RegisterEvent(d,e,"month");e.oWeeks.push({dayIndex:h.dayIndex,bEnd:h.bEnd});e.oParts.push(d);if((h.dayIndex+1)%7==0){o=bxInt(h.width)}else{o=((8-((h.dayIndex+1)%7))*(bxInt(h.width)-1))}if(o>this.DaysTitleCont.offsetWidth){o=this.DaysTitleCont.offsetWidth-10}p.firstChild.style.maxWidth=o+"px";this.EventHolderCont.appendChild(d)};JCEC.prototype.HighlightEvent_M=function(b,h,g){if(!b||!b.oParts||b.oParts.length==0){return}var d,a,e=g?BX.removeClass:BX.addClass;for(d=0,a=b.oParts.length;d<a;d++){e(b.oParts[d],"bxec-event-over")}if(h){e(h,"bxec-event-over")}if(b.pMoreDivs){for(d=0,a=b.pMoreDivs.length;d<a;d++){e(b.pMoreDivs[d],"bxec-event-over")}}};JCEC.prototype.GetEventWeeks=function(b){var f,d,g=[],e,a;for(e=0,a=b.oParts.length;e<a;e++){f=b.oWeeks[e].dayIndex;for(d=0;d<6;d++){if(f>=d*7&&f<(d+1)*7){g.push(d);break}}}return g};JCEC.prototype.BuildWeekEventHolder=function(){if(this._bBETimeOut){clearTimeout(this._bBETimeOut)}var a=this;this._bBETimeOut=setTimeout(function(){var b=a.Tabs[a.activeTabId||a.userSettings.tabId];if(!b.pEventHolder){b.pEventHolder=b.pBodyCont.querySelector(".bxec-day-t-event-holder")}if(a.bJustRedraw){a.ReBuildEvents(b.id)}else{a.DisplayWeekEvents(b)}},0)};JCEC.prototype.DisplayWeekEvents=function(b){BX.cleanNode(b.pEventHolder);for(var d=0,a=this.arEvents.length;d<a;d++){if(this.arEvents[d]){this.HandleWeekEvent({Tab:b,Event:this.arEvents[d],ind:d})}}this.RefreshEventsInDayT(b);this.ArrangeEventsInTL(b)};JCEC.prototype.ReBuildEvents=function(e){var d=this.Tabs[e],a=d.pTimelineCont,h,f,b,g;BX.cleanNode(d.pEventHolder);for(f=0;f<d.daysCount;f++){g=d.arDays[f];g.TLine={};g.Events={begining:[],hidden:[],all:[]};g.EventsCount=0}b=a.childNodes.length;f=0;while(f<b){h=a.childNodes[f];if(h.className.toString().indexOf("bxec-tl-event")==-1){f++;continue}a.removeChild(h);b=a.childNodes.length}this.DisplayWeekEvents(d)};JCEC.prototype.HandleWeekEvent=function(f){var e=this.HandleEventCommon(f.Event,f.ind);if(!e){return}if(!e.oDaysT){e.oDaysT={}}if(!e.oTLParts){e.oTLParts={}}e.oTLParts[f.Tab.id]=[];var d=e.DT_FROM_TS,j=e.DT_TO_TS,h=bxGetDateFromTS(d),b=bxGetDateFromTS(j);if(j<f.Tab.activeFirst||d>f.Tab.activeLast){return}if(e.DT_SKIP_TIME!="Y"&&j==f.Tab.activeFirst&&j!==d){return}if(h.bTime&&!b.bTime){j-=1000}var a={real_from:h,real_to:b,from:d,to:j,real_from_t:d,real_to_t:j};if(d<f.Tab.activeFirst&&j<=f.Tab.activeLast){a.from=f.Tab.activeFirst}else{if(d>=f.Tab.activeFirst&&j>f.Tab.activeLast){a.to=f.Tab.activeLast}else{if(d<f.Tab.activeFirst&&j>f.Tab.activeLast){a.from=f.Tab.activeFirst;a.to=f.Tab.activeLast}}}e.display=true;var g=(e.DT_TO_TS+(e.DT_SKIP_TIME=="Y"?this.dayLength:300000))<new Date().getTime();e.bMuted=this.userSettings.showMuted&&g;if(f.Event.DT_SKIP_TIME=="Y"){this.DisplayEvent_DT(a,e,f.Tab)}else{this.DisplayEventOnTimeline(a,e,f.Tab)}if(!g){this.Event.Blink(e,true,true)}};JCEC.prototype.DisplayEvent_DT=function(b,v,j){var y=this,m=false,l=this.ConvertDayIndex(new Date(b.from).getDay()),A=this.ConvertDayIndex(new Date(b.to).getDay()),g={oEvent:v,daysCount:A-l+1},o,d,B=this.Event.IsTask(v),p=this.Event.IsCrm(v),f="",z,u;for(z=0;z<j.daysCount;z++){u=j.arDays[z];if(u.day==l){o=u;d=u;m=true;u.Events.begining.push(g)}if(!m){continue}u.Events.all.push(g);u.EventsCount++;if(u.day==A){d=u;break}}if(o&&d){var e=bxInt(o.pWnd.offsetLeft)+2,C=bxInt(d.pWnd.offsetLeft)+bxInt(d.pWnd.offsetWidth),x=C-e-5,h=BX.create("DIV",{props:{className:"bxec-event"},style:{left:e.toString()+"px",width:x.toString()+"px",backgroundColor:v.displayColor,color:v.displayTextColor}}),q=h.appendChild(BX.create("TABLE")),s=q.insertRow(-1);v.oDaysT[j.id]=h;h.setAttribute("data-bx-event-ind",v.ind);if(v.bMuted){BX.addClass(h,"bxec-event-muted")}if(b.real_from_t<b.from){c=s.insertCell(-1);c.innerHTML='<img class="bxec-iconkit" src="/bitrix/images/1.gif">';c.className="bxec-event-ar-l"}if(this.Event.IsMeeting(v)){f='<i class="bxc-e-meeting"></i>'}if(B){f='<i class="bxc-e-task"></i>'}if(p&&!B){f='<i class="bxc-e-crm"></i>'}var w=this.Event.GetQuestIcon(v),a=s.insertCell(-1);a.innerHTML='<div class="bxec-event-title">'+f+'<span class="bxec-event-label"'+this.Event.GetLabelStyle(v)+">"+w+BX.util.htmlspecialchars(v.NAME)+"</span></div>";this.Event.BuildActions({cont:a,oEvent:v,evCont:h});h.onmouseover=function(){y.HighlightEvent_DT(this)};h.onmouseout=function(){y.HighlightEvent_DT(this,true)};h.ondblclick=function(){y.Event.View(v)};this.dragDrop.RegisterEvent(h,v,"week_title");if(j.pEventHolder){j.pEventHolder.appendChild(h)}}};JCEC.prototype.DisplayEventOnTimeline=function(e,r,g){if(e.from==e.to){e.to+=60*1000}var q=false,m=new Date(e.from),s=new Date(e.to),f=this.ConvertDayIndex(m.getDay()),d=this.ConvertDayIndex(s.getDay()),l=m.getHours()||0,t=m.getMinutes()||0,h=s.getHours(),a=s.getMinutes(),o,b,j,p;if(parseInt(r.DT_LENGTH)>0){if(!s){h=23;a=59}else{if(e.from==e.to){if(a==59){h++;a=0}else{a++}}else{if(a==0&&h==0){if(d>f){d--;h=23;a=59}else{a=1}}else{if(a==0&&h>0){h--;a=59}else{if(a>1){a--}}}}}}for(j=0;j<g.daysCount;j++){p=g.arDays[j];if(p.day==f){o=p;b=p;q=true}if(!q){continue}if(p.day==d){b=p;break}}if(o&&b){this._SetTimeEvent(o,l,t,{oEvent:r,bStart:true,arInit:e});this._SetTimeEvent(b,h,a,{oEvent:r,bStart:false,arInit:e})}};JCEC.prototype._SetTimeEvent=function(e,d,a,b){if(!e.TLine){e.TLine={}}d=bxInt(d);a=bxInt(a);if(!e.TLine[d]){e.TLine[d]={}}if(!e.TLine[d][a]){e.TLine[d][a]=[]}e.TLine[d][a].push(b)};JCEC.prototype.HighlightEvent_DT=function(d,a){var b=a?BX.removeClass:BX.addClass;b(d,"bxec-event-over")};JCEC.prototype.RefreshEventsInDayT=function(d){var o=[],b=0,t=3,s,h,e,g,r,p,a,m,q;for(g=0;g<t;g++){o[g]=0}for(h=0;h<d.daysCount;h++){s=d.arDays[h];e=s.Events.begining;n=e.length;m=[];if(n>0){e.sort(function(j,f){return f.daysCount-j.daysCount});eventloop:for(k=0;k<n;k++){r=e[k];if(!r){continue}if(!this.arEvents[r.oEvent.ind]){s.Events.begining=e=BX.util.deleteFromArray(e,k);r=e[k];if(!r){continue}}for(g=0;g<t;g++){if(o[g]-b<=0){o[g]=b+r.daysCount;q=21+g*18;r.oEvent.oDaysT[d.id].style.top=(21+g*18).toString()+"px";continue eventloop}}m[r.oEvent.ID]=true;s.Events.hidden.push(r)}}p=s.Events.all;for(var u=0,l=p.length;u<l;u++){r=p[u];if(!r||m[r.oEvent.ID]){continue}if(!this.arEvents[r.oEvent.ind]){s.Events.all=p=BX.util.deleteFromArray(p,u);r=p[u];if(!r){continue}}a=r.oEvent.oDaysT[d.id].style.display;if(a&&a.toLowerCase()=="none"){s.Events.hidden.push(r)}}this.ShowMoreEventsSelectWeek(s,d.id);b++}};JCEC.prototype.ShowMoreEventsSelectWeek=function(m,d){var h=this,f=m.Events.hidden,e=f.length,o=[],j=m.pMoreEvents.firstChild,g,b,a;if(e<=0){j.style.display="none";return}for(g=0;g<e;g++){b=f[g];a=b.oEvent.oDaysT[d];a.style.display="none";o.push({pDiv:a,oEvent:b.oEvent})}j.style.display="block";j.innerHTML=EC_MESS.MoreEvents+" ("+e+" "+EC_MESS.Item+")";j.onmousedown=function(l){if(!l){l=window.event}BX.PreventDefault(l)};j.onclick=function(){h.ShowMoreEventsWin({Events:o,id:"day_t_"+d+m.day,pDay:m.pWnd,mode:"day_t",pSelect:j})}};JCEC.prototype.ArrangeEventsInTL=function(t){try{var f=false,H,E,I,z,g,q=0,v,M,D,B,y,p,u={},j=0,b,F,w,J;for(F=0;F<t.daysCount;F++){b=t.arDays[F];M=[];if(j>0){if(!b.TLine){b.TLine={}}for(g in u){if(u[g]&&typeof u[g]=="object"&&u[g].oEvent){if(!b.TLine["0"]){b.TLine["0"]={}}if(!b.TLine["0"]["0"]){b.TLine["0"]["0"]=[]}b.TLine["0"]["0"].push({oEvent:u[g].oEvent,bStart:true,dontClose:false,arInit:u[g].arInit})}}}if(!f&&!b.TLine){continue}p=true;if(b.TLine){for(H=0;H<=23;H++){if(!b.TLine[H]&&H!=23){continue}for(E=0;E<60;E++){w=b.TLine[H]&&b.TLine[H][E]?b.TLine[H][E]:false;if(H==23&&E==59){if(w===false){w=[]}for(g in u){if(u[g]&&typeof u[g]=="object"&&u[g].oEvent){w.push({oEvent:u[g].oEvent,bStart:false,dontClose:true,arInit:u[g].arInit})}}}if(!w){continue}for(I=0;I<w.length;I++){J=w[I];if(J.bStart){u[J.oEvent.ID]=J;j++;if(p){M.push([])}D=M[M.length-1];y=false;p=false;if(D.length>1){for(A=0,x=D.length;A<x;A++){B=D[A];if(!B.bFilled){y=A;break}}}v={bFilled:true,evId:J.oEvent.ID,h_f:H,m_f:E};if(y!==false){v.arEvents=D[y].arEvents;D[y]=v}else{D.push(v)}}else{p=true;if(!J.dontClose){u[J.oEvent.ID]=false;j--}for(A=0;A<D.length;A++){B=D[A];if(B.bFilled&&B.evId==J.oEvent.ID){B.bFilled=false;z=this.BuildEventDiv_TL({Tab:t,dayInd:F,from:{h:B.h_f,m:B.m_f},to:{h:H,m:E},oEvent:J.oEvent,arInit:J.arInit,lastPart:!J.dontClose});if(!B.arEvents){B.arEvents=[z]}else{B.arEvents.push(z)}}if(B.bFilled&&p){p=false}}}}}}}var d=t.pTimelineTable.rows[0].cells[F+1],C,s,K,o,G,A,x,l,L,a=d.offsetWidth-15;for(s=0,K=M.length;s<K;s++){C=M[s];o=C.length;G=Math.round((a-o)/o);for(A=0;A<C.length;A++){B=C[A];if(A==0){l=G;q=bxInt(B.arEvents[0].style.left);x=false}else{q+=G+1;x=q;if(A==C.length-1){l=a-(G+1)*(C.length-1)-1}else{l=G}}for(I=0;I<B.arEvents.length;I++){L=B.arEvents[I];L.style.width=l+"px";L.style.minWidth=l+"px";if(x!==false){L.style.left=x+"px"}}}}}}catch(I){}};JCEC.prototype.BuildEventDiv_TL=function(e){var z=this,v=e.oEvent,B=this.Event.IsTask(v),q=this.Event.IsCrm(v),p=e.from.m,a=e.to.m,d="",A=Math.floor((e.from.h+p/60)*2),r=Math.floor((e.to.h+a/60)*2),g=e.Tab.pTimelineTable.rows[A].cells[this.__ConvertCellIndex(A,e.dayInd+1,true)],y=e.Tab.pTimelineTable.rows[r].cells[this.__ConvertCellIndex(r,e.dayInd+1,true)],s=bxInt(g.offsetTop)+1,j=bxInt(y.offsetTop)-1,b=bxInt(g.offsetLeft)+2,l=BX.create("DIV",{props:{className:"bxec-tl-event"+(v.bMuted?" bxec-event-muted":"")},style:{left:b+"px",backgroundColor:v.displayColor,color:v.displayTextColor},events:{mouseover:function(C){z.HighlightEvent_TL(v,this,false,e.Tab.id,C||window.event)},mouseout:function(C){z.HighlightEvent_TL(v,this,true,e.Tab.id,C||window.event)},dblclick:function(){z.Event.View(v)}}});l.setAttribute("data-bx-event-ind",v.ind);l.setAttribute("data-bx-original-width","");l.setAttribute("data-bx-original-height","");v._eventViewed=false;v._contentSpan=false;if(this.Event.IsMeeting(v)){d='<i class="bxc-e-meeting"></i>'}if(B){d='<i class="bxc-e-task"></i>'}if(q&&!B){d='<i class="bxc-e-crm"></i>'}var w=e.arInit.real_from,h=e.arInit.real_to,x=this.Event.GetQuestIcon(v),f=d+x+"<u "+this.Event.GetLabelStyle(v)+">"+BX.util.htmlspecialchars(v.NAME)+"</u><br />",o=this.FormatTimeByNum(w.hour,w.min),m=this.FormatTimeByNum(h.hour,h.min);if(p!=30&&p!=0){s+=Math.round((p>30?p-30:p)*40/60)-1}if(a!=30&&a!=0){j+=Math.round((a>30?a-30:a)*40/60)+2}var t=j-s;if(t<=17){t=17}l.style.top=s+"px";l.style.height=t+"px";if(w.year==h.year&&w.month==h.month&&w.date==h.date){f+=o+" &mdash; "+m}else{f+=bxFormatDate(w.date,w.month,w.year)+" "+o+" &mdash; "+bxFormatDate(h.date,h.month,h.year)+" "+m}l.appendChild(BX.create("DIV",{children:[BX.create("SPAN",{props:{className:"bxec-cnt-sp"},html:f})]}));this.Event.BuildActions({cont:l,oEvent:v,evCont:l,bTimeline:true});if(e.lastPart){var u=l.appendChild(BX.create("DIV",{props:{className:"bxec-tl-event-resizer-cnt"}}));this.dragDrop.RegisterTimelineEventResizer(u,l,v,e.Tab.id)}e.Tab.pTimelineCont.appendChild(l);if(!v.oTLParts[e.Tab.id]){v.oTLParts[e.Tab.id]=[]}v.oTLParts[e.Tab.id].push(l);this.dragDrop.RegisterTimelineEvent(l,v,e.Tab.id);return l};JCEC.prototype.HighlightEvent_TL=function(o,a,b,y,v){var t=this;var x=a.getAttribute("data-bx-original-width");var s=a.getAttribute("data-bx-original-height");if(!b&&!o._eventViewed){if(this._highlightIntKeypWnd==a&&this._highlightInt){return}if(this._highlightInt){clearInterval(this._highlightInt)}if(!x){x=parseInt(a.style.width);a.setAttribute("data-bx-original-width",x)}if(!s){s=parseInt(a.style.height);a.setAttribute("data-bx-original-height",s)}o._contentSpan=BX.findChild(a,{className:"bxec-cnt-sp"},true);var w=0,l=x,j=parseInt(o._contentSpan.offsetWidth)+20,h=s,g=parseInt(o._contentSpan.offsetHeight)+30;if(j<=60){j=60}if(g<=55){g=55}if(j-l>0||g-h>0){this._highlightIntKeypWnd=a;this._highlightInt=setInterval(function(){var e=(j-l)<=0,d=(g-h)<=0;if(e&&d){o._eventViewed=true;return clearInterval(t._highlightInt)}w+=12;if(!e){l+=w;if(l>j){l=j+2}a.style.width=l+"px"}if(!d){h+=w;if(h>g){h=g+2}a.style.height=h+"px"}},5)}}else{if(this.CheckMouseInCont(a,v,-2)){return true}this._highlightIntKeypWnd=false;if(this._highlightInt){clearInterval(this._highlightInt)}this._highlightInt=false;if(x){a.style.width=x+"px";o._eventViewed=false}if(s){a.style.height=s+"px";o._eventViewed=false}}if(b){BX.removeClass(a,"bxec-tl-ev-hlt");BX.removeClass(a,"bxec-tl-ev-hlt-s")}else{BX.addClass(a,"bxec-tl-ev-hlt")}if(o.oTLParts&&o.oTLParts[y]){var r=o.oTLParts[y],u=r.length,q,f,m;for(q=0;q<u;q++){if(r[q]==a){continue}if(b){BX.removeClass(r[q],"bxec-tl-ev-hlt");BX.removeClass(r[q],"bxec-tl-ev-hlt-s");f=r[q].getAttribute("data-bx-original-width");m=r[q].getAttribute("data-bx-original-height");if(f){r[q].style.width=f+"px"}if(m){r[q].style.height=m+"px"}}else{BX.addClass(r[q],"bxec-tl-ev-hlt-s")}}}};JCEC.prototype.ShowMoreEventsWin=function(e){var g=this;if(this.MoreEventsWin){this.MoreEventsWin.close();this.MoreEventsWin.destroy();this.MoreEventsWin=null;return}this.MoreEventsWin=BX.PopupWindowManager.create(this.id+"bxc-month-sel"+e.id,e.pSelect,{autoHide:true,closeByEsc:true,offsetTop:-1,offsetLeft:1,lightShadow:true,content:BX.create("DIV",{props:{id:"bxc-more-"+this.id+e.id,className:"bxec-more-event-popup"}})});BX.addCustomEvent(this.MoreEventsWin,"onPopupClose",function(){if(g.MoreEventsWin&&g.MoreEventsWin.destroy){g.MoreEventsWin.destroy()}});var d=BX("bxc-more-"+this.id+e.id),a,f,b;BX.bind(d,"click",BX.proxy(this.EventClick,this));d.innerHTML="";for(b=0;b<e.Events.length;b++){f=e.Events[b].pDiv;a=f.cloneNode(true);BX.addClass(a,"bxec-event-static");a.onmouseover=f.onmouseover;a.onmouseout=f.onmouseout;a.ondblclick=f.ondblclick;d.appendChild(a);this.dragDrop.RegisterEvent(a,e.Events[b].oEvent,"month")}this.MoreEventsWin.show(true)};JCEC.prototype.GetUsableDateTime=function(b,d){var a=(d||10)*60*1000;b=Math.ceil(b/a)*a;return new Date(b)};JCEC.prototype.CompareArrays=function(d,b){var a=true;if(d.length!==b.length){a=false}else{for(i=0;i<d.length;i++){if(d[i]!==b[i]){a=false;break}}}return a};