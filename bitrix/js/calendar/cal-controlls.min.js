var ECUserControll=function(d){this.oEC=d.oEC;var e=this;this.count=0;this.countAgr=0;this.countDec=0;this.bEditMode=d.view!==true;this.pAttendeesCont=d.AttendeesCont;this.pAttendeesList=d.AttendeesList;this.pParamsCont=d.AdditionalParams;this.pSummary=d.SummaryCont;this.pCount=this.pSummary.appendChild(BX.create("A",{props:{className:"bxc-count",href:"javascript:void(0)"}}));this.pCountArg=this.pSummary.appendChild(BX.create("A",{props:{className:"bxc-count-agr",href:"javascript:void(0)"}}));this.pCountDec=this.pSummary.appendChild(BX.create("A",{props:{className:"bxc-count-dec",href:"javascript:void(0)"}}));this.pCount.onclick=function(){e.ListMode("all")};this.pCountArg.onclick=function(){e.ListMode("agree")};this.pCountDec.onclick=function(){e.ListMode("decline")};this._getFromDate=(d.fromDateGetter&&typeof d.fromDateGetter=="function")?d.fromDateGetter:function(){return false};this._getToDate=(d.toDateGetter&&typeof d.toDateGetter=="function")?d.toDateGetter:function(){return false};this._getEventId=(d.eventIdGetter&&typeof d.eventIdGetter=="function")?d.eventIdGetter:function(){return false};this.ListMode("all");this.Attendees={};if(this.bEditMode){this.pLinkCont=d.AddLinkCont;var b=this.pLinkCont.appendChild(BX.create("I")),c=this.pLinkCont.appendChild(BX.create("SPAN",{text:EC_MESS.AddAttendees}));b.onclick=c.onclick=BX.proxy(this.OpenSelectUser,this);var a=[{text:EC_MESS.AddGuestsDef,onclick:BX.proxy(this.OpenSelectUser,this)}];if(!this.oEC.bExtranet&&this.oEC.type=="group"){a.push({text:EC_MESS.AddGroupMemb,title:EC_MESS.AddGroupMembTitle,onclick:BX.proxy(this.oEC.AddGroupMembers,this.oEC)})}if(a.length>1){pMore=this.pLinkCont.appendChild(BX.create("A",{props:{href:"javascript: void(0);",className:"bxec-add-more"}}));pMore.onclick=function(){BX.PopupMenu.show("bxec_add_guest_menu",e.pLinkCont,a,{events:{onPopupClose:function(){BX.removeClass(pMore,"bxec-add-more-over")}}});BX.addClass(pMore,"bxec-add-more-over")}}BX.addCustomEvent(window,"onUserSelectorOnChange",BX.proxy(this.UserOnChange,this))}};ECUserControll.prototype={SetValues:function(c){var b,a=c.length,d;BX.cleanNode(this.pAttendeesList);this.Attendees={};this.count=0;this.countAgr=0;this.countDec=0;for(b=0;b<a;b++){d=c[b];d.key=d.id||d.email;if(d&&d.key&&!this.Attendees[d.key]){this.DisplayAttendee(d)}}if(this.bEditMode){this.DisableUserOnChange(true,true);O_BXCalUserSelect.setSelected(c)}this.UpdateCount()},GetValues:function(){return this.Attendees},SetEmpty:function(a){if(this.bEmpty===a){return}BX.onCustomEvent(this,"SetEmpty",[a]);if(a){BX.addClass(this.pAttendeesCont,"bxc-att-empty");if(this.pParamsCont){this.pParamsCont.style.display="none"}}else{BX.removeClass(this.pAttendeesCont,"bxc-att-empty");if(this.pParamsCont){this.pParamsCont.style.display=""}}this.bEmpty=a},UpdateCount:function(){this.pCount.innerHTML=EC_MESS.AttSumm+" - "+(parseInt(this.count)||0);if(this.countAgr>0){this.pCountArg.innerHTML=EC_MESS.AttAgr+" - "+parseInt(this.countAgr);this.pCountArg.style.display=""}else{this.pCountArg.style.display="none"}if(this.countDec>0){this.pCountDec.innerHTML=EC_MESS.AttDec+" - "+parseInt(this.countDec);this.pCountDec.style.display=""}else{this.pCountDec.style.display="none"}this.SetEmpty(this.count==0)},OpenSelectUser:function(c){if(BX.PopupMenu&&BX.PopupMenu.currentItem){BX.PopupMenu.currentItem.popupWindow.close()}if(!c){c=window.event}if(!this.SelectUserPopup){var d=this;this.SelectUserPopup=BX.PopupWindowManager.create("bxc-user-popup",this.pLinkCont,{offsetTop:1,autoHide:true,closeByEsc:true,content:BX("BXCalUserSelect_selector_content"),className:"bxc-popup-user-select",buttons:[new BX.PopupWindowButton({text:EC_MESS.Add,events:{click:function(){d.SelectUserPopup.close();for(var e in d.selectedUsers){if(d.selectedUsers.hasOwnProperty(e)){e=parseInt(e);if(!isNaN(e)&&e>0){if(!d.Attendees[e]&&d.selectedUsers[e]){d.selectedUsers[e].key=e;d.DisplayAttendee(d.selectedUsers[e])}else{if(d.Attendees[e]&&!d.selectedUsers[e]){d.RemoveAttendee(e,false)}}}}}BX.onCustomEvent(d,"UserOnChange");d.UpdateCount()}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){d.SelectUserPopup.close()}}})]})}if(this.bEditMode){this.selectedUsers={};var b=[],a;for(a in this.Attendees){if(this.Attendees[a]&&this.Attendees[a].type!="ext"){b.push(this.Attendees[a].User)}}O_BXCalUserSelect.setSelected(b)}this.SelectUserPopup.show();BX.PreventDefault(c)},AddByEmail:function(b){var c=this;if(BX.PopupMenu&&BX.PopupMenu.currentItem){BX.PopupMenu.currentItem.popupWindow.close()}if(!b){b=window.event}if(!this.EmailPopup){var a=BX.create("DIV",{props:{className:"bxc-email-cont"},html:'<label class="bxc-email-label">'+EC_MESS.UserEmail+":</label>"});this.pEmailValue=a.appendChild(BX.create("INPUT",{props:{className:"bxc-email-input"}}));this.EmailPopup=BX.PopupWindowManager.create("bxc-user-popup-email",this.pLinkCont,{offsetTop:1,autoHide:true,content:a,className:"bxc-popup-user-select-email",closeIcon:{right:"12px",top:"5px"},closeByEsc:true,buttons:[new BX.PopupWindowButton({text:EC_MESS.Add,className:"popup-window-button-accept",events:{click:function(){var d=BX.util.trim(c.pEmailValue.value);if(d!=""&&!c.Attendees[d]){var e={name:d,key:d,type:"ext",status:"Y"};c.DisplayAttendee(e);c.UpdateCount()}c.EmailPopup.close()}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){c.EmailPopup.close()}}})]})}this.EmailPopup.show();setTimeout(function(){BX.focus(c.pEmailValue)},50);BX.PreventDefault(b)},DisableUserOnChange:function(a,b){this.bDisableUserOnChange=a===true;if(b){setTimeout(BX.proxy(this.DisableUserOnChange,this),300)}},UserOnChange:function(a){if(this.bDisableUserOnChange){return}this.selectedUsers=a},DisplayAttendee:function(g,f){this.count++;if(g.status=="Y"){this.countAgr++}else{if(g.status=="N"){this.countDec++}else{g.status="Q"}}if(f&&g.id&&this.Attendees[g.id]){}else{var e=this,b=false,a=g.status.toLowerCase(),d=this.pAttendeesList.appendChild(BX.create("SPAN",{props:{className:"bxc-attendee-row bxc-att-row-"+a}})),c=d.appendChild(BX.create("I",{props:{className:"bxc-stat-"+a,title:EC_MESS["GuestStatus_"+a]+(g.desc?" - "+g.desc:"")}}));if(g.type=="ext"){pName=d.appendChild(BX.create("span",{props:{className:"bxc-name"},text:(g.name||g.email)}))}else{pName=d.appendChild(BX.create("A",{props:{href:this.oEC.GetUserHref(g.id),className:"bxc-name"},text:g.name}))}if(this.bEditMode&&g.type!="ext"){b=d.appendChild(BX.create("SPAN",{props:{className:"bxc-busy"}}))}d.appendChild(BX.create("SPAN",{props:{className:"bxc-comma"},html:","}));if(this.bEditMode){d.appendChild(BX.create("A",{props:{id:"bxc-att-key-"+g.key,href:"javascript:void(0)",title:EC_MESS.Delete,className:"bxc-del-att"}})).onclick=function(h){e.RemoveAttendee(this.id.substr("bxc-att-key-".length));return BX.PreventDefault(h||window.event)}}this.Attendees[g.key]={User:g,pRow:d,pBusyCont:b}}},RemoveAttendee:function(a,b){b=b!==false;if(this.Attendees[a]){this.Attendees[a].pRow.parentNode.removeChild(this.Attendees[a].pRow);if(this.Attendees[a].User.status=="Y"){this.countAgr--}if(this.Attendees[a].User.status=="N"){this.countDec--}this.count--;this.Attendees[a]=null;delete this.Attendees[a];if(this.bEditMode){var c=[];for(k in this.Attendees){if(this.Attendees[k]&&this.Attendees[k].type!="ext"){c.push(this.Attendees[k].User)}}this.DisableUserOnChange(true,true);if(b){O_BXCalUserSelect.setSelected(c)}}}this.UpdateCount()},ListMode:function(a){if(this.mode==a){return}if(this.mode){BX.removeClass(this.pAttendeesList,"bxc-users-mode-"+this.mode);BX.removeClass(this.pSummary,"bxc-users-mode-"+this.mode)}this.mode=a;BX.addClass(this.pAttendeesList,"bxc-users-mode-"+this.mode);BX.addClass(this.pSummary,"bxc-users-mode-"+this.mode)}};var ECSyncPannel=function(a){this.oEC=a;if(!this.oEC.arConfig.syncInfo){return}this.Display();if(!window.jsOutlookUtils){return BX.loadScript("/bitrix/js/calendar/outlook.js")}};ECSyncPannel.prototype={Display:function(){var d=this,b;this.syncList=[{id:"google",label:EC_MESS.syncGoogle,className:"bxec-sect-access-for-google",active:!!this.oEC.arConfig.syncInfo.google.active,connected:!!this.oEC.arConfig.syncInfo.google.connected,syncDate:this.oEC.arConfig.syncInfo.google.syncDate,connectHandler:function(f){BX.util.popup(d.oEC.arConfig.googleCalDavStatus.authLink,500,600);return BX.PreventDefault(f||window.event)},disconnectHandler:function(f){d.DisconnectGoogle(f);return BX.PreventDefault(f||window.event)}},{id:"macosx",className:"bxec-sect-access-for-macosx",label:EC_MESS.syncMac,active:!!this.oEC.arConfig.syncInfo.macosx.active,connected:!!this.oEC.arConfig.syncInfo.macosx.connected,syncDate:this.oEC.arConfig.syncInfo.macosx.syncDate,connectHandler:function(f){d.ConnectMacOSX();return BX.PreventDefault(f||window.event)},disconnectHandler:function(f){d.DisconnectMacOSX();return BX.PreventDefault(f||window.event)}},{id:"iphone",className:"bxec-sect-access-for-iphone",label:EC_MESS.syncIphone,active:!!this.oEC.arConfig.syncInfo.iphone.active,connected:!!this.oEC.arConfig.syncInfo.iphone.connected,syncDate:this.oEC.arConfig.syncInfo.iphone.syncDate,connectHandler:function(f){d.ConnectIphone();return BX.PreventDefault(f||window.event)},disconnectHandler:function(f){d.DisconnectIphone();return BX.PreventDefault(f||window.event)}},{id:"android",className:"bxec-sect-access-for-android",label:EC_MESS.syncAndroid,active:!!this.oEC.arConfig.syncInfo.android.active,connected:!!this.oEC.arConfig.syncInfo.android.connected,syncDate:this.oEC.arConfig.syncInfo.android.syncDate,connectHandler:function(f){d.ConnectAndroid();return BX.PreventDefault(f||window.event)},disconnectHandler:function(f){d.DisconnectAndroid();return BX.PreventDefault(f||window.event)}},{id:"outlook",className:"bxec-sect-access-for-outlook",label:EC_MESS.syncOutlook,active:!!this.oEC.arConfig.syncInfo.outlook.active&&!BX.browser.IsMac(),connected:!!this.oEC.arConfig.syncInfo.outlook.connected,syncDate:this.oEC.arConfig.syncInfo.outlook.syncDate,connectHandler:function(f){d.ConnectOutlook();return BX.PreventDefault(f||window.event)},disconnectHandler:function(f){d.DisconnectOutlook();return BX.PreventDefault(f||window.event)}},{id:"office365",className:"bxec-sect-access-for-office365",label:EC_MESS.syncOffice365,active:!!this.oEC.arConfig.syncInfo.office365.active,connected:!!this.oEC.arConfig.syncInfo.office365.connected,syncDate:this.oEC.arConfig.syncInfo.office365.syncDate},{id:"exchange",className:"bxec-sect-access-for-exchange",label:EC_MESS.syncExchange,active:!!this.oEC.arConfig.syncInfo.exchange.active,connected:!!this.oEC.arConfig.syncInfo.exchange.connected,syncDate:this.oEC.arConfig.syncInfo.exchange.syncDate,connectHandler:function(f){d.ConnectExchange();return BX.PreventDefault(f||window.event)},disconnectHandler:function(f){d.DisconnectExchange();return BX.PreventDefault(f||window.event)}}];this.pWrap=BX(this.oEC.id+"-sync-inner-wrap");BX.cleanNode(this.pWrap);this.brightMode=true;var c=0;var a=0;for(b=0;b<this.syncList.length;b++){if(this.syncList[b].active){if(this.syncList[b].connected){this.brightMode=false;c++}else{a++}}}if(this.brightMode){for(b=0;b<this.syncList.length;b++){this.BuildSyncItem(this.syncList[b])}}else{for(b=0;b<this.syncList.length;b++){if(this.syncList[b].connected){this.BuildSyncItem(this.syncList[b])}}this.showMoreLink=this.pWrap.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-view-all"}})).appendChild(BX.create("A",{props:{href:""},text:EC_MESS.connectMore.replace(/#COUNT#/ig,a)}));BX.bind(this.showMoreLink,"click",function(f){d.showMoreLink.style.display="none";d.hiddenWrap.style.height=(a*41)+"px";if(!d.hideMoreLink){d.hideMoreLink=d.pWrap.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-view-all"}})).appendChild(BX.create("A",{props:{href:""},text:EC_MESS.showLess}));BX.bind(d.hideMoreLink,"click",function(g){d.hideMoreLink.style.display="none";d.showMoreLink.style.display="";d.hiddenWrap.style.height=0;return BX.PreventDefault(g||window.event)})}else{d.hideMoreLink.style.display=""}return BX.PreventDefault(f||window.event)});this.hiddenWrap=this.pWrap.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-hidden-wrap"}}));for(b=0;b<this.syncList.length;b++){if(!this.syncList[b].connected){this.BuildSyncItem(this.syncList[b],this.hiddenWrap)}}}},SyncSectionWithOutlook:function(id){var oSect=this.oEC.oSections[id];if(oSect&&oSect.OUTLOOK_JS&&oSect.OUTLOOK_JS.length>0){try{eval(oSect.OUTLOOK_JS)}catch(e){}}},DisconnectGoogle:function(c){if(confirm(EC_MESS.googleDisconnectConfirm)){var b,a=null,d=this;for(b=0;b<this.oEC.arConnections.length;b++){a=this.oEC.arConnections[b];if(a.account_type=="caldav_google_oauth"){break}}if(a&&a.id){this.oEC.Request({postData:this.oEC.GetReqData("disconnect_google",{connectionId:a.id}),handler:function(){window.location=window.location}})}}return BX.PreventDefault(c||window.event)},ConnectOutlook:function(){var a=0,g=this,e,c,b,d;for(e=0;e<this.oEC.arSections.length;e++){c=this.oEC.arSections[e];if(c.ACTIVE!=="N"&&this.oEC.IsCurrentViewSect(c)&&c.OUTLOOK_JS){a++;b=c}}if(a==1&&b){this.SyncSectionWithOutlook(b.ID)}else{var f=this.GetSyncItem("outlook");if(!this.outlookPopup){f.popupCont=BX.create("DIV",{props:{className:"bxec-sync-popup-wrap"}});for(e=0;e<this.oEC.arSections.length;e++){c=this.oEC.arSections[e];if(this.oEC.IsCurrentViewSect(c)&&c.OUTLOOK_JS){d=f.popupCont.appendChild(BX.create("DIV",{props:{id:"ecpp_"+c.ID,className:"bxec-sync-popup-item"+(c.bDark?" bxec-dark":"")},style:{backgroundColor:c.COLOR},text:c.NAME}));d.onclick=function(){g.SyncSectionWithOutlook(this.id.substr("ecpp_".length))}}}this.outlookPopup=BX.PopupWindowManager.create(this.oEC.id+"-outlook-sync-popup",f.pConnectLink,{autoHide:true,closeByEsc:true,offsetTop:-1,offsetLeft:1,lightShadow:true,content:f.popupCont})}this.outlookPopup.show(true);BX.addCustomEvent(this.outlookPopup,"onPopupClose",function(){if(g.outlookPopup&&g.outlookPopup.destroy){g.outlookPopup.destroy();g.outlookPopup=null}})}},ConnectIphone:function(){this.oEC.ShowMobileSyncDialog("iphone")},ConnectMacOSX:function(){this.oEC.ShowMobileSyncDialog("macosx")},ConnectAndroid:function(){this.oEC.ShowMobileSyncDialog("android")},DisconnectIphone:function(){this.oEC.Request({postData:this.oEC.GetReqData("clear_sync_info",{sync_type:"iphone"})});var a=this.GetSyncItem("iphone");if(a&&a.pDisconnectLink){var b=this;this.ShowInfoPopup(a.pDisconnectLink,EC_MESS.disconnectIphone,function(){b.oEC.arConfig.syncInfo.iphone.connected=false;b.oEC.arConfig.syncInfo.iphone.syncDate=false;b.Display()})}},DisconnectMacOSX:function(){this.oEC.Request({postData:this.oEC.GetReqData("clear_sync_info",{sync_type:"mac"})});var a=this.GetSyncItem("macosx");if(a&&a.pDisconnectLink){var b=this;this.ShowInfoPopup(a.pDisconnectLink,EC_MESS.disconnectMac,function(){b.oEC.arConfig.syncInfo.macosx.connected=false;b.oEC.arConfig.syncInfo.macosx.syncDate=false;b.Display()})}},DisconnectAndroid:function(){this.oEC.Request({postData:this.oEC.GetReqData("clear_sync_info",{sync_type:"android"})});var a=this.GetSyncItem("android");if(a&&a.pDisconnectLink){var b=this;this.ShowInfoPopup(a.pDisconnectLink,EC_MESS.disconnectAndroid,function(){b.oEC.arConfig.syncInfo.android.connected=false;b.oEC.arConfig.syncInfo.android.syncDate=false;b.Display()})}},DisconnectOutlook:function(){this.oEC.Request({postData:this.oEC.GetReqData("clear_sync_info",{sync_type:"outlook"})});var a=this.GetSyncItem("outlook");if(a&&a.pDisconnectLink){var b=this;this.ShowInfoPopup(a.pDisconnectLink,EC_MESS.disconnectOutlook,function(){b.oEC.arConfig.syncInfo.outlook.connected=false;b.oEC.arConfig.syncInfo.outlook.syncDate=false;b.Display()})}},ShowInfoPopup:function(d,c,b){var a=BX.PopupWindowManager.create(this.oEC.id+"-disconnect-popup",d,{autoHide:true,closeByEsc:true,offsetTop:-1,offsetLeft:1,lightShadow:true,content:BX.create("DIV",{props:{className:"bxec-disconnect-popup-wrap"},html:c})});a.show(true);function e(){if(b&&typeof b=="function"){b()}if(a&&a.destroy){BX.removeCustomEvent(a,"onPopupClose",e);a.destroy();a=null}}BX.addCustomEvent(a,"onPopupClose",e)},ConnectExchange:function(){var a=this.GetSyncItem("exchange");if(a&&a.pConnectLink){this.ShowInfoPopup(a.pConnectLink,EC_MESS.connectExchange)}},DisconnectExchange:function(){var a=this.GetSyncItem("exchange");if(a&&a.pDisconnectLink){this.ShowInfoPopup(a.pDisconnectLink,EC_MESS.disconnectExchange)}},SyncExchange:function(){this.oEC.Request({postData:this.oEC.GetReqData("exchange_sync"),handler:function(b){var a=b.result;setTimeout(function(){if(a===true){top.window.location=top.window.location}else{if(a===false){alert(EC_MESS.ExchNoSync)}}},100)}})},BuildSyncItem:function(c,b){if(!b){b=this.pWrap}if(c.active){c.pOuter=b.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-el "+(c.className||"")}}));c.pInner=c.pOuter.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-el-block"}}));if(!c.connected&&c.connectHandler){c.pConnectLink=c.pInner.appendChild(BX.create("A",{props:{className:"bxec-sect-access-connect-link"},text:EC_MESS.syncConnect}));BX.bind(c.pConnectLink,"click",c.connectHandler)}c.pIcon=c.pInner.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-icon"}}));c.pTextWrap=c.pInner.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-text-wrap"},text:c.label}));if(!this.brightMode||c.connected){BX.addClass(c.pOuter,"bxec-sect-access-connected")}if(c.connected){c.pInner.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-allowed-icon"}}));c.pInfoCont=c.pOuter.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-block-info bxec-sect-access-el-block-active"}}));var d=c.pInfoCont.appendChild(BX.create("TABLE",{props:{className:"bxec-sect-access-el-table"}}));var e=d.insertRow(-1);BX.adjust(e.insertCell(-1),{props:{className:"bxec-sect-access-status"},html:EC_MESS.syncOk});var a=BX.adjust(e.insertCell(-1),{style:{textAlign:"right"}});if(c.syncDate){c.pSyncDate=a.appendChild(BX.create("DIV",{props:{className:"bxec-sect-access-status-time"}}));c.pSyncDate.innerHTML=c.syncDate}if(c.disconnectHandler){c.pDisconnectLink=a.appendChild(BX.create("SPAN",{props:{className:"bxec-sect-access-disconnect-link"},html:EC_MESS.syncDisconnect}));BX.bind(c.pDisconnectLink,"click",c.disconnectHandler)}if(c.id=="exchange"&&this.oEC.arConfig.bExchange){c.pTextWrap.style.cursor="pointer";c.pTextWrap.title=EC_MESS.syncExchangeTitle;BX.bind(c.pTextWrap,"click",BX.proxy(this.SyncExchange,this))}}}},GetSyncItem:function(b){var a;for(a=0;a<this.syncList.length;a++){if(this.syncList[a].active&&this.syncList[a].id==b){return this.syncList[a]}}}};var ECMonthSelector=function(a){this.oEC=a;this.Build();this.content={month:"",week:"",day:""}};ECMonthSelector.prototype={Build:function(){var a=this;this.pPrev=BX(this.oEC.id+"selector-prev");this.pNext=BX(this.oEC.id+"selector-next");this.pCont=BX(this.oEC.id+"selector-cont");this.pContInner=BX(this.oEC.id+"selector-cont-inner");this.pPrev.onclick=function(){a.ChangeValue(false)};this.pNext.onclick=function(){a.ChangeValue(true)}},ChangeMode:function(a){this.mode=a||this.oEC.activeTabId;if(this.mode=="month"){this.pCont.className="bxec-sel-but";this.pCont.onclick=BX.proxy(this.ShowMonthPopup,this)}else{this.pCont.className="bxec-sel-text";this.pCont.onclick=BX.False}},OnChange:function(m,h,a,e){h=parseInt(h,10);m=parseInt(m);var l,r;this.pNext.style.marginLeft=(this.mode=="month"&&BX.browser.IsIE()&&!BX.browser.IsIE9())?"10px":"";if(this.mode=="month"){if(h<0||h>11){return alert("Error! Incorrect month")}this.content.month=this.oEC.arConfig.month[h]+",&nbsp;"+m+'<span class="bxec-sel-but-arr">'}else{if(this.mode=="week"){var i=new Date();i.setFullYear(m,h,1);r=this.oEC.GetWeekDayOffset(this.oEC.GetWeekDayByInd(i.getDay()));if(r>0){i.setDate(i.getDate()-r)}if(a!=0){i.setDate(i.getDate()+(7*a))}var o=new Date(i.getTime());o.setDate(o.getDate()+6);var g,q=this.oEC.arConfig.month_r,d=i.getDate(),c=i.getMonth(),n=i.getFullYear(),j=o.getDate(),f=o.getMonth(),b=o.getFullYear();if(c==f){g=d+"&nbsp;-&nbsp;"+j+"&nbsp;"+q[c]+"&nbsp;"+n}else{if(n==b){g=d+"&nbsp;"+q[c]+"&nbsp;-&nbsp;"+j+"&nbsp;"+q[f]+"&nbsp;"+n}else{g=d+"&nbsp;"+q[c]+"&nbsp;"+n+"&nbsp;-&nbsp;"+j+"&nbsp;"+q[f]+"&nbsp;"+b}}this.content.week="<nobr>"+g+"</nobr>";l={dateFrom:d,monthFrom:c,yearFrom:n,weekStartDate:i,monthTo:f,yearTo:b,dateTo:j,weekEndDate:o}}else{if(this.mode=="day"){var p=new Date();p.setFullYear(m,h,e);day=this.oEC.ConvertDayIndex(p.getDay());e=p.getDate(),h=p.getMonth(),m=p.getFullYear();this.content.day="<nobr>"+this.oEC.arConfig.days[day][0]+",&nbsp;"+e+"&nbsp;"+this.oEC.arConfig.month_r[h]+"&nbsp;"+m+"</nobr>";l={date:e,month:h,year:m,oDate:p}}}}this.Show(this.mode);return l},Show:function(a){this.pContInner.innerHTML=this.content[a]},ChangeValue:function(b){var d=b?1:-1;this.oEC.bJustRedraw=false;if(this.mode=="month"){var a=bxInt(this.oEC.activeDate.month)+d;var c=this.oEC.activeDate.year;if(a<0){a+=12;c--}else{if(a>11){a-=12;c++}}this.oEC.SetMonth(a,c)}else{if(this.mode=="week"){this.oEC.SetWeek(this.oEC.activeDate.week+d,this.oEC.activeDate.month,this.oEC.activeDate.year)}else{if(this.mode=="day"){this.oEC.SetDay(this.oEC.activeDate.date+d,this.oEC.activeDate.month,this.oEC.activeDate.year)}}}},ShowMonthPopup:function(){if(!this.oMonthWin){var e=this;this.oMonthWin=new BX.PopupWindow(this.oEC.id+"bxc-month-sel",this.pCont,{overlay:{opacity:1},autoHide:true,offsetTop:1,offsetLeft:0,lightShadow:true,contentColor:"white",contentNoPaddings:true,content:BX("bxec_month_win_"+this.oEC.id)});this.oMonthWin.CAL={DOM:{Year:BX(this.oEC.id+"md-year"),MonthList:BX(this.oEC.id+"md-month-list")},curYear:parseInt(this.oEC.activeDate.year)};this.oMonthWin.CAL.DOM.Year.innerHTML=this.oMonthWin.CAL.curYear;BX(this.oEC.id+"md-selector-prev").onclick=function(){e.oMonthWin.CAL.DOM.Year.innerHTML=--e.oMonthWin.CAL.curYear};BX(this.oEC.id+"md-selector-next").onclick=function(){e.oMonthWin.CAL.DOM.Year.innerHTML=++e.oMonthWin.CAL.curYear};var c,a,d,b=[0,4,8,1,5,9,2,6,10,3,7,11];for(c=0;c<12;c++){a=b[c];d=this.oMonthWin.CAL.DOM.MonthList.appendChild(BX.create("DIV",{props:{id:"bxec_ms_m_"+b[c],className:"bxec-month-div"+(b[c]==this.oEC.activeDate.month?" bxec-month-act":"")+" bxec-"+this.GetSeason(b[c])},html:"<span>"+this.oEC.arConfig.month[b[c]]+"</span>",events:{click:function(){e.oEC.bJustRedraw=false;BX.removeClass(e.oMonthWin.CAL.DOM.curMonth,"bxec-month-act");BX.addClass(this,"bxec-month-act");e.oMonthWin.CAL.DOM.curMonth=this;e.oEC.SetMonth(parseInt(this.id.substr("bxec_ms_m_".length)),e.oMonthWin.CAL.curYear);e.oMonthWin.close()}}}));if(b[c]==this.oEC.activeDate.month){this.oMonthWin.CAL.DOM.curMonth=d}}}this.oMonthWin.show()},GetSeason:function(a){switch(a){case 11:case 0:case 1:return"winter";case 2:case 3:case 4:return"spring";case 5:case 6:case 7:return"summer";case 8:case 9:case 10:return"autumn"}}};var ECCalendarAccess=function(a){BX.Access.Init();if(!window.EC_MESS){EC_MESS={}}this.bind=a.bind;this.GetAccessName=a.GetAccessName;this.pTbl=a.pCont.appendChild(BX.create("TABLE",{props:{className:"bxc-access-tbl"}}));this.pSel=BX("bxec-"+this.bind);var b=this;this.delTitle=a.delTitle||EC_MESS.Delete;this.noAccessRights=a.noAccessRights||EC_MESS.NoAccessRights;this.inputName=a.inputName||false;a.pLink.onclick=function(){BX.Access.ShowForm({callback:BX.proxy(b.InsertRights,b),bind:b.bind})}};ECCalendarAccess.prototype={InsertRights:function(b){var c,a;for(c in b){for(a in b[c]){this.InsertAccessRow(BX.Access.GetProviderName(c)+" "+b[c][a].name,a)}}},InsertAccessRow:function(f,c,d){var h=this,e,b,g,a;if(this.pTbl.rows[0]&&this.pTbl.rows[0].cells[0]&&this.pTbl.rows[0].cells[0].className.indexOf("bxc-access-no-vals")!=-1){this.DeleteRow(0)}e=this.pTbl.insertRow(-1);b=BX.adjust(e.insertCell(-1),{props:{className:"bxc-access-c-l"},html:f+":"});g=BX.adjust(e.insertCell(-1),{props:{className:"bxc-access-c-r"}});a=g.appendChild(this.pSel.cloneNode(true));a.id="BXEC_ACCESS_"+c;if(d){a.value=d}pDel=g.appendChild(BX.create("A",{props:{className:"access-delete",href:"javascript:void(0)",title:this.delTitle},events:{click:function(){h.DeleteRow(this.parentNode.parentNode.rowIndex)}}}));if(this.inputName){a.name=this.inputName+"["+c+"]"}},DeleteRow:function(a){if(this.pTbl.rows[a]){this.pTbl.deleteRow(a)}},GetValues:function(){var f,d,c={},e=this.pTbl.getElementsByTagName("SELECT"),b,a=e.length;for(b=0;b<a;b++){f=e[b].id.substr("BXEC_ACCESS_".length);d=e[b].value;c[f]=d}return c},SetSelected:function(a){if(!a){a={}}while(this.pTbl.rows[0]){this.pTbl.deleteRow(0)}var b,c={};for(b in a){this.InsertAccessRow(this.GetTitleByCode(b),b,a[b]);c[b]=true}if(this.pTbl.rows.length<=0){BX.adjust(this.pTbl.insertRow(-1).insertCell(-1),{props:{className:"bxc-access-no-vals",colSpan:2},html:"<span>"+this.noAccessRights+"</span>"})}BX.Access.SetSelected(c,this.bind)},GetTitleByCode:function(a){return this.GetAccessName(a)}};function ECColorPicker(a){this.bOpened=false;this.zIndex=5000;this.id="";this.Popups={};this.Conts={}}ECColorPicker.prototype={Create:function(){var f=this;var b=document.body.appendChild(BX.create("DIV",{props:{className:"ec-colpick-cont"},style:{zIndex:this.zIndex}}));var e=["#3AD0FF","#A6DC00","#FF5C5A","#B47153","#2FC7F7","#04B4AB","#FFA801","#5CD1DF","#6E54D1","#29AD49","#FE5957","#DAA187","#78D4F1","#43DAD2","#EECE8F","#AEE5EC","#FF0000","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#FFFFFF","#EBEBEB","#E1E1E1","#D7D7D7","#CCCCCC","#C2C2C2","#B7B7B7","#ACACAC","#A0A0A0","#959595","#EE1D24","#FFF100","#00A650","#00AEEF","#2F3192","#ED008C","#898989","#7D7D7D","#707070","#626262","#555","#464646","#363636","#262626","#111","#000000","#F7977A","#FBAD82","#FDC68C","#FFF799","#C6DF9C","#A4D49D","#81CA9D","#7BCDC9","#6CCFF7","#7CA6D8","#8293CA","#8881BE","#A286BD","#BC8CBF","#F49BC1","#F5999D","#F16C4D","#F68E54","#FBAF5A","#FFF467","#ACD372","#7DC473","#39B778","#16BCB4","#00BFF3","#438CCB","#5573B7","#5E5CA7","#855FA8","#A763A9","#EF6EA8","#F16D7E","#EE1D24","#F16522","#F7941D","#FFF100","#8FC63D","#37B44A","#00A650","#00A99E","#00AEEF","#0072BC","#0054A5","#2F3192","#652C91","#91278F","#ED008C","#EE105A","#9D0A0F","#A1410D","#A36209","#ABA000","#588528","#197B30","#007236","#00736A","#0076A4","#004A80","#003370","#1D1363","#450E61","#62055F","#9E005C","#9D0039","#790000","#7B3000","#7C4900","#827A00","#3E6617","#045F20","#005824","#005951","#005B7E","#003562","#002056","#0C004B","#30004A","#4B0048","#7A0045","#7A0026"],m,h,g,c=BX.create("TABLE",{props:{className:"ec-colpic-tbl"}}),d,a=e.length;m=c.insertRow(-1);h=m.insertCell(-1);h.colSpan=8;var j=h.appendChild(BX.create("SPAN",{props:{className:"ec-colpic-def-but"},text:EC_MESS.DefaultColor}));j.onmouseover=function(){this.className="ec-colpic-def-but ec-colpic-def-but-over";g.style.backgroundColor="#FF0000"};j.onmouseout=function(){this.className="ec-colpic-def-but"};j.onmousedown=function(i){f.Select("#FF0000")};g=m.insertCell(-1);g.colSpan=8;g.className="ec-color-inp-cell";g.style.backgroundColor=e[38];for(d=0;d<a;d++){if(Math.round(d/16)==d/16){m=c.insertRow(-1)}h=m.insertCell(-1);h.innerHTML="&nbsp;";h.className="ec-col-cell";h.style.backgroundColor=e[d];h.id="lhe_color_id__"+d;h.onmouseover=function(i){this.className="ec-col-cell ec-col-cell-over";g.style.backgroundColor=e[this.id.substring("lhe_color_id__".length)]};h.onmouseout=function(i){this.className="ec-col-cell"};h.onmousedown=function(l){var i=this.id.substring("lhe_color_id__".length);f.Select(e[i])}}b.appendChild(c);this.Conts[this.id]=b},Open:function(a){this.id=a.id+Math.round(Math.random()*1000000);this.key=a.key;this.OnSelect=a.onSelect;if(!this.Conts[this.id]){this.Create()}if(!this.Popups[this.id]){this.Popups[this.id]=BX.PopupWindowManager.create("bxc-color-popup"+this.id,a.pWnd,{autoHide:true,offsetTop:1,offsetLeft:0,lightShadow:true,content:this.Conts[this.id]})}this.Popups[this.id].show()},Close:function(){this.Popups[this.id].close();this.Popups[this.id].destroy()},OnKeyPress:function(a){if(!a){a=window.event}if(a.keyCode==27){this.Close()}},Select:function(a){if(this.OnSelect&&typeof this.OnSelect=="function"){this.OnSelect(a)}this.Close()}};window.BxEditEventGridSetLinkName=function(a){var b=BX("event-grid-dest-add-link");if(b){b.innerHTML=BX.SocNetLogDestination.getSelectedCount(a)>0?BX.message("BX_FPD_LINK_2"):BX.message("BX_FPD_LINK_1")}};window.BxEditEventGridSelectCallback=function(d,c,b){var a=c;prefix="S";if(c=="sonetgroups"){prefix="SG"}else{if(c=="groups"){prefix="UA";a="all-users"}else{if(c=="users"){prefix="U"}else{if(c=="department"){prefix="DR"}}}}BX("event-grid-dest-item").appendChild(BX.create("span",{attrs:{"data-id":d.id},props:{className:"event-grid-dest event-grid-dest-"+a},children:[BX.create("input",{attrs:{type:"hidden",name:"EVENT_DESTINATION["+prefix+"][]",value:d.id}}),BX.create("span",{props:{className:"event-grid-dest-text"},html:d.name}),BX.create("span",{props:{className:"feed-event-del-but"},attrs:{"data-item-id":d.id,"data-item-type":c}})]}));BX.onCustomEvent("OnDestinationAddNewItem",[d]);BX("event-grid-dest-input").value="";BxEditEventGridSetLinkName(editEventDestinationFormName)};window.BxEditEventGridUnSelectCallback=function(d,c,b){var e=BX.findChildren(BX("event-grid-dest-item"),{attribute:{"data-id":""+d.id+""}},true);if(e!=null){for(var a=0;a<e.length;a++){BX.remove(e[a])}}BX.onCustomEvent("OnDestinationUnselect");BX("event-grid-dest-input").value="";BxEditEventGridSetLinkName(editEventDestinationFormName)};window.BxEditEventGridOpenDialogCallback=function(){BX.style(BX("event-grid-dest-input-box"),"display","inline-block");BX.style(BX("event-grid-dest-add-link"),"display","none");BX.focus(BX("event-grid-dest-input"))};window.BxEditEventGridCloseDialogCallback=function(){if(!BX.SocNetLogDestination.isOpenSearch()&&BX("event-grid-dest-input").value.length<=0){BX.style(BX("event-grid-dest-input-box"),"display","none");BX.style(BX("event-grid-dest-add-link"),"display","inline-block");BxEditEventGridDisableBackspace()}};window.BxEditEventGridCloseSearchCallback=function(){if(!BX.SocNetLogDestination.isOpenSearch()&&BX("event-grid-dest-input").value.length>0){BX.style(BX("event-grid-dest-input-box"),"display","none");BX.style(BX("event-grid-dest-add-link"),"display","inline-block");BX("event-grid-dest-input").value="";BxEditEventGridDisableBackspace()}};window.BxEditEventGridDisableBackspace=function(a){if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!=null){BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable)}BX.bind(window,"keydown",BX.SocNetLogDestination.backspaceDisable=function(b){if(b.keyCode==8){BX.PreventDefault(b);return false}});setTimeout(function(){BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5000)};window.BxEditEventGridSearchBefore=function(a){return BX.SocNetLogDestination.searchBeforeHandler(a,{formName:editEventDestinationFormName,inputId:"event-grid-dest-input"})};window.BxEditEventGridSearch=function(a){return BX.SocNetLogDestination.searchHandler(a,{formName:editEventDestinationFormName,inputId:"event-grid-dest-input",linkId:"event-grid-dest-add-link",sendAjax:true})};(function(a){a.EditEventPopupController=function(b){this.config=b;this.id=this.config.id;this.oEC=this.config.oEC;this.oEvent=this.config.oEvent;this.Form=this.config.form;this.Init()};a.EditEventPopupController.prototype={Init:function(){this.InitDateTimeControls();var d=this,b=this.oEC.id+"_event_editor",c=a.BXHtmlEditor.Get(b);if(c&&c.IsShown()){this.CustomizeHtmlEditor(c)}else{BX.addCustomEvent(a.BXHtmlEditor,"OnEditorCreated",function(e){if(e.id==b){d.CustomizeHtmlEditor(e)}})}if(this.oEC.allowMeetings){this.InitDestinationControls()}this.FillFormFields()},SaveForm:function(j,q){var s,m,o=this,p=parseInt(this.oEC.activeDate.month,10),r=this.oEC.activeDate.year,c=this.oEC.actionUrl,n=Math.round(Math.random()*1000000);c+=(c.indexOf("?")==-1)?"?":"&";c+="action=edit_event&bx_event_calendar_request=Y&sessid="+BX.bitrix_sessid()+"&reqId="+n;this.Form.action=c;if(BX.util.trim(this.pFromTime.value)!=""||BX.util.trim(this.pFromDate.value)!=""){s=this.oEC.ParseDate(BX.util.trim(this.pFromDate.value)+(this.pFullDay.checked?"":" "+BX.util.trim(this.pFromTime.value)))}if(BX.util.trim(this.pToTime.value)!=""||BX.util.trim(this.pToDate.value)!=""){m=this.oEC.ParseDate(BX.util.trim(this.pToDate.value)+(this.pFullDay.checked?"":" "+BX.util.trim(this.pToTime.value)))}if(j.recurentEventEditMode){BX("event-current-date-from"+this.id).value=this.oEvent.DATE_FROM;BX("event-rec-edit-mode"+this.id).value=j.recurentEventEditMode}else{BX("event-current-date-from"+this.id).value="";BX("event-rec-edit-mode"+this.id).value=""}BX("event-location-old"+this.id).value=this.Loc.OLD||false;BX("event-location-new"+this.id).value=this.Loc.NEW;if(this.Loc.NEW.substr(0,5)=="ECMR_"&&this.RepeatCheck.checked){alert(EC_MESS.reservePeriodWarn);return false}if(!this.CheckUserAccessibility()){alert(EC_MESS.EC_BUSY_ALERT);return}if(this.Loc.NEW.substr(0,5)=="ECMR_"&&!j.bLocationChecked){if(m&&this.pFullDay.checked){m=new Date(m.getTime()+86400000)}if(s&&m){this.oEC.CheckMeetingRoom({id:this.oEvent.ID||0,from:o.oEC.FormatDateTime(s),to:o.oEC.FormatDateTime(m),location_new:this.Loc.NEW,location_old:this.Loc.OLD||false},function(i){if(!i){return alert(EC_MESS.MRReserveErr)}if(i=="reserved"){return alert(EC_MESS.MRNotReservedErr)}j.bLocationChecked=true;o.SaveForm(j)});return false}}if(s&&BX.util.trim(this.pFromTime.value)!=""){this.pFromTime.value=this.oEC.FormatTime(s,true)}if(m&&BX.util.trim(this.pToTime.value)!=""){this.pToTime.value=this.oEC.FormatTime(m,true)}BX("event-id"+this.id).value=this.oEvent.ID||0;BX("event-month"+this.id).value=p+1;BX("event-year"+this.id).value=r;if(this.RepeatCheck.checked){var b=this.RepeatSelect.value;if(this.RepeatDiapTo.value==EC_MESS.NoLimits){this.RepeatDiapTo.value=""}if(b=="WEEKLY"){var f=[],l;for(l=0;l<7;l++){if(this.RepeatWeekDaysCh[l].checked){f.push(this.RepeatWeekDaysCh[l].value)}}if(f.length==0){this.RepeatSelect.value="NONE"}else{BX("event-rrule-byday"+this.id).value=f.join(",")}}}if(this.oEvent.ID&&this.oEC.Event.IsRecursive(this.oEvent)&&!q){if(this.CheckForSignificantChanges()){this.oEC.ShowConfirmEditDialog(this.oEvent,{params:j});return false}}BX.ajax.submit(this.Form,function(){if(j.recurentEventEditMode){o.oEC.Event.ReloadAll(false)}else{var u=top.BXCRES[n];if(u){if(u.eventIds&&u.eventIds.length>0){for(var t=0;t<u.eventIds.length;t++){o.oEC.Event.UnDisplay(u.eventIds[t],false)}}o.oEC.HandleEvents(u.events,u.attendees);o.oEC.arLoadedMonth[p+"."+r]=true;o.oEC.Event.Display()}}});var d=this.pSectSelect.value,e=o.oEC.oSections&&o.oEC.oSections[d]?o.oEC.oSections[d]:{},h=this.TextColor,g=this.Color;if(!e.COLOR||e.COLOR&&e.COLOR.toLowerCase()!=g.toLowerCase()){BX(this.id+"_bxec_color").value=g}if(!e.TEXT_COLOR||e.TEXT_COLOR&&e.TEXT_COLOR.toLowerCase()!=h.toLowerCase()){BX(this.id+"_bxec_text_color").value=h}if(!this.oEC.arConfig.userTimezoneName){this.config.userTimezoneName=this.oEC.arConfig.userTimezoneName=this.pDefTimezone.value}if(j.callback){j.callback()}},CheckUserAccessibility:function(){var c,b=true;if(this.plannerData){for(c in this.plannerData.entries){if(this.plannerData.entries.hasOwnProperty(c)&&this.plannerData.entries[c].id&&this.plannerData.entries[c].status!="h"&&this.plannerData.entries[c].strictStatus&&!this.plannerData.entries[c].currentStatus){b=false;break}}}return b},CheckForSignificantChanges:function(){var j=false;if(!j&&this.oEvent.NAME!==this.Form.name.value){j=true}if(!j&&this.oEvent.DESCRIPTION!==this.Form.desc.value){j=true}if(!j&&this.oEvent.LOCATION!==this.Loc.NEW){j=true}if(!j&&this.oEvent.displayColor!==this.Color){j=true}if(!j&&this.oEvent.displayTextColor!==this.TextColor){j=true}if(!j&&(this.oEvent.DT_SKIP_TIME=="Y")!=this.Form.skip_time.checked){j=true}if(!j){var h=this.pFromDate.value,n=this.pToDate.value;if(this.oEvent.DT_SKIP_TIME!="Y"){if(!j&&(this.oEvent.TZ_FROM!=this.Form.tz_from.value||this.oEvent.TZ_TO!=this.Form.tz_to.value)){j=true}h+=" "+this.pFromTime.value;n+=" "+this.pToTime.value;if(!j){var c=this.oEC.ParseDate(this.oEvent["~DATE_FROM"]),f=this.oEC.ParseDate(this.oEvent["~DATE_TO"]),e=this.oEC.ParseDate(h),l=this.oEC.ParseDate(n);if(!c||!f||!e||!l){j=true}if(!j&&Math.abs(c.getTime()-e.getTime())>1000||Math.abs(f.getTime()-l.getTime())>1000){j=true}}}else{if(!j&&(this.oEvent["~DATE_FROM"]!=h||this.oEvent["~DATE_TO"]!=n)){j=true}}}if(!j&&this.plannerData){var d,m={},g=0;if(this.oEvent.IS_MEETING&&this.oEvent["~ATTENDEES"]){for(d in this.oEvent["~ATTENDEES"]){if(this.oEvent["~ATTENDEES"].hasOwnProperty(d)&&this.oEvent["~ATTENDEES"][d]["USER_ID"]){m[this.oEvent["~ATTENDEES"][d]["USER_ID"]]=true;g++}}}for(d in this.plannerData.entries){if(this.plannerData.entries.hasOwnProperty(d)&&this.plannerData.entries[d].type=="user"&&this.plannerData.entries[d].id){if(m[this.plannerData.entries[d].id]){m[this.plannerData.entries[d].id]="+"}else{j=true;break}}}if(!j&&m){for(d in m){if(m.hasOwnProperty(d)&&m[d]!=="+"){j=true;break}}}}if(!j&&(this.oEvent.RRULE.FREQ!=this.RepeatSelect.value)){j=true}if(!j&&(this.oEvent.RRULE.INTERVAL!=this.RepeatCount.value)){j=true}if(!j&&this.oEvent.RRULE.FREQ=="WEEKLY"&&this.oEvent.RRULE.BYDAY){var b=[];for(d in this.oEvent.RRULE.BYDAY){if(this.oEvent.RRULE.BYDAY.hasOwnProperty(d)){b.push(this.oEvent.RRULE.BYDAY[d])}}if(b.join(",")!=BX("event-rrule-byday"+this.id).value){j=true}}return j},InitDestinationControls:function(){BX.addCustomEvent("OnDestinationAddNewItem",BX.proxy(this.CheckPlannerState,this));BX.addCustomEvent("OnDestinationUnselect",BX.proxy(this.CheckPlannerState,this));BX.addCustomEvent("OnSetTab",BX.proxy(this.OnPlannerTabShow,this));this.pMeetingParams=BX("event-grid-meeting-params"+this.id);this.pDestValuesCont=BX("event-grid-dest-item");this.pPlannerCont=BX("event-grid-planner-cont"+this.id);this.plannerId=this.id+"_Planner";BX.addCustomEvent("OnCalendarPlannerSelectorChanged",BX.proxy(this.OnCalendarPlannerSelectorChanged,this));BX.addCustomEvent("OnCalendarPlannerScaleChanged",BX.proxy(this.OnCalendarPlannerScaleChanged,this));BX.bind(this.pDestValuesCont,"click",function(c){var b=c.target||c.srcElement;if(b.className=="feed-event-del-but"){BX.SocNetLogDestination.deleteItem(b.getAttribute("data-item-id"),b.getAttribute("data-item-type"),editEventDestinationFormName);BX.PreventDefault(c)}});BX.bind(this.pDestValuesCont,"mouseover",function(c){var b=c.target||c.srcElement;if(b.className=="feed-event-del-but"){BX.addClass(b.parentNode,"event-grid-dest-hover")}});BX.bind(this.pDestValuesCont,"mouseout",function(c){var b=c.target||c.srcElement;if(b.className=="feed-event-del-but"){BX.removeClass(b.parentNode,"event-grid-dest-hover")}});if(this.oEvent.IS_MEETING){this.pMeetingParams.style.display="block"}this.AddMeetTextLink=BX(this.id+"_add_meet_text");this.HideMeetTextLink=BX(this.id+"_hide_meet_text");this.MeetTextCont=BX(this.id+"_meet_text_cont");this.MeetText=BX(this.id+"_meeting_text");this.OpenMeeting=BX(this.id+"_ed_open_meeting");this.NotifyStatus=BX(this.id+"_ed_notify_status");this.Reinvite=BX(this.id+"_ed_reivite");this.ReinviteCont=BX(this.id+"_ed_reivite_cont");if(this.oEvent.IS_MEETING){this.OpenMeeting.checked=!!(this.oEvent.MEETING&&this.oEvent.MEETING.OPEN);this.NotifyStatus.checked=!!(this.oEvent.MEETING&&this.oEvent.MEETING.NOTIFY);this.Reinvite.checked=this.oEvent.MEETING.REINVITE===true}this.AddMeetTextLink.parentNode.style.display="none"},OnCalendarPlannerSelectorChanged:function(b){this.pFromDate.value=this.oEC.FormatDate(b.dateFrom);this.pFromTime.value=this.oEC.FormatTime(b.dateFrom);this.pToDate.value=this.oEC.FormatDate(b.dateTo);this.pToTime.value=this.oEC.FormatTime(b.dateTo);this.pFullDay.checked=!!b.fullDay;this.FullDay(false,!b.fullDay)},OnCalendarPlannerScaleChanged:function(b){this.UpdatePlanner({entrieIds:b.entrieIds,entries:b.entries,from:b.from,to:b.to,location:this.Loc&&this.Loc.NEW?this.Loc.NEW:"",roomEventId:this.Loc&&this.Loc.OLD_mrevid?parseInt(this.Loc.OLD_mrevid):"",focusSelector:b.focusSelector===true})},DestroyDestinationControls:function(){BX.removeCustomEvent("OnDestinationAddNewItem",BX.proxy(this.CheckPlannerState,this));BX.removeCustomEvent("OnDestinationUnselect",BX.proxy(this.CheckPlannerState,this));BX.removeCustomEvent("OnCalendarPlannerSelectorChanged",BX.proxy(this.OnCalendarPlannerSelectorChanged,this));BX.removeCustomEvent("OnCalendarPlannerScaleChanged",BX.proxy(this.OnCalendarPlannerScaleChanged,this));BX.removeCustomEvent("OnSetTab",BX.proxy(this.OnPlannerTabShow,this));BX.onCustomEvent("OnCalendarPlannerDoUninstall",[{plannerId:this.plannerId}])},OnPlannerTabShow:function(e,c){if(c&&e.tab==BX(this.id+"ed-tab-2")){var b="",d=this.oEC.ParseLocation(this.Loc.NEW,true);if(d.mrid){b=this.Loc.NEW}if(this.plannerLoadedTimezone!==this.pFromTz.value||this.plannerLoadedlocation!==b){this.CheckPlannerState()}else{this.RefreshPlannerState()}}},CheckPlannerState:function(){var e,h={codes:[]},d=this.oEC.ParseDate(BX.util.trim(this.pFromDate.value)),b=this.oEC.ParseDate(BX.util.trim(this.pToDate.value)),g=this.pDestValuesCont.getElementsByTagName("INPUT"),c=this.oEC.ParseLocation(this.Loc.NEW,true),f=c.mrind==undefined?false:c.mrind;for(e=0;e<g.length;e++){h.codes.push(g[e].value)}if(c.mrid){h.location=this.Loc.NEW}h.locationMrind=f;if(this.Loc&&this.Loc.OLD_mrevid){h.roomEventId=this.Loc.OLD_mrevid}if(d&&b&&d.getTime&&b.getTime&&d.getTime()<=b.getTime()&&(h.location||h.codes.length>0)){h.from=BX.date.format(this.oEC.DATE_FORMAT,(d.getTime()-this.oEC.dayLength*3)/1000);h.to=BX.date.format(this.oEC.DATE_FORMAT,(b.getTime()+this.oEC.dayLength*10)/1000);this.UpdatePlanner(h)}else{if(this.pPlannerCont&&BX.hasClass(this.pPlannerCont,"event-grid-planner-cont-shown")){this.HidePlanner()}}},UpdatePlanner:function(d){if(!d){d={}}this.plannerLoadedTimezone=d.tzFrom||this.pFromTz.value;this.plannerLoadedlocation=d.location||"";console.info(this.plannerLoadedlocation);var e=this,c=d.eventId||this.oEvent.ID||0,b=!c||!this.oEvent||!this.oEvent.IS_MEETING;this.oEC.Request({getData:this.oEC.GetReqData("update_planner",{codes:d.codes||[],cur_event_id:c,date_from:d.dateFrom||d.from||"",date_to:d.dateTo||d.to||"",timezone:this.plannerLoadedTimezone,location:this.plannerLoadedlocation,roomEventId:d.roomEventId||"",entries:d.entrieIds||false,add_cur_user_to_list:b?"Y":"N"}),handler:function(i){var h=!!(d.entries||(i.entries&&i.entries.length>0)),g=BX.hasClass(e.pPlannerCont,"event-grid-planner-cont-shown");if(h){var f={show:h&&!g};if(d.entries){i.entries=d.entries;f.scaleFrom=d.from;f.scaleTo=d.to}f.loadedDataFrom=d.from;f.loadedDataTo=d.to;f.data={entries:i.entries,accessibility:i.accessibility};f.focusSelector=d.focusSelector==undefined?false:d.focusSelector;e.ShowPlannerAnimation();e.RefreshPlannerState(f)}else{if(!h&&g){e.HidePlanner()}}}})},RefreshPlannerState:function(e){if(!e||typeof e!=="object"){e={}}this.plannerData=e.data;var l,j,f=this.pFullDay.checked,c={},g,d,b,n,m=this.pPlannerCont&&BX.hasClass(this.pPlannerCont,"event-grid-planner-cont-shown");if(e.focusSelector==undefined){e.focusSelector=true}if(f){l=this.oEC.ParseDate(BX.util.trim(this.pFromDate.value));j=this.oEC.ParseDate(BX.util.trim(this.pToDate.value))||l}else{l=this.oEC.ParseDate(BX.util.trim(this.pFromDate.value)+" "+BX.util.trim(this.pFromTime.value));if(this.pToDate.value==""){this.pToDate.value=this.pFromDate.value}j=this.oEC.ParseDate(BX.util.trim(this.pToDate.value)+" "+BX.util.trim(this.pToTime.value))}if(l&&j&&l.getTime&&j.getTime&&l.getTime()<=j.getTime()){if(!m&&!e.data){this.CheckPlannerState()}else{if(e.show){BX.addClass(this.pPlannerCont,"event-grid-planner-cont-shown");this.pMeetingParams.style.display="block";d=this.pPlannerCont.offsetWidth-8;if(!m&&e.show){e.focusSelector=true}}if(f){b=new Date(l.getTime());b=e.scaleFrom||new Date(b.getTime()-this.oEC.dayLength*3);n=e.scaleTo||new Date(b.getTime()+this.oEC.dayLength*10);c.scaleType="1day";c.scaleDateFrom=b;c.scaleDateTo=n;c.adjustCellWidth=false}else{c.changeFromFullDay={scaleType:"1hour",timelineCellWidth:40};c.shownScaleTimeFrom=parseInt(this.config.workTimeStart);c.shownScaleTimeTo=parseInt(this.config.workTimeEnd)}c.entriesListWidth=170;c.width=d;var h=false;if(this.RepeatCheck.checked){h={FREQ:this.RepeatSelect.value,INTERVAL:this.RepeatCount.value,UNTIL:this.RepeatDiapTo.value};if(h.UNTIL==EC_MESS.NoLimits){h.UNTIL=""}if(h.FREQ=="WEEKLY"){h.WEEK_DAYS=[];for(g=0;g<7;g++){if(this.RepeatWeekDaysCh[g].checked){h.WEEK_DAYS.push(this.RepeatWeekDaysCh[g].value)}}if(!h.WEEK_DAYS.length){h=false}}}BX.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:this.plannerId,config:c,focusSelector:e.focusSelector,selector:{from:l,to:j,fullDay:!!this.pFullDay.checked,RRULE:h,animation:true,updateScaleLimits:true},data:e.data||false,loadedDataFrom:e.loadedDataFrom,loadedDataTo:e.loadedDataTo,show:!!e.show}])}}else{if(m){this.HidePlanner()}}},HidePlanner:function(){var b=this;this.pPlannerCont.style.opacity=1;this.pPlannerCont.style.display="";this.pPlannerCont.style.height=this.pPlannerCont.offsetHeight+"px";this.pPlannerCont.style.overflow="hidden";BX.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:this.plannerId,hide:true}]);this.pMeetingParams.style.display="none";new BX.easing({duration:600,start:{opacity:100,height:parseInt(this.pPlannerCont.offsetHeight),padding:14},finish:{opacity:0,height:0,padding:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(c){b.pPlannerCont.style.opacity=c.opacity/100;b.pPlannerCont.style.height=c.height+"px"},complete:function(){b.pPlannerCont.removeAttribute("style");BX.removeClass(b.pPlannerCont,"event-grid-planner-cont-shown")}}).animate()},ShowPlannerAnimation:function(){var b=this;this.pPlannerCont.style.opacity=0;this.pPlannerCont.style.display="";new BX.easing({duration:300,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(c){b.pPlannerCont.style.opacity=c.opacity/100},complete:function(){b.pPlannerCont.removeAttribute("style")}}).animate()},InitDateTimeControls:function(){this.pFromToCont=BX("feed-cal-from-to-cont"+this.id);this.pFromDate=BX("feed-cal-event-from"+this.id);this.pToDate=BX("feed-cal-event-to"+this.id);this.pFromTime=BX("feed_cal_event_from_time"+this.id);this.pToTime=BX("feed_cal_event_to_time"+this.id);this.pFullDay=BX("event-full-day"+this.id);this.pDefTimezone=BX("event-tz-def"+this.id);this.pDefTimezoneWrap=BX("event-tz-def-wrap"+this.id);this.pDefTimezone.onchange=BX.proxy(this.DefaultTimezoneOnChange,this);this.pFromTz=BX("event-tz-from"+this.id);this.pToTz=BX("event-tz-to"+this.id);this.pTzOuterCont=BX("event-tz-cont-outer"+this.id);this.pTzSwitch=BX("event-tz-switch"+this.id);this.pTzCont=BX("event-tz-cont"+this.id);this.pTzInnerCont=BX("event-tz-inner-cont"+this.id);this.pTzSwitch.onclick=BX.proxy(this.TimezoneSwitch,this);this.pFromTz.onchange=BX.proxy(this.TimezoneFromOnChange,this);this.pToTz.onchange=BX.proxy(this.TimezoneToOnChange,this);new BX.CHint({parent:BX("event-tz-tip"+this.id),hint:EC_MESS.eventTzHint});new BX.CHint({parent:BX("event-tz-def-tip"+this.id),hint:EC_MESS.eventTzDefHint});this.pReminderCont=BX("feed-cal-reminder-cont"+this.id);this.pReminder=BX("event-reminder"+this.id);this.pRemType=BX("event_remind_type"+this.id);this.pRemCount=BX("event_remind_count"+this.id);this.pFullDay.onclick=BX.proxy(this.FullDay,this);this.pReminder.onclick=BX.proxy(this.Reminder,this);var d=this;this.pFromDate.onclick=function(){BX.calendar({node:this.parentNode,field:this,bTime:false})};this.pToDate.onclick=function(){BX.calendar({node:this.parentNode,field:this,bTime:false})};this.pFromDate.onchange=function(){if(d._FromDateValue){var f=BX.parseDate(d._FromDateValue),g=BX.parseDate(d.pFromDate.value),e=BX.parseDate(d.pToDate.value);if(g&&f){var h=e.getTime()-f.getTime();if(h<0){h=0}e=new Date(g.getTime()+h);if(e){d.pToDate.value=bxFormatDate(e.getDate(),e.getMonth()+1,e.getFullYear())}}}d._FromDateValue=d.pFromDate.value};this.pFromTime.parentNode.onclick=this.pFromTime.onclick=a["bxShowClock_feed_cal_event_from_time"+d.id];this.pToTime.parentNode.onclick=this.pToTime.onclick=a["bxShowClock_feed_cal_event_to_time"+d.id];this.pFromTime.onchange=function(){var h=d.oEC.ParseDate(BX.util.trim(d.pFromDate.value)+" "+BX.util.trim(d.pFromTime.value));if(d.pToDate.value==""){d.pToDate.value=d.pFromDate.value}var f=d.oEC.ParseDate(BX.util.trim(d.pToDate.value)+" "+BX.util.trim(d.pToTime.value));if(d._FromTimeValue){var e=d.oEC.ParseDate(BX.util.trim(d.pFromDate.value)+" "+d._FromTimeValue);var i=f.getTime()-e.getTime();if(i<0){i=3600000}var g=new Date(h.getTime()+i);d.pToDate.value=d.oEC.FormatDate(g);d.pToTime.value=d.oEC.FormatTime(g)}d._FromTimeValue=d.pFromTime.value};var c,b;if(this.oEvent.ID){this.pFullDay.checked=this.bFullDay=this.oEvent.DT_SKIP_TIME=="Y";this.pFullDay.onclick();c=(BX.parseDate(this.oEvent["~DATE_FROM"]||this.oEvent.DATE_FROM));b=(BX.parseDate(this.oEvent["~DATE_TO"]||this.oEvent.DATE_TO));this.pFromDate.value=this.oEC.FormatDate(c);this.pToDate.value=this.oEC.FormatDate(b);if(this.oEvent.DT_SKIP_TIME!=="Y"){this.pFromTime.value=this.oEC.FormatTime(c);this.pToTime.value=this.oEC.FormatTime(b);this.pFromTz.value=this.oEvent.TZ_FROM||"";this.pToTz.value=this.oEvent.TZ_TO||"";if(this.oEvent.TZ_TO!==this.oEvent.TZ_FROM||this.oEvent.TZ_TO!==this.config.userTimezoneName||parseInt(this.oEvent["~USER_OFFSET_FROM"])>0||parseInt(this.oEvent["~USER_OFFSET_TO"])>0){this.pTzCont.style.height=this.pTzInnerCont.offsetHeight+"px";BX.addClass(this.pTzOuterCont,"bxec-timezone-outer-wrap-opened")}}if(this.oEvent.REMIND&&this.oEvent.REMIND.length>0){this.pReminder.checked=true;this.pRemType.value=this.oEvent.REMIND[0].type;this.pRemCount.value=this.oEvent.REMIND[0].count;this.Reminder(false,true)}else{this.pReminder.checked=false;this.pRemType.value="min";this.pRemCount.value="15";this.Reminder(false,false)}if(this.config.userTimezoneName){this.pDefTimezoneWrap.style.display="none"}else{this.pDefTimezoneWrap.style.display="";this.pDefTimezone.value=this.config.userTimezoneDefault||""}}else{c=this.oEC.GetUsableDateTime(new Date().getTime(),15);b=this.oEC.GetUsableDateTime(c.getTime()+3600000,15);this.pFromDate.value=this.oEC.FormatDate(c);this.pFromTime.value=this.oEC.FormatTime(c);this.pToDate.value=this.oEC.FormatDate(b);this.pToTime.value=this.oEC.FormatTime(b);if(this.config.userTimezoneName){this.pDefTimezoneWrap.style.display="none";this.pDefTimezone.value=this.config.userTimezoneName;this.pFromTz.value=this.pToTz.value=this.config.userTimezoneName}else{this.pDefTimezoneWrap.style.display="";this.pFromTz.value=this.pToTz.value=this.pDefTimezone.value=this.config.userTimezoneDefault||""}this.pFullDay.checked=false;this.FullDay(false,true);this.pReminder.checked=true;this.pRemType.value="min";this.pRemCount.value="15";this.Reminder(false,true)}this.linkFromToTz=this.pFromTz.value==this.pToTz.value;this.linkFromToDefaultTz=this.pFromTz.value==this.pToTz.value&&this.pFromTz.value==this.pDefTimezone.value;this._FromTimeValue=this.pFromTime.value;this._FromDateValue=this.pFromDate.value},FillFormFields:function(){var e=this;this.pName=BX(this.id+"_edit_ed_name");this.pName.value=this.oEvent.NAME||"";this.Title=this.config.Title;this.pName.onkeydown=this.pName.onchange=function(){if(this._titleTimeout){clearTimeout(this._titleTimeout)}this._titleTimeout=setTimeout(function(){var f=BX.util.htmlspecialchars(e.pName.value);e.Title.innerHTML=(e.oEvent.ID?EC_MESS.EditEvent:EC_MESS.NewEvent)+(f!=""?": "+f:"")},20)};this.Location=new BXInputPopup({id:this.id+"loc_1",values:this.oEC.bUseMR?this.oEC.meetingRooms:false,input:BX(this.id+"_planner_location1"),defaultValue:EC_MESS.SelectMR,openTitle:EC_MESS.OpenMRPage,className:"calendar-inp calendar-inp-time",noMRclassName:"calendar-inp calendar-inp-time"});this.Loc={};BX.addCustomEvent(this.Location,"onInputPopupChanged",BX.proxy(this.LocationOnChange,this));if(this.oEvent.ID){var d=BX.util.htmlspecialcharsback(this.oEvent.LOCATION);this.Loc.OLD=d;this.Loc.NEW=d;var b=this.oEC.ParseLocation(d,true);if(b.mrid&&b.mrevid){this.Location.Set(b.mrind,"");this.Loc.OLD_mrid=b.mrid;this.Loc.OLD_mrevid=b.mrevid}else{this.Location.Set(false,d)}}else{this.Location.Set(false,"")}this.pAccessibility=BX(this.id+"_bxec_accessibility");if(this.pAccessibility){this.pAccessibility.value=this.oEvent.ACCESSIBILITY||"busy"}this.pPrivate=BX(this.id+"_bxec_private");if(this.pPrivate){this.pPrivate.checked=this.oEvent.PRIVATE_EVENT||false}this.pImportance=BX(this.id+"_bxec_importance");if(this.pImportance){this.pImportance.value=this.oEvent.IMPORTANCE||"normal"}this.pSectSelect=BX(this.id+"_edit_ed_calend_sel");var c=this.oEvent.SECT_ID||this.oEC.GetLastSection();if(!this.oEC.oSections[c]){c=this.oEC.arSections[0].ID;this.oEC.SaveLastSection(c)}this.oEC.BuildSectionSelect(this.pSectSelect,c);this.pSectSelect.onchange=function(){var f=this.value;if(e.oEC.oSections[f]){e.oEC.SaveLastSection(f);e.ColorControl.Set(e.oEC.oSections[f].COLOR,e.oEC.oSections[f].TEXT_COLOR)}};this.RepeatCheck=BX(this.id+"_edit_ed_rep_check");this.RepeatSelect=BX(this.id+"_edit_ed_rep_sel");this.RepeatCont=BX(this.id+"_edit_ed_rep_cont");this.RepeatPhrase1=BX(this.id+"_edit_ed_rep_phrase1");this.RepeatPhrase2=BX(this.id+"_edit_ed_rep_phrase2");this.RepeatWeekDays=BX(this.id+"_edit_ed_rep_week_days");this.RepeatCount=BX(this.id+"_edit_ed_rep_count");this.RepeatEndsOnNever=BX(this.id+"edit-ev-rep-endson-never");this.RepeatEndsOnCount=BX(this.id+"edit-ev-rep-endson-count");this.RepeatEndsOnUntil=BX(this.id+"edit-ev-rep-endson-until");this.RepeatDiapTo=BX(this.id+"edit-ev-rep-diap-to");this.RepeatCountInp=BX(this.id+"edit-ev-rep-endson-count-input");this.RepeatSelect.onchange=function(){e.RepeatSelectOnChange(this.value)};this.RepeatCount.onmousedown=function(){e.bEditEventDialogOver=true};this.RepeatCheck.onclick=function(){if(this.checked){BX.addClass(e.RepeatCont,"bxec-popup-row-repeat-show")}else{BX.removeClass(e.RepeatCont,"bxec-popup-row-repeat-show")}};BX.bind(this.RepeatEndsOnNever,"change",BX.proxy(this.EndsOnChange,this));BX.bind(this.RepeatEndsOnCount,"change",BX.proxy(this.EndsOnChange,this));BX.bind(this.RepeatEndsOnUntil,"change",BX.proxy(this.EndsOnChange,this));BX.bind(this.RepeatDiapTo,"click",BX.proxy(function(){this.RepeatEndsOnUntil.checked="checked";BX.calendar({node:this.RepeatDiapTo,field:this.RepeatDiapTo,bTime:false});BX.focus(this.RepeatDiapTo);this.EndsOnChange()},this));BX.bind(this.RepeatCountInp,"click",BX.proxy(function(){this.RepeatEndsOnCount.checked="checked";BX.focus(this.RepeatCountInp);this.EndsOnChange()},this));if(this.oEC.Event.IsRecursive(this.oEvent)){this.RepeatCheck.checked=true;this.RepeatSelect.value=this.oEvent.RRULE.FREQ}else{this.RepeatCheck.checked=false}this.RepeatCheck.onclick();this.RepeatSelect.onchange();this.ColorControl=this.oEC.InitColorDialogControl("event",function(f,g){e.Color=f;e.TextColor=g});if(!this.oEvent.displayColor&&this.oEC.oSections[c]){this.oEvent.displayColor=this.oEC.oSections[c].COLOR}if(!this.oEvent.displayTextColor&&this.oEC.oSections[c]){this.oEvent.displayTextColor=this.oEC.oSections[c].TEXT_COLOR}if(this.oEvent.displayColor){this.ColorControl.Set(this.oEvent.displayColor,this.oEvent.displayTextColor)}else{if(this.oEC.oSections[c]){this.ColorControl.Set(this.oEC.oSections[c].COLOR,this.oEC.oSections[c].TEXT_COLOR)}}},EndsOnChange:function(){if(this.RepeatEndsOnNever.checked){this.RepeatCountInp.value="";this.RepeatDiapTo.value=""}else{if(this.RepeatEndsOnCount.checked){this.RepeatDiapTo.value="";if(!this.RepeatCountInp.value){this.RepeatCountInp.value=this.RepeatCountInp.placeholder}BX.focus(this.RepeatCountInp);this.RepeatCountInp.select()}else{this.RepeatCountInp.value="";BX.focus(this.RepeatDiapTo);this.RepeatDiapTo.select()}}},LocationOnChange:function(b,d,c){this.Loc.NEW=(d===false)?(c||""):"ECMR_"+this.oEC.meetingRooms[d].ID},RepeatSelectOnChange:function(f){var d,e,c;f=f.toUpperCase();if(f=="NONE"){}else{this.RepeatPhrase2.innerHTML=EC_MESS.DeDot;if(f=="WEEKLY"){this.RepeatPhrase1.innerHTML=EC_MESS.EveryF;this.RepeatPhrase2.innerHTML+=EC_MESS.WeekP;this.RepeatWeekDays.style.display=(f=="WEEKLY")?"inline-block":"none";e={};if(!this.RepeatWeekDaysCh){this.RepeatWeekDaysCh=[];for(d=0;d<7;d++){this.RepeatWeekDaysCh[d]=BX(this.id+"bxec_week_day_"+d)}}if(this.oEvent&&this.oEvent.ID&&this.oEvent.RRULE&&this.oEvent.RRULE.BYDAY){e=this.oEvent.RRULE.BYDAY}else{c=BX.parseDate(this.pFromDate.value);if(!c){c=bxGetDateFromTS(this.oEvent.DT_FROM_TS)}if(c){e[this.oEC.GetWeekDayByInd(c.getDay())]=true}}for(d=0;d<7;d++){this.RepeatWeekDaysCh[d].checked=!!e[this.RepeatWeekDaysCh[d].value]}}else{if(f=="YEARLY"){this.RepeatPhrase1.innerHTML=EC_MESS.EveryN}else{this.RepeatPhrase1.innerHTML=EC_MESS.EveryM}if(f=="DAILY"){this.RepeatPhrase2.innerHTML+=EC_MESS.DayP}else{if(f=="MONTHLY"){this.RepeatPhrase2.innerHTML+=EC_MESS.MonthP}else{if(f=="YEARLY"){this.RepeatPhrase2.innerHTML+=EC_MESS.YearP}}}this.RepeatWeekDays.style.display="none"}var b=this.oEvent&&this.oEC.Event.IsRecursive(this.oEvent);this.RepeatCount.value=(!this.oEvent.ID||!b)?1:this.oEvent.RRULE.INTERVAL;if(!this.oEvent.ID||!b){this.RepeatEndsOnNever.checked=true}else{if(this.oEvent.RRULE&&this.oEvent.RRULE.COUNT>0){this.RepeatCountInp.value=parseInt(this.oEvent.RRULE.COUNT);this.RepeatEndsOnCount.checked=true}else{if(this.oEvent.RRULE&&this.oEvent.RRULE["~UNTIL"]){this.RepeatDiapTo.value=this.oEvent.RRULE["~UNTIL"];this.RepeatEndsOnUntil.checked=true}else{this.RepeatEndsOnNever.checked=true}}this.EndsOnChange()}}},CustomizeHtmlEditor:function(b){if(b.toolbar.controls&&b.toolbar.controls.spoiler){BX.remove(b.toolbar.controls.spoiler.pCont)}},FullDay:function(b,d){if(d==undefined){d=!this.bFullDay}if(d&&this.pFromDate.value!==""&&this.pFromTime.value===""&&this.pToDate.value!==""&&this.pToTime.value===""){var f=BX.parseDate(this.pFromDate.value),e=BX.parseDate(this.pToDate.value),c=f.getTime()===e.getTime();if(f){f.setHours(12);f.setMinutes(0);this.pFromTime.value=this.oEC.FormatTime(f)}if(e){e.setHours(c?13:12);e.setMinutes(0);this.pToTime.value=this.oEC.FormatTime(e)}this.UpdateAccessibility()}if(d&&this.config.userTimezoneName&&(this.pFromTz.value==""||this.pToTz.value=="")){this.pFromTz.value=this.pToTz.value=this.pDefTimezone.value=this.config.userTimezoneName}if(d){BX.removeClass(this.pFromToCont,"feed-cal-full-day")}else{BX.addClass(this.pFromToCont,"feed-cal-full-day")}this.bFullDay=d},Reminder:function(b,c){if(c==undefined){c=!this.bReminder}this.pReminderCont.className=c?"bxec-reminder":"bxec-reminder-collapsed";this.bReminder=c},TimezoneSwitch:function(){if(this.pTzCont.offsetHeight>0){this.pTzCont.style.height=0;BX.removeClass(this.pTzOuterCont,"bxec-timezone-outer-wrap-opened")}else{this.pTzCont.style.height=this.pTzInnerCont.offsetHeight+"px";BX.addClass(this.pTzOuterCont,"bxec-timezone-outer-wrap-opened")}},DefaultTimezoneOnChange:function(){var b=this.pDefTimezone.value;BX.userOptions.save("calendar","timezone_name","timezone_name",b);if(this.linkFromToDefaultTz){this.pToTz.value=this.pFromTz.value=this.pDefTimezone.value}},TimezoneFromOnChange:function(){if(this.linkFromToTz){this.pToTz.value=this.pFromTz.value}this.linkFromToDefaultTz=false},TimezoneToOnChange:function(){this.linkFromToTz=false;this.linkFromToDefaultTz=false},UpdateAccessibility:function(b){var c=this;if(b!==false){if(this.updateAccessibilityTimeout){this.updateAccessibilityTimeout=clearTimeout(this.updateAccessibilityTimeout)}this.updateAccessibilityTimeout=setTimeout(function(){c.UpdateAccessibility(false)},500);return}},ParseDateFromTo:function(){var c=this.pFromDate.value,b=this.pToDate.value;if(!this.pFullDay.checked){c+=" "+this.pFromTime.value;b+=" "+this.pToTime.value}return{from:this.oEC.ParseDate(c),to:this.oEC.ParseDate(b)}}};a.ECDragDropControl=function(b){this.oEC=b.calendar;this.enabled=true};a.ECDragDropControl.prototype={Reset:function(){jsDD.Reset()},RegisterDay:function(b){if(!this.enabled){return}var c=this;jsDD.registerDest(b);b.onbxdestdragfinish=function(f,e,h){if(c.oDiv){var g=parseInt(c.oDiv.getAttribute("data-bx-event-ind")),d=new Date(c.oEC.activeDateDays[c.oEC.GetDayIndexByElement(b.parentNode)].getTime());if(!isNaN(g)&&c.oEC.arEvents[g]){c.MoveEventToNewDate(c.oEC.arEvents[g],d,"day")}BX.removeClass(b,"bxc-day-drag")}c.OnDragFinish();return true};b.onbxdestdraghover=function(e,d,f){if(c.oDiv){BX.addClass(b,"bxc-day-drag")}};b.onbxdestdraghout=function(e,d,f){if(c.oDiv){BX.removeClass(b,"bxc-day-drag")}}},RegisterTitleDay:function(d,c,b){if(!this.enabled){return}var e=this;jsDD.registerDest(d);jsDD.registerDest(c);d.onbxdestdragfinish=c.onbxdestdragfinish=function(j,g,m){if(e.oDiv){var l=parseInt(e.oDiv.getAttribute("data-bx-event-ind")),i=parseInt(d.getAttribute("data-bx-day-ind")),h=e.oEC.Tabs[b].arDays[i],f=new Date();f.setFullYear(h.year,h.month,h.date);if(!isNaN(l)&&e.oEC.arEvents[l]){e.MoveEventToNewDate(e.oEC.arEvents[l],f,"day")}}BX.removeClass(d,"bxc-day-drag");BX.removeClass(c,"bxc-day-drag");e.OnDragFinish();return true};d.onbxdestdraghover=c.onbxdestdraghover=function(g,f,h){BX.addClass(d,"bxc-day-drag");BX.addClass(c,"bxc-day-drag")};d.onbxdestdraghout=c.onbxdestdraghout=function(g,f,h){BX.removeClass(d,"bxc-day-drag");BX.removeClass(c,"bxc-day-drag")}},RegisterTimeline:function(b,c){if(!this.enabled){return}var d=this;jsDD.registerDest(b);b.onbxdestdragfinish=function(h,q,o){if(d.oDiv){var m=parseInt(d.oDiv.getAttribute("data-bx-event-ind"));if(isNaN(m)||!d.oEC.arEvents[m]){return}var s=d.oEC.arEvents[m];if(h.getAttribute("data-bx-event-resizer")=="Y"){var n=parseInt(d.oDiv.getAttribute("data-bx-original-height"),10),r=d.oDiv.offsetHeight-n,g=parseInt(((r-1)/40)*3600);d.ResizeEventTimeline(s,g)}else{var t=d.oDiv.getAttribute("data-bx-day-index");if(t!=undefined&&c.arDays[t]){var i=c.arDays[t],f=parseInt(d.oDiv.style.top,10)-BX.pos(b).top+b.scrollTop,p=Math.max((f-1)/42*60,0);p=Math.round(p/10)*10;var j=parseInt(p/60,10),l=Math.max(p-j*60,0),e=new Date();e.setFullYear(i.year,i.month,i.date);e.setHours(j);e.setMinutes(l);e.setSeconds(0);if(d.oDiv.getAttribute("data-bx-title-event")){s.DT_SKIP_TIME="N";d.MoveEventToNewDate(s,e,"timeline",3600000)}else{d.MoveEventToNewDate(s,e,"timeline")}}}}d.OnDragFinish();return true};b.onbxdestdraghover=function(f,e,g){d.timeLineEventOver=true;d.PrepareTimelineDaysPos(b,c);BX.addClass(b,"bxec-timeline-div-drag")};b.onbxdestdraghout=function(f,e,g){d.ClearTimeline(b)};b.onbxdestdragstop=function(f,e,g){d.ClearTimeline(b)}},ClearTimeline:function(b){this.timeLineEventOver=false;BX.removeClass(b,"bxec-timeline-div-drag");jsDD.current_dest_index=false},GetTimelinePos:function(b){return b.__bxpos},PrepareTimelineDaysPos:function(c,g){this.timeLinePos=this.GetTimelinePos(c);var b=g.pTimelineTable.rows[0];var f,d,e;this.arDays=[];for(var d=1;d<b.cells.length;d++){f=b.cells[d];e=BX.pos(f);e._left=e.left-this.timeLinePos[0];e._right=e.right-this.timeLinePos[0];this.arDays.push(e)}if(!this.activeDayDrop){this.activeDayDrop=BX.create("DIV",{props:{className:"bxec-timeline-active-day-drag-selector"}});this.activeDayDrop.style.height=parseInt(g.pTimelineTable.offsetHeight,10)+"px"}if(this.activeDayDrop.parentNode!=c){c.appendChild(this.activeDayDrop)}if(!this.timelineDragOverlay){this.timelineDragOverlay=BX.create("DIV",{props:{className:"bxec-timeline-drag-overlay"}});this.timelineDragOverlay.style.height=parseInt(g.pTimelineTable.offsetHeight,10)+"px"}if(this.timelineDragOverlay.parentNode!=c){c.appendChild(this.timelineDragOverlay)}},CheckTimelineOverPos:function(b,e){if(this.timeLineEventOver){this.activeDayDrop.style.display="block";var d,c=this.arDays.length;for(d=0;d<c;d++){if(b>=this.arDays[d].left&&b<=this.arDays[d].right){this.activeDayDrop.style.left=(this.arDays[d]._left-1)+"px";this.activeDayDrop.style.width=(this.arDays[d].width-1)+"px";this.oDiv.style.width=(this.arDays[d].width-5)+"px";this.oDiv.style.left=(this.arDays[d].left+1)+"px";this.oDiv.style.top=(e-10)+"px";this.oDiv.setAttribute("data-bx-day-index",d);break}}}else{if(this.activeDayDrop){this.activeDayDrop.style.display="none"}}},RegisterEvent:function(c,e,d){if(!this.enabled){return}var b=(e["~TYPE"]=="tasks"||!this.oEC.Event.CanDo(e,"edit"));if(this.oEC.Event.IsMeeting(e)&&!this.oEC.Event.IsHost(e)){b=true}if(e.PRIVATE_EVENT&&!this.oEC.Personal()){b=true}var f=this;jsDD.registerObject(c);c.setAttribute("data-bx-title-event",true);c.onbxdragstart=function(){if(b){f.oDiv=null;document.body.style.cursor="default";f.ShowDenyNotice(c,e)}else{f.oDiv=c.cloneNode(true);f.oDiv.className="bxec-event bxec-event-drag";document.body.appendChild(f.oDiv);f.oDiv.style.top="-1000px";f.oDiv.style.left="-1000px";var g=f.oEC.MoreEventsWin;if(g){g.close();g.destroy();g=null}}};c.onbxdrag=function(g,h){if(f.oDiv){f.oDiv.style.left=(g-20)+"px";f.oDiv.style.top=(h-10)+"px";if(d=="week_title"){f.CheckTimelineOverPos(g,h)}}};c.onbxdragstop=function(g,h){if(f.oDiv){setTimeout(function(){if(f.oDiv&&f.oDiv.parentNode){f.oDiv.parentNode.removeChild(f.oDiv);f.oDiv=null}},100)}f.OnDragFinish()};c.onbxdragfinish=function(h,g,i){f.OnDragFinish();return true}},RegisterTimelineEvent:function(c,e,d){if(!this.enabled){return}var b=(e["~TYPE"]=="tasks"||!this.oEC.Event.CanDo(e,"edit"));if(this.oEC.Event.IsMeeting(e)&&!this.oEC.Event.IsHost(e)){b=true}if(e.PRIVATE_EVENT&&!this.oEC.Personal()){b=true}var f=this;jsDD.registerObject(c);c.onbxdragstart=function(){if(b){f.oDiv=null;document.body.style.cursor="default";f.ShowDenyNotice(c,e)}else{f.oDiv=c.cloneNode(true);f.oDiv.className="bxec-tl-event bxec-event-drag";document.body.appendChild(f.oDiv);f.oDiv.style.top="-1000px";f.oDiv.style.left="-1000px"}};c.onbxdrag=function(g,m){if(!f.oDiv){return}if(f.timeLineEventOver){var j,h=f.arDays.length;for(j=0;j<h;j++){if(g>=f.arDays[j].left&&g<=f.arDays[j].right){f.oDiv.style.width=(f.arDays[j].width-15)+"px";f.oDiv.style.left=(f.arDays[j].left+1)+"px";f.oDiv.style.top=(m-10)+"px";f.oDiv.setAttribute("data-bx-day-index",j);break}}}};c.onbxdragstop=function(g,h){f.OnDragFinish();if(!f.oDiv){return}setTimeout(function(){if(f.oDiv&&f.oDiv.parentNode){f.oDiv.parentNode.removeChild(f.oDiv);f.oDiv=null}},100)};c.onbxdragfinish=function(h,g,i){f.OnDragFinish()}},RegisterTimelineEventResizer:function(c,d,f,e){if(!this.enabled){return}var b=(f["~TYPE"]=="tasks"||!this.oEC.Event.CanDo(f,"edit"));c.setAttribute("data-bx-event-resizer","Y");BX.bind(c,"mousedown",function(i){var h=BX.GetWindowSize();i=i||a.event;g.timelineResize={oDiv:d,startY:i.clientY+h.scrollTop,height:parseInt(d.offsetHeight)}});var g=this;jsDD.registerObject(c);c.onbxdragstart=function(){if(b){g.oDiv=null;document.body.style.cursor="default";g.ShowDenyNotice(c,f);return}document.body.style.cursor="s-resize";g.oDiv=d;BX.removeClass(g.oDiv,"bxec-tl-ev-hlt")};c.onbxdrag=function(i,j){if(g.oDiv&&g.timeLineEventOver){var h=(g.timelineResize.height+j-g.timelineResize.startY+5);if(h<=0){h=5}g.timelineResize.oDiv.style.height=h+"px"}};c.onbxdragstop=function(h,i){g.OnDragFinish();if(!g.oDiv){return}};c.onbxdragfinish=function(i,h,j){g.OnDragFinish()}},ResizeEventTimeline:function(e,d){var c=[],f=this;e.DT_LENGTH=Math.max(parseInt(e.DT_LENGTH,10)+d,0);e.DT_LENGTH=Math.round(e.DT_LENGTH/600)*600;e.dateTo.setTime(e.dateFrom.getTime()+e.DT_LENGTH*1000);e.DATE_TO=this.oEC.FormatDateTime(e.dateTo);if(this.oEC.Event.IsMeeting(e)){e["~ATTENDEES"].forEach(function(g){c.push(g.USER_ID)})}var b=e.TZ_FROM!=this.oEC.arConfig.userTimezoneName||e.TZ_TO!=this.oEC.arConfig.userTimezoneName;this.oEC.Request({postData:this.oEC.GetReqData("move_event_to_date",{id:e.ID,current_date_from:e.DATE_FROM,recursive:this.oEC.Event.IsRecursive(e)?"Y":"N",is_meeting:this.oEC.Event.IsMeeting(e)?"Y":"N",attendees:c,date_from:e.DATE_FROM,date_to:e.DATE_TO,section:e.SECT_ID,skip_time:e.DT_SKIP_TIME,timezone:b?this.oEC.arConfig.userTimezoneName:e.TZ_FROM,set_timezone:b?"Y":"N"}),errorText:EC_MESS.EventSaveError,handler:function(g){if(g.reload||f.oEC.Event.IsRecursive(e)){f.oEC.Event.ReloadAll(false)}return true}});this.oEC.Event.PreHandle(e);this.oEC.Event.Display()},MoveEventToNewDate:function(c,j,g,l){var d=[],h=this,e=86400000,b;if(g=="day"&&c.DT_SKIP_TIME=="N"){j.setHours(c.dateFrom.getHours()||0);j.setMinutes(c.dateFrom.getMinutes()||0)}if(l){b=new Date(j.getTime()+l)}else{if(c.DT_SKIP_TIME=="N"){b=new Date(j.getTime()+c.DT_LENGTH*1000)}else{if(c.DT_SKIP_TIME=="Y"){b=new Date(j.getTime()+c.DT_LENGTH*1000-e)}}}var f=c.DATE_FROM;c.DATE_FROM=c.DT_SKIP_TIME=="Y"?this.oEC.FormatDate(j):this.oEC.FormatDateTime(j);c.DATE_TO=c.DT_SKIP_TIME=="Y"?this.oEC.FormatDate(b):this.oEC.FormatDateTime(b);if(this.oEC.Event.IsMeeting(c)){c["~ATTENDEES"].forEach(function(m){d.push(m.USER_ID)})}var i=c.TZ_FROM!=this.oEC.arConfig.userTimezoneName||c.TZ_TO!=this.oEC.arConfig.userTimezoneName;this.oEC.Request({postData:this.oEC.GetReqData("move_event_to_date",{id:c.ID,current_date_from:f,recursive:this.oEC.Event.IsRecursive(c)?"Y":"N",is_meeting:this.oEC.Event.IsMeeting(c)?"Y":"N",attendees:d,date_from:c.DATE_FROM,date_to:c.DATE_TO,section:c.SECT_ID,skip_time:c.DT_SKIP_TIME,timezone:i?this.oEC.arConfig.userTimezoneName:c.TZ_FROM,set_timezone:i?"Y":"N"}),errorText:EC_MESS.EventSaveError,handler:function(m){if(m.reload||h.oEC.Event.IsRecursive(c)){h.oEC.Event.ReloadAll(false)}if(h.oEC.Event.IsMeeting(c)&&m.busy_warning){alert(EC_MESS.EC_BUSY_ALERT)}return true}});if(c.DT_SKIP_TIME=="N"){c["~USER_OFFSET_FROM"]=0;c["~USER_OFFSET_TO"]=0;c.TZ_FROM=c.TZ_TO=this.oEC.arConfig.userTimezoneName}if(l!=undefined){c.DT_LENGTH=parseInt(l,10)/1000}this.oEC.Event.PreHandle(c);this.oEC.Event.Display()},ShowDenyNotice:function(b,c){if(!this.pNotice){this.pNotice=document.body.appendChild(BX.create("DIV",{props:{className:"bxec-event-drag-deny-notice"}}))}if(this.bNoticeShown){this.HideDenyNotice()}if(c["~TYPE"]=="tasks"){this.pNotice.innerHTML=EC_MESS.ddDenyTask}else{this.pNotice.innerHTML=EC_MESS.ddDenyEvent}var d=BX.align(b,250,50,"top");this.pNotice.style.left=d.left+"px";this.pNotice.style.top=d.top+"px";this.pNotice.style.display="block";this.bNoticeShown=true;BX.bind(document,"mouseup",BX.proxy(this.HideDenyNotice,this))},HideDenyNotice:function(){if(this.bNoticeShown){this.bNoticeShown=false;if(this.pNotice){this.pNotice.style.display="none"}BX.unbind(document,"mouseup",BX.proxy(this.HideDenyNotice,this))}},OnDragFinish:function(){},IsDragDropNow:function(){return jsDD.bStarted}}})(window);