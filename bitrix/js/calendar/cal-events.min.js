(function(a){a.JSECEvent=function(b){this.oEC=b};JSECEvent.prototype={Get:function(b){for(i=0,l=this.oEC.arEvents.length;i<l;i++){if(this.oEC.arEvents[i].ID==b){return this.oEC.arEvents[i]}}},IsMeeting:function(b){return this.oEC.allowMeetings&&b&&!!b.IS_MEETING},Attendees:function(b){var c={};if(b&&b.ID&&this.oEC.arAttendees[b.ID]){c=this.oEC.arAttendees[b.ID]}return c},View:function(b){if(b){this.oEC.HighlightEvent_M(b,false,true)}this.oEC.DefaultAction();BX.onCustomEvent(this.oEC,"onBeforeCalendarEventView",[this.oEC,b]);if(this.oEC.DefaultAction()){if(b["~TYPE"]=="tasks"&&a.taskIFramePopup&&b.ID>0){taskIFramePopup.view(parseInt(b.ID))}else{this.oEC.ShowViewEventPopup(b)}BX.onCustomEvent(this.oEC,"onAfterCalendarEventView",[this.oEC,b])}},Edit:function(b){if(b.oEvent){this.oEC.HighlightEvent_M(b.oEvent,false,true)}this.oEC.DefaultAction();BX.onCustomEvent(this.oEC,"onBeforeCalendarEventEdit",[this.oEC,b]);if(this.oEC.DefaultAction()){if(((!b.oEvent&&b.bTasks)||(b.oEvent&&b.oEvent["~TYPE"]=="tasks"&&b.oEvent.ID>0))&&a.taskIFramePopup){if(b.oEvent){taskIFramePopup.edit(parseInt(b.oEvent.ID))}else{taskIFramePopup.add()}}else{this.oEC.ShowEditEventPopup(b)}BX.onCustomEvent(this.oEC,"onAfterCalendarEventView",[this.oEC,b])}},DeleteAllReccurent:function(d,c){if(this.IsRecursive(d)||d.RECURRENCE_ID){var f,g={},e,b=[];for(e=0;e<this.oEC.arEvents.length;e++){f=this.oEC.arEvents[e];if(f.ID!=d.ID&&f.RECURRENCE_ID!=d.ID&&f.ID!=d.RECURRENCE_ID&&(f.RECURRENCE_ID!=d.RECURRENCE_ID||!f.RECURRENCE_ID)){g[this.SmartId(f)]=true;b.push(f)}else{this.Blink(this.oEC.arEvents[e],false)}}this.oEC.arEvents=b;this.oEC.arLoadedEventsId=g}this.Display();return this.Delete(d,c,{recursionMode:"all"})},Delete:function(c,b,d){if(c){this.oEC.HighlightEvent_M(c,false,true)}if(!d){d={}}if(!c||!c.ID){return false}this.oEC.DefaultAction();BX.onCustomEvent(this.oEC,"onBeforeCalendarEventDelete",[this.oEC,c]);if(this.oEC.DefaultAction()){if(c["~TYPE"]=="tasks"){}else{if((this.IsRecursive(c)||c.RECURRENCE_ID)&&!b){this.oEC.ShowConfirmDeleteDialog(c);return false}else{b=!!b;if(this.IsAttendee(c)&&!this.IsHost(c)){b=true;if(!confirm(EC_MESS.DeclineConfirm)){return false}}if(this.IsHost(c)&&!b){b=true;if(!confirm(EC_MESS.DelMeetingConfirm)){return false}}if((!c.IS_MEETING||this.IsHost(c))&&!b){if(!confirm(EC_MESS.DelEventConfirm)){return false}}var e=this;if(this.IsAttendee(c)&&!this.IsHost(c)){return this.SetMeetingStatus(true,{eventId:bxInt(c.ID),comment:""})}else{this.oEC.Request({postData:this.oEC.GetReqData("delete",{id:bxInt(c.ID),name:c.NAME,calendar:bxInt(c.SECT_ID),rec_mode:d.recursionMode||false}),errorText:EC_MESS.DelEventError,handler:function(f){if(f){e.UnDisplay(c)}}})}BX.onCustomEvent(this.oEC,"onAfterCalendarEventDelete",[this.oEC])}}}return true},SetColor:function(c){var d,h=this,g=c.SECT_ID,b,e;function f(k){var j={};if(h.oEC.arSectionsInd[k]&&h.oEC.arSections[h.oEC.arSectionsInd[k]]){j=h.oEC.arSections[h.oEC.arSectionsInd[k]]}if(!j.TEXT_COLOR&&j.COLOR){j.TEXT_COLOR=h.oEC.ColorIsDark(j.COLOR)?"#FFFFFF":"#000000"}return j}if(c["~TYPE"]=="tasks"){b=this.oEC.taskBgColor;e=this.oEC.taskTextColor}else{if(c.USER_MEETING&&!this.IsHost(c)){b=c.USER_MEETING.COLOR;e=c.USER_MEETING.TEXT_COLOR;if(!b){b=c.COLOR}if(!e){e=c.TEXT_COLOR}if(!b){d=f(g);if(d.COLOR){b=this.oEC.oSections[g].COLOR;e=this.oEC.oSections[g].TEXT_COLOR}}if((!b||!e)&&this.oEC.arSections.length){g=this.oEC.GetMeetingSection();d=f(g);if(g){if(!b&&d.COLOR){b=d.COLOR}if(!e&&d.TEXT_COLOR){e=d.TEXT_COLOR}}}}else{if(g){b=c.COLOR;e=c.TEXT_COLOR;d=f(g);if(!b&&d.COLOR){b=d.COLOR}if(!e&&d.TEXT_COLOR){e=d.TEXT_COLOR}}}}if(!b){b="#CEE669"}c.displayColor=b;c.bDark=this.oEC.ColorIsDark(b);if(!e){e=c.bDark?"#FFFFFF":"#000000"}c.displayTextColor=e;return c},SaveUserFields:function(e,b){if(e&&e.event_id&&b>0){e.event_id.value=parseInt(b);var c=this.oEC.GetReqData("").reqId;var d=this;if(e.reqId){e.reqId.value=c}BX.ajax.submit(e,function(){var f=top.BXCRES[c];if(f&&f.refresh){d.ReloadAll(false)}})}},GetQuestIcon:function(b){if(!this.IsBlinked(b)){return""}return'<b title="'+EC_MESS.NotConfirmed+'" class="bxec-stat-q">?</b>'},IsTask:function(b){return b["~TYPE"]=="tasks"},IsHost:function(b,c){if(!c){c=this.oEC.userId}return(b.IS_MEETING&&(b.MEETING_STATUS=="H"||b.ID==b.PARENT_ID&&c==b.MEETING_HOST))},IsAttendee:function(b,c){if(!c){c=this.oEC.userId}if(b.IS_MEETING){return true}return false},IsCrm:function(b){return b.UF_CRM_CAL_EVENT&&b.UF_CRM_CAL_EVENT!=""},IsBlinked:function(b){return b.IS_MEETING&&b.MEETING_STATUS=="Q"},IsRecursive:function(b){return !!b.RRULE},Blink:function(b,d,g){if(b&&b.display&&b.OWNER_ID==this.oEC.userId){if(g){d=this.IsBlinked(b)}if(b._blinkInterval){b._blinkInterval=!!clearInterval(b._blinkInterval)}if(d&&this.oEC.userSettings.blink){var f=this;b._blinkInterval=setInterval(function(){f.BlinkInterval(b)},600)}else{if(!d){var c,e="bxec-event-blink";if(b.oParts){for(c=0;c<b.oParts.length;c++){if(b.oParts[c]){BX.removeClass(b.oParts[c],e)}}}if(b.oDaysT){if(b.oDaysT.week){BX.removeClass(b.oDaysT.week,e)}if(b.oDaysT.day){BX.removeClass(b.oDaysT.day,e)}}if(b.oTLParts){if(b.oTLParts.week){for(c=0;c<b.oTLParts.week.length;c++){if(b.oTLParts.week[c]){BX.removeClass(b.oTLParts.week[c],e)}}}if(b.oTLParts.day){for(c=0;c<b.oTLParts.day.length;c++){if(b.oTLParts.day[c]){BX.removeClass(b.oTLParts.day[c],e)}}}}}}}},BlinkInterval:function(c){if(!this.oEC.userSettings.blink){return this.Blink(c,false,false)}var d,b,f="bxec-event-blink",e=this.oEC.activeTabId;if(e=="month"){if(c.oParts){b=c.oParts.length;for(d=0;d<b;d++){if(c.oParts[d]){BX.toggleClass(c.oParts[d],f)}}}}else{if(c.oDaysT&&c.oTLParts){if(c.oDaysT[e]){BX.toggleClass(c.oDaysT[e],f)}if(c.oTLParts[e]){b=c.oTLParts[e].length;for(d=0;d<b;d++){if(c.oTLParts[e][d]){BX.toggleClass(c.oTLParts[e][d],f)}}}}}},SetMeetingStatus:function(b,e){var d={},g,c=e&&e.eventId?e.eventId:0;if(typeof e=="undefined"){e={}}if(!c&&this.oEC.oViewEventDialog){d=this.oEC.oViewEventDialog.CAL.oEvent;c=d.ID}g=parseInt(e.parentId||d.PARENT_ID);if(!e.eventId){e.eventId=c}if(!b&&!e.confirmed){if(this.IsRecursive(d)){this.oEC.ShowConfirmDeclineDialog(d);return false}else{if(!confirm(EC_MESS.DeclineConfirm)){return false}}}var f=this;this.oEC.Request({postData:this.oEC.GetReqData("set_meeting_status",{event_id:parseInt(e.eventId),parent_id:g,status:b?"Y":"N",reccurent_mode:e.reccurentMode||false,current_date_from:e.currentDateFrom||false}),handler:function(h){if(h){if(!f.oEC.userSettings.showDeclined&&!f.IsHost(d)&&!b&&!e.reccurentMode){f.UnDisplay(f.Get(e.eventId))}if(b||e.reccurentMode){f.ReloadAll(false)}}return true}});return true},SmartId:function(c){var b=c.PARENT_ID||c.ID;if(this.IsRecursive(c)){b+="|"+c.DT_FROM_TS}if(c["~TYPE"]=="tasks"){b+="|task"}return b},ReloadAll:function(b){if(this._reloadTimeout){clearTimeout(this._reloadTimeout)}var c=this;this.oEC.arLoadedEventsId={};this.oEC.arLoadedParentId={};this.oEC.arLoadedMonth={};this.oEC.arEvents=[];this.oEC.SetTabNeedRefresh("month",true);this.oEC.SetTabNeedRefresh("week",true);this.oEC.SetTabNeedRefresh("day",true);if(b===false){this.oEC.LoadEvents()}else{this._reloadTimeout=setTimeout(function(){c.oEC.LoadEvents()},600)}},Save:function(d){var e=parseInt(this.oEC.activeDate.month,10),c=this.oEC.activeDate.year;var b=this.oEC.GetReqData("edit_event",{id:d.id||0,name:d.name,desc:d.desc||"",date_from:d.date_from,date_to:d.date_to,default_tz:d.default_tz,sections:[d.calendar],location:d.location||{OLD:"",NEW:"",CHANGED:""},month:e+1,year:c,skip_time:d.skip_time||"N"});this.oEC.arLoadedMonth={};if(d.RRULE&&d.RRULE){b.rrule=d.RRULE}if(d.remind){b.remind=[{type:d.remind_type,count:d.remind_count}]}if(this.oEC.allowMeetings){b.is_meeting=d.isMeeting||"";if(d.isMeeting){b.meeting=d.meeting||{};if(d.guests){b.guest=d.guests.length>0?d.guests:[0]}}}b.color=d.color||"";b.text_color=d.text_color||"";if(d.accessibility){b.accessibility=d.accessibility}if(d.importance){b.importance=d.importance}if(d.private_event){b.private_event=d.private_event}var f=this;this.oEC.Request({postData:b,errorText:EC_MESS.EventSaveError,handler:function(h){if(h.id&&d.UFForm){f.SaveUserFields(d.UFForm,h.id)}if(h.eventIds&&h.eventIds.length>0){for(var g=0;g<h.eventIds.length;g++){f.UnDisplay(h.eventIds[g],false)}}f.oEC.HandleEvents(h.events,h.attendees);f.oEC.arLoadedMonth[e+"."+c]=true;f.Display();return true}})},Display:function(){this.oEC.SetTabNeedRefresh(this.oEC.activeTabId);if(this.oEC.activeTabId=="month"){this.oEC.DisplayEventsMonth(true)}else{this.oEC.DeSelectTime(this.oEC.activeTabId);this.oEC.ReBuildEvents(this.oEC.activeTabId)}},UnDisplay:function(c,d){var j;if(typeof c=="object"&&c.ID){j=c.ID}else{if(c>0){j=c}}var h,g={},f,b=[];for(f=0;f<this.oEC.arEvents.length;f++){h=this.oEC.arEvents[f];if(h&&(h.ID!=j||h["~TYPE"]=="tasks")){g[this.SmartId(h)]=true;b.push(h)}else{this.Blink(this.oEC.arEvents[f],false)}}this.oEC.arEvents=b;this.oEC.arLoadedEventsId=g;if(d!==false){this.Display()}},SetMeetingParams:function(e){var d=this.oEC.oEditEventDialog;var b=this.oEC.GetReqData("set_meeting_params",{event_id:d.CAL.oEvent.ID,accessibility:d.CAL.DOM.Accessibility.value});if(this.oEC.allowReminders&&d.CAL.DOM.RemCheck.checked){var c=d.CAL.DOM.RemCount.value||"";c=c.replace(/,/g,".");c=c.replace(/[^\d|\.]/g,"");b.remind=[{type:d.CAL.DOM.RemType.value,count:c}]}this.oEC.Request({postData:b,handler:function(f){d.CAL.oEvent.USER_MEETING.REMIND=b.remind||[];d.CAL.oEvent.USER_MEETING.ACCESSIBILITY=b.accessibility}});if(e.callback&&typeof e.callback=="function"){e.callback()}},CanDo:function(b,e,c){if(!b){return false}if(!c){c=this.oEC.userId}if(e=="edit"||e=="delete"){if(this.bReadOnly){return false}if(!b.IS_MEETING&&b.MEETING&&b.MEETING.ORGANIZER){return false}if(b.SECT_ID){var d=this.oEC.oSections[b.SECT_ID];if(d){if(d.SUPERPOSED&&(d.OWNER_ID!=this.oEC.ownerId||d.CAL_TYPE!=this.oEC.type)){return false}if(d.CAL_DAV_CAL&&d.CAL_DAV_CAL.indexOf("@virtual/events/")!==-1){return false}if(d.PERM){return !!d.PERM.edit}}}}return false},BuildActions:function(h){var b,c=h.oEvent,e=c["~TYPE"]=="tasks",g=0,d=BX.create("DIV",{props:{className:"bxec-event-actions"}}),f=d.appendChild(BX.create("DIV",{props:{className:h.bTimeline?"bxec-icon-cont-tl":"bxec-icon-cont"}}));if((!this.IsMeeting(c)||(this.IsMeeting(c)&&this.IsHost(c)))&&(this.CanDo(c,"edit")||(e&&c.CAN_EDIT))&&(!c.PRIVATE_EVENT||this.oEC.Personal())){b=f.appendChild(BX.create("I",{props:{className:"bxec-event-but bxec-ev-edit-icon",title:e?EC_MESS.TaskEdit:EC_MESS.EditEvent}}));b.setAttribute("data-bx-event-action","edit");g++;if(this.IsAttendee(c)&&!this.IsHost(c)){if(c.MEETING_STATUS!="N"){b=f.appendChild(BX.create("I",{props:{className:"bxec-event-but bxec-ev-del-icon",title:EC_MESS.DelEncounter}}));b.setAttribute("data-bx-event-action","del");g++}}else{if(!e){b=f.appendChild(BX.create("I",{props:{className:"bxec-event-but bxec-ev-del-icon",title:EC_MESS.DelEvent}}));b.setAttribute("data-bx-event-action","del");g++}}}if(g!=2){f.style.height="18px";f.style.width=(18*g)+"px";f.style.left="-"+(18*g)+"px"}h.cont.appendChild(d)},GetLabelStyle:function(c){var b="",d=c.IMPORTANCE;if(d&&d!="normal"){b=' style="'+(d=="high"?"font-weight: bold;":"color: #535353;")+'"'}return b},PreHandle:function(b){if(b.DATE_FROM&&b.DATE_TO){b.dateFrom=BX.parseDate(b.DATE_FROM);b.dateTo=BX.parseDate(b.DATE_TO);if(b.dateFrom&&b.dateTo){b.DT_FROM_TS=Math.floor(b.dateFrom.getTime()/1000)*1000;b.DT_TO_TS=Math.floor(b.dateTo.getTime()/1000)*1000;if(b.DT_SKIP_TIME!=="Y"){b.DT_FROM_TS-=(b["~USER_OFFSET_FROM"]||0)*1000;b.DT_TO_TS-=(b["~USER_OFFSET_TO"]||0)*1000}}}return b},CutOffRecursiveEvent:function(c,e){var j=this;var h=Math.floor(this.oEC.ParseDate(e).getTime()/1000)*1000;e=this.oEC.FormatDate(new Date(h-this.oEC.dayLength));if(c.RRULE){c.RRULE.UNTIL=e;c.RRULE["~UNTIL"]=e}var f,g={},d,b=[];if(this.IsRecursive(c)){for(d=0;d<this.oEC.arEvents.length;d++){f=this.oEC.arEvents[d];if(f&&(f.ID!==c.ID||f.DT_FROM_TS<h||f["~TYPE"]=="tasks")){g[this.SmartId(f)]=true;b.push(f)}else{this.Blink(this.oEC.arEvents[d],false)}}this.oEC.arEvents=b;this.oEC.arLoadedEventsId=g}else{for(d=0;d<this.oEC.arEvents.length;d++){f=this.oEC.arEvents[d];if(f&&(f.ID!==c.ID||f.DT_FROM_TS<h||f["~TYPE"]=="tasks")){g[this.SmartId(f)]=true;b.push(f)}else{this.Blink(this.oEC.arEvents[d],false)}}this.oEC.arEvents=b;this.oEC.arLoadedEventsId=g}this.oEC.Request({postData:this.oEC.GetReqData("change_recurcive_event_until",{event_id:parseInt(c.ID),until_date:e}),handler:function(){j.ReloadAll(false);return true}});this.Display()},ExcludeRecursionDate:function(c,d){var k=this;var g=Math.floor(this.oEC.ParseDate(d).getTime()/1000)*1000;var j,h={},f,b=[];for(f=0;f<this.oEC.arEvents.length;f++){j=this.oEC.arEvents[f];if(j&&(j.ID!==c.ID||j.DT_FROM_TS!=g||j["~TYPE"]=="tasks")){h[this.SmartId(j)]=true;b.push(j)}else{this.Blink(this.oEC.arEvents[f],false)}}this.oEC.arEvents=b;this.oEC.arLoadedEventsId=h;this.oEC.Request({postData:this.oEC.GetReqData("exclude_recursion_date",{event_id:parseInt(c.ID),exclude_date:d}),handler:function(){k.ReloadAll(false);return true}});this.Display()}}})(window);