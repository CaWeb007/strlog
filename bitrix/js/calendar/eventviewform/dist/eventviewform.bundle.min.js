this.BX=this.BX||{};(function(c,e,g,a,f,d){var b=function(){function r(){var y=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,r);babelHelpers.defineProperty(this,"permissions",{});babelHelpers.defineProperty(this,"name","eventviewform");babelHelpers.defineProperty(this,"uid",null);babelHelpers.defineProperty(this,"DOM",{});this.type=y.type||"user";this.ownerId=y.ownerId||0;this.userId=y.userId||0;this.sliderId="calendar:view-entry-slider";this.zIndex=3100;this.entryId=y.entryId||null;this.entryDateFrom=y.entryDateFrom||null;this.timezoneOffset=y.timezoneOffset||null;this.BX=e.Util.getBX();this.sliderOnClose=this.hide.bind(this);this.sliderOnLoad=this.onLoadSlider.bind(this)}babelHelpers.createClass(r,[{key:"initInSlider",value:function j(z,y){this.BX.addCustomEvent(z,"SidePanel.Slider:onLoad",this.sliderOnLoad);this.BX.addCustomEvent(z,"SidePanel.Slider:onClose",this.sliderOnClose);this.BX.addCustomEvent(z,"SidePanel.Slider:onCloseComplete",this.BX.proxy(this.destroy,this));this.createContent(z).then(function(A){if(g.Type.isFunction(y)){y(A)}}.bind(this));this.opened=true}},{key:"show",value:function t(){var y=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(y.entryId){this.entryId=y.entryId}this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),label:{text:g.Loc.getMessage("CALENDAR_EVENT"),bgColor:"#55D0E0"},events:{onClose:this.sliderOnClose,onCloseComplete:this.destroy.bind(this),onLoad:this.sliderOnLoad}});this.opened=true}},{key:"isOpened",value:function x(){return this.opened}},{key:"hide",value:function q(y){if(y&&y.getSliderPage&&y.getSliderPage().getUrl()===this.sliderId){this.BX.removeCustomEvent("SidePanel.Slider::onClose",this.sliderOnClose)}}},{key:"destroy",value:function s(y){this.BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",this.BX.proxy(this.destroy,this));g.Event.unbind(document,"click",e.Util.applyHacksForPopupzIndex);this.BX.SidePanel.Instance.destroy(this.sliderId);e.Util.closeAllPopups();this.opened=false}},{key:"onLoadSlider",value:function v(z){var y=z.getSlider();this.DOM.content=y.layout.content;this.BX.html(y.layout.content,y.getData().get("sliderContent"));this.initControls(this.uid)}},{key:"createContent",value:function m(y){var z=this;return new Promise(function(A){z.BX.ajax.runAction("calendar.api.calendarajax.getViewEventSlider",{data:{entryId:z.entryId,dateFrom:e.Util.formatDate(z.entryDateFrom),timezoneOffset:z.timezoneOffset}}).then(function(B){var C="";if(g.Type.isFunction(y.isOpen)&&y.isOpen()||y.isOpen===true){C=z.BX.util.trim(B.data.html);y.getData().set("sliderContent",C);var D=B.data.additionalParams;z.userId=D.userId;z.uid=D.uniqueId;z.entryUrl=D.entryUrl;z.handleEntryData(D.entry,D.userIndex,D.section)}A(C)},function(B){z.displayError(B.errors);A(B)})})}},{key:"initControls",value:function h(A){var C=this;this.DOM.title=this.DOM.content.querySelector("#".concat(A,"_title"));this.DOM.formWrap=this.DOM.content.querySelector("#".concat(A,"_form_wrap"));this.DOM.form=this.DOM.content.querySelector("#".concat(A,"_form"));this.DOM.buttonSet=this.DOM.content.querySelector("#".concat(A,"_buttonset"));this.DOM.editButton=this.DOM.content.querySelector("#".concat(A,"_but_edit"));this.DOM.delButton=this.DOM.content.querySelector("#".concat(A,"_but_del"));this.DOM.sidebarInner=this.DOM.content.querySelector("#".concat(A,"_sidebar_inner"));this.DOM.chatLink=this.DOM.content.querySelector("#".concat(A,"_but_chat"));if(this.DOM.chatLink){g.Event.bind(this.DOM.chatLink,"click",function(){a.EntryManager.openChatForEntry({entryId:C.entry.parentId,entry:C.entry})})}if(this.DOM.buttonSet){this.initPlannerControl(A);this.initUserListControl(A)}if(this.DOM.content.querySelector("#".concat(A,"_time_inner_wrap")).offsetHeight>50){this.BX.addClass(this.DOM.content.querySelector("#".concat(A,"_time_wrap")),"calendar-slider-sidebar-head-long-time")}if(this.canDo(this.entry,"edit")&&this.DOM.editButton){g.Event.bind(this.DOM.editButton,"click",function(){C.BX.SidePanel.Instance.close(false,function(){a.EntryManager.openEditSlider({entry:this.entry,type:this.type,ownerId:this.ownerId,userId:this.userId})}.bind(C))})}else{this.BX.remove(this.DOM.editButton)}if(this.DOM.sidebarInner){this.DOM.reminderWrap=this.DOM.sidebarInner.querySelector(".calendar-slider-sidebar-remind-wrap");if(g.Type.isDomNode(this.DOM.reminderWrap)){var z=!this.canDo(this.entry,"edit")&&this.entry.getCurrentStatus()===false;this.reminderControl=new f.Reminder({wrap:this.DOM.reminderWrap,zIndex:this.zIndex,viewMode:z});this.reminderControl.setValue(this.entry.getReminders());if(!z){this.reminderControl.subscribe("onChange",function(E){if(E instanceof d.BaseEvent){this.reminderValues=E.getData().values;this.BX.ajax.runAction("calendar.api.calendarajax.updateReminders",{data:{entryId:this.entry.id,userId:this.userId,reminders:this.reminderValues}})}}.bind(this))}}var y=this.DOM.sidebarInner.querySelectorAll(".calendar-slider-sidebar-border-bottom");if(y.length>=2){this.BX.removeClass(y[y.length-1],"calendar-slider-sidebar-border-bottom")}}if(this.canDo(this.entry,"delete")){g.Event.bind(this.DOM.delButton,"click",function(){a.EntryManager.deleteEntry(C.entry)})}else{this.BX.remove(this.DOM.delButton)}this.BX.viewElementBind(A+"_"+this.entry.id+"_files_wrap",{showTitle:true},function(E){return g.Type.isElementNode(E)&&(E.getAttribute("data-bx-viewer")||E.getAttribute("data-bx-image"))});if(this.entry&&this.entry.isMeeting()){this.initAcceptMeetingControl(A);var B=this.entry.getAttendees();if(g.Type.isArray(B)){if(window.location.host==="cp.bitrix.ru"&&this.DOM.chatLink&&B.length>1&&B.find(function(E){return E.STATUS!=="N"&&parseInt(E.ID)===parseInt(C.userId)})){this.DOM.chatLink.style.display=""}}}if(this.DOM.sidebarInner){var D=this.DOM.sidebarInner.querySelectorAll(".calendar-slider-sidebar-border-bottom");if(D.length>=2){this.BX.removeClass(D[D.length-1],"calendar-slider-sidebar-border-bottom")}}this.DOM.copyButton=this.DOM.content.querySelector("#".concat(A,"_copy_url_btn"));if(this.DOM.copyButton){g.Event.bind(this.DOM.copyButton,"click",this.copyEventUrl.bind(this))}g.Event.unbind(document,"click",e.Util.applyHacksForPopupzIndex);g.Event.bind(document,"click",e.Util.applyHacksForPopupzIndex)}},{key:"handleEntryData",value:function u(A,y,z){this.entry=new a.Entry({data:A,userIndex:y});if(g.Type.isPlainObject(z)){this.permissions=z.PERM}}},{key:"initPlannerControl",value:function l(y){var z=this;this.plannerId=y+"_view_slider_planner";this.DOM.plannerWrap=this.DOM.content.querySelector("#".concat(y,"_view_planner_wrap"));setTimeout(function(){if(this.DOM.plannerWrap){this.BX.removeClass(this.DOM.plannerWrap,"hidden")}}.bind(this),500);setTimeout(function(){if(z.DOM.plannerWrap&&z.DOM.plannerWrap.offsetWidth){z.BX.onCustomEvent("OnCalendarPlannerDoResize",[{plannerId:z.plannerId,timeoutCheck:true,width:z.DOM.plannerWrap.offsetWidth}])}},200);g.Event.bind(window,"resize",function(){if(z.DOM.plannerWrap&&z.DOM.plannerWrap.offsetWidth){z.BX.onCustomEvent("OnCalendarPlannerDoResize",[{plannerId:z.plannerId,timeoutCheck:true,width:z.DOM.plannerWrap.offsetWidth}])}})}},{key:"initUserListControl",value:function k(A){var z=this;var y={y:[],i:[],q:[],n:[]};if(this.entry.isMeeting()){this.entry.getAttendees().forEach(function(B){if(B.STATUS==="H"){y.y.push(B)}else{if(y[B.STATUS.toLowerCase()]){y[B.STATUS.toLowerCase()].push(B)}}},this)}this.DOM.attendeesListY=this.DOM.content.querySelector("#".concat(A,"_attendees_y"));this.DOM.attendeesListN=this.DOM.content.querySelector("#".concat(A,"_attendees_n"));this.DOM.attendeesListQ=this.DOM.content.querySelector("#".concat(A,"_attendees_q"));this.DOM.attendeesListI=this.DOM.content.querySelector("#".concat(A,"_attendees_i"));g.Event.bind(this.DOM.attendeesListY,"click",function(){z.showUserListPopup(z.DOM.attendeesListY,y.y)});g.Event.bind(this.DOM.attendeesListN,"click",function(){z.showUserListPopup(z.DOM.attendeesListN,y.n)});g.Event.bind(this.DOM.attendeesListQ,"click",function(){z.showUserListPopup(z.DOM.attendeesListQ,y.q)});g.Event.bind(this.DOM.attendeesListI,"click",function(){z.showUserListPopup(z.DOM.attendeesListI,y.i)})}},{key:"showUserListPopup",value:function i(A,y){var z=this;if(this.userListPopup){this.userListPopup.close()}if(y&&y.length){this.DOM.userListPopupWrap=this.BX.create("DIV",{props:{className:"calendar-user-list-popup-block"}});y.forEach(function(B){var C=this.DOM.userListPopupWrap.appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-container calendar-slider-sidebar-user-card"}}));C.appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-avatar"}})).appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-block-item"}})).appendChild(this.BX.create("IMG",{props:{width:34,height:34,src:B.AVATAR}}));C.appendChild(this.BX.create("DIV",{props:{className:"calendar-slider-sidebar-user-info"}})).appendChild(this.BX.create("A",{props:{href:B.URL?B.URL:"#",className:"calendar-slider-sidebar-user-info-name"},text:B.DISPLAY_NAME}))},this);this.userListPopup=this.BX.PopupWindowManager.create("user-list-popup-"+Math.random(),A,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:0,resizable:false,lightShadow:true,content:this.DOM.userListPopupWrap,className:"calendar-user-list-popup",zIndex:4000});this.userListPopup.setAngle({offset:36});this.userListPopup.show();this.BX.addCustomEvent(this.userListPopup,"onPopupClose",function(){z.userListPopup.destroy()})}}},{key:"initAcceptMeetingControl",value:function n(y){this.DOM.statusButtonset=this.DOM.content.querySelector("#".concat(y,"_status_buttonset"));this.DOM.statusButtonset.style.marginRight="12px";if(this.entry.getCurrentStatus()==="H"||this.entry.getCurrentStatus()===false){g.Dom.remove(this.DOM.statusButtonset)}else{this.statusControl=new f.MeetingStatusControl({wrap:this.DOM.statusButtonset,currentStatus:this.DOM.content.querySelector("#".concat(y,"_current_status")).value||this.entry.getCurrentStatus()});this.statusControl.subscribe("onSetStatus",function(A){if(A instanceof d.BaseEvent){var z=a.EntryManager.setMeetingStatus(this.entry,A.getData().status);if(!z){this.statusControl.setStatus(this.entry.getCurrentStatus(),false)}}}.bind(this))}}},{key:"copyEventUrl",value:function w(){if(!this.entryUrl||!this.BX.clipboard.copy(this.entryUrl)){return}this.timeoutIds=this.timeoutIds||[];var y=new this.BX.PopupWindow("calendar_clipboard_copy",this.DOM.copyButton,{content:g.Loc.getMessage("CALENDAR_TIP_TEMPLATE_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1000,angle:true,offsetLeft:20,cachable:false});y.show();var z;while(z=this.timeoutIds.pop()){clearTimeout(z)}this.timeoutIds.push(setTimeout(function(){y.close()},1500))}},{key:"displayError",value:function p(){}},{key:"canDo",value:function o(y,z){if(z==="edit"||z==="delete"){return this.permissions.edit}if(z==="view"){return this.permissions.view_full}return false}}]);return r}();c.EventViewForm=b}((this.BX.Calendar=this.BX.Calendar||{}),BX.Calendar,BX,BX.Calendar,BX.Calendar.Controls,BX.Event));