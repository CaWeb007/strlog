JCEC.prototype.BuildWeekDaysTable=function(){var f=this.Tabs.week,d=f.pBodyCont.rows[0],e=f.pBodyCont.rows[1],a=f.pBodyCont.rows[2],b,g;for(b=0;b<7;b++){d.insertCell(b+1);g=e.insertCell(b+1);g.innerHTML='<div class="bxec-wdv-more-ev">&nbsp;</div>'}a.cells[0].colSpan="9";f.pTimelineCont=BX(this.id+"-week-timeline-wrap");this.ResizeTabTitle(f)};JCEC.prototype.ResizeTabTitle=function(d){var c=bxInt(d.pBodyCont.parentNode.offsetWidth)-40-16,a,b;if(d.id=="week"){d.dayColWidth=Math.round(c/7);d.arDayColWidth=[];a=c-(d.dayColWidth*7);for(b=0;b<7;b++){d.arDayColWidth[b]=d.dayColWidth;if(a<0){d.arDayColWidth[b]--;a++}else{if(a>0){d.arDayColWidth[b]++;a--}}}}else{if(d.id=="day"){d.dayColWidth=c;d.arDayColWidth=[d.dayColWidth]}}};JCEC.prototype.FillWeekDaysTitle=function(d){this.dragDrop.Reset();var h=this.Tabs[d.tabId],b=h.pBodyCont,g=b.rows[0],a=b.rows[1],l=d.startDate,o=[],p=this,r,f,c,v,q,s,t,k,u,j,n,m,e;h.curDay=false;for(r=1;r<=d.count;r++){q=this.ConvertDayIndex(l.getDay());s=l.getDate();t=l.getMonth();k=l.getFullYear();c=this.days[q][1]+", "+l.getDate();v=this.days[q][0]+", "+l.getDate()+" "+this.arConfig.month_r[t]+" "+k;n=g.cells[r];m=a.cells[r];n.setAttribute("data-bx-day-ind",r-1);m.setAttribute("data-bx-day-ind",r-1);e=BX.create("A",{props:{className:"bxec-day-link",href:"javascript:void(0)",title:EC_MESS.GoToDay},html:c});BX.cleanNode(n);n.style.width=(h.arDayColWidth[r-1]-2)+"px";n.appendChild(this.CreateStrut(h.arDayColWidth[r-1]-2));n.appendChild(e);e.onmousedown=function(i){return BX.PreventDefault(i)};e.onclick=function(w){var i=h.arDays[this.parentNode.cellIndex-1];p.SetTab("day",false,{bSetDay:false});p.SetDay(i.date,i.month,i.year);return BX.PreventDefault(w)};n.title=v;j=(this.week_holidays[q]||this.year_holidays[s+"."+t])&&!this.year_workdays[s+"."+t];u=s==this.currentDate.date&&t==this.currentDate.month&&k==this.currentDate.year;f="";if(u||j){if(u){f="bxec-cur-day";h.curDay={cellInd:r}}if(j){f+=" bxec-hol-day"}}n.className=m.className=f;o.push({day:q,date:s,month:t,year:k,bHoliday:j,bCurDay:u,pWnd:n,pMoreEvents:m,Events:{begining:[],hidden:[],all:[]},EventsCount:0});if(!this.bReadOnly){n.onmousedown=m.onmousedown=function(){p.DayTitleOnMouseDown(this,d.tabId)};n.onmouseup=m.onmouseup=function(i){if(!p.dragDrop.IsDragDropNow()){p.DayTitleOnMouseUp(this,d.tabId);BX.PreventDefault(i)}};n.onmouseover=m.onmouseover=function(){p.DayTitleOnMouseOver(this,d.tabId)}}l.setDate(l.getDate()+1);if(r==1){h.activeFirst=new Date(k,t,s).getTime()}if(r==d.count){h.activeLast=new Date(k,t,s,23,59).getTime()}this.dragDrop.RegisterTitleDay(n,m,h.id)}return o};JCEC.prototype.BuildTimelineGrid=function(x,n){var d=BX.create("TABLE",{props:{className:"bxec-wdv-timeline-tbl"}}),w="",f="",o=this,y=x.id,r,p,s,q,v,u,t,l,k,g,m=this.arConfig.workTime[0].split("."),h=this.arConfig.workTime[1].split("."),z=bxIntEx(m[0]),b=bxIntEx(m[1]),e=bxIntEx(h[0]),a=bxIntEx(h[1]);x.arDays=n;if(x.pTimelineCont){BX.cleanNode(x.pTimelineCont)}for(r=0;r<24;r++){k=((r<z+1&&b==30)||(r>=e&&a==0)||r>e||r<z);g=((r>=e&&a==30)||r<z||r>=e);w=k?" bxec-wdv-hol-row":"";f=g?" bxec-wdv-hol-row":"";s=d.insertRow(-1);s.className="bxec-half-time-row1"+w;v=s.insertCell(-1);v.innerHTML=this.FormatTimeByNum(r);v.rowSpan="2";v.className="bxec-time";q=d.insertRow(-1);q.className="bxec-half-time-row2"+f;for(p=0;p<x.daysCount;p++){u=s.insertCell(-1);if(r==0){u.style.width=(x.arDayColWidth[p]-2)+"px";u.appendChild(this.CreateStrut(x.arDayColWidth[p]-2))}t=q.insertCell(-1);if(!this.bReadOnly){u.onmousedown=t.onmousedown=function(){o.TimeCellOnMouseDown(this,y)};u.onmouseup=t.onmouseup=function(){o.TimeCellOnMouseUp(this,y)};u.onmouseover=t.onmouseover=function(){o.TimeCellOnMouseOver(this,y)}}l=n[p];if(!l.bHoliday&&!l.bCurDay){continue}if(l.bHoliday){BX.addClass(u,"bxec-time-hol-c1");BX.addClass(t,"bxec-time-hol-c2")}if(l.bCurDay){BX.addClass(u,"bxec-time-cur-c1");BX.addClass(t,"bxec-time-cur-c2")}}}d.rows[0].cells[0].appendChild(this.CreateStrut(40));if(BX.browser.IsIE()){setTimeout(function(){try{var A=d.rows[0].cells[d.rows[0].cells.length-1];var i=x.pBodyCont.rows[0].cells[x.pBodyCont.rows[0].cells.length-2];if(A.offsetLeft-i.offsetLeft>2){A.style.width=x.dayColWidth+50+"px"}}catch(j){}},500)}x.pTimelineTable=d;x.pTimelineCont.appendChild(d);d.parentNode.style.width="100%";setTimeout(function(){x.pTimelineCont.scrollTop=40*bxInt(z);if(x.id=="week"){var c=3;if(BX.browser.IsChrome()||BX.browser.IsSafari()){c=6}d.style.width=(x.pBodyCont.offsetWidth-c)+"px";d.parentNode.style.width=(x.pBodyCont.offsetWidth-c)+"px"}},0);if(x.curDay){setTimeout(function(){o.ShowCurTimePointer(y)},100)}else{this.HideCurTimePointer(y)}this.dragDrop.RegisterTimeline(x.pTimelineCont,x);this.BuildWeekEventHolder()};JCEC.prototype.TimeCellOnMouseOver=function(b,a){if(this.selectTimeMode){this.selectTimeEndObj=b;this.SelectTime(a)}};JCEC.prototype.TimeCellOnMouseDown=function(b,a){this.selectTimeMode=true;this.selectTimeStartObj=this.selectTimeEndObj=b;if(b.className.indexOf("bxec-time-selected")==-1){return this.SelectTime(a)}this.selectTimeMode=false;this.DeSelectTime(a);this.CloseAddEventDialog()};JCEC.prototype.TimeCellOnMouseUp=function(){if(!this.selectTimeMode){return}this.ShowAddEventDialog();this.selectTimeMode=false};JCEC.prototype.DayTitleOnMouseOver=function(c,a){if(this.selectTimeMode&&!this.selectDayTMode){var b=this.__GetRelativeCell(c);this.selectTimeEndObj=this.Tabs[a].pTimelineTable.rows[b.rowInd].cells[b.cellInd];this.SelectTime(a);return}if(this.selectDayTMode){this.selectDayTEndObj=c;this.SelectDaysT(a)}};JCEC.prototype.DayTitleOnMouseDown=function(b,a){this.selectDayTMode=true;this.selectDayTStartObj=this.selectDayTEndObj=b;if(b.className.indexOf("bxec-day-t-selected")==-1){if(this.arSelectedTime&&this.arSelectedTime.length>0){this.SelectTime(a)}this.SelectDaysT(a);return}this.selectDayTMode=false;this.DeSelectDaysT();this.CloseAddEventDialog()};JCEC.prototype.DayTitleOnMouseUp=function(c,a){if(this.selectTimeMode&&!this.selectDayTMode){var b=this.__GetRelativeCell(c);this.selectTimeEndObj=this.Tabs[a].pTimelineTable.rows[b.rowInd].cells[b.cellInd];this.TimeCellOnMouseOver(this.selectTimeEndObj,a);this.TimeCellOnMouseUp(this.selectTimeEndObj,a);return}if(!this.selectDayTMode){return}this.ShowAddEventDialog();this.selectDayTMode=false};JCEC.prototype.__GetRelativeCell=function(c){var b=c.cellIndex,a=0;if(b>this.__ConvertCellIndex(this.selectTimeStartObj.parentNode.rowIndex,this.selectTimeStartObj.cellIndex)){b--;a=47}return{cellInd:b,rowInd:a}};JCEC.prototype.SelectDaysT=function(a){if(!this.arSelectedDaysT){this.arSelectedDaysT=[]}if(!this.selectDayTStartObj||!this.selectDayTEndObj){return}if(this.arSelectedDaysT.length>0){this.DeSelectDaysT()}var d=this.Tabs[a],b=this.selectDayTStartObj,f=this.selectDayTEndObj,c=b.cellIndex,k=f.cellIndex,g=d.pBodyCont,j=g.rows[0],h=g.rows[1],e;if(c>k){b=this.selectDayTEndObj;f=this.selectDayTStartObj;c=b.cellIndex;k=f.cellIndex}this.curDayTSelection={sDay:d.arDays[c-1],eDay:d.arDays[k-1]};for(e=c;e<=k;e++){c1=j.cells[e];c2=h.cells[e];BX.addClass(c1,"bxec-day-t-selected");BX.addClass(c2,"bxec-day-t-selected");this.arSelectedDaysT.push({pCell1:c1,pCell2:c2})}};JCEC.prototype.DeSelectDaysT=function(){if(!this.arSelectedDaysT){return}var b,a;for(b=0,a=this.arSelectedDaysT.length;b<a;b++){BX.removeClass(this.arSelectedDaysT[b].pCell1,"bxec-day-t-selected");BX.removeClass(this.arSelectedDaysT[b].pCell2,"bxec-day-t-selected")}this.arSelectedDaysT=[]};JCEC.prototype.SelectTime=function(c){if(!this.arSelectedTime){this.arSelectedTime=[]}if(!this.selectTimeStartObj||!this.selectTimeEndObj){return}if(this.arSelectedTime.length>0){this.DeSelectTime(c)}var h=this.Tabs[c],f=this.selectTimeStartObj,a=f.parentNode.rowIndex,g=this.__ConvertCellIndex(a,f.cellIndex),m=this.selectTimeEndObj,o=m.parentNode.rowIndex,q=this.__ConvertCellIndex(o,m.cellIndex),n={sDay:h.arDays[g-1],eDay:h.arDays[q-1],sTime:a/2,eTime:o/2+0.5},l,j,p,e,b,d,k;if(a>o&&g==q||g>q){n.sTime+=0.5;n.eTime-=0.5}n.sHour=Math.floor(n.sTime);n.eHour=Math.floor(n.eTime);n.sMin=(n.sTime-n.sHour)*60;n.eMin=(n.eTime-n.eHour)*60;this.curTimeSelection=n;if(g==q){this._SelectTime({sRow:a,eRow:o,col:g,bShowNotifier:true,tabId:c,oDays:n})}else{if(g<q){j=g;p=q;d=a;k=o}else{j=q;p=g;d=o;k=a;_d=n.sDay;n.sDay=n.eDay;n.eDay=_d;_t=n.sTime;n.sTime=n.eTime;n.eTime=_t}for(l=j;l<=p;l++){e=(l==j)?d:0;b=(l==p)?k:47;this._SelectTime({sRow:e,eRow:b,col:l,bShowNotifier:l==j,tabId:c,oDays:n})}}};JCEC.prototype._SelectTime=function(g){var c=this.Tabs[g.tabId].pTimelineTable,e=Math.min(g.eRow,g.sRow),a=Math.max(g.eRow,g.sRow),d,h;for(d=e;d<=a;d++){h=c.rows[d].cells[this.__ConvertCellIndex(d,g.col,true)];BX.addClass(h,"bxec-time-selected");this.arSelectedTime.push({pCell:h})}if(g.bShowNotifier){if(e==g.eRow&&(g.eRow!=g.sRow)){var b=g.oDays.sDay;g.oDays.sDay=g.oDays.eDay;g.oDays.eDay=b;var f=g.oDays.sTime;g.oDays.sTime=g.oDays.eTime;g.oDays.eTime=f}this.ShowSelectTimeNotifier({tabId:g.tabId,rowInd:e,colInd:g.col,oDays:g.oDays})}};JCEC.prototype.__ConvertCellIndex=function(b,a,c){if((b/2)!==Math.round((b/2))){a+=c?-1:1}return a};JCEC.prototype.DeSelectTime=function(b){if(!this.arSelectedTime){return}var c,a;for(c=0,a=this.arSelectedTime.length;c<a;c++){BX.removeClass(this.arSelectedTime[c].pCell,"bxec-time-selected")}this.HideSelectTimeNotifier({tabId:b});this.arSelectedTime=[]};JCEC.prototype.ShowSelectTimeNotifier=function(f,l){var p=this.Tabs[f.tabId],o=p.pTimelineTable,h=o.rows[f.rowInd].cells[this.__ConvertCellIndex(f.rowInd,f.colInd,true)],e=bxInt(h.offsetLeft),k=bxInt(h.offsetTop),j=Math.floor(f.oDays.sTime),n=Math.floor(f.oDays.eTime),b=(f.oDays.sTime-j)*60,a=(f.oDays.eTime-n)*60,r=f.oDays.sDay,q=f.oDays.eDay,m=-19,c=15,d,i,g;if(n==24){n="00"}if(!p.pSTNotifier){p.pSTNotifier=o.parentNode.appendChild(BX.create("DIV",{props:{className:"bxec-st-notifier"}}))}i=this.FormatTimeByNum(j,b);g=this.FormatTimeByNum(n,a);if(f.oDays.sDay==f.oDays.eDay){d="<nobr>"+i+" - "+g+"</nobr>"}else{d="<nobr>"+bxFormatDate(r.date,r.month+1,r.year)+" "+i+" - "+bxFormatDate(q.date,q.month+1,q.year)+" "+g+"</nobr>"}if(bxInt(j)<=0){m=20}p.pSTNotifier.innerHTML='<img class="bxec-iconkit" src="/bitrix/images/1.gif">'+d;p.pSTNotifier.style.left=e+c+"px";p.pSTNotifier.style.top=k+m+"px";p.pSTNotifier.style.display="block"};JCEC.prototype.HideSelectTimeNotifier=function(a){var b=this.Tabs[a.tabId];if(!b.pSTNotifier){return}b.pSTNotifier.style.display="none"};JCEC.prototype.BuildSingleDayTable=function(){var f=this.Tabs.day,e=f.pBodyCont,b=e.rows[0],d=e.rows[1],a=e.rows[2],g;b.insertCell(1);g=d.insertCell(1);g.innerHTML='<div class="bxec-wdv-more-ev">&nbsp;</div>';a.cells[0].colSpan="3";f.pTimelineCont=a.cells[0].firstChild;this.ResizeTabTitle(f)};JCEC.prototype.ShowCurTimePointer=function(b){var g=this,e=this.Tabs[b];if(!e.oCurTimePointer){this.CreateCurTimePointer(b)}function d(){var l=new Date(),k=bxInt(l.getHours()),c=bxInt(l.getMinutes()),j=e.pTimelineTable.rows[k*2].cells[1],i=j.offsetTop+Math.round(j.offsetHeight*2*c/6)/10-(BX.browser.IsSafari()?3:4);e.oCurTimePointer.pWnd.style.top=i+"px";e.oCurTimePointer.pWnd.title=EC_MESS.CurTime+" - "+g.FormatTimeByNum(k,c)}var a=e.oCurTimePointer,f=e.pTimelineTable.rows[0].cells[e.curDay.cellInd];if(!f){return}e.pTimelineCont.appendChild(a.pWnd);a.pWnd.style.display="block";a.pWnd.style.left=bxInt(f.offsetLeft)+"px";a.pWnd.style.width=bxInt(f.offsetWidth)+"px";a.interval=setInterval(d,60000);d()};JCEC.prototype.CreateCurTimePointer=function(a){this.Tabs[a].oCurTimePointer={pWnd:BX.create("DIV",{props:{className:"bxec-time-pointer"},html:'<img class="bxec-iconkit" src="/bitrix/images/1.gif">'})}};JCEC.prototype.HideCurTimePointer=function(a){var b=this.Tabs[a];if(!b.oCurTimePointer){return}if(b.oCurTimePointer.interval){clearInterval(b.oCurTimePointer.interval)}b.oCurTimePointer.pWnd.style.display="none"};JCEC.prototype.SetWeek=function(d,i,g){var e=this.Selector.OnChange(g,i,d),b=e.monthTo,f=e.yearTo,h=this.GetWeekByDate({date:e.dateTo,month:e.monthTo,year:e.yearTo});if(!this.arLoadedMonth[b+"."+f]){return this.LoadEvents(b,f,{week:d,month:i,year:g})}var c=new Date().getTime();if(c>=e.weekStartDate.getTime()&&c<=e.weekEndDate.getTime()){b=this.currentDate.month;f=this.currentDate.year;h=this.GetWeekByDate(this.currentDate)}var a=this.activeDate.month!=b||this.activeDate.year!=f;this.activeDate.week=h;this.activeDate.month=b;this.activeDate.year=f;if(a){this.SetTabNeedRefresh("week",true)}this.BuildTimelineGrid(this.Tabs.week,this.FillWeekDaysTitle({tabId:"week",count:7,startDate:e.weekStartDate}))};JCEC.prototype.SetDay=function(h,c,f){var e=this.Selector.OnChange(f,c,false,h),a=e.month,i=e.year;if(!this.arLoadedMonth[a+"."+i]){return this.LoadEvents(a,i,{date:h,month:c,year:f})}var g=this.activeDate.month!=e.month||this.activeDate.year!=e.year;this.activeDate.date=e.date;this.activeDate.month=e.month;this.activeDate.year=e.year;if(g){this.SetTabNeedRefresh("day",true)}var b=this.FillWeekDaysTitle({tabId:"day",count:1,startDate:e.oDate});this.BuildTimelineGrid(this.Tabs.day,b)};