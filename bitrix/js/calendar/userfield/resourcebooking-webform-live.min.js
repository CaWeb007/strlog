(function(){BX.namespace("BX.Calendar.UserField");function a(b){this.params=b;this.timeFrom=b.timeFrom||7;this.timeTo=b.timeTo||20;this.scale=parseInt(b.field.settings_data.time.scale)||60;this.inputName=b.field.name+"[]";this.DATE_FORMAT=BX.date.convertBitrixFormat(BX.message("FORMAT_DATE"));this.DATETIME_FORMAT=BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME"));this.loadedDates=[];this.accessibility={user:{},resource:{}};this.busySlotMatrix={user:{},resource:{}};this.DOM={wrap:this.params.wrap,valueInputs:[]}}BX.Calendar.UserField.CrmFormResourceBookingFieldLiveController=a;a.prototype={init:function(){this.DOM.outerWrap=this.DOM.wrap.appendChild(BX.create("div",{props:{className:"calendar-resbook-webform-wrapper"}}));this.showMainLoader();this.requireFormData().then(BX.delegate(function(){this.hideMainLoader();this.buildFormControls();this.onChangeValues()},this))},check:function(){var b=true;if(this.usersDisplayed()&&!this.getSelectedUser()){this.userControl.showWarning();b=false}if(b&&this.resourcesDisplayed()&&!this.getSelectedResources()){this.resourceControl.showWarning();b=false}if(b&&!this.getCurrentDuration()){if(this.durationControl){this.durationControl.showWarning()}else{if(this.serviceControl){this.serviceControl.showWarning()}}b=false}if(b&&!this.dateControl.getValue()){this.dateControl.showWarning();b=false}if(b&&this.timeSelectorDisplayed()&&!this.timeControl.getValue()){this.timeControl.showWarning();b=false}return b},buildFormControls:function(){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(BX.create("div",{props:{className:"calendar-resbook-webform-inner"}}));this.DOM.inputsWrap=this.DOM.innerWrap.appendChild(BX.create("div"));if(!this.getFieldParams()){this.statusControl=new BX.Calendar.UserField.ResourceBookingStatusControl({outerWrap:this.DOM.innerWrap});this.statusControl.refresh({});this.statusControl.setError("[UF_NOT_FOUND] "+BX.message("WEBF_RES_BOOKING_UF_WARNING"))}else{this.preparaAutoSelectValues();this.displayUsersControl();this.displayResourcesControl();this.displayServicesControl();this.displayDurationControl();this.displayDateTimeControl();if(this.selectedUserId||this.selectedResourceId){this.refreshControlsState()}}},refreshControlsState:function(){if(this.selectorCanBeShown("resources")&&this.resourceControl&&!this.resourceControl.isShown()){this.resourceControl.display()}if(this.selectorCanBeShown("services")&&this.serviceControl&&!this.serviceControl.isShown()){this.serviceControl.display()}if(this.selectorCanBeShown("duration")&&this.durationControl&&!this.durationControl.isShown()){this.durationControl.display()}var c=this.getSettingsData();if(this.selectorCanBeShown("date")&&this.dateControl){if(!this.dateControl.isShown()){var b;if(c.date.start==="free"){b=this.getFreeDate({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})}else{b=new Date()}this.dateControl.display({selectedValue:b,availableDateIndex:this.getAvailableDateIndex({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})})}else{this.dateControl.refresh(c.date,{availableDateIndex:this.getAvailableDateIndex({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})});if(this.timeControl){this.timeControl.refresh(c.time,{slotIndex:this.getSlotIndex({date:this.dateControl.getValue()}),currentDate:this.dateControl.getValue()})}}}this.updateStatusControl();this.onChangeValues();BX.onCustomEvent(window,"crmWebFormFireResize")},onChangeValues:function(){var h="",g="",i=this.getCurrentDate(),f=this.getCurrentDuration()*60,d=this.getCurrentServiceName(),b=[];BX.cleanNode(this.DOM.inputsWrap);this.DOM.valueInputs=[];if(BX.type.isDate(i)){var e=this.getSelectedResources();if(BX.type.isArray(e)){e.forEach(function(j){b=b.concat({type:"resource",id:j})})}var c=this.getSelectedUser();if(c){b=b.concat({type:"user",id:c})}g=BX.date.format(this.DATETIME_FORMAT,i.getTime()/1000);b.forEach(function(j){var k=j.type+"|"+j.id+"|"+g+"|"+f+"|"+d;h+=k+"#";this.DOM.valueInputs.push(this.DOM.inputsWrap.appendChild(BX.create("INPUT",{attrs:{name:this.inputName,value:k,type:"hidden"}})))},this)}if(!b.length){this.DOM.valueInputs.push(this.DOM.inputsWrap.appendChild(BX.create("INPUT",{attrs:{name:this.inputName,value:"empty",type:"hidden"}})))}},showMainLoader:function(){if(this.DOM.wrap){this.hideMainLoader();this.DOM.mainLoader=this.DOM.outerWrap.appendChild(BX.create("div",{props:{className:"calendar-resbook-webform-wrapper-loader-wrap"},children:[BX.Calendar.UserField.ResourceBooking.getLoader(160)]}))}},hideMainLoader:function(){BX.remove(this.DOM.mainLoader)},showStatusLoader:function(){if(this.DOM.wrap){this.hideMainLoader();this.DOM.mainLoader=this.DOM.outerWrap.appendChild(BX.create("div",{props:{className:"calendar-resbook-webform-wrapper-loader-wrap"},children:[BX.Calendar.UserField.ResourceBooking.getLoader(160)]}))}},hideStatusLoader:function(){BX.remove(this.DOM.mainLoader)},requestAccessibilityData:function(c){if(!this.requestedFormData){this.showStatusLoader();this.requestedFormData=true;var b={from:c.date};this.requireFormData(b).then(BX.delegate(function(){this.hideStatusLoader();this.refreshControlsState();this.dateControl.refreshCurrentValue();this.onChangeValues();this.requestedFormData=false},this))}},requireFormData:function(f){f=f||{};var b={settingsData:this.getSettingsData()||null},e=new BX.Promise();if(!this.userFieldParams){b.fieldName=this.params.field.entity_field_name}var d=BX.type.isDate(f.from)?f.from:new Date(),c;if(BX.type.isDate(f.to)){c=f.to}else{c=new Date(d.getTime());c.setDate(d.getDate()+60)}b.from=BX.date.format(this.DATE_FORMAT,d);b.to=BX.date.format(this.DATE_FORMAT,c);this.setLoadedDataLimits(d,c);BX.ajax.runAction("calendar.api.resourcebookingajax.getfillformdata",{data:b}).then(BX.delegate(function(g){if(BX.type.isNumber(g.data.timezoneOffset)){this.timezoneOffset=g.data.timezoneOffset;this.timezoneOffsetLabel=g.data.timezoneOffsetLabel}if(g.data.workTimeStart!==undefined&&g.data.workTimeEnd!==undefined){this.timeFrom=parseInt(g.data.workTimeStart);this.timeTo=parseInt(g.data.workTimeEnd)}if(g.data.fieldSettings){this.userFieldParams=g.data.fieldSettings}if(g.data.userIndex){this.userIndex=g.data.userIndex}this.handleAccessibilityData(g.data.usersAccessibility,"user");this.handleAccessibilityData(g.data.resourcesAccessibility,"resource");e.fulfill(g.data)},this),function(g){});return e},setLoadedDataLimits:function(e,d){this.loadedDataFrom=BX.type.isDate(e)?e:BX.parseDate(e);this.loadedDataTo=BX.type.isDate(d)?d:BX.parseDate(d);this.loadedDates=this.loadedDates||[];this.loadedDatesIndex=this.loadedDatesIndex||{};var c,b=new Date(this.loadedDataFrom.getTime());while(true){c=BX.date.format(this.DATE_FORMAT,b);this.loadedDatesIndex[c]=this.loadedDates.length;this.loadedDates.push({key:BX.date.format(this.DATE_FORMAT,b),slots:{},slotsCount:{}});b.setDate(b.getDate()+1);if(b.getTime()>this.loadedDataTo.getTime()){break}}},fillDataIndex:function(d,f,e,c){var b=this.loadedDatesIndex[d];if(this.loadedDates[b]){if(!this.loadedDates[b].slots[f]){this.loadedDates[b].slots[f]={}}if(this.loadedDates[b].slotsCount[e+c]===undefined){this.loadedDates[b].slotsCount[e+c]=0}this.loadedDates[b].slots[f][e+c]=true;this.loadedDates[b].slotsCount[e+c]++}},handleAccessibilityData:function(d,c){if(BX.type.isPlainObject(d)&&(c==="user"||c==="resource")){for(var b in d){if(d.hasOwnProperty(b)){d[b].forEach(function(e){if(!e.from){e.from=BX.parseDate(e.dateFrom);if(e.from){e.from.setSeconds(0,0);e.fromTimestamp=e.from.getTime()}}if(!e.to){e.to=BX.parseDate(e.dateTo);if(e.to){if(e.fullDay){e.to.setHours(23,59,0,0)}else{e.to.setSeconds(0,0)}e.toTimestamp=e.to.getTime()}}if(e.from&&e.to){this.fillBusySlotMatrix(e,c,b)}},this)}}this.accessibility[c]=BX.mergeEx(this.accessibility[c],d)}},fillBusySlotMatrix:function(m,e,h){if(!this.busySlotMatrix[e][h]){this.busySlotMatrix[e][h]={}}var l=new Date(m.from.getTime()),g=BX.date.format(this.DATE_FORMAT,l),c=BX.date.format(this.DATE_FORMAT,m.to),n=l.getHours()*60+l.getMinutes(),d=Math.round((m.toTimestamp-m.fromTimestamp)/60000),b=n+d,k=this.getTimeSlots(),j=0,f;if(d>0){while(true){if(!this.busySlotMatrix[e][h][g]){this.busySlotMatrix[e][h][g]={}}for(f=0;f<k.length;f++){if(n<(k[f].time+this.scale)&&b>k[f].time){this.busySlotMatrix[e][h][g][k[f].time]=true;this.fillDataIndex(g,k[f].time,e,h)}}if(g===c){break}else{l.setDate(l.getDate()+1);g=BX.date.format(this.DATE_FORMAT,l);n=0;if(g===c){b=m.to.getHours()*60+m.to.getMinutes()}else{b=1440}}j++;if(j>10000){break}}}},getCaption:function(){return this.params.field.caption},getSettingsData:function(){return this.params.field.settings_data},getUserIndex:function(){return this.userIndex},getFieldParams:function(){return this.userFieldParams},getSettings:function(){return{caption:this.getCaption(),data:this.getSettingsData()}},isUserSelectorInAutoMode:function(){return this.usersDisplayed()&&this.getSettingsData().users.show==="N"},isResourceSelectorInAutoMode:function(){return this.resourcesDisplayed()&&this.getSettingsData().resources.show==="N"},autoAdjustUserSelector:function(){var c=this.dateControl.getValue(),e=this.timeControl.getValue();if(BX.type.isDate(c)&&e){var d,b=this.loadedDates[this.loadedDatesIndex[BX.date.format(this.DATE_FORMAT,c)]];if(b.slots[e]){for(d=0;d<this.userControl.values.length;d++){if(!b.slots[e]["user"+this.userControl.values[d]]){this.userControl.setSelectedUser(this.userControl.values[d]);break}}}}},autoAdjustResourceSelector:function(){var c=this.dateControl.getValue(),e=this.timeControl.getValue();if(BX.type.isDate(c)&&e){var d,f,b=this.loadedDates[this.loadedDatesIndex[BX.date.format(this.DATE_FORMAT,c)]];if(b.slots[e]){for(d=0;d<this.resourceControl.resourceList.length;d++){f=parseInt(this.resourceControl.resourceList[d].id);if(!b.slots[e]["resource"+f]){this.resourceControl.setSelectedResource(f);break}}}}},preparaAutoSelectValues:function(){var g=this.getSettingsData(),h=this.usersDisplayed()&&(g.users.defaultMode==="auto"||g.users.show==="N"),d=this.resourcesDisplayed()&&(g.resources.defaultMode==="auto"||g.resources.show==="N"),b=g.date.start==="free",c=60,e,f;this.selectedUserId=false;this.selectedResourceId=false;e=new Date();for(f=0;f<=c;f++){this.getFreeEntitiesForDate(e,{autoSelectUser:h,autoSelectResource:d,slotsAmount:this.getDefaultDurationSlotsAmount()});if((this.selectedUserId||!h)&&(this.selectedResourceId||!d)){break}if(!b){break}e.setDate(e.getDate()+1)}},getFreeEntitiesForDate:function(c,h){var f=this.getSettingsData(),g=h.slotsAmount||1,e,b,d;if(h.autoSelectUser){b=BX.type.isArray(f.users.value)?f.users.value:f.users.value.split("|");for(e=0;e<b.length;e++){if(this.checkSlotsForDate(c,g,{user:parseInt(b[e])})){this.selectedUserId=parseInt(b[e]);break}}}if(h.autoSelectResource){d=BX.type.isArray(f.resources.value)?f.resources.value:f.resources.value.split("|");for(e=0;e<d.length;e++){if(this.checkSlotsForDate(c,g,{resources:[parseInt(d[e])],user:this.selectedUserId||null})){this.selectedResourceId=parseInt(d[e]);break}}}},displayUsersControl:function(){if(this.usersDisplayed()){this.userControl=new BX.Calendar.UserField.ViewFormUsersControl({outerWrap:this.DOM.innerWrap,data:this.getSettingsData().users,userIndex:this.getUserIndex(),previewMode:false,autoSelectDefaultValue:this.selectedUserId,changeValueCallback:BX.proxy(function(b){BX.onCustomEvent(this,"CrmFormResourceBookingFieldLiveController:onUserChanged",[b]);this.refreshControlsState()},this)});this.userControl.display()}},displayResourcesControl:function(){var f={},e=[],b=this.getFieldParams(),c=this.getSettingsData();if(this.resourcesDisplayed()){c.resources.value.split("|").forEach(function(g){g=parseInt(g);if(g>0){f[g]=true;e.push(g)}});var d=[];b.SELECTED_RESOURCES.forEach(function(g){g.id=parseInt(g.id);if(f[g.id]){d.push(g)}},this);this.resourceControl=new BX.Calendar.UserField.ViewFormResourcesControl({outerWrap:this.DOM.innerWrap,data:{show:c.resources.show,defaultMode:c.resources.defaultMode,label:c.resources.label,multiple:c.resources.multiple,value:c.resources.value},resourceList:d,autoSelectDefaultValue:this.selectedResourceId,changeValueCallback:BX.proxy(function(){BX.onCustomEvent(this,"CrmFormResourceBookingFieldLiveController:onResourceChanged",[]);this.refreshControlsState()},this)});if(this.selectorCanBeShown("resources")){this.resourceControl.display()}}},displayServicesControl:function(){var b=this.getFieldParams(),c=this.getSettingsData();if(b.USE_SERVICES==="Y"&&c.services.value){var d=BX.type.isArray(c.services.value)?c.services.value:c.services.value.split("|");this.serviceControl=new BX.Calendar.UserField.ViewFormServicesControl({outerWrap:this.DOM.innerWrap,data:c.services,serviceList:b.SERVICE_LIST,selectedValue:(BX.type.isArray(d)&&d.length>0)?d[0]:null,changeValueCallback:BX.proxy(function(){BX.onCustomEvent(this,"CrmFormResourceBookingFieldLiveController:onServiceChanged",[]);this.refreshControlsState()},this)});if(this.selectorCanBeShown("services")){this.serviceControl.display()}}},displayDurationControl:function(){var b=this.getFieldParams(),c=this.getSettingsData();if(!this.serviceControl){this.durationControl=new BX.Calendar.UserField.ViewFormDurationControl({outerWrap:this.DOM.innerWrap,data:c.duration,fullDay:b.FULL_DAY==="Y",changeValueCallback:BX.proxy(function(){BX.onCustomEvent(this,"CrmFormResourceBookingFieldLiveController:onDurationChanged",[]);this.refreshControlsState()},this)});if(this.selectorCanBeShown("duration")){this.durationControl.display()}}},displayDateTimeControl:function(){var c=null,f=this.getSettingsData(),b=this.getFieldParams();this.dateControl=new BX.Calendar.UserField.DateSelector({outerWrap:this.DOM.innerWrap,data:f.date,previewMode:false,allowOverbooking:b.ALLOW_OVERBOOKING==="Y",changeValueCallback:BX.proxy(this.handleDateChanging,this),requestDataCallback:BX.proxy(this.requestAccessibilityData,this)});if(this.timeSelectorDisplayed()){var e=false;if(b.USE_USER_TIMEZONE==="N"){var d=-(new Date).getTimezoneOffset()*60;if(d!==this.timezoneOffset){e=b.TIMEZONE}}this.timeControl=new BX.Calendar.UserField.TimeSelector({outerWrap:this.DOM.innerWrap,data:f.time,previewMode:false,changeValueCallback:BX.proxy(this.handleSelectedDateTimeChanging,this),timeFrom:this.timeFrom,timeTo:this.timeTo,timezone:e,timezoneOffset:this.timezoneOffset,timezoneOffsetLabel:this.timezoneOffsetLabel})}this.statusControl=new BX.Calendar.UserField.ResourceBookingStatusControl({outerWrap:this.DOM.innerWrap,timezone:e,timezoneOffsetLabel:this.timezoneOffsetLabel});if(this.selectorCanBeShown("date")){this.statusControl.show();if(f.date.start==="free"){c=this.getFreeDate({resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})}this.dateControl.display({selectedValue:c});if(this.timeControl&&!this.timeControl.isShown()){this.timeControl.display()}}else{this.statusControl.hide()}},handleDateChanging:function(e,d){BX.onCustomEvent(this,"CrmFormResourceBookingFieldLiveController:onDateChanged",[]);if(this.timeSelectorDisplayed()){if(d){this.timeControl.show();var c,b=this.getCurrentDate();if(b){c=b.getHours()*60+b.getMinutes()}this.timeControl.refresh(this.getSettingsData().time,{slotIndex:this.getSlotIndex({date:d}),currentDate:d,selectedValue:c})}}else{this.handleSelectedDateTimeChanging(null,true)}this.onChangeValues()},handleSelectedDateTimeChanging:function(c,b){if(b!==false){if(this.updateTimeStatusTimeout){this.updateTimeStatusTimeout=clearTimeout(this.updateTimeStatusTimeout)}this.updateTimeStatusTimeout=setTimeout(BX.proxy(function(){this.handleSelectedDateTimeChanging(c,false)},this),100)}else{if(this.isUserSelectorInAutoMode()){this.autoAdjustUserSelector()}if(this.isResourceSelectorInAutoMode()){this.autoAdjustResourceSelector()}this.updateStatusControl();BX.onCustomEvent(window,"crmWebFormFireResize")}this.onChangeValues()},updateStatusControl:function(){if(this.statusControl&&this.selectorCanBeShown("date")){var b=this.getCurrentDate();if(this.dateControl.isItPastDate(b)){this.statusControl.setError(BX.message("WEBF_RES_BOOKING_PAST_DATE_WARNING"))}else{if(this.timeSelectorDisplayed()){if(this.timeControl.hasAvailableSlots()){var c=this.timeControl.getValue();this.statusControl.refresh({dateFrom:c?b:null,duration:c?this.getCurrentDuration():null,fullDay:false})}else{this.statusControl.hide()}}else{this.statusControl.refresh({dateFrom:this.dateControl.isDateAvailable(b)?b:null,duration:this.getCurrentDuration(),fullDay:true})}}}},getFreeDate:function(d){var c=Math.ceil(d.duration/this.scale),e=null,b=this.loadedDataFrom;while(true){if(this.checkSlotsForDate(b,c,{resources:d.resources,user:d.user})){e=b;break}b.setDate(b.getDate()+1);if(b.getTime()>=this.loadedDataTo.getTime()){break}}return e},getAvailableDateIndex:function(f){var m,l,n={};if(this.timeSelectorDisplayed()){var k=Math.ceil(f.duration/this.scale);this.loadedDates.forEach(function(i){n[i.key]=this.checkSlotsForDate(i.key,k,{resources:f.resources,user:f.user})},this)}else{var h,e,d,g,b=f.user?"user"+f.user:null,c=Math.ceil(f.duration/1440);e=1;for(h=this.loadedDates.length;h--;h>=0){m=true;l=true;d=this.loadedDates[h];if(b){m=!d.slotsCount[b]}if(m&&f.resources&&f.resources.length>0){for(g=0;g<f.resources.length;g++){l=l&&!d.slotsCount["resource"+f.resources[g]];if(!l){break}}}if(m&&l){e++}else{e=0}n[d.key]=m&&l&&c<=e}}return n},getSlotIndex:function(e){if(e.date){e.date=this.dateControl.getValue()}var n={};if(BX.type.isDate(e.date)){if(this.getFieldParams().ALLOW_OVERBOOKING!=="Y"&&(this.isUserSelectorInAutoMode()||this.isResourceSelectorInAutoMode())){var s,h,f,c,k=this.getSettingsData(),m=1,o=0,r=this.getTimeSlots(),g=BX.date.format(this.DATE_FORMAT,e.date),b=this.loadedDates[this.loadedDatesIndex[g]],l=Math.ceil(this.getCurrentDuration()/this.scale);if(this.checkIsTodayDate(g)){var p=new Date();o=p.getHours()*60+p.getMinutes()}r.forEach(function(i){n[i.time]=true},this);if(this.isUserSelectorInAutoMode()){var d=BX.type.isArray(k.users.value)?k.users.value:k.users.value.split("|");for(h=r.length;h--;h>=0){c=r[h].time;s=false;if(o&&c<o){n[c]=false;continue}for(f=0;f<d.length;f++){if(!b.slots[c]||!b.slots[c]["user"+d[f]]){s=true;break}}n[c]=n[c]&&s&&l<=m;m=s?m+1:1}}if(this.isResourceSelectorInAutoMode()){var q=BX.type.isArray(k.resources.value)?k.resources.value:k.resources.value.split("|");for(h=r.length;h--;h>=0){c=r[h].time;s=false;if(o&&c<o){n[c]=false;continue}for(f=0;f<q.length;f++){if(!b.slots[c]||!b.slots[c]["resource"+q[f]]){s=true;break}}n[c]=n[c]&&s&&l<=m;m=s?m+1:1}}}else{n=this.getAvailableSlotIndex({date:e.date||this.dateControl.getValue(),resources:this.getSelectedResources(),user:this.getSelectedUser(),duration:this.getCurrentDuration()})}}return n},getAvailableSlotIndex:function(f){var h,d,k,g,e,o=0,n,b=f.user?"user"+f.user:null,m=Math.ceil(f.duration/this.scale),r,q,s=this.getTimeSlots(),c=this.getFieldParams().ALLOW_OVERBOOKING==="Y",l={};s.forEach(function(i){l[i.time]=true},this);if(BX.type.isDate(f.date)){h=BX.date.format(this.DATE_FORMAT,f.date);d=this.loadedDates[this.loadedDatesIndex[h]];n=1;if(this.checkIsTodayDate(h)){var p=new Date();o=p.getHours()*60+p.getMinutes()}for(k=s.length;k--;k>=0){e=s[k].time;if(o&&e<o){l[e]=false;continue}if(c){l[e]=m<=n;n++}else{r=true;q=true;if(b){r=!d.slots[e]||!d.slots[e][b]}if(f.resources&&f.resources.length>0){for(g=0;g<f.resources.length;g++){q=q&&(!d.slots[e]||!d.slots[e]["resource"+f.resources[g]]);if(!q){break}}}l[e]=r&&q&&m<=n;if(r&&q){n++}else{n=1}}}}return l},checkSlotsForDate:function(d,f,g){var b=true,c=true,e=BX.type.isDate(d)?BX.date.format(this.DATE_FORMAT,d):d;g=g||{};if(this.usersDisplayed()&&g.user){if(this.busySlotMatrix.user[g.user]&&!this.entityHasSlotsForDate({entityType:"user",entityId:g.user,dateKey:e,slotsAmount:f})){b=false}}if(this.resourcesDisplayed()&&b&&BX.type.isArray(g.resources)&&g.resources.length>0){g.resources.forEach(function(h){if(c&&this.busySlotMatrix.resource[h]&&!this.entityHasSlotsForDate({entityType:"resource",entityId:h,dateKey:e,slotsAmount:f})){c=false}},this)}return b&&c},entityHasSlotsForDate:function(g){var f,c,b,e=0,d=false;if(this.busySlotMatrix[g.entityType][g.entityId]&&this.busySlotMatrix[g.entityType][g.entityId][g.dateKey]){f=this.busySlotMatrix[g.entityType][g.entityId][g.dateKey];c=this.getTimeSlots();for(b=0;b<c.length;b++){if(!f[c[b].time]){e++;if(e>=g.slotsAmount){d=true;break}}else{e=0}}}else{d=true}return d},getSelectedResources:function(){var b=null;if(this.resourceControl){b=this.resourceControl.getSelectedValues();if(BX.type.isArray(b)&&!b.length){b=null}}return b},getSelectedUser:function(){var b=null;if(this.userControl){b=this.userControl.getSelectedUser()}return b},getCurrentDuration:function(){var c=null;if(this.durationControl){c=this.durationControl.getSelectedValue()}else{if(this.serviceControl){var b=this.serviceControl.getSelectedService(true);if(b&&b.duration){c=parseInt(b.duration)}}}return c},getDefaultDurationSlotsAmount:function(){var f=this.getSettingsData(),c=this.getFieldParams(),h,e,g,b=function(i){return BX.translit(i).replace(/[^a-z0-9_]/ig,"_")};if(c.USE_SERVICES==="Y"&&f.services.value){var d=f.services.value.split("|");if(BX.type.isArray(c.SERVICE_LIST)&&BX.type.isArray(d)&&d.length>0){for(e=0;e<c.SERVICE_LIST.length;e++){if(b(c.SERVICE_LIST[e].name)===d[0]){h=parseInt(c.SERVICE_LIST[e].duration);break}}}}else{h=parseInt(f.duration.defaultValue)}g=Math.ceil(h/this.scale);return g},getCurrentServiceName:function(){var c="";if(this.serviceControl){var b=this.serviceControl.getSelectedService(true);if(b&&b.name){c=b.name}}return c},getCurrentDate:function(){var b=null;if(this.dateControl&&this.dateControl.isShown()){b=this.dateControl.getValue();if(this.timeSelectorDisplayed()){var c,d,e=this.timeControl.getValue();if(e){c=Math.floor(e/60);d=e-c*60;b.setHours(c,d,0,0)}}else{b.setHours(0,0,0,0)}}return b},getTimeSlots:function(){if(!this.slots){this.slots=[];var i,c,f,e,b,h,d=0,g=this.timeFrom*60;while(g<this.timeTo*60){f=Math.floor(g/60);e=(g)-f*60;c=g+this.scale;b=Math.floor(c/60);h=(c)-b*60;i={time:g};this.slots.push(i);g+=this.scale;d++}}return this.slots},usersDisplayed:function(){if(this.useUsers===undefined){this.useUsers=!!(this.getFieldParams()["USE_USERS"]==="Y"&&this.getSettingsData().users.value)}return this.useUsers},resourcesDisplayed:function(){if(this.useResources===undefined){var b=this.getFieldParams();this.useResources=!!(b.USE_RESOURCES==="Y"&&b.SELECTED_RESOURCES&&this.getSettingsData().resources.value)}return this.useResources},timeSelectorDisplayed:function(){if(this.useTime===undefined){this.useTime=this.getFieldParams().FULL_DAY!=="Y"}return this.useTime},selectorCanBeShown:function(c){var b=false;if(c==="resources"){if(this.resourcesDisplayed()&&!this.usersDisplayed()){b=true}else{if(this.usersDisplayed()){b=this.getSelectedUser()}}}else{if(c==="date"||c==="services"||c==="duration"){if(this.usersDisplayed()&&this.resourcesDisplayed()){b=this.getSelectedUser()&&this.getSelectedResources()}else{if(this.usersDisplayed()){b=this.getSelectedUser()}else{if(this.resourcesDisplayed()){b=this.getSelectedResources()}}}}}return b},checkIsTodayDate:function(c){if(!this.todayDateKey){var b=new Date();this.todayDateKey=BX.date.format(this.DATE_FORMAT,b)}return this.todayDateKey===c}}})();