JCEC.prototype.ShowAddEventDialog=function(d){var z=this;if(this.bReadOnly){return}if(!this.CheckSectionsCount()){return alert(EC_MESS.NoCalendarsAlert)}var v=this.oAddEventDialog;var x=BX(this.id+"-bitrix24-limit");if(!v){v=new BX.PopupWindow("BXCAddEvent"+this.id,null,{overlay:{opacity:10},autoHide:true,closeByEsc:true,zIndex:0,offsetLeft:0,offsetTop:0,draggable:true,bindOnResize:false,titleBar:EC_MESS.NewEvent,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:x?[new BX.PopupWindowButton({text:EC_MESS.Close,events:{click:function(){z.CloseAddEventDialog(true)}}})]:[new BX.PopupWindowButton({text:EC_MESS.Edit,title:EC_MESS.GoExtTitle,events:{click:function(){z.OpenExFromSimple()}}}),new BX.PopupWindowButton({text:EC_MESS.Add,className:"popup-window-button-accept",events:{click:function(){var t=BX.date.convertBitrixFormat(v.CAL.selectTime?BX.message("FORMAT_DATETIME"):BX.message("FORMAT_DATE")),f=v.CAL.Params.from,D=v.CAL.Params.to,a={name:v.CAL.DOM.Name.value,desc:"",calendar:v.CAL.DOM.SectSelect.value,date_from:BX.date.format(t,f.getTime()/1000),date_to:BX.date.format(t,D.getTime()/1000),default_tz:v.CAL.DOM.DefTimezone.value,skip_time:v.CAL.selectTime?"N":"Y"};if(v.CAL.DOM.Accessibility){a.accessibility=v.CAL.DOM.Accessibility.value}z.Event.Save(a);if(!z.arConfig.userTimezoneName){z.arConfig.userTimezoneName=v.CAL.DOM.DefTimezone.value}z.CloseAddEventDialog(true)}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){z.CloseAddEventDialog(true)}}})],content:BX("bxec_add_ed_"+this.id),events:{}});v.CAL={DOM:{Name:BX(this.id+"_add_ed_name"),PeriodText:BX(this.id+"_add_ed_per_text"),SectSelect:BX(this.id+"_add_ed_calend_sel"),Warn:BX(this.id+"_add_sect_sel_warn"),DefTimezone:BX("event-simple-tz-def"+this.id),DefTimezoneWrap:BX("event-simple-tz-def-wrap"+this.id)}};this.oAddEventDialog=v;if(!x){new BX.CHint({parent:BX("event-tz-simple-def-tip"+this.id),hint:EC_MESS.eventTzDefHint});if(this.bIntranet&&(this.Personal()||this.type!="user")){v.CAL.DOM.Accessibility=BX(this.id+"_add_ed_acc");if(v.CAL.DOM.Accessibility&&BX.browser.IsIE()){v.CAL.DOM.Accessibility.style.width="250px"}}v.CAL.DOM.SectSelect.onchange=function(){z.SaveLastSection(this.value);v.CAL.DOM.Warn.style.display=z.oActiveSections[v.CAL.DOM.SectSelect.value]?"none":"block"}}BX.addCustomEvent(v,"onPopupClose",BX.proxy(this.CloseAddEventDialog,this))}if(x){v.show();return}var C,u,B,F,g,l,n="",c="";v.CAL.DOM.Name.value="";this.BuildSectionSelect(v.CAL.DOM.SectSelect,this.GetLastSection());v.CAL.DOM.Warn.style.display=z.oActiveSections[v.CAL.DOM.SectSelect.value]?"none":"block";v.CAL.DOM.DefTimezoneWrap.style.display="none";v.CAL.selectTime=this.selectTimeMode&&(!this.selectDaysMode&&!this.selectDayTMode);if(this.selectDaysMode){var w=parseInt(this.selectDaysStartObj.id.substr(9)),k=parseInt(this.selectDaysEndObj.id.substr(9));if(w>k){F=k;k=w;w=F}C=this.activeDateDays[w];u=this.activeDateDays[k]}else{if(this.selectTimeMode){B=this.curTimeSelection;C=new Date(B.sDay.year,B.sDay.month,B.sDay.date,B.sHour,B.sMin);u=new Date(B.eDay.year,B.eDay.month,B.eDay.date,B.eHour,B.eMin);if(C.getTime()>u.getTime()){F=C;C=u;u=F}if(this.arConfig.userTimezoneName){v.CAL.DOM.DefTimezoneWrap.style.display="none";v.CAL.DOM.DefTimezone.value=this.arConfig.userTimezoneName}else{v.CAL.DOM.DefTimezoneWrap.style.display="";v.CAL.DOM.DefTimezone.value=this.arConfig.userTimezoneDefault||""}}else{if(this.selectDayTMode){g=this.curDayTSelection;C=new Date(g.sDay.year,g.sDay.month,g.sDay.date);u=new Date(g.eDay.year,g.eDay.month,g.eDay.date)}else{return}}}var E=this.ConvertDayIndex(C.getDay()),r=this.ConvertDayIndex(u.getDay());if(C.getTime()==u.getTime()){l=this.days[E][0]+" "+bxFormatDate(C.getDate(),C.getMonth()+1,C.getFullYear())}else{var s=C.getDate(),p=C.getMonth()+1,e=C.getFullYear(),y=C.getHours(),q=C.getMinutes(),j=u.getDate(),h=u.getMonth()+1,A=u.getFullYear(),o=u.getHours(),i=u.getMinutes(),b=!(y==o&&y==0&&q==i&&q==0);if(b){n=this.FormatTimeByNum(y,q);c=this.FormatTimeByNum(o,i)}if(p==h&&e==A&&s==j&&b){l=this.days[E][0]+" "+bxFormatDate(s,p,e)+", "+n+" &mdash; "+c}else{l=this.days[E][0]+" "+bxFormatDate(s,p,e)+" "+n+" &mdash; "+this.days[r][0]+" "+bxFormatDate(j,h,A)+" "+c}}v.CAL.DOM.PeriodText.innerHTML=l;v.CAL.Params={from:C,to:u,time_f:n||"",time_t:c||""};setTimeout(function(){BX.focus(v.CAL.DOM.Name)},500);if(this.bIntranet&&(this.Personal()||this.type!="user")){v.CAL.DOM.Accessibility.value="busy"}var m=this.GetAddDialogPosition();if(m){v.popupContainer.style.top=m.top+"px";v.popupContainer.style.left=m.left+"px"}v.show()};JCEC.prototype.OpenExFromSimple=function(a){this.CloseAddEventDialog(true);if(!a){return this.ShowEditEventPopup({bExFromSimple:true})}var h=this.oAddEventDialog,b=this.oEditEventDialog.oController,g=h.CAL.Params.from,e=h.CAL.Params.to;b._FromDateValue=b.pFromDate.value=bxFormatDate(g.getDate(),g.getMonth()+1,g.getFullYear());b.pToDate.value=bxFormatDate(e.getDate(),e.getMonth()+1,e.getFullYear());var i=!!(h.CAL.Params.time_f||h.CAL.Params.time_t);b.pFullDay.checked=!i;if(i){b._FromTimeValue=b.pFromTime.value=h.CAL.Params.time_f;b.pToTime.value=h.CAL.Params.time_t||""}else{if(b.pFromDate.value==b.pToDate.value){var d=this.ParseDate(BX.util.trim(b.pFromDate.value)+" "+BX.util.trim(b.pFromTime.value),true);if(d){var c=new Date(d.getTime()+3600000);b.pToDate.value=this.FormatDate(c);b.pToTime.value=this.FormatTime(c)}}else{b.pToTime.value=b.pFromTime.value}}b.FullDay(false,i);if(!this.arConfig.userTimezoneName&&h.CAL.DOM.DefTimezone.value){b.pDefTimezone.value=h.CAL.DOM.DefTimezone.value}b.pName.value=h.CAL.DOM.Name.value;if(this.bIntranet&&b.pAccessibility&&h.CAL.DOM.Accessibility){b.pAccessibility.value=h.CAL.DOM.Accessibility.value}if(h.CAL.DOM.SectSelect.value){b.pSectSelect.value=h.CAL.DOM.SectSelect.value;if(b.pSectSelect.onchange){b.pSectSelect.onchange()}}};JCEC.prototype.CloseAddEventDialog=function(a){if(!this.oAddEventDialog){return}switch(this.activeTabId){case"month":this.DeSelectDays();break;case"week":this.DeSelectTime(this.activeTabId);this.DeSelectDaysT();break;case"day":break}if(a===true){this.oAddEventDialog.close()}};JCEC.prototype.GetAddDialogPosition=function(){if(this.activeTabId=="month"){var a=this.arSelectedDays[this.bInvertedDaysSelection?0:this.arSelectedDays.length-1];if(!a){return false}var b=BX.pos(a);b.top+=parseInt(this.dayCellHeight/2)+20;b.left+=parseInt(this.dayCellWidth/2)+20;b.right=b.left;b.bottom=b.top;b=BX.align(b,360,180);return b}else{return false}};JCEC.prototype.CreateEditEventPopup=function(d){var c=this,a=BX.create("DIV");var b=new BX.PopupWindow("BXCEditEvent"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:EC_MESS.NewEvent,contentColor:"white",contentNoPaddings:true,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-tabed bxc-popup-window",buttons:[new BX.PopupWindowButton({text:EC_MESS.Delete,id:this.id+"ed-del-button",events:{click:function(){if(c.Event.Delete(b.CAL.oEvent)){c.CloseEditEventDialog(true)}}}}),new BX.PopupWindowButton({text:EC_MESS.Save,id:this.id+"ed-save-button",className:"popup-window-button-accept",events:{click:function(){c.oEditEventDialog.oController.SaveForm({callback:function(){c.CloseEditEventDialog(true)}})}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){c.CloseEditEventDialog(true)}}})],content:a,events:{}});BX.addCustomEvent(b,"onPopupClose",BX.proxy(this.CloseEditEventDialog,this));b.CAL={DOM:{content:a,Title:b.titleBar.firstChild,DelBut:BX(this.id+"ed-del-button"),SaveBut:BX(this.id+"ed-save-button")}};BX.addClass(b.CAL.DOM.Title,"bxce-dialog-title");this.oEditEventDialog=b};JCEC.prototype.ShowEditEventPopup=function(e){if(!this.oEditEventDialog){this.CreateEditEventPopup()}if(this.showDialogRequest||this.oEditEventDialog.bShowed){return}if(window.LHEPostForm&&window.LHEPostForm.unsetHandler&&LHEPostForm.getHandler(this.id+"_event_editor")){window.LHEPostForm.unsetHandler(this.id+"_event_editor")}if(!e){e={}}var g=this,b,d=this.oEditEventDialog;d.bExFromSimple=!!e.bExFromSimple;d.CAL.oEvent=e.oEvent||{};b=(d.CAL.oEvent&&d.CAL.oEvent.ID)?d.CAL.oEvent.ID:0;if(b){d.CAL.DOM.DelBut.style.display="";d.CAL.DOM.Title.innerHTML=EC_MESS.EditEvent}else{d.CAL.DOM.DelBut.style.display="none";d.CAL.DOM.Title.innerHTML=EC_MESS.NewEvent}this.showDialogRequest=true;BX.ajax.get(this.actionUrl,this.GetReqData("get_edit_event_dialog",{event_id:b,js_id:this.id}),function(f){if(g.showDialogRequest){BX.removeClass(d.popupContainer.firstChild,"bxc-popup-window-loader");g.showDialogRequest=false;d.CAL.DOM.content.innerHTML=BX.util.trim(f)}});BX.addClass(d.popupContainer.firstChild,"bxc-popup-window-loader");d.CAL.DOM.content.innerHTML='<div class="bxec-popup" style="width: 750px; height: 300px;"><div class="bxce-popup-loader"><div class="bxce-loader-curtain"></div></div></div>';g.oEditEventDialog.show();var a=0;function c(){d.CAL.DOM.pTabs=BX(g.id+"_edit_tabs");a++;if(!d.CAL.DOM.pTabs){if(a<10){return setTimeout(c,100)}else{return}}if(!d.CAL.DOM.pTabs){if(!BX(g.id+"-bitrix24-limit")){g.oEditEventDialog.close();g.Event.ReloadAll()}else{d.CAL.DOM.DelBut.style.display="none";d.CAL.DOM.SaveBut.style.display="none"}a=0;return}g.ChargePopupTabs(d,g.id+"ed-tab-");if(window.__ATTENDEES_ACC){d.CAL.oEvent["~ATTENDEES"]=window.__ATTENDEES_ACC}d.oController=new EditEventPopupController({form:document.forms.event_edit_form,oEC:g,oEvent:d.CAL.oEvent,id:g.id,editorContId:"bx_cal_editor_cont_"+g.id,LHEJsObjName:"pLHEEvDesc",LHEId:"LHEEvDesc",WDControllerCID:window.__UPLOAD_WEBDAV_ELEMENT_CID,arFiles:window.__UPLOAD_WEBDAV_ELEMENT_VALUE,Title:d.CAL.DOM.Title,userTimezoneName:g.arConfig.userTimezoneName,userTimezoneDefault:g.arConfig.userTimezoneDefault});if(window.editEventDestinationFormName){BxEditEventGridSetLinkName(window.editEventDestinationFormName);BX.bind(BX("event-grid-dest-input"),"keyup",BxEditEventGridSearch);BX.bind(BX("event-grid-dest-input"),"keydown",BxEditEventGridSearchBefore);BX.bind(BX("event-grid-dest-add-link"),"click",function(f){BX.SocNetLogDestination.openDialog(editEventDestinationFormName);BX.PreventDefault(f)});BX.bind(BX("event-grid-dest-cont"),"click",function(f){BX.SocNetLogDestination.openDialog(editEventDestinationFormName);BX.PreventDefault(f)})}BX.removeCustomEvent("onAjaxSuccessFinish",c);if(d.bExFromSimple){g.OpenExFromSimple(true)}}BX.addCustomEvent("onAjaxSuccessFinish",c)};JCEC.prototype.CloseEditEventDialog=function(a){if(this.oEditEventDialog){if(a===true){if(this.oEditEventDialog.oController&&this.oEditEventDialog.oController.Location&&this.oEditEventDialog.oController.Location.oPopup){this.oEditEventDialog.oController.Location.oPopup.destroy()}this.oEditEventDialog.close()}if(this.oEditEventDialog.oController){this.oEditEventDialog.oController.DestroyDestinationControls()}this.showDialogRequest=false;this.OnResize()}};JCEC.prototype.CreateViewEventPopup=function(){var c=this,a=BX.create("DIV"),b=new BX.PopupWindow("BXCViewEvent"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:EC_MESS.ViewingEvent,contentColor:"white",contentNoPaddings:true,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-tabed bxc-popup-window",buttons:[new BX.PopupWindowButton({text:EC_MESS.Delete,id:this.id+"_viewev_del_but",events:{click:function(){if(c.Event.Delete(b.CAL.oEvent)){c.CloseViewDialog(true)}}}}),new BX.PopupWindowButton({text:EC_MESS.Edit,id:this.id+"_viewev_edit_but",events:{click:function(){c.ShowEditEventPopup({oEvent:b.CAL.oEvent});c.CloseViewDialog(true)}}}),new BX.PopupWindowButton({text:EC_MESS.Close,className:"popup-window-button-accept",events:{click:function(){c.CloseViewDialog(true)}}})],content:a,events:{}});BX.addCustomEvent(b,"onPopupClose",BX.proxy(this.CloseViewDialog,this));b.CAL={DOM:{content:a,TITLE:b.titleBar.firstChild,delBut:BX(this.id+"_viewev_del_but"),editBut:BX(this.id+"_viewev_edit_but")}};BX.addClass(b.CAL.DOM.TITLE,"bxce-dialog-title");BX.bind(b.CAL.DOM.content,"click",function(i){var d=i.target||i.srcElement;if(d&&d.parentNode){var h=d.getAttribute("data-bx-more-users");if(!!h){var g=BX(h);if(g){BX.addClass(g,"bx-cal-view-att-cont-full")}return}var f=d.getAttribute("data-bx-set-status")||d.parentNode.getAttribute("data-bx-set-status");if(!!f){if(c.Event.SetMeetingStatus(f=="Y")){b.close()}return BX.PreventDefault(i||window.event)}}});this.oViewEventDialog=b};JCEC.prototype.ShowViewEventPopup=function(a){if(!this.oViewEventDialog){this.CreateViewEventPopup()}var i=this,h=this.oViewEventDialog,e=a.ID;BX.addCustomEvent("OnUCFeedChanged",BX.proxy(function(){this.AdjustOverlay(this.oViewEventDialog)},this));if(h.adjustInterval){clearInterval(h.adjustInterval)}h.adjustInterval=setInterval(function(){i.AdjustOverlay(h,false)},1000);h.CAL.DOM.delBut.style.display="none";h.CAL.DOM.editBut.style.display="none";BX.addClass(h.popupContainer.firstChild,"bxc-popup-window-loader");h.CAL.DOM.content.innerHTML='<div class="bxec-popup" style="width: 700px; height: 200px;"><div class="bxce-popup-loader"><div class="bxce-loader-curtain"></div></div></div>';i.oViewEventDialog.show();var c=0,d=0;h.CAL.oEvent=a;BX.ajax.get(this.actionUrl,this.GetReqData("get_view_event_dialog",{event_id:e,js_id:this.id,section_name:this.oSections[a.SECT_ID]?this.oSections[a.SECT_ID].NAME:"",date_from:a.DATE_FROM,date_from_offset:a.TZ_OFFSET_FROM}),g);function g(f){h.CAL.DOM.content.innerHTML=f;h.CAL.DOM.pTabs=BX(i.id+"_viewev_tabs");c++;if(!h.CAL.DOM.pTabs&&c<10){return setTimeout(function(){g(f)},100)}if(!h.CAL.DOM.pTabs){if(!BX(i.id+"-bitrix24-limit")){i.oViewEventDialog.close();i.Event.ReloadAll()}c=0;return}i.ChargePopupTabs(h,i.id+"view-tab-");BX.removeClass(h.popupContainer.firstChild,"bxc-popup-window-loader");h.CAL.DOM.TITLE.innerHTML=EC_MESS.ViewingEvent+": "+BX.util.htmlspecialchars(a.NAME);if(a.PRIVATE_EVENT&&!i.Personal()){h.CAL.DOM.delBut.style.display="none";h.CAL.DOM.editBut.style.display="none"}else{if(i.bIntranet&&i.Event.IsHost(a)&&i.Event.CanDo(a,"edit")){h.CAL.DOM.delBut.style.display="";h.CAL.DOM.editBut.style.display=""}else{if(i.bIntranet&&i.Event.IsAttendee(a)){h.CAL.DOM.delBut.style.display="none";h.CAL.DOM.editBut.style.display="none"}else{if(i.Event.CanDo(a,"edit")){h.CAL.DOM.delBut.style.display="";h.CAL.DOM.editBut.style.display=""}else{h.CAL.DOM.delBut.style.display="none";h.CAL.DOM.editBut.style.display="none"}}}}h.CAL.DOM.pViewTzHint=BX("bxec-view-tz-hint"+i.id);if(h.CAL.DOM.pViewTzHint){new BX.CHint({parent:h.CAL.DOM.pViewTzHint,hint:h.CAL.DOM.pViewTzHint.getAttribute("data-bx-hint")})}BX.viewElementBind("bx-cal-view-files-"+i.id+e,{showTitle:true},function(j){return BX.type.isElementNode(j)&&(j.getAttribute("data-bx-viewer")||j.getAttribute("data-bx-image"))});h.CAL.DOM.commentWrap=BX(i.id+"comments-cont");b(h.CAL.DOM.commentWrap.querySelector(".feed-com-avatar img"))}function b(j){d++;if(j){var f=parseInt(BX.style(j,"width"));if(f>90&&d<20){return setTimeout(function(){b(j)},100)}}i.comAni=new BX.easing({duration:200,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(k){h.CAL.DOM.commentWrap.style.opacity=k.opacity/100},complete:BX.proxy(function(){h.CAL.DOM.commentWrap.style.opacity=null;i.comAni=null},this)});i.comAni.animate()}};JCEC.prototype.AdjustOverlay=function(a,b){if(b===false){if(a&&a.overlay&&a.resizeOverlay){a.resizeOverlay()}}else{setTimeout(function(){if(a&&a.overlay&&a.resizeOverlay){a.resizeOverlay()}},200)}};JCEC.prototype.CloseViewDialog=function(a){BX.removeCustomEvent("OnUCFeedChanged",BX.proxy(function(){this.AdjustOverlay(this.oViewEventDialog)},this));if(this.oViewEventDialog.adjustInterval){this.oViewEventDialog.adjustInterval=clearInterval(this.oViewEventDialog.adjustInterval)}if(a===true){this.oViewEventDialog.close()}this.OnResize()};JCEC.prototype.CreateSectDialog=function(){var b=this;var a=new BX.PopupWindow("BXCSection"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:EC_MESS.NewCalenTitle,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-tabed bxc-popup-window",contentColor:"white",contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:EC_MESS.googleHide,id:this.id+"_bxec_cal_hide_but",events:{click:function(){b.HideCalDavSection(a.CAL.oSect);b.Event.ReloadAll();b.CloseSectDialog(true)}}}),new BX.PopupWindowButton({text:EC_MESS.DelSect,id:this.id+"_bxec_cal_del_but",events:{click:function(){if(b.DeleteSection(a.CAL.oSect)){b.CloseSectDialog(true)}}}}),new BX.PopupWindowButton({text:EC_MESS.Save,className:"popup-window-button-accept",events:{click:function(){if(b.SaveSection()){b.CloseSectDialog(true)}}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){b.CloseSectDialog(true)}}})],content:BX("bxec_sect_d_"+this.id),events:{}});BX.addCustomEvent(a,"onPopupClose",BX.proxy(this.CloseSectDialog,this));a.CAL={DOM:{Title:a.titleBar.firstChild,pTabs:BX(this.id+"_editsect_tabs"),Name:BX(this.id+"_edcal_name"),Desc:BX(this.id+"_edcal_desc"),ExpAllow:BX(this.id+"_bxec_cal_exp_allow"),delBut:BX(this.id+"_bxec_cal_del_but"),hideBut:BX(this.id+"_bxec_cal_hide_but")}};BX.addClass(a.CAL.DOM.Title,"bxce-dialog-title");a.CAL.Access=new ECCalendarAccess({bind:"calendar_section",GetAccessName:BX.proxy(this.GetAccessName,this),pCont:BX(this.id+"access-values-cont"),pLink:BX(this.id+"access-link")});a.CAL.ColorControl=this.InitColorDialogControl("sect",function(c,d){a.CAL.Color=c;a.CAL.TextColor=d});if(this.arConfig.bExchange&&this.Personal()){a.CAL.DOM.Exch=BX(this.id+"_bxec_cal_exch")}this.ChargePopupTabs(a,this.id+"sect-tab-");this.oSectDialog=a;if(this.bSuperpose&&this.Personal()){a.CAL.DOM.add2SPCont=BX(this.id+"_bxec_cal_add2sp_cont");a.CAL.DOM.add2SP=BX(this.id+"_bxec_cal_add2sp")}a.CAL.DOM.ExpAllow.onclick=function(){b._AllowCalendarExportHandler(this.checked)}};JCEC.prototype.ShowSectionDialog=function(a){if(!this.oSectDialog){this.CreateSectDialog()}var b=this.oSectDialog;b.show();this.SetPopupTab(0,b);if(!a){a={PERM:{access:true,add:true,edit:true,edit_section:true,view_full:true,view_time:true,view_title:true}};b.CAL.bNew=true;b.CAL.DOM.Title.innerHTML=EC_MESS.NewCalenTitle;b.CAL.DOM.delBut.style.display="none";b.CAL.DOM.hideBut.style.display="none";a.COLOR=this.GetFreeDialogColor();b.CAL.DOM.ExpAllow.checked=true;this._AllowCalendarExportHandler(true);if(b.CAL.DOM.ExpSet){b.CAL.DOM.ExpSet.value="all"}if(this.bSuperpose&&this.Personal()){b.CAL.DOM.add2SP.checked=true;b.CAL.DOM.add2SPCont.style.display=BX.browser.IsIE()?"inline":"table-row"}if(this.arConfig.bExchange&&this.Personal()){b.CAL.DOM.Exch.disabled=false;b.CAL.DOM.Exch.checked=true}a.ACCESS=this.new_section_access}else{if(this.arConfig.bExchange&&this.Personal()){b.CAL.DOM.Exch.checked=!!a.IS_EXCHANGE;b.CAL.DOM.Exch.disabled=true}b.CAL.bNew=false;b.CAL.DOM.Title.innerHTML=EC_MESS.EditCalenTitle;b.CAL.DOM.delBut.style.display="";b.CAL.DOM.hideBut.style.display="none";if(a.CAL_DAV_CAL&&a.CAL_DAV_CON){b.CAL.DOM.delBut.style.display="none";b.CAL.DOM.hideBut.style.display=""}if(!a.COLOR){a.COLOR=this.arConfig.arCalColors[0]}b.CAL.DOM.ExpAllow.checked=a.EXPORT||false;this._AllowCalendarExportHandler(a.EXPORT);if(a.EXPORT){b.CAL.DOM.ExpSet.value=a.EXPORT_SET||"all"}if(this.bSuperpose&&this.Personal()){b.CAL.DOM.add2SPCont.style.display="none"}}b.CAL.ColorControl.Set(a.COLOR,a.TEXT_COLOR);this.ShowPopupTab(b.CAL.Tabs[1],a.PERM.access);if(a.PERM.access){if(this.type=="user"&&this.Personal()&&a.ACCESS["U"+this.ownerId]){delete a.ACCESS["U"+this.ownerId]}else{if(this.type=="group"&&a.ACCESS["SG"+this.ownerId+"_A"]){delete a.ACCESS["SG"+this.ownerId+"_A"]}}b.CAL.Access.SetSelected(a.ACCESS)}b.CAL.oSect=a;this.bEditCalDialogOver=false;b.CAL.DOM.Name.value=a.NAME||"";b.CAL.DOM.Desc.value=a.DESCRIPTION||"";BX.focus(b.CAL.DOM.Name)};JCEC.prototype.CloseSectDialog=function(a){if(a===true){this.oSectDialog.close()}};JCEC.prototype._AllowCalendarExportHandler=function(a){if(!this.oSectDialog.CAL.DOM.ExpDiv){this.oSectDialog.CAL.DOM.ExpDiv=BX(this.id+"_bxec_calen_exp_div")}if(!this.oSectDialog.CAL.DOM.ExpSet&&a){this.oSectDialog.CAL.DOM.ExpSet=BX(this.id+"_bxec_calen_exp_set")}this.oSectDialog.CAL.DOM.ExpDiv.style.display=a?"block":"none"};JCEC.prototype.CreateExportDialog=function(){var b=this;var a=new BX.PopupWindow("BXCExportDialog"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:" ",closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButton({text:EC_MESS.Close,className:"popup-window-button-accept",events:{click:function(){b.CloseExportDialog(true)}}})],content:BX("bxec_excal_"+this.id)});BX.addCustomEvent(a,"onPopupClose",BX.proxy(this.CloseExportDialog,this));a.CAL={DOM:{Title:a.titleBar.firstChild,Link:BX(this.id+"_excal_link"),NoticeLink:BX(this.id+"_excal_link_outlook"),Text:BX(this.id+"_excal_text"),Warn:BX(this.id+"_excal_warning")}};a.CAL.DOM.NoticeLink.onclick=function(){this.parentNode.className=""};this.oExportDialog=a};JCEC.prototype.ShowExportDialog=function(a){if(a&&a.EXPORT&&!a.EXPORT.ALLOW){return}if(!this.oExportDialog){this.CreateExportDialog()}var c=this.oExportDialog;c.show();c.CAL.DOM.NoticeLink.parentNode.className="bxec-excal-notice-hide";c.CAL.DOM.Warn.className="bxec-export-warning-hidden";var b=this.path;b+=(b.indexOf("?")>=0)?"&":"?";if(a){c.CAL.DOM.Title.innerHTML=EC_MESS.ExpDialTitle;c.CAL.DOM.Text.innerHTML=EC_MESS.ExpText;b+="action=export"+a.EXPORT.LINK}var d="webcal"+b.substr(b.indexOf("://"));c.CAL.DOM.Link.onclick=function(f){window.location.href=d;BX.PreventDefault(f)};c.CAL.DOM.Link.href=b;c.CAL.DOM.Link.innerHTML=b;BX.ajax.get(b+"&check=Y","",function(e){setTimeout(function(){BX.closeWait(c.CAL.DOM.Title);if(!e||e.length<=0||e.toUpperCase().indexOf("BEGIN:VCALENDAR")==-1){c.CAL.DOM.Warn.className="bxec-export-warning"}},300)})};JCEC.prototype.CloseExportDialog=function(a){if(a===true){this.oExportDialog.close()}};JCEC.prototype.CreateSuperposeDialog=function(){var b=this;var a=new BX.PopupWindow("BXCSuperpose"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:EC_MESS.SPCalendars,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButton({text:EC_MESS.Save,className:"popup-window-button-accept",events:{click:function(){b.SPD_SaveSuperposed();b.CloseSuperposeDialog(true)}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){b.CloseSuperposeDialog(true)}}})],content:BX("bxec_superpose_"+this.id),events:{}});BX.addCustomEvent(a,"onPopupClose",BX.proxy(this.CloseSuperposeDialog,this));a.CAL={DOM:{UserCntInner:BX("bxec_sp_type_user_cont_"+this.id),GroupCnt:BX("bxec_sp_type_group_"+this.id),GroupCntInner:BX("bxec_sp_type_group_cont_"+this.id),CommonCnt:BX("bxec_sp_type_common_"+this.id),DelAllUsersLink:BX("bxec_sp_dell_all_sp_"+this.id),UserSearchCont:BX(this.id+"_sp_user_search_input_cont"),NotFoundNotice:BX(this.id+"_sp_user_nf_notice"),arCat:{}},arSect:{},arGroups:{},arCals:{},curTrackedUsers:{}};BX.addCustomEvent(window,"onUserSelectorOnChange",function(c){a.CAL.curTrackedUsers=c});a.CAL.DOM.AddUsersLinkCont=BX(this.id+"_user_control_link_sp");a.CAL.DOM.AddUsersLinkCont.onclick=function(c){if(BX.PopupMenu&&BX.PopupMenu.currentItem){BX.PopupMenu.currentItem.popupWindow.close()}if(!c){c=window.event}if(!a.CAL.DOM.SelectUserPopup){a.CAL.DOM.SelectUserPopup=BX.PopupWindowManager.create("bxc-user-popup-sp",a.CAL.DOM.AddUsersLinkCont,{offsetTop:1,autoHide:true,closeByEsc:true,content:BX("BXCalUserSelectSP_selector_content"),className:"bxc-popup-user-select",buttons:[new BX.PopupWindowButton({text:EC_MESS.Add,events:{click:function(){a.CAL.DOM.SelectUserPopup.close();var e=[],d;for(d in a.CAL.curTrackedUsers){if(a.CAL.curTrackedUsers[d]&&d>0&&parseInt(d)==d){e.push(d)}}b.Request({postData:b.GetReqData("spcal_user_cals",{users:e}),errorText:EC_MESS.CalenSaveErr,handler:function(g){if(g){if(g.sections){if(!b.arSPSections){b.arSPSections=[]}b.SPD_BuildSections(b.arSPSections.concat(g.sections),true);for(var f=0;f<b.arSections.length;f++){if(b.arSections[f].ID&&a.CAL.arSect[b.arSections[f].ID]){a.CAL.arSect[b.arSections[f].ID].pCh.checked=!!b.arSections[f].SUPERPOSED}}}else{b.oSupDialog.CAL.DOM.NotFoundNotice.style.visibility="visible";setTimeout(function(){b.oSupDialog.CAL.DOM.NotFoundNotice.style.visibility="hidden"},4000)}return true}return false}})}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){a.CAL.DOM.SelectUserPopup.close()}}})]})}a.CAL.curTrackedUsers={};a.CAL.DOM.SelectUserPopup.show();BX.PreventDefault(c)};this.oSupDialog=a};JCEC.prototype.SPD_BuildSections=function(n,f){var l=this,a=this.oSupDialog,m,e,j,h,g,d,k,o,c,b;BX.cleanNode(a.CAL.DOM.UserCntInner);BX.cleanNode(a.CAL.DOM.GroupCntInner);BX.cleanNode(a.CAL.DOM.CommonCnt);if(!this.arSPSections){this.arSPSections=[]}for(h in n){g=n[h];if(!g.ID){return}if(g.CAL_TYPE=="user"){d=a.CAL.DOM.UserCntInner}else{if(g.CAL_TYPE=="group"){d=a.CAL.DOM.GroupCntInner;a.CAL.DOM.GroupCnt.style.display="block"}else{d=a.CAL.DOM.CommonCnt;a.CAL.DOM.CommonCnt.style.display="block"}}o=g.CAL_TYPE+g.OWNER_ID;if(!a.CAL.DOM.arCat[o]||!BX.isNodeInDom(a.CAL.DOM.arCat[o].pCat)){if(g.CAL_TYPE=="user"||g.CAL_TYPE=="group"){c=g.OWNER_NAME}else{c=g.TYPE_NAME}m=d.appendChild(BX.create("DIV",{props:{className:"bxc-spd-cat"}}));e=m.appendChild(BX.create("DIV",{props:{className:"bxc-spd-cat-title"},html:'<span class="bxc-spd-cat-plus"></span><span class="bxc-spd-cat-title-inner">'+BX.util.htmlspecialchars(c)+"</span>"}));pCatSections=m.appendChild(BX.create("DIV",{props:{className:"bxc-spd-cat-sections"}}));e.onclick=function(){BX.toggleClass(this.parentNode,"bxc-spd-cat-collapsed")};if(g.CAL_TYPE=="user"&&g.OWNER_ID!=this.userId){e.appendChild(BX.create("A",{props:{href:"javascript:void(0);",className:"bxc-spd-del-cat",title:EC_MESS.DeleteDynSPGroupTitle},text:EC_MESS.DeleteDynSPGroup,events:{click:function(i){l.SPD_DelTrackingUser(this.getAttribute("bx-data"),this);return BX.PreventDefault(i)}}})).setAttribute("bx-data",g.OWNER_ID)}a.CAL.DOM.arCat[o]={pCat:m,pTitle:e,pSections:pCatSections}}b=this.id+"spd-sect"+g.ID;k=BX.create("DIV",{props:{className:"bxc-spd-sect-cont"}});j=k.appendChild(BX.create("SPAN",{props:{className:"bxc-spd-sect-check"}})).appendChild(BX.create("INPUT",{props:{type:"checkbox",id:b}}));pLabel=k.appendChild(BX.create("SPAN",{props:{className:"bxc-spd-sect-label"},html:'<label for="'+b+'"><span>'+BX.util.htmlspecialchars(g.NAME)+"</span></label>"}));a.CAL.DOM.arCat[o].pSections.appendChild(k);a.CAL.arSect[g.ID]={pCh:j,pItem:k,oSect:g};if(f){var p=false;for(h in this.arSPSections){if(this.arSPSections.hasOwnProperty(h)){if(this.arSPSections[h].CAL_TYPE==g.CAL_TYPE&&this.arSPSections[h].OWNER_ID==g.OWNER_ID){p=true;break}}}if(!p){this.arSPSections.push(g)}}}};JCEC.prototype.SPD_SaveSuperposed=function(){var a,b;for(a in this.oSupDialog.CAL.arSect){b=this.oSupDialog.CAL.arSect[a];if(b.pCh.checked){if(this.arSectionsInd[a]&&this.arSections[this.arSectionsInd[a]]){this.arSections[this.arSectionsInd[a]].SUPERPOSED=true}else{if(!this.arSectionsInd[a]){b.oSect.SUPERPOSED=true;this.arSections.push(b.oSect);this.arSectionsInd[b.oSect.ID]=this.arSections.length-1}}}else{if(this.arSectionsInd[a]&&this.arSections[this.arSectionsInd[a]]){this.arSections[this.arSectionsInd[a]].SUPERPOSED=false}}}this.SetSuperposed()};JCEC.prototype.SPD_DelTrackingUser=function(c,b){var e=BX.findParent(b,{className:"bxc-spd-cat"});if(e){e.parentNode.removeChild(e)}var a,d;for(a in this.oSupDialog.CAL.arSect){if(this.oSupDialog.CAL.arSect.hasOwnProperty(a)){d=this.oSupDialog.CAL.arSect[a];if(d&&d.oSect&&d.oSect.CAL_TYPE=="user"&&d.oSect.OWNER_ID==c){d.pCh.checked=false}}}var f=[];for(a in this.arSPSections){if(this.arSPSections.hasOwnProperty(a)){d=this.arSPSections[a];if(d.CAL_TYPE!="user"||d.OWNER_ID!=c){f.push(d)}}}this.arSPSections=f;this.SPD_SaveSuperposed();this.Request({postData:this.GetReqData("spcal_del_user",{userId:parseInt(c)}),handler:function(g){if(g){return true}}})};JCEC.prototype.ShowSuperposeDialog=function(){var c=this;if(!this.arSPSections){return this.Request({getData:c.GetReqData("get_superposed"),handler:function(d){if(d){c.arSPSections=d.sections||[];return c.ShowSuperposeDialog()}return false}})}if(!this.oSupDialog){this.CreateSuperposeDialog()}if(this.arSPSections){this.SPD_BuildSections(this.arSPSections,false)}var b=this.oSupDialog;b.show();for(var a=0;a<this.arSections.length;a++){if(this.arSections[a].ID&&b.CAL.arSect[this.arSections[a].ID]){b.CAL.arSect[this.arSections[a].ID].pCh.checked=!!this.arSections[a].SUPERPOSED}}};JCEC.prototype.CloseSuperposeDialog=function(a){this.arSPSections=null;if(a===true){this.oSupDialog.close()}};JCEC.prototype.BuildSectionSelect=function(a,f){a.options.length=0;var c,b,e,d;a.parentNode.className="bxec-cal-sel-cel";for(c=0;c<this.arSections.length;c++){e=this.arSections[c];if(e.PERM.edit_section&&this.IsCurrentViewSect(e)&&e.ACTIVE!=="N"){d=f==e.ID;b=new Option(e.NAME,e.ID,d,d);a.options.add(b);if(!BX.browser.IsIE()){b.style.backgroundColor=e.COLOR}}}if(a.options.length<=0){a.parentNode.className="bxec-cal-sel-cel-empty"}};JCEC.prototype.IsCurrentViewSect=function(a){return a.CAL_TYPE==this.type&&a.OWNER_ID==this.ownerId};JCEC.prototype.CreateSetDialog=function(){var b=this;var a=new BX.PopupWindow("BXCSettings"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:this.PERM.access?EC_MESS.Settings:EC_MESS.UserSettings,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-tabed bxc-popup-window",contentColor:"white",contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:EC_MESS.Save,className:"popup-window-button-accept",events:{click:function(){b.CloseSetDialog(true);b.SaveSettings()}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){b.CloseSetDialog(true)}}})],content:BX("bxec_uset_"+this.id)});BX.addCustomEvent(a,"onPopupClose",BX.proxy(this.CloseSetDialog,this));a.CAL={inPersonal:this.type=="user"&&this.ownerId==this.userId,DOM:{pTabs:BX(this.id+"_set_tabs"),ShowMuted:BX(this.id+"_show_muted"),denyBusyInvitation:BX(this.id+"_deny_busy_invitation")}};if(a.CAL.inPersonal){a.CAL.DOM.SectSelect=BX(this.id+"_set_sect_sel");a.CAL.DOM.Blink=BX(this.id+"_uset_blink");a.CAL.DOM.ShowDeclined=BX(this.id+"_show_declined");a.CAL.DOM.TimezoneSelect=BX(this.id+"_set_tz_sel")}if(this.PERM.access){a.CAL.Access=new ECCalendarAccess({bind:"calendar_type",GetAccessName:BX.proxy(this.GetAccessName,this),pCont:BX(this.id+"type-access-values-cont"),pLink:BX(this.id+"type-access-link")});a.CAL.DOM.WorkTimeStart=BX(this.id+"work_time_start");a.CAL.DOM.WorkTimeEnd=BX(this.id+"work_time_end");a.CAL.DOM.WeekHolidays=BX(this.id+"week_holidays");a.CAL.DOM.YearHolidays=BX(this.id+"year_holidays");a.CAL.DOM.YearWorkdays=BX(this.id+"year_workdays");a.CAL.DOM.WeekStart=BX(this.id+"week_start")}if(this.bSuperpose){a.CAL.DOM.ManageSuperpose=BX(this.id+"-set-manage-sp");a.CAL.DOM.ManageSuperpose.onclick=function(){b.ShowSuperposeDialog()}}a.CAL.DOM.ManageCalDav=BX(this.id+"_manage_caldav");if(a.CAL.DOM.ManageCalDav){a.CAL.DOM.ManageCalDav.onclick=function(){b.ShowExternalDialog()}}a.CAL.DOM.UsetClearAll=BX(this.id+"_uset_clear");if(a.CAL.DOM.UsetClearAll){a.CAL.DOM.UsetClearAll.onclick=function(){if(confirm(EC_MESS.ClearUserSetConf)){b.CloseSetDialog(true);b.ClearPersonalSettings()}}}this.ChargePopupTabs(a,this.id+"set-tab-");if(!this.PERM.access&&a.CAL.DOM.pTabs){a.CAL.DOM.pTabs.style.display="none"}this.oSetDialog=a};JCEC.prototype.ShowSetDialog=function(f){if(!this.oSetDialog){this.CreateSetDialog()}var e=this.oSetDialog;e.show();if(!f||typeof f!="object"){f={}}this.SetPopupTab(f.tabId||0,e);if(e.CAL.inPersonal){e.CAL.DOM.SectSelect.options.length=0;var b,a,c,d=!this.userSettings.meetSection;e.CAL.DOM.SectSelect.options.add(new Option(" - "+EC_MESS.FirstInList+" - ",0,d,d));for(b=0;b<this.arSections.length;b++){c=this.arSections[b];if(c.CAL_TYPE=="user"&&c.OWNER_ID==this.userId&&c.ACTIVE!=="N"){d=this.userSettings.meetSection==c.ID;a=new Option(c.NAME,c.ID,d,d);a.style.backgroundColor=c.COLOR;e.CAL.DOM.SectSelect.options.add(a)}}e.CAL.DOM.Blink.checked=!!this.userSettings.blink;e.CAL.DOM.ShowDeclined.checked=!!this.userSettings.showDeclined}if(e.CAL.DOM.TimezoneSelect){e.CAL.DOM.TimezoneSelect.value=this.arConfig.userTimezoneName||""}e.CAL.DOM.ShowMuted.checked=!!this.userSettings.showMuted;if(e.CAL.DOM.denyBusyInvitation){e.CAL.DOM.denyBusyInvitation.checked=!!this.userSettings.denyBusyInvitation}if(this.PERM.access){e.CAL.Access.SetSelected(this.typeAccess);e.CAL.DOM.WorkTimeStart.value=this.settings.work_time_start;e.CAL.DOM.WorkTimeEnd.value=this.settings.work_time_end;for(b=0;b<e.CAL.DOM.WeekHolidays.options.length;b++){e.CAL.DOM.WeekHolidays.options[b].selected=BX.util.in_array(e.CAL.DOM.WeekHolidays.options[b].value,this.settings.week_holidays)}e.CAL.DOM.YearHolidays.value=this.settings.year_holidays;e.CAL.DOM.YearWorkdays.value=this.settings.year_workdays;e.CAL.DOM.WeekStart.value=this.settings.week_start}};JCEC.prototype.CloseSetDialog=function(a){if(a===true){this.oSetDialog.close()}};JCEC.prototype.CreateExternalDialog=function(){var b=this;var a=new BX.PopupWindow("BXCExternalDialog"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-95,offsetLeft:0,offsetTop:0,draggable:true,titleBar:EC_MESS.CalDavDialogTitle,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window bxc-popup-window-white",contentColor:"white",contentNoPaddings:true,buttons:[new BX.PopupWindowButton({text:EC_MESS.AddCalDav,events:{click:function(){var c=a.CAL.arConnections.length;a.CAL.arConnections.push({bNew:true,name:EC_MESS.NewExCalendar,link:"",user_name:""});b.ExternalCalDialogDisplayConnection(a.CAL.arConnections[c],c);b.ExternalCalDialogEditConnection(c)}}}),new BX.PopupWindowButton({text:EC_MESS.Save,className:"popup-window-button-accept",events:{click:function(){if(a.CAL.bLockClosing){return alert(EC_MESS.CalDavConWait)}if(a.CAL.curEditedConInd!==false&&a.CAL.arConnections[a.CAL.curEditedConInd]){b.ExternalCalDialogSaveConnectionData(a.CAL.curEditedConInd)}b.arConnections=a.CAL.arConnections;a.CAL.bLockClosing=true;b.SaveCalDavConnections(function(c){a.CAL.bLockClosing=false;if(c){b.CloseExternalDialog(true);window.location=window.location}},function(){a.CAL.bLockClosing=false})}}}),new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){b.CloseExternalDialog(true)}}})],content:BX("bxec_cdav_"+this.id)});BX.addCustomEvent(a,"onPopupClose",BX.proxy(this.CloseExternalDialog,this));a.CAL={DOM:{List:BX(this.id+"_bxec_dav_list"),EditConDiv:BX(this.id+"_bxec_dav_new"),EditName:BX(this.id+"_bxec_dav_name"),EditLink:BX(this.id+"_bxec_dav_link"),UserName:BX(this.id+"_bxec_dav_username"),Pass:BX(this.id+"_bxec_dav_password"),UserNameCont:BX(this.id+"_bxec_dav_username_cont"),PassCont:BX(this.id+"_bxec_dav_password_cont"),SectionsCont:BX(this.id+"_bxec_dav_sections_cont"),Sections:BX(this.id+"_bxec_dav_sections")}};this.oExternalDialog=a};JCEC.prototype.ShowExternalDialog=function(){if(!this.oExternalDialog){this.CreateExternalDialog()}var b=this.oExternalDialog,a;b.show();b.CAL.curEditedConInd=false;BX.cleanNode(b.CAL.DOM.List);b.CAL.arConnections=BX.clone(this.arConnections);for(a=0;a<this.arConnections.length;a++){this.ExternalCalDialogDisplayConnection(b.CAL.arConnections[a],a)}if(this.arConnections.length==0){a=b.CAL.arConnections.length;b.CAL.arConnections.push({bNew:true,name:EC_MESS.NewExCalendar,link:"",user_name:""});this.ExternalCalDialogDisplayConnection(b.CAL.arConnections[a],a);this.ExternalCalDialogEditConnection(a)}else{this.ExternalCalDialogEditConnection(0)}};JCEC.prototype.CloseExternalDialog=function(a){if(a===true){this.oExternalDialog.close()}};JCEC.prototype.ExternalCalDialogEditConnection=function(d){var f=this.oExternalDialog,a=f.CAL.arConnections[d];for(var e in f.CAL.arConnections){if(f.CAL.arConnections[e]&&e!=d&&BX.hasClass(f.CAL.arConnections[e].pConDiv,"bxec-dav-item-edited")){if(f.CAL.DOM.EditConDiv.parentNode==f.CAL.arConnections[e].pConDiv){this.ExternalCalDialogSaveConnectionData(e)}BX.removeClass(f.CAL.arConnections[e].pConDiv,"bxec-dav-item-edited")}}if(a.del||f.CAL.curEditedConInd===d){return}if(f.CAL.curEditedConInd!==false&&f.CAL.arConnections[f.CAL.curEditedConInd]){this.ExternalCalDialogSaveConnectionData(f.CAL.curEditedConInd);BX.removeClass(f.CAL.arConnections[f.CAL.curEditedConInd].pConDiv,"bxec-dav-item-edited")}if(a.account_type=="caldav_google_oauth"){f.CAL.DOM.UserNameCont.style.display="none";f.CAL.DOM.PassCont.style.display="none";f.CAL.DOM.SectionsCont.style.display="";f.CAL.DOM.EditName.disabled="disabled";f.CAL.DOM.EditLink.disabled="disabled"}else{f.CAL.DOM.EditName.disabled="";f.CAL.DOM.EditLink.disabled="";f.CAL.DOM.UserNameCont.style.display="";f.CAL.DOM.PassCont.style.display=""}f.CAL.curEditedConInd=d;f.CAL.DOM.EditName.value=a.name;f.CAL.DOM.EditLink.value=a.link;f.CAL.DOM.UserName.value=a.user_name;a.sections={};BX.cleanNode(f.CAL.DOM.Sections);var c,h,b,g;for(c=0;c<this.arSections.length;c++){if(this.arSections[c]&&this.arSections[c].CAL_DAV_CON==a.id){h=this.arSections[c].ID;b=f.CAL.DOM.Sections.appendChild(BX.create("DIV",{props:{className:"bxec-dav-sect"}}));a.sections[h]=b.appendChild(BX.create("SPAN",{props:{className:"bxec-dav-sect-check"}})).appendChild(BX.create("INPUT",{props:{type:"checkbox",id:h,checked:this.arSections[c].ACTIVE=="Y"}}));b.appendChild(BX.create("SPAN",{props:{className:"bxc-spd-sect-label"},html:'<label for="'+h+'"><span>'+BX.util.htmlspecialchars(this.arSections[c].NAME)+"</span></label>"}))}}if(a.account_type!=="caldav_google_oauth"){if(a.id>0){this.ExD_CheckPass()}else{f.CAL.DOM.Pass.value=""}setTimeout(function(){BX.focus(f.CAL.DOM.EditLink)},100);f.CAL.DOM.EditName.onkeyup=f.CAL.DOM.EditName.onfocus=f.CAL.DOM.EditName.onblur=function(){if(f.CAL.changeNameTimeout){clearTimeout(f.CAL.changeNameTimeout)}f.CAL.changeNameTimeout=setTimeout(function(){if(f.CAL.curEditedConInd!==false&&f.CAL.arConnections[f.CAL.curEditedConInd]){var i=f.CAL.DOM.EditName.value;if(i.length>25){i=i.substr(0,23)+"..."}f.CAL.arConnections[f.CAL.curEditedConInd].pText.innerHTML=BX.util.htmlspecialchars(i);f.CAL.arConnections[f.CAL.curEditedConInd].pText.title=f.CAL.DOM.EditName.value}},50)}}a.pConDiv.appendChild(f.CAL.DOM.EditConDiv);BX.addClass(a.pConDiv,"bxec-dav-item-edited")};JCEC.prototype.ExternalCalDialogDisplayConnection=function(b,j){var m=this,l=this.oExternalDialog,k=l.CAL.DOM.List.appendChild(BX.create("DIV",{props:{id:"bxec_dav_con_"+j,className:"bxec-dav-item"+(j%2==0?"":" bxec-dav-item-1")}})),s=k.appendChild(BX.create("DIV",{props:{className:"bxec-dav-item-name"}})),h=s.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"bxec-dav-item-status"}})),q=s.appendChild(BX.create("SPAN",{text:b.name})),e=s.appendChild(BX.create("SPAN",{text:""})),r=s.appendChild(BX.create("A",{props:{href:"javascript: void(0);",className:"bxec-dav-edit"},text:EC_MESS.CalDavEdit})),c=s.appendChild(BX.create("A",{props:{href:"javascript: void(0);",className:"bxec-dav-col"},text:EC_MESS.CalDavCollapse})),g=s.appendChild(BX.create("A",{props:{href:"javascript: void(0);",className:"bxec-dav-del"},text:EC_MESS.CalDavDel})),p=s.appendChild(BX.create("A",{props:{href:"javascript: void(0);",className:"bxec-dav-rest"},text:EC_MESS.CalDavRestore})),n=s.appendChild(BX.create("DIV",{props:{className:"bxec-dav-del-cal"},children:[BX.create("LABEL",{props:{htmlFor:"bxec_dav_con_del_cal_"+j},text:EC_MESS.DelConCalendars})]})),a=n.appendChild(BX.create("INPUT",{props:{type:"checkbox",id:"bxec_dav_con_del_cal_"+j,checked:true}}));if(b.id>0){var f="bxec-dav-item-status",t;if(b.last_result.indexOf("[200]")>=0){f+=" bxec-dav-ok";t=EC_MESS.SyncOk+". "+EC_MESS.SyncDate+": "+b.sync_date}else{f+=" bxec-dav-error";t=EC_MESS.SyncError+": "+b.last_result+". "+EC_MESS.SyncDate+": "+b.sync_date}h.className=f;h.title=t;var o,d=0;for(o=0;o<this.arSections.length;o++){if(this.arSections[o]&&this.arSections[o].CAL_DAV_CON==b.id){d++}}e.innerHTML=" ("+d+")";l.CAL.DOM.SectionsCont.style.display=""}else{l.CAL.DOM.SectionsCont.style.display="none"}k.onmouseover=function(){BX.addClass(this,"bxec-dav-item-over")};k.onmouseout=function(){BX.removeClass(this,"bxec-dav-item-over")};k.onclick=function(){j=parseInt(this.id.substr("bxec_dav_con_".length));m.ExternalCalDialogEditConnection(j)};c.onclick=function(u){var i=parseInt(this.parentNode.parentNode.id.substr("bxec_dav_con_".length));if(l.CAL.arConnections[i]){m.ExternalCalDialogSaveConnectionData(i);BX.removeClass(l.CAL.arConnections[i].pConDiv,"bxec-dav-item-edited");m.oExternalDialog.curEditedConInd=false}return BX.PreventDefault(u)};g.onclick=function(u){var i=parseInt(this.parentNode.parentNode.id.substr("bxec_dav_con_".length));if(l.CAL.arConnections[i]){l.CAL.arConnections[i].del=true;BX.removeClass(l.CAL.arConnections[i].pConDiv,"bxec-dav-item-edited");BX.addClass(l.CAL.arConnections[i].pConDiv,"bxec-dav-item-deleted");m.ExternalCalDialogSaveConnectionData(i);m.oExternalDialog.curEditedConInd=false}return BX.PreventDefault(u)};p.onclick=function(u){var i=parseInt(this.parentNode.parentNode.id.substr("bxec_dav_con_".length));if(l.CAL.arConnections[i]){l.CAL.arConnections[i].del=false;BX.removeClass(l.CAL.arConnections[i].pConDiv,"bxec-dav-item-deleted")}return BX.PreventDefault(u)};r.onclick=function(u){var i=parseInt(this.parentNode.parentNode.id.substr("bxec_dav_con_".length));m.ExternalCalDialogEditConnection(i);return BX.PreventDefault(u)};b.pConDiv=k;b.pText=q;b.pDelCalendars=a};JCEC.prototype.ExternalCalDialogSaveConnectionData=function(b){var c=this.oExternalDialog,a=c.CAL.arConnections[b];a.name=c.CAL.DOM.EditName.value;a.link=c.CAL.DOM.EditLink.value;a.user_name=c.CAL.DOM.UserName.value;a.pass="bxec_not_modify_pass";if(c.CAL.DOM.Pass.type.toLowerCase()=="password"&&c.CAL.DOM.Pass.title!=EC_MESS.CalDavNoChange){a.pass=c.CAL.DOM.Pass.value}};JCEC.prototype.ExD_CheckPass=function(){var a=this.oExternalDialog;if(!BX.browser.IsIE()){a.CAL.DOM.Pass.type="text";a.CAL.DOM.Pass.value=EC_MESS.CalDavNoChange}else{a.CAL.DOM.Pass.value=""}a.CAL.DOM.Pass.title=EC_MESS.CalDavNoChange;a.CAL.DOM.Pass.className="bxec-dav-no-change";a.CAL.DOM.Pass.onfocus=a.CAL.DOM.Pass.onmousedown=function(){if(!BX.browser.IsIE()){this.type="password"}this.value="";this.title="";this.className="";this.onfocus=this.onmousedown=null;BX.focus(this)}};JCEC.prototype.CreateMobileSyncDialog=function(){var b=this;var a=new BX.PopupWindow("BXCMobileHelp"+this.id,null,{overlay:{opacity:10},autoHide:false,closeByEsc:true,zIndex:-100,offsetLeft:0,offsetTop:0,draggable:true,titleBar:" ",closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButton({text:EC_MESS.Close,className:"popup-window-button-accept",events:{click:function(){b.CloseMobileSyncDialog(true)}}})],content:BX("bxec_mobile_"+this.id)});BX.addCustomEvent(a,"onPopupClose",BX.proxy(this.CloseMobileSyncDialog,this));a.CAL={DOM:{title:a.titleBar.firstChild,iPhoneSyncInfo:BX("bxec-sync-iphone-"+this.id),macosxSyncInfo:BX("bxec-sync-mac-"+this.id),androidSyncInfo:BX("bxec-sync-android-"+this.id)}};this.oMobileDialog=a};JCEC.prototype.ShowMobileSyncDialog=function(d,c){c="all";if(!this.oMobileDialog){this.CreateMobileSyncDialog()}var e=this.oMobileDialog;e.show();e.CAL.DOM.iPhoneSyncInfo.style.display="none";e.CAL.DOM.macosxSyncInfo.style.display="none";e.CAL.DOM.androidSyncInfo.style.display="none";var b=[],a;if(d=="iphone"){e.CAL.DOM.title.innerHTML=EC_MESS.SyncTitleIphone;e.CAL.DOM.iPhoneSyncInfo.style.display="block";b=b.concat(BX.findChildren(e.CAL.DOM.iPhoneSyncInfo,{tagName:"SPAN",className:"bxec-link"},true));for(a=0;a<b.length;a++){if(b[a]&&b[a].nodeName){b[a].innerHTML=this.arConfig.caldav_link_all}}}else{if(d=="macosx"){e.CAL.DOM.title.innerHTML=EC_MESS.SyncTitleMacOSX;e.CAL.DOM.macosxSyncInfo.style.display="block";b=BX.findChildren(e.CAL.DOM.macosxSyncInfo,{tagName:"SPAN",className:"bxec-link"},true);for(a=0;a<b.length;a++){if(b[a]&&b[a].nodeName){b[a].innerHTML=this.arConfig.caldav_link_all.replace(/^https?:\/\//ig,"")}}}else{if(d=="android"){e.CAL.DOM.title.innerHTML=EC_MESS.SyncTitleAndroid;e.CAL.DOM.androidSyncInfo.style.display="block"}}}e.CAL.calendarId=c;if(d=="iphone"||d=="macosx"){b=b.concat(BX.findChildren(e.CAL.DOM.iPhoneAllCont,{tagName:"SPAN",className:"bxec-link"},true));for(a=0;a<b.length;a++){if(b[a]&&b[a].nodeName){b[a].innerHTML=this.arConfig.caldav_link_all}}}};JCEC.prototype.CloseMobileSyncDialog=function(a){if(a===true){this.oMobileDialog.close()}};JCEC.prototype.ChargePopupTabs=function(d,c){if(!d||!d.CAL||!d.CAL.DOM||!d.CAL.DOM.pTabs){return}d.CAL.Tabs=[];d.CAL.activeTab=false;var b,e=this;for(var a in d.CAL.DOM.pTabs.childNodes){b=d.CAL.DOM.pTabs.childNodes[a];if(b.nodeType=="1"&&b.className&&b.className.indexOf("popup-window-tab")!=-1){d.CAL.Tabs.push({tab:b,cont:BX(b.id+"-cont"),showed:b.style.display!="none"});b.onclick=function(){e.SetPopupTab(parseInt(this.id.substr(c.length)),d)}}}};JCEC.prototype.ShowPopupTab=function(a,b){a.tab.style.display=b?"":"none";a.cont.style.display=b?"":"none";a.showed=!!b};JCEC.prototype.SetPopupTab=function(c,e){var d,b,a=e.CAL.Tabs;if(isNaN(parseInt(c))||parseInt(c)!==c){for(d in a){if(a.hasOwnProperty(d)&&a[d].tab.id==c){c=d;break}}}c=parseInt(c);if(a&&e.CAL.activeTab!==c&&!a[c].bDisabled){for(d in a){if(a.hasOwnProperty(d)){b=a[d];if(!b||!b.cont){continue}if(d==c){BX.addClass(b.cont,"popup-window-tab-content-selected");BX.addClass(b.tab,"popup-window-tab-selected")}else{BX.removeClass(b.cont,"popup-window-tab-content-selected");BX.removeClass(b.tab,"popup-window-tab-selected")}BX.onCustomEvent(b,"OnSetTab",[b,(d==c)])}}e.CAL.activeTab=c;this.AdjustOverlay(e)}};JCEC.prototype.InitColorDialogControl=function(c,b){var h=this,g=this.id+"-"+c,e=BX(g+"-color-cont"),d=BX(g+"-color-inp"),f=BX(g+"-text-color-inp");function a(j,l,i){if(!l||(i&&(l=="#FFFFFF"||l=="#000000"))){l=h.ColorIsDark(j)?"#FFFFFF":"#000000"}try{d.value=j;d.style.backgroundColor=j;d.style.color=l}catch(k){j=this.arConfig.arCalColors[0];d.style.color="#000000"}if(b&&typeof b=="function"){b(j,l)}}e.onclick=function(k){if(!k){k=window.event}var i=k.target||k.srcElement;if(i&&i.nodeName&&i.nodeName.toLowerCase()=="a"){var j=parseInt(i.id.substr((g+"-color-").length),10);if(h.arConfig.arCalColors[j]){a(h.arConfig.arCalColors[j])}}};d.onblur=d.onkeyup=function(){a(this.value)};d.onclick=function(){h.ColorPicker.Open({pWnd:this,key:c,id:g+"-bg",onSelect:function(i){a(i,d.style.color,true)}})};f.onclick=function(){h.ColorPicker.Open({pWnd:this,key:c,id:g+"-text",onSelect:function(i){a(d.value,i,false)}})};return{Set:a}};JCEC.prototype.ShowConfirmDeleteDialog=function(a){var d=this;var c=this.oConfirmDeleteDialog;if(c){c.destroy()}var b=BX.create("DIV");c=new BX.PopupWindow("BXCConfirmDelete"+this.id,null,{overlay:{opacity:10},autoHide:true,closeByEsc:true,zIndex:0,offsetLeft:0,offsetTop:0,draggable:true,bindOnResize:false,titleBar:EC_MESS.EC_DEL_REC_EVENT,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){if(d.oConfirmDeleteDialog){d.oConfirmDeleteDialog.close()}}}})],content:b,events:{}});c.CAL={butThis:new BX.PopupWindowButton({text:EC_MESS.EC_REC_EV_ONLY_THIS_EVENT,events:{click:function(){if(d.Event.IsRecursive(a)){d.Event.ExcludeRecursionDate(a,a.DATE_FROM)}else{if(a.RECURRENCE_ID){d.Event.Delete(a,true,{recursionMode:"this"})}}if(d.oConfirmDeleteDialog){d.oConfirmDeleteDialog.close()}}}}),butNext:new BX.PopupWindowButton({text:EC_MESS.EC_REC_EV_NEXT,events:{click:function(){if(d.Event.IsRecursive(a)&&a.DT_FROM_TS===Math.floor(d.ParseDate(a["~DATE_FROM"]).getTime()/1000)*1000&&!a.RECURRENCE_ID){d.Event.DeleteAllReccurent(a,true)}else{d.Event.CutOffRecursiveEvent(a,a.DATE_FROM)}if(d.oConfirmDeleteDialog){d.oConfirmDeleteDialog.close()}if(d.oEditEventDialog){d.oEditEventDialog.close()}}}}),butAll:new BX.PopupWindowButton({text:EC_MESS.EC_REC_EV_ALL,events:{click:function(){d.Event.DeleteAllReccurent(a,true);if(d.oConfirmDeleteDialog){d.oConfirmDeleteDialog.close()}if(d.oEditEventDialog){d.oEditEventDialog.close()}}}}),DOM:{content:b}};b.appendChild(c.CAL.butThis.buttonNode);b.appendChild(c.CAL.butNext.buttonNode);b.appendChild(c.CAL.butAll.buttonNode);this.oConfirmDeleteDialog=c;c.show()};JCEC.prototype.ShowConfirmEditDialog=function(b,d){var e=this;var c=this.oConfirmEditDialog;if(c){c.destroy()}var a=BX.create("DIV");c=new BX.PopupWindow("BXCConfirmEdit"+this.id,null,{overlay:{opacity:10},autoHide:true,closeByEsc:true,zIndex:0,offsetLeft:0,offsetTop:0,draggable:true,bindOnResize:false,titleBar:EC_MESS.EC_EDIT_REC_EVENT,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){if(e.oConfirmEditDialog){e.oConfirmEditDialog.close()}}}})],content:a,events:{}});c.CAL={butThis:new BX.PopupWindowButton({text:EC_MESS.EC_REC_EV_ONLY_THIS_EVENT,events:{click:function(){d.params.recurentEventEditMode="this";e.oEditEventDialog.oController.SaveForm(d.params,true);if(e.oConfirmEditDialog){e.oConfirmEditDialog.close()}if(e.oEditEventDialog){e.oEditEventDialog.close()}}}}),butNext:new BX.PopupWindowButton({text:EC_MESS.EC_REC_EV_NEXT,events:{click:function(){d.params.recurentEventEditMode="next";if(e.oEditEventDialog.oController.Reinvite&&c.CAL.DOM.reiviteInp){e.oEditEventDialog.oController.Reinvite.checked=c.CAL.DOM.reiviteInp.checked}e.oEditEventDialog.oController.SaveForm(d.params,true);if(e.oConfirmEditDialog){e.oConfirmEditDialog.close()}if(e.oEditEventDialog){e.oEditEventDialog.close()}}}}),butAll:new BX.PopupWindowButton({text:EC_MESS.EC_REC_EV_ALL,events:{click:function(){d.params.recurentEventEditMode="all";e.oEditEventDialog.oController.SaveForm(d.params,true);if(e.oConfirmEditDialog){e.oConfirmEditDialog.close()}if(e.oEditEventDialog){e.oEditEventDialog.close()}}}}),DOM:{content:a}};a.appendChild(c.CAL.butThis.buttonNode);a.appendChild(c.CAL.butNext.buttonNode);a.appendChild(c.CAL.butAll.buttonNode);if(b.IS_MEETING&&b.MEETING){c.CAL.DOM.reiviteCont=a.appendChild(BX.create("DIV",{props:{className:"bxec-row-reinvite"}}));c.CAL.DOM.reiviteInp=c.CAL.DOM.reiviteCont.appendChild(BX.create("INPUT",{props:{type:"checkbox",value:"Y",name:"confirm_meeting_reinvite",checked:this.oEditEventDialog.oController.Reinvite.checked,id:"reinvite-inp"+this.id}}));c.CAL.DOM.reiviteCont.appendChild(BX.create("LABEL",{attrs:{"for":"reinvite-inp"+this.id},text:EC_MESS.EC_REINVITE}))}this.oConfirmEditDialog=c;c.show()};JCEC.prototype.ShowConfirmDeclineDialog=function(b,d){var e=this;var c=this.oConfirmDeclineDialog;if(c){c.destroy()}var a=BX.create("DIV");c=new BX.PopupWindow("BXCConfirmDecline"+this.id,null,{overlay:{opacity:10},autoHide:true,closeByEsc:true,zIndex:0,offsetLeft:0,offsetTop:0,draggable:true,bindOnResize:false,titleBar:EC_MESS.EC_DECLINE_REC_EVENT,closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButtonLink({text:EC_MESS.Close,className:"popup-window-button-link-cancel",events:{click:function(){if(e.oConfirmDeclineDialog){e.oConfirmDeclineDialog.close()}}}})],content:a,events:{}});c.CAL={butThis:new BX.PopupWindowButton({text:EC_MESS.EC_D_REC_EV_ONLY_THIS_EVENT,events:{click:function(){e.Event.SetMeetingStatus(false,{confirmed:true,reccurentMode:"this",currentDateFrom:e.oViewEventDialog.CAL.oEvent.DATE_FROM});if(e.oConfirmDeclineDialog){e.oConfirmDeclineDialog.close()}if(e.oViewEventDialog){e.oViewEventDialog.close()}}}}),butNext:new BX.PopupWindowButton({text:EC_MESS.EC_D_REC_EV_NEXT,events:{click:function(){e.Event.SetMeetingStatus(false,{confirmed:true,reccurentMode:"next",currentDateFrom:e.oViewEventDialog.CAL.oEvent.DATE_FROM});if(e.oConfirmDeclineDialog){e.oConfirmDeclineDialog.close()}if(e.oViewEventDialog){e.oViewEventDialog.close()}}}}),butAll:new BX.PopupWindowButton({text:EC_MESS.EC_D_REC_EV_ALL,events:{click:function(){e.Event.SetMeetingStatus(false,{confirmed:true,reccurentMode:"all",currentDateFrom:e.oViewEventDialog.CAL.oEvent.DATE_FROM});if(e.oConfirmDeclineDialog){e.oConfirmDeclineDialog.close()}if(e.oViewEventDialog){e.oViewEventDialog.close()}}}}),DOM:{content:a}};a.appendChild(c.CAL.butThis.buttonNode);a.appendChild(c.CAL.butNext.buttonNode);a.appendChild(c.CAL.butAll.buttonNode);this.oConfirmDeclineDialog=c;c.show()};