(function(){BX.namespace("BX.Call");if(BX.Call.VideoStrategy){return}var a={AllowAll:"AllowAll",AllowNone:"AllowNone",OnlySpeaker:"OnlySpeaker",CurrentlyTalking:"CurrentlyTalking"};var c=20;BX.Call.VideoStrategy=function(d){this.call=d.call;this.callView=d.callView;this.strategyType=d.strategyType||a.AllowAll;this.onCallUserVoiceStartedHandler=this.onCallUserVoiceStarted.bind(this);this.onCallUserVoiceStoppedHandler=this.onCallUserVoiceStopped.bind(this);this.onCallViewSetCentralUserHandler=this.onCallViewSetCentralUser.bind(this);this.onCallViewLayoutChangeHandler=this.onCallViewLayoutChange.bind(this);this.users={};this.init()};BX.Call.VideoStrategy.prototype.init=function(){if(this.strategyType===BX.Call.VideoStrategy.AllowAll){this.call.allowVideoFrom(BX.Call.UserMnemonic.all)}else{if(this.strategyType===BX.Call.VideoStrategy.AllowNone){this.call.allowVideoFrom(BX.Call.UserMnemonic.none)}}this.bindEvents()};BX.Call.VideoStrategy.prototype.bindEvents=function(){this.call.addEventListener(BX.Call.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.addEventListener(BX.Call.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler);this.callView.subscribe(BX.Call.View.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.subscribe(BX.Call.View.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)};BX.Call.VideoStrategy.prototype.removeEvents=function(){if(this.call){this.call.removeEventListener(BX.Call.Event.onUserVoiceStarted,this.onCallUserVoiceStartedHandler);this.call.removeEventListener(BX.Call.Event.onUserVoiceStopped,this.onCallUserVoiceStoppedHandler)}if(this.callView){this.callView.unsubscribe(BX.Call.View.Event.onSetCentralUser,this.onCallViewSetCentralUserHandler);this.callView.unsubscribe(BX.Call.View.Event.onLayoutChange,this.onCallViewLayoutChangeHandler)}};BX.Call.VideoStrategy.prototype.setType=function(d){if(d==this.strategyType){return}this.strategyType=d;this.applyVideoLimit()};BX.Call.VideoStrategy.prototype.applyVideoLimit=function(){if(this.strategyType===a.AllowAll){this.call.allowVideoFrom(BX.Call.UserMnemonic.all)}else{if(this.strategyType===a.AllowNone){this.call.allowVideoFrom(BX.Call.UserMnemonic.none)}else{if(this.strategyType===a.CurrentlyTalking){var d=this.getActiveUsers();console.log("talking users",d);if(d.length===0){this.call.allowVideoFrom(BX.Call.UserMnemonic.none)}else{this.call.allowVideoFrom(this.getActiveUsers())}}}}};BX.Call.VideoStrategy.prototype.getActiveUsers=function(){var d=[];for(var f in this.users){var e=this.users[f];if(e.active){d.push(e.id)}}return d};BX.Call.VideoStrategy.prototype.onUserActiveChanged=function(){if(this.strategyType==a.CurrentlyTalking){this.applyVideoLimit()}};BX.Call.VideoStrategy.prototype.onCallUserVoiceStarted=function(e){var d=e.userId;if(!this.users[d]){this.users[d]=new b({id:d,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[d].setTalking(true)};BX.Call.VideoStrategy.prototype.onCallUserVoiceStopped=function(e){var d=e.userId;if(!this.users[d]){this.users[d]=new b({id:d,onActiveChanged:this.onUserActiveChanged.bind(this)})}this.users[d].setTalking(false)};BX.Call.VideoStrategy.prototype.onCallViewSetCentralUser=function(e){var d=e.data.userId;if(this.strategyType===a.OnlySpeaker){console.log("requesting video only from "+d);this.call.allowVideoFrom([d])}};BX.Call.VideoStrategy.prototype.onCallViewLayoutChange=function(d){};BX.Call.VideoStrategy.prototype.destroy=function(){this.removeEvents();this.call=null;this.callView=null;for(var d in this.users){if(this.users.hasOwnProperty(d)){this.users[d].destroy()}}this.users={}};var b=function(d){this.id=d.id;this.talking=false;this.sharing=false;this.active=false;this.callbacks={onActiveChanged:BX.type.isFunction(d.onActiveChanged)?d.onActiveChanged:BX.DoNothing};this.turnOffVideoTimeout=null};b.prototype.setTalking=function(d){if(this.talking==d){return}this.talking=d;if(this.talking){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}};b.prototype.setSharing=function(d){if(this.sharing==d){return}this.sharing=d;if(this.sharing){this.cancelTurnOffVideo();this.updateActive()}else{this.scheduleTurnOffVideo()}};b.prototype.updateActive=function(){var d=!!(this.sharing||this.talking||this.turnOffVideoTimeout);if(d!=this.active){this.active=d}this.callbacks.onActiveChanged({userId:this.id,active:this.active})};b.prototype.scheduleTurnOffVideo=function(){clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=setTimeout(function(){this.turnOffVideoTimeout=null;this.updateActive()}.bind(this),c*1000)};b.prototype.cancelTurnOffVideo=function(){clearTimeout(this.turnOffVideoTimeout);this.turnOffVideoTimeout=null};b.prototype.destroy=function(){this.callbacks.onActiveChanged=BX.DoNothing;clearTimeout(this.turnOffVideoTimeout)};BX.Call.VideoStrategy.Type=a})();