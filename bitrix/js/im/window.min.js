(function(b){if(b.BX.MessengerWindow){return}var c=b.BX;var a=function(){this.popupConfirm=null;this.BXIM={};this.popup=null;this.backgroundSelector=null;this.content=null;this.contentFullWindow=true;this.contentBodyWindow=false;this.contentMenu=null;this.contentAvatar=null;this.contentTab=null;this.contentTabContent=null;this.currentTab="";this.currentTabTarget="";this.lastTab="";this.lastTabTarget="";this.tabItems={};this.tabRedrawTimeout=null;this.userInfo={id:0,name:"",gender:"M",avatar:"",profile:""};this.inited=false;this.width=914;this.height=454;this.initWidth=914;this.initHeight=454;this.minWidth=515;this.minHeight=384};a.prototype.init=function(e){e=e||{};if(this.inited){return true}this.inited=true;this.BXIM=e.bxim||{};this.context=e.context||"DESKTOP";this.design=e.design||"DESKTOP";if(this.context=="FULLSCREEN"||this.context=="POPUP-FULLSCREEN"||this.context=="PAGE"||this.context=="DIALOG"||this.context=="LINES"){if(this.context=="FULLSCREEN"||this.context=="PAGE"||this.context=="POPUP-FULLSCREEN"){this.contentBodyWindow=true}this.popup=c("im-workarea-popup");this.popupBackground=this.popup;this.content=c("im-workarea-content");this.apps=c("im-workarea-apps");this.backgroundSelector=c("im-workarea-backgound-selector");if(!this.content){this.popup=c("workarea-popup");this.content=c("workarea-content")}if(this.popup){c.addClass(this.popup,"bx-im-fullscreen-closed");c.bind(this.popup,"click",c.delegate(this.closePopup,this))}else{this.popupBackground=c("im-workarea-popup-bg")}if(this.context=="PAGE"){var d=b.innerWidth-document.documentElement.clientWidth;c.onCustomEvent(b,"onMessengerWindowBodyOverflow",[this,d]);c.addClass(document.body,"bx-im-fullscreen-block-scroll")}if(this.backgroundSelector){c.bind(this.backgroundSelector.parentNode,"click",c.delegate(c.PreventDefault,this));c.bind(this.backgroundSelector,"change",c.delegate(function(g){this.backgroundChange();c.localStorage.set("imFullscreenBackground",this.backgroundSelector.value,3000000);return c.PreventDefault(g)},this));var f=c.localStorage.get("imFullscreenBackground");if(f!==null){this.backgroundSelector.value=f}this.backgroundChange()}if(!this.content){this.content=c.create("div",{attrs:{className:"bx-desktop"}});document.body.insertBefore(this.content,document.body.firstChild)}if(this.apps){c.bind(this.apps,"click",c.delegate(c.MessengerCommon.preventDefault,this))}c.bind(this.content,"click",c.delegate(c.MessengerCommon.preventDefault,this));if(!c.hasClass(this.content,"bx-desktop")){c.addClass(this.content,"bx-desktop")}if(this.context=="LINES"||this.context=="DIALOG"){this.contentFullWindow=false}else{if(this.context!="POPUP-FULLSCREEN"){if(this.content.offsetWidth<this.minWidth){c.style(this.content,"width",this.minWidth+"px")}}}}else{this.content=c.create("div");document.body.insertBefore(this.content,document.body.firstChild)}if(c.desktop&&c.desktop.apiReady&&!c.desktop.enableInVersion(29)){c.PULL.tryConnectSet(null,false);c.desktop.notSupported();c.desktop.apiReady=false;c.desktop.disableLogin=true;return false}if(c.browser.SupportLocalStorage()){c.addCustomEvent(b,"onLocalStorageSet",c.delegate(this.storageSet,this))}if(c.MessengerCommon.isDesktop()){c.MessengerWindow.addTab({id:"exit",title:c.message("BXD_LOGOUT"),order:1100,target:false,events:{open:c.delegate(function(){this.logout(false,"exit_tab")},this)}})}c.bind(b,"resize",c.delegate(function(){this.adjustSize()},this))};a.prototype.browse=function(d){if(c.MessengerCommon.isDesktop()){c.desktop.browse(d)}else{if(this.context=="POPUP-FULLSCREEN"){location.href=d}else{b.open(d,"_blank")}}};a.prototype.getCurrentUrl=function(){return document.location.protocol+"//"+document.location.hostname+(document.location.port==""?"":":"+document.location.port)};a.prototype.windowReload=function(){location.reload()};a.prototype.logout=function(d,f,e){if(typeof(BXDesktopSystem)=="undefined"||typeof(BXDesktopWindow)=="undefined"){location.href="/?logout=yes";return true}if(c.desktop&&c.desktop.apiReady){c.desktop.logout(d,f,e)}return true};a.prototype.adjustSize=function(g,f){if(this.context=="POPUP-FULLSCREEN"&&c.hasClass(this.popup,"bx-im-fullscreen-closed")){return false}var d=0;var j=0;var k=false;if(this.contentBodyWindow){if(!this.popupFullscreenSizeTop&&!this.popupFullscreenSizeBottom){var h=c.pos(c.MessengerWindow.content.parentNode);this.popupFullscreenSizeTop=h.top;this.popupFullscreenSizeBottom=b.innerHeight-h.top-h.height}j=Math.max(b.innerHeight-this.popupFullscreenSizeTop-this.popupFullscreenSizeBottom,this.initHeight);d=c.MessengerWindow.content.offsetWidth}else{if(this.contentFullWindow){d=b.innerWidth;j=b.innerHeight}else{try{c.style(document.body,"height",b.innerHeight+"px")}catch(i){setTimeout(function(){c.MessengerWindow.adjustSize(g,f)},500)}d=Math.max(this.content.offsetWidth,this.minWidth);j=Math.max(this.content.offsetHeight,this.minHeight)}}if(c.desktop&&c.desktop.apiReady&&(!g||!f)&&(j<this.minHeight||d<this.minWidth)){BXDesktopWindow.SetProperty("clientSize",{Width:this.width,Height:this.height});return false}if(this.context=="POPUP-FULLSCREEN"&&c.browser.IsMobile()){this.height=this.initHeight;this.width=this.initWidth}else{c.addClass(this.content,"bx-im-fullscreen-adaptive");this.width=g?g:d;this.height=f?f:j}c.style(this.contentMenu,"height",this.height+"px");c.style(this.contentTabContent,"height",this.height+"px");c.style(this.content,"max-width",b.innerWidth+"px");return true};a.prototype.openConfirm=function(f,e,d){if(this.popupConfirm!=null){this.popupConfirm.destroy()}if(typeof(f)=="object"){f='<div class="bx-desktop-confirm-title">'+f.title+"</div>"+f.message}d=d!==false;if(typeof(e)=="undefined"||typeof(e)=="object"&&e.length<=0){e=[new c.PopupWindowButton({text:c.message("BXD_CONFIRM_CLOSE"),className:"popup-window-button-decline",events:{click:function(g){this.popupWindow.close();c.PreventDefault(g)}}})]}this.popupConfirm=new c.PopupWindow("bx-desktop-confirm",null,{zIndex:200,autoHide:e===false,buttons:e,closeByEsc:e===false,overlay:d,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:c.delegate(function(){this.popupConfirm=null},this)},content:c.create("div",{props:{className:(e===false?" bx-desktop-confirm-without-buttons":"bx-desktop-confirm")},html:f})});this.popupConfirm.show();c.bind(this.popupConfirm.popupContainer,"click",c.PreventDefault);c.bind(this.popupConfirm.contentContainer,"click",c.PreventDefault);c.bind(this.popupConfirm.overlay.element,"click",c.PreventDefault);return true};a.prototype.addSeparator=function(d){d.type="separator";d.id="sep"+(+new Date());this.tabItems[d.id]=d;this.drawTabs()};a.prototype.addTab=function(d){if(!d||!d.id||!d.title){return false}if(!d.order){d.order=500}d.hide=d.hide?true:false;if(parseInt(d.badge)>0){d.badge=parseInt(d.badge)}else{d.badge=0}if(!d.initContent||!c.type.isDomNode(d.initContent)){d.initContent=null}if(!d.events){d.events={}}if(typeof(d.target)=="undefined"){d.target=d.id}if(!d.events.open){d.events.open=function(){}}if(!d.events.close){d.events.close=function(){}}if(!d.events.init){d.events.init=function(){}}d.type="item";this.tabItems[d.id]=d;this.drawTabs()};a.prototype.hideTab=function(d){if(!d||!this.tabItems[d]){return false}this.tabItems[d].hide=true;this.drawTabs()};a.prototype.showTab=function(d){if(!d||!this.tabItems[d]){return false}this.tabItems[d].hide=false;this.drawTabs()};a.prototype.existsTab=function(d){return this.tabItems[d]};a.prototype.drawTabs=function(f){if(!f){clearTimeout(this.tabRedrawTimeout);this.tabRedrawTimeout=setTimeout(c.delegate(function(){this.drawTabs(true)},this),100);return true}if(!this.contentTabContent){if(!this.drawAppearance()){return false}}this.contentTab.innerHTML="";var e=c.util.objectSort(this.tabItems,"order","asc");for(var d=0;d<e.length;d++){this.drawTab(e[d])}c.onCustomEvent(this,"OnDesktopTabsInit");if(this.currentTab==""){if(e[0].id=="exit"){if(typeof(e[1])!="undefined"){this.changeTab(e[1].id)}}else{this.changeTab(e[0].id)}}if(c.desktop&&c.desktop.apiReady){c.desktop.updateTabBadge()}return true};a.prototype.drawTab=function(e){if(e.type=="separator"){this.contentTab.appendChild(c.create("div",{attrs:{"data-id":e.id,id:"bx-desktop-sep-"+e.id},props:{className:"bx-desktop-separator"}}))}else{this.contentTab.appendChild(c.create("div",{attrs:{"data-id":e.id,id:"bx-desktop-tab-"+e.id,title:e.title},props:{className:"bx-desktop-tab bx-desktop-tab-"+e.id+(this.currentTab==e.id?" bx-desktop-tab-active":"")+(e.hide?" bx-desktop-tab-hide":"")},children:[c.create("span",{props:{className:"bx-desktop-tab-counter"},html:e.badge>0?'<span class="bx-desktop-tab-counter-digit">'+(e.badge>50?"50+":e.badge)+"</span>":""}),c.create("div",{props:{className:"bx-desktop-tab-icon bx-desktop-tab-icon-"+e.id}})]}));if(!c("bx-desktop-tab-content-"+e.id)&&e.id==e.target){var d=false;if(this.currentTab==e.id||this.tabItems[this.currentTab]&&this.tabItems[this.currentTab].target==e.id){d=true}this.contentTabContent.appendChild(c.create("div",{attrs:{"data-id":e.id,id:"bx-desktop-tab-content-"+e.id},props:{className:"bx-desktop-tab-content bx-desktop-tab-content-"+e.id+(d?" bx-desktop-tab-content-active":"")},children:e.initContent?[e.initContent]:[]}));e.events.init()}}return true};a.prototype.drawAppearance=function(){if(!this.content){return false}this.content.innerHTML="";this.content.appendChild(this.contentBox=c.create("div",{props:{className:"bx-desktop-appearance"},style:{minHeight:this.minHeight+"px"},children:[this.contentMenu=c.create("div",{props:{className:"bx-desktop-appearance-menu"},children:[this.contentAvatar=c.create("div",{props:{className:"bx-desktop-appearance-avatar"}}),this.contentTab=c.create("div",{props:{className:"bx-desktop-appearance-tab"}})]}),this.contentTabContent=c.create("div",{props:{className:"bx-desktop-appearance-content"}})]}));c.bindDelegate(this.contentTab,"click",{className:"bx-desktop-tab"},c.delegate(function(d){this.changeTab(d,false);c.PreventDefault(d)},this));this.adjustSize();c.onCustomEvent(b,"onMessengerWindowInit",[this,this.BXIM]);return true};a.prototype.changeTab=function(d,f,g){f=typeof(f)=="undefined"?true:f;g=typeof(g)=="undefined"?false:g;if(typeof(d)=="object"){if(!c.proxy_context){return false}d=c.proxy_context.getAttribute("data-id")}if(!this.tabItems[d]){return false}if(this.tabItems[d].target){var e=false;if(!f||this.currentTab!=d){this.lastTab=this.currentTab;this.lastTabTarget=this.currentTabTarget;this.currentTab=this.tabItems[d].id;this.currentTabTarget=this.tabItems[d].target;e=true}if(c("bx-desktop-tab-"+this.lastTab)){c.removeClass(c("bx-desktop-tab-"+this.lastTab),"bx-desktop-tab-active")}if(c("bx-desktop-tab-"+d)){c.addClass(c("bx-desktop-tab-"+d),"bx-desktop-tab-active")}if(c("bx-desktop-tab-content-"+this.lastTab)){c.removeClass(c("bx-desktop-tab-content-"+this.lastTab),"bx-desktop-tab-content-active")}else{if(c("bx-desktop-tab-content-"+this.lastTabTarget)){c.removeClass(c("bx-desktop-tab-content-"+this.lastTabTarget),"bx-desktop-tab-content-active")}}if(c("bx-desktop-tab-content-"+this.currentTab)){c.addClass(c("bx-desktop-tab-content-"+this.currentTab),"bx-desktop-tab-content-active")}else{if(c("bx-desktop-tab-content-"+this.currentTabTarget)){c.addClass(c("bx-desktop-tab-content-"+this.currentTabTarget),"bx-desktop-tab-content-active")}}if(e&&!g){if(this.tabItems[this.lastTab]){this.tabItems[this.lastTab].events.close()}if(this.tabItems[this.currentTab]){c.onCustomEvent(this,"OnDesktopTabChange",[this.currentTab,this.lastTab]);this.tabItems[this.currentTab].events.open()}}}else{if(!g){this.tabItems[d].events.open()}}return true};a.prototype.closeTab=function(e){e=e||this.getCurrentTab();if(!this.tabItems[e]||this.getCurrentTab()!=e){return false}if(this.tabItems[e].target!=this.currentTabTarget){this.changeTab(e,false)}else{if(c("bx-desktop-tab-"+this.currentTab)){c.removeClass(c("bx-desktop-tab-"+this.currentTab),"bx-desktop-tab-active")}if(c("bx-desktop-tab-"+this.lastTab)){c.addClass(c("bx-desktop-tab-"+this.lastTab),"bx-desktop-tab-active")}var d=this.lastTab;this.lastTab=this.currentTab;this.currentTab=d}};a.prototype.setTabBadge=function(e,f){if(!this.tabItems[e]){return false}f=parseInt(f);this.tabItems[e].badge=f>0?f:0;if(f>50){f="50+"}if(c("bx-desktop-tab-"+e)){var d=c.findChild(c("bx-desktop-tab-"+e),{className:"bx-desktop-tab-counter"},true);if(d){d.innerHTML=f?'<span class="bx-desktop-tab-counter-digit">'+f+"</span>":""}}if(c.desktop&&c.desktop.apiReady){c.desktop.updateTabBadge()}};a.prototype.setTabContent=function(d,e){if(!this.tabItems[d]){return false}if(c("bx-desktop-tab-content-"+d)){if(c.type.isDomNode(e)){c("bx-desktop-tab-content-"+d).innerHTML="";c("bx-desktop-tab-content-"+d).appendChild(e)}else{c("bx-desktop-tab-content-"+d).innerHTML=e}}else{this.tabItems[d].initContent=e}return true};a.prototype.getCurrentTab=function(){return this.currentTab};a.prototype.getCurrentTabTarget=function(){return this.currentTabTarget};a.prototype.setUserInfo=function(e){if(!this.userInfo){if(!e||!e.id||!e.name){return false}}if(e){if(!e.gender){e.gender="M"}if(!e.avatar||!e.profile){e.avatar=""}this.userInfo=e}if(!this.contentAvatar){if(!this.drawAppearance()){return false}}var d={};d.click=function(f){BXIM.openMessenger(BXIM.userId);return c.PreventDefault(f)};this.contentAvatar.innerHTML="";this.contentAvatar.appendChild(c.create("a",{attrs:{href:this.userInfo.profile,title:c.util.htmlspecialcharsback(this.userInfo.name),target:"_blank"},props:{className:"bx-desktop-avatar"},events:d,children:[c.create("img",{attrs:{src:this.userInfo.avatar,style:(c.MessengerCommon.isBlankAvatar(this.userInfo.avatar)?"background-color: "+this.userInfo.color:"")},props:{className:"bx-desktop-avatar-img bx-desktop-avatar-img-default"}})]}));return true};a.prototype.updateUserInfo=function(e){for(var d in e){this.userInfo[d]=e[d]}return this.setUserInfo(this.userInfo)};a.prototype.getUserInfo=function(){return this.userInfo};a.prototype.isPopupShow=function(){if(this.context=="DESKTOP"){return true}else{if(this.context=="POPUP-FULLSCREEN"&&!c.hasClass(this.popup,"bx-im-fullscreen-closed")){return true}}return false};a.prototype.backgroundChange=function(){var d=this.backgroundSelector.value;if(d=="transparent"){c.removeClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");c.addClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");c.style(this.popupBackground,"background","");c.style(this.popupBackground,"backgroundSize","")}else{if(d>0){c.removeClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");c.removeClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");c.style(this.popupBackground,"background","url(/bitrix/js/im/images/bg-image-"+d+".jpg) #ccc");c.style(this.popupBackground,"backgroundSize","cover")}else{c.removeClass(this.popupBackground,"bx-im-fullscreen-popup-transparent");c.addClass(this.popupBackground,"bx-im-fullscreen-popup-bitrix24");c.style(this.popupBackground,"background","");c.style(this.popupBackground,"backgroundSize","")}}};a.prototype.showPopup=function(d){if(this.isPopupShow()){return false}this.popupTimestart=+new Date();clearTimeout(this.popupTimeout);var e=b.innerWidth-document.documentElement.clientWidth;c.onCustomEvent(b,"onMessengerWindowBodyOverflow",[this,e]);c.addClass(document.body,"bx-im-fullscreen-block-scroll");c.addClass(this.popup,"bx-im-fullscreen-opening");c.removeClass(this.popup,"bx-im-fullscreen-closing");c.removeClass(this.popup,"bx-im-fullscreen-closed");this.adjustSize();this.BXIM.desktop.initHeight=c.MessengerWindow.content.offsetHeight;this.popupTimeout=setTimeout(c.delegate(function(){c.removeClass(this.popup,"bx-im-fullscreen-opening");c.addClass(this.popup,"bx-im-fullscreen-open");if(this.BXIM.webrtc.callOverlay){c.style(this.BXIM.webrtc.callOverlay,"height",(this.BXIM.messenger.popupMessengerFullHeight-1)+"px")}},this),400);c.onCustomEvent(this,"OnMessengerWindowShowPopup",[d]);return true};a.prototype.closePopup=function(){if(!this.isPopupShow()||this.BXIM.webrtc.callInit){return false}if(this.popupTimestart+400>(+new Date())){return false}clearTimeout(this.popupTimeout);c.removeClass(document.body,"bx-im-fullscreen-block-scroll");c.onCustomEvent(this,"OnMessengerWindowClosePopup",[]);c.onCustomEvent(b,"onMessengerWindowBodyOverflow",[this,0]);c.addClass(this.popup,"bx-im-fullscreen-open");c.addClass(this.popup,"bx-im-fullscreen-closing");c.removeClass(this.popup,"bx-im-fullscreen-opening");this.popupTimeout=setTimeout(c.delegate(function(){c.removeClass(this.popup,"bx-im-fullscreen-closing");c.removeClass(this.popup,"bx-im-fullscreen-open");c.addClass(this.popup,"bx-im-fullscreen-closed")},this),400);return true};a.prototype.storageSet=function(d){if(d.key=="imFullscreenBackground"){this.backgroundSelector.value=d.value;this.backgroundChange()}};c.MessengerWindow=new a()})(window);