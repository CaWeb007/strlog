(function(){var f=function(){};var k={simple:"simple",crm:"crm"};var m={simple:{width:550,height:492},crm:{width:550,height:650}};var g={height:"im-phone-call-view-height",width:"im-phone-call-view-width"};var d=15000;var j={setTitle:"phoneCallViewSetTitle",setStatus:"phoneCallViewSetStatus",setUiState:"phoneCallViewSetUiState",setDeviceCall:"phoneCallViewSetDeviceCall",setCrmEntity:"phoneCallViewSetCrmEntity",setPortalCall:"phoneCallViewSetPortalCall",setPortalCallUserId:"phoneCallViewSetPortalCallUserId",setPortalCallData:"phoneCallViewSetPortalCallData",setConfig:"phoneCallViewSetConfig",setCallState:"phoneCallViewSetCallState",reloadCrmCard:"phoneCallViewReloadCrmCard",setCallId:"phoneCallViewSetCallId",setLineNumber:"phoneCallViewSetLineNumber",setCompanyPhoneNumber:"phoneCallViewSetCompanyPhoneNumber",closeWindow:"phoneCallViewCloseWindow",onHold:"phoneCallViewOnHold",onUnHold:"phoneCallViewOnUnHold",onMute:"phoneCallViewOnMute",onUnMute:"phoneCallViewOnUnMute",onMakeCall:"phoneCallViewOnMakeCall",onCallListMakeCall:"phoneCallViewOnCallListMakeCall",onAnswer:"phoneCallViewOnAnswer",onSkip:"phoneCallViewOnSkip",onHangup:"phoneCallViewOnHangup",onClose:"phoneCallViewOnClose",onStartTransfer:"phoneCallViewOnStartTransfer",onCancelTransfer:"phoneCallViewOnCancelTransfer",onBeforeUnload:"phoneCallViewOnBeforeUnload",onSwitchDevice:"phoneCallViewOnSwitchDevice",onQualityGraded:"phoneCallViewOnQualityGraded",onDialpadButtonClicked:"phoneCallViewOnDialpadButtonClicked",onSaveComment:"phoneCallViewOnSaveComment"};var e={restApps:[],callInterceptAllowed:false};BX.PhoneCallView=function(q){this.id="im-phone-call-view";this.BXIM=q.BXIM||window.BXIM;if(!BX.type.isPlainObject(q)){q={}}this.keypad=null;this.phoneNumber=q.phoneNumber||"hidden";this.lineNumber=q.lineNumber||"";this.companyPhoneNumber=q.companyPhoneNumber||"";this.direction=q.direction||BX.PhoneCallView.Direction.incoming;this.fromUserId=q.fromUserId;this.toUserId=q.toUserId;this.config=q.config||{};this.callId=q.callId||"";this.callState=BX.PhoneCallView.CallState.idle;this.crmEntityType=q.crmEntityType||"";this.crmEntityId=q.crmEntityId||0;this.crmActivityId=q.crmActivityId||0;this.crmActivityEditUrl=q.crmActivityEditUrl||"";this.crmData=BX.type.isPlainObject(q.crmData)?q.crmData:{};this.externalRequests={};this.portalCallUserId=q.portalCallUserId;this.portalCallData=q.portalCallData;this.hasSipPhone=(q.hasSipPhone===true);this.deviceCall=(q.deviceCall===true);this.portalCall=(q.portalCall===true);this.crm=(q.crm===true);this.held=false;this.muted=false;this.recording=(q.recording===true);this.makeCall=(q.makeCall===true);this.closable=false;this.allowAutoClose=true;this.folded=(q.folded===true);this.autoFold=(q.autoFold===true);this.title="";this._uiState=q.uiState||BX.PhoneCallView.UiState.idle;this.statusText=q.statusText||"";this.progress="";this.quality=0;this.qualityPopup=null;this.qualityGrade=0;this.comment="";this.commentShown=false;this.initialTimestamp=q.initialTimestamp||0;this.timerInterval=null;this.elements=this.getInitialElements();this.sections=this.getInitialSections();var p=this.getUiStateButtons(this._uiState);this.buttonLayout=p.layout;this.buttons=p.buttons;if(!BX.type.isPlainObject(q.events)){q.events={}}this.callbacks={hold:BX.type.isFunction(q.events.hold)?q.events.hold:f,unhold:BX.type.isFunction(q.events.unhold)?q.events.unhold:f,mute:BX.type.isFunction(q.events.mute)?q.events.mute:f,unmute:BX.type.isFunction(q.events.unmute)?q.events.unmute:f,makeCall:BX.type.isFunction(q.events.makeCall)?q.events.makeCall:f,callListMakeCall:BX.type.isFunction(q.events.callListMakeCall)?q.events.callListMakeCall:f,answer:BX.type.isFunction(q.events.answer)?q.events.answer:f,skip:BX.type.isFunction(q.events.skip)?q.events.skip:f,hangup:BX.type.isFunction(q.events.hangup)?q.events.hangup:f,close:BX.type.isFunction(q.events.close)?q.events.close:f,transfer:BX.type.isFunction(q.events.transfer)?q.events.transfer:f,cancelTransfer:BX.type.isFunction(q.events.cancelTransfer)?q.events.cancelTransfer:f,switchDevice:BX.type.isFunction(q.events.switchDevice)?q.events.switchDevice:f,qualityGraded:BX.type.isFunction(q.events.qualityGraded)?q.events.qualityGraded:f,dialpadButtonClicked:BX.type.isFunction(q.events.dialpadButtonClicked)?q.events.dialpadButtonClicked:f};this.popup=null;this._onBeforeUnloadHandler=this._onBeforeUnload.bind(this);this._onDblClickHandler=this._onDblClick.bind(this);this._onHoldButtonClickHandler=this._onHoldButtonClick.bind(this);this._onMuteButtonClickHandler=this._onMuteButtonClick.bind(this);this._onTransferButtonClickHandler=this._onTransferButtonClick.bind(this);this._onTransferCancelButtonClickHandler=this._onTransferCancelButtonClick.bind(this);this._onDialpadButtonClickHandler=this._onDialpadButtonClick.bind(this);this._onHangupButtonClickHandler=this._onHangupButtonClick.bind(this);this._onCloseButtonClickHandler=this._onCloseButtonClick.bind(this);this._onMakeCallButtonClickHandler=this._onMakeCallButtonClick.bind(this);this._onNextButtonClickHandler=this._onNextButtonClick.bind(this);this._onRedialButtonClickHandler=this._onRedialButtonClick.bind(this);this._onFoldButtonClickHandler=this._onFoldButtonClick.bind(this);this._onAnswerButtonClickHandler=this._onAnswerButtonClick.bind(this);this._onSkipButtonClickHandler=this._onSkipButtonClick.bind(this);this._onSwitchDeviceButtonClickHandler=this._onSwitchDeviceButtonClick.bind(this);this._onQualityMeterClickHandler=this._onQualityMeterClick.bind(this);this._onPullEventCrmHandler=this._onPullEventCrm.bind(this);this._externalEventHandler=this._onExternalEvent.bind(this);this._unloadHandler=this._onWindowUnload.bind(this);this.hiddenTabs=[];this.currentTabName="";this.moreTabsMenu=null;this.callListId=q.callListId||0;this.callListStatusId=q.callListStatusId||null;this.callListItemIndex=q.callListItemIndex||null;this.callListView=null;this.currentEntity=null;this.callingEntity=null;this.numberSelectMenu=null;this.webformId=q.webformId||0;this.webformSecCode=q.webformSecCode||"";this.webformLoaded=false;this.formManager=null;this.restAppLayoutLoaded=false;this.restAppLayoutLoading=false;this.restAppInterface=null;this.callWindow=null;this.slave=q.slave===true;this.skipOnResize=q.skipOnResize===true;this.desktop=new i({BXIM:this.BXIM,parentPhoneCallView:this,closable:(this.callListId>0?true:this.closable)});this.currentLayout=(this.callListId>0?k.crm:k.simple);this.init();this.setTitle(this.createTitle());if(q.hasOwnProperty("uiState")){this.setUiState(q.uiState)}window.test=this};BX.PhoneCallView.ButtonLayouts={centered:"centered",spaced:"spaced"};BX.PhoneCallView.create=function(p){return new BX.PhoneCallView(p)};BX.PhoneCallView.prototype.getInitialElements=function(){return{main:null,title:null,sections:{status:null,timer:null,crmButtons:null,},avatar:null,progress:null,timer:null,status:null,commentEditorContainer:null,commentEditor:null,qualityMeter:null,crmCard:null,crmButtonsContainer:null,crmButtons:{},buttonsContainer:null,topLevelButtonsContainer:null,topButtonsContainer:null,buttons:{},sidebarContainer:null,tabsContainer:null,tabsBodyContainer:null,tabs:{callList:null,webform:null,app:null},tabsBody:{callList:null,webform:null,app:null},moreTabs:null}};BX.PhoneCallView.prototype.getInitialSections=function(){return{status:{visible:false},timer:{visible:false},crmButtons:{visible:false},commentEditor:{visible:false}}};BX.PhoneCallView.prototype.init=function(){var p=this;if(BX.MessengerCommon.isDesktop()&&!this.slave){this.desktop.openCallWindow("",null,{width:this.getInitialWidth(),height:this.getInitialHeight(),resizable:(this.currentLayout==k.crm),minWidth:this.elements.sidebarContainer?950:550,minHeight:650});this.bindMasterDesktopEvents();window.addEventListener("beforeunload",this._unloadHandler);return}this.elements.main=this.createLayout();this.updateView();if(this.isDesktop()){document.body.appendChild(this.elements.main);this.bindSlaveDesktopEvents()}else{if(this.isFolded()){document.body.appendChild(this.elements.main)}else{this.popup=this.createPopup();BX.addCustomEvent(window,"onLocalStorageSet",this._externalEventHandler)}}if(this.callListId>0){if(this.callListView){this.callListView.reinit({node:this.elements.tabsBody.callList})}else{this.callListView=new a({node:this.elements.tabsBody.callList,id:this.callListId,statusId:this.callListStatusId,itemIndex:this.callListItemIndex,makeCall:this.makeCall,BXIM:this.BXIM,onSelectedItem:this.onCallListSelectedItem.bind(this)});this.callListView.init(function(){if(p.makeCall){p._onMakeCallButtonClick()}});this.setUiState(BX.PhoneCallView.UiState.outgoing)}}else{if(this.crm&&!this.isFolded()){this.loadCrmCard(this.crmEntityType,this.crmEntityId)}}BX.addCustomEvent("onPullEvent-crm",this._onPullEventCrmHandler);if(!this.isDesktop()){window.addEventListener("beforeunload",this._onBeforeUnloadHandler)}};BX.PhoneCallView.prototype.reinit=function(){this.elements=this.getInitialElements();this.init()};BX.PhoneCallView.setDefaults=function(p){for(paramName in p){if(p.hasOwnProperty(paramName)&&e.hasOwnProperty(paramName)){e[paramName]=p[paramName]}}};BX.PhoneCallView.prototype.show=function(){if(!this.popup){return}if(!this.isDesktop()&&!this.isFolded()){this.disableDocumentScroll()}this.popup.show()};BX.PhoneCallView.prototype.createPopup=function(){var p=this;return new BX.PopupWindow(p.getId(),null,{content:this.elements.main,closeIcon:false,noAllPaddings:true,zIndex:d,offsetLeft:0,offsetTop:0,closeByEsc:false,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(){if(p.isFolded()){}else{p.callbacks.close()}},onPopupDestroy:function(){p.popup=null}}})};BX.PhoneCallView.prototype.createLayout=function(){if(this.isFolded()){return this.createLayoutFolded()}else{if(this.currentLayout==k.crm){return this.createLayoutCrm()}else{return this.createLayoutSimple()}}};BX.PhoneCallView.prototype.createLayoutCrm=function(){var p=BX.create("div",{props:{className:"im-phone-call-top-level"},events:{dblclick:this._onDblClickHandler},children:[this.elements.topLevelButtonsContainer=BX.create("div"),BX.create("div",{props:{className:"im-phone-call-wrapper"+(this.hasSideBar()?"":" im-phone-call-wrapper-without-sidebar")},children:[BX.create("div",{props:{className:"im-phone-call-container"+(this.hasSideBar()?"":" im-phone-call-container-without-sidebar")},children:[BX.create("div",{props:{className:"im-phone-call-header-container"},children:[BX.create("div",{props:{className:"im-phone-call-header"},children:[this.elements.title=BX.create("div",{props:{className:"im-phone-call-title-text"},html:this.renderTitle()})]})]}),this.elements.crmCard=BX.create("div",{props:{className:"im-phone-call-crm-card"}}),this.elements.sections.status=BX.create("div",{props:{className:"im-phone-call-section"},style:this.sections.status.visible?{}:{display:"none"},children:[BX.create("div",{props:{className:"im-phone-call-status-description"},children:[this.elements.status=BX.create("div",{props:{className:"im-phone-call-status-description-item"},text:this.statusText})]})]}),this.elements.sections.timer=BX.create("div",{props:{className:"im-phone-call-section"},style:this.sections.timer.visible?{}:{display:"none"},children:[BX.create("div",{props:{className:"im-phone-call-status-timer"},children:[BX.create("div",{props:{className:"im-phone-call-status-timer-item"},children:[this.elements.timer=BX.create("span")]})]})]}),this.elements.commentEditorContainer=BX.create("div",{props:{className:"im-phone-call-section"},style:this.commentShown?{}:{display:"none"},children:[BX.create("div",{props:{className:"im-phone-call-comments"},children:[this.elements.commentEditor=BX.create("textarea",{props:{className:"im-phone-call-comments-textarea",value:this.comment,placeholder:BX.message("IM_PHONE_CALL_COMMENT_PLACEHOLDER")},events:{bxchange:this._onCommentChanged.bind(this)}})]})]}),this.elements.sections.crmButtons=BX.create("div",{props:{className:"im-phone-call-section"},style:this.sections.crmButtons.visible?{}:{display:"none"},children:[this.elements.crmButtonsContainer=BX.create("div",{props:{className:"im-phone-call-crm-buttons"}})]}),this.elements.buttonsContainer=BX.create("div",{props:{className:"im-phone-call-buttons-container"}}),this.elements.topButtonsContainer=BX.create("div",{props:{className:"im-phone-call-buttons-container-top"}})]})]})]});if(this.hasSideBar()){this.createSidebarLayout();if(this.elements.sidebarContainer){p.appendChild(this.elements.sidebarContainer)}setTimeout(function(){this.checkMoreButton()}.bind(this),0)}if(this.isDesktop()){p.style.position="fixed";p.style.top=0;p.style.bottom=0;p.style.left=0;p.style.right=0}else{p.style.width=this.getInitialWidth()+"px";p.style.height=this.getInitialHeight()+"px"}return p};BX.PhoneCallView.prototype.hasSideBar=function(){if(this.isDesktop()&&!this.desktop.isFeatureSupported("iframe")){return this.callListId>0}else{return(this.callListId>0||this.webformId>0||e.restApps.length>0)}};BX.PhoneCallView.prototype.getInitialWidth=function(){var p=(window.localStorage)?parseInt(window.localStorage.getItem(g.width)):0;if(this.currentLayout==k.simple){return m.simple.width}else{if(this.hasSideBar()){if(p>0){return p}else{return Math.min(Math.floor(screen.width*0.8),1200)}}else{return m.crm.width}}};BX.PhoneCallView.prototype.getInitialHeight=function(){var p=(window.localStorage)?parseInt(window.localStorage.getItem(g.height)):0;if(this.currentLayout==k.simple){return m.simple.height}else{if(p>0){return p}else{return m.crm.height}}};BX.PhoneCallView.prototype.saveInitialSize=function(q,p){if(!window.localStorage){return false}if(this.currentLayout==k.crm){window.localStorage.setItem(g.height,p.toString());if(this.hasSideBar()){window.localStorage.setItem(g.width,q)}}};BX.PhoneCallView.prototype.showSections=function(q){var p=this;if(!BX.type.isArray(q)){return}q.forEach(function(r){if(p.elements.sections[r]){p.elements.sections[r].style.removeProperty("display")}if(p.sections[r]){p.sections[r].visible=true}})};BX.PhoneCallView.prototype.hideSections=function(q){var p=this;if(!BX.type.isArray(q)){return}q.forEach(function(r){if(p.elements.sections[r]){p.elements.sections[r].style.display="none"}if(p.sections[r]){p.sections[r].visible=false}})};BX.PhoneCallView.prototype.showOnlySections=function(s){var q=this;if(!BX.type.isArray(s)){return}var p={};s.forEach(function(t){p[t]=true});for(var r in this.elements.sections){if(!this.elements.sections.hasOwnProperty(r)||!BX.type.isDomNode(this.elements.sections[r])){continue}if(p[r]){this.elements.sections[r].style.removeProperty("display");if(this.sections.hasOwnProperty(r)){this.sections[r].visible=true}}else{this.elements.sections[r].style.display="none";if(this.sections.hasOwnProperty(r)){this.sections[r].visible=false}}}};BX.PhoneCallView.prototype.createSidebarLayout=function(){var p=this;var q=[];var r=[];if(this.callListId>0){this.elements.tabs.callList=BX.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:"callList",tabBodyId:"callList"},text:BX.message("IM_PHONE_CALL_VIEW_CALL_LIST_TITLE"),events:{click:this._onTabHeaderClick.bind(this)}});q.push(this.elements.tabs.callList);this.elements.tabsBody.callList=BX.create("div");r.push(this.elements.tabsBody.callList)}if(this.webformId>0&&this.isWebformSupported()){this.elements.tabs.webform=BX.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:"webform",tabBodyId:"webform"},text:BX.message("IM_PHONE_CALL_VIEW_WEBFORM_TITLE"),events:{click:this._onTabHeaderClick.bind(this)}});q.push(this.elements.tabs.webform);this.elements.tabsBody.webform=BX.create("div",{props:{className:"im-phone-call-form-container"}});r.push(this.elements.tabsBody.webform);this.formManager=new l({node:this.elements.tabsBody.webform,onFormSend:this._onFormSend.bind(this)})}if(e.restApps.length>0&&this.isRestAppsSupported()){e.restApps.forEach(function(u){var s=u.id;var t="restApp"+s;p.elements.tabs[t]=BX.create("span",{props:{className:"im-phone-sidebar-tab"},dataset:{tabId:t,tabBodyId:"app",restAppId:s},text:BX.util.htmlspecialchars(u.name),events:{click:p._onTabHeaderClick.bind(p)}});q.push(p.elements.tabs[t])});p.elements.tabsBody.app=BX.create("div",{props:{className:"im-phone-call-app-container"}});r.push(p.elements.tabsBody.app)}this.elements.sidebarContainer=BX.create("div",{props:{className:"im-phone-sidebar-wrap"},children:[BX.create("div",{props:{className:"im-phone-sidebar-tabs-container"},children:[this.elements.tabsContainer=BX.create("div",{props:{className:"im-phone-sidebar-tabs-left"},children:q}),BX.create("div",{props:{className:"im-phone-sidebar-tabs-right"},children:[this.elements.moreTabs=BX.create("span",{props:{className:"im-phone-sidebar-tab im-phone-sidebar-tab-more"},style:{display:"none"},dataset:{},text:BX.message("IM_PHONE_CALL_VIEW_MORE"),events:{click:this._onTabMoreClick.bind(this)}})]})]}),this.elements.tabsBodyContainer=BX.create("div",{props:{className:"im-phone-sidebar-tabs-body-container"},children:r})]});if(this.callListId>0){this.setActiveTab({tabId:"callList",tabBodyId:"callList"})}else{if(this.webformId>0&&this.isWebformSupported()){this.setActiveTab({tabId:"webform",tabBodyId:"webform"})}else{if(e.restApps.length>0&&this.isRestAppsSupported()){this.setActiveTab({tabId:"restApp"+e.restApps[0].id,tabBodyId:"app",restAppId:e.restApps[0].id})}}}};BX.PhoneCallView.prototype.createLayoutSimple=function(){var q="";if(this.isPortalCall()&&this.portalCallData.hrphoto&&this.portalCallData.hrphoto[this.portalCallUserId]){q=this.portalCallData.hrphoto[this.portalCallUserId]}var p=BX.create("div",{props:{className:"im-phone-call-wrapper"},children:[BX.create("div",{props:{className:"im-phone-call-container"},children:[BX.create("div",{props:{className:"im-phone-calling-section"},children:[this.elements.title=BX.create("div",{props:{className:"im-phone-calling-text"}})]}),BX.create("div",{props:{className:"im-phone-call-section im-phone-calling-progress-section"},children:[BX.create("div",{props:{className:"im-phone-calling-progress-container"},children:[BX.create("div",{props:{className:"im-phone-calling-progress-container-block-l"},children:[BX.create("div",{props:{className:"im-phone-calling-progress-phone"}})]}),this.elements.progress=BX.create("div",{props:{className:"im-phone-calling-progress-container-block-c"}}),BX.create("div",{props:{className:"im-phone-calling-progress-container-block-r"},children:[this.elements.avatar=BX.create("div",{props:{className:"im-phone-calling-progress-customer"},style:q==""?{}:{"background-image":"url("+q+")"}})]})]})]}),BX.create("div",{props:{className:"im-phone-call-section"},children:[this.elements.status=BX.create("div",{props:{className:"im-phone-calling-process-status"}})]}),this.elements.buttonsContainer=BX.create("div",{props:{className:"im-phone-call-buttons-container"}}),this.elements.topButtonsContainer=BX.create("div",{props:{className:"im-phone-call-buttons-container-top"}})]})]});p.style.width=this.getInitialWidth()+"px";p.style.height=this.getInitialHeight()+"px";return p};BX.PhoneCallView.prototype.createLayoutFolded=function(){var p=this;return BX.create("div",{props:{className:"im-phone-call-panel-mini"},style:{zIndex:d},children:[this.elements.sections.timer=this.elements.timer=BX.create("div",{props:{className:"im-phone-call-panel-mini-time"},style:this.sections.timer.visible?{}:{display:"none"}}),this.elements.buttonsContainer=BX.create("div",{props:{className:"im-phone-call-panel-mini-buttons"}}),BX.create("div",{props:{className:"im-phone-call-panel-mini-expand"},events:{click:function(){p.unfold()}}})]})};BX.PhoneCallView.prototype.setActiveTab=function(s){var r=s.tabId;var q=s.tabBodyId;var p=s.restAppId||"";s.hidden=s.hidden===true;for(tab in this.elements.tabs){if(this.elements.tabs.hasOwnProperty(tab)&&BX.type.isDomNode(this.elements.tabs[tab])){if(tab==r){BX.addClass(this.elements.tabs[tab],"im-phone-sidebar-tab-active")}else{BX.removeClass(this.elements.tabs[tab],"im-phone-sidebar-tab-active")}}}if(s.hidden){BX.addClass(this.elements.moreTabs,"im-phone-sidebar-tab-active")}else{BX.removeClass(this.elements.moreTabs,"im-phone-sidebar-tab-active")}for(tab in this.elements.tabsBody){if(this.elements.tabsBody.hasOwnProperty(tab)&&BX.type.isDomNode(this.elements.tabsBody[tab])){if(tab==q){this.elements.tabsBody[tab].style.removeProperty("display")}else{this.elements.tabsBody[tab].style.display="none"}}}this.currentTabName=r;if(r==="webform"&&!this.webformLoaded){this.loadForm({id:this.webformId,secCode:this.webformSecCode})}if(p!==""){this.loadRestApp({id:p,callId:this.BXIM.webrtc.phoneCallId,node:this.elements.tabsBody.app})}};BX.PhoneCallView.prototype.isCurrentTabHidden=function(){var p=false;for(var q=0;q<this.hiddenTabs.length;q++){if(this.hiddenTabs[q].dataset.tabId==this.currentTabName){p=true;break}}return p};BX.PhoneCallView.prototype.checkMoreButton=function(){if(!this.elements.tabsContainer){return}var q=this.elements.tabsContainer.children;var r;this.hiddenTabs=[];for(var p=0;p<q.length;p++){r=q.item(p);if(r.offsetTop>7){this.hiddenTabs.push(r)}}if(this.hiddenTabs.length>0){this.elements.moreTabs.style.removeProperty("display")}else{this.elements.moreTabs.style.display="none"}if(this.isCurrentTabHidden()){BX.addClass(this.elements.moreTabs,"im-phone-sidebar-tab-active")}else{BX.removeClass(this.elements.moreTabs,"im-phone-sidebar-tab-active")}};BX.PhoneCallView.prototype._onTabHeaderClick=function(p){if(this.moreTabsMenu){this.moreTabsMenu.close()}this.setActiveTab({tabId:p.target.dataset.tabId,tabBodyId:p.target.dataset.tabBodyId,restAppId:p.target.dataset.restAppId||"",hidden:false})};BX.PhoneCallView.prototype._onTabMoreClick=function(r){var p=this;if(this.hiddenTabs.length===0){return}if(this.moreTabsMenu){this.moreTabsMenu.close();return}var q=[];this.hiddenTabs.forEach(function(s){q.push({id:"selectTab_"+s.dataset.tabId,text:s.innerText,onclick:function(){p.moreTabsMenu.close();p.setActiveTab({tabId:s.dataset.tabId,tabBodyId:s.dataset.tabBodyId,restAppId:s.dataset.restAppId||"",hidden:true})}})});this.moreTabsMenu=BX.PopupMenu.create("phoneCallViewMoreTabs",this.elements.moreTabs,q,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top"},parentPopup:this.popup,zIndex:d+100,events:{onPopupClose:function(){p.moreTabsMenu.popupWindow.destroy();BX.PopupMenu.destroy("phoneCallViewMoreTabs")},onPopupDestroy:function(){p.moreTabsMenu=null}}});this.moreTabsMenu.popupWindow.show()};BX.PhoneCallView.prototype.getId=function(){return this.id};BX.PhoneCallView.prototype.createTitle=function(){var p="";if(this.phoneNumber=="unknown"){return BX.message("IM_PHONE_CALL_VIEW_NUMBER_UNKNOWN")}if(this.phoneNumber=="hidden"){p=BX.message("IM_PHONE_HIDDEN_NUMBER")}else{p=this.phoneNumber.toString();if(p.substr(0,1)=="8"||p.substr(0,1)=="+"){}else{if(!isNaN(parseInt(p))&&p.length>=10){p="+"+p}}}if(this.isTransfer()){p=BX.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",p)}else{if(this.isCallback()){p=BX.message("IM_PHONE_CALLBACK_TO").replace("#PHONE#",p)}else{if(this.isPortalCall()){switch(this.direction){case BX.PhoneCallView.Direction.incoming:p=BX.message("IM_M_CALL_VOICE_FROM").replace("#USER#",this.portalCallData.users[this.portalCallUserId].name);break;case BX.PhoneCallView.Direction.outgoing:p=BX.message("IM_M_CALL_VOICE_TO").replace("#USER#",this.portalCallData.users[this.portalCallUserId].name);break}}else{p=BX.message(this.direction===BX.PhoneCallView.Direction.incoming?"IM_PHONE_CALL_VOICE_FROM":"IM_PHONE_CALL_VOICE_TO").replace("#PHONE#",p);if(this.direction===BX.PhoneCallView.Direction.incoming&&this.companyPhoneNumber){p=p+", "+BX.message("IM_PHONE_CALL_TO_PHONE").replace("#PHONE#",this.companyPhoneNumber)}}}}return p};BX.PhoneCallView.prototype.renderTitle=function(){return BX.util.htmlspecialchars(this.title)};BX.PhoneCallView.prototype.renderAvatar=function(){var p="";if(this.isPortalCall()&&this.elements.avatar&&this.portalCallData.hrphoto&&this.portalCallData.hrphoto[this.portalCallUserId]){p=this.portalCallData.hrphoto[this.portalCallUserId];BX.adjust(this.elements.avatar,{style:p==""?{}:{"background-image":"url("+p+")"}})}};BX.PhoneCallView.prototype._getCrmEditUrl=function(q,p){if(!BX.type.isNotEmptyString(q)){return""}p=parseInt(p)||0;return"/crm/"+q.toLowerCase()+"/edit/"+p.toString()+"/"};BX.PhoneCallView.prototype._generateExternalContext=function(){return this._getRandomString(16)};BX.PhoneCallView.prototype._getRandomString=function(p){charSet="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";var q="";for(var r=0;r<p;r++){var s=Math.floor(Math.random()*charSet.length);q+=charSet.substring(s,s+1)}return q};BX.PhoneCallView.prototype.setTitle=function(p){this.title=p;if(this.isDesktop()){if(this.slave){BXDesktopWindow.SetProperty("title",p)}else{BX.desktop.onCustomEvent(j.setTitle,[p])}}if(this.elements.title){this.elements.title.innerHTML=this.renderTitle()}};BX.PhoneCallView.prototype.getTitle=function(){return this.title};BX.PhoneCallView.prototype.setQuality=function(p){this.quality=p;if(this.elements.qualityMeter){this.elements.qualityMeter.style.width=this.getQualityMeterWidth()}};BX.PhoneCallView.prototype.getQualityMeterWidth=function(){if(this.quality>0&&this.quality<=5){return this.quality*20+"%"}else{return"0"}};BX.PhoneCallView.prototype.setProgress=function(p){this.progress=p;if(!this.elements.progress){return}BX.cleanNode(this.elements.progress);this.elements.progress.appendChild(this.renderProgress())};BX.PhoneCallView.prototype.setStatusText=function(p){if(this.isDesktop()&&!this.slave){BX.desktop.onCustomEvent(j.setStatus,[p]);return}this.statusText=p;if(this.elements.status){this.elements.status.innerText=this.statusText}};BX.PhoneCallView.prototype.setConfig=function(p){if(!BX.type.isPlainObject(p)){return}this.config=p;if(!this.isDesktop()||this.slave){this.renderCrmButtons()}this.setOnSlave(j.setConfig,[p])};BX.PhoneCallView.prototype.setCallId=function(p){this.callId=p;this.setOnSlave(j.setCallId,[p])};BX.PhoneCallView.prototype.setLineNumber=function(p){this.lineNumber=p;this.setOnSlave(j.setCallId,[p])};BX.PhoneCallView.prototype.setCompanyPhoneNumber=function(p){this.companyPhoneNumber=p;this.setOnSlave(j.setCompanyPhoneNumber,[p])};BX.PhoneCallView.prototype.setButtons=function(q,p){if(!BX.PhoneCallView.ButtonLayouts[p]){p=BX.PhoneCallView.ButtonLayouts.centered}this.buttonLayout=p;this.buttons=q;this.renderButtons()};BX.PhoneCallView.prototype.setUiState=function(q){this._uiState=q;var p=this.getUiStateButtons(q);this.buttons=p.buttons;this.buttonLayout=p.layout;switch(q){case BX.PhoneCallView.UiState.incoming:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();break;case BX.PhoneCallView.UiState.transferIncoming:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();break;case BX.PhoneCallView.UiState.outgoing:this.setClosable(true);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();this.hideCallIcon();break;case BX.PhoneCallView.UiState.connectingIncoming:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.stopTimer();break;case BX.PhoneCallView.UiState.connectingOutgoing:this.setClosable(false);this.showOnlySections(["status"]);this.renderCrmButtons();this.showCallIcon();this.stopTimer();break;case BX.PhoneCallView.UiState.connected:if(this.deviceCall){this.setClosable(true)}else{this.setClosable(false)}this.showSections(["status","timer"]);this.renderCrmButtons();this.showCallIcon();this.startTimer();break;case BX.PhoneCallView.UiState.transferring:this.setClosable(false);this.showSections(["status","timer"]);this.renderCrmButtons();break;case BX.PhoneCallView.UiState.idle:this.setClosable(true);this.stopTimer();this.hideCallIcon();this.showOnlySections(["status"]);this.renderCrmButtons();break;case BX.PhoneCallView.UiState.error:this.setClosable(true);this.stopTimer();this.hideCallIcon();break;case BX.PhoneCallView.UiState.moneyError:this.setClosable(true);this.stopTimer();this.hideCallIcon();break;case BX.PhoneCallView.UiState.sipPhoneError:this.setClosable(true);this.stopTimer();this.hideCallIcon();break;case BX.PhoneCallView.UiState.redial:this.setClosable(true);this.stopTimer();this.hideCallIcon();break}if(this.isDesktop()&&!this.slave){BX.desktop.onCustomEvent(j.setUiState,[q]);return}this.renderButtons()};BX.PhoneCallView.prototype.setCallState=function(q,p){if(this.callState===q){return}this.callState=q;if(!BX.type.isPlainObject(p)){p={}}if(q===BX.PhoneCallView.CallState.connected&&this.isAutoFoldAllowed()){this.fold()}else{this.renderButtons()}BX.onCustomEvent(window,"CallCard::CallStateChanged",[q,p]);this.setOnSlave(j.setCallState,[q,p])};BX.PhoneCallView.prototype.isAutoFoldAllowed=function(){return(this.autoFold===true&&!this.isDesktop()&&!this.isFolded()&&e.restApps.length==0)};BX.PhoneCallView.prototype.isHeld=function(){return this.held};BX.PhoneCallView.prototype.setHeld=function(p){this.held=p};BX.PhoneCallView.prototype.setRecording=function(p){this.recording=p};BX.PhoneCallView.prototype.isRecording=function(){return this.recording};BX.PhoneCallView.prototype.isMuted=function(){return this.muted};BX.PhoneCallView.prototype.setMuted=function(p){this.muted=p};BX.PhoneCallView.prototype.isTransfer=function(){return(this.direction===BX.PhoneCallView.Direction.incomingTransfer)};BX.PhoneCallView.prototype.isCallback=function(){return(this.direction===BX.PhoneCallView.Direction.callback)};BX.PhoneCallView.prototype.isPortalCall=function(){return this.portalCall};BX.PhoneCallView.prototype.setCallback=function(p,q){if(!this.callbacks.hasOwnProperty(p)){return false}this.callbacks[p]=BX.type.isFunction(q)?q:f};BX.PhoneCallView.prototype.setDeviceCall=function(p){this.deviceCall=p;if(this.elements.buttons.sipPhone){if(p){BX.addClass(this.elements.buttons.sipPhone,"active")}else{BX.removeClass(this.elements.buttons.sipPhone,"active")}}if(this.isDesktop()&&!this.slave){BX.desktop.onCustomEvent(j.setDeviceCall,[p])}};BX.PhoneCallView.prototype.setCrmEntity=function(p){this.crmEntityType=p.type;this.crmEntityId=p.id;this.crmActivityId=p.activityId||"";this.crmActivityEditUrl=p.activityEditUrl||"";if(this.isDesktop()&&!this.slave){BX.desktop.onCustomEvent(j.setCrmEntity,[p])}};BX.PhoneCallView.prototype.setCrmData=function(p){if(!BX.type.isPlainObject(p)){return}this.crm=true;this.crmData=p};BX.PhoneCallView.prototype.loadCrmCard=function(t,r,q,u){var s=3;q=parseInt(q)||0;u=u===true;if(!u){BX.onCustomEvent(window,"CallCard::EntityChanged",[{CRM_ENTITY_TYPE:t,CRM_ENTITY_ID:r,PHONE_NUMBER:this.phoneNumber}])}var p=this;var v={sessid:BX.bitrix_sessid(),COMMAND:"getCrmCard",IM_PHONE:"Y",IM_AJAX_CALL:"Y",PARAMS:{ENTITY_TYPE:t,ENTITY_ID:r}};BX.ajax({url:this.BXIM.pathToCallAjax+"?CALL_CRM_CARD&V="+this.BXIM.revision,method:"POST",datatype:"html",data:v,onsuccess:function(z){var x;try{if(z[0]==="{"){x=JSON.parse(z)}else{x={}}}catch(y){x={}}if(x.ERROR==="SESSION_ERROR"&&x.BITRIX_SESSID&&q<=s){BX.message({bitrix_sessid:x.BITRIX_SESSID});setTimeout(function(){this.loadCrmCard(t,r,q+1,true)}.bind(this),50);return}else{if(x.ERROR=="AUTHORIZE_ERROR"&&this.isDesktop()&&q<=s){setTimeout(function(){this.loadCrmCard(t,r,q+1,true)}.bind(this),5000);BX.onCustomEvent(window,"onImError",[x.ERROR]);return}}if(p.currentLayout==k.simple){p.currentLayout=k.crm;p.crm=true;var w=p.createLayoutCrm();p.elements.main.parentNode.replaceChild(w,p.elements.main);p.elements.main=w;p.setUiState(p._uiState);p.setStatusText(p.statusText)}if(p.elements.crmCard){p.elements.crmCard.innerHTML=z;setTimeout(function(){if(p.isDesktop()){p.resizeWindow(p.getInitialWidth(),p.getInitialHeight())}p.adjust();p.bindCrmCardEvents()},100)}p.renderCrmButtons()}})};BX.PhoneCallView.prototype.reloadCrmCard=function(){if(this.isDesktop()&&!this.slave){BX.desktop.onCustomEvent(j.reloadCrmCard,[])}else{this.loadCrmCard(this.crmEntityType,this.crmEntityId)}};BX.PhoneCallView.prototype.bindCrmCardEvents=function(){var p=this;if(!this.elements.crmCard){return}if(!BX.Crm||!BX.Crm.Page){return}var r=this.elements.crmCard.querySelectorAll("a[data-use-slider=Y]");for(var q=0;q<r.length;q++){BX.bind(r[q],"click",function(s){if(BX.Crm.Page.isSliderEnabled(s.currentTarget.href)){if(!p.isFolded()){p.fold()}}})}};BX.PhoneCallView.prototype.setPortalCallUserId=function(p){this.portalCallUserId=p;this.setOnSlave(j.setPortalCallUserId,[p]);if(this.portalCallData&&this.portalCallData.users[this.portalCallUserId]){this.renderAvatar();if(!this.slave){this.setTitle(BX.message("IM_M_CALL_VOICE_TO").replace("#USER#",this.portalCallData.users[this.portalCallUserId].name))}}};BX.PhoneCallView.prototype.setPortalCall=function(p){this.portalCall=(p==true);this.setOnSlave(j.setPortalCall,[p])};BX.PhoneCallView.prototype.setPortalCallData=function(p){this.portalCallData=p;this.setOnSlave(j.setPortalCallData,[p])};BX.PhoneCallView.prototype.setOnSlave=function(q,p){if(this.isDesktop()&&!this.slave){BX.desktop.onCustomEvent(q,p)}};BX.PhoneCallView.prototype.updateView=function(){if(this.elements.title){this.elements.title.innerHTML=this.renderTitle()}if(this.elements.progress){BX.cleanNode(this.elements.progress);this.elements.progress.appendChild(this.renderProgress())}if(this.elements.status){this.elements.status.innerText=this.statusText}this.renderButtons();this.renderTimer()};BX.PhoneCallView.prototype.renderProgress=function(){var p;var q=this.progress;if(q=="connect"){p=BX.create("div",{props:{className:"bx-messenger-call-overlay-progress"},children:[BX.create("img",{props:{className:"bx-messenger-call-overlay-progress-status bx-messenger-call-overlay-progress-status-anim-1"}}),BX.create("img",{props:{className:"bx-messenger-call-overlay-progress-status bx-messenger-call-overlay-progress-status-anim-2"}})]})}else{if(q=="online"){p=BX.create("div",{props:{className:"bx-messenger-call-overlay-progress bx-messenger-call-overlay-progress-online"},children:[BX.create("img",{props:{className:"bx-messenger-call-overlay-progress-status bx-messenger-call-overlay-progress-status-anim-3"}})]})}else{if(q=="wait"||q=="offline"||q=="error"){if(q=="offline"){this.BXIM.playSound("error")}else{if(q=="error"){q="offline"}}p=BX.create("div",{props:{className:"bx-messenger-call-overlay-progress bx-messenger-call-overlay-progress-"+q}})}else{p=BX.create("div",{props:{className:"bx-messenger-call-overlay-progress bx-messenger-call-overlay-progress-"+q}})}}}return p};BX.PhoneCallView.prototype.getUiStateButtons=function(q){var p={buttons:[],layout:BX.PhoneCallView.ButtonLayouts.centered};switch(q){case BX.PhoneCallView.UiState.incoming:p.buttons=["answer","skip"];break;case BX.PhoneCallView.UiState.transferIncoming:p.buttons=["answer","skip"];break;case BX.PhoneCallView.UiState.outgoing:p.buttons=["call"];if(this.callListId>0){p.buttons.push("next");p.buttons.push("fold");if(!this.isDesktop()){p.buttons.push("topClose")}}break;case BX.PhoneCallView.UiState.connectingIncoming:p.buttons=["hangup"];break;case BX.PhoneCallView.UiState.connectingOutgoing:if(this.hasSipPhone){p.buttons.push("sipPhone")}p.buttons.push("hangup");break;case BX.PhoneCallView.UiState.error:if(this.callListId>0){p.buttons=["redial","next","topClose"]}else{p.buttons.push("close")}break;case BX.PhoneCallView.UiState.moneyError:p.buttons=["notifyAdmin","close"];break;case BX.PhoneCallView.UiState.sipPhoneError:p.buttons=["sipPhone","close"];break;case BX.PhoneCallView.UiState.connected:p.buttons=["hold","mute","qualityMeter","fold"];if(!this.callListId){p.buttons.push("transfer")}if(this.deviceCall){p.buttons.push("close")}else{p.buttons.push("dialpad");p.buttons.push("hangup")}p.layout=BX.PhoneCallView.ButtonLayouts.spaced;break;case BX.PhoneCallView.UiState.transferring:p.buttons=["transferCancel"];break;case BX.PhoneCallView.UiState.idle:if(this.hasSipPhone){p.buttons=["close"]}else{if(this.direction==BX.PhoneCallView.Direction.incoming){p.buttons=["close"]}else{if(this.direction==BX.PhoneCallView.Direction.outgoing){p.buttons=["redial"];if(this.callListId>0){p.buttons.push("next");p.buttons.push("fold")}else{p.buttons.push("close")}}}}if(this.callListId>0&&!this.isDesktop()){p.buttons.push("topClose")}break;case BX.PhoneCallView.UiState.redial:p.buttons=["redial"];break;case BX.PhoneCallView.UiState.externalCard:p.buttons=["close"];p.buttons.push("fold");break}return p};BX.PhoneCallView.prototype.renderButtons=function(){if(this.isFolded()){this.renderButtonsFolded()}else{this.renderButtonsDefault()}};BX.PhoneCallView.prototype.renderButtonsDefault=function(){var s=this;var r=document.createDocumentFragment();var u=document.createDocumentFragment();var q=document.createDocumentFragment();var t;var p={left:null,right:null};this.elements.buttons={};if(this.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.left=BX.create("div",{props:{className:"im-phone-call-buttons-container-left"}});p.right=BX.create("div",{props:{className:"im-phone-call-buttons-container-right"}});r.appendChild(p.left);r.appendChild(p.right)}this.buttons.forEach(function(v){switch(v){case"hold":t=s._renderSimpleButton("","im-phone-call-btn-hold",s._onHoldButtonClickHandler);if(s.isHeld()){BX.addClass(t,"active")}if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.left.appendChild(t)}else{r.appendChild(t)}break;case"mute":t=s._renderSimpleButton("","im-phone-call-btn-mute",s._onMuteButtonClickHandler);if(s.isMuted()){BX.addClass(t,"active")}if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.left.appendChild(t)}else{r.appendChild(t)}break;case"transfer":t=s._renderSimpleButton("","im-phone-call-btn-transfer",s._onTransferButtonClickHandler);if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.left.appendChild(t)}else{r.appendChild(t)}break;case"transferCancel":t=s._renderSimpleButton(BX.message("IM_M_CALL_BTN_RETURN"),"im-phone-call-btn im-phone-call-btn-blue im-phone-call-btn-arrow",s._onTransferCancelButtonClickHandler);r.appendChild(t);break;case"dialpad":t=s._renderSimpleButton("","im-phone-call-btn-dialpad",s._onDialpadButtonClickHandler);if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.left.appendChild(t)}else{r.appendChild(t)}break;case"call":t=s._renderSimpleButton(BX.message("IM_PHONE_CALL"),"im-phone-call-btn im-phone-call-btn-green",s._onMakeCallButtonClickHandler);r.appendChild(t);break;case"answer":t=s._renderSimpleButton(BX.message("IM_PHONE_BTN_ANSWER"),"im-phone-call-btn im-phone-call-btn-green",s._onAnswerButtonClickHandler);r.appendChild(t);break;case"skip":t=s._renderSimpleButton(BX.message("IM_PHONE_BTN_BUSY"),"im-phone-call-btn im-phone-call-btn-red",s._onSkipButtonClickHandler);r.appendChild(t);break;case"hangup":t=s._renderSimpleButton(BX.message("IM_M_CALL_BTN_HANGUP"),"im-phone-call-btn im-phone-call-btn-red  im-phone-call-btn-tube",s._onHangupButtonClickHandler);if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.right.appendChild(t)}else{r.appendChild(t)}break;case"close":t=s._renderSimpleButton(BX.message("IM_M_CALL_BTN_CLOSE"),"im-phone-call-btn im-phone-call-btn-red",s._onCloseButtonClickHandler);if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.right.appendChild(t)}else{r.appendChild(t)}break;case"topClose":if(!s.isDesktop()){t=BX.create("div",{props:{className:"im-phone-call-top-close-btn"},events:{click:s._onCloseButtonClickHandler}});q.appendChild(t)}break;case"notifyAdmin":t=s._renderSimpleButton(BX.message("IM_M_CALL_BTN_NOTIFY_ADMIN"),"im-phone-call-btn im-phone-call-btn-blue im-phone-call-btn-arrow",function(){s.callbacks.notifyAdmin()});r.appendChild(t);break;case"sipPhone":t=s._renderSimpleButton("",(s.deviceCall?"im-phone-call-btn-phone active":"im-phone-call-btn-phone"),s._onSwitchDeviceButtonClickHandler);if(s.buttonLayout==BX.PhoneCallView.ButtonLayouts.spaced){p.left.appendChild(t)}else{r.appendChild(t)}break;case"qualityMeter":t=BX.create("span",{props:{className:"im-phone-call-btn-signal"},events:{click:s._onQualityMeterClickHandler},children:[BX.create("span",{props:{className:"im-phone-call-btn-signal-icon-container"},children:[BX.create("span",{props:{className:"im-phone-call-btn-signal-background"}}),s.elements.qualityMeter=BX.create("span",{props:{className:"im-phone-call-btn-signal-active"},style:{width:s.getQualityMeterWidth()}})]})]});r.appendChild(t);break;case"settings":break;case"next":t=s._renderSimpleButton(BX.message("IM_M_CALL_BTN_NEXT"),"im-phone-call-btn im-phone-call-btn-gray im-phone-call-btn-arrow",s._onNextButtonClickHandler);r.appendChild(t);break;case"redial":t=s._renderSimpleButton(BX.message("IM_M_CALL_BTN_RECALL"),"im-phone-call-btn im-phone-call-btn-green",s._onMakeCallButtonClickHandler);r.appendChild(t);break;case"fold":if(!s.isDesktop()&&s.canBeFolded()){t=BX.create("div",{props:{className:"im-phone-btn-arrow"},text:BX.message("IM_PHONE_CALL_VIEW_FOLD"),events:{click:s._onFoldButtonClickHandler}});u.appendChild(t)}break;default:throw"Unknown button "+v}if(t){s.elements.buttons[v]=t}});if(this.elements.buttonsContainer){BX.cleanNode(this.elements.buttonsContainer);this.elements.buttonsContainer.appendChild(r)}if(this.elements.topButtonsContainer){BX.cleanNode(this.elements.topButtonsContainer);this.elements.topButtonsContainer.appendChild(u)}if(this.elements.topLevelButtonsContainer){BX.cleanNode(this.elements.topLevelButtonsContainer);this.elements.topLevelButtonsContainer.appendChild(q)}};BX.PhoneCallView.prototype.renderButtonsFolded=function(){var q=this;var p=document.createDocumentFragment();this.elements.buttons={};this.buttons.forEach(function(r){switch(r){case"hangup":buttonNode=q._renderSimpleButton(BX.message("IM_M_CALL_BTN_HANGUP"),"im-phone-call-panel-mini-cancel",q._onHangupButtonClickHandler);p.appendChild(buttonNode);break;case"close":buttonNode=q._renderSimpleButton(BX.message("IM_M_CALL_BTN_CLOSE"),"im-phone-call-panel-mini-cancel",q._onCloseButtonClickHandler);p.appendChild(buttonNode);break}});if(this.elements.buttonsContainer){BX.cleanNode(this.elements.buttonsContainer);this.elements.buttonsContainer.appendChild(p)}};BX.PhoneCallView.prototype.renderCrmButtons=function(){var q=this;var r;var p=document.createDocumentFragment();this.elements.crmButtons={};if(!this.elements.crmButtonsContainer){return}r=["addComment"];if(this.crmEntityType=="CONTACT"){r.push("addDeal");r.push("addInvoice")}else{if(this.crmEntityType=="COMPANY"){r.push("addDeal");r.push("addInvoice")}else{if(!this.crmEntityType&&this.config.CRM_CREATE=="none"){r.push("addLead");r.push("addContact")}}}if(r.length>0){r.forEach(function(s){var t;switch(s){case"addComment":t=BX.create("div",{props:{className:"im-phone-call-crm-button im-phone-call-crm-button-comment"+(q.commentShown?" im-phone-call-crm-button-active":"")},children:[q.elements.crmButtons.addCommentLabel=BX.create("div",{props:{className:"im-phone-call-crm-button-item"},text:q.commentShown?BX.message("IM_PHONE_CALL_VIEW_SAVE"):BX.message("IM_PHONE_ACTION_CRM_COMMENT")})],events:{click:q._onAddCommentButtonClick.bind(q)}});break;case"addDeal":t=BX.create("div",{props:{className:"im-phone-call-crm-button"},children:[BX.create("div",{props:{className:"im-phone-call-crm-button-item"},text:BX.message("IM_PHONE_ACTION_CRM_DEAL")})],events:{click:q._onAddDealButtonClick.bind(q)}});break;case"addInvoice":t=BX.create("div",{props:{className:"im-phone-call-crm-button"},children:[BX.create("div",{props:{className:"im-phone-call-crm-button-item"},text:BX.message("IM_PHONE_ACTION_CRM_INVOICE")})],events:{click:q._onAddInvoiceButtonClick.bind(q)}});break;case"addLead":t=BX.create("div",{props:{className:"im-phone-call-crm-button"},children:[BX.create("div",{props:{className:"im-phone-call-crm-button-item"},text:BX.message("IM_CRM_BTN_NEW_LEAD")})],events:{click:q._onAddLeadButtonClick.bind(q)}});break;case"addContact":t=BX.create("div",{props:{className:"im-phone-call-crm-button"},children:[BX.create("div",{props:{className:"im-phone-call-crm-button-item"},text:BX.message("IM_CRM_BTN_NEW_CONTACT")})],events:{click:q._onAddContactButtonClick.bind(q)}});break}if(t){p.appendChild(t);q.elements.crmButtons[s]=t}});BX.cleanNode(this.elements.crmButtonsContainer);this.elements.crmButtonsContainer.appendChild(p);this.showSections(["crmButtons"])}else{BX.cleanNode(this.elements.crmButtonsContainer);this.hideSections(["crmButtons"])}};BX.PhoneCallView.prototype._renderSimpleButton=function(s,q,p){var r={};if(s!=""){r.text=s}if(q!=""){r.props={className:q}}if(BX.type.isFunction(p)){r.events={click:p}}return BX.create("span",r)};BX.PhoneCallView.prototype.loadForm=function(p){if(!this.formManager){return}this.formManager.load({id:p.id,secCode:p.secCode})};BX.PhoneCallView.prototype.unloadForm=function(){if(!this.formManager){return}this.formManager.unload();BX.cleanNode(this.elements.tabsBody.webform)};BX.PhoneCallView.prototype._onFormSend=function(q){if(!this.callListView){return}var p=this.callListView.getCurrentElement();this.callListView.setWebformResult(p.ELEMENT_ID,q.resultId)};BX.PhoneCallView.prototype.loadRestApp=function(u){var q=this;var p=u.id;var r=u.callId;var s=u.node;if(this.restAppLayoutLoaded){BX.rest.AppLayout.getPlacement("CALL_CARD").load(p,this.getPlacementOptions());return}if(this.restAppLayoutLoading){return}this.restAppLayoutLoading=true;var t={sessid:BX.bitrix_sessid(),REST_APP_ID:p,PLACEMENT_OPTIONS:this.getPlacementOptions()};BX.ajax({url:"/bitrix/tools/voximplant/rest_app.php",method:"POST",dataType:"html",data:t,onsuccess:function(v){s.innerHTML=v;q.restAppLayoutLoaded=true;q.restAppLayoutLoading=false;q.restAppInterface=BX.rest.AppLayout.initializePlacement("CALL_CARD");q.initializeAppInterface(q.restAppInterface)}})};BX.PhoneCallView.prototype.unloadRestApps=function(){var p=BX.rest.AppLayout.getPlacement("CALL_CARD");if(this.restAppLayoutLoaded&&p){p.destroy();this.restAppLayoutLoaded=false}};BX.PhoneCallView.prototype.initializeAppInterface=function(p){p.prototype.events.push("CallCard::EntityChanged");p.prototype.events.push("CallCard::BeforeClose");p.prototype.events.push("CallCard::CallStateChanged");p.prototype.getStatus=function(r,q){q(this.getPlacementOptions())}.bind(this);p.prototype.disableAutoClose=function(r,q){this.disableAutoClose();q([])}.bind(this);p.prototype.enableAutoClose=function(r,q){this.enableAutoClose();q([])}.bind(this)};BX.PhoneCallView.prototype.getPlacementOptions=function(){return{CALL_ID:this.callId,PHONE_NUMBER:this.phoneNumber==="unknown"?undefined:this.phoneNumber,LINE_NUMBER:this.lineNumber,LINE_NAME:this.companyPhoneNumber,CRM_ENTITY_TYPE:this.crmEntityType,CRM_ENTITY_ID:this.crmEntityId,CRM_ACTIVITY_ID:this.crmActivityId===0?undefined:this.crmActivityId,CALL_DIRECTION:this.direction,CALL_STATE:this.callState,CALL_LIST_MODE:this.callListId>0}};BX.PhoneCallView.prototype.isUnloadAllowed=function(){return this.folded&&(this.deviceCall||this._uiState===BX.PhoneCallView.UiState.idle||this._uiState===BX.PhoneCallView.UiState.error||this._uiState===BX.PhoneCallView.UiState.externalCard)};BX.PhoneCallView.prototype._onBeforeUnload=function(p){if(!this.isUnloadAllowed()){p.returnValue=BX.message("IM_PHONE_CALL_VIEW_DONT_LEAVE");return BX.message("IM_PHONE_CALL_VIEW_DONT_LEAVE")}};BX.PhoneCallView.prototype._onDblClick=function(p){BX.PreventDefault(p);if(!this.isFolded()&&this.canBeFolded()){this.fold()}};BX.PhoneCallView.prototype._onHoldButtonClick=function(p){if(this.isHeld()){this.held=false;BX.removeClass(this.elements.buttons.hold,"active");if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onUnHold,[])}else{this.callbacks.unhold()}}else{this.held=true;BX.addClass(this.elements.buttons.hold,"active");if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onHold,[])}else{this.callbacks.hold()}}};BX.PhoneCallView.prototype._onMuteButtonClick=function(p){if(this.isMuted()){this.muted=false;BX.removeClass(this.elements.buttons.mute,"active");if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onUnMute,[])}else{this.callbacks.unmute()}}else{this.muted=true;BX.addClass(this.elements.buttons.mute,"active");if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onMute,[])}else{this.callbacks.mute()}}};BX.PhoneCallView.prototype._onTransferButtonClick=function(q){var p=this;this.transferPopup=o.create({bindElement:this.elements.buttons.transfer,BXIM:this.BXIM,onSelect:function(r){if(p.isDesktop()&&p.slave){BX.desktop.onCustomEvent(j.onStartTransfer,[r])}else{p.callbacks.transfer(r)}},onDestroy:function(){p.transferPopup=null}});this.transferPopup.show()};BX.PhoneCallView.prototype._onTransferCancelButtonClick=function(p){if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onCancelTransfer,[])}else{this.callbacks.cancelTransfer()}};BX.PhoneCallView.prototype._onDialpadButtonClick=function(q){var p=this;this.keypad=new n({bindElement:this.elements.buttons.dialpad,hideDial:true,onButtonClick:function(s){var r=s.key;if(p.isDesktop()&&p.slave){BX.desktop.onCustomEvent(j.onDialpadButtonClicked,[r])}else{p.callbacks.dialpadButtonClicked(r)}},onClose:function(r){p.keypad.destroy();p.keypad=null}});p.keypad.show()};BX.PhoneCallView.prototype._onHangupButtonClick=function(p){if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onHangup,[])}else{this.callbacks.hangup()}};BX.PhoneCallView.prototype._onCloseButtonClick=function(p){if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onClose,[])}else{this.close()}};BX.PhoneCallView.prototype._onMakeCallButtonClick=function(r){var q={};var p=this;if(this.callListId>0){this.callingEntity=this.currentEntity;if(this.currentEntity.phones.length==0){this.keypad=new n({bindElement:this.elements.buttons.call?this.elements.buttons.call:null,onClose:function(){p.keypad.destroy();p.keypad=null},onDial:function(s){p.keypad.close();p.phoneNumber=s.phoneNumber;p.setTitle(p.createTitle());q={phoneNumber:s.phoneNumber,crmEntityType:p.crmEntityType,crmEntityId:p.crmEntityId,callListId:p.callListId};if(p.isDesktop()&&p.slave){BX.desktop.onCustomEvent(j.onCallListMakeCall,[q])}else{p.callbacks.callListMakeCall(q)}}});this.keypad.show()}else{if(this.currentEntity.phones.length==1){q.phoneNumber=this.currentEntity.phones[0].VALUE;q.crmEntityType=this.crmEntityType;q.crmEntityId=this.crmEntityId;q.callListId=this.callListId;if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onCallListMakeCall,[q])}else{this.callbacks.callListMakeCall(q)}}else{this.showNumberSelectMenu({bindElement:this.elements.buttons.call?this.elements.buttons.call:null,phoneNumbers:this.currentEntity.phones,onSelect:function(s){p.closeNumberSelectMenu();p.phoneNumber=s.phoneNumber;p.setTitle(p.createTitle());q={phoneNumber:s.phoneNumber,crmEntityType:p.crmEntityType,crmEntityId:p.crmEntityId,callListId:p.callListId};if(p.isDesktop()&&p.slave){BX.desktop.onCustomEvent(j.onCallListMakeCall,[q])}else{p.callbacks.callListMakeCall(q)}}})}}}else{if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onMakeCall,[this.phoneNumber])}else{this.callbacks.makeCall(this.phoneNumber)}}};BX.PhoneCallView.prototype._onNextButtonClick=function(p){if(!this.callListView){return}this.setUiState(BX.PhoneCallView.UiState.outgoing);this.callListView.moveToNextItem();this.setStatusText("")};BX.PhoneCallView.prototype._onRedialButtonClick=function(p){};BX.PhoneCallView.prototype._onCommentChanged=function(p){this.comment=this.elements.commentEditor.value};BX.PhoneCallView.prototype._onAddCommentButtonClick=function(p){this.commentShown=!this.commentShown;if(this.commentShown){if(this.elements.crmButtons.addComment){BX.addClass(this.elements.crmButtons.addComment,"im-phone-call-crm-button-active");this.elements.crmButtons.addCommentLabel.innerText=BX.message("IM_PHONE_CALL_VIEW_SAVE")}if(this.elements.commentEditor){this.elements.commentEditor.focus()}if(this.elements.commentEditorContainer){this.elements.commentEditorContainer.style.removeProperty("display")}}else{if(this.elements.crmButtons.addComment){BX.removeClass(this.elements.crmButtons.addComment,"im-phone-call-crm-button-active");this.elements.crmButtons.addCommentLabel.innerText=BX.message("IM_PHONE_ACTION_CRM_COMMENT")}if(this.elements.commentEditorContainer){this.elements.commentEditorContainer.style.display="none"}if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onSaveComment,[this.comment])}else{this.saveComment()}}};BX.PhoneCallView.prototype._onAddDealButtonClick=function(r){var p=this._getCrmEditUrl("DEAL",0);var q=this._generateExternalContext();if(this.crmEntityType==="CONTACT"){p=BX.util.add_url_param(p,{contact_id:this.crmEntityId})}else{if(this.crmEntityType==="COMPANY"){p=BX.util.add_url_param(p,{company_id:this.crmEntityId})}}p=BX.util.add_url_param(p,{external_context:q});if(this.callListId>0){p=BX.util.add_url_param(p,{call_list_id:this.callListId});p=BX.util.add_url_param(p,{call_list_element:this.currentEntity.id})}this.externalRequests[q]={type:"add",context:q,window:window.open(p)}};BX.PhoneCallView.prototype._onAddInvoiceButtonClick=function(r){var p=this._getCrmEditUrl("INVOICE",0);var q=this._generateExternalContext();if(this.crmEntityType==="CONTACT"){p=BX.util.add_url_param(p,{contact:this.crmEntityId})}else{if(this.crmEntityType==="COMPANY"){p=BX.util.add_url_param(p,{company:this.crmEntityId})}}p=BX.util.add_url_param(p,{external_context:q});if(this.callListId>0){p=BX.util.add_url_param(p,{call_list_id:this.callListId});p=BX.util.add_url_param(p,{call_list_element:this.currentEntity.id})}this.externalRequests[q]={type:"add",context:q,window:window.open(p)}};BX.PhoneCallView.prototype._onAddLeadButtonClick=function(q){var p=this._getCrmEditUrl("LEAD",0);p=BX.util.add_url_param(p,{phone:this.phoneNumber,origin_id:"VI_"+this.callId});window.open(p)};BX.PhoneCallView.prototype._onAddContactButtonClick=function(q){var p=this._getCrmEditUrl("CONTACT",0);p=BX.util.add_url_param(p,{phone:this.phoneNumber,origin_id:"VI_"+this.callId});window.open(p)};BX.PhoneCallView.prototype._onFoldButtonClick=function(p){this.fold()};BX.PhoneCallView.prototype._onAnswerButtonClick=function(p){if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onAnswer,[])}else{this.callbacks.answer()}};BX.PhoneCallView.prototype._onSkipButtonClick=function(p){if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onSkip,[])}else{this.callbacks.skip()}};BX.PhoneCallView.prototype._onSwitchDeviceButtonClick=function(p){if(this.isDesktop()&&this.slave){BX.desktop.onCustomEvent(j.onSwitchDevice,[{phoneNumber:this.phoneNumber}])}else{this.callbacks.switchDevice({phoneNumber:this.phoneNumber})}};BX.PhoneCallView.prototype._onQualityMeterClick=function(q){var p=this;this.showQualityPopup({onSelect:function(r){p.qualityGrade=r;p.closeQualityPopup();if(p.isDesktop()&&p.slave){BX.desktop.onCustomEvent(j.onQualityGraded,[r])}else{p.callbacks.qualityGraded(r)}}})};BX.PhoneCallView.prototype._onExternalEvent=function(q){q=BX.type.isPlainObject(q)?q:{};q.key=q.key||"";var p=q.value||{};p.entityTypeName=p.entityTypeName||"";p.context=p.context||"";p.isCanceled=BX.type.isBoolean(p.isCanceled)?p.isCanceled:false;if(p.isCanceled){return}if(q.key==="onCrmEntityCreate"&&this.externalRequests[p.context]){if(this.externalRequests[p.context]){if(this.externalRequests[p.context]["type"]=="create"){this.crmEntityType=p.entityTypeName;this.crmEntityId=p.entityInfo.id;this.loadCrmCard(this.crmEntityType,this.crmEntityId)}else{if(this.externalRequests[p.context]["type"]=="add"){this.loadCrmCard(this.crmEntityType,this.crmEntityId)}}if(this.externalRequests[p.context]["window"]){this.externalRequests[p.context]["window"].close()}delete this.externalRequests[p.context]}}};BX.PhoneCallView.prototype._onPullEventCrm=function(u,t){if(u==="external_event"){if(t.NAME==="onCrmEntityCreate"&&t.IS_CANCELED==false){var s=t.PARAMS;if(this.externalRequests[s.context]){var r=s.entityTypeName;var p=s.entityInfo.id;if(this.callListView){var q=this.callListView.getCurrentElement()}}}}};BX.PhoneCallView.prototype.onCallListSelectedItem=function(p){this.currentEntity=p;this.crmEntityType=p.type;this.crmEntityId=p.id;if(p.phones.length>0){this.phoneNumber=p.phones[0].VALUE}else{this.phoneNumber="unknown"}this.setTitle(this.createTitle());this.loadCrmCard(p.type,p.id);if(this.currentTabName==="webform"){this.formManager.unload();this.formManager.load({id:this.webformId,secCode:this.webformSecCode})}if(this._uiState===BX.PhoneCallView.UiState.redial){this.setUiState(BX.PhoneCallView.UiState.outgoing)}this.updateView()};BX.PhoneCallView.prototype._onWindowUnload=function(){this.close()};BX.PhoneCallView.prototype.showCallIcon=function(){if(!this.callListView){return}if(!this.callingEntity){return}this.callListView.setCallingElement(this.callingEntity.statusId,this.callingEntity.index)};BX.PhoneCallView.prototype.hideCallIcon=function(){if(!this.callListView){return}this.callListView.resetCallingElement()};BX.PhoneCallView.prototype.startTimer=function(){if(this.timerInterval){return}if(this.initialTimestamp===0){this.initialTimestamp=(new Date()).getTime()}this.timerInterval=setInterval(this.renderTimer.bind(this),1000);this.renderTimer()};BX.PhoneCallView.prototype.renderTimer=function(){if(!this.elements.timer){return}var t=(new Date()).getTime();var p=(t-this.initialTimestamp);var r=Math.floor(p/1000);var q=Math.floor(r/60).toString();if(q.length<2){q="0"+q}var u=(r%60).toString();if(u.length<2){u="0"+u}var s=(this.isRecording()?BX.message("IM_PHONE_TIMER_WITH_RECORD"):BX.message("IM_PHONE_TIMER_WITHOUT_RECORD"));if(this.isFolded()){this.elements.timer.innerText=q+":"+u}else{this.elements.timer.innerText=s.replace("#MIN#",q).replace("#SEC#",u)}};BX.PhoneCallView.prototype.stopTimer=function(){if(!this.timerInterval){return}clearInterval(this.timerInterval);this.timerInterval=null};BX.PhoneCallView.prototype.showQualityPopup=function(s){if(!BX.type.isPlainObject(s)){s={}}if(!BX.type.isFunction(s.onSelect)){s.onSelect=BX.DoNothing}var p=this;var q={"1":null,"2":null,"3":null,"4":null,"5":null};var r=function(t){return BX.create("div",{props:{className:"im-phone-popup-rating-stars-item "+(p.qualityGrade==t?"im-phone-popup-rating-stars-item-active":"")},dataset:{grade:t},events:{click:function(v){BX.PreventDefault(v);var u=v.currentTarget.dataset.grade;s.onSelect(u)}}})};this.qualityPopup=new BX.PopupWindow("PhoneCallViewQualityGrade",this.elements.qualityMeter,{darkMode:true,closeByEsc:true,autoHide:true,zIndex:d+200,noAllPaddings:true,overlay:{backgroundColor:"white",opacity:0},bindOptions:{position:"top"},angle:{position:"bottom",offset:30},content:BX.create("div",{props:{className:"im-phone-popup-rating"},children:[BX.create("div",{props:{className:"im-phone-popup-rating-title"},text:BX.message("IM_PHONE_CALL_VIEW_RATE_QUALITY")}),BX.create("div",{props:{className:"im-phone-popup-rating-stars"},children:[q["1"]=r(1),q["2"]=r(2),q["3"]=r(3),q["4"]=r(4),q["5"]=r(5)],events:{mouseover:function(){if(q[p.qualityGrade]){BX.removeClass(q[p.qualityGrade],"im-phone-popup-rating-stars-item-active")}},mouseout:function(){if(q[p.qualityGrade]){BX.addClass(q[p.qualityGrade],"im-phone-popup-rating-stars-item-active")}}}})]}),events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){p.qualityPopup=null}}});this.qualityPopup.show()};BX.PhoneCallView.prototype.closeQualityPopup=function(){if(this.qualityPopup){this.qualityPopup.close()}};BX.PhoneCallView.prototype.saveComment=function(){BX.MessengerCommon.phoneCommand("saveComment",{CALL_ID:this.callId,COMMENT:this.comment})};BX.PhoneCallView.prototype.showNumberSelectMenu=function(r){var p=this;var q=[];if(!BX.type.isPlainObject(r)){r={}}if(!BX.type.isArray(r.phoneNumbers)){return}r.onSelect=BX.type.isFunction(r.onSelect)?r.onSelect:BX.DoNothing;r.phoneNumbers.forEach(function(s){q.push({id:"number-select-"+BX.util.getRandomString(10),text:s.VALUE,onclick:function(){r.onSelect({phoneNumber:s.VALUE})}})});this.numberSelectMenu=BX.PopupMenu.create("im-phone-call-view-number-select",r.bindElement,q,{autoHide:true,offsetTop:0,offsetLeft:40,angle:{position:"top"},zIndex:d+200,closeByEsc:true,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function(){p.numberSelectMenu.popupWindow.destroy();BX.PopupMenu.destroy("im-phone-call-view-number-select")},onPopupDestroy:function(){p.numberSelectMenu=null}}});this.numberSelectMenu.popupWindow.show()};BX.PhoneCallView.prototype.closeNumberSelectMenu=function(){if(this.numberSelectMenu){this.numberSelectMenu.popupWindow.close()}};BX.PhoneCallView.prototype.fold=function(){if(!this.canBeFolded()){return false}if(this.callListId>0&&this.callState===BX.PhoneCallView.CallState.idle){this.foldCallView()}else{this.foldCall()}};BX.PhoneCallView.prototype.unfold=function(){if(!this.isDesktop()&&this.isFolded()){BX.cleanNode(this.elements.main,true);this.folded=false;this.elements=this.unfoldedElements;this.show()}};BX.PhoneCallView.prototype.foldCall=function(){if(this.isDesktop()||!this.popup){return}var p=this;var r=this.popup.popupContainer;var q=this.popup.overlay.element;BX.addClass(r,"im-phone-call-view-folding");BX.addClass(q,"popup-window-overlay-im-phone-call-view-folding");setTimeout(function(){p.folded=true;p.popup.close();p.unfoldedElements=p.elements;BX.removeClass(r,"im-phone-call-view-folding");BX.removeClass(q,"popup-window-overlay-im-phone-call-view-folding");p.reinit();p.enableDocumentScroll()},300)};BX.PhoneCallView.prototype.foldCallView=function(){var p=this;var q=BX.FoldedCallView.getInstance();var s=this.popup.popupContainer;var r=this.popup.overlay.element;BX.addClass(s,"im-phone-call-view-folding");BX.addClass(r,"popup-window-overlay-im-phone-call-view-folding");setTimeout(function(){p.close();q.fold({callListId:p.callListId,webformId:p.webformId,webformSecCode:p.webformSecCode,currentItemIndex:p.callListView.currentItemIndex,currentItemStatusId:p.callListView.currentStatusId,statusList:p.callListView.statuses,entityType:p.callListView.entityType},true)},300)};BX.PhoneCallView.prototype.bindSlaveDesktopEvents=function(){var p=this;BX.desktop.addCustomEvent(j.setTitle,this.setTitle.bind(this));BX.desktop.addCustomEvent(j.setStatus,this.setStatusText.bind(this));BX.desktop.addCustomEvent(j.setUiState,this.setUiState.bind(this));BX.desktop.addCustomEvent(j.setDeviceCall,this.setDeviceCall.bind(this));BX.desktop.addCustomEvent(j.setCrmEntity,this.setCrmEntity.bind(this));BX.desktop.addCustomEvent(j.reloadCrmCard,this.reloadCrmCard.bind(this));BX.desktop.addCustomEvent(j.setPortalCall,this.setPortalCall.bind(this));BX.desktop.addCustomEvent(j.setPortalCallUserId,this.setPortalCallUserId.bind(this));BX.desktop.addCustomEvent(j.setPortalCallData,this.setPortalCallData.bind(this));BX.desktop.addCustomEvent(j.setConfig,this.setConfig.bind(this));BX.desktop.addCustomEvent(j.setCallId,this.setCallId.bind(this));BX.desktop.addCustomEvent(j.setLineNumber,this.setLineNumber.bind(this));BX.desktop.addCustomEvent(j.setCompanyPhoneNumber,this.setCompanyPhoneNumber.bind(this));BX.desktop.addCustomEvent(j.setCallState,this.setCallState.bind(this));BX.desktop.addCustomEvent(j.closeWindow,function(){window.close()});BX.bind(window,"beforeunload",function(){BX.unbindAll(window,"beforeunload");BX.desktop.onCustomEvent(j.onBeforeUnload,[])});BX.bind(window,"resize",BX.debounce(function(q){if(p.skipOnResize){p.skipOnResize=false;return}p.saveInitialSize(window.innerWidth,window.innerHeight)},100,this));BX.addCustomEvent("SidePanel.Slider:onOpen",function(q){if(!q.getSlider().isSelfContained()){q.denyAction();window.open(q.slider.url)}})};BX.PhoneCallView.prototype.bindMasterDesktopEvents=function(){var p=this;BX.desktop.addCustomEvent(j.onHold,function(){p.callbacks.hold()});BX.desktop.addCustomEvent(j.onUnHold,function(){p.callbacks.unhold()});BX.desktop.addCustomEvent(j.onMute,function(){p.callbacks.mute()});BX.desktop.addCustomEvent(j.onUnMute,function(){p.callbacks.unmute()});BX.desktop.addCustomEvent(j.onMakeCall,function(q){p.callbacks.makeCall(q)});BX.desktop.addCustomEvent(j.onCallListMakeCall,function(q){p.callbacks.callListMakeCall(q)});BX.desktop.addCustomEvent(j.onAnswer,function(){p.callbacks.answer()});BX.desktop.addCustomEvent(j.onSkip,function(){p.callbacks.skip()});BX.desktop.addCustomEvent(j.onHangup,function(){p.callbacks.hangup()});BX.desktop.addCustomEvent(j.onClose,function(){p.close()});BX.desktop.addCustomEvent(j.onStartTransfer,function(q){p.callbacks.transfer(q)});BX.desktop.addCustomEvent(j.onCancelTransfer,function(){p.callbacks.cancelTransfer()});BX.desktop.addCustomEvent(j.onSwitchDevice,function(q){p.callbacks.switchDevice(q)});BX.desktop.addCustomEvent(j.onBeforeUnload,function(){p.desktop.window=null;p.callbacks.hangup();p.callbacks.close()});BX.desktop.addCustomEvent(j.onQualityGraded,function(q){p.callbacks.qualityGraded(q)});BX.desktop.addCustomEvent(j.onDialpadButtonClicked,function(q){p.callbacks.dialpadButtonClicked(q)});BX.desktop.addCustomEvent(j.onSaveComment,function(q){p.comment=q;p.saveComment()})};BX.PhoneCallView.prototype.unbindDesktopEvents=function(){for(eventId in j){if(j.hasOwnProperty(eventId)){BX.desktop.removeCustomEvents(j[eventId])}}};BX.PhoneCallView.prototype.isDesktop=function(){return BX.MessengerCommon.isDesktop()};BX.PhoneCallView.prototype.isFolded=function(){return this.folded};BX.PhoneCallView.prototype.canBeFolded=function(){return this.allowAutoClose&&(this.callState===BX.PhoneCallView.CallState.connected||(this.callState===BX.PhoneCallView.CallState.idle&&this.callListId>0))};BX.PhoneCallView.prototype.getFoldedHeight=function(){if(!this.folded){return 0}if(!this.elements.main){return 0}return this.elements.main.clientHeight+(this.elements.sections.status?this.elements.sections.status.clientHeight:0)};BX.PhoneCallView.prototype.isWebformSupported=function(){return(!this.isDesktop()||this.desktop.isFeatureSupported("iframe"))};BX.PhoneCallView.prototype.isRestAppsSupported=function(){return(!this.isDesktop()||this.desktop.isFeatureSupported("iframe"))};BX.PhoneCallView.prototype.setClosable=function(p){p=(p==true);this.closable=p;if(this.isDesktop()){}else{if(this.popup){this.popup.setClosingByEsc(p)}}};BX.PhoneCallView.prototype.isClosable=function(){return this.closable};BX.PhoneCallView.prototype.adjust=function(){if(this.popup){this.popup.adjustPosition()}if(this.isDesktop()&&this.slave){if(this.currentLayout==k.simple){this.desktop.setResizable(false)}else{this.desktop.setResizable(true);this.desktop.setMinSize((this.elements.sidebarContainer?900:550),650)}this.desktop.center()}};BX.PhoneCallView.prototype.resizeWindow=function(q,p){if(!this.isDesktop()||!this.slave){return false}this.skipOnResize=true;this.desktop.resize(q,p)};BX.PhoneCallView.prototype.close=function(){BX.onCustomEvent(window,"CallCard::BeforeClose",[]);if(this.isFolded()&&this.elements.main){BX.addClass(this.elements.main,"im-phone-call-panel-mini-closing");setTimeout(function(){BX.cleanNode(this.elements.main,true);this.elements=this.getInitialElements()}.bind(this),300)}if(this.popup){this.popup.close()}if(this.desktop.window){BX.desktop.onCustomEvent(j.closeWindow,[])}this.enableDocumentScroll();this.callbacks.close();BX.onCustomEvent(window,"CallCard::AfterClose",[])};BX.PhoneCallView.prototype.disableAutoClose=function(){this.allowAutoClose=false;this.renderButtons()};BX.PhoneCallView.prototype.enableAutoClose=function(){this.allowAutoClose=true;this.renderButtons()};BX.PhoneCallView.prototype.autoClose=function(){if(this.allowAutoClose&&!this.commentShown){this.close()}else{BX.onCustomEvent(window,"CallCard::BeforeClose",[])}};BX.PhoneCallView.prototype.disableDocumentScroll=function(){var p=window.innerWidth-document.documentElement.clientWidth;document.body.style.setProperty("padding-right",p+"px");document.body.classList.add("im-phone-call-disable-scroll");var q=BX("bx-im-bar");if(q){q.style.setProperty("right",p+"px")}};BX.PhoneCallView.prototype.enableDocumentScroll=function(){document.body.classList.remove("im-phone-call-disable-scroll");document.body.style.removeProperty("padding-right");var p=BX("bx-im-bar");if(p){p.style.removeProperty("right")}};BX.PhoneCallView.prototype.dispose=function(){window.removeEventListener("beforeunload",this._onBeforeUnloadHandler);BX.removeCustomEvent("onPullEvent-crm",this._onPullEventCrmHandler);this.unloadRestApps();this.unloadForm();if(this.isFolded()&&this.elements.main){BX.addClass(this.elements.main,"im-phone-call-panel-mini-closing");setTimeout(function(){BX.cleanNode(this.elements.main,true)}.bind(this),300)}if(this.popup){this.popup.destroy();this.popup=null}if(this.qualityPopup){this.qualityPopup.close()}if(this.transferPopup){this.transferPopup.close()}if(this.keypad){this.keypad.close()}if(this.numberSelectMenu){this.closeNumberSelectMenu()}if(this.isDesktop()){this.unbindDesktopEvents();if(this.desktop.window){BX.desktop.onCustomEvent(j.closeWindow,[]);this.desktop.window=null}if(!this.slave){window.removeEventListener("beforeunload",this._unloadHandler)}}else{window.removeEventListener("beforeunload",this._onBeforeUnloadHandler)}};BX.PhoneCallView.prototype.canBeUnloaded=function(){return this.allowAutoClose&&this.isFolded()};BX.PhoneCallView.prototype.getState=function(){return{callId:this.callId,folded:this.folded,uiState:this._uiState,phoneNumber:this.phoneNumber,companyPhoneNumber:this.companyPhoneNumber,direction:this.direction,fromUserId:this.fromUserId,toUserId:this.toUserId,statusText:this.statusText,crm:this.crm,hasSipPhone:this.hasSipPhone,deviceCall:this.deviceCall,transfer:this.transfer,callback:this.callback,crmEntityType:this.crmEntityType,crmEntityId:this.crmEntityId,crmActivityId:this.crmActivityId,crmActivityEditUrl:this.crmActivityEditUrl,callListId:this.callListId,callListStatusId:this.callListStatusId,callListItemIndex:this.callListItemIndex,config:(this.config?this.config:"{}"),portalCall:(this.portalCall?"true":"false"),portalCallData:(this.portalCallData?this.portalCallData:"{}"),portalCallUserId:this.portalCallUserId,webformId:this.webformId,webformSecCode:this.webformSecCode,initialTimestamp:this.initialTimestamp,crmData:this.crmData}};BX.PhoneCallView.Direction={incoming:"incoming",outgoing:"outgoing",incomingTransfer:"incomingTransfer",callback:"callback"};BX.PhoneCallView.UiState={incoming:1,transferIncoming:2,outgoing:3,connectingIncoming:4,connectingOutgoing:5,connected:6,transferring:7,idle:8,error:9,moneyError:10,sipPhoneError:11,redial:12,externalCard:13};BX.PhoneCallView.CallState={idle:"idle",connecting:"connecting",connected:"connected"};var c={iframe:39};var i=function(p){this.BXIM=p.BXIM;this.parentPhoneCallView=p.parentPhoneCallView;this.closable=p.closable;this.title=p.title||"";this.window=null};i.prototype.openCallWindow=function(p,q,r){if(!BX.MessengerCommon.isDesktop()){return false}r=r||{};if(r.minSettingsWidth){this.minSettingsWidth=r.minSettingsWidth}if(r.minSettingsHeight){this.minSettingsHeight=r.minSettingsHeight}r.resizable=(r.resizable==true);BX.desktop.createWindow("callWindow",BX.delegate(function(s){s.SetProperty("clientSize",{Width:r.width,Height:r.height});s.SetProperty("resizable",r.resizable);if(r.resizable&&r.hasOwnProperty("minWidth")&&r.hasOwnProperty("minHeight")){s.SetProperty("minClientSize",{Width:r.minWidth,Height:r.minHeight})}s.SetProperty("title",this.title);s.SetProperty("closable",true);s.ExecuteCommand("html.load",this.getHtmlPage(p,q,{}));this.window=s},this))};i.prototype.setClosable=function(p){this.closable=(p==true);if(this.window){this.window.SetProperty("closable",this.closable)}};i.prototype.setTitle=function(p){this.title=p;if(this.window){this.window.SetProperty("title",p)}};i.prototype.getHtmlPage=function(r,u,p,q){if(!BX.MessengerCommon.isDesktop()){return}r=r||"";u=u||"";q=q||"";var t=typeof(p)=="undefined"||typeof(p)!="object"?{}:p;p=typeof(p)!="undefined";if(this.htmlWrapperHead==null){this.htmlWrapperHead=document.head.outerHTML.replace(/BX\.PULL\.start\([^)]*\);/g,"")}if(r!=""&&BX.type.isDomNode(r)){r=r.outerHTML}if(u!=""&&BX.type.isDomNode(u)){u=u.outerHTML}if(u!=""){u='<script type="text/javascript">BX.ready(function(){'+u+"});<\/script>"}var s="";if(p==true){s="<script type=\"text/javascript\">BX.ready(function() {BXIM = new BX.IM(null, {'init': false,'colors' : "+(this.BXIM.colors?JSON.stringify(this.BXIM.colors):"false")+",'settings' : "+JSON.stringify(this.BXIM.settings)+",'settingsView' : "+JSON.stringify(this.BXIM.settingsView)+",'updateStateInterval': '"+this.BXIM.updateStateInterval+"','desktop': "+BX.MessengerCommon.isPage()+",'desktopVersion': "+this.BXIM.desktopVersion+",'ppStatus': false,'ppServerStatus': false,'xmppStatus': "+this.BXIM.xmppStatus+",'bitrixNetwork': "+this.BXIM.bitrixNetwork+",'bitrixNetwork2': "+this.BXIM.bitrixNetwork2+",'bitrixOpenLines': "+this.BXIM.bitrixOpenLines+",'bitrix24': "+this.BXIM.bitrix24+",'bitrixIntranet': "+this.BXIM.bitrixIntranet+",'bitrixXmpp': "+this.BXIM.bitrixXmpp+",'bitrixMobile': "+this.BXIM.bitrixMobile+",'files' : "+(t.files?JSON.stringify(t.files):"{}")+",'notify' : "+(t.notify?JSON.stringify(t.notify):"{}")+",'users' : "+(t.users?JSON.stringify(t.users):"{}")+",'chat' : "+(t.chat?JSON.stringify(t.chat):"{}")+",'userChat' : "+(t.userChat?JSON.stringify(t.userChat):"{}")+",'userInChat' : "+(t.userInChat?JSON.stringify(t.userInChat):"{}")+",'hrphoto' : "+(t.hrphoto?JSON.stringify(t.hrphoto):"{}")+",'phoneCrm' : "+(t.phoneCrm?JSON.stringify(t.phoneCrm):"{}")+",'generalChatId': "+this.BXIM.messenger.generalChatId+",'canSendMessageGeneralChat': "+this.BXIM.messenger.canSendMessageGeneralChat+",'userId': "+this.BXIM.userId+",'userEmail': '"+this.BXIM.userEmail+"','userColor': '"+this.BXIM.userColor+"','userGender': '"+this.BXIM.userGender+"','userExtranet': "+this.BXIM.userExtranet+",'disk': {'enable': "+(this.disk?this.disk.enable:false)+"},'path' : "+JSON.stringify(this.BXIM.path)+"});BXIM.messenger.contactListLoad = false;BX.PhoneCallView.setDefaults("+JSON.stringify(e)+");PCW = new BX.PhoneCallView({'slave': true, 'skipOnResize': true, 'callId': '"+this.parentPhoneCallView.callId+"','uiState': "+this.parentPhoneCallView._uiState+",'phoneNumber': '"+this.parentPhoneCallView.phoneNumber+"','companyPhoneNumber': '"+this.parentPhoneCallView.companyPhoneNumber+"','direction': '"+this.parentPhoneCallView.direction+"','fromUserId': '"+this.parentPhoneCallView.fromUserId+"','toUserId': '"+this.parentPhoneCallView.toUserId+"','crm': "+this.parentPhoneCallView.crm+",'hasSipPhone': "+this.parentPhoneCallView.hasSipPhone+",'deviceCall': "+this.parentPhoneCallView.deviceCall+",'transfer': "+this.parentPhoneCallView.transfer+",'callback': "+this.parentPhoneCallView.callback+",'crmEntityType': '"+this.parentPhoneCallView.crmEntityType+"','crmEntityId': '"+this.parentPhoneCallView.crmEntityId+"','crmActivityId': '"+this.parentPhoneCallView.crmActivityId+"','crmActivityEditUrl': '"+this.parentPhoneCallView.crmActivityEditUrl+"','callListId': "+this.parentPhoneCallView.callListId+",'callListStatusId': '"+this.parentPhoneCallView.callListStatusId+"','callListItemIndex': "+this.parentPhoneCallView.callListItemIndex+",'config': "+(this.parentPhoneCallView.config?JSON.stringify(this.parentPhoneCallView.config):"{}")+",'portalCall': "+(this.parentPhoneCallView.portalCall?"true":"false")+",'portalCallData': "+(this.parentPhoneCallView.portalCallData?JSON.stringify(this.parentPhoneCallView.portalCallData):"{}")+",'portalCallUserId': "+this.parentPhoneCallView.portalCallUserId+",'webformId': "+this.parentPhoneCallView.webformId+",'webformSecCode': '"+this.parentPhoneCallView.webformSecCode+"'});});<\/script>"}return"<!DOCTYPE html><html>"+this.htmlWrapperHead+'<body class="im-desktop im-desktop-popup '+q+'"><div id="placeholder-messanger">'+r+"</div>"+s+u+"</body></html>"};i.prototype.addCustomEvent=function(p,q){if(!BX.MessengerCommon.isDesktop()){return false}BX.desktop.addCustomEvent(p,q)};i.prototype.onCustomEvent=function(r,q,p){if(!BX.MessengerCommon.isDesktop()){return false}BX.desktop.onCustomEvent(r,q,p)};i.prototype.resize=function(q,p){BXDesktopWindow.SetProperty("clientSize",{Width:q,Height:p})};i.prototype.setResizable=function(p){p=(p==true);BXDesktopWindow.SetProperty("resizable",p)};i.prototype.setMinSize=function(q,p){BXDesktopWindow.SetProperty("minClientSize",{Width:q,Height:p})};i.prototype.setWindowPosition=function(p){BXDesktopWindow.SetProperty("position",p)};i.prototype.center=function(){BXDesktopWindow.ExecuteCommand("center")};i.prototype.getVersion=function(p){if(typeof(BXDesktopSystem)=="undefined"){return 0}if(!this.clientVersion){this.clientVersion=BXDesktopSystem.GetProperty("versionParts")}return p?this.clientVersion.join("."):this.clientVersion[3]};i.prototype.isFeatureSupported=function(p){if(!c.hasOwnProperty(p)){return false}return this.getVersion()>=c[p]};var a=function(p){this.node=p.node;this.id=p.id;this.entityType="";this.statuses={};this.elements={};this.currentStatusId=p.callListStatusId||"IN_WORK";this.currentItemIndex=p.itemIndex||0;this.callingStatusId=null;this.callingItemIndex=null;this.selectionLocked=false;this.itemActionMenu=null;this.callbacks={onError:BX.type.isFunction(p.onError)?p.onError:f,onSelectedItem:BX.type.isFunction(p.onSelectedItem)?p.onSelectedItem:f};this.showLimit=10;this.showDelta=10};a.getAjaxUrl=function(){return(BX.MessengerCommon.isDesktop()?"/desktop_app/call_list.ajax.php":"/bitrix/components/bitrix/crm.activity.call_list/ajax.php")};a.prototype.init=function(q){if(!BX.type.isFunction(q)){q=BX.DoNothing}var p=this;this.load(function(){if(p.statuses[p.currentStatusId].ITEMS.length>0){p.render();p.selectItem(p.currentStatusId,p.currentItemIndex);q()}else{BX.debug("empty call list. don't know what to do")}})};a.prototype.reinit=function(p){if(BX.type.isDomNode(p.node)){this.node=p.node}this.render();this.selectItem(this.currentStatusId,this.currentItemIndex);if(this.callingStatusId!==null&&this.callingItemIndex!==null){this.setCallingElement(this.callingStatusId,this.callingItemIndex)}};a.prototype.load=function(q){var p=this;var r={sessid:BX.bitrix_sessid(),ajax_action:"GET_CALL_LIST",callListId:this.id};BX.ajax({url:a.getAjaxUrl(),method:"POST",dataType:"json",data:r,onsuccess:function(s){if(!s.ERROR){if(BX.type.isArray(s.STATUSES)){s.STATUSES.forEach(function(t){p.statuses[t.STATUS_ID]=t;p.statuses[t.STATUS_ID].ITEMS=[]});s.ITEMS.forEach(function(t){p.statuses[t.STATUS_ID].ITEMS.push(t)})}p.entityType=s.ENTITY_TYPE;if(p.statuses[p.currentStatusId].ITEMS.length==0){p.currentStatusId=p.getNonEmptyStatusId();p.currentItemIndex=0}q()}else{console.log(s)}}})};a.prototype.selectItem=function(s,r){var q=this.statuses[this.currentStatusId].ITEMS[this.currentItemIndex]._node;BX.removeClass(q,"im-phone-call-list-customer-block-active");if(this.itemActionMenu){this.itemActionMenu.close()}this.currentStatusId=s;this.currentItemIndex=r;q=this.statuses[this.currentStatusId].ITEMS[this.currentItemIndex]._node;BX.addClass(q,"im-phone-call-list-customer-block-active");var p=this.statuses[s].ITEMS[r];if((this.entityType=="DEAL"||this.entityType=="QUOTE"||this.entityType=="INVOICE")&&p.ASSOCIATED_ENTITY){this.callbacks.onSelectedItem({type:p.ASSOCIATED_ENTITY.TYPE,id:p.ASSOCIATED_ENTITY.ID,phones:p.ASSOCIATED_ENTITY.PHONES,statusId:s,index:r})}else{this.callbacks.onSelectedItem({type:this.entityType,id:p.ELEMENT_ID,phones:p.PHONES,statusId:s,index:r})}};a.prototype.moveToNextItem=function(){var p=this.currentItemIndex+1;if(p>=this.statuses[this.currentStatusId].ITEMS.length){p=0}this.selectItem(this.currentStatusId,p)};a.prototype.setCallingElement=function(q,p){this.callingStatusId=q;this.callingItemIndex=p;currentNode=this.statuses[this.callingStatusId].ITEMS[this.callingItemIndex]._node;BX.addClass(currentNode,"im-phone-call-list-customer-block-calling");this.selectionLocked=true};a.prototype.resetCallingElement=function(){if(this.callingStatusId===null||this.callingItemIndex===null){return}currentNode=this.statuses[this.callingStatusId].ITEMS[this.callingItemIndex]._node;BX.removeClass(currentNode,"im-phone-call-list-customer-block-calling");this.callingStatusId=null;this.callingItemIndex=null;this.selectionLocked=false};a.prototype.render=function(){BX.cleanNode(this.node);var p=BX.create("div",{props:{className:"im-phone-call-list-container"},children:this.renderStatusBlocks()});this.node.appendChild(p)};a.prototype.renderStatusBlocks=function(){var r=this;var p=[];var t;var s;for(t in this.statuses){var q=this.statuses[t];if(q.ITEMS.length==0){continue}q._node=this.renderStatusBlock(q);p.push(q._node)}return p};a.prototype.renderStatusBlock=function(q){var p;var t;var s;var r=q.STATUS_ID;if(!q.hasOwnProperty("_folded")){q._folded=false}className="im-phone-call-list-block";if(q.CLASS!=""){className=className+" "+q.CLASS}return BX.create("div",{props:{className:className},children:[BX.create("div",{props:{className:"im-phone-call-list-block-title"+(q._folded?"":" active")},children:[BX.create("span",{text:this.getStatusTitle(r)}),BX.create("div",{props:{className:"im-phone-call-list-block-title-arrow"}})],events:{click:function(u){clearTimeout(p);q._folded=!q._folded;if(q._folded){BX.removeClass(u.target,"active");t.style.height=s.clientHeight.toString()+"px";p=setTimeout(function(){t.style.height=0},50)}else{BX.addClass(u.target,"active");t.style.height=0;p=setTimeout(function(){t.style.height=s.clientHeight+"px"},50)}BX.PreventDefault(u)}}}),t=BX.create("div",{props:{className:"im-phone-call-list-items-block"},children:[s=BX.create("div",{props:{className:"im-phone-call-list-items-measuring"},children:this.renderCallListItems(r)})],events:{transitionend:function(){if(!q._folded){t.style.removeProperty("height")}}}})]})};a.prototype.renderCallListItems=function(s){var p=[];var q=this.statuses[s];if(q._shownCount>0){if(q._shownCount>q.ITEMS.length){q._shownCount=q.ITEMS.length}}else{q._shownCount=Math.min(this.showLimit,q.ITEMS.length)}for(var r=0;r<q._shownCount;r++){p.push(this.renderCallListItem(q.ITEMS[r],s,r))}if(q.ITEMS.length>q._shownCount){q._showMoreNode=BX.create("div",{props:{className:"im-phone-call-list-show-more-wrap"},children:[BX.create("span",{props:{className:"im-phone-call-list-show-more-button"},dataset:{statusId:s},text:BX.message("IM_PHONE_CALL_LIST_MORE").replace("#COUNT#",(q.ITEMS.length-q._shownCount)),events:{click:this.onShowMoreClick.bind(this)}})]});p.push(q._showMoreNode)}else{q._showMoreNode=null}return p};a.prototype.renderCallListItem=function(s,u,r){var q=this.statuses[u].NAME;var p=this;var t="";if(BX.type.isArray(s.PHONES)){s.PHONES.forEach(function(v,w){if(w!=0){t+="; "}t+=BX.util.htmlspecialchars(v.VALUE)})}s._node=BX.create("div",{props:{className:(this.currentStatusId==u&&this.currentItemIndex==r?"im-phone-call-list-customer-block im-phone-call-list-customer-block-active":"im-phone-call-list-customer-block")},children:[BX.create("div",{props:{className:"im-phone-call-list-customer-block-action"},children:[BX.create("span",{text:q})],events:{click:function(v){if(p.itemActionMenu){p.itemActionMenu.popupWindow.close()}else{p.showItemMenu(s,v.target)}BX.PreventDefault(v)}}}),BX.create("div",{props:{className:"im-phone-call-list-item-customer-name"+(s.ASSOCIATED_ENTITY?" im-phone-call-list-connection-line":"")},children:[BX.create("a",{attrs:{href:s.EDIT_URL,target:"_blank"},props:{className:"im-phone-call-list-item-customer-link"},text:s.NAME,events:{click:function(v){window.open(s.EDIT_URL);BX.PreventDefault(v)}}})]}),(s.POST?BX.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:s.POST}):null),(s.COMPANY_TITLE?BX.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:s.COMPANY_TITLE}):null),(t?BX.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:t}):null),(s.ASSOCIATED_ENTITY?this.renderAssociatedEntity(s.ASSOCIATED_ENTITY):null)],events:{click:function(){if(!p.selectionLocked&&(p.currentStatusId!=s.STATUS_ID||p.currentItemIndex!=r)){p.selectItem(s.STATUS_ID,r)}}}});return s._node};a.prototype.renderAssociatedEntity=function(p){var q="";if(BX.type.isArray(p.PHONES)){p.PHONES.forEach(function(r,s){if(s!=0){q+="; "}q+=BX.util.htmlspecialchars(r.VALUE)})}return BX.create("div",{props:{className:"im-phone-call-list-item-customer-entity im-phone-call-list-connection-line-item"},children:[BX.create("a",{attrs:{href:p.EDIT_URL,target:"_blank"},props:{className:"im-phone-call-list-item-customer-link"},text:p.NAME,events:{click:function(r){window.open(p.EDIT_URL);BX.PreventDefault(r)}}}),BX.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:p.POST}),BX.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:p.COMPANY_TITLE}),(q?BX.create("div",{props:{className:"im-phone-call-list-item-customer-info"},text:q}):null)]})};a.prototype.onShowMoreClick=function(r){var s=r.target.dataset.statusId;var q=this.statuses[s];q._shownCount+=this.showDelta;if(q._shownCount>q.ITEMS.length){q._shownCount=q.ITEMS.length}var p=this.renderStatusBlock(q);q._node.parentNode.replaceChild(p,q._node);q._node=p};a.prototype.showItemMenu=function(r,t){var p=this;var q=[];var s;for(statusId in this.statuses){s={id:"setStatus_"+statusId,text:this.statuses[statusId].NAME,onclick:this.actionMenuItemClickHandler(r.ELEMENT_ID,statusId).bind(this)};q.push(s)}q.push({id:"callListItemActionMenu_delimiter",delimiter:true});q.push({id:"defer15min",text:BX.message("IM_PHONE_CALL_VIEW_CALL_LIST_DEFER_15_MIN"),onclick:function(){p.itemActionMenu.popupWindow.close();p.setElementRank(r.ELEMENT_ID,r.RANK+35)}});q.push({id:"defer1hour",text:BX.message("IM_PHONE_CALL_VIEW_CALL_LIST_DEFER_HOUR"),onclick:function(){p.itemActionMenu.popupWindow.close();p.setElementRank(r.ELEMENT_ID,r.RANK+185)}});q.push({id:"moveToEnd",text:BX.message("IM_PHONE_CALL_VIEW_CALL_LIST_TO_END"),onclick:function(){p.itemActionMenu.popupWindow.close();p.setElementRank(r.ELEMENT_ID,r.RANK+5100)}});this.itemActionMenu=BX.PopupMenu.create("callListItemActionMenu",t,q,{autoHide:true,offsetTop:0,offsetLeft:0,angle:{position:"top"},zIndex:d+200,events:{onPopupClose:function(){p.itemActionMenu.popupWindow.destroy();BX.PopupMenu.destroy("callListItemActionMenu")},onPopupDestroy:function(){p.itemActionMenu=null}}});this.itemActionMenu.popupWindow.show()};a.prototype.actionMenuItemClickHandler=function(q,r){var p=this;return function(){p.itemActionMenu.popupWindow.close();p.setElementStatus(q,r)}};a.prototype.setElementRank=function(q,r){var p=this;this.executeItemAction({action:"SET_ELEMENT_RANK",parameters:{callListId:this.id,elementId:q,rank:r},successCallback:function(s){if(s.ITEMS){p.repopulateItems(s.ITEMS);p.render()}}})};a.prototype.setElementStatus=function(q,r){var p=this;this.executeItemAction({action:"SET_ELEMENT_STATUS",parameters:{callListId:this.id,elementId:q,statusId:r},successCallback:function(s){p.repopulateItems(s.ITEMS);p.render()}})};a.prototype.setWebformResult=function(p,q){this.executeItemAction({action:"SET_WEBFORM_RESULT",parameters:{callListId:this.id,elementId:p,webformResultId:q}})};a.prototype.executeItemAction=function(r){var p=this;if(!BX.type.isPlainObject(r)){r={}}if(!BX.type.isFunction(r.successCallback)){r.successCallback=BX.DoNothing}var q={sessid:BX.bitrix_sessid(),ajax_action:r.action,parameters:r.parameters};BX.ajax({url:a.getAjaxUrl(),method:"POST",dataType:"json",data:q,onsuccess:function(s){r.successCallback(s)}})};a.prototype.repopulateItems=function(q){var p=this;for(statusId in this.statuses){this.statuses[statusId].ITEMS=[]}q.forEach(function(r){p.statuses[r.STATUS_ID].ITEMS.push(r)});if(this.statuses[this.currentStatusId].ITEMS.length==0){this.currentStatusId=this.getNonEmptyStatusId();this.currentItemIndex=0}else{if(this.currentItemIndex>=this.statuses[this.currentStatusId].ITEMS.length){this.currentItemIndex=0}}this.selectItem(this.currentStatusId,this.currentItemIndex)};a.prototype.getNonEmptyStatusId=function(){var p=false;for(statusId in this.statuses){if(this.statuses[statusId].ITEMS.length>0){p=statusId;break}}return p};a.prototype.getCurrentElement=function(){return this.statuses[this.currentStatusId].ITEMS[this.currentItemIndex]};a.prototype.getStatusTitle=function(q){var p=this.statuses[q].ITEMS.length;return BX.util.htmlspecialchars(this.statuses[q].NAME)+" ("+p.toString()+")"};var b=null;var h={};BX.FoldedCallView=function(p){this.currentItem={};this.callListParams={id:0,webformId:0,webformSecCode:"",itemIndex:0,itemStatusId:"",statusList:{},entityType:""};this.node=null;this.elements={avatar:null,callButton:null,nextButton:null,unfoldButton:null};this._lsKey="bx-im-folded-call-view-data";this._lsTtl=86400;this.init()};BX.FoldedCallView.getInstance=function(){if(b==null){b=new BX.FoldedCallView()}return b};BX.FoldedCallView.prototype.init=function(){this.load();if(this.callListParams.id>0){this.currentItem=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS[this.callListParams.itemIndex];this.render()}};BX.FoldedCallView.prototype.load=function(){var p=BX.localStorage.get(this._lsKey);if(BX.type.isPlainObject(p)){this.callListParams=p}};BX.FoldedCallView.prototype.destroy=function(){if(this.node){BX.cleanNode(this.node,true);this.node=null}BX.localStorage.remove(this._lsKey)};BX.FoldedCallView.prototype.store=function(){BX.localStorage.set(this._lsKey,this.callListParams,this._lsTtl)};BX.FoldedCallView.prototype.fold=function(q,p){p=(p==true);this.callListParams.id=q.callListId;this.callListParams.webformId=q.webformId;this.callListParams.webformSecCode=q.webformSecCode;this.callListParams.itemIndex=q.currentItemIndex;this.callListParams.itemStatusId=q.currentItemStatusId;this.callListParams.statusList=q.statusList;this.callListParams.entityType=q.entityType;this.currentItem=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS[this.callListParams.itemIndex];this.store();this.render(p)};BX.FoldedCallView.prototype.unfold=function(p){var q=this;BX.addClass(this.node,"im-phone-folded-call-view-unfold");this.node.addEventListener("animationend",function(){if(q.node){BX.cleanNode(q.node,true);q.node=null}BX.localStorage.remove(q._lsKey);if(!window.BXIM||q.callListParams.id==0){return false}var r={};if(q.callListParams.webformId>0&&q.callListParams.webformSecCode!=""){r.webformId=q.callListParams.webformId;r.webformSecCode=q.callListParams.webformSecCode}r.callListStatusId=q.callListParams.itemStatusId;r.callListItemIndex=q.callListParams.itemIndex;r.makeCall=p;window.BXIM.startCallList(q.callListParams.id,r)})};BX.FoldedCallView.prototype.moveToNext=function(){this.callListParams.itemIndex++;if(this.callListParams.itemIndex>=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS.length){this.callListParams.itemIndex=0}this.currentItem=this.callListParams.statusList[this.callListParams.itemStatusId].ITEMS[this.callListParams.itemIndex];this.store();this.render()};BX.FoldedCallView.prototype.render=function(q){var p=this;q=(q==true);if(this.node==null){this.node=BX.create("div",{props:{id:"im-phone-folded-call-view",className:"im-phone-call-wrapper im-phone-call-wrapper-fixed im-phone-call-panel"},events:{dblclick:this._onViewDblClick.bind(this)}});document.body.appendChild(this.node)}else{BX.cleanNode(this.node)}this.node.appendChild(BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-left"},style:(q?{bottom:"-90px"}:{}),children:[BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user"},children:[BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-image"},children:[this.elements.avatar=BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-image-item"}})]}),BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-info"},children:this.renderUserInfo()})]})]}));this.node.appendChild(BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-right"},children:[BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-btn-container"},children:[this.elements.callButton=BX.create("span",{props:{className:"im-phone-call-btn im-phone-call-btn-green"},text:BX.message("IM_PHONE_CALL_VIEW_FOLDED_BUTTON_CALL"),events:{click:this._onDialButtonClick.bind(this)}}),this.elements.nextButton=BX.create("span",{props:{className:"im-phone-call-btn im-phone-call-btn-gray im-phone-call-btn-arrow"},text:BX.message("IM_PHONE_CALL_VIEW_FOLDED_BUTTON_NEXT"),events:{click:this._onNextButtonClick.bind(this)}})]})]}));this.node.appendChild(BX.create("div",{props:{className:"im-phone-btn-block"},children:[this.elements.unfoldButton=BX.create("div",{props:{className:"im-phone-btn-arrow"},children:[BX.create("div",{props:{className:"im-phone-btn-arrow-inner"},text:BX.message("IM_PHONE_CALL_VIEW_UNFOLD")})],events:{click:this._onUnfoldButtonClick.bind(this)}})]}));if(h[this.currentItem.ELEMENT_ID]){this.elements.avatar.style.backgroundImage="url('"+BX.util.htmlspecialchars(h[this.currentItem.ELEMENT_ID])+"')"}else{this.loadAvatar(this.callListParams.entityType,this.currentItem.ELEMENT_ID)}if(q){BX.addClass(this.node,"im-phone-folded-call-view-fold");this.node.addEventListener("animationend",function(){BX.removeClass(p.node,"im-phone-folded-call-view-fold")})}};BX.FoldedCallView.prototype.renderUserInfo=function(){var p=[];p.push(BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-name"},text:this.currentItem.NAME}));if(this.currentItem.POST){p.push(BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-item"},text:this.currentItem.POST}))}if(this.currentItem.COMPANY_TITLE){p.push(BX.create("div",{props:{className:"im-phone-call-wrapper-fixed-user-item"},text:this.currentItem.COMPANY_TITLE}))}return p};BX.FoldedCallView.prototype.loadAvatar=function(r,q){var p=this;BX.ajax({url:a.getAjaxUrl(),method:"POST",dataType:"json",data:{sessid:BX.bitrix_sessid(),ajax_action:"GET_AVATAR",entityType:r,entityId:q},onsuccess:function(s){if(!s.avatar){return}h[q]=s.avatar;if(p.currentItem.ELEMENT_ID==q&&p.elements.avatar){p.elements.avatar.style.backgroundImage="url('"+BX.util.htmlspecialchars(s.avatar)+"')"}}})};BX.FoldedCallView.prototype._onViewDblClick=function(p){BX.PreventDefault(p);this.unfold(false)};BX.FoldedCallView.prototype._onDialButtonClick=function(p){BX.PreventDefault(p);this.unfold(true)};BX.FoldedCallView.prototype._onNextButtonClick=function(p){BX.PreventDefault(p);this.moveToNext()};BX.FoldedCallView.prototype._onUnfoldButtonClick=function(p){BX.PreventDefault(p);this.unfold(false)};var o=function(p){this.bindElement=BX.type.isDomNode(p.bindElement)?p.bindElement:null;this.callbacks={onSelect:BX.type.isFunction(p.onSelect)?p.onSelect:BX.DoNothing,onDestroy:BX.type.isFunction(p.onDestroy)?p.onDestroy:BX.DoNothing};this.popup=null;this.selectedUserId=0;this.BXIM=p.BXIM;this.elements={destinationContainer:null,input:null}};o.create=function(p){return new o(p)};o.prototype.show=function(){if(!this.popup){this.popup=this.createPopup();this.popup.setAngle({offset:BX.MessengerCommon.isPage()?32:198});this.bindEvents()}this.popup.show();this.elements.input.focus()};o.prototype.close=function(){if(this.popup){this.popup.close()}};o.prototype.createPopup=function(){var p=this;return new BX.PopupWindow("bx-messenger-popup-transfer",this.bindElement,{zIndex:d+200,lightShadow:true,offsetTop:5,offsetLeft:BX.MessengerCommon.isPage()?5:-162,autoHide:true,closeByEsc:true,content:this.render(),buttons:[new BX.PopupWindowButton({text:BX.message("IM_M_CALL_BTN_TRANSFER"),className:"popup-window-button-accept",events:{click:function(r){var q=false;if(p.selectedUserId==0){return false}if(p.BXIM.messenger.phones&&p.BXIM.messenger.phones[p.selectedUserId]){if(p.BXIM.messenger.phones[p.selectedUserId].PERSONAL_MOBILE||p.BXIM.messenger.phones[p.selectedUserId].PERSONAL_PHONE||p.BXIM.messenger.phones[p.selectedUserId].WORK_PHONE){q=true}}if(!q){p.popup.close();p.callbacks.onSelect({type:"user",userId:p.selectedUserId})}else{p.BXIM.messenger.openPopupMenu(r.target,"callTransferMenu",true,{userId:p.selectedUserId,zIndex:d+210,onSelect:function(s){p.popup.close();p.callbacks.onSelect(s)}})}}}}),new BX.PopupWindowButton({text:BX.message("IM_M_CHAT_BTN_CANCEL"),events:{click:function(){p.popup.close()}}})],events:{onPopupClose:function(){this.destroy()},onPopupDestroy:function(){p.popup=null;p.elements.contactList=null;p.callbacks.onDestroy()}}})};o.prototype.render=function(){return BX.create("div",{props:{className:"bx-messenger-popup-newchat-wrap"},children:[BX.create("div",{props:{className:"bx-messenger-popup-newchat-caption"},html:BX.message("IM_M_CALL_TRANSFER_TEXT")}),BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-dest bx-messenger-popup-newchat-dest-even"},children:[this.elements.destinationContainer=BX.create("span",{props:{className:"bx-messenger-dest-items"}}),this.elements.input=BX.create("input",{props:{className:"bx-messenger-input"},attrs:{type:"text",placeholder:BX.message(this.BXIM.bitrixIntranet?"IM_M_SEARCH_PLACEHOLDER_CP":"IM_M_SEARCH_PLACEHOLDER"),value:""}})]}),this.elements.contactList=BX.create("div",{props:{className:"bx-messenger-popup-newchat-box bx-messenger-popup-newchat-cl bx-messenger-recent-wrap"},children:[]})]})};o.prototype.bindEvents=function(r){var q=this;var p=1;BX.MessengerCommon.contactListSearchClear();if(!this.BXIM.messenger.contactListLoad){this.elements.contactList.appendChild(BX.create("div",{props:{className:"bx-messenger-cl-item-load"},html:BX.message("IM_CL_LOAD")}));BX.MessengerCommon.contactListGetFromServer(function(){BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",q.elements.contactList,q.elements.input.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})})}else{BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",this.elements.contactList,this.elements.input.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}BX.bindDelegate(this.elements.contactList,"click",{className:"bx-messenger-chatlist-more"},BX.delegate(this.BXIM.messenger.toggleChatListGroup,this.BXIM.messenger));BX.addClass(this.popup.popupContainer,"bx-messenger-mark");BX.bind(this.popup.popupContainer,"click",BX.PreventDefault);BX.bind(this.elements.input,"keyup",BX.delegate(function(v){if(v.keyCode==16||v.keyCode==17||v.keyCode==18||v.keyCode==20||v.keyCode==244||v.keyCode==224||v.keyCode==91){return false}if(v.keyCode==27&&this.elements.input.value!=""){BX.MessengerCommon.preventDefault(v)}if(v.keyCode==27){this.elements.input.value=""}if(v.keyCode==8){var w=null;var s=BX.util.objectSort(this.popupChatDialogUsers,"date","asc");for(var t=0;t<s.length;t++){w=s[t].id}if(w){delete this.popupChatDialogUsers[w];this.redrawChatDialogDest()}}if(v.keyCode==13){this.elements.input.value="";var u=BX.findChildByClassName(this.elements.contactList,"bx-messenger-cl-item");if(u){if(this.elements.input.value!=""){this.elements.input.value=""}if(this.selectedUserId>0){p=p+1;if(p>0){BX.show(this.elements.input)}this.selectedUserId=0}else{if(p>0){p=p-1;if(p<=0){BX.hide(this.elements.input)}this.selectedUserId=u.getAttribute("data-userId")}}this.redrawTransferDialogDest()}}BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",this.elements.contactList,this.elements.input.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true,timeout:100})},this));BX.bindDelegate(this.elements.destinationContainer,"click",{className:"bx-messenger-dest-del"},BX.delegate(function(){this.selectedUserId=0;p=p+1;if(p>0){BX.show(this.elements.input)}this.redrawTransferDialogDest()},this));BX.bindDelegate(this.elements.contactList,"click",{className:"bx-messenger-cl-item"},BX.delegate(function(s){if(this.elements.input.value!=""){this.elements.input.value="";BX.MessengerCommon.contactListPrepareSearch("popupTransferDialogContactListElements",this.elements.contactList,"",{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}if(this.selectedUserId){p=p+1;this.selectedUserId=0}else{if(p<=0){return false}p=p-1;this.selectedUserId=BX.proxy_context.getAttribute("data-userId")}if(p<=0){BX.hide(this.elements.input)}else{BX.show(this.elements.input)}this.redrawTransferDialogDest();return BX.PreventDefault(s)},this))};o.prototype.redrawTransferDialogDest=function(){var t="";var s=0;var q=this.selectedUserId.toString().substr(0,5)=="queue";var p=q?this.selectedUserId.toString().substr(5):0;if(q){var u=this.selectedUserId;for(var r=0;r<this.queue.length;r++){if(this.queue[r].ID==p){u=this.queue[r].NAME;break}}s++;t+='<span class="bx-messenger-dest-block bx-messenger-dest-block-extranet"><span class="bx-messenger-dest-text">'+u+'</span><span class="bx-messenger-dest-del" data-userId="'+this.selectedUserId+'"></span></span>'}else{if(this.selectedUserId>0){s++;t+='<span class="bx-messenger-dest-block'+(this.BXIM.messenger.users[this.selectedUserId].extranet?" bx-messenger-dest-block-extranet":"")+'"><span class="bx-messenger-dest-text">'+(this.BXIM.messenger.users[this.selectedUserId].name)+'</span><span class="bx-messenger-dest-del" data-userId="'+this.selectedUserId+'"></span></span>'}}this.elements.destinationContainer.innerHTML=t;this.elements.destinationContainer.parentNode.scrollTop=this.elements.destinationContainer.parentNode.offsetHeight;if(BX.util.even(s)){BX.addClass(this.elements.destinationContainer.parentNode,"bx-messenger-popup-newchat-dest-even")}else{BX.removeClass(this.elements.destinationContainer.parentNode,"bx-messenger-popup-newchat-dest-even")}this.elements.input.focus()};o.prototype.destroy=function(){this.BXIM.messenger.closeMenuPopup()};var n=function(p){if(!BX.type.isPlainObject(p)){p={}}this.bindElement=p.bindElement||null;this.offsetTop=p.offsetTop||0;this.offsetLeft=p.offsetLeft||0;this.anglePosition=p.anglePosition||"";this.angleOffset=p.angleOffset||0;this.history=p.history||[];this.selectedLineId=p.defaultLineId;this.lines=p.lines||{};this.availableLines=p.availableLines||[];this.zIndex=d+200;this.hideDial=(p.hideDial===true);this.plusEntered=false;this.callbacks={onButtonClick:BX.type.isFunction(p.onButtonClick)?p.onButtonClick:BX.DoNothing,onDial:BX.type.isFunction(p.onDial)?p.onDial:BX.DoNothing,onClose:BX.type.isFunction(p.onClose)?p.onClose:BX.DoNothing};this.elements={inputContainer:null,input:null,lineSelector:null,lineName:null,interceptButton:null,historyButton:null};this.plusKeyTimeout=null;this.lineSelectMenu=null;this.historySelectMenu=null;this.interceptErrorPopup=null;this.popup=this.createPopup()};n.prototype.createPopup=function(){var p=this;var q={darkMode:true,closeByEsc:true,autoHide:true,zIndex:this.zIndex,content:this.render(),noAllPaddings:true,offsetTop:this.offsetTop,offsetLeft:this.offsetLeft,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function(){p.callbacks.onClose()}}};if(this.anglePosition!==""){q.angle={position:this.anglePosition,offset:this.angleOffset}}return new BX.PopupWindow("phone-call-view-popup-keypad",this.bindElement,q)};n.prototype.canSelectLine=function(){return this.availableLines.length>1};n.prototype.setSelectedLineId=function(p){this.selectedLineId=p;if(this.elements.lineName){this.elements.lineName.innerText=this.getLineName(p)}};n.prototype.getLineName=function(p){return this.lines.hasOwnProperty(p)?this.lines[p].SHORT_NAME:""};n.prototype.render=function(){var p=this;var q=function(s){var r;if(s=="*"){r="10"}else{if(s=="#"){r="11"}else{r=s}}return BX.create("span",{dataset:{digit:s},props:{className:"bx-messenger-calc-btn bx-messenger-calc-btn-"+r},children:[BX.create("span",{props:{className:"bx-messenger-calc-btn-num"}})],events:{mousedown:p._onKeyButtonMouseDown.bind(p),mouseup:p._onKeyButtonMouseUp.bind(p)}})};return BX.create("div",{props:{className:"bx-messenger-calc-wrap"+(BX.MessengerCommon.isPage()?" bx-messenger-calc-wrap-desktop":"")},events:{click:this._onBodyClick.bind(this)},children:[BX.create("div",{props:{className:"bx-messenger-calc-body"},children:[this.elements.inputContainer=BX.create("div",{props:{className:"bx-messenger-calc-panel"},children:[BX.create("span",{props:{className:"bx-messenger-calc-panel-delete"},events:{click:this._onDeleteButtonClick.bind(this)}}),this.elements.input=BX.create("input",{attrs:{readonly:this.hideDial,type:"text",value:"",placeholder:BX.message(this.hideDial?"IM_PHONE_PUT_DIGIT":"IM_PHONE_PUT_NUMBER")},props:{className:"bx-messenger-calc-panel-input"},events:{keydown:this._onInputKeydown.bind(this),keyup:function(){p._onAfterNumberChanged()}}})]}),BX.create("div",{props:{className:"bx-messenger-calc-btns-block"},children:["1","2","3","4","5","6","7","8","9","*","0","#"].map(q)})]}),this.hideDial?null:BX.create("div",{props:{className:"bx-messenger-call-btn-wrap"},children:[this.elements.lineSelector=!this.canSelectLine()?null:BX.create("div",{props:{className:"im-phone-select-line"},children:[this.elements.lineName=BX.create("span",{props:{className:"im-phone-select-line-name"},text:this.getLineName(this.selectedLineId)}),BX.create("span",{props:{className:"im-phone-select-line-select"}})],events:{click:this._onLineSelectClick.bind(this)}}),BX.create("span",{props:{className:"bx-messenger-call-btn-separate"},children:[BX.create("span",{props:{className:"bx-messenger-call-btn"},children:[BX.create("span",{props:{className:"bx-messenger-call-btn-text"},html:BX.message("IM_PHONE_CALL")})],events:{click:this._onDialButtonClick.bind(this)}}),this.elements.historyButton=BX.create("span",{props:{className:"bx-messenger-call-btn-arrow"},events:{click:this._onShowHistoryButtonClick.bind(this)}})]}),this.elements.interceptButton=BX.create("span",{props:{className:"im-phone-intercept-button"+(e.callInterceptAllowed?"":" im-phone-intercept-button-locked")},text:BX.message("IM_PHONE_CALL_VIEW_INTERCEPT"),events:{click:this._onInterceptButtonClick.bind(this)}})]})]})};n.prototype._onBodyClick=function(p){if(this.interceptErrorPopup){this.interceptErrorPopup.close()}};n.prototype._onInputKeydown=function(p){if(p.keyCode==13){this.callbacks.onDial({phoneNumber:this.elements.input.value,lineId:this.selectedLineId})}else{if(p.keyCode==37||p.keyCode==39||p.keyCode==8||p.keyCode==107||p.keyCode==46||p.keyCode==35||p.keyCode==36){}else{if((p.keyCode==61||p.keyCode==187||p.keyCode==51||p.keyCode==56)&&p.shiftKey){}else{if((p.keyCode==67||p.keyCode==86||p.keyCode==65||p.keyCode==88)&&(p.metaKey||p.ctrlKey)){}else{if(p.keyCode>=48&&p.keyCode<=57&&!p.shiftKey){this.callbacks.onButtonClick({key:p.key})}else{if(p.keyCode>=96&&p.keyCode<=105&&!p.shiftKey){this.callbacks.onButtonClick({key:p.key})}else{return BX.PreventDefault(p)}}}}}}};n.prototype._onAfterNumberChanged=function(){if(this.elements.input.value.length>0){BX.addClass(this.elements.inputContainer,"bx-messenger-calc-panel-active")}else{BX.removeClass(this.elements.inputContainer,"bx-messenger-calc-panel-active")}this.elements.input.focus()};n.prototype._onDeleteButtonClick=function(){this.elements.input.value=this.elements.input.value.substr(0,this.elements.input.value.length-1);this._onAfterNumberChanged()};n.prototype._onDialButtonClick=function(){this.callbacks.onDial({phoneNumber:this.elements.input.value,lineId:this.selectedLineId})};n.prototype._onInterceptButtonClick=function(){var p=this;if(!e.callInterceptAllowed){this.close();if(BX.Voximplant&&BX.Voximplant.showLicensePopup){BX.Voximplant.showLicensePopup("call-intercept")}return}BX.MessengerCommon.phoneCommand("interceptCall",{},true,function(q){if(!q.FOUND||q.FOUND=="Y"){p.close()}else{if(q.ERROR){p.interceptErrorPopup=new BX.PopupWindow("intercept-call-error",this.elements.interceptButton,{content:BX.util.htmlspecialchars(q.ERROR),autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},angle:{offset:40},zIndex:this.zIndex+100,onPopupClose:function(r){p.interceptErrorPopup.destroy()},onPopupDestroy:function(r){p.interceptErrorPopup=null}});p.interceptErrorPopup.show()}}}.bind(this))};n.prototype._onKeyButtonMouseDown=function(r){BX.PreventDefault(r);var q=r.currentTarget.dataset.digit.toString();var p=this;if(q==0){this.plusKeyTimeout=setTimeout(function(){p.plusEntered=true;p.elements.input.value=p.elements.input.value+"+"},500)}};n.prototype._onKeyButtonMouseUp=function(q){BX.PreventDefault(q);var p=q.currentTarget.dataset.digit.toString();if(p==0){clearTimeout(this.plusKeyTimeout);if(!this.plusEntered){this.elements.input.value=this.elements.input.value+"0"}this.plusEntered=false}else{this.elements.input.value=this.elements.input.value+p}this._onAfterNumberChanged();this.callbacks.onButtonClick({key:p})};n.prototype._onShowHistoryButtonClick=function(){var p=this;var q=[];if(!BX.type.isArray(this.history)||this.history.length===0){return}this.history.forEach(function(s,r){q.push({id:"history_"+r,text:BX.util.htmlspecialchars(s),onclick:function(){p.historySelectMenu.close();p.callbacks.onDial({phoneNumber:s,lineId:p.selectedLineId})}})});this.historySelectMenu=BX.PopupMenu.create("phoneCallViewDialHistory",this.elements.historyButton,q,{autoHide:true,offsetTop:0,offsetLeft:0,zIndex:d+300,bindOptions:{position:"top"},angle:{offset:33},closeByEsc:true,overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function(){p.historySelectMenu.popupWindow.destroy();BX.PopupMenu.destroy("phoneCallViewDialHistory")},onPopupDestroy:function(){p.historySelectMenu=null}}});this.historySelectMenu.popupWindow.show()};n.prototype._onLineSelectClick=function(r){var p=this;var q=[];this.availableLines.forEach(function(s){q.push({id:"selectLine_"+s,text:BX.util.htmlspecialchars(p.getLineName(s)),onclick:function(){p.lineSelectMenu.close();p.setSelectedLineId(s)}})});this.lineSelectMenu=BX.PopupMenu.create("phoneCallViewSelectLine",this.elements.lineSelector,q,{autoHide:true,zIndex:this.zIndex+100,closeByEsc:true,bindOptions:{position:"top"},offsetLeft:35,angle:{offset:33},overlay:{backgroundColor:"white",opacity:0},events:{onPopupClose:function(){p.lineSelectMenu.popupWindow.destroy();BX.PopupMenu.destroy("phoneCallViewSelectLine")},onPopupDestroy:function(){p.lineSelectMenu=null}}});this.lineSelectMenu.popupWindow.show()};n.prototype.show=function(){if(this.popup){this.popup.show();this.elements.input.focus()}};n.prototype.close=function(){if(this.lineSelectMenu){this.lineSelectMenu.destroy()}if(this.historySelectMenu){this.historySelectMenu.destroy()}if(this.interceptErrorPopup){this.interceptErrorPopup.close()}if(this.popup){this.popup.close()}};n.prototype.destroy=function(){if(this.lineSelectMenu){this.lineSelectMenu.destroy()}if(this.historySelectMenu){this.historySelectMenu.destroy()}if(this.interceptErrorPopup){this.interceptErrorPopup.destroy()}if(this.popup){this.popup.destroy()}this.popup=null};BX.PhoneKeypad=n;var l=function(p){this.node=p.node;this.currentForm=null;this.callbacks={onFormLoad:BX.type.isFunction(p.onFormLoad)?p.onFormLoad:BX.DoNothing,onFormUnLoad:BX.type.isFunction(p.onFormUnLoad)?p.onFormUnLoad:BX.DoNothing,onFormSend:BX.type.isFunction(p.onFormSend)?p.onFormSend:BX.DoNothing}};l.prototype.load=function(q){var p=this.getFormData(q);window.Bitrix24FormLoader.load(p);this.currentForm=p};l.prototype.unload=function(){if(this.currentForm){window.Bitrix24FormLoader.unload(this.currentForm);this.currentForm=null}};l.prototype.getFormData=function(p){return{id:p.id,sec:p.secCode,type:"inline",lang:"ru",ref:window.location.href,node:this.node,handlers:{load:this._onFormLoad.bind(this),unload:this._onFormUnLoad.bind(this),send:this.onFormSend.bind(this)},options:{borders:false,logo:false}}};l.prototype._onFormLoad=function(p){this.callbacks.onFormLoad(p)};l.prototype._onFormUnLoad=function(p){this.callbacks.onFormUnLoad(p)};l.prototype.onFormSend=function(p){this.callbacks.onFormSend(p)}})();