(function(){BX.namespace("BX.Call");if(BX.Call.FloatingVideo){return}var b={setStream:"FloatingVideo::setStream",setAudioMuted:"FloatingVideo::setAudioMuted",setTitle:"FloatingVideo::setTitle",setAvatars:"FloatingVideo::setAvatars",setTalking:"FloatingVideo::setTalking",onMainAreaClick:"FloatingVideo::onMainAreaClick",onMicButtonClick:"FloatingVideo::onMicButtonClick",onHangupButtonClick:"FloatingVideo::onHangupButtonClick",connectionOffer:"FloatingVideo::connectionOffer",connectionAnswer:"FloatingVideo::connectionAnswer",connectionClose:"FloatingVideo::connectionClose",connectionIceCandidate:"FloatingVideo::connectionIceCandidate",};var c=320;var e=180;var d=320;var a=70;BX.Call.FloatingVideo=function(f){if(typeof(f)!=="object"){f={}}this.stream=f.stream&&BX.Call.Util.containsVideoTrack(f.stream)?f.stream:null;this.audioMuted=f.audioMuted||false;this.title=f.title||"";this.avatars=f.avatars||{};this.window=null;this.visible=false;this.peerConnection=null;this.callbacks={onMainAreaClick:BX.type.isFunction(f.onMainAreaClick)?f.onMainAreaClick:BX.DoNothing,onButtonClick:BX.type.isFunction(f.onButtonClick)?f.onButtonClick:BX.DoNothing};this._onContentMainAreaClickHandler=this._onContentMainAreaClick.bind(this);this._onContentMicButtonClickHandler=this._onContentMicButtonClick.bind(this);this._onContentHangupButtonClickHandler=this._onContentHangupButtonClick.bind(this);this._onPCNegotiationNeededHandler=this._onPCNegotiationNeeded.bind(this);this._onPCIceCandidateHandler=this._onPCIceCandidate.bind(this);this._onConnectionAnswerHandler=this._onConnectionAnswer.bind(this);this._onConnectionIceCandidateHandler=this._onConnectionIceCandidate.bind(this);this.bindEventHandlers()};BX.Call.FloatingVideo.prototype={bindEventHandlers:function(){BX.desktop.addCustomEvent(b.onMainAreaClick,this._onContentMainAreaClickHandler);BX.desktop.addCustomEvent(b.onMicButtonClick,this._onContentMicButtonClickHandler);BX.desktop.addCustomEvent(b.onHangupButtonClick,this._onContentHangupButtonClickHandler);BX.desktop.addCustomEvent(b.connectionAnswer,this._onConnectionAnswerHandler);BX.desktop.addCustomEvent(b.connectionIceCandidate,this._onConnectionIceCandidateHandler)},_onContentMainAreaClick:function(){this.callbacks.onMainAreaClick()},_onContentMicButtonClick:function(){this.callbacks.onButtonClick({buttonName:"toggleMute",muted:!this.audioMuted})},_onContentHangupButtonClick:function(){this.callbacks.onButtonClick({buttonName:"hangup"})},setStream:function(f){if(BX.Call.Util.containsVideoTrack(f)){this.stream=f}else{this.stream=null}if(this.window&&this.visible){if(this.stream){this.sendVideo()}else{this.stopSendingVideo()}}},setTitle:function(f){this.title=f;if(this.window){BX.desktop.onCustomEvent(this.window,b.setTitle,[this.title])}},setAvatars:function(f){this.avatars=f;if(this.window&&this.visible){BX.desktop.onCustomEvent(this.window,b.setAvatars,[this.avatars])}},setTalking:function(f){if(this.window){BX.desktop.onCustomEvent(this.window,b.setTalking,[f])}},sendVideo:function(){if(!this.peerConnection){this.peerConnection=new RTCPeerConnection();this.peerConnection.addEventListener("negotiationneeded",this._onPCNegotiationNeededHandler);this.peerConnection.addEventListener("icecandidate",this._onPCIceCandidateHandler)}this.peerConnection.addTrack(this.stream.getVideoTracks()[0],this.stream)},_onPCNegotiationNeeded:function(){var f;this.peerConnection.createOffer().then(function(g){f=g;return this.peerConnection.setLocalDescription(g)}.bind(this)).then(function(){BX.desktop.onCustomEvent(this.window,b.connectionOffer,[f.sdp])}.bind(this))},_onPCIceCandidate:function(g){var f=g.candidate;if(f){BX.desktop.onCustomEvent(this.window,b.connectionIceCandidate,[f.toJSON()])}},_onConnectionAnswer:function(f){if(this.peerConnection){var g=new RTCSessionDescription({type:"answer",sdp:f});this.peerConnection.setRemoteDescription(g)}},_onConnectionIceCandidate:function(f){if(this.peerConnection){this.peerConnection.addIceCandidate(f)}},stopSendingVideo:function(){if(this.peerConnection){this.peerConnection.close();this.peerConnection.removeEventListener("negotiationneeded",this._onPCNegotiationNeededHandler);this.peerConnection.removeEventListener("icecandidate",this._onPCIceCandidateHandler);this.peerConnection=null}BX.desktop.onCustomEvent(this.window,b.connectionClose,[])},setAudioMuted:function(f){if(this.audioMuted==f){return}this.audioMuted=f;if(this.window&&this.visible){BX.desktop.onCustomEvent(this.window,b.setAudioMuted,[this.audioMuted])}},show:function(){if(!BX.desktop){return}if(this.window){this.window.BXDesktopWindow.ExecuteCommand("show");BX.desktop.onCustomEvent(this.window,b.setAudioMuted,[this.audioMuted]);BX.desktop.onCustomEvent(this.window,b.setAvatars,[this.avatars]);if(this.stream){this.sendVideo()}}else{var f={audioMuted:this.audioMuted,title:this.title,avatars:this.avatars};this.window=BXDesktopSystem.ExecuteCommand("topmost.show.html",BX.desktop.getHtmlPage("","window.FVC = new BX.Call.FloatingVideoContent("+JSON.stringify(f)+");"));setTimeout(function(){if(this.stream&&this.visible){this.sendVideo()}}.bind(this),2000)}this.visible=true},hide:function(){if(!this.window||!this.window.document){return false}this.stopSendingVideo();this.window.BXDesktopWindow.ExecuteCommand("hide");this.visible=false},close:function(){if(!this.window||!this.window.document){return false}this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null;this.visible=false},destroy:function(){if(this.window){this.window.BXDesktopWindow.ExecuteCommand("close");this.window=null}this.stream=null;BX.desktop.removeCustomEvents(b.onMainAreaClick);BX.desktop.removeCustomEvents(b.onMicButtonClick);BX.desktop.removeCustomEvents(b.onHangupButtonClick)}};BX.Call.FloatingVideoContent=function(f){this.stream=f.stream;this.audioMuted=f.audioMuted;this.avatars=f.avatars||{};this.title=f.title||"";this.talking=[];this.elements={container:null,video:null,avatars:null,title:null,micButton:null,micButtonText:null,hangupButton:null};this.render();this.adjustWindow();this.bindEventHandlers();this.callAspectHorizontal=true;if(this.stream){this.callAspectCheckInterval=setInterval(this.checkVideoAspect.bind(this),500)}this.slavePeerConnection=null;this._onSlavePCIceCandidateHandler=this._onSlavePCIceCandidate.bind(this);this._onSlavePCIceConnectionStateChangeHandler=this._onSlavePCIceConnectionStateChange.bind(this)};BX.Call.FloatingVideoContent.prototype={bindEventHandlers:function(){BX.desktop.addCustomEvent(b.setStream,this.setStream.bind(this));BX.desktop.addCustomEvent(b.setAudioMuted,this.setAudioMuted.bind(this));BX.desktop.addCustomEvent(b.setTitle,this.setTitle.bind(this));BX.desktop.addCustomEvent(b.setAvatars,this.setAvatars.bind(this));BX.desktop.addCustomEvent(b.setTalking,this.setTalking.bind(this));BX.desktop.addCustomEvent(b.connectionOffer,this._onConnectionOfferFromMain.bind(this));BX.desktop.addCustomEvent(b.connectionIceCandidate,this._onIceCandidateFromMain.bind(this));BX.desktop.addCustomEvent(b.connectionClose,this._onRTCconnectionClose.bind(this));window.addEventListener("beforeunload",this.destroy.bind(this))},render:function(){var g=this.stream?c:d;var f=this.stream?e:a;var h={width:g+"px",height:f+"px"};this.elements.container=BX.create("div",{props:{className:"bx-messenger-call-float"+(this.stream?"":" bx-messenger-call-float-audio")},style:h,events:{click:this.onMainAreaClick.bind(this)},children:[BX.create("div",{props:{className:"bx-messenger-call-float-audio-unfold"},children:[this.elements.avatars=BX.create("div",{props:{className:"bx-messenger-call-float-avatars"},}),this.elements.title=BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:this.title})]}),BX.create("div",{props:{className:"bx-messenger-call-float-buttons"},children:[this.elements.micButton=BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-mic"+(this.audioMuted?" bx-messenger-call-float-button-mic-disabled":"")},events:{click:this.onMicButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),this.elements.micButtonText=BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_"+(this.audioMuted?"OFF":"ON"))})]}),this.elements.hangupButton=BX.create("div",{props:{className:"bx-messenger-call-float-button bx-messenger-call-float-button-decline"},events:{click:this.onHangupButtonClick.bind(this)},children:[BX.create("span",{props:{className:"bx-messenger-call-float-button-icon"}}),BX.create("span",{props:{className:"bx-messenger-call-float-button-text"},text:BX.message("IM_M_CALL_BTN_HANGUP")})]})]})]});this.elements.video=BX.create("video",{attrs:{autoplay:true,src:this.stream,},props:{className:"bx-messenger-call-float-video",volume:0},});if(this.stream){BX.prepend(this.elements.video,this.elements.container)}this.setAvatars(this.avatars);document.body.appendChild(this.elements.container)},adjustWindow:function(i,g){var h=this.stream?c:d;var f=this.stream?e:a;i=i||h;g=g||f;if(!this.stream){var j=Math.ceil(Object.keys(this.avatars).length/4);g+=j*74+10}this.elements.container.style.width=i+"px";this.elements.container.style.height=g+"px";BX.desktop.setWindowMinSize({Width:i,Height:g});BX.desktop.setWindowResizable(false);BX.desktop.setWindowClosable(false);BX.desktop.setWindowResizable(false);BX.desktop.setWindowTitle(this.title);if(BXDesktopSystem.QuerySettings("global_topmost_x",null)){BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:i,Height:g,Mode:STP_FRONT});if(!BX.browser.IsMac()){BX.desktop.setWindowPosition({X:parseInt(BXDesktopSystem.QuerySettings("global_topmost_x",STP_RIGHT)),Y:parseInt(BXDesktopSystem.QuerySettings("global_topmost_y",STP_TOP)),Width:i,Height:g,Mode:STP_FRONT})}}else{BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:i,Height:g,Mode:STP_FRONT});if(!BX.browser.IsMac()){BX.desktop.setWindowPosition({X:STP_RIGHT,Y:STP_TOP,Width:i,Height:g,Mode:STP_FRONT})}}},checkVideoAspect:function(){if(this.elements.video.videoWidth<this.elements.video.videoHeight){if(this.callAspectHorizontal){this.callAspectHorizontal=false;BX.addClass(this.elements.container,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:e,Height:c})}}else{if(!this.callAspectHorizontal){this.callAspectHorizontal=true;BX.removeClass(this.elements.container,"bx-messenger-call-overlay-aspect-vertical");BX.desktop.setWindowSize({Width:c,Height:e})}}},_onConnectionOfferFromMain:function(f){if(this.slavePeerConnection){this.slavePeerConnection.removeEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.removeEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler);this.slavePeerConnection.close()}this.slavePeerConnection=new RTCPeerConnection();this.slavePeerConnection.addEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.addEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler);var g=new RTCSessionDescription({type:"offer",sdp:f});this.slavePeerConnection.setRemoteDescription(g).then(function(){if(this.slavePeerConnection){this.slavePeerConnection.createAnswer().then(function(h){this.slavePeerConnection.setLocalDescription(h);BX.desktop.onCustomEvent("main",b.connectionAnswer,[h.sdp])}.bind(this))}}.bind(this))},_onIceCandidateFromMain:function(f){setTimeout(function(){if(this.slavePeerConnection){this.slavePeerConnection.addIceCandidate(f)}}.bind(this),200)},_onRTCconnectionClose:function(){if(this.slavePeerConnection){this.slavePeerConnection.removeEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.removeEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler);this.slavePeerConnection.close();this.slavePeerConnection=null}this.setStream(null)},_onSlavePCIceCandidate:function(g){var f=g.candidate;if(f){BX.desktop.onCustomEvent("main",b.connectionIceCandidate,[f.toJSON()])}},_onSlavePCIceConnectionStateChange:function(f){if(this.slavePeerConnection.iceConnectionState==="connected"){this.setStream(this.slavePeerConnection.getRemoteStreams()[0])}else{if(this.slavePeerConnection.iceConnectionState==="disconnected"){this.setStream(null);this.slavePeerConnection.removeEventListener("icecandidate",this._onSlavePCIceCandidateHandler);this.slavePeerConnection.removeEventListener("iceconnectionstatechange",this._onSlavePCIceConnectionStateChangeHandler)}}},setStream:function(i){clearInterval(this.callAspectCheckInterval);this.stream=i;var g=this.stream?c:d;var f=this.stream?e:a;var h={width:g+"px",height:f+"px"};if(this.elements.container){if(this.stream){if(!this.elements.video.parentNode){BX.prepend(this.elements.video,this.elements.container);BX.removeClass(this.elements.container,"bx-messenger-call-float-audio")}this.elements.video.srcObject=this.stream}else{BX.remove(this.elements.video);BX.addClass(this.elements.container,"bx-messenger-call-float-audio")}BX.adjust(this.elements.container,{style:h})}if(this.stream){this.callAspectCheckInterval=setInterval(this.checkVideoAspect.bind(this),500)}this.adjustWindow()},setAudioMuted:function(f){this.audioMuted=f;if(this.audioMuted){BX.addClass(this.elements.micButton,"bx-messenger-call-float-button-mic-disabled");BX.adjust(this.elements.micButtonText,{text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_OFF")})}else{BX.removeClass(this.elements.micButton,"bx-messenger-call-float-button-mic-disabled");BX.adjust(this.elements.micButtonText,{text:BX.message("IM_M_CALL_BTN_MIC")+" "+BX.message("IM_M_CALL_BTN_MIC_ON")})}},setTitle:function(f){this.title=f;this.elements.title.innerText=f;BX.desktop.setWindowTitle(this.title)},setAvatars:function(i){this.avatars=i;this.elements.avatars.innerHTML="";for(var h in this.avatars){var g=this.avatars[h];var f=BX.create("div",{props:{className:"bx-messenger-call-float-avatar"},dataset:{userId:h}});if(g!=""){f.style.backgroundImage="url('"+g+"')"}this.elements.avatars.appendChild(f)}this.adjustWindow()},setTalking:function(f){this.talking=f;if(this.elements.avatars){for(var j=0;j<this.elements.avatars.children.length;j++){var h=this.elements.avatars.children[j];var g=Number(h.dataset.userId);if(this.talking.includes(g)){h.classList.add("talking")}else{h.classList.remove("talking")}}}},onMainAreaClick:function(f){BX.desktop.onCustomEvent("main",b.onMainAreaClick,[]);f.stopPropagation()},onMicButtonClick:function(f){BX.desktop.onCustomEvent("main",b.onMicButtonClick,[this.audioMuted]);f.stopPropagation()},onHangupButtonClick:function(f){BX.desktop.onCustomEvent("main",b.onHangupButtonClick,[]);f.stopPropagation()},destroy:function(){this.stream=null;BX.desktop.removeCustomEvents(b.setStream);BX.desktop.removeCustomEvents(b.setAudioMuted)}}})();