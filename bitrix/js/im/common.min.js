(function(b){if(b.BX.MessengerCommon){return}var d=b.BX;var a=function(){this.BXIM={};this.sendBotCommand=false;this.sendBotCommandBlock={};this.tryCheckConnect={}};a.prototype.setBxIm=function(e){this.BXIM=e};a.prototype.isPage=function(){return typeof(d.MessengerWindow)!="undefined"&&!(this.BXIM.context=="POPUP-FULLSCREEN"&&d.browser.IsMobile())};a.prototype.isDesktop=function(){return typeof(d.desktop)!="undefined"&&d.desktop.apiReady};a.prototype.isMobile=function(){return this.BXIM.mobileVersion};a.prototype.isMobileNative=function(){return false};a.prototype.isLinesOperator=function(){return this.BXIM.messenger.openlines&&this.BXIM.messenger.openlines.queue&&this.BXIM.messenger.openlines.queue.length>0};a.prototype.isBot=function(e){return typeof(this.BXIM.messenger.bot[e])!="undefined"};a.prototype.isBirthday=function(g){var f=new Date();var e=("0"+f.getDate().toString()).substr(-2)+"-"+("0"+(f.getMonth()+1).toString()).substr(-2);return g==e};a.prototype.getDebugInfo=function(){return{context:this.BXIM.context,design:this.BXIM.design,isDesktop:this.isDesktop()?"Y":"N",isPage:this.isPage()?"Y":"N",isMobile:this.isMobile()?"Y":"N",vInitedCall:d.localStorage.get("vInitedCall")?"Y":"N",desktopStatus:this.BXIM.desktopStatus?"Y":"N",callInit:this.BXIM.webrtc.callInit?"Y":"N",callActive:this.BXIM.webrtc.callActive?"Y":"N",appVersion:navigator.appVersion}};a.prototype.checkInternetConnection=function(e,h,f,g){if(typeof(e)!="function"){e=function(){if(typeof(BXIM)!="undefined"){BXIM.messenger.connectionStatus("online",false)}}}if(typeof(h)!="function"){h=function(){}}if(typeof(f)!="number"){f=1}if(!g&&f>1){g=+new Date()}if(typeof(BXIM)!="undefined"){BXIM.messenger.connectionStatus("connecting")}d.ajax({url:"//www.bitrixsoft.com/200.ok."+(+new Date),method:"GET",dataType:"html",skipAuthCheck:true,skipBxHeader:true,timeout:1,onsuccess:function(i){if(i=="OK"){console.log("Checking internet connection... success!");delete d.MessengerCommon.tryCheckConnect[g];e()}else{if(typeof(BXIM)!="undefined"){BXIM.messenger.connectionStatus("offline")}console.log("Checking internet connection... failure!");if(f==1){delete d.MessengerCommon.tryCheckConnect[g];h()}else{if(typeof(BXIM)!="undefined"){BXIM.messenger.connectionStatus("connecting")}clearTimeout(d.MessengerCommon.tryCheckConnect[g]);d.MessengerCommon.tryCheckConnect[g]=setTimeout(function(){d.MessengerCommon.checkInternetConnection(e,h,f-1,g)},5000)}}},onfailure:function(){console.log("Checking internet connection... failure!");if(f==1){delete d.MessengerCommon.tryCheckConnect[g];h()}else{clearTimeout(d.MessengerCommon.tryCheckConnect[g]);d.MessengerCommon.tryCheckConnect[g]=setTimeout(function(){d.MessengerCommon.checkInternetConnection(e,h,f-1,g)},5000)}}});return true};a.prototype.pinDialog=function(e,f){this.recentListElementPin(e,f);d.rest.callMethod("im.recent.pin",{DIALOG_ID:e,ACTION:f?"Y":"N"})};a.prototype.muteMessageChat=function(f,h,e){var g=0;if(f.toString().substr(0,4)=="chat"){g=f.toString().substr(4);if(!this.BXIM.messenger.chat[g]){return false}}else{g=this.BXIM.messenger.userChat[f];if(!g){return false}}e=e!=false;if(!this.BXIM.messenger.userChatBlockStatus[g]){this.BXIM.messenger.userChatBlockStatus[g]={}}if(typeof h=="undefined"){if(typeof this.BXIM.messenger.userChatBlockStatus[g][this.BXIM.userId]=="undefined"){h=true}else{h=!this.BXIM.messenger.userChatBlockStatus[g][this.BXIM.userId]}}else{h=Boolean(h)}console.log(h?"Y":"N");this.BXIM.messenger.userChatBlockStatus[g][this.BXIM.userId]=h;this.BXIM.messenger.chat[g].mute_list[this.BXIM.userId]=h;this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.updateMessageCount();if(e){d.ajax({url:this.BXIM.pathToAjax+"?CHAT_MUTE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_MUTE:"Y",CHAT_ID:g,MUTE:this.BXIM.messenger.userChatBlockStatus[g][this.BXIM.userId]?"Y":"N",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()}})}};a.prototype.MobileActionEqual=function(f){if(!this.isMobile()){return true}for(var e=0;e<arguments.length;e++){if(arguments[e]==this.BXIM.mobileAction){return true}}return false};a.prototype.MobileActionNotEqual=function(f){if(!this.isMobile()){return false}for(var e=0;e<arguments.length;e++){if(arguments[e]==this.BXIM.mobileAction){return false}}return true};a.prototype.isScrollMax=function(f,g){if(!f){return true}g=typeof(g)=="number"?g:0;if(this.isMobile()){var e=b.orientation==0?screen.height-125:screen.width-113;return(document.body.scrollHeight-e-e/2<=f.scrollTop)}else{return(f.scrollHeight-f.offsetHeight-g<=f.scrollTop)}};a.prototype.isScrollMin=function(e){if(!e){return false}return(0==e.scrollTop)};a.prototype.enableScroll=function(h,f,e){if(!h){return false}if(this.BXIM.messenger.isBodyScroll){return false}e=e!==false;f=400;var g=this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]?d("im-message-"+this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]):null;if(g){var j=g.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling?g.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling:g.parentNode.parentNode.parentNode.parentNode.parentNode;var i=this.isElementVisibleOnScreen(j,h,true);if(!i.top){d.scrollToNode(g.parentNode.parentNode.parentNode.parentNode.parentNode);return false}}return(e&&this.isScrollMax(h,f))};a.prototype.preventDefault=function(e){e=e||b.event;if(e.stopPropagation){e.stopPropagation()}else{e.cancelBubble=true}if(typeof(BXIM)!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup){BXIM.messenger.closeMenuPopup()}if(typeof(d)!="undefined"&&d.calendar&&d.calendar.get().popup){d.calendar.get().popup.close()}};a.prototype.countObject=function(g){var e=0;for(var f in g){if(g.hasOwnProperty(f)){e++}}return e};a.prototype.isElementCoordsBelow=function(h,f,k,j){if(this.isMobile()){return true}if(!f||typeof(f.getElementsByClassName)=="undefined"){return false}k=k?k:0;var i=this.getElementCoords(h,f);i.bottom=i.top+h.offsetHeight;var g=(i.top>=k);var e=(i.bottom>k);if(j){return{top:g,bottom:e,coords:i}}else{return(g||e)}};a.prototype.isElementVisibleOnScreen=function(j,h,g){if(this.isMobile()){return BitrixMobile.Utils.isElementVisibleOnScreen(j)}if(!h||typeof(h.getElementsByClassName)=="undefined"){return false}var k=this.getElementCoords(j,h);k.bottom=k.top+j.offsetHeight;var l=h.scrollTop;var f=l+h.clientHeight;var i=(k.top>=0&&k.top<f);var e=(k.bottom>0&&k.bottom<h.clientHeight);if(g){return{result:(i||e),top:i,bottom:e,coords:k}}else{return(i||e)}};a.prototype.getElementCoords=function(f,e){if(this.isMobile()){return BitrixMobile.Utils.getElementCoords(f)}if(!e||typeof(e.getElementsByClassName)=="undefined"){return false}var h=f.getBoundingClientRect();var g=e.getBoundingClientRect();return{originTop:h.top,originLeft:h.left,top:h.top-g.top,left:h.left-g.left}};a.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var f=[];if(e=="MESSAGE_TITLE"){f=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",d.date.convertBitrixFormat(d.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else{if(e=="MESSAGE"){f=[["",d.message("IM_M_MESSAGE_FORMAT_TIME")]]}else{if(e=="RECENT_TITLE"){f=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",d.date.convertBitrixFormat(d.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{if(e=="RECENT_OL_TITLE"){f=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",d.date.convertBitrixFormat(d.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{f=[["tommorow","tommorow, "+d.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+d.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+d.message("IM_M_MESSAGE_FORMAT_TIME")],["",d.date.convertBitrixFormat(d.message("FORMAT_DATETIME"))]]}}}}return f};a.prototype.formatDate=function(e,f){if(typeof(f)=="undefined"){f=this.getDateFormatType("DEFAULT")}if(!d.type.isDate(e)){if(typeof e=="string"){e=new Date(e)}console.log(e,f);console.trace()}return d.date.format(f,Math.round(e.getTime()/1000)+parseInt(d.message("SERVER_TZ_OFFSET"))+parseInt(d.message("USER_TZ_OFFSET")),Math.round((new Date).getTime()/1000)+parseInt(d.message("SERVER_TZ_OFFSET"))+parseInt(d.message("USER_TZ_OFFSET")),true)};a.prototype.getNowDate=function(f){var e=new Date();if(f===true){e=new Date(e.getFullYear(),e.getMonth(),e.getDate(),0,0,0)}return e};a.prototype.formatUrl=function(e){if(this.isMobile()&&this.BXIM.webComponent&&currentDomain){if(e&&e.indexOf("/")===0){e=currentDomain+e;return encodeURI(e)}}return e};a.prototype.isBlankAvatar=function(e){return e==""||e.toString().indexOf(this.BXIM.pathToBlankImage)>=0};a.prototype.getDefaultAvatar=function(e){return"/bitrix/js/im/images/default-avatar-"+e+".png"};a.prototype.hideErrorImage=function(f,e){if(e){d.remove(f.parentNode);return true}var g=f.src;if(f.parentNode&&f.parentNode.parentNode){f.parentNode.parentNode.className="";f.parentNode.parentNode.innerHTML='<a href="'+g+'" target="_blank">'+g+"</a>"}return true};a.prototype.prepareText=function(s,p,e,g,m,r){var f=s;p=p==true;e=e==true;g=g==true;m=m?m:false;f=d.util.trim(f);if(f.indexOf("/me")==0){f=f.substr(4);f="<i>"+f+"</i>"}else{if(f.indexOf("/loud")==0){f=f.substr(6);f="<b>"+f+"</b>"}}var n="&gt;&gt;";if(e&&f.indexOf(n)>=0){var h=false;var o=f.split("<br />");for(var l=0;l<o.length;l++){if(o[l].substring(0,n.length)==n){o[l]=o[l].replace(n,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++l<o.length&&o[l].substring(0,n.length)==n){o[l]=o[l].replace(n,"")}o[l-1]+="</div></div>";h=true}}f=o.join("<br />")}if(p){f=d.util.htmlspecialchars(f)}f=this.decodeBbCode(f,e);if(e){f=f.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\]<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(t,x,v,u,i,w){return(w>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+x+' <span class="bx-messenger-content-quote-time">'+v+"</span></div>"+u+"</div></div><br />"});f=f.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,function(i,w,u,t,v){return(v>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+w+"</div></div><br />"})}if(p){f=f.replace(/\n/gi,"<br />")}f=f.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(g){var k=false;f=f.replace(/<a(.*?)>(http[s]{0,1}:\/\/.*?)<\/a>/ig,function(t,i,v,u){if(!v.match(/(\.(jpg|jpeg|png|gif)\?|\.(jpg|jpeg|png|gif)$)/i)||v.indexOf("/docs/pub/")>0||v.indexOf("logout=yes")>0){return t}else{if(d.MessengerCommon.isMobile()){k=true;return(u>0?"<br />":"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+v+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}else{k=true;return(u>0?"<br />":"")+'<span class="bx-messenger-file-image"><a'+i+' target="_blank" class="bx-messenger-file-image-src"><img src="'+v+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></a></span>'}}});if(k){f=f.replace(/<\/span>(\n?)<br(\s\/?)>/ig,"</span>").replace(/<br(\s\/?)>(\n?)<br(\s\/?)>(\n?)<span/ig,"<br /><span")}}if(m){f=f.replace(new RegExp("("+m.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"),'<span class="bx-messenger-highlight">$1</span>')}if(this.BXIM.settings.enableBigSmile){var q=false;f=f.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?style="width:)(\d+)(px[^>]+?height:)(\d+)(px[^>]+?class="bx-smile"\s*\/?>\s*)$/,function j(v,x,w,u,i,t){q=true;return x+(parseInt(w,10)*2)+u+(parseInt(i,10)*2)+t});if(r&&q){r.oneSmileInMessage=true}}if(f.substr(-6)=="<br />"){f=f.substr(0,f.length-6)}f=f.replace(/<br><br \/>/ig,"<br />");f=f.replace(/<br \/><br>/ig,"<br />");return f};a.prototype.trimText=function(e){return d.util.trim(e)};a.prototype.purifyText=function(f,e){if(!f){return""}f=f.toString();f=this.trimText(f);if(f.indexOf("/me")==0){f=f.substr(4)}else{if(f.indexOf("/loud")==0){f=f.substr(6)}}if(f.substr(-6)=="<br />"){f=f.substr(0,f.length-6)}f=f.replace(/<br><br \/>/ig,"<br />");f=f.replace(/<br \/><br>/ig,"<br />");f=f.replace(/\[[buis]\](.*?)\[\/[buis]\]/ig,"$1");f=f.replace(/\[url\](.*?)\[\/url\]/ig,"$1");f=f.replace(/\[RATING=([1-5]{1})\]/ig,function(h,g){return"["+d.message("IM_F_RATING")+"] "});f=f.replace(/\[ATTACH=([0-9]{1,})\]/ig,function(h,g){return"["+d.message("IM_F_ATTACH")+"] "});f=f.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig,"$2");f=f.replace(/\[CHAT=([0-9]{1,})\](.*?)\[\/CHAT\]/ig,"$2");f=f.replace(/\[SEND=([0-9]{1,})\](.*?)\[\/SEND\]/ig,"$2");f=f.replace(/\[PUT=([0-9]{1,})\](.*?)\[\/PUT\]/ig,"$2");f=f.replace(/\[CALL=([0-9]{1,})\](.*?)\[\/CALL\]/ig,"$2");f=f.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/ig,"$2");f=f.replace(/<img.*?data-code="([^"]*)".*?>/ig,"$1");f=f.replace(/<span.*?title="([^"]*)".*?>.*?<\/span>/ig,"($1)");f=f.replace(/<img.*?title="([^"]*)".*?>/ig,"($1)");f=f.replace(/\[ATTACH=([0-9]{1,})\]/ig,function(g,i,h){return i==10000?"":"["+d.message("IM_F_ATTACH")+"] "});f=f.replace(/<s>([^"]*)<\/s>/ig," ");f=f.replace(/\[s\]([^"]*)\[\/s\]/ig," ");f=f.replace(/\[icon\=([^\]]*)\]/ig,function(g){var h=g.match(/title\=(.*[^\s\]])/i);if(h&&h[1]){h=h[1];if(h.indexOf("width=")>-1){h=h.substr(0,h.indexOf("width="))}if(h.indexOf("height=")>-1){h=h.substr(0,h.indexOf("height="))}if(h.indexOf("size=")>-1){h=h.substr(0,h.indexOf("size="))}if(h){h="("+this.trimText(h)+")"}}else{h="("+d.message("IM_M_ICON")+")"}return h}.bind(this));f=f.replace("<br />"," ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gmi," ["+d.message("IM_M_QUOTE_BLOCK")+"] ");f=this.trimText(f);if(f.length<=0){if(e&&e.FILE_ID&&e.FILE_ID.length>0){f="["+d.message("IM_F_FILE")+"]"}else{if(e&&e.ATTACH&&e.ATTACH.length>0){f="["+d.message("IM_F_ATTACH")+"]"}else{f=d.message("IM_M_DELETED")}}}return f};a.prototype.decodeBbCode=function(f,h,g){h=typeof(h)?false:h;f=f.replace(/\[LIKE\]/ig,'<span class="bx-smile bx-im-smile-like" title="'+d.message("IM_MESSAGE_LIKE")+'"></span>');f=f.replace(/\[DISLIKE\]/ig,'<span class="bx-smile bx-im-smile-dislike" title="'+d.message("IM_MESSAGE_DISLIKE")+'"></span>');f=f.replace(/\[USER=([0-9]{1,})\](.*?)\[\/USER\]/ig,d.delegate(function(k,j,l){var i="";if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="livechat"){return l}j=parseInt(j);if(!h&&l&&j>0){i='<span class="bx-messenger-ajax '+(j==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+j+'">'+l+"</span>"}else{i=l}return i},this));f=f.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/ig,function(l,k,j,m){var i="";j=parseInt(j);if(!h&&m&&j>0&&typeof(BXIM)!="undefined"){if(k){i='<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+j+'">'+m+"</span>"}else{i='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+j+'">'+m+"</span>"}}else{i=m}return i});f=f.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/ig,function(j,k,l){var i="";k=parseInt(k);if(!h&&l&&k>0){i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+k+'">'+l+"</span>"}else{i=l}return i});f=f.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/ig,function(j,l,k){var i="";k=k?k:l;l=l?l:k;if(!h&&k){k=k.replace(/<([\w]+)[^>]*>(.*?)<\\1>/i,"$2",k);k=k.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",k);i='<span class="bx-messenger-command" data-entity="send" title="'+d.message("IM_BB_SEND")+'">'+k+"</span>";i+='<span class="bx-messenger-command-data">'+l+"</span>"}else{i=k}return i});f=f.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/ig,function(j,l,k){var i="";k=k?k:l;l=l?l:k;if(!h&&k){k=k.replace(/<([\w]+)[^>]*>(.*?)<\/\1>/i,"$2",k);k=k.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",k);i='<span class="bx-messenger-command" data-entity="put" title="'+d.message("IM_BB_PUT")+'">'+k+"</span>";i+='<span class="bx-messenger-command-data">'+l+"</span>"}else{i=k}return i});f=f.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/ig,function(j,l,k){var i="";k=k?k:l;l=l?l:k;if(!h&&k){i='<span class="bx-messenger-command" data-entity="call" data-command="'+d.util.htmlspecialchars(l)+'">'+k+"</span>"}else{i=k}return i});var e=0;if(this.BXIM.settings.enableBigSmile){e=d.util.trim(f.replace(/\[icon\=([^\]]*)\]/ig,"")).length}f=f.replace(/\[icon\=([^\]]*)\]/ig,d.delegate(function(n){var k=n.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(k&&k[1]){k=k[1]}else{return""}var j={src:k,border:0};var l=n.match(/size\=(\d+)/i);if(l&&l[1]){j.width=l[1];j.height=l[1]}else{var m=n.match(/width\=(\d+)/i);if(m&&m[1]){j.width=m[1]}var i=n.match(/height\=(\d+)/i);if(i&&i[1]){j.height=i[1]}if(j.width&&!j.height){j.height=j.width}else{if(j.height&&!j.width){j.width=j.height}else{if(j.height&&j.width){}else{j.width=20;j.height=20}}}}j.width=j.width>100?100:j.width;j.height=j.height>100?100:j.height;if(this.BXIM.settings.enableBigSmile&&e==0&&j.width==j.height&&j.width==20){j.width=40;j.height=40}var o=n.match(/title\=(.*[^\s\]])/i);if(o&&o[1]){o=o[1];if(o.indexOf("width=")>-1){o=o.substr(0,o.indexOf("width="))}if(o.indexOf("height=")>-1){o=o.substr(0,o.indexOf("height="))}if(o.indexOf("size=")>-1){o=o.substr(0,o.indexOf("size="))}if(o){o=d.util.trim(o);j.title=o;j.alt=o}}else{j.title=d.message("IM_M_ICON");j.alt=j.title}return d.create("img",{attrs:j,props:{className:"bx-smile bx-icon"}}).outerHTML},this));f=f.replace(/\[RATING\=([1-5]{1})\]/ig,d.delegate(function(j,i){return this.linesVoteHeadNodes(0,i,false).outerHTML},this));return f};a.prototype.prepareTextBack=function(g,f){var e=g;f=f===true;e=d.util.htmlspecialcharsback(e);e=e.replace(/<(\/*)([buis]+)>/ig,"[$1$2]");e=e.replace(/<img.*?data-code="([^"]*)".*?>/ig,"$1");e=e.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/ig,"$1");if(!f){e=e.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gmi,"["+d.message("IM_M_QUOTE_BLOCK")+"]")}e=e.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("\t");e=e.split("&nbsp;").join(" ");e=e.split("<br />").join("\n");return e};a.prototype.addMentionList=function(f,g,e){if(!f||!g){return false}if(!this.BXIM.messenger.mentionList[f]){this.BXIM.messenger.mentionList[f]={}}this.BXIM.messenger.mentionList[f][g]=e};a.prototype.prepareMention=function(f,h){if(!this.BXIM.messenger.mentionList[f]){return h}for(var g in this.BXIM.messenger.mentionList[f]){var e=this.BXIM.messenger.mentionList[f][g];if(!e){continue}if(e.toString().substr(0,4)=="chat"){h=h.split(g).join("[CHAT="+e.toString().substr(4)+"]"+g+"[/CHAT]")}else{h=h.split(g).join("[USER="+e+"]"+g+"[/USER]")}}this.clearMentionList(f);return h};a.prototype.clearMentionList=function(e){delete this.BXIM.messenger.mentionList[e]};a.prototype.getRecipientByChatId=function(f){var g=0;if(this.BXIM.messenger.chat[f]){g="chat"+f}else{for(var e in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[e]==f){g=e;break}}}return g};a.prototype.getUserIdByChatId=function(g){var e=0;for(var f in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[f]==g){e=f;break}}return e};a.prototype.getUserParam=function(f,g){f=typeof(f)=="undefined"?this.BXIM.userId:f;g=typeof(g)=="boolean"?g:false;if(f.toString().substr(0,4)=="chat"||f.toString().substr(0,2)=="sg"){var e=f.toString().substr(0,4)=="chat"?f.toString().substr(4):f;if(g||!(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].id)){this.BXIM.messenger.chat[e]={id:e,name:d.message("IM_M_LOAD_USER"),owner:0,work_position:"",avatar:this.BXIM.pathToBlankImage,type:"chat",color:"#556574",fake:true,date_create:false};if(g){this.BXIM.messenger.chat[e].fake=false}}return this.BXIM.messenger.chat[e]}else{if(g||!(this.BXIM.messenger.users[f]&&this.BXIM.messenger.users[f].id)){var h=parseInt(f)?this.BXIM.path.profileTemplate.replace("#user_id#",f):"";this.BXIM.messenger.users[f]={id:f,avatar:this.BXIM.pathToBlankImage,name:d.message("IM_M_LOAD_USER"),profile:h,status:"guest",work_position:"",extranet:false,network:false,color:"#556574",fake:true,last_activity_date:new Date(0),mobile_last_date:new Date(0),absent:false,idle:false};this.BXIM.messenger.hrphoto[f]="/bitrix/js/im/images/hidef-avatar-v3.png";if(g){this.BXIM.messenger.users[f].fake=false}}return this.BXIM.messenger.users[f]}};a.prototype.userInChat=function(g,f){if(!this.BXIM.messenger.userInChat[g]){return false}if(typeof(f)=="undefined"){f=this.BXIM.userId}else{f=parseInt(f)}var h=false;if(typeof(this.BXIM.messenger.userInChat[g].indexOf)!="undefined"){if(this.BXIM.messenger.userInChat[g].indexOf(f.toString())>-1||this.BXIM.messenger.userInChat[g].indexOf(parseInt(f))>-1){h=true}}else{for(var e=0;e<this.BXIM.messenger.userInChat[g].length;e++){if(parseInt(this.BXIM.messenger.userInChat[g][e])==parseInt(f)){h=true;break}}}return h};a.prototype.onOnlineStatusCallback=function(f,h,e,g,i){console.log("Run callback for",i,f,h,e,g)};a.prototype.getUserStatus=function(f,k){k=k!==false;var h=this.getOnlineData(f);var g="";var j="";var e="";var i="";if(!f){g="guest";j=d.message("IM_STATUS_GUEST")}else{if(f.network){g="network";j=d.message("IM_STATUS_NETWORK")}else{if(f.bot){g="bot";j=d.message("IM_STATUS_BOT")}else{if(f.connector){g=f.status=="offline"?"lines":"lines-online";j=d.message("IM_CL_USER_LINES")}else{if(f.status=="guest"){g="guest";j=d.message("IM_STATUS_GUEST")}else{if(this.getCurrentUser()==f.id){g=f.status?f.status.toString():"";j=g?d.message("IM_STATUS_"+g.toUpperCase()):""}else{if(!h.isOnline){g="offline";j=d.message("IM_STATUS_OFFLINE")}else{if(this.getUserMobileStatus(f)){g="mobile";j=d.message("IM_STATUS_MOBILE")}else{if(this.getUserIdleStatus(f,h)){g="idle";j=d.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(f))}else{g=f.status?f.status.toString():"";j=d.message("IM_STATUS_"+g.toUpperCase())}}}}}}}}}if(f&&this.isBirthday(f.birthday)&&(f.status=="online"||!h.isOnline)){e=g;i=j;g="birthday";if(h.isOnline){j=d.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}else{j=d.message("IM_STATUS_OFFLINE")}}else{if(f&&f.absent){e=g;i=j;g="vacation";if(h.isOnline){j=d.message("IM_STATUS_ONLINE")}else{j=d.message("IM_STATUS_VACATION")}}}return k?g:{status:g,statusText:j,originStatus:e?e:g,originStatusText:i?i:j,}};a.prototype.getOnlineData=function(e){var f={};if(e){if(e.id==this.getCurrentUser()){e.last_activity_date=new Date();e.mobile_last_date=new Date(0);e.idle=false}f=d.user.getOnlineStatus(e.last_activity_date)}return f};a.prototype.getUserIdle=function(e){if(!e){return""}var f="";if(e.idle){var g=(new Date().getTime()-e.idle.getTime())/1000>=3600?"Hdiff":"idiff";f=this.formatDate(e.idle,g)}return f};a.prototype.getUserMobileStatus=function(e){if(!e){return false}var f=false;var h=e.mobile_last_date;var g=e.last_activity_date;if((new Date())-h<d.user.getSecondsForLimitOnline()*1000&&g-h<300*1000){f=true}return f};a.prototype.getUserIdleStatus=function(e,f){if(!e){return""}f=f?f:d.user.getOnlineStatus(e.last_activity_date);return e.idle&&f.isOnline};a.prototype.getUserPosition=function(f,g){g=g===true;if(!f){return""}var e="";if(g&&f.last_activity_date&&!(f.bot||f.network)){e=this.getUserLastDate(f);if(e){return e}}if(f.work_position){e=f.work_position}else{if(f.extranet||f.network){e=d.message("IM_CL_USER_EXTRANET")}else{if(f.bot){e=d.message("IM_CL_BOT")}else{e=this.isIntranet()?d.message("IM_CL_USER"):d.message("IM_CL_USER_B24")}}}return e};a.prototype.getUserLastDate=function(e){if(!e){return""}var g="";var f={};if(e.bot||e.network){g=""}else{if(e.absent&&!this.getUserMobileStatus(e)){f=this.getOnlineData(e);g=d.message("IM_STATUS_VACATION_TITLE").replace("#DATE#",d.date.format(d.date.convertBitrixFormat(d.message("FORMAT_DATE")),e.absent.getTime()/1000));if(f.isOnline&&e.idle){g=d.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else{if(f.isOnline&&!f.lastSeenText){g=d.message("IM_STATUS_ONLINE")+". "+g}else{if(f.lastSeenText){g=d.message("IM_LS_"+(e.gender=="F"?"F":"M")).replace("#POSITION#",g).replace("#LAST_SEEN#",f.lastSeenText)}}}}else{if(e.last_activity_date){f=this.getOnlineData(e);if(f.isOnline&&e.idle&&!this.getUserMobileStatus(e)){g=d.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else{if(f.isOnline&&!f.lastSeenText){if(this.isMobile()&&this.getUserMobileStatus(e)){g=d.message("IM_STATUS_MOBILE")}else{g=d.message("IM_STATUS_ONLINE")}}else{if(f.lastSeenText){g=d.message("IM_LS_SHORT_"+(e.gender=="F"?"F":"M")).replace("#LAST_SEEN#",f.lastSeenText)}}}}}}return g};a.prototype.isIntranet=function(){return this.BXIM.bitrixIntranet};a.prototype.getCurrentUser=function(){return this.BXIM.userId};a.prototype.getDialogId=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){return this.BXIM.messenger.currentTab}return parseInt(this.BXIM.messenger.currentTab)};a.prototype.getChatUsers=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)!="chat"){return[].push(parseInt(this.BXIM.messenger.currentTab))}var f=this.BXIM.messenger.currentTab.toString().substr(4);var e=[];if(this.BXIM.messenger.userInChat[f]){e=this.BXIM.messenger.userInChat[f].map(function(g){return parseInt(g)})}return e};a.prototype.setColor=function(e,f){if(!this.BXIM.init&&this.isDesktop()){d.desktop.onCustomEvent("bxSaveColor",[{color:e,chatId:f}]);return false}if(typeof(e)!="string"){return false}else{e=e.toUpperCase()}if(typeof(f)!="undefined"){if(typeof(this.BXIM.messenger.chat[f])=="undefined"){return false}}else{f=0;if(this.BXIM.userColor==e){return false}}d.ajax({url:this.BXIM.pathToAjax+"?SET_COLOR&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SET_COLOR:"Y",COLOR:e,CHAT_ID:f,sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(g){if(g.ERROR==""){if(parseInt(g.CHAT_ID)==0){this.BXIM.userColor=g.COLOR;if(this.isPage()){setTimeout(function(){d.MessengerWindow.setUserInfo(d.MessengerCommon.getUserParam())},500)}}}},this)})};a.prototype.checkRestriction=function(e,g){if(!this.BXIM.messenger.chat[e]){return null}if(!this.BXIM.messenger.chat[e].entity_type){return false}var f=this.BXIM.messenger.chat[e].entity_type;if(typeof(this.BXIM.messenger.userChatOptions[f])=="undefined"||typeof(this.BXIM.messenger.userChatOptions[f][g])=="undefined"){return false}if(!this.BXIM.messenger.userChatOptions[f][g]){return true}return false};a.prototype.getEntityTypePath=function(e){if(!this.BXIM.messenger.chat[e]){return null}if(!this.BXIM.messenger.chat[e].entity_type){return null}var f=this.BXIM.messenger.chat[e].entity_type;if(typeof(this.BXIM.messenger.userChatOptions[f])=="undefined"){return null}if(!this.BXIM.messenger.userChatOptions[f]["PATH"]){return null}return{PATH:this.BXIM.messenger.userChatOptions[f]["PATH"].replace("#ID#",this.BXIM.messenger.chat[e].entity_id),TITLE:this.BXIM.messenger.userChatOptions[f]["PATH_TITLE"]}};a.prototype.renameChat=function(e,g){e=parseInt(e);if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"||!g||e<=0){return false}g=d.util.trim(g);if(g.length<=0||this.BXIM.messenger.chat[e].name==d.util.htmlspecialchars(g)){return false}var f=this.BXIM.messenger.chat[e].name;this.BXIM.messenger.chat[e].name=d.util.htmlspecialchars(g);d.ajax({url:this.BXIM.pathToAjax+"?CHAT_RENAME&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_RENAME:"Y",CHAT_ID:e,CHAT_TITLE:g,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){if(h.ERROR){if(this.BXIM.messenger.popupMessengerPanelChatTitle){this.BXIM.messenger.popupMessengerPanelChatTitle.innerHTML=f}this.BXIM.messenger.chat[e].name=f}if(!this.BXIM.ppServerStatus){d.PULL.updateState(true)}},this)});return true};a.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.recentListRedraw(e)}else{if(this.BXIM.messenger.chatList){this.chatListRedraw(e)}else{this.contactListRedraw(e);if(this.BXIM.messenger.recentListExternal){this.recentListRedraw(e)}}}};a.prototype.contactListRedraw=function(e){if(this.BXIM.messenger.popupMessenger==null){return false}e=e||{};if(!this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.recentList=false;if(this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}}if(this.BXIM.messenger.contactListSearchText.length>0){this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,e.FORCE?{}:{params:false,timeout:this.isMobile()?500:100})}else{if(this.BXIM.messenger.redrawContactListTimeout.contactList){clearTimeout(this.BXIM.messenger.redrawContactListTimeout.contactList)}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.contactListPrepare());if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}e.SEND=e.SEND==true;if(!this.isMobile()&&e.SEND){d.localStorage.set("mrd",{viewGroup:this.BXIM.settings.viewGroup,viewOffline:this.BXIM.settings.viewOffline},5)}};a.prototype.contactListPrepareSearch=function(e,l,g,k){if(!l){return false}if(this.BXIM.messenger.openLinesFlag&&(e=="popupChatDialogContactListElements"&&this.BXIM.messenger.popupChatDialogDestType=="CHAT_EXTEND"||e=="popupTransferDialogContactListElements")){k.viewOffline=true;k.viewOnlyIntranet=true;k.viewOnlyBusiness=true;k.viewChat=false;k.viewOfflineWithPhones=false}var j={listName:e,groupOpen:true,viewSelf:e=="contactList",viewOffline:true,viewOnlyBusiness:false,viewGroup:true,viewChat:true,viewBot:true,viewTransferViQueue:false,viewTransferOlQueue:false,viewOpenChat:true,viewOfflineWithPhones:false,extra:false,searchText:g,callback:{empty:function(){}}};if(k!=false){for(var f in k){if(f=="timeout"||f=="params"){continue}j[f]=k[f]}}var h=k.timeout?k.timeout:0;if(h>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(d.delegate(function(){l.innerHTML="";l.appendChild(this.contactListPrepare(j));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}},this),h)}else{l.innerHTML="";l.appendChild(this.contactListPrepare(j));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};a.prototype.contactListPrepare=function(e){e=typeof(e)=="object"?e:{};return this.chatListPrepare(e)};a.prototype.contactListClickItem=function(h){this.BXIM.messenger.closeMenuPopup();var i=d.proxy_context.getAttribute("data-userId");if(i.toString().substr(0,9)=="structure"){var f=i.toString().substr(9);var g=this.BXIM.messenger.groups[f].name.split(" / ")[0];this.BXIM.messenger.popupContactListSearchInput.value=g;this.BXIM.messenger.contactListSearchText=i;this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,{});return d.PreventDefault(h)}if(this.BXIM.messenger.contactList){d.MessengerCommon.recentListElementToTop(d.proxy_context.getAttribute("data-userId"))}if(this.isMobile()||!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";d.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.realSearch=false;this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(d.proxy_context.getAttribute("data-userId"),d.proxy_context)}else{this.BXIM.messenger.openMessenger(d.proxy_context.getAttribute("data-userId"))}return d.PreventDefault(h)};a.prototype.contactListGetFromServer=function(e){if(this.BXIM.messenger.contactListLoad){return false}if(!d.type.isFunction(e)){e=d.DoNothing}this.BXIM.messenger.contactListLoad=true;d.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:(this.isDesktop()?"Y":"N"),sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){if(h&&h.BITRIX_SESSID){d.message({bitrix_sessid:h.BITRIX_SESSID})}if(h.ERROR==""){for(var g in h.USERS){h.USERS[g].last_activity_date=new Date(h.USERS[g].last_activity_date);h.USERS[g].mobile_last_date=new Date(h.USERS[g].mobile_last_date);h.USERS[g].idle=h.USERS[g].idle?new Date(h.USERS[g].idle):false;h.USERS[g].absent=h.USERS[g].absent?new Date(h.USERS[g].absent):false;this.BXIM.messenger.users[g]=h.USERS[g]}for(var g in h.GROUPS){this.BXIM.messenger.groups[g]=h.GROUPS[g]}for(var g in h.CHATS){if(this.BXIM.messenger.chat[g]&&this.BXIM.messenger.chat[g].fake){h.CHATS[g].fake=true}else{if(!this.BXIM.messenger.chat[g]){h.CHATS[g].fake=true}}h.CHATS[g].date_create=new Date(h.CHATS[g].date_create);this.BXIM.messenger.chat[g]=h.CHATS[g]}for(var g in h.PHONES){this.BXIM.messenger.phones[g]={};for(var f in h.PHONES[g]){this.BXIM.messenger.phones[g][f]=d.util.htmlspecialcharsback(h.PHONES[g][f])}}for(var g in h.USER_IN_GROUP){if(typeof(this.BXIM.messenger.userInGroup[g])=="undefined"||typeof(this.BXIM.messenger.userInGroup[g].users)=="undefined"||!this.BXIM.messenger.userInGroup[g].users.length){this.BXIM.messenger.userInGroup[g]=h.USER_IN_GROUP[g]}else{for(var f=0;f<h.USER_IN_GROUP[g].users.length;f++){this.BXIM.messenger.userInGroup[g].users.push(h.USER_IN_GROUP[g].users[f])}this.BXIM.messenger.userInGroup[g].users=d.util.array_unique(this.BXIM.messenger.userInGroup[g].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.BXIM.messenger.popupChatDialogContactListElementsType=="MENTION"})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}if(this.BXIM.messenger.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.messenger.popupTransferDialogContactListElements,this.BXIM.messenger.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false})}}e()}else{this.BXIM.messenger.contactListLoad=false;if(h.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(this.contactListGetFromServer,this),2000);d.onCustomEvent(b,"onImError",[h.ERROR,h.BITRIX_SESSID])}else{if(h.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(d.delegate(this.contactListGetFromServer,this),10000)}d.onCustomEvent(b,"onImError",[h.ERROR])}}}},this),onfailure:d.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false},this)})};a.prototype.contactListRealSearch=function(e,f){if(!this.BXIM.messenger.realSearch){return false}this.contactListRealSearchText=e;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(d.delegate(function(){if(this.contactListRealSearchText.length<3){this.BXIM.messenger.realSearchFound=true;return false}d.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.contactListRealSearchText,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.userInGroup.search={id:"search",users:[]};for(var g in h.USERS){if(this.BXIM.messenger.users[g]){continue}h.USERS[g].last_activity_date=new Date(h.USERS[g].mobile_last_date);h.USERS[g].mobile_last_date=new Date(h.USERS[g].mobile_last_date);h.USERS[g].idle=h.USERS[g].idle?new Date(h.USERS[g].idle):false;h.USERS[g].absent=h.USERS[g].absent?new Date(h.USERS[g].absent):false;this.BXIM.messenger.users[g]=h.USERS[g];this.BXIM.messenger.userInGroup.search["users"].push(g);if(h.USERS[g].bot&&h.USERS[g].network){this.BXIM.messenger.bot[g]={type:"network"};this.BXIM.messenger.users[g].extranet=false}}if(typeof(f)!="undefined"){f()}else{if(this.BXIM.messenger.contactList){this.contactListRedraw({FORCE:true})}}},this),onfailure:d.delegate(function(){this.BXIM.messenger.realSearchFound=true},this)})},this),1500)};a.prototype.contactListSearchClear=function(f){if(!this.BXIM.messenger.popupContactListSearchInput){return}clearTimeout(this.BXIM.messenger.contactListSearchTimeout);clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout.contactList){clearTimeout(this.BXIM.messenger.redrawContactListTimeout.contactList)}this.BXIM.messenger.realSearch=false;this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=d.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);d.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);d.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");d.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.userInGroup.search={id:"search",users:[]};this.userListRedraw()};a.prototype.contactListSearch=function(f){if(f.keyCode==16||f.keyCode==18||f.keyCode==20||f.keyCode==244||f.keyCode==91){return false}if(f.keyCode==37||f.keyCode==39){return true}if(this.BXIM.messenger.popupContactListSearchInput.value!=this.BXIM.messenger.contactListSearchLastText||this.BXIM.messenger.popupContactListSearchInput.value==""){}else{if(f.keyCode==224||f.keyCode==18||f.keyCode==17){return true}}if(f.keyCode==38||f.keyCode==40){return true}if(this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(!app.enableInVersion(10)){setTimeout(function(){document.body.scrollTop=0},100)}}else{if(f.keyCode==27){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}if(this.BXIM.messenger.contactListSearchText<=0&&!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&!this.BXIM.messenger.webrtc.callInit){this.BXIM.messenger.popupMessenger.destroy();return true}}else{this.contactListSearchClear();this.BXIM.messenger.popupMessengerTextarea.focus();return true}}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=true;if(f.keyCode==13){var g=true;var e=d.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-item");if(e){this.recentListElementToTop(e.getAttribute("data-userId"));this.BXIM.messenger.openMessenger(e.getAttribute("data-userid"))}else{var e=d.findChildByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-chatlist-search-button");if(e){g=false;this.BXIM.messenger.chatListSearchAction(e);return true}}if(g){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}this.BXIM.messenger.popupContactListSearchInput.value=""}}}if(this.BXIM.messenger.popupContactListSearchInput.value==this.BXIM.messenger.contactListSearchLastText){return true}this.BXIM.messenger.contactListSearchText=d.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);this.BXIM.messenger.contactListSearchLastText=this.BXIM.messenger.contactListSearchText;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.BXIM.messenger.contactListSearchText.length<3}if(!this.isMobile()){d.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.realSearch=false}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false;d.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");d.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}else{d.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");d.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.contactListRealSearch(this.BXIM.messenger.contactListSearchText)}this.userListRedraw()};a.prototype.recentListRedraw=function(e){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT")){return false}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.popupMessenger){if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null){return false}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.contactList=false}if(this.BXIM.messenger.popupContactListActive){d.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");d.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(this.BXIM.messenger.contactListSearchText==null||this.BXIM.messenger.contactListSearchText.length>0){this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout.contactList){clearTimeout(this.BXIM.messenger.redrawContactListTimeout.contactList)}if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";if(this.isPage()&&d.MessengerWindow.currentTab=="im-ol"){d.addClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentLinesListPrepare(e))}else{d.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.recentListPrepare(e))}if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML=this.BXIM.messenger.popupContactListElementsWrap.innerHTML}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}else{if(this.BXIM.messenger.recentListExternal){this.BXIM.messenger.recentListExternal.innerHTML="";this.BXIM.messenger.recentListExternal.appendChild(this.recentListPrepare(e))}}};a.prototype.recentListPrepare=function(k){var j=document.createDocumentFragment();var g={};k=typeof(k)=="object"?k:{};var e=k.showOnlyChat;if(!this.BXIM.messenger.recentListLoad){j.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-load"},html:d.message("IM_CL_LOAD")}));this.recentListGetFromServer();return j}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}for(var r in this.BXIM.messenger.unreadMessage){if(this.inRecentList(r)){continue}if(r.toString().substr(0,4)=="chat"){var m=this.BXIM.messenger.chat[r.toString().substr(4)];if(m&&m.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable){continue}}else{var m=this.BXIM.messenger.users[r]}if(typeof(m)=="undefined"||typeof(m.name)=="undefined"){this.readMessage(r,true,true);continue}var f=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[r]);if(this.BXIM.messenger.message[f]){this.BXIM.messenger.recent.push({chatId:this.BXIM.messenger.message[f].chatId,date:this.BXIM.messenger.message[f].date,id:f,params:{},recipientId:r.toString().substr(0,4)=="chat"?r:this.BXIM.userId,senderId:this.BXIM.messenger.message[f].senderId,text:this.BXIM.messenger.message[f].text,userId:r,userIsChat:r.toString().substr(0,4)=="chat",})}}this.BXIM.messenger.recent.sort(function(s,u){var v=s.date.getTime();var t=u.date.getTime();if(v>t){return -1}else{if(v<t){return 1}else{if(s>u){return -1}else{if(s<u){return 1}else{return 0}}}}});this.BXIM.messenger.recentListIndex=[];var l=this.isMobile()?49:999999;var h={};for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(!this.BXIM.messenger.recent[n].pinned){continue}if(typeof(this.BXIM.messenger.recent[n].userIsChat)=="undefined"){this.BXIM.messenger.recent[n].userIsChat=this.BXIM.messenger.recent[n].recipientId.toString().substr(0,4)=="chat"}var q=d.clone(this.BXIM.messenger.recent[n]);if(n>l){if(!this.BXIM.messenger.unreadMessage[q.userId]||(this.BXIM.messenger.unreadMessage[q.userId]&&this.BXIM.messenger.unreadMessage[q.userId].length==0)){continue}}var p="";if(q.userIsChat){var m=this.BXIM.messenger.chat[q.userId.toString().substr(4)];if(typeof(m)=="undefined"||typeof(m.name)=="undefined"||this.isPage()&&m.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator()){continue}var o="chat"+m.id}else{if(!e){var m=this.BXIM.messenger.users[q.userId];if(typeof(m)=="undefined"||typeof(m.name)=="undefined"){continue}if(typeof(m.active)!="undefined"&&!m.active&&!this.BXIM.messenger.unreadMessage[m.id]){continue}var o=m.id}else{continue}}h[o]=true;if(!g.favorites){g.favorites=true;j.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group bx-messenger-recent-group-pinned"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:d.message("IM_RECENT_PINNED")})]}))}j.appendChild(this.drawContactListElement({id:o,data:m,text:q.text,textSenderId:q.senderId,textParams:q.params,pinned:q.pinned}));this.BXIM.messenger.recentListIndex.push(o)}var g={};for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(this.BXIM.messenger.recent[n].pinned){continue}if(typeof(this.BXIM.messenger.recent[n].userIsChat)=="undefined"){this.BXIM.messenger.recent[n].userIsChat=this.BXIM.messenger.recent[n].recipientId.toString().substr(0,4)=="chat"}var q=d.clone(this.BXIM.messenger.recent[n]);if(n>l){if(!this.BXIM.messenger.unreadMessage[q.userId]||(this.BXIM.messenger.unreadMessage[q.userId]&&this.BXIM.messenger.unreadMessage[q.userId].length==0)){continue}}var p="";if(q.userIsChat){var m=this.BXIM.messenger.chat[q.userId.toString().substr(4)];if(typeof(m)=="undefined"||typeof(m.name)=="undefined"||this.isPage()&&m.entity_type=="LINES"&&this.BXIM.settings.linesTabEnable&&this.isLinesOperator()){continue}var o="chat"+m.id}else{if(!e){var m=this.BXIM.messenger.users[q.userId];if(typeof(m)=="undefined"||typeof(m.name)=="undefined"){continue}if(typeof(m.active)!="undefined"&&!m.active&&!this.BXIM.messenger.unreadMessage[m.id]){continue}var o=m.id}else{continue}}h[o]=true;if(q.date){q.date=this.formatDate(q.date,this.getDateFormatType("RECENT_TITLE"));if(!g[q.date]){g[q.date]=true;j.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:q.date})]}))}}else{if(!g.never){g.never=true;j.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:d.message("IM_RESENT_NEVER")})]}))}}j.appendChild(this.drawContactListElement({id:o,data:m,text:q.text,textSenderId:q.senderId,textParams:q.params}));this.BXIM.messenger.recentListIndex.push(o)}if(j.childNodes.length<=0){j.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:d.message("IM_M_CL_EMPTY")}))}return j};a.prototype.recentLinesListPrepare=function(w){var p=document.createDocumentFragment();w=typeof(w)=="object"?w:{};if(!this.BXIM.messenger.recentListLoad){p.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-load"},html:d.message("IM_CL_LOAD")}));this.recentListGetFromServer();return p}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var g={};var j=false;for(var o=0;o<this.BXIM.messenger.openlines.queue.length;o++){g[this.BXIM.messenger.openlines.queue[o].id]=parseInt(this.BXIM.messenger.openlines.queue[o].priority);if(!j&&g[this.BXIM.messenger.openlines.queue[o].id]>0){j=true}}var f={};var r=this.isMobile()?49:999999;var m=[];this.BXIM.messenger.recentListIndex=[];var k={};for(var o=0;o<this.BXIM.messenger.recent.length;o++){if(typeof(this.BXIM.messenger.recent[o].userIsChat)=="undefined"){this.BXIM.messenger.recent[o].userIsChat=this.BXIM.messenger.recent[o].recipientId.toString().substr(0,4)=="chat"}var t=this.BXIM.messenger.recent[o];if(o>r){if(!this.BXIM.messenger.unreadMessage[t.userId]||(this.BXIM.messenger.unreadMessage[t.userId]&&this.BXIM.messenger.unreadMessage[t.userId].length==0)){continue}}var l="";if(typeof(t.userIsChat)=="undefined"){t.userIsChat=t.recipientId.toString().substr(0,4)=="chat"}if(t.userIsChat){var q=this.BXIM.messenger.chat[t.userId.toString().substr(4)];if(typeof(q)=="undefined"||typeof(q.name)=="undefined"||q.entity_type!="LINES"){continue}t.chatId=q.id;var v="chat"+q.id}else{continue}k[v]=true;if(j&&!f[t.chatId]){var n=q.entity_id.toString().split("|");f[t.chatId]=g[n[1]]?g[n[1]]:0}var h=q.entity_data_1.toString().split("|");if(typeof(h[6])!="undefined"){h=parseInt(h[6])-(j?f[t.chatId]:0);t.dateStart=new Date(h*1000)}else{h=typeof(h[5])!="undefined"?parseInt(h[5]):0;t.dateStart=new Date(h*1000)}m.push(t)}m.sort(d.delegate(function(z,B){if(!this.BXIM.messenger.chat[z.chatId]){return -1}if(!this.BXIM.messenger.chat[B.chatId]){return 1}var C=z.dateStart.getTime();var A=B.dateStart.getTime();if(C<A){return -1}else{if(C>A){return 1}else{return 0}}},this));var u={};var x={};for(var e in this.BXIM.messenger.unreadMessage){if(k[e]){continue}x[e]=true}for(var e in x){if(e.toString().substr(0,4)=="chat"){var y=this.BXIM.messenger.chat[e.toString().substr(4)];if(!y||y.entity_type!="LINES"){continue}}else{continue}if(!u["30days"]){u["30days"]=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:""})]}))}var t={text:"",textSenderId:0,textParams:{}};var s=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[e]);if(this.BXIM.messenger.message[s]){t.text=this.BXIM.messenger.message[s].text;t.textSenderId=this.BXIM.messenger.message[s].senderId;t.textParams=this.BXIM.messenger.message[s].params}p.appendChild(this.drawContactListElement({id:e,data:y,text:t.text,textSenderId:t.senderId,textParams:t.params,showLastMessage:t.text!=""}));this.BXIM.messenger.recentListIndex.push(y.id)}if(this.BXIM.settings.linesNewGroupEnable){for(var o=0;o<m.length;o++){if(o>r){if(!this.BXIM.messenger.unreadMessage[t.userId]||(this.BXIM.messenger.unreadMessage[t.userId]&&this.BXIM.messenger.unreadMessage[t.userId].length==0)){continue}}var t=d.clone(m[o]);var l="";if(t.userIsChat){var q=this.BXIM.messenger.chat[t.userId.toString().substr(4)];if(typeof(q)=="undefined"||typeof(q.name)=="undefined"||q.entity_type!="LINES"||parseInt(q.owner)!=0){continue}if(t.senderId!=0&&this.BXIM.messenger.users[t.senderId]&&!this.BXIM.messenger.users[t.senderId].connector&&!this.BXIM.messenger.users[t.senderId].bot&&!(t.params&&t.params.CLASS=="bx-messenger-content-item-system")){continue}var v="chat"+q.id}else{continue}if(!u.groupNew){p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red-2"},html:d.message("IM_OL_LIST_NEW")})]}));u.groupNew=true}if(t.date){t.date=this.formatDate(t.dateStart,this.getDateFormatType("RECENT_OL_TITLE"));if(!u[t.date]){u[t.date]=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:t.date})]}))}}else{if(!u.never){u.never=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:d.message("IM_RESENT_NEVER")})]}))}}p.appendChild(this.drawContactListElement({id:v,data:q,text:t.text,textSenderId:t.senderId,textParams:t.params}))}}var u={};for(var o=0;o<m.length;o++){if(o>r){if(!this.BXIM.messenger.unreadMessage[t.userId]||(this.BXIM.messenger.unreadMessage[t.userId]&&this.BXIM.messenger.unreadMessage[t.userId].length==0)){continue}}var t=d.clone(m[o]);var l="";if(t.userIsChat){var q=this.BXIM.messenger.chat[t.userId.toString().substr(4)];if(typeof(q)=="undefined"||typeof(q.name)=="undefined"||q.entity_type!="LINES"||parseInt(q.owner)==0&&this.BXIM.settings.linesNewGroupEnable){continue}if(t.senderId!=0&&this.BXIM.messenger.users[t.senderId]&&!this.BXIM.messenger.users[t.senderId].connector&&!this.BXIM.messenger.users[t.senderId].bot&&!(t.params&&t.params.CLASS=="bx-messenger-content-item-system")){continue}var v="chat"+q.id}else{continue}if(!u.groupUnanswered){p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-red"},html:d.message("IM_OL_LIST_UNANSWERED")})]}));u.groupUnanswered=true}if(t.date){t.date=this.formatDate(t.dateStart,this.getDateFormatType("RECENT_OL_TITLE"));if(!u[t.date]){u[t.date]=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:t.date})]}))}}else{if(!u.never){u.never=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:d.message("IM_RESENT_NEVER")})]}))}}p.appendChild(this.drawContactListElement({id:v,data:q,text:t.text,textSenderId:t.senderId,textParams:t.params}))}m.sort(function(z,B){var C=z.date.getTime();var A=B.date.getTime();if(C>A){return -1}else{if(C<A){return 1}else{if(z>B){return -1}else{if(z<B){return 1}else{return 0}}}}});var u={};for(var o=0;o<m.length;o++){if(o>r){if(!this.BXIM.messenger.unreadMessage[t.userId]||(this.BXIM.messenger.unreadMessage[t.userId]&&this.BXIM.messenger.unreadMessage[t.userId].length==0)){continue}}var t=d.clone(m[o]);var l="";if(t.userIsChat){var q=this.BXIM.messenger.chat[t.userId.toString().substr(4)];if(typeof(q)=="undefined"||typeof(q.name)=="undefined"||q.entity_type!="LINES"){continue}if(t.senderId==0||!this.BXIM.messenger.users[t.senderId]||this.BXIM.messenger.users[t.senderId]&&(this.BXIM.messenger.users[t.senderId].connector||this.BXIM.messenger.users[t.senderId].bot)||(t.params&&t.params.CLASS=="bx-messenger-content-item-system")){continue}var v="chat"+q.id}else{continue}if(!u.groupAnswered){p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-green"},html:d.message("IM_OL_LIST_ANSWERED")})]}));u.groupAnswered=true}if(t.date){t.date=this.formatDate(t.date,this.getDateFormatType("RECENT_OL_TITLE"));if(!u[t.date]){u[t.date]=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:t.date})]}))}}else{if(!u.never){u.never=true;p.appendChild(d.create("div",{props:{className:"bx-messenger-recent-group"},children:[d.create("span",{props:{className:"bx-messenger-recent-group-title"},html:d.message("IM_RESENT_NEVER")})]}))}}p.appendChild(this.drawContactListElement({id:v,data:q,text:t.text,textSenderId:t.senderId,textParams:t.params}))}if(p.childNodes.length<=0){p.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:d.message("IM_M_OL_EMPTY")}))}return p};a.prototype.recentListAdd=function(g){g.date=g.date?g.date:new Date();if(!g.skipDateCheck){for(var e=0;e<this.BXIM.messenger.recent.length;e++){if(this.BXIM.messenger.recent[e].userId==g.userId&&Math.floor(this.BXIM.messenger.recent[e].date.getTime()/1000)>Math.floor(g.date.getTime()/1000)){return false}}}var f=[];f.push(g);for(var e=0;e<this.BXIM.messenger.recent.length;e++){if(this.BXIM.messenger.recent[e].userId==g.userId){g.pinned=this.BXIM.messenger.recent[e].pinned===true}else{f.push(this.BXIM.messenger.recent[e])}}this.BXIM.messenger.recent=f;if(!g.skipRedraw&&this.BXIM.messenger.recentList){if(this.isMobile()){clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);this.BXIM.messenger.redrawRecentListTimeout=setTimeout(d.delegate(function(){this.recentListRedraw()},this),300)}else{this.recentListRedraw()}}};a.prototype.inRecentList=function(e){if(!e){return false}var g=false;for(var f=0;f<this.BXIM.messenger.recent.length;f++){if(this.BXIM.messenger.recent[f].userId==e){g=true;break}}return g};a.prototype.recentListHide=function(f,e){if(!f){return false}var h=[];var j=false;for(var g=0;g<this.BXIM.messenger.recent.length;g++){if(!j&&this.BXIM.messenger.recent[g].userId==f){j=true;continue}h.push(this.BXIM.messenger.recent[g])}this.BXIM.messenger.recent=h;if(this.BXIM.messenger.recentList){this.recentListRedraw()}if(!this.isMobile()){d.localStorage.set("mrlr",f,5)}e=e!=false;if(e){d.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",DIALOG_ID:f,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()}})}this.readMessage(f,e,false);if(f.toString().substr(0,4)=="chat"){if(this.isMobile()){app.onCustomEvent("onPullClearWatch",{id:"IM_PUBLIC_"+f.substr(4)})}else{d.PULL.clearWatch("IM_PUBLIC_"+f.substr(4))}}delete this.BXIM.messenger.showMessage[f];delete this.BXIM.messenger.history[f];if(this.BXIM.messenger.currentTab==f){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.extraOpen(d.create("div",{attrs:{style:"padding-top: 300px"},props:{className:"bx-messenger-box-empty"},html:d.message("IM_M_EMPTY")}))}};a.prototype.recentListElementUpdate=function(g,e,h){if(g.toString().substr(0,4)=="chat"){for(var f=0;f<this.BXIM.messenger.recent.length;f++){if(this.BXIM.messenger.recent[f].userIsChat&&this.BXIM.messenger.recent[f].recipientId==g){if(this.BXIM.messenger.recent[f].id==e){this.BXIM.messenger.recent[f].text=h}break}}}else{for(var f=0;f<this.BXIM.messenger.recent.length;f++){if(!this.BXIM.messenger.recent[f].userIsChat&&this.BXIM.messenger.recent[f].userId==g){if(this.BXIM.messenger.recent[f].id==e){this.BXIM.messenger.recent[f].text=h}break}}}};a.prototype.recentListElementToTop=function(h){var k=false;for(var g=0;g<this.BXIM.messenger.recent.length;g++){if(this.BXIM.messenger.recent[g].userId==h){k=true;this.BXIM.messenger.recent[g].date=new Date();break}}if(!k){var j="";var f=this.getLastMessageInDialog(h);if(f){if(f.text){j=f.text}else{if(f.params&&f.params.FILE_ID&&f.params.FILE_ID.length>1){j="["+d.message("IM_F_FILE")+"]"}else{if(f.params&&f.params.ATTACH&&f.params.ATTACH.length>1){item.text="["+d.message("IM_F_ATTACH")+"]"}}}}if(!j){var e=this.getUserParam(h);if(e.type=="chat"){j=d.message("IM_CL_CHAT_2")}else{if(e.type=="open"){j=d.message("IM_CL_OPEN_CHAT")}else{if(e.type=="call"){j=d.message("IM_CL_PHONE")}else{if(e.type=="lines"){j=d.message("IM_CL_LINES")}else{j=d.util.htmlspecialcharsback(this.getUserPosition(this.BXIM.messenger.users[h],true))}}}}}this.BXIM.messenger.recent.push({id:"tempSort"+(+new Date()),date:new Date(),skipDateCheck:true,recipientId:h,senderId:h,text:d.MessengerCommon.prepareText(j,true),userId:h,params:{}})}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal){this.recentListRedraw()}if(!this.isMobile()){d.localStorage.set("mrlr",h,5)}};a.prototype.recentListElementPin=function(e,g){var h=false;for(var f=0;f<this.BXIM.messenger.recent.length;f++){if(this.BXIM.messenger.recent[f].userId==e){h=true;if(this.BXIM.messenger.recent[f].pinned==g){return true}this.BXIM.messenger.recent[f].pinned=g;break}}if(h&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}return true};a.prototype.recentListGetSortIndex=function(){var f={};var g=0;if(this.BXIM.messenger.recent.length<=0){this.recentListGetFromServer()}for(var e=0;e<this.BXIM.messenger.recent.length;e++){g=this.BXIM.messenger.recent.length-e;f[this.BXIM.messenger.recent[e].userId]=g}return f};a.prototype.recentListGetFromServer=function(){if(this.BXIM.messenger.recentListLoad){return false}this.BXIM.messenger.recentListLoad=true;d.ajax({url:this.BXIM.pathToAjax+"?RECENT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_RECENT_LIST:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){if(h&&h.BITRIX_SESSID){d.message({bitrix_sessid:h.BITRIX_SESSID})}if(h.ERROR==""){this.BXIM.messenger.recent=[];for(var g in h.RECENT){h.RECENT[g].date=new Date(h.RECENT[g].date);this.BXIM.messenger.recent.push(h.RECENT[g])}var f=false;for(var g in this.BXIM.messenger.unreadMessage){for(var e=0;e<this.BXIM.messenger.unreadMessage[g].length;e++){if(!f||this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]]&&f.SEND_DATE.getTime()<=this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].date.getTime()){f={ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].id,SEND_DATE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].date,RECIPIENT_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].recipientId,SENDER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].senderId,USER_ID:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].senderId,SEND_MESSAGE:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].text,PARAMS:this.BXIM.messenger.message[this.BXIM.messenger.unreadMessage[g][e]].params}}}}if(f){this.recentListAdd({userId:f.RECIPIENT_ID.toString().substr(0,4)=="chat"?f.RECIPIENT_ID:f.USER_ID,id:f.ID,date:f.SEND_DATE,recipientId:f.RECIPIENT_ID,senderId:f.SENDER_ID,text:f.SEND_MESSAGE,userIsChat:f.RECIPIENT_ID.toString().substr(0,4)=="chat",params:f.PARAMS},true)}for(var g in h.CHAT){if(this.BXIM.messenger.chat[g]&&this.BXIM.messenger.chat[g].fake){h.CHAT[g].fake=true}else{if(!this.BXIM.messenger.chat[g]){h.CHAT[g].fake=true}}h.CHAT[g].date_create=new Date(h.CHAT[g].date_create);this.BXIM.messenger.chat[g]=h.CHAT[g]}for(var g in h.USERS){h.USERS[g].last_activity_date=new Date(h.USERS[g].last_activity_date);h.USERS[g].mobile_last_date=new Date(h.USERS[g].mobile_last_date);h.USERS[g].idle=h.USERS[g].idle?new Date(h.USERS[g].idle):false;h.USERS[g].absent=h.USERS[g].absent?new Date(h.USERS[g].absent):false;this.BXIM.messenger.users[g]=h.USERS[g]}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal){this.recentListRedraw()}this.BXIM.messenger.smile=h.SMILE;this.BXIM.messenger.smileSet=h.SMILE_SET;this.BXIM.settingsNotifyBlocked=h.NOTIFY_BLOCKED;if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw()}if(this.BXIM.messenger.recent.length==0){this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare())}}else{this.BXIM.messenger.recentListLoad=false;if(h.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(this.recentListGetFromServer,this),2000);d.onCustomEvent(b,"onImError",[h.ERROR,h.BITRIX_SESSID])}else{if(h.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(d.delegate(this.recentListGetFromServer,this),10000)}d.onCustomEvent(b,"onImError",[h.ERROR])}}}},this),onfailure:d.delegate(function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.recentListLoad=false},this)})};a.prototype.drawContactListElement=function(u){if(!u||!u.id){return null}u.userIsChat=u.id.toString().substr(0,4)=="chat";u.userIsQueue=u.id.toString().substr(0,5)=="queue";u.userIsStructure=u.id.toString().substr(0,9)=="structure";u.extraClass=u.extraClass||"";u.showLastMessage=u.showLastMessage===false?false:true;u.showCounter=u.showCounter===false?false:true;u.data=u.data?u.data:{};var n="";var m="";var p="";var e="";if(u.showCounter){if(this.BXIM.messenger.unreadMessage[u.id]&&this.BXIM.messenger.unreadMessage[u.id].length>0){m="bx-messenger-cl-status-new-message";p='<span class="bx-messenger-cl-count-digit">'+(this.BXIM.messenger.unreadMessage[u.id].length<100?this.BXIM.messenger.unreadMessage[u.id].length:"99+")+"</span>"}if(this.countWriting(u.id)){e="bx-messenger-cl-status-writing"}}if(u.userIsQueue){u.data.avatar="";u.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}else{if(u.userIsStructure){u.data.avatar="";u.data.color=this.BXIM.messenger.users[this.BXIM.userId].color}}if(!u.data.avatar){u.data.avatar=this.BXIM.pathToBlankImage}var l="";var q=u.data.avatar;var v="";if(this.isMobile()){if(this.BXIM.messenger.currentTab==u.id){v="bx-messenger-cl-item-active "}var f="mobile-rc-avatar-id-"+u.data.id;l='id="'+f+'" data-src="'+u.data.avatar+'"';q=this.BXIM.pathToBlankImage;BitrixMobile.LazyLoad.registerImage(f,function(w){return !w.node.parentNode.parentNode.classList.contains("bx-messenger-hide")||w.node.parentNode.parentNode.parentNode.classList.contains("bx-messenger-chatlist-show-all")})}var s="";var o=false;if(this.BXIM.settings.viewLastMessage&&u.showLastMessage){if(this.BXIM.messenger.message[u.id]&&this.BXIM.messenger.message[u.id].text){u.text=this.BXIM.messenger.message[u.id].text}var j="";if(u.textSenderId==this.BXIM.userId){j='<span class="bx-messenger-cl-user-reply"></span>'}u.text=this.purifyText(u.text,u.textParams);s=j+""+u.text}else{if(u.userIsChat){if(u.data.type=="call"){s=d.message("IM_CL_PHONE")}else{if(u.data.type=="lines"){s=d.message("IM_CL_LINES")}else{if(u.data.type=="open"){s=d.message("IM_CL_OPEN_CHAT")}else{s=d.message("IM_CL_CHAT_2")}}}}else{if(u.userIsQueue){if(u.data.type=="olQueue"){s=d.message("IM_CL_OL_QUEUE")}else{if(u.data.type=="viQueue"){s=d.message("IM_CL_VI_QUEUE")}}}else{if(u.userIsStructure){s=d.message("IM_CL_STRUCTURE")}else{s=this.getUserPosition(this.BXIM.messenger.users[u.id],true)}}}}if(u.userIsChat){if(u.data.type=="lines"){var g=this.linesGetSession(this.BXIM.messenger.chat[u.id.substr(4)]);o=g.crm=="Y";n+=" bx-messenger-cl-avatar-"+this.linesGetSource(this.BXIM.messenger.chat[u.id.substr(4)])}else{n="bx-messenger-cl-item-chat-"+u.data.type}}else{if(u.userIsQueue){if(u.data.type=="olQueue"){n=" bx-messenger-cl-avatar-lines"}else{if(u.data.type=="viQueue"){n=" bx-messenger-cl-avatar-call"}}}else{if(u.userIsStructure){n=" bx-messenger-cl-avatar-structure"}}}var t=this.isBlankAvatar(u.data.avatar)?'style="background-color: '+u.data.color+'"':"";var r=u.userIsChat&&t?"bx-messenger-cl-avatar-status-hide":"";var k=u.data.name;if(!u.userIsChat&&!u.userIsQueue&&!u.userIsStructure&&this.BXIM.userId==u.data.id){k=k+" (<b><i>"+d.message("IM_YOU")+"</i></b>)"}var i="";var h="bx-messenger-cl-item  bx-messenger-cl-id-"+(u.userIsChat?"chat":"")+(u.userIsQueue?"queue":"")+u.data.id+" "+v;if(u.userIsChat){i="bx-messenger-cl-avatar-"+u.data.type+" "+(this.BXIM.messenger.generalChatId==u.data.id?" bx-messenger-cl-item-chat-general":"");h+="bx-messenger-cl-item-chat "+m+" "+e+" "+n+" "+(this.BXIM.messenger.generalChatId==u.data.id?"bx-messenger-cl-item-chat-general":"")}else{if(u.userIsQueue){h+=n}else{if(u.userIsStructure){h+=n}else{h+="bx-messenger-cl-status-"+this.getUserStatus(this.BXIM.messenger.users[u.data.id])+" "+m+" "+e}}}h+=" "+u.extraClass;if(u.pinned){h+=" bx-messenger-cl-item-pinned"}return d.create("span",{props:{className:h},attrs:{"data-userId":u.id,"data-name":d.util.htmlspecialcharsback(u.data.name),"data-status":this.getUserStatus(this.BXIM.messenger.users[u.data.id]),"data-avatar":u.data.avatar,"data-userIsChat":u.userIsChat,"data-isPinned":u.pinned,"data-userIsQueue":u.userIsQueue},html:'<span class="bx-messenger-cl-count">'+p+'</span><span title="'+u.data.name+'" class="bx-messenger-cl-avatar '+i+" "+r+'"><img class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(u.data.avatar)?" bx-messenger-cl-avatar-img-default":"")+'" src="'+q+'" '+l+" "+t+">"+(o?'<span class="bx-messenger-cl-crm"></span>':"")+(!u.userIsQueue&&!u.userIsStructure?'<span class="bx-messenger-cl-status"></span>':"")+'</span><span class="bx-messenger-cl-user"><div class="bx-messenger-cl-user-title'+(u.data.extranet&&u.data.type!="lines"?" bx-messenger-user-extranet":"")+'" title="'+u.data.name+'">'+k+'</div><div class="bx-messenger-cl-user-desc">'+s+"</div></span>"})};a.prototype.chatListRedraw=function(e){if(this.MobileActionNotEqual("RECENT")||this.BXIM.messenger.popupMessenger==null){return false}d.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");d.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null){return false}}this.BXIM.messenger.chatList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.contactList=false;clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout.contactList){clearTimeout(this.BXIM.messenger.redrawContactListTimeout.contactList)}if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}if(this.BXIM.messenger.popupContactListElementsWrap){d.removeClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(this.chatListPrepare(e))}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};a.prototype.chatListPrepare=function(g){var R=document.createDocumentFragment();var B={};g=typeof(g)=="object"?g:{};var M=typeof(g.listName)!="undefined"?g.listName:"contactList";var af=typeof(g.searchText)!="undefined"?g.searchText:this.BXIM.messenger.contactListSearchText;var z=!(af!=null&&af.length==0);var at=z&&af.substr(0,9)=="structure"?af.substr(9):0;var ar=this.BXIM.messenger.realSearch&&!this.BXIM.messenger.realSearchFound;var ag=typeof(g.viewOnlyIntranet)!="undefined"?g.viewOnlyIntranet:false;var m=typeof(g.viewOnlyBusiness)!="undefined"?g.viewOnlyBusiness:false;var D=typeof(g.extra)!="undefined"?g.extra:true;var ah=typeof(g.viewOffline)!="undefined"?g.viewOffline:z||!this.BXIM.settings?true:this.BXIM.settings.viewOffline;var aa=typeof(g.viewOfflineWithPhones)!="undefined"?g.viewOfflineWithPhones:false;var T=typeof(g.viewChat)!="undefined"?g.viewChat:true;var r=typeof(g.viewOpenChat)!="undefined"?g.viewOpenChat:true;var n=typeof(g.viewSelf)!="undefined"?g.viewSelf:true;var P=typeof(g.viewTransferViQueue)!="undefined"?g.viewTransferViQueue:false;var h=typeof(g.viewTransferOlQueue)!="undefined"?g.viewTransferOlQueue:false;var S=typeof(g.viewBot)!="undefined"?g.viewBot:true;var X=typeof(g.callback)!="undefined"?g.callback:{};var x=z&&af.length>=3&&this.BXIM.messenger.realSearchAvailable&&!this.BXIM.messenger.realSearch&&!ag;var U=M=="contactList"||M=="popupChatDialogContactListElements"&&(this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_ADD"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_EXTEND"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_CREATE"&&this.BXIM.messenger.chatCreateType!="private");var J=M=="contactList";if(typeof(X.empty)!="function"){X.empty=function(){}}if(!this.BXIM.messenger.contactListLoad){R.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-load"},html:d.message("IM_CL_LOAD")}));this.contactListGetFromServer();return R}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var G=this.BXIM.messenger.popupContactListElementsSize;var K=46;var ao=29;var f=26;var q=0;var F=z?5:3;var u=[];if(h){u.push({id:"olQueue",name:d.message("IM_CTL_CHAT_OL_QUEUE"),title:"",more:d.message("IM_CL_MORE_QUEUE")})}else{if(P){u.push({id:"viQueue",name:d.message("IM_CTL_CHAT_VI_QUEUE"),title:"",more:d.message("IM_CL_MORE_QUEUE")})}}var w=this.BXIM.messenger.users;if(z&&at){u.push({id:"private",name:d.message("IM_CTL_CHAT_PRIVATE"),title:d.message("IM_CL_CREATE_PRIVATE"),more:d.message("IM_CL_MORE_PRIVATE")});w={};if(this.BXIM.messenger.userInGroup[at]){for(var al=0;al<this.BXIM.messenger.userInGroup[at].users.length;al++){w[this.BXIM.messenger.userInGroup[at].users[al]]=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[at].users[al]]}}}else{if(z){u.push({id:"private",name:d.message("IM_CTL_CHAT_PRIVATE"),title:d.message("IM_CL_CREATE_PRIVATE"),more:d.message("IM_CL_MORE_PRIVATE")});u.push({id:"bot",name:d.message("IM_CTL_CHAT_BOT"),title:"",more:d.message("IM_CL_MORE_BOT")});u.push({id:"open",name:d.message("IM_CTL_CHAT_OPEN"),title:d.message("IM_CL_CREATE_OPEN"),more:d.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});u.push({id:"chat",name:d.message("IM_CTL_CHAT_CHAT"),title:d.message("IM_CL_CREATE_CHAT"),more:d.message("IM_CL_MORE_CHAT")});u.push({id:"lines",name:d.message("IM_CTL_CHAT_LINES"),title:"",more:d.message("IM_CL_MORE_LINES")});u.push({id:"call",name:d.message("IM_CTL_CHAT_CALL"),title:"",more:d.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});u.push({id:"ol",name:d.message("IM_CTL_CHAT_OL"),title:"",more:d.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});u.push({id:"extranet",name:d.message("IM_CTL_CHAT_EXTRANET"),title:d.message("IM_CL_CREATE_PRIVATE"),more:d.message("IM_CL_MORE_EXTRANET")});u.push({id:"structure",name:this.BXIM.bitrixIntranet?d.message("IM_CTL_CHAT_STRUCTURE"):d.message("IM_CL_GROUP"),title:"",more:this.BXIM.bitrixIntranet?d.message("IM_CL_MORE_STRUCTURE"):d.message("IM_CL_MORE_GROUP"),skip:!U});u.push({id:"blocked",name:d.message("IM_CTL_CHAT_BLOCKED"),title:"",more:d.message("IM_CL_MORE_EXTRANET")})}else{u.push({id:"open",name:d.message("IM_CTL_CHAT_OPEN"),title:d.message("IM_CL_CREATE_OPEN"),more:d.message("IM_CL_MORE_OPEN"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});u.push({id:"chat",name:d.message("IM_CTL_CHAT_CHAT"),title:d.message("IM_CL_CREATE_CHAT"),more:d.message("IM_CL_MORE_CHAT")});u.push({id:"lines",name:d.message("IM_CTL_CHAT_LINES"),title:"",more:d.message("IM_CL_MORE_LINES")});u.push({id:"call",name:d.message("IM_CTL_CHAT_CALL"),title:"",more:d.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});u.push({id:"private",name:d.message("IM_CTL_CHAT_PRIVATE"),title:d.message("IM_CL_CREATE_PRIVATE"),more:d.message("IM_CL_MORE_PRIVATE")});u.push({id:"bot",name:d.message("IM_CTL_CHAT_BOT"),title:"",more:d.message("IM_CL_MORE_BOT")});u.push({id:"ol",name:d.message("IM_CTL_CHAT_OL"),title:"",more:d.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});u.push({id:"extranet",name:d.message("IM_CTL_CHAT_EXTRANET"),title:d.message("IM_CL_CREATE_PRIVATE"),more:d.message("IM_CL_MORE_EXTRANET")});u.push({id:"structure",name:this.BXIM.bitrixIntranet?d.message("IM_CTL_CHAT_STRUCTURE"):d.message("IM_CTL_CHAT_GROUP"),title:"",more:this.BXIM.bitrixIntranet?d.message("IM_CL_MORE_STRUCTURE"):d.message("IM_CL_MORE_GROUP"),skip:!U});u.push({id:"blocked",name:d.message("IM_CTL_CHAT_BLOCKED"),title:"",more:d.message("IM_CL_MORE_EXTRANET")})}}for(var al=0;al<u.length;al++){if(u[al].skip){continue}q++}var l=G-(ao*q);var e=parseInt(l/K);var ap=Math.max(parseInt(l/q/K),F);var ab=0;var Z=0;for(var al=0;al<u.length;al++){u[al].countElement=0;if(u[al].skip){continue}u[al].countElement=ap}var C=[];if(z){af=af+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&d.correctText){var ad=d.correctText(af);if(ad!=af){af=af+" "+ad}}C=af.split(" ")}var v=this.recentListGetSortIndex();var V={};var O=[];for(var al=0;al<u.length;al++){V[al]=[];if(u[al].id=="private"||u[al].id=="extranet"||u[al].id=="blocked"||u[al].id=="bot"||u[al].id=="ol"){if(!S&&u[al].id=="bot"){u[al].skip=true}if(ag&&u[al].id=="extranet"){u[al].skip=true}if(!T&&u[al].id=="ol"){u[al].skip=true}if(u[al].skip){continue}for(var E in w){if(!w.hasOwnProperty(E)){continue}if(!n&&E==this.BXIM.userId){continue}if(typeof(this.BXIM.messenger.users[E].active)!="undefined"&&!this.BXIM.messenger.users[E].active){continue}if(m&&this.BXIM.messenger.businessUsers&&!this.BXIM.messenger.users[E].bot&&this.BXIM.messenger.businessUsers.indexOf(E.toString())==-1){continue}if(!ah){var k=this.getUserStatus(this.BXIM.messenger.users[E]);if(aa&&this.userHasPhone(E)){}else{if(k=="offline"){continue}}}var o=this.BXIM.messenger.userChat[E];if(u[al].id=="blocked"){if(!this.BXIM.messenger.userChatBlockStatus[o]||!this.BXIM.messenger.userChatBlockStatus[o][this.BXIM.userId]){continue}}else{if(this.BXIM.messenger.userChatBlockStatus[o]&&this.BXIM.messenger.userChatBlockStatus[o][this.BXIM.userId]){continue}}if(u[al].id=="extranet"){if(!this.BXIM.messenger.users[E].extranet){continue}}else{if(this.BXIM.messenger.users[E].extranet){continue}}if(u[al].id=="ol"){if(!this.BXIM.messenger.users[E].bot){continue}if(!this.BXIM.messenger.bot[E]||this.BXIM.messenger.bot[E].type!="network"){continue}}else{if(u[al].id=="bot"){if(!this.BXIM.messenger.users[E].bot||!this.BXIM.messenger.bot[E]){continue}if(this.BXIM.messenger.bot[E]&&this.BXIM.messenger.bot[E].type=="network"){continue}if(this.BXIM.messenger.popupChatDialogDestType=="CALL_INVITE_USER"){continue}if(this.BXIM.messenger.openChatFlag){var ak=this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)];if(ak&&ak.entity_type!="LINES"&&this.BXIM.messenger.bot[E].type=="openline"){continue}else{if(ak&&ak.entity_type=="LINES"&&!this.BXIM.messenger.bot[E].openline){continue}else{if(this.BXIM.messenger.bot[E].type=="network"){continue}}}}else{if(this.BXIM.messenger.bot[E].type=="network"||this.BXIM.messenger.bot[E].type=="openline"){continue}}}else{if(this.BXIM.messenger.users[E].bot){continue}}}if(z&&at){}else{if(z){var Q=this.BXIM.messenger.users[E];if(!Q){continue}var aq=Q.name.toLowerCase()+(Q.search_mark?" "+Q.search_mark:"");var aj=Q.work_position?(" "+Q.work_position).toLowerCase():"";var y=true;if(!v[E]){v[E]=0}for(var ae=0;ae<C.length;ae++){if(aq.indexOf(C[ae].toLowerCase())>=0){v[E]+=100+C[ae].length;y=false}if(aj.indexOf(C[ae].toLowerCase())>=0){v[E]+=50+C[ae].length;y=false}}if(y){continue}}}if(u[al].id=="bot"){V[al].push(this.BXIM.messenger.users[E])}else{if(u[al].id=="ol"){V[al].push(this.BXIM.messenger.users[E])}else{V[al].push(this.BXIM.messenger.users[E])}}}if(u[al].id=="bot"){V[al].sort(d.delegate(function(au,s){var j=v[au.id]?v[au.id]:0;var i=v[s.id]?v[s.id]:0;if(this.BXIM.messenger.bot[au.id]&&this.BXIM.messenger.bot[au.id]["code"]=="marta"){j=10000000}if(this.BXIM.messenger.bot[s.id]&&this.BXIM.messenger.bot[s.id]["code"]=="marta"){i=10000000}if(j>i){return -1}else{if(j<i){return 1}else{return 0}}},this))}else{if(z){V[al].sort(function(au,s){var j=v[au.id]?v[au.id]:0;var i=v[s.id]?v[s.id]:0;if(j>i){return -1}else{if(j<i){return 1}else{return 0}}})}else{V[al].sort(function(au,s){var j=v[au.id]?v[au.id]:0;var i=v[s.id]?v[s.id]:0;if(BXIM&&au.id==BXIM.userId){j=10000000}if(BXIM&&s.id==BXIM.userId){i=10000000}if(j>i){return -1}else{if(j<i){return 1}else{return 0}}})}}}else{if(u[al].id=="chat"||u[al].id=="open"||u[al].id=="call"||u[al].id=="lines"){if(!T&&u[al].id!="open"){u[al].skip=true}if(!r&&u[al].id=="open"){u[al].skip=true}if(u[al].skip){continue}for(var o in this.BXIM.messenger.chat){if(!this.BXIM.messenger.chat.hasOwnProperty(o)){continue}if(this.BXIM.messenger.chat[o].type!=u[al].id){continue}if(this.BXIM.messenger.generalChatId==o&&(!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet)){continue}if(z){var I=true;for(var ae=0;ae<C.length;ae++){if(this.BXIM.messenger.chat[o].name.toLowerCase().indexOf(C[ae].toLowerCase())>=0){I=false;break}}if(I){continue}}V[al].push(this.BXIM.messenger.chat[o])}V[al].sort(d.delegate(function(au,s){var j=v["chat"+au.id]?v["chat"+au.id]:0;var i=v["chat"+s.id]?v["chat"+s.id]:0;if(this.BXIM.messenger.generalChatId==au.id){j=10000000}else{if(this.BXIM.messenger.userChatBlockStatus[au.id]&&this.BXIM.messenger.userChatBlockStatus[au.id][this.BXIM.userId]){j=-1}}if(this.BXIM.messenger.generalChatId==s.id){i=10000000}else{if(this.BXIM.messenger.userChatBlockStatus[i.id]&&this.BXIM.messenger.userChatBlockStatus[i.id][this.BXIM.userId]){i=-1}}if(j>i){return -1}else{if(j>i){return -1}else{if(j<i){return 1}else{return 0}}}},this))}else{if(u[al].id=="olQueue"){if(!this.BXIM.messenger.openlines){continue}if(!this.BXIM.messenger.openlines.queue){continue}this.BXIM.messenger.openlines.queue.sort(function(j,i){if(j.transfer_count>i.transfer_count){return -1}else{if(j.transfer_count<i.transfer_count){return 1}else{if(j.id>i.id){return 1}else{if(j.id<i.id){return -1}else{return 0}}}}});for(var N=0;N<this.BXIM.messenger.openlines.queue.length;N++){if(z){var A=true;for(var ae=0;ae<C.length;ae++){if(this.BXIM.messenger.openlines.queue[N].name.toLowerCase().indexOf(C[ae].toLowerCase())>=0){A=false;break}}if(A){continue}}V[al].push(d.clone(this.BXIM.messenger.openlines.queue[N]))}}else{if(u[al].id=="structure"){if(u[al].skip){continue}for(var an in this.BXIM.messenger.groups){if(!this.BXIM.messenger.userInGroup[an]||this.BXIM.messenger.userInGroup[an].length<=0){continue}if(M=="popupChatDialogContactListElements"&&this.BXIM.messenger.userInGroup[an].length>200){continue}if(!J&&an.toString().substr(0,2)=="SG"){continue}if(z){var A=true;for(var ae=0;ae<C.length;ae++){if(this.BXIM.messenger.groups[an].name.toLowerCase().indexOf(C[ae].toLowerCase())>=0){A=false;break}}if(A){continue}}V[al].push(this.BXIM.messenger.groups[an])}V[al].sort(d.delegate(function(au,s){var j=au.id;var i=s.id;if(this.BXIM.messenger.userInGroup[j]&&this.BXIM.messenger.userInGroup[j].users.indexOf(this.BXIM.userId.toString())>-1){j=-1}if(this.BXIM.messenger.userInGroup[i]&&this.BXIM.messenger.userInGroup[i].users.indexOf(this.BXIM.userId.toString())>-1){i=-1}if(j>i){return 1}else{if(j<i){return -1}else{return 0}}},this))}}}}if(u[al].countElement>V[al].length){ab+=V[al].length;Z+=u[al].countElement-V[al].length}else{O.push(al);ab+=u[al].countElement}}if(ab<e){var am=0;var H=O.length;for(var al=0;al<Z;al++){if(O[am]&&u[O[am]]){u[O[am]].countElement=u[O[am]].countElement+1}am=am==H-1?0:am+1}}for(var al=0;al<u.length;al++){if(u[al].skip){continue}if(z&&V[al].length<=0){if(!x||u[al].id!="extranet"){continue}}if(V[al].length<=0&&!(u[al].id=="private"||u[al].id=="open"||u[al].id=="chat"||x&&u[al].id=="extranet")){continue}R.appendChild(d.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[(!D||u[al].id=="lines"||u[al].id=="call"||u[al].id=="blocked"||u[al].id=="bot"||u[al].id=="ol")?null:d.create("span",{attrs:{"data-type":u[al].id},props:{title:u[al].title,className:"bx-messenger-chatlist-group-add"}}),d.create("span",{props:{className:"bx-messenger-chatlist-group-title"},html:u[al].name})]}));if(V[al].length<=0){if(x&&u[al].id=="extranet"){R.appendChild(d.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[d.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:this.BXIM.bitrixIntranet?d.message("IM_SEARCH_B24"):d.message("IM_SEARCH_SITE")})]}))}continue}var ac=[];var t=1;for(var ai=0;ai<V[al].length;ai++){var Y=t<=u[al].countElement;t++;if(u[al].id=="private"||u[al].id=="extranet"||u[al].id=="bot"||u[al].id=="ol"){var Q=V[al][ai];ac.push(this.drawContactListElement({id:Q.id,data:Q,showLastMessage:false,showCounter:D,extraClass:Y?"":"bx-messenger-hide"}))}else{if(u[al].id=="chat"||u[al].id=="open"||u[al].id=="call"||u[al].id=="lines"){var W=V[al][ai];ac.push(this.drawContactListElement({id:"chat"+W.id,data:W,showLastMessage:false,showCounter:D,extraClass:Y?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}else{if(u[al].id=="olQueue"||u[al].id=="viQueue"){var p=V[al][ai];p.type=u[al].id;ac.push(this.drawContactListElement({id:"queue"+p.id,data:p,showLastMessage:false,showCounter:false,extraClass:Y?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}else{if(u[al].id=="structure"){var L=V[al][ai];ac.push(this.drawContactListElement({id:"structure"+L.id,data:L,showLastMessage:false,showCounter:false,extraClass:Y?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"}))}}}}}if(u[al].countElement<V[al].length){ac.push(d.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},children:[d.create("span",{attrs:{"data-id":u[al].id,"data-text":d.message("IM_CL_MORE").replace("#COUNT#",V[al].length-u[al].countElement),"data-title":u[al].more},props:{title:u[al].more,className:"bx-messenger-chatlist-more"},html:this.BXIM.messenger.contactListShowed[u[al].id]?d.message("IM_CL_HIDE"):d.message("IM_CL_MORE").replace("#COUNT#",V[al].length-u[al].countElement)})]}))}if(ac.length>0){R.appendChild(d.create("div",{props:{className:"bx-messenger-chatlist-category"+(this.BXIM.messenger.contactListShowed[u[al].id]?" bx-messenger-chatlist-show-all":"")},children:ac}));if(x&&u[al].id=="extranet"){R.appendChild(d.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[d.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:d.message("IM_SEARCH_B24")})]}))}}}if(ar){R.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-search"},html:d.message("IM_M_CL_SEARCH")}))}else{if(R.childNodes.length<=0){R.appendChild(d.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:d.message("IM_M_CL_EMPTY")}));X.empty()}}return R};a.prototype.userHasPhone=function(e){return(this.BXIM.messenger.users.hasOwnProperty(e)&&this.BXIM.messenger.users[e].phone_device||(this.BXIM.messenger.phones.hasOwnProperty(e)&&(this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_MOBILE")||this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_PHONE")||this.BXIM.messenger.phones[e].hasOwnProperty("WORK_PHONE"))))};a.prototype.prepareCommandList=function(f){f=typeof(f)=="string"?f:"";var k=d.clone(this.BXIM.messenger.command);var j=[];var l=[];for(var e=0;e<k.length;e++){if(this.BXIM.messenger.openChatFlag){if(d.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),k[e].bot_id)){j.push(k[e])}else{l.push(k[e])}}else{if(this.BXIM.messenger.currentTab==parseInt(k[e].bot_id)){j.push(k[e])}else{l.push(k[e])}}}for(var e=0;e<l.length;e++){j.push(l[e])}var h=[];var g="";for(var e=0;e<j.length;e++){if(f==""||j[e].command.indexOf(f)===1){if(this.BXIM.userExtranet&&!j[e].extranet){continue}if(!j[e].common){if(this.BXIM.messenger.openChatFlag){if(!d.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),j[e].bot_id)){continue}}else{if(this.BXIM.messenger.currentTab!=parseInt(j[e].bot_id)){continue}}}if(j[e].context!=""){if(j[e].context=="chat"){if(!this.BXIM.messenger.openChatFlag){continue}}else{if(j[e].context=="user"){if(this.BXIM.messenger.openChatFlag){continue}}else{if(f==""){continue}}}}if(g!=j[e].category){g=j[e].category;h.push({type:"category",title:g})}if(j[e].command=="/>>"){j[e].command=">>"}j[e].type="item";h.push(j[e])}}return h};a.prototype.drawMessage=function(s,n,Y,q){if(typeof(n)!="object"||this.BXIM.messenger.popupMessenger==null){return false}var O=this.BXIM.messenger.popupMessengerBodyWrap;var w="default";var ah=false;var af=true;var v=true;if(typeof(s)=="object"){ah=true;w=s.placeholderName||"custom";O=s.placeholder;af=s.showKeyboard==false?false:true;v=s.showReply==false?false:true}else{if(s!=this.BXIM.messenger.currentTab||s==0||!this.MobileActionEqual("DIALOG")){return false}}if(n.dropDuplicate){var H=d.findChildByClassName(O,"bx-messenger-content-item-id-"+n.id);if(H){d.remove(H)}n.dropDuplicate=false}q=q==true;Y=q?false:Y;var p=false;var T=false;var y=n.params&&n.params.IS_EDITED=="Y";var Z=n.params&&n.params.IS_DELETED=="Y";var V=Z?d.message("IM_M_DELETED"):n.text;var l=n.id.toString().indexOf("temp")==0;var t=l&&n.retry;var ac=n.senderId==0;var G=this.BXIM.ppServerStatus;var aa=n.params&&n.params.MENU;if(l){V=this.decodeBbCode(V);V=V.replace(/(^https|^http|[^"]https|[^"]http):\/\/([\S]+)\.(jpg|jpeg|png|gif)(\?[\S]+)?/ig,function(i){return'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+i+'" class="bx-messenger-file-image-text"></span></span>'})}if(ah){p=n.chatId&&this.BXIM.messenger.chat[n.chatId]?true:false;T=p&&n.chatId==this.BXIM.messenger.generalChatId;if(p&&this.BXIM.messenger.chat[n.chatId].type=="call"){G=false}else{if(p&&this.BXIM.messenger.chat[n.chatId].type=="lines"){var L=this.linesGetSource(this.BXIM.messenger.chat[n.chatId]);if(!(L=="livechat")){G=false}}else{if(!p&&this.BXIM.messenger.bot[n.recipientId]&&this.BXIM.messenger.bot[n.recipientId].type=="network"){G=false}}}}else{if(n.senderId==this.BXIM.userId){if(this.BXIM.messenger.popupMessengerLastMessage>0&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage]&&this.BXIM.messenger.message[this.BXIM.messenger.popupMessengerLastMessage].recipientId==this.BXIM.messenger.currentTab){if(this.BXIM.messenger.popupMessengerLastMessage<n.id){this.BXIM.messenger.popupMessengerLastMessage=n.id}}else{this.BXIM.messenger.popupMessengerLastMessage=n.id}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat";p=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="chat"||this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="open");T=p&&n.chatId==this.BXIM.messenger.generalChatId;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){G=false}else{if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="lines"){var L=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]);if(!(L=="livechat")){G=false}}else{if(!this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="network"){G=false}}}}if(typeof(n.params)!="object"){n.params={}}if(n.params.DATE_TEXT){for(var ab=0;ab<n.params.DATE_TEXT.length;ab++){V=V.split(n.params.DATE_TEXT[ab]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+n.id+'" data-ts="'+n.params.DATE_TS[ab]+'">'+n.params.DATE_TEXT[ab]+"</span>")}}var k=G&&typeof(n.params.LIKE)=="object"&&n.params.LIKE.length>0?n.params.LIKE.length:"";var J=G&&typeof(n.params.LIKE)=="object"&&d.util.in_array(this.BXIM.userId,n.params.LIKE);var f=this.diskDrawFiles(n.chatId,n.params.FILE_ID);if(f.length>0){f=d.create("div",{props:{className:"bx-messenger-file-box"+(V!=""?" bx-messenger-file-box-with-message":"")},children:f})}else{f=null}var z=v?this.drawMessageReply(n.id):null;var ai=null;var Q=[];if(n.params.ATTACH){for(var ab=0;ab<n.params.ATTACH.length;ab++){Q[ab]=n.params.ATTACH[ab]}var U=/\[ATTACH=([0-9]{1,})\]/gm;var j=[];while((j=U.exec(V))!==null){for(var ab=0;ab<Q.length;ab++){if(n.params.ATTACH[ab].ID==j[1]){ai=d.create("div",{props:{className:"bx-messenger-attach-box"},children:d.MessengerCommon.drawAttach(n.id,n.chatId,[Q[ab]])});V=V.replace("[ATTACH="+j[1]+"]",ai.innerHTML);delete Q[ab]}}}}if(n.params.LINK_ACTIVE&&n.params.LINK_ACTIVE.length>0&&n.params.LINK_ACTIVE.indexOf(this.BXIM.userId.toString())<0){V=V.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/ig,"$2")}var N="";if(n.params.CLASS){N=n.params.CLASS}var F=null;if(n.params.IMOL_SID&&parseInt(n.params.IMOL_SID)>0){F=d.create("div",{props:{className:"bx-messenger-message-extra"},html:d.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",n.params.IMOL_SID)})}if(n.params.IMOL_FORM&&this.BXIM.messenger.chat[n.chatId]&&this.BXIM.messenger.chat[n.chatId].type=="livechat"){var S=n.params.IMOL_FORM.toString().substr(-6)=="-delay";var g=S?n.params.IMOL_FORM.substr(0,n.params.IMOL_FORM.lastIndexOf("-delay")):n.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<n.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=g){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=n.id;this.BXIM.messenger.popupMessengerLiveChatDelayedForm=S?g:null;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(d.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(g)},this),S?30000:5000)}}ai=d.MessengerCommon.drawAttach(n.id,n.chatId,Q);if(ai.length>0){ai=d.create("div",{props:{className:"bx-messenger-attach-box"},children:ai})}else{ai=null}var K=null;if(af&&n.params.KEYBOARD){K=this.drawKeyboard(n.recipientId,n.id,n.params.KEYBOARD)}var C=false;if(!f&&!ai&&V.length<=0){C=true}if(n.system&&n.system=="Y"){ac=true;n.senderId=0}var E=false;var W=this.BXIM.messenger.users[n.senderId];if(!ac&&(typeof(W)=="undefined"||W.id<=0)){E=true;C=true}if(n.params&&W&&W.id>0&&(n.params.AVATAR||n.params.NAME||n.params.USER_ID)){W=d.clone(W);if(n.params.AVATAR){W.avatar=n.params.AVATAR}if(n.params.NAME){W.name=n.params.NAME;W.first_name=n.params.NAME.split(" ")[0]}n=d.clone(n);if(parseInt(n.params.USER_ID)){n.senderId="network"+n.params.USER_ID}}var u=this.linesVoteDraw(n.id);if(u){V=u;n.system="Y"}else{N=N.replace("bx-messenger-content-item-vote","");var ae=this.linesVoteResultDraw(n.id,V);if(ae){V=ae}}if(!ah){if(!this.BXIM.messenger.history[s]){this.BXIM.messenger.history[s]=[]}if(parseInt(n.id)>0&&this.BXIM.messenger.history[s].indexOf(n.id.toString())==-1){this.BXIM.messenger.history[s].push(n.id)}var h=0;if(!E){var r=false;if(this.BXIM.messenger.unreadMessage[s]&&d.util.in_array(n.id,this.BXIM.messenger.unreadMessage[s])){r=true}}}var ad=false;var M=null;if(q){M=O.firstChild;if(M){if(d.hasClass(M,"bx-messenger-content-empty")||d.hasClass(M,"bx-messenger-content-load")){d.remove(M)}else{if(d.hasClass(M,"bx-messenger-content-group")){M=M.nextSibling}}}}else{M=O.lastChild;if(M&&(d.hasClass(M,"bx-messenger-content-empty")||d.hasClass(M,"bx-messenger-content-load"))){d.remove(M)}else{if(M&&d.hasClass(M,"bx-messenger-content-item-notify")){if(n.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){d.remove(M);ad=false;M=O.lastChild}else{ad=true;M=O.lastChild.previousSibling}}}}if(!E){var e=this.formatDate(n.date,this.getDateFormatType("MESSAGE_TITLE"));var o=(typeof(d.translit)!="undefined"?d.translit(e):e);if(typeof(this.messageGroup)!="object"){this.messageGroup={}}if(typeof(this.messageGroup[w])!="object"){this.messageGroup[w]={}}if(!this.messageGroup[w][o]){this.messageGroup[w][o]=true;var m=[];if(this.BXIM.desktop&&this.isPage()){m=[d.create("a",{attrs:{name:"bx-im-go-"+n.date},props:{className:"bx-messenger-content-group-link"}}),d.create("a",{attrs:{id:"bx-im-go-"+o,href:"#bx-im-go-"+n.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:e})]}else{m=[d.create("a",{attrs:{name:"bx-im-go-"+n.date},props:{className:"bx-messenger-content-group-link"}}),d.create("div",{attrs:{id:"bx-im-go-"+o},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:e})]}var R=d.create("div",{props:{className:"bx-messenger-content-group"+(e==d.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:m});if(q){O.insertBefore(R,O.firstChild);M=R.nextSibling}else{if(ad&&M.nextElementSibling){O.insertBefore(R,M.nextElementSibling);M=R}else{O.appendChild(R)}}}}var D=false;var B=false;var ag=null;if(typeof(V)=="string"){if(V.length>0){var A=V.replace(/<img.*?data-code="([^"]*)".*?>/ig,"$1").replace(/<\/?[^>]+>/gi," ").replace(/(https|http):\/\/([\S]+)\.(jpg|jpeg|png|gif)(\?[\S]+)?/ig,function(i){return""}).trim();if(!A){D=true}}if(this.BXIM.settings.enableRichLink&&n.params.URL_ONLY=="Y"&&n.params.URL_ID&&n.params.URL_ID.length>0&&n.params.ATTACH&&n.params.ATTACH.length>0){B=true}var X={oneSmileInMessage:false};ag=d.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+n.id},html:this.prepareText(V,false,true,true,(!this.BXIM.messenger.openChatFlag||n.senderId==this.BXIM.userId?false:(this.BXIM.messenger.users[this.BXIM.userId].name)),X)});var I=X.oneSmileInMessage}else{ag=d.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+n.id},children:[V]});var I=false}if(!C){if(M){h=M.getAttribute("data-messageId")}if(ac){var x=d.create("div",{attrs:{"data-type":"system","data-senderId":"0","data-messageId":n.id,"data-blockmessageid":n.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+n.id+" bx-messenger-content-item-notice "+N},children:[F,d.create("span",{props:{className:"bx-messenger-content-item-content"+(I?" bx-messenger-content-item-content-transparent":"")+(D?" bx-messenger-content-item-content-without-padding":"")+(B&&!Z?" bx-messenger-content-item-content-rich-link":"")+(Z||y?" bx-messenger-message-edited":"")},children:[!T?[]:d.create("span",{attrs:{title:(aa?d.message("IM_M_MENU_APP_EXISTS")+" ":"")+d.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",d.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(aa?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!G?null:d.create("span",{props:{className:"bx-messenger-content-item-like"+(J?" bx-messenger-content-item-liked":"")+(k<=0?" bx-messenger-content-like-digit-off":"")},children:[d.create("span",{attrs:{"data-messageId":n.id},props:{className:"bx-messenger-content-like-button"},html:""}),d.create("span",{attrs:{title:k>0?d.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:k})],events:this.isMobile()?{click:d.delegate(function(i){this.BXIM.messageLike(n.id);return d.PreventDefault(i)},this)}:{}}),typeof(W)=="undefined"||W.id<=0?[]:d.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[d.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),d.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[d.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(d.MessengerCommon.isBlankAvatar(W.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(W.avatar),style:(this.isBlankAvatar(W.avatar)?"background-color: "+W.color:"")}}),this.BXIM.messenger.openChatFlag?d.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:d.util.htmlspecialcharsback(W.name)},html:W.first_name?W.first_name:W.name.split(" ")[0]}):null]})]}),d.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),d.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(q?" bx-messenger-content-item-text-wrap-append":"")+(Z?" bx-messenger-message-deleted":" ")},children:[f,ag,ai]})]}),d.create("span",{props:{className:"bx-messenger-content-item-params"},children:[d.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(n.date,this.getDateFormatType("MESSAGE"))}),]}),d.create("span",{props:{className:"bx-messenger-clear"}})]})]}),K,z]});if(n.system&&n.system=="Y"&&r){d.addClass(x,"bx-messenger-content-item-new")}}else{if(n.senderId==this.BXIM.userId){var x=d.create("div",{attrs:{"data-type":"self","data-senderId":n.senderId,"data-messageDate":n.date,"data-messageId":n.id,"data-blockmessageid":n.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+n.id+" bx-messenger-content-item-1 "+N},children:[F,d.create("span",{props:{className:"bx-messenger-content-item-content"+(I?" bx-messenger-content-item-content-transparent":"")+(D?" bx-messenger-content-item-content-without-padding":"")+(B&&!Z?" bx-messenger-content-item-content-rich-link":"")+(Z||y?" bx-messenger-message-edited":"")},children:[d.create("span",{attrs:{title:(aa?d.message("IM_M_MENU_APP_EXISTS")+" ":"")+d.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",d.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(aa?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!G?null:d.create("span",{props:{className:"bx-messenger-content-item-like"+(J?" bx-messenger-content-item-liked":"")+(k<=0?" bx-messenger-content-like-digit-off":"")},children:[d.create("span",{attrs:{"data-messageId":n.id},props:{className:"bx-messenger-content-like-button"},html:""}),d.create("span",{attrs:{title:k>0?d.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:k})],events:this.isMobile()?{click:d.delegate(function(i){this.BXIM.messageLike(n.id);return d.PreventDefault(i)},this)}:{}}),d.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[d.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),d.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[d.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(d.MessengerCommon.isBlankAvatar(W.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(W.avatar),style:(this.isBlankAvatar(W.avatar)?"background-color: "+W.color:"")}}),this.BXIM.messenger.openChatFlag?d.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:d.util.htmlspecialcharsback(W.name)},html:W.first_name?W.first_name:W.name.split(" ")[0]}):null]})]}),t?(d.create("span",{props:{className:"bx-messenger-content-item-status"},children:[d.create("span",{attrs:{title:d.message("IM_M_RETRY"),"data-messageid":n.id,"data-chat":parseInt(n.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[d.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})):(d.create("span",{props:{className:"bx-messenger-content-item-status"},children:l?[d.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]})),d.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(q?" bx-messenger-content-item-text-wrap-append":"")+(Z?" bx-messenger-message-deleted":" ")},children:[f,ag,ai]})]}),d.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!G||this.isMobile()?null:d.create("span",{props:{className:"bx-messenger-content-item-like"+(J?" bx-messenger-content-item-liked":"")+(k<=0?" bx-messenger-content-like-digit-off":"")},children:[d.create("span",{html:"&nbsp;"}),d.create("span",{attrs:{title:k>0?d.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:k}),d.create("span",{attrs:{"data-messageId":n.id},props:{className:"bx-messenger-content-like-button"},html:d.message("IM_MESSAGE_LIKE")})]}),d.create("span",{props:{className:"bx-messenger-content-item-date"},html:(t?d.message("IM_M_NOT_DELIVERED"):this.formatDate(n.date,this.getDateFormatType("MESSAGE")))}),]}),d.create("span",{props:{className:"bx-messenger-clear"}})]})]}),K,z]})}else{var x=d.create("div",{attrs:{"data-type":"other","data-senderId":n.senderId,"data-messageDate":n.date,"data-messageId":n.id,"data-blockmessageid":n.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+n.id+" bx-messenger-content-item-2"+(r?" bx-messenger-content-item-new":"")+" "+N},children:[F,d.create("span",{props:{className:"bx-messenger-content-item-content"+(I?" bx-messenger-content-item-content-transparent":"")+(D?" bx-messenger-content-item-content-without-padding":"")+(B&&!Z?" bx-messenger-content-item-content-rich-link":"")+(Z||y?" bx-messenger-message-edited":"")},children:[d.create("span",{attrs:{title:(aa?d.message("IM_M_MENU_APP_EXISTS")+" ":"")+d.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",d.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"+(aa?" bx-messenger-content-item-menu-with-apps":"")}}),!this.isMobile()||!G?null:d.create("span",{props:{className:"bx-messenger-content-item-like"+(J?" bx-messenger-content-item-liked":"")+(k<=0?" bx-messenger-content-like-digit-off":"")},children:[d.create("span",{attrs:{"data-messageId":n.id},props:{className:"bx-messenger-content-like-button"},html:""}),d.create("span",{attrs:{title:k>0?d.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:k})],events:this.isMobile()?{click:d.delegate(function(i){this.BXIM.messageLike(n.id);return d.PreventDefault(i)},this)}:{}}),d.create("span",{attrs:{title:d.util.htmlspecialcharsback(W.name)},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[d.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),d.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[d.create("img",{props:{className:"bx-messenger-content-item-avatar-img"+(d.MessengerCommon.isBlankAvatar(W.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{src:this.formatUrl(W.avatar),style:(this.isBlankAvatar(W.avatar)?"background-color: "+W.color:"")}}),this.BXIM.messenger.openChatFlag||W.bot?d.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:d.util.htmlspecialcharsback(W.name)},html:W.firstName?W.firstName:W.name.split(" ")[0]}):null]})]}),d.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),d.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(q?" bx-messenger-content-item-text-wrap-append":"")+(Z?" bx-messenger-message-deleted":" ")},children:[f,ag,ai]})]}),d.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!G||this.isMobile()?null:d.create("span",{props:{className:"bx-messenger-content-item-like"+(J?" bx-messenger-content-item-liked":"")+(k<=0?" bx-messenger-content-like-digit-off":"")},children:[d.create("span",{html:"&nbsp;"}),d.create("span",{attrs:{title:k>0?d.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:k}),d.create("span",{attrs:{"data-messageId":n.id},props:{className:"bx-messenger-content-like-button"},html:d.message("IM_MESSAGE_LIKE")})]}),d.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(n.date,this.getDateFormatType("MESSAGE"))}),]}),d.create("span",{props:{className:"bx-messenger-clear"}})]})]}),K,z]})}}}else{if(E){x=d.create("div",{attrs:{id:"im-message-"+n.id,"data-messageDate":n.date,"data-messageId":n.id,"data-blockmessageid":n.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}}if(x&&(!C||E)){var P=null;if(M&&M.getAttribute("data-senderId")!=n.senderId){P=d.create("div",{props:{className:"bx-messenger-item-delimiter"}})}if(q){O.insertBefore(x,M);if(P){O.insertBefore(P,M)}}else{if(ad&&M&&M.nextElementSibling){O.insertBefore(x,M.nextElementSibling);if(P){O.insertBefore(P,M.nextElementSibling)}}else{if(P){O.appendChild(P)}O.appendChild(x)}}}if(!ah&&!E&&Y!==false&&this.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=b.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else{if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}(this.BXIM.messenger.popupMessengerBodyAnimation=new d.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:d.easing.makeEaseInOut(d.easing.transitions.quart),step:d.delegate(function(i){this.BXIM.messenger.popupMessengerBody.scrollTop=i.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}if(n.params.SENDING=="Y"||n.params.IS_DELIVERED=="N"){this.drawProgessMessage(n.id)}return h};a.prototype.drawMessageReply=function(o){var h=null;if(!(this.BXIM.messenger.message[o]&&this.BXIM.messenger.message[o].params&&this.BXIM.messenger.message[o].params.CHAT_ID>0)){return h}var k=this.BXIM.messenger.message[o].params.CHAT_ID;var p=this.BXIM.messenger.message[o].chatId;var f=[];var g=this.BXIM.messenger.message[o].params.CHAT_USER||[];var m=0;for(var j=g.length-1;j>=0;j--){if(!this.BXIM.messenger.users[g[j]]||!this.BXIM.messenger.userInChat[p]||this.BXIM.messenger.userInChat[p].indexOf(g[j])==-1&&this.BXIM.messenger.userInChat[p].indexOf(g[j].toString())==-1){continue}var e=this.isBlankAvatar(this.BXIM.messenger.users[g[j]].avatar)?this.BXIM.messenger.users[g[j]].color:"transparent";f.push(d.create("span",{props:{className:"bx-messenger-panel-chat-user"},children:[d.create("span",{props:{className:"bx-notifier-popup-avatar"},children:[d.create("img",{props:{className:"bx-notifier-popup-avatar-img"+(this.isBlankAvatar(this.BXIM.messenger.users[g[j]].avatar)?" bx-notifier-popup-avatar-img-default":"")},attrs:{src:this.formatUrl(this.BXIM.messenger.users[g[j]].avatar)},style:{backgroundColor:e}})]})]}));m++;if(m==5){break}}var l=this.BXIM.messenger.message[o].params.CHAT_LAST_DATE?new Date(this.BXIM.messenger.message[o].params.CHAT_LAST_DATE):"";var n=this.BXIM.messenger.message[o].params.CHAT_MESSAGE||0;h=d.create("div",{props:{className:"bx-messenger-content-reply"},attrs:{id:"im-message-content-reply-"+o,"data-messageId":o,"data-chatid":k},children:[d.create("span",{props:{className:"bx-messenger-content-reply-block"},children:[d.create("span",{props:{className:"bx-messenger-content-reply-comment"},children:[d.create("span",{props:{className:"bx-messenger-content-reply-answer"},events:{click:d.delegate(function(){this.joinParentChat(d.proxy_context.getAttribute("data-messageId"),d.proxy_context.getAttribute("data-chatId"))},this)},attrs:{"data-messageId":o,"data-chatId":k},html:n+" "+this.getMessagePlural("IM_R_COMMENT",n)}),d.create("span",{props:{className:"bx-messenger-content-reply-date"},html:l?", "+this.formatDate(l):""}),]}),d.create("span",{props:{className:"bx-messenger-content-reply-users"},children:f}),d.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]}),d.create("span",{props:{className:"bx-messenger-content-reply-join"},children:[d.create("span",{props:{className:"bx-messenger-content-reply-join-button"},html:d.message("IM_M_OPEN"),events:{click:d.delegate(function(){this.joinParentChat(d.proxy_context.getAttribute("data-messageId"),d.proxy_context.getAttribute("data-chatId"))},this)},attrs:{"data-messageId":o,"data-chatId":k},}),]}),d.create("div",{props:{className:"bx-messenger-content-reply-clear"}}),]});return h};a.prototype.joinParentChat=function(e,f){if(!e||!f){return false}if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]){this.BXIM.messenger.blockJoinChat[f]=false;this.BXIM.messenger.openMessenger("chat"+f)}else{this.BXIM.messenger.blockJoinChat[f]=true;d.ajax({url:this.BXIM.pathToAjax+"?PARENT_CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_PARENT_CHAT_JOIN:"Y",CHAT_ID:f,MESSAGE_ID:e,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false;this.BXIM.messenger.openMessenger("chat"+f)},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this)})}};a.prototype.openReplyDialog=function(e){if(this.isMobile()){alert(d.message("IM_AV_NEXT_VERSION"));return false}this.BXIM.messenger.openMessengerPanel();this.BXIM.messenger.popupMessengerBodyPanelTitleName.innerHTML=d.message("IM_R_DIALOG_TITLE");var f=this.drawMessageReply(e);if(f){this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML="";this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.appendChild(f)}else{this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML=d.message("IM_R_COMMENT_ZERO")}this.BXIM.messenger.popupMessengerBodyPanelWrap.innerHTML="";d.adjust(this.BXIM.messenger.popupMessengerBodyPanelWrap,{children:[this.BXIM.messenger.popupMessengerBodyPanelWrapMessage=d.create("div",{props:{className:"bx-messenger-body-panel-wrap-message"}}),this.BXIM.messenger.popupMessengerBodyPanelWrapMessages=d.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-list"}}),d.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-textarea"},children:[this.popupMessengerTextareaPlace=d.create("div",{props:{className:"bx-messenger-textarea-place"},children:[d.create("div",{props:{className:"bx-messenger-textarea-send"},children:[d.create("a",{attrs:{href:"#send"},props:{className:"bx-messenger-textarea-send-button"},events:{click:d.delegate(this.sendMessage,this)}}),]}),this.popupMessengerBodyPanelSmileButton=d.create("div",{attrs:{title:d.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:d.delegate(function(g){this.openSmileMenu();return d.PreventDefault(g)},this)}}),d.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupMessengerPanelTextarea=d.create("textarea",{props:{value:"",className:"bx-messenger-textarea-input"}}),this.popupMessengerPanelTextareaPlaceholder=d.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:d.message("IM_M_TA_TEXT")})]}),d.create("div",{props:{className:"bx-messenger-textarea-clear"}}),]})]})]});if(typeof(this.messageGroup)!="object"){this.messageGroup={}}this.messageGroup.reply={};this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessage,placeholderName:"reply",showKeyboard:false,showReply:false},this.BXIM.messenger.message[e]);if(f){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+d.message("IM_R_LOAD_COMMENT")+"</span></div>"}else{this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+d.message("IM_R_NO_COMMENT")+"</span></div>"}this.messageGroup.replyMessages={};if(f){setTimeout(d.delegate(function(){if(!this.BXIM.messenger.message[e]||this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.CHAT_ID<=0){return false}var g="chat"+this.BXIM.messenger.message[e].params.CHAT_ID;this.loadLastMessage(g,d.delegate(function(j,h,m){if(!h){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+d.message("IM_F_ERROR")+"</span></div>";return false}this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML="";var l=d.util.shuffle(this.BXIM.messenger.showMessage[j]);for(var k=0;k<l.length;k++){this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessages,placeholderName:"replyMessages",showKeyboard:false,showReply:false,},this.BXIM.messenger.message[l[k]])}},this))},this),1000)}return true};a.prototype.checkProgessMessage=function(){for(messageId in this.BXIM.messenger.popupMessengerSendingTimeout){if(!this.BXIM.messenger.message[messageId]||!this.BXIM.messenger.message[messageId].params||!this.BXIM.messenger.message[messageId].params.SENDING_TS){delete this.BXIM.messenger.popupMessengerSendingTimeout[messageId]}else{if(parseInt(this.BXIM.messenger.message[messageId].params.SENDING_TS)+86400<((new Date).getTime()/1000)){this.drawProgessMessage(messageId)}}}};a.prototype.drawProgessMessage=function(e,g){var f=d("im-message-"+e);if(!f){return false}d.addClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");d.MessengerTimer.start("progressMessage",e,5000,function(k){var j=d("im-message-"+k);if(!j){return false}d.addClass(j.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start")});f.parentNode.parentNode.parentNode.previousSibling.innerHTML="";var h=true;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"&&parseInt(this.BXIM.messenger.message[e].params.SENDING_TS)+86400<(new Date()).getTime()/1000||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];this.BXIM.messenger.message[e].params.IS_DELIVERED="N";this.BXIM.messenger.message[e].params.SENDING="N";this.BXIM.messenger.message[e].params.SENDING_TS=0;h=false;var i=d.findChildByClassName(f.parentNode.parentNode.parentNode,"bx-messenger-content-item-date");if(i){i.innerHTML=d.message("IM_M_NOT_DELIVERED")}}if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.SENDING=="Y"){this.BXIM.messenger.popupMessengerSendingTimeout[e]=this.BXIM.messenger.message[e].params.SENDING_TS}if(!h){if(this.BXIM.messenger.message[e]){d.addClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");d.MessengerTimer.stop("progressMessage",e,true)}}else{if(typeof(g)=="object"||g===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;d.addClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");d.MessengerTimer.stop("progressMessage",e,true);g.chat=g.chat?g.chat:(parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N");d.adjust(f.parentNode.parentNode.parentNode.previousSibling,{children:[d.create("span",{attrs:{title:g.title?g.title:"","data-messageid":e,"data-chat":g.chat},props:{className:"bx-messenger-content-item-error"},children:[d.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{d.MessengerTimer.stop("progressMessage",e,true);d.removeClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");d.removeClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");d.removeClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{d.adjust(f.parentNode.parentNode.parentNode.previousSibling,{children:[d.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}}return true};a.prototype.clearProgessMessage=function(e){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];var f=d("im-message-"+e);if(!f){return false}if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){return false}d.MessengerTimer.stop("progressMessage",e,true);d.removeClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");d.removeClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");d.removeClass(f.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");f.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};a.prototype.startWriting=function(f,e,g){if(e==this.BXIM.userId){this.BXIM.messenger.writingList[f]=true;this.drawWriting(f);clearTimeout(this.BXIM.messenger.writingListTimeout[f]);this.BXIM.messenger.writingListTimeout[f]=setTimeout(d.delegate(function(){this.endWriting(f)},this),29500)}else{if(!this.BXIM.messenger.writingList[e]){this.BXIM.messenger.writingList[e]={}}if(!this.BXIM.messenger.writingListTimeout[e]){this.BXIM.messenger.writingListTimeout[e]={}}this.BXIM.messenger.writingList[e][f]=true;this.drawWriting(f,e);clearTimeout(this.BXIM.messenger.writingListTimeout[e][f]);this.BXIM.messenger.writingListTimeout[e][f]=setTimeout(d.delegate(function(){this.endWriting(f,e)},this),29500)}};a.prototype.drawWriting=function(j,g,l){l=typeof(l)=="undefined"?true:l;if(g==this.BXIM.userId){return false}if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[j]||g&&this.countWriting(g)>0){var k=d.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(g?g:j));if(k){for(var h=0;h<k.length;h++){d.addClass(k[h],"bx-messenger-cl-status-writing")}}var k=d.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(g?g:j));if(k){for(var h=0;h<k.length;h++){d.addClass(k[h],"bx-messenger-cl-status-writing")}}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==j||g&&this.BXIM.messenger.currentTab==g)){if(g){var e=[];for(var h in this.BXIM.messenger.writingList[g]){if(this.BXIM.messenger.writingList[g].hasOwnProperty(h)&&this.BXIM.messenger.users[h]){e.push(this.BXIM.messenger.users[h].name)}}this.drawNotifyMessage(g,"writing",d.message("IM_M_WRITING").replace("#USER_NAME#",e.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(j,"writing",d.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[j].name))}}}else{if(!this.BXIM.messenger.writingList[j]||g&&this.countWriting(g)==0){var k=d.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(g?g:j));if(k){for(var h=0;h<k.length;h++){d.removeClass(k[h],"bx-messenger-cl-status-writing")}}var k=d.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(g?g:j));if(k){for(var h=0;h<k.length;h++){d.removeClass(k[h],"bx-messenger-cl-status-writing")}}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==j||this.BXIM.messenger.currentTab==g)){if(!g){if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(this.BXIM.messenger.users[j])}}var f=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(f&&d.hasClass(f,"bx-messenger-content-item-notify")&&this.BXIM.messenger.popupMessengerBody){if(!g&&this.BXIM.messenger.readedList[j]){this.drawReadMessage(j,this.BXIM.messenger.readedList[j].messageId,this.BXIM.messenger.readedList[j].date,false)}else{if(g&&this.BXIM.messenger.readedList[g]){this.drawReadMessageChat(g,false)}else{if(d.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=b.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else{if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}(this.BXIM.messenger.popupMessengerBodyAnimation=new d.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-f.offsetHeight},transition:d.easing.makeEaseInOut(d.easing.transitions.quart),step:d.delegate(function(i){this.BXIM.messenger.popupMessengerBody.scrollTop=i.scroll},this),complete:d.delegate(function(){d.remove(f)},this)})).animate()}else{if(l){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-f.offsetHeight;d.remove(f)}}}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-f.offsetHeight;d.remove(f)}}}}}}}}};a.prototype.endWriting=function(f,e,g){g=typeof(g)=="undefined"?true:g;if(e.toString().substr(0,4)=="chat"){if(this.BXIM.messenger.writingListTimeout[e]&&this.BXIM.messenger.writingListTimeout[e][f]){clearTimeout(this.BXIM.messenger.writingListTimeout[e][f])}if(this.BXIM.messenger.writingList[e]&&this.BXIM.messenger.writingList[e][f]){delete this.BXIM.messenger.writingList[e][f]}}else{clearTimeout(this.BXIM.messenger.writingListTimeout[f]);delete this.BXIM.messenger.writingList[f]}this.drawWriting(f,e,g)};a.prototype.sendWriting=function(e){if(!this.BXIM.ppServerStatus||e=="create"||e==this.BXIM.userId){return false}if(!this.BXIM.messenger.writingSendList[e]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=true;var f="N";if(e.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[e.toString().substr(4)]){f="Y"}d.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:e,OL_SILENT:f,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(g){if(g&&g.BITRIX_SESSID){d.message({bitrix_sessid:g.BITRIX_SESSID})}if(g.ERROR=="AUTHORIZE_ERROR"&&this.isDesktop()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;d.onCustomEvent(b,"onImError",[g.ERROR])}else{if(g.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;d.onCustomEvent(b,"onImError",[g.ERROR,g.BITRIX_SESSID])}else{if(g.ERROR=="AUTHORIZE_ERROR"||g.ERROR=="SESSION_ERROR"){d.onCustomEvent(b,"onImError",[g.ERROR])}}}},this)});this.BXIM.messenger.writingSendListTimeout[e]=setTimeout(d.delegate(function(){this.endSendWriting(e)},this),30000)}};a.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};a.prototype.countWriting=function(e){var g=0;if(this.BXIM.messenger.writingList[e]){if(typeof(this.BXIM.messenger.writingList[e])=="object"){for(var f in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(f)){g++}}}else{g=1}}return g};a.prototype.leaveFromChat=function(g,e){if(!this.BXIM.messenger.chat[g]){return false}e=e!=false;if(!e){if(this.BXIM.messenger.chat[g].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.chat[g];delete this.BXIM.messenger.userInChat[g];delete this.BXIM.messenger.unreadMessage[g];delete this.BXIM.messenger.showMessage[g];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+g){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}}else{for(var f=0;f<this.BXIM.messenger.userInChat[g].length;f++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[g][f])){delete this.BXIM.messenger.userInChat[g][f];break}}this.BXIM.messenger.dialogStatusRedraw();delete this.BXIM.messenger.unreadMessage[g]}this.recentListHide("chat"+g,false);this.userListRedraw()}else{d.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:g,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(j){if(j.ERROR==""){this.readMessage("chat"+j.CHAT_ID,true,false);if(this.BXIM.messenger.chat[j.CHAT_ID].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.showMessage[j.CHAT_ID];delete this.BXIM.messenger.userInChat[j.CHAT_ID];delete this.BXIM.messenger.unreadMessage[j.CHAT_ID];delete this.BXIM.messenger.chat[j.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+j.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;d.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}}}else{for(var h=0;h<this.BXIM.messenger.userInChat[j.CHAT_ID].length;h++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[j.CHAT_ID][h])){delete this.BXIM.messenger.userInChat[j.CHAT_ID][h];break}}delete this.BXIM.messenger.unreadMessage[j.CHAT_ID];this.BXIM.messenger.dialogStatusRedraw()}this.recentListHide("chat"+j.CHAT_ID,false);this.userListRedraw();d.localStorage.set("mcl",j.CHAT_ID,5)}},this)})}};a.prototype.dialogCloseCurrent=function(f){var e=d.findChildByClassName(this.BXIM.messenger.popupContactListWrap,"bx-messenger-cl-item");if(e&&!f){this.BXIM.messenger.openMessenger(e.getAttribute("data-userId"))}else{this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}};a.prototype.pullEvent=function(){var f=d.delegate(function(z,k,ah){if(this.isMobile()){if(this.BXIM.webComponent&&!this.BXIM.checkRevision(ah.revision_im_mobile)){return false}}else{if(!this.BXIM.checkRevision(ah.revision_im_web)){return false}}if(z=="generalChatId"){this.BXIM.messenger.generalChatId=k.id}else{if(z=="updateSettings"){for(var ae in k){this.BXIM.settings[ae]=k[ae]}}else{if(z=="generalChatAccess"){if(this.BXIM.messenger.canSendMessageGeneralChat&&k.status=="blocked"){if(this.MobileActionEqual("DIALOG")){this.BXIM.messenger.canSendMessageGeneralChat=false;if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.redrawChatHeader({userRedraw:false})}}}else{if(this.isMobile()&&this.MobileActionEqual("DIALOG")){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}else{if(this.isDesktop()){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}}}}else{if(z=="desktopOffline"){this.BXIM.desktopStatus=false}else{if(z=="desktopOnline"){this.BXIM.desktopStatus=true}else{if(z=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}this.readMessage(k.userId,false,false,true)}else{if(z=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}this.readMessage("chat"+k.chatId,false,false,true)}else{if(z=="readMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}if(!this.BXIM.messenger.readedList["chat"+k.chatId]){this.BXIM.messenger.readedList["chat"+k.chatId]={}}this.BXIM.messenger.readedList["chat"+k.chatId][k.userId]={messageId:k.lastId,date:new Date(k.date)};this.drawReadMessageChat("chat"+k.chatId)}else{if(z=="readMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}this.drawReadMessage(k.userId,k.lastId,new Date(k.date));if(typeof(this.BXIM.messenger.users[k.userId])!="undefined"){this.BXIM.messenger.users[k.userId].idle=false;this.BXIM.messenger.users[k.userId].last_activity_date=new Date();if(this.BXIM.messenger.currentTab.toString()==k.userId.toString()){var ag=d.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[k.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(ag)}else{if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=ag?". "+ag:""}}}}if(typeof(this.BXIM.messenger.users[k.userId])!="undefined"){this.BXIM.messenger.users[k.userId].idle=false;this.BXIM.messenger.users[k.userId].last_activity_date=new Date();if(this.BXIM.messenger.currentTab.toString()==k.userId.toString()){var ag=d.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[k.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(ag)}else{if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=ag?". "+ag:""}}}}}else{if(z=="unreadMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}var N=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(N&&d.hasClass(N,"bx-messenger-content-item-notify")){if(k.userId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){d.remove(N)}}if(typeof(this.BXIM.messenger.users[k.userId])!="undefined"){this.BXIM.messenger.users[k.userId].idle=false;this.BXIM.messenger.users[k.userId].last_activity_date=new Date();if(this.BXIM.messenger.currentTab.toString()==k.userId.toString()){var ag=d.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[k.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(ag)}else{if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=ag?". "+ag:""}}}}}else{if(z=="unreadMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}if(!this.BXIM.messenger.readedList["chat"+k.chatId]){this.BXIM.messenger.readedList["chat"+k.chatId]={}}delete this.BXIM.messenger.readedList["chat"+k.chatId][k.userId];this.drawReadMessageChat("chat"+k.chatId);if(typeof(this.BXIM.messenger.users[k.userId])!="undefined"){this.BXIM.messenger.users[k.userId].idle=false;this.BXIM.messenger.users[k.userId].last_activity_date=new Date();if(this.BXIM.messenger.currentTab.toString()==k.userId.toString()){var ag=d.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[k.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(ag)}else{if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=ag?". "+ag:""}}}}}else{if(z=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}if(this.isBot(k.userId)&&!k.DEFERRED&&this.BXIM.messenger.showMessage[k.dialogId]&&this.BXIM.messenger.showMessage[k.dialogId].length){var v=this.BXIM.messenger.bot[k.userId];if(v.type=="human"){var m=d.clone({command:z,params:k,extra:ah});setTimeout(d.delegate(function(){m.params.DEFERRED=true;if(this.isMobile()){d.onCustomEvent(b,"onPull-im",[m])}else{d.onCustomEvent(b,"onPullEvent-im",[m.command,m.params,m.extra])}},this),1000);return false}}if(typeof(this.BXIM.messenger.users[k.userId])!="undefined"){this.BXIM.messenger.users[k.userId].idle=false;this.BXIM.messenger.users[k.userId].last_activity_date=new Date();if(this.BXIM.messenger.currentTab.toString()==k.userId.toString()){var ag=d.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[k.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(ag)}else{if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=ag?". "+ag:""}}}}this.startWriting(k.userId,k.dialogId,k.userName)}else{if(z=="addBot"||z=="updateBot"){if(this.BXIM.userExtranet){return false}this.BXIM.messenger.bot[k.bot.id]=k.bot;k.user.last_activity_date=new Date(k.user.last_activity_date);k.user.mobile_last_date=new Date(k.user.mobile_last_date);k.user.idle=k.user.idle?new Date(k.user.idle):false;k.user.absent=k.user.absent?new Date(k.user.absent):false;this.BXIM.messenger.users[k.user.id]=k.user;if(typeof(k.userInGroup)!="undefined"){for(var ae in k.userInGroup){if(typeof(this.BXIM.messenger.userInGroup[ae])=="undefined"||typeof(this.BXIM.messenger.userInGroup[ae].users)=="undefined"||!this.BXIM.messenger.userInGroup[ae].users.length){this.BXIM.messenger.userInGroup[ae]=k.userInGroup[ae]}else{for(var ad=0;ad<k.userInGroup[ae].users.length;ad++){this.BXIM.messenger.userInGroup[ae].users.push(k.userInGroup[ae].users[ad])}this.BXIM.messenger.userInGroup[ae].users=d.util.array_unique(this.BXIM.messenger.userInGroup[ae].users)}}}}else{if(z=="updateUser"){k.user.last_activity_date=new Date(k.user.last_activity_date);k.user.mobile_last_date=new Date(k.user.mobile_last_date);k.users[ae].idle=k.users[ae].idle?new Date(k.users[ae].idle):false;k.users[ae].absent=k.users[ae].absent?new Date(k.users[ae].absent):false;this.BXIM.messenger.users[k.user.id]=k.user;this.BXIM.messenger.redrawChatHeader()}else{if(z=="deleteBot"){if(this.BXIM.messenger.bot[k.botId]){delete this.BXIM.messenger.bot[k.botId]}if(this.BXIM.messenger.users[k.botId]){delete this.BXIM.messenger.users[k.botId]}this.recentListHide(k.botId,false);if(this.BXIM.messenger.currentTab==k.botId){this.BXIM.messenger.openMessenger("general")}}else{if(z=="chatMuteNotify"){this.muteMessageChat(k.dialogId,k.mute,false)}else{if(z=="message"||z=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG")){return false}if(!k.deferred&&this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=k.message.id){return false}if(k.message.senderId!=this.BXIM.userId){d.onCustomEvent("onImMessageReceive",[{command:z,params:k}])}var E=k.message.senderId;if(k.message.recipientId.toString().substr(0,4)=="chat"){E=k.message.recipientId}if(this.sendBotCommandBlock[k.message.senderId]){for(var s in this.sendBotCommandBlock[k.message.senderId]){delete this.sendBotCommandBlock[k.message.senderId][s];var R=d("im-message-keyboard-"+s);if(R){var ab=d.findChildrenByClassName(R,"bx-messenger-keyboard-button-block",false);for(var ae=0;ae<ab.length;ae++){d.removeClass(ab[ae],"bx-messenger-keyboard-button-progress");d.removeClass(ab[ae],"bx-messenger-keyboard-button-block")}}}}if(this.isBot(k.message.senderId)&&!k.deferred&&this.BXIM.messenger.showMessage[E]&&this.BXIM.messenger.showMessage[E].length){var v=this.BXIM.messenger.bot[k.message.senderId];if(v.type=="human"){if(k.chat[E]&&k.chat[E].entity_type=="LINES"){Z=1000}else{var Z=(k.message.text.split(" ").length*300)+1000;if(Z>5000){Z=5000}}var m=d.clone({command:z,params:k,extra:ah,waitTime:Z});setTimeout(d.delegate(function(){m.params.deferred=true;if(this.isMobile()){d.onCustomEvent(b,"onPull-im",[m])}else{d.onCustomEvent(b,"onPullEvent-im",[m.command,m.params,m.extra])}},this),Z);return false}}var af={};af.MESSAGE={};af.USERS_MESSAGE={};k.message.date=new Date(k.message.date);for(var ae in k.chat){k.chat[ae].date_create=new Date(k.chat[ae].date_create);this.BXIM.messenger.chat[ae]=k.chat[ae]}for(var ae in k.userInChat){this.BXIM.messenger.userInChat[ae]=k.userInChat[ae]}for(var ae in k.userBlockChat){this.BXIM.messenger.userChatBlockStatus[ae]=k.userBlockChat[ae]}var y={};for(var ae in k.users){if(this.BXIM.messenger.users[ae]&&this.BXIM.messenger.users[ae].status!=k.users[ae].status&&Math.round(k.message.date.getTime()/1000)+180>Math.round(new Date()/1000)){y[ae]=this.BXIM.messenger.users[ae].status;this.BXIM.messenger.users[ae].status=k.users[ae].status}}if(this.MobileActionEqual("RECENT")){for(var ae in y){if(!this.BXIM.messenger.users[ae]){continue}var q=d.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+ae);if(q!=null){for(var ad=0;ad<q.length;ad++){var O=d.MessengerCommon.getUserStatus(this.BXIM.messenger.users[ae]);d.removeClass(q[ad],"bx-messenger-cl-status-"+y[ae]);d.addClass(q[ad],"bx-messenger-cl-status-"+O);q[ad].setAttribute("data-status",O)}}var q=d.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+ae);if(q!=null){for(var ad=0;ad<q.length;ad++){var O=d.MessengerCommon.getUserStatus(this.BXIM.messenger.users[ae]);d.removeClass(q[ad],"bx-messenger-cl-status-"+y[ae]);d.addClass(q[ad],"bx-messenger-cl-status-"+O);q[ad].setAttribute("data-status",O)}}}}q=null;af.USERS=k.users;if(this.MobileActionEqual("DIALOG")){for(var ae in k.files){if(!this.BXIM.disk.files[k.chatId]){this.BXIM.disk.files[k.chatId]={}}if(this.BXIM.disk.files[k.chatId][ae]){continue}k.files[ae].date=new Date(k.files[ae].date);this.BXIM.disk.files[k.chatId][ae]=k.files[ae]}}af.MESSAGE[k.message.id]=k.message;this.BXIM.lastRecordId=parseInt(k.message.id)>this.BXIM.lastRecordId?parseInt(k.message.id):this.BXIM.lastRecordId;var aa=k.message.text;if(!aa||aa.length<=0){if(k.message.params&&k.message.params.FILE_ID&&k.message.params.FILE_ID.length>0){aa="["+d.message("IM_F_FILE")+"]"}else{if(k.message.params&&k.message.params.ATTACH&&k.message.params.ATTACH.length>0){aa="["+d.message("IM_F_ATTACH")+"]"}else{aa=d.message("IM_M_DELETED")}}}if(k.message.senderId==this.BXIM.userId){if(this.BXIM.messenger.sendMessageFlag>0&&k.message.system!="Y"||this.BXIM.messenger.message[k.message.id]){return}if(this.isMobile()){if(k.message.params.FILE_ID&&k.message.params.FILE_ID.length>0){var J=false;k.message.params.FILE_ID.forEach(function(i){if(this.BXIM.disk.messageBlock[i]){delete this.BXIM.disk.messageBlock[i];J=true}}.bind(this));if(J){return}}}this.readMessage(k.message.recipientId,false,false);af.USERS_MESSAGE[k.message.recipientId]=[k.message.id];this.updateStateVar(af);d.MessengerCommon.recentListAdd({userId:k.message.recipientId,id:k.message.id,date:k.message.date,recipientId:k.message.recipientId,senderId:k.message.system=="Y"?0:k.message.senderId,text:aa,userIsChat:z=="messageChat",params:k.message.params},true)}else{af.UNREAD_MESSAGE={};if(k.notify===true||k.notify.indexOf(parseInt(this.BXIM.userId))>-1){af.UNREAD_MESSAGE[z=="messageChat"?k.message.recipientId:k.message.senderId]=[k.message.id]}af.USERS_MESSAGE[z=="messageChat"?k.message.recipientId:k.message.senderId]=[k.message.id];if(z=="message"){this.endWriting(k.message.senderId,0,false)}else{this.endWriting(k.message.senderId,k.message.recipientId,false)}if(z=="messageChat"&&!d.MessengerCommon.userInChat(k.message.chatId)){this.updateStateVar(af);return}else{this.updateStateVar(af);var n=k.notify!==true&&k.notify.indexOf(parseInt(this.BXIM.userId))==-1?this.inRecentList(z=="messageChat"?k.message.recipientId:k.message.senderId):true;if(n){this.recentListAdd({userId:z=="messageChat"?k.message.recipientId:k.message.senderId,id:k.message.id,date:k.message.date,recipientId:k.message.recipientId,senderId:k.message.senderId,text:aa,userIsChat:z=="messageChat",params:k.message.params},true)}}}d.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80)}else{if(z=="messageDeleteComplete"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(!this.BXIM.messenger.message[k.id]){return false}var E=0;if(k.type=="private"){E=k.fromUserId==this.BXIM.userId&&k.toUserId?k.toUserId:k.fromUserId;this.endWriting(E,0,false)}else{E="chat"+k.chatId;this.endWriting(k.senderId,E,false)}if(this.BXIM.messenger.currentTab==E&&d("im-message-"+k.id)){var h=d("im-message-"+k.id).parentNode.parentNode.parentNode.parentNode.parentNode;if(h.getAttribute("data-messageId")==h.getAttribute("data-blockMessageId")){d.remove(h)}else{h=d("im-message-"+k.id).parentNode;if(h.nextSibling&&d.hasClass(h.nextSibling,"bx-messenger-hr")){d.remove(h.nextSibling)}else{if(!h.nextSibling&&d.hasClass(h.previousSibling,"bx-messenger-hr")){d.remove(h.previousSibling)}}d.remove(h)}}this.recentListElementUpdate(E,k.id,k.text);if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal){this.recentListRedraw()}delete this.BXIM.messenger.message[k.id];this.BXIM.messenger.showMessage[E].sort(d.delegate(function(j,am){if(!this.BXIM.messenger.message[j]||!this.BXIM.messenger.message[am]){return 0}var an=this.BXIM.messenger.message[j].date.getTime();var al=this.BXIM.messenger.message[am].date.getTime();if(an<al){return -1}else{if(an>al){return 1}else{if(j<am){return -1}else{if(j>am){return 1}else{return 0}}}}},this))}else{if(z=="messageUpdate"||z=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}for(var I in this.sendBotCommandBlock){if(this.sendBotCommandBlock[I][k.id]){delete this.sendBotCommandBlock[I][k.id];var R=d("im-message-keyboard-"+k.id);if(R){var ab=d.findChildrenByClassName(R,"bx-messenger-keyboard-button-block",false);for(var ae=0;ae<ab.length;ae++){d.removeClass(ab[ae],"bx-messenger-keyboard-button-progress");d.removeClass(ab[ae],"bx-messenger-keyboard-button-block")}}}}if(this.BXIM.messenger.message[k.id]){if(!this.BXIM.messenger.message[k.id].params){this.BXIM.messenger.message[k.id].params={}}var E=0;if(z=="messageDelete"){k.text=d.message("IM_M_DELETED");if(!this.BXIM.messenger.message[k.id].params){this.BXIM.messenger.message[k.id].params={}}this.BXIM.messenger.message[k.id].params.IS_DELETED="Y"}else{if(z=="messageUpdate"){this.BXIM.messenger.message[k.id].params=k.params}}this.BXIM.messenger.message[k.id].text=k.text;if(k.type=="private"){E=k.fromUserId==this.BXIM.userId&&k.toUserId?k.toUserId:k.fromUserId;this.endWriting(E,0,false)}else{E="chat"+k.chatId;this.endWriting(k.senderId,E,false)}this.recentListElementUpdate(E,k.id,k.text);if(this.BXIM.messenger.currentTab==E&&d("im-message-"+k.id)){var t=d("im-message-"+k.id);if(k.params&&k.params.IS_EDITED=="Y"){d.addClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited")}var P=false;if(z=="messageDelete"){d.addClass(t.parentNode,"bx-messenger-message-deleted");var U=d("im-message-keyboard-"+k.id);d.remove(U);d.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else{if(z=="messageUpdate"){if(k.params){if(k.params.DATE_TEXT){var x=this.prepareText(this.BXIM.messenger.message[k.id].text,false,true,true);for(var ae=0;ae<k.params.DATE_TEXT.length;ae++){x=x.split(k.params.DATE_TEXT[ae]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+k.id+'" data-ts="'+k.params.DATE_TS[ae]+'">'+k.params.DATE_TEXT[ae]+"</span>")}t.innerHTML=x;P=true}if(k.params.IS_EDITED=="Y"){d.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding")}if(k.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){d.addClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else{d.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(k.params.ATTACH){var ak=d.MessengerCommon.drawAttach(k.id,this.BXIM.messenger.message[k.id].chatId,k.params.ATTACH);if(t.nextElementSibling&&d.hasClass(t.nextElementSibling,"bx-messenger-attach-box")){t.nextElementSibling.innerHTML="";if(ak.length>0){d.adjust(t.nextElementSibling,{children:ak})}}else{if(ak.length>0){ak=d.create("div",{props:{className:"bx-messenger-attach-box"},children:ak});if(t.nextElementSibling){t.parentNode.insertBefore(ak,t.nextElementSibling)}else{t.parentNode.appendChild(ak)}}}}if(k.params.KEYBOARD){var R=d("im-message-keyboard-"+k.id);var M=d.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,k.id,k.params.KEYBOARD);if(R){R.innerHTML=M?M.innerHTML:""}}}else{if(typeof(k.params)!="undefined"&&k.params==""){if(d.hasClass(t.nextElementSibling,"bx-messenger-attach-box")){d.remove(t.nextElementSibling)}}}}}if(!P){t.innerHTML=d.MessengerCommon.prepareText(this.BXIM.messenger.message[k.id].text,false,true,true)}d.addClass(t,"bx-messenger-message-edited-anim");if(t.previousSibling&&d.hasClass(t.previousSibling,"bx-messenger-file-box")){d.addClass(t.previousSibling,"bx-messenger-file-box-with-message")}setTimeout(d.delegate(function(){d.removeClass(t,"bx-messenger-message-edited-anim")},this),1000)}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal){this.recentListRedraw()}}}else{if(z=="messageParamsUpdate"){if(this.MobileActionNotEqual("DIALOG")){return false}if(!this.BXIM.messenger.message[k.id]){return false}if(this.BXIM.messenger.message[k.id].params&&this.BXIM.messenger.message[k.id].params.IS_DELETED=="Y"){return false}var ai=typeof(k.animation)=="undefined"?null:k.animation;for(var I in this.sendBotCommandBlock){if(this.sendBotCommandBlock[I][k.id]){delete this.sendBotCommandBlock[I][k.id];var R=d("im-message-keyboard-"+k.id);if(R){var ab=d.findChildrenByClassName(R,"bx-messenger-keyboard-button-block",false);for(var ae=0;ae<ab.length;ae++){d.removeClass(ab[ae],"bx-messenger-keyboard-button-progress");d.removeClass(ab[ae],"bx-messenger-keyboard-button-block")}}}}this.BXIM.messenger.message[k.id].params=k.params;if(k.type=="private"){E=k.fromUserId==this.BXIM.userId?k.toUserId:k.fromUserId}else{E="chat"+k.chatId}var t=d("im-message-"+k.id);if(this.BXIM.messenger.currentTab==E&&t){var T=t.parentNode.parentNode.parentNode.parentNode.parentNode;if(k.params){if(k.params.DATE_TEXT){var x=this.prepareText(this.BXIM.messenger.message[k.id].text,false,true,true);for(var ae=0;ae<k.params.DATE_TEXT.length;ae++){x=x.split(k.params.DATE_TEXT[ae]).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+k.id+'" data-ts="'+k.params.DATE_TS[ae]+'">'+k.params.DATE_TEXT[ae]+"</span>")}t.innerHTML=x}if(k.params.FILE_ID){var l=d.MessengerCommon.diskDrawFiles(this.BXIM.messenger.message[k.id].chatId,k.params.FILE_ID);if(t.previousElementSibling&&d.hasClass(t.previousElementSibling,"bx-messenger-file-box")){t.previousElementSibling.innerHTML="";if(l.length>0){d.adjust(t.previousElementSibling,{children:l})}}else{if(l.length>0){l=d.create("div",{props:{className:"bx-messenger-file-box"+(k.text!=""?" bx-messenger-file-box-with-message":"")},children:l});if(t.previousElementSibling){t.parentNode.insertBefore(l,t.previousElementSibling)}else{t.parentNode.insertBefore(l,t)}}}if(t.innerHTML!=""&&d.hasClass(t.previousElementSibling,"bx-messenger-file-box")){d.addClass(t.previousElementSibling,"bx-messenger-file-box-with-message")}}if(k.params.ATTACH){var ak=d.MessengerCommon.drawAttach(k.id,this.BXIM.messenger.message[k.id].chatId,k.params.ATTACH);if(t.nextElementSibling&&d.hasClass(t.nextElementSibling,"bx-messenger-attach-box")){t.nextElementSibling.innerHTML="";if(ak.length>0){d.adjust(t.nextElementSibling,{children:ak})}}else{if(ak.length>0){ak=d.create("div",{props:{className:"bx-messenger-attach-box"},children:ak});if(t.nextElementSibling){t.parentNode.insertBefore(ak,t.nextElementSibling)}else{t.parentNode.appendChild(ak)}}}if(ai!="N"){ai="Y"}}if(k.params.KEYBOARD){var R=d("im-message-keyboard-"+k.id);var M=d.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,k.id,k.params.KEYBOARD);if(R){R.innerHTML=M?M.innerHTML:""}if(ai!="N"){ai="Y"}}if(k.params.CHAT_USER||k.params.CHAT_ID||k.params.CHAT_MESSAGE||k.params.CHAT_LAST_DATE){var D=d("im-message-content-reply-"+k.id);var C=d.MessengerCommon.drawMessageReply(k.id);if(D){D.innerHTML=C?C.innerHTML:""}}if(k.params&&k.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){d.addClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else{if(k.params&&k.params.URL_ONLY=="N"){d.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}}if(k.params&&k.params.IS_EDITED=="Y"){d.removeClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding");d.addClass(t.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited");if(ai!="N"){ai="Y"}}}else{if(typeof(k.params)!="undefined"&&k.params==""){if(t.nextElementSibling&&d.hasClass(t.nextElementSibling,"bx-messenger-attach-box")){d.remove(t.nextElementSibling);if(ai!="N"){ai="Y"}}}}if(k.params&&typeof(k.params.CLASS)!="undefined"){var X=d.findParent(t,{className:"bx-messenger-content-item"});d.addClass(X,k.params.CLASS)}if(k.params&&typeof(k.params.MENU)!="undefined"){var X=d.findParent(t,{className:"bx-messenger-content-item"});var p=d.findChildByClassName(X,"bx-messenger-content-item-menu");if(!k.params.MENU||k.params.MENU=="N"||k.params.MENU.length<=0){d.removeClass(p,"bx-messenger-content-item-menu-with-apps")}else{d.addClass(p,"bx-messenger-content-item-menu-with-apps")}}if(k.params&&k.params.IS_DELIVERED){if(k.params.IS_DELIVERED=="N"){this.drawProgessMessage(k.id)}else{this.clearProgessMessage(k.id)}}if(k.params&&k.params.SENDING){if(k.params.SENDING=="Y"){this.drawProgessMessage(k.id)}else{this.clearProgessMessage(k.id)}}if(k.params.IMOL_SID&&parseInt(k.params.IMOL_SID)>0){var Q=d.findChildByClassName(T,"bx-messenger-message-extra");if(!Q){T.insertBefore(d.create("div",{props:{className:"bx-messenger-message-extra"},html:d.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",k.params.IMOL_SID)}),T.firstChild);if(this.isElementVisibleOnScreen(T,BXIM.messenger.popupMessengerBody)){this.linesBodyScroll()}}}if(k.params.IMOL_FORM&&this.BXIM.messenger.chat[k.chatId]&&this.BXIM.messenger.chat[k.chatId].type=="livechat"){var V=k.params.IMOL_FORM.toString().substr(-6)=="-delay";var r=V?k.params.IMOL_FORM.substr(0,k.params.IMOL_FORM.lastIndexOf("-delay")):k.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<k.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=r){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=k.id;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(d.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(r)},this),V?30000:5000)}}if(k.params.IMOL_VOTE&&t){var w=this.linesVoteDraw(k.id);if(w){d.cleanNode(t);t.appendChild(w)}if(ai!="N"){ai="Y"}}else{if(typeof(k.params.IMOL_VOTE_SID)!="undefined"&&t){var aa=d.findChildByClassName(t,"bx-messenger-content-item-vote-message-text");if(aa){var w=this.linesVoteResultDraw(k.id,aa.innerHTML);if(w){d.cleanNode(t);t.appendChild(w)}}}}if(ai=="Y"){d.addClass(t,"bx-messenger-message-edited-anim");setTimeout(d.delegate(function(){d.removeClass(t,"bx-messenger-message-edited-anim")},this),1000)}}}else{if(z=="messageLike"){if(this.MobileActionNotEqual("DIALOG")){return false}var K=d.util.in_array(this.BXIM.userId,k.users);var u=k.users.length>0?k.users.length:"";if(!this.BXIM.messenger.message[k.id]){return false}if(typeof(this.BXIM.messenger.message[k.id].params)!="object"){this.BXIM.messenger.message[k.id].params={}}this.BXIM.messenger.message[k.id].params.LIKE=k.users;if(d("im-message-"+k.id)){var B=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+k.id+""}},false);if(B){var H=d.findChildByClassName(B,"bx-messenger-content-item-like");if(H){var ac=d.findChildByClassName(H,"bx-messenger-content-like-digit",false);var F=d.findChildByClassName(H,"bx-messenger-content-like-button",false);if(K){d.addClass(H,"bx-messenger-content-item-liked")}else{d.removeClass(H,"bx-messenger-content-item-liked")}if(u>0){ac.setAttribute("title",d.message("IM_MESSAGE_LIKE_LIST"));d.removeClass(ac.parentNode,"bx-messenger-content-like-digit-off")}else{ac.setAttribute("title","");d.addClass(ac.parentNode,"bx-messenger-content-like-digit-off")}if(ac.innerHTML<u){d.addClass(B.firstChild,"bx-messenger-content-item-plus-like");setTimeout(function(){d.removeClass(B.firstChild,"bx-messenger-content-item-plus-like")},500)}ac.innerHTML=u}}}}else{if(z=="fileUpload"){if(this.MobileActionNotEqual("DIALOG")){return false}if(this.BXIM.disk.filesProgress[k.fileTmpId]){return false}k.fileParams.date=new Date(k.fileParams.date);if(this.BXIM.disk.files[k.fileChatId]&&this.BXIM.disk.files[k.fileChatId][k.fileId]){k.fileParams.preview=this.BXIM.disk.files[k.fileChatId][k.fileId]["preview"]}if(!this.BXIM.disk.files[k.fileChatId]){this.BXIM.disk.files[k.fileChatId]={}}this.BXIM.disk.files[k.fileChatId][k.fileId]=k.fileParams;this.diskRedrawFile(k.fileChatId,k.fileId);if(this.BXIM.messenger.popupMessengerBody&&d.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=b.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else{if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}(this.BXIM.messenger.popupMessengerBodyAnimation=new d.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:d.easing.makeEaseInOut(d.easing.transitions.quart),step:d.delegate(function(i){this.BXIM.messenger.popupMessengerBody.scrollTop=i.scroll},this)})).animate()}else{if(this.BXIM.messenger.popupMessengerBody){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}}}else{if(z=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG")){return false}for(var W in k.files){if(this.BXIM.disk.filesRegister[k.chatId]){delete this.BXIM.disk.filesRegister[k.chatId][k.files[W]]}if(this.BXIM.disk.files[k.chatId]&&this.BXIM.disk.files[k.chatId][k.files[W]]){this.BXIM.disk.files[k.chatId][k.files[W]].status="error";d.MessengerCommon.diskRedrawFile(k.chatId,k.files[W])}delete this.BXIM.disk.filesProgress[W]}this.drawTab(this.getRecipientByChatId(k.chatId))}else{if(z=="fileDelete"){if(this.MobileActionNotEqual("DIALOG")){return false}delete this.BXIM.disk.files[k.chatId][k.fileId];this.drawTab(this.getRecipientByChatId(k.chatId))}else{if(z=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(this.BXIM.messenger.chat[k.chatId]){this.BXIM.messenger.chat[k.chatId].name=d.util.htmlspecialchars(k.name);this.BXIM.messenger.redrawChatHeader()}}else{if(z=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}this.BXIM.messenger.updateChatAvatar(k.chatId,k.avatar)}else{if(z=="chatChangeColor"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(this.BXIM.messenger.chat[k.chatId]){this.BXIM.messenger.chat[k.chatId].color=k.color;this.BXIM.messenger.redrawChatHeader()}}else{if(z=="chatHide"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}var Y=this.BXIM.messenger.currentTab==k.dialogId;this.recentListHide(k.dialogId,false);if(!this.isMobile()&&Y){d.MessengerCommon.dialogCloseCurrent()}}else{if(z=="chatPin"){if(this.MobileActionNotEqual("RECENT")){return false}this.recentListElementPin(k.dialogId,k.active)}else{if(z=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}for(var ae in k.users){k.users[ae].last_activity_date=new Date(k.users[ae].last_activity_date);k.users[ae].mobile_last_date=new Date(k.users[ae].mobile_last_date);k.users[ae].idle=k.users[ae].idle?new Date(k.users[ae].idle):false;k.users[ae].absent=k.users[ae].absent?new Date(k.users[ae].absent):false;this.BXIM.messenger.users[ae]=k.users[ae]}if(!this.BXIM.messenger.chat[k.chatId]){this.BXIM.messenger.chat[k.chatId]={id:k.chatId,name:k.chatId,owner:k.chatOwner,extranet:k.chatExtranet,fake:true,date_create:""}}else{this.BXIM.messenger.chat[k.chatId].extranet=k.chatExtranet;if(this.BXIM.messenger.userInChat[k.chatId]){for(ae=0;ae<k.newUsers.length;ae++){this.BXIM.messenger.userInChat[k.chatId].push(k.newUsers[ae])}}else{this.BXIM.messenger.userInChat[k.chatId]=k.newUsers}this.BXIM.messenger.redrawChatHeader()}}else{if(z=="chatOwner"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(!this.BXIM.messenger.chat[k.chatId]){return false}this.BXIM.messenger.chat[k.chatId].owner=k.userId;if(!this.isMobile()&&this.BXIM.messenger.currentTab=="chat"+k.chatId){this.BXIM.messenger.redrawChatHeader()}}else{if(z=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(k.userId==this.BXIM.userId){this.readMessage("chat"+k.chatId,true,false,true);this.leaveFromChat(k.chatId,false);if(k.message.length>0){this.BXIM.openConfirm({title:d.util.htmlspecialchars(k.chatTitle),message:k.message})}}else{if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[k.chatId]||!this.BXIM.messenger.userInChat[k.chatId]){return false}var L=[];for(var ae=0;ae<this.BXIM.messenger.userInChat[k.chatId].length;ae++){if(this.BXIM.messenger.userInChat[k.chatId][ae]!=k.userId){L.push(this.BXIM.messenger.userInChat[k.chatId][ae])}}this.BXIM.messenger.userInChat[k.chatId]=L;this.BXIM.messenger.redrawChatHeader()}}}else{if(z=="deleteNotifies"){if(this.MobileActionNotEqual("NOTIFY")){return false}if(this.BXIM.notify.skipMassDelete){return true}for(var ae in k.id){if(k.id[ae]>0){delete this.BXIM.notify.notify[ae];delete this.BXIM.notify.flashNotify[ae];delete this.BXIM.notify.unreadNotify[ae]}}this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen){this.BXIM.notify.openNotify(true)}}else{if(z=="notify"){if(this.MobileActionNotEqual("NOTIFY")){return false}k.date=new Date(k.date);var af={};af.UNREAD_NOTIFY={};af.UNREAD_NOTIFY[k.id]=[k.id];this.BXIM.messenger.notify.notify[k.id]=k;if(this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=k.message.id){this.BXIM.messenger.notify.flashNotify[k.id]=false}else{this.BXIM.messenger.notify.flashNotify[k.id]=k.silent!="Y"}if(k.settingName=="im|like"&&k.originalTag.substr(0,10)=="RATING|IM|"){var o=k.originalTag.split("|");if(this.BXIM.messenger.message[o[4]]&&this.BXIM.messenger.message[o[4]].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete af.UNREAD_NOTIFY[k.id];this.BXIM.notify.flashNotify[k.id]=false;this.BXIM.notify.viewNotify(k.id)}}if(k.silent=="N"){this.BXIM.notify.changeUnreadNotify(af.UNREAD_NOTIFY)}d.localStorage.set("mfn",this.BXIM.notify.flashNotify,80);this.BXIM.lastRecordId=parseInt(k.id)>this.BXIM.lastRecordId?parseInt(k.id):this.BXIM.lastRecordId}else{if(z=="readNotifyList"){if(this.MobileActionNotEqual("NOTIFY")){return false}this.BXIM.notify.initNotifyCount=k.counter;k.list.forEach(function(i){delete this.BXIM.notify.unreadNotify[i]}.bind(this));this.BXIM.notify.viewNotifyMarkupUpdate();this.BXIM.notify.updateNotifyCount(false)}else{if(z=="massReadNotify"){if(this.MobileActionNotEqual("NOTIFY")){return false}if(!d.type.isArray(k.idList)){return false}var G=k.idList;this.BXIM.notify.initNotifyCount=0;for(var ae in this.BXIM.notify.unreadNotify){var A=this.BXIM.notify.notify[this.BXIM.notify.unreadNotify[ae]];if(A&&A.type!=1&&G.indexOf(A.id)>=0){delete this.BXIM.notify.unreadNotify[ae]}}this.BXIM.notify.updateNotifyCount(false)}else{if(z=="confirmNotify"){if(this.MobileActionNotEqual("NOTIFY")){return false}var aj=parseInt(k.id);if(this.BXIM.notify.notify[aj]){if(this.isMobile()){delete this.BXIM.notify.notify[aj]}else{this.BXIM.notify.notify[aj].confirmMessages=k.confirmMessages}}delete this.BXIM.notify.unreadNotify[aj];delete this.BXIM.notify.flashNotify[aj];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen){this.BXIM.notify.openNotify(true)}}else{if(z=="readNotifyOne"){if(this.MobileActionNotEqual("NOTIFY")){return false}if(this.BXIM.notify.unreadNotify[k.id]){this.BXIM.notify.viewNotify(k.id,true,false)}}else{if(z=="unreadNotifyList"){if(this.MobileActionNotEqual("NOTIFY")){return false}k.list.forEach(function(i){this.BXIM.notify.viewNotify(i,false,false)}.bind(this))}else{if(z=="deleteCommand"){if(this.MobileActionNotEqual("DIALOG")){return false}for(var ae=0;ae<this.BXIM.messenger.command.length;ae++){if(!this.BXIM.messenger.command[ae]||this.BXIM.messenger.command[ae].id!=k.commandId){continue}delete this.BXIM.messenger.command[ae];if(this.commandPopup!=null){this.commandPopup.destroy()}break}}else{if(z=="deleteAppIcon"){if(this.MobileActionNotEqual("DIALOG")){return false}for(var ae=0;ae<this.BXIM.messenger.textareaIcon.length;ae++){if(!this.BXIM.messenger.textareaIcon[ae]||this.BXIM.messenger.textareaIcon[ae].id!=k.iconId){continue}delete this.BXIM.messenger.textareaIcon[ae];if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}var B=d.findChildByClassName(this.BXIM.messenger.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-marketplace-"+k.iconId,true);if(B){d.remove(B)}break}}else{if(z=="updateAppIcon"){if(this.MobileActionNotEqual("DIALOG")){return false}for(var ae=0;ae<this.BXIM.messenger.textareaIcon.length;ae++){if(!this.BXIM.messenger.textareaIcon[ae]||this.BXIM.messenger.textareaIcon[ae].id!=k.iconId){continue}if(k.context){this.BXIM.messenger.textareaIcon[ae].context=k.context}if(k.js){this.BXIM.messenger.textareaIcon[ae].js=k.js}if(k.iframe){this.BXIM.messenger.textareaIcon[ae].iframe=k.iframe}if(k.iframeWidth){this.BXIM.messenger.textareaIcon[ae].iframeWidth=k.iframeWidth}if(k.iframeHeight){this.BXIM.messenger.textareaIcon[ae].iframeHeight=k.iframeHeight}if(k.userId!=this.BXIM.userId&&this.popupSmileMenu!=null){this.popupIframeMenu.destroy()}break}}else{if(z=="chatUpdateParam"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(this.BXIM.messenger.chat[k.chatId]){if(k.name=="name"){k.value=d.util.htmlspecialchars(k.value)}this.BXIM.messenger.chat[k.chatId][k.name]=k.value;if(this.BXIM.messenger.currentTab.toString().substr(4)==k.chatId){this.BXIM.messenger.redrawChatHeader();if(this.isMobile()){this.BXIM.messenger.dialogStatusRedraw()}}if(this.BXIM.messenger.chat[k.chatId].type=="livechat"&&k.fieldName=="entity_data_1"){var S=this.livechatGetSession(k.chatId);S.readedTime=S.readedTime?new Date(S.readedTime):false;this.drawReadMessage("chat"+k.chatId,S.readedId,S.readedTime);if(S.showForm=="N"){if(!this.BXIM.messenger.popupMessengerLiveChatLastSend||this.BXIM.messenger.popupMessengerLiveChatLastSend+1000<+(new Date())){this.BXIM.messenger.linesLivechatFormHide()}}}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}}},this);var g=d.delegate(function(m,l){if(this.isMobile()){l=m.params;m=m.command}if(m=="list"||m=="userStatus"){var k=false;var j=false;for(var h in l.users){if(typeof(this.BXIM.messenger.users[h])=="undefined"){continue}if(this.BXIM.messenger.recentListIndex.indexOf(h.toString())>=0){k=true}if(this.BXIM.messenger.currentTab.toString()==h.toString()){j=true}this.BXIM.messenger.users[h].status=l.users[h].status;this.BXIM.messenger.users[h].color=l.users[h].color;this.BXIM.messenger.users[h].idle=l.users[h].idle?new Date(l.users[h].idle):false;this.BXIM.messenger.users[h].mobile_last_date=new Date(l.users[h].mobile_last_date);this.BXIM.messenger.users[h].last_activity_date=new Date(l.users[h].last_activity_date)}if(k){d.MessengerCommon.userListRedraw()}if(j){this.BXIM.messenger.dialogStatusRedraw()}}},this);var e=d.delegate(function(n,m){if(this.isMobile()){m=n.params;n=n.command}if(n=="linesAnswer"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}if(!this.BXIM.messenger.chat[m.chatId]){return false}this.BXIM.messenger.chat[m.chatId].owner=this.BXIM.userId;this.BXIM.messenger.redrawChatHeader();if(this.BXIM.messenger.popupMessengerTextarea){this.BXIM.messenger.popupMessengerTextarea.focus()}}else{if(n=="queueItemUpdate"){if(typeof(this.BXIM.messenger.openlines)=="undefined"){this.BXIM.messenger.openlines.queue=[m]}else{var k=true;for(var l=0,h=this.BXIM.messenger.openlines.queue.length;l<h;l++){if(this.BXIM.messenger.openlines.queue[l].id==m.id){this.BXIM.messenger.openlines.queue[l].name=m.name;this.BXIM.messenger.openlines.queue[l].priority=m.priority;k=false;break}}if(k){this.BXIM.messenger.openlines.queue.push(m)}}}else{if(n=="queueItemDelete"){if(typeof(this.BXIM.messenger.openlines)=="undefined"||this.BXIM.messenger.openlines.queue.length<=0){return true}var j=[];for(var l=0,h=this.BXIM.messenger.openlines.queue.length;l<h;l++){if(this.BXIM.messenger.openlines.queue[l].id!=m.id){j.push(this.BXIM.messenger.openlines.queue[l])}}this.BXIM.messenger.openlines.queue=j}}}},this);if(this.isMobile()){console.warn("MOBILE!");BXMobileApp.addCustomEvent("onPull-im",d.delegate(function(j){console.log(j);var k=j.data;if(typeof(k)=="undefined"){f(j.command,j.params,j.extra)}else{for(var h=0;h<k.length;h++){f(k[h]["command"],k[h]["params"],k[h]["extra"])}}},this));BXMobileApp.addCustomEvent("onPullOnline",g);BXMobileApp.addCustomEvent("onPull-imopenlines",e)}else{d.addCustomEvent("onPullOnlineEvent",g);d.addCustomEvent("onPullEvent-im",f);d.addCustomEvent("onPullEvent-imopenlines",e)}};a.prototype.updateStateVar=function(h,k,g){g=g!==false;if(typeof(h.CHAT)!="undefined"){for(var f in h.CHAT){h.CHAT[f].date_create=new Date(h.CHAT[f].date_create);this.BXIM.messenger.chat[f]=h.CHAT[f]}}if(typeof(h.USER_IN_CHAT)!="undefined"){for(var f in h.USER_IN_CHAT){this.BXIM.messenger.userInChat[f]=h.USER_IN_CHAT[f]}}if(typeof(h.USER_BLOCK_CHAT)!="undefined"){for(var f in h.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[f]=h.USER_BLOCK_CHAT[f]}}if(typeof(h.USERS)!="undefined"){for(var f in h.USERS){h.USERS[f].last_activity_date=new Date(h.USERS[f].last_activity_date);h.USERS[f].mobile_last_date=new Date(h.USERS[f].mobile_last_date);h.USERS[f].idle=h.USERS[f].idle?new Date(h.USERS[f].idle):false;h.USERS[f].absent=h.USERS[f].absent?new Date(h.USERS[f].absent):false;this.BXIM.messenger.users[f]=h.USERS[f]}}if(typeof(h.USER_IN_GROUP)!="undefined"){for(var f in h.USER_IN_GROUP){if(typeof(this.BXIM.messenger.userInGroup[f])=="undefined"||typeof(this.BXIM.messenger.userInGroup[f].users)=="undefined"||!this.BXIM.messenger.userInGroup[f].users.length){this.BXIM.messenger.userInGroup[f]=h.USER_IN_GROUP[f]}else{for(var e=0;e<h.USER_IN_GROUP[f].users.length;e++){this.BXIM.messenger.userInGroup[f].users.push(h.USER_IN_GROUP[f].users[e])}this.BXIM.messenger.userInGroup[f].users=d.util.array_unique(this.BXIM.messenger.userInGroup[f].users)}}}if(typeof(h.MESSAGE)!="undefined"){for(var f in h.MESSAGE){h.MESSAGE[f].date=new Date(h.MESSAGE[f].date);if(this.BXIM.messenger.message[f]&&this.BXIM.messenger.message[f].dropDuplicate){h.MESSAGE[f].dropDuplicate=true}this.BXIM.messenger.message[f]=h.MESSAGE[f];this.BXIM.lastRecordId=parseInt(f)>this.BXIM.lastRecordId?parseInt(f):this.BXIM.lastRecordId}}this.changeUnreadMessage(h.UNREAD_MESSAGE,k);if(typeof(h.USERS_MESSAGE)!="undefined"){for(var f in h.USERS_MESSAGE){h.USERS_MESSAGE[f].sort(d.delegate(function(j,m){j=parseInt(j);m=parseInt(m);if(!this.BXIM.messenger.message[j]||!this.BXIM.messenger.message[m]){return 0}var n=this.BXIM.messenger.message[j].date.getTime();var l=this.BXIM.messenger.message[m].date.getTime();if(n<l){return -1}else{if(n>l){return 1}else{if(j<m){return -1}else{if(j>m){return 1}else{return 0}}}}},this));for(var e=0;e<h.USERS_MESSAGE[f].length;e++){if(this.BXIM.messenger.message[h.USERS_MESSAGE[f][e]].dropDuplicate||!this.BXIM.messenger.showMessage[f]||!d.util.in_array(h.USERS_MESSAGE[f][e],this.BXIM.messenger.showMessage[f])){if(!this.BXIM.messenger.showMessage[f]){this.BXIM.messenger.showMessage[f]=[]}this.BXIM.messenger.showMessage[f].push(h.USERS_MESSAGE[f][e]);if(this.BXIM.messenger.history[f]){this.BXIM.messenger.history[f]=d.util.array_merge(this.BXIM.messenger.history[f],h.USERS_MESSAGE[f])}else{this.BXIM.messenger.history[f]=h.USERS_MESSAGE[f]}if(g&&this.BXIM.messenger.currentTab==f&&this.MobileActionEqual("DIALOG")){this.drawMessage(f,this.BXIM.messenger.message[h.USERS_MESSAGE[f][e]])}}}}}};a.prototype.changeUnreadMessage=function(j,h){h=h!=false;var n=false;var p=false;var m=true;var e=this.isMobile()?"online":this.BXIM.settings.status;for(var l in j){if(l.toString().substr(0,4)=="chat"){if(!d.MessengerCommon.userInChat(l.toString().substr(4))){continue}}var o=false;if(this.BXIM.xmppStatus&&l.toString().substr(0,4)!="chat"){if(!(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==l&&this.BXIM.isFocus())){p=true;if(this.BXIM.messenger.unreadMessage[l]){this.BXIM.messenger.unreadMessage[l]=d.util.array_unique(d.util.array_merge(this.BXIM.messenger.unreadMessage[l],j[l]))}else{this.BXIM.messenger.unreadMessage[l]=j[l]}}o=true}if(!o){if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==l&&this.BXIM.isFocus()){if(typeof(this.BXIM.messenger.flashMessage[l])=="undefined"){this.BXIM.messenger.flashMessage[l]={}}for(var g=0;g<j[l].length;g++){if(this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[l][j[l][g]]=false}if(this.BXIM.messenger.message[j[l][g]]&&this.BXIM.messenger.message[j[l][g]].senderId==this.BXIM.messenger.currentTab){n=true}}this.readMessage(l,true,true,true)}else{if(this.isMobile()&&this.BXIM.messenger.currentTab==l){var s=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(d.delegate(function(i){if(i){d.MessengerCommon.readMessage(s,true,true,true)}},this));if(this.BXIM.messenger.unreadMessage[s]){this.BXIM.messenger.unreadMessage[s]=d.util.array_unique(d.util.array_merge(this.BXIM.messenger.unreadMessage[s],j[s]))}else{this.BXIM.messenger.unreadMessage[s]=j[s]}}else{p=true;if(typeof(this.BXIM.messenger.flashMessage[l])=="undefined"){this.BXIM.messenger.flashMessage[l]={};var r=l.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[l.toString().substr(4)]&&this.BXIM.messenger.chat[l.toString().substr(4)].type=="lines";for(var g=0;g<j[l].length;g++){if(r&&this.BXIM.messenger.unreadMessage[l]&&this.BXIM.messenger.unreadMessage[l].length>0){var q=this.BXIM.messenger.message[j[l][g]].senderId;if(q==0||this.BXIM.messenger.users[q].extranet){this.BXIM.messenger.flashMessage[l][j[l][g]]=false;continue}}var f=this.BXIM.messenger.message[j[l][g]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(e!="dnd"||f){this.BXIM.messenger.flashMessage[l][j[l][g]]=h}}}else{var r=l.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[l.toString().substr(4)]&&this.BXIM.messenger.chat[l.toString().substr(4)].type=="lines";for(var g=0;g<j[l].length;g++){var f=this.BXIM.messenger.message[j[l][g]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(e!="dnd"||f){if(!h&&!this.BXIM.isFocus()){this.BXIM.messenger.flashMessage[l][j[l][g]]=false}else{if(r&&this.BXIM.messenger.unreadMessage[l]&&this.BXIM.messenger.unreadMessage[l].length>0){var q=this.BXIM.messenger.message[j[l][g]].senderId;if(q==0||this.BXIM.messenger.users[q].extranet){this.BXIM.messenger.flashMessage[l][j[l][g]]=false;continue}}if(typeof(this.BXIM.messenger.flashMessage[l][j[l][g]])=="undefined"){this.BXIM.messenger.flashMessage[l][j[l][g]]=true}}}}}if(this.BXIM.messenger.unreadMessage[l]){this.BXIM.messenger.unreadMessage[l]=d.util.array_unique(d.util.array_merge(this.BXIM.messenger.unreadMessage[l],j[l]))}else{this.BXIM.messenger.unreadMessage[l]=j[l]}}}}if(this.MobileActionEqual("DIALOG")&&this.BXIM.messenger.popupMessenger!=null&&this.BXIM.messenger.currentTab==l){m=true}}if(m){this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true,userRedraw:false}:{userRedraw:false})}if(this.MobileActionEqual("RECENT")&&this.BXIM.messenger.popupMessenger!=null&&!this.BXIM.messenger.recentList&&p){d.MessengerCommon.userListRedraw()}if(this.isMobile()&&this.MobileActionEqual("RECENT")&&app.enableInVersion(13)){clearTimeout(this.newMessageTimeout);this.newMessageTimeout=setTimeout(d.proxy(function(){this.BXIM.messenger.newMessage()},this),1000)}else{if(!this.isMobile()){this.BXIM.messenger.newMessage(h);this.BXIM.messenger.updateMessageCount(h);if(h&&n&&e!="dnd"){this.BXIM.playSound("newMessage2")}}}};a.prototype.redrawDateMarks=function(){if(!this.BXIM.messenger.popupMessengerBodyWrap){return false}if(typeof(this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName)=="undefined"){return false}var g={};var f=this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName("bx-messenger-content-group");var h=this.BXIM.messenger.popupMessengerBody.getBoundingClientRect().top;for(var e=0;e<f.length;e++){g=d.MessengerCommon.isElementCoordsBelow(f[e],this.BXIM.messenger.popupMessengerBody,33,true);if(f[e].className!="bx-messenger-content-group bx-messenger-content-group-today"){f[e].className="bx-messenger-content-group "+(g.top?"":"bx-messenger-content-group-float");f[e].firstChild.nextSibling.style.marginLeft=g.top?"":Math.round(f[e].offsetWidth/2-f[e].firstChild.nextSibling.offsetWidth/2)+"px";f[e].firstChild.nextSibling.style.marginTop=g.top?"":((-g.coords.top)+14)+"px"}if(!g.top&&f[e-1]){f[e-1].className="bx-messenger-content-group";f[e-1].firstChild.nextSibling.style.marginLeft="";f[e-1].firstChild.nextSibling.style.marginTop=""}}};a.prototype.unreadMessage=function(f){if(!this.BXIM.messenger.message[f]){return false}var j=this.BXIM.messenger.message[f];var e="";if(j.recipientId.toString().substr(0,4)=="chat"){e=j.recipientId}else{e=j.senderId}showMessage=this.BXIM.messenger.showMessage[e];showMessage.sort(function(l,m){if(l<m){return -1}else{if(l>m){return 1}else{return 0}}});var k=0;this.BXIM.messenger.unreadMessage[e]=[];for(var g=0;g<showMessage.length;g++){if(showMessage[g]>=f){if(!this.BXIM.messenger.unreadMessage[e]){this.BXIM.messenger.unreadMessage[e]=[]}this.BXIM.messenger.unreadMessage[e].push(showMessage[g])}else{k=showMessage[g]}}this.skipReadMessage=true;this.drawTab();this.userListRedraw();setTimeout(d.delegate(function(){this.skipReadMessage=false},this),1000);var h=d.ajax({url:this.BXIM.pathToAjax+"?UNREAD_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:{IM_UNREAD_MESSAGE:"Y",USER_ID:e,LAST_ID:k,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()}})};a.prototype.readMessage=function(n,j,h,o){if(!n||this.skipReadMessage){return false}o=o==true||this.isMobile();if(!o&&(!this.BXIM.messenger.unreadMessage[n]||this.BXIM.messenger.unreadMessage[n].length<=0)){return false}if(n.toString().substring(0,4)=="chat"){var m=n.toString().substring(4);if(this.BXIM.messenger.chat[m]&&this.BXIM.messenger.chat[m].type=="lines"&&this.BXIM.messenger.chat[m].owner==0){return false}}j=j!=false;h=h!==false;var q={};for(var k in this.BXIM.messenger.unreadMessage){if(n==k){continue}q[k]=true}if(this.BXIM.messenger.recentListExternal){var e=d.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-status-new-message");if(e!=null){for(var k=0;k<e.length;k++){var p=e[k].getAttribute("data-userId");if(!q[p]){e[k].firstChild.innerHTML="";d.removeClass(e[k],"bx-messenger-cl-status-new-message")}}}}if(this.BXIM.messenger.popupMessenger!=null){var e=d.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-status-new-message");if(e!=null){for(var k=0;k<e.length;k++){var p=e[k].getAttribute("data-userId");if(!q[p]){e[k].firstChild.innerHTML="";d.removeClass(e[k],"bx-messenger-cl-status-new-message")}}}e=d.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(e!=null){for(var k=0;k<e.length;k++){if(e[k].getAttribute("data-notifyType")!=1){d.removeClass(e[k],"bx-messenger-content-item-new")}}}}var g=0;if(Math&&this.BXIM.messenger.unreadMessage[n]){g=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[n])}if(this.BXIM.messenger.unreadMessage[n]){var f=d.clone(this.BXIM.messenger.unreadMessage[n]);delete this.BXIM.messenger.unreadMessage[n]}if(this.BXIM.messenger.flashMessage[n]){delete this.BXIM.messenger.flashMessage[n]}d.localStorage.set("mfm",this.BXIM.messenger.flashMessage,80);if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(j);this.BXIM.updateCounter()}if(h){var r={IM_READ_MESSAGE:"Y",USER_ID:n,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()};if(parseInt(g)>0){r.LAST_ID=g}var l=d.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:r,onsuccess:d.delegate(function(i){if(i){if(i.BITRIX_SESSID){d.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){d.onCustomEvent(b,"onImMessageRead",[n]);this.BXIM.messenger.setUpdateStateStep()}else{this.BXIM.messenger.unreadMessage[n]=f;if(i.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(function(){this.readMessage(n,false,true)},this),2000);d.onCustomEvent(b,"onImError",[i.ERROR,i.BITRIX_SESSID])}else{if(i.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(d.delegate(function(){this.readMessage(n,false,true)},this),10000)}d.onCustomEvent(b,"onImError",[i.ERROR])}}}}else{this.BXIM.messenger.unreadMessage[n]=f}},this),onfailure:d.delegate(function(){this.BXIM.messenger.unreadMessage[n]=f;this.BXIM.messenger.sendAjaxTry=0;try{if(typeof(l)=="object"&&l.status==0){d.onCustomEvent(b,"onImError",["CONNECT_ERROR"])}}catch(i){}},this)})}if(j){d.localStorage.set("mrm",n,5);d.localStorage.set("mnnb",true,1)}};a.prototype.drawReadMessageChat=function(m,i){if(!this.BXIM.messenger.readedList[m]){return false}var h=Math.max.apply(Math,this.BXIM.messenger.showMessage[m]);var j=0;var l={};var o=0;var k=false;for(var n in this.BXIM.messenger.readedList[m]){if(n==this.BXIM.userId){continue}if(this.BXIM.messenger.message[h]&&this.BXIM.messenger.message[h].senderId==n){continue}if(this.BXIM.messenger.readedList[m][n].messageId>=h){if(!l[n]){l[n]={}}if(!k||k.getTime()>this.BXIM.messenger.readedList[m][n].date.getTime()){o=n;k=this.BXIM.messenger.readedList[m][n].date}l[n]=this.BXIM.messenger.readedList[m][n];j++}}if(j>0){this.BXIM.messenger.readedList[m]=l}else{this.BXIM.messenger.readedList[m]=false;var g=this.BXIM.messenger.popupMessengerBodyWrap?this.BXIM.messenger.popupMessengerBodyWrap.lastChild:null;if(g&&d.hasClass(g,"bx-messenger-content-item-notify")){if(!this.countWriting(m)){d.remove(g)}}return false}if(!this.countWriting(m)){var f=this.getUserParam(o);var e='<span title="'+this.formatDate(k)+'">'+f.name+"</span>";if(j>1){if(this.isMobile()){e=d.message("IM_M_READED_CHAT_MORE").replace("#USER#",e).replace("#LINK_START#","<b>").replace("#LINK_END#","</b>").replace("#COUNT#",(j-1))}else{e=d.message("IM_M_READED_CHAT_MORE").replace("#USER#",e).replace("#LINK_START#",'<span class="bx-messenger-ajax" data-entity="readedList">').replace("#LINK_END#","</span>").replace("#COUNT#",(j-1))}}i=i!=false;this.drawNotifyMessage(m,"readed",d.message("IM_M_READED_CHAT").replace("#USERS#",e),i)}};a.prototype.drawReadMessage=function(g,f,e,h){var i=Math.max.apply(Math,this.BXIM.messenger.showMessage[g]);if(i!=f||this.BXIM.messenger.message[i].senderId==g||!e){this.BXIM.messenger.readedList[g]=false;return false}this.BXIM.messenger.readedList[g]={messageId:f,date:e};if(!this.countWriting(g)){h=h!=false;this.drawNotifyMessage(g,"readed",d.message("IM_M_READED").replace("#DATE#",this.formatDate(e)),h)}};a.prototype.drawNotifyMessage=function(f,h,j,k){if(this.BXIM.messenger.popupMessenger==null||f!=this.BXIM.messenger.currentTab||typeof(j)=="undefined"||typeof(h)=="undefined"||f==0){return false}if(!this.BXIM.messenger.popupMessengerBodyWrap){return false}var i=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(!i||d.hasClass(i,"bx-messenger-content-empty")){return false}var g=d.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[d.create("span",{props:{className:"bx-messenger-content-item-content"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[d.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+h+'"></span>'+this.prepareText(j,false,true,true)})]})]})]});var e=true;if(d.hasClass(i,"bx-messenger-content-item-notify")){e=false;d.remove(i)}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(g);k=k!=false;if(e&&this.BXIM.messenger.popupMessengerBody&&d.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=b.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else{if(this.BXIM.animationSupport&&k){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}(this.BXIM.messenger.popupMessengerBodyAnimation=new d.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:d.easing.makeEaseInOut(d.easing.transitions.quart),step:d.delegate(function(l){this.BXIM.messenger.popupMessengerBody.scrollTop=l.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}};a.prototype.loadHistory=function(h,e,g){e=typeof(e)=="undefined"?true:e;g=typeof(g)=="undefined"?false:g;if(!this.BXIM.messenger.historyEndOfList[h]){this.BXIM.messenger.historyEndOfList[h]={}}if(!this.BXIM.messenger.historyLoadFlag[h]){this.BXIM.messenger.historyLoadFlag[h]={}}if(this.BXIM.messenger.historyLoadFlag[h]&&this.BXIM.messenger.historyLoadFlag[h][e]){if(this.isMobile()){app.pullDownLoadingStop()}return}if(this.isMobile()){e=false}else{if(e){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!=""){return}if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100)){return}}else{if(this.BXIM.messenger.showMessage[h]&&this.BXIM.messenger.showMessage[h].length>0&&this.BXIM.messenger.popupMessengerBody.scrollTop>=5){return}}}if(!this.BXIM.messenger.historyEndOfList[h]||!this.BXIM.messenger.historyEndOfList[h][e]){var i=[];if(e){i=d.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item-text")}else{i=d.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&i.length<20&&!g){return false}if(i.length>0){this.BXIM.messenger.historyOpenPage[h]=Math.floor(i.length/20)+1}else{this.BXIM.messenger.historyOpenPage[h]=1}var f=null;if(!this.isMobile()&&!g){f=d.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[d.create("span",{props:{className:"bx-messenger-content-load-img"}}),d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_MESSAGE")})]});if(e){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(f)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(f,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}else{if(g){f=d.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[d.create("span",{props:{className:"bx-messenger-content-load-img"}}),d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_MESSAGE")})]});var j=d.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(j){j.innerHTML="";j.appendChild(f)}else{j=d.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history-empty");this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(f,j);d.remove(j)}}}if(!this.BXIM.messenger.historyLoadFlag[h]){this.BXIM.messenger.historyLoadFlag[h]={}}this.BXIM.messenger.historyLoadFlag[h][e]=true;d.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:h,PAGE_ID:this.BXIM.messenger.historyOpenPage[h],IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(p){if(f){d.remove(f)}if(this.isMobile()){app.pullDownLoadingStop()}this.BXIM.messenger.historyLoadFlag[h][e]=false;if(p.MESSAGE&&p.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[h][e]=true;var l=d.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(l){l.appendChild(d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_NO_MESSAGE")}))}return}for(var q in p.FILES){if(!this.BXIM.disk.files[p.CHAT_ID]){this.BXIM.disk.files[p.CHAT_ID]={}}if(this.BXIM.disk.files[p.CHAT_ID][q]){continue}p.FILES[q].date=new Date(p.FILES[q].date);this.BXIM.disk.files[p.CHAT_ID][q]=p.FILES[q]}var k=0;for(var q in p.MESSAGE){p.MESSAGE[q].date=new Date(p.MESSAGE[q].date);this.BXIM.messenger.message[q]=p.MESSAGE[q];k++}if(k<20){this.BXIM.messenger.historyEndOfList[h][e]=true}for(var q in p.USERS_MESSAGE){if(e){if(this.BXIM.messenger.history[q]){this.BXIM.messenger.history[q]=d.util.array_merge(this.BXIM.messenger.history[q],p.USERS_MESSAGE[q])}else{this.BXIM.messenger.history[q]=p.USERS_MESSAGE[q]}}else{if(this.BXIM.messenger.showMessage[q]){this.BXIM.messenger.showMessage[q]=d.util.array_unique(d.util.array_merge(p.USERS_MESSAGE[q],this.BXIM.messenger.showMessage[q]))}else{this.BXIM.messenger.showMessage[q]=p.USERS_MESSAGE[q]}}}if(e){for(var q=0;q<p.USERS_MESSAGE[h].length;q++){var r=this.BXIM.messenger.message[p.USERS_MESSAGE[h][q]];if(r){if(d("im-message-history-"+r.id)){continue}var n=d.MessengerCommon.formatDate(r.date,d.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));var s=typeof(d.translit)!="undefined"?d.translit(n):n;if(!d("bx-im-history-"+s)){var o=d.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[d.create("div",{attrs:{id:"bx-im-history-"+s},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:n})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(o)}var r=this.BXIM.messenger.drawMessageHistory(r);if(r){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(r)}}}}else{var m=this.BXIM.messenger.popupMessengerBodyWrap.firstChild?this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling:null;if(m){m=d("im-message-"+m.getAttribute("data-blockmessageid"))}if(p.USERS_MESSAGE[h]){for(var q=0;q<p.USERS_MESSAGE[h].length;q++){var r=this.BXIM.messenger.message[p.USERS_MESSAGE[h][q]];if(r){if(d("im-message-"+r.id)){continue}d.MessengerCommon.drawMessage(h,r,false,true)}}}if(m){d.scrollToNode(m.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}},this),onfailure:d.delegate(function(){if(f){d.remove(f)}if(this.isMobile()){app.pullDownLoadingStop()}},this)})}};a.prototype.loadMessageByDate=function(g,e,f){d.ajax({url:this.BXIM.pathToAjax+"?LOAD_MESSAGE_BY_DATE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_MESSAGE_BY_DATE:"Y",CHAT_ID:g,LAST_LOAD:e,FIRST_MESSAGE_ID:f,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(o){if(o&&o.BITRIX_SESSID){d.message({bitrix_sessid:o.BITRIX_SESSID})}if(o.ERROR==""){var h=o.DIALOG_ID;this.BXIM.messenger.sendAjaxTry=0;for(var m in o.USERS){o.USERS[m].last_activity_date=new Date(o.USERS[m].last_activity_date);o.USERS[m].mobile_last_date=new Date(o.USERS[m].mobile_last_date);o.USERS[m].idle=o.USERS[m].idle?new Date(o.USERS[m].idle):false;o.USERS[m].absent=o.USERS[m].absent?new Date(o.USERS[m].absent):false;this.BXIM.messenger.users[m]=o.USERS[m]}for(var m in o.PHONES){this.BXIM.messenger.phones[m]={};for(var k in o.PHONES[m]){this.BXIM.messenger.phones[m][k]=d.util.htmlspecialcharsback(o.PHONES[m][k])}}for(var m in o.USER_IN_GROUP){if(typeof(this.BXIM.messenger.userInGroup[m])=="undefined"||typeof(this.BXIM.messenger.userInGroup[m].users)=="undefined"||!this.BXIM.messenger.userInGroup[m].users.length){this.BXIM.messenger.userInGroup[m]=o.USER_IN_GROUP[m]}else{for(var k=0;k<o.USER_IN_GROUP[m].users.length;k++){this.BXIM.messenger.userInGroup[m].users.push(o.USER_IN_GROUP[m].users[k])}this.BXIM.messenger.userInGroup[m].users=d.util.array_unique(this.BXIM.messenger.userInGroup[m].users)}}for(var m in o.FILES){if(!this.BXIM.messenger.disk.files[o.CHAT_ID]){this.BXIM.messenger.disk.files[o.CHAT_ID]={}}o.FILES[m].date=new Date(o.FILES[m].date);this.BXIM.messenger.disk.files[o.CHAT_ID][m]=o.FILES[m]}this.BXIM.messenger.sendAjaxTry=0;var n=0;for(var m in o.MESSAGE){n++;o.MESSAGE[m].date=new Date(o.MESSAGE[m].date);this.BXIM.messenger.message[m]=o.MESSAGE[m];this.BXIM.lastRecordId=parseInt(m)>this.BXIM.lastRecordId?parseInt(m):this.BXIM.lastRecordId}for(var m in o.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[m]){this.BXIM.messenger.showMessage[m]=d.util.array_unique(d.util.array_merge(o.USERS_MESSAGE[m],this.BXIM.messenger.showMessage[m]))}else{this.BXIM.messenger.showMessage[m]=o.USERS_MESSAGE[m]}}for(var m in o.DELETE_MESSAGE){delete this.BXIM.messenger.message[m];if(this.BXIM.messenger.currentTab==o.DIALOG_ID&&d("im-message-"+m)){var l=d("im-message-"+m).parentNode.parentNode.parentNode.parentNode.parentNode;if(l.getAttribute("data-messageId")==l.getAttribute("data-blockMessageId")){d.remove(l)}else{l=d("im-message-"+m).parentNode;if(l.nextSibling&&d.hasClass(l.nextSibling,"bx-messenger-hr")){d.remove(l.nextSibling)}else{if(!l.nextSibling&&d.hasClass(l.previousSibling,"bx-messenger-hr")){d.remove(l.previousSibling)}}d.remove(l)}}}for(var m in o.CHAT){o.CHAT[m].date_create=new Date(o.CHAT[m].date_create);this.BXIM.messenger.chat[m]=o.CHAT[m]}for(var m in o.USER_IN_CHAT){this.BXIM.messenger.userInChat[m]=o.USER_IN_CHAT[m]}for(var m in o.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[m]=o.USER_BLOCK_CHAT[m]}this.changeUnreadMessage(o.UNREAD_MESSAGE)}else{if(o.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(d.delegate(function(){this.loadMessageByDate(g,e,f)},this),1000);d.onCustomEvent(b,"onImError",[o.ERROR,o.BITRIX_SESSID])}else{if(o.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(d.MessengerCommon.isDesktop()||this.isMobile()){setTimeout(d.delegate(function(){this.loadMessageByDate(g,e,f)},this),10000)}d.onCustomEvent(b,"onImError",[o.ERROR])}}}},this),onfailure:d.delegate(function(){this.sendAjaxTry=0},this)})};a.prototype.loadUserData=function(e){d.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){if(h.ERROR==""){this.BXIM.messenger.userChat[e]=h.CHAT_ID;d.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=d.message("IM_M_USER_NO_ACCESS");for(var g in h.USERS){h.USERS[g].last_activity_date=new Date(h.USERS[g].last_activity_date);h.USERS[g].mobile_last_date=new Date(h.USERS[g].mobile_last_date);h.USERS[g].idle=h.USERS[g].idle?new Date(h.USERS[g].idle):false;h.USERS[g].absent=h.USERS[g].absent?new Date(h.USERS[g].absent):false;this.BXIM.messenger.users[g]=h.USERS[g]}for(var g in h.PHONES){this.BXIM.messenger.phones[g]={};for(var f in h.PHONES[g]){this.BXIM.messenger.phones[g][f]=d.util.htmlspecialcharsback(h.PHONES[g][f])}}for(var g in h.USER_IN_GROUP){if(typeof(this.BXIM.messenger.userInGroup[g])=="undefined"||typeof(this.BXIM.messenger.userInGroup[g].users)=="undefined"||!this.BXIM.messenger.userInGroup[g].users.length){this.BXIM.messenger.userInGroup[g]=h.USER_IN_GROUP[g]}else{for(var f=0;f<h.USER_IN_GROUP[g].users.length;f++){this.BXIM.messenger.userInGroup[g].users.push(h.USER_IN_GROUP[g].users[f])}this.BXIM.messenger.userInGroup[g].users=d.util.array_unique(this.BXIM.messenger.userInGroup[g].users)}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}}else{this.BXIM.messenger.redrawTab[e]=true;if(h.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}},this)})};a.prototype.loadChatData=function(e){d.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){if(h.ERROR==""){if(this.BXIM.messenger.chat[h.CHAT_ID].fake){this.BXIM.messenger.chat[h.CHAT_ID].name=d.message("IM_M_USER_NO_ACCESS")}for(var g in h.CHAT){h.CHAT[g].date_create=new Date(h.CHAT[g].date_create);this.BXIM.messenger.chat[g]=h.CHAT[g]}for(var g in h.USER_IN_CHAT){this.BXIM.messenger.userInChat[g]=h.USER_IN_CHAT[g]}for(var g in h.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[g]=h.USER_BLOCK_CHAT[g]}for(var g in h.USERS){h.USERS[g].last_activity_date=new Date(h.USERS[g].last_activity_date);h.USERS[g].mobile_last_date=new Date(h.USERS[g].mobile_last_date);h.USERS[g].idle=h.USERS[g].idle?new Date(h.USERS[g].idle):false;h.USERS[g].absent=h.USERS[g].absent?new Date(h.USERS[g].absent):false;this.BXIM.messenger.users[g]=h.USERS[g]}for(var g in h.USER_IN_GROUP){if(typeof(this.BXIM.messenger.userInGroup[g])=="undefined"||typeof(this.BXIM.messenger.userInGroup[g].users)=="undefined"||!this.BXIM.messenger.userInGroup[g].users.length){this.BXIM.messenger.userInGroup[g]=h.USER_IN_GROUP[g]}else{for(var f=0;f<h.USER_IN_GROUP[g].users.length;f++){this.BXIM.messenger.userInGroup[g].users.push(h.USER_IN_GROUP[g].users[f])}this.BXIM.messenger.userInGroup[g].users=d.util.array_unique(this.BXIM.messenger.userInGroup[g].users)}}if(this.BXIM.messenger.currentTab=="chat"+h.CHAT_ID){if(this.BXIM.messenger.chat[h.CHAT_ID]&&this.BXIM.messenger.chat[h.CHAT_ID].type=="call"){this.BXIM.messenger.openCallFlag=true}else{if(this.BXIM.messenger.chat[h.CHAT_ID]&&this.BXIM.messenger.chat[h.CHAT_ID].type=="lines"){this.BXIM.messenger.openLinesFlag=true}}this.drawTab(this.BXIM.messenger.currentTab)}}},this)})};a.prototype.loadLastMessage=function(g,l){if(this.BXIM.messenger.loadLastMessageTimeout[g]){return false}l=typeof(l)=="function"?l:function(n,m,o){};var f=0;var h=false;if(g.toString().substr(0,4)=="chat"){f=g.toString().substr(4);h=true}else{if(g.toString().substr(0,2)=="sg"){f=g.toString().substr(2);h=true}}this.BXIM.messenger.historyWindowBlock=true;delete this.BXIM.messenger.redrawTab[g];this.BXIM.messenger.loadLastMessageTimeout[g]=true;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==g){if((h&&(!this.BXIM.messenger.chat[f]||this.BXIM.messenger.chat[f].fake))||(!h&&(!this.BXIM.messenger.users[g]||this.BXIM.messenger.users[g].fake))){d.addClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}}var i=d.delegate(function(){this.BXIM.messenger.loadLastMessageTimeout[g]=false;l(g,false,{});if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==g){d.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;clearTimeout(this.BXIM.messenger.loadLastMessageTimeout);this.BXIM.messenger.loadLastMessageTimeout=setTimeout(d.delegate(function(){d.MessengerCommon.loadLastMessage(g)},this),2000);return true}this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.redrawTab[g]=true;if(!this.BXIM.messenger.showMessage[g]||this.BXIM.messenger.showMessage[g].length<=0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";var n=[d.create("div",{props:{className:"bx-messenger-content-empty"},children:[d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_ERROR")})]})];d.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:n});if(this.isMobile()&&this.MobileActionEqual("DIALOG")){BXMobileApp.UI.Page.TopBar.title.setText(d.message("IM_F_ERROR"));BXMobileApp.UI.Page.TopBar.title.setDetailText("")}}else{this.BXIM.messenger.tooltip(this.BXIM.messenger.popupMessengerBody,d.message("IM_M_LOAD_ERROR"),{offsetTop:-10,offsetLeft:50,bindOptions:{position:"top"}});var m=d.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history");if(m){d.remove(m)}}},this);var e=d.delegate(function(q){this.BXIM.messenger.loadLastMessageTimeout[g]=false;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==q.USER_ID){d.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(!this.BXIM.checkRevision(this.isMobile()?q.MOBILE_REVISION:q.REVISION)){return false}if(!q){i();return false}if(q&&q.BITRIX_SESSID){d.message({bitrix_sessid:q.BITRIX_SESSID})}if(q.ERROR==""){if(this.isMobile()){this.BXIM.disk.setChatParams(parseInt(q.CHAT_ID),parseInt(q.DISK_FOLDER_ID))}if(h){if(q.USER_ID.toString().substr(0,2)=="sg"){if(this.BXIM.messenger.currentTab==q.USER_ID){this.BXIM.messenger.currentTab="chat"+q.CHAT_ID}delete this.BXIM.messenger.chat[q.USER_ID];q.USER_ID="chat"+q.CHAT_ID;d.MessengerCommon.getUserParam(q.USER_ID)}}else{this.BXIM.messenger.userChat[g]=q.CHAT_ID;d.MessengerCommon.getUserParam(g,true);this.BXIM.messenger.users[g].name=d.message("IM_M_USER_NO_ACCESS")}for(var n in q.USERS){q.USERS[n].last_activity_date=new Date(q.USERS[n].last_activity_date);q.USERS[n].mobile_last_date=new Date(q.USERS[n].mobile_last_date);q.USERS[n].idle=q.USERS[n].idle?new Date(q.USERS[n].idle):false;q.USERS[n].absent=q.USERS[n].absent?new Date(q.USERS[n].absent):false;this.BXIM.messenger.users[n]=q.USERS[n]}for(var n in q.PHONES){this.BXIM.messenger.phones[n]={};for(var m in q.PHONES[n]){this.BXIM.messenger.phones[n][m]=d.util.htmlspecialcharsback(q.PHONES[n][m])}}for(var n in q.USER_IN_GROUP){if(typeof(this.BXIM.messenger.userInGroup[n])=="undefined"||typeof(this.BXIM.messenger.userInGroup[n].users)=="undefined"||!this.BXIM.messenger.userInGroup[n].users.length){this.BXIM.messenger.userInGroup[n]=q.USER_IN_GROUP[n]}else{for(var m=0;m<q.USER_IN_GROUP[n].users.length;m++){this.BXIM.messenger.userInGroup[n].users.push(q.USER_IN_GROUP[n].users[m])}this.BXIM.messenger.userInGroup[n].users=d.util.array_unique(this.BXIM.messenger.userInGroup[n].users)}}if(!h&&q.USER_LOAD=="Y"){d.MessengerCommon.userListRedraw()}for(var n in q.FILES){if(!this.BXIM.messenger.disk.files[q.CHAT_ID]){this.BXIM.messenger.disk.files[q.CHAT_ID]={}}q.FILES[n].date=new Date(q.FILES[n].date);this.BXIM.messenger.disk.files[q.CHAT_ID][n]=q.FILES[n]}this.BXIM.messenger.sendAjaxTry=0;var p=0;for(var n in q.MESSAGE){p++;q.MESSAGE[n].date=new Date(q.MESSAGE[n].date);this.BXIM.messenger.message[n]=q.MESSAGE[n];this.BXIM.lastRecordId=parseInt(n)>this.BXIM.lastRecordId?parseInt(n):this.BXIM.lastRecordId}if(p<=0){delete this.BXIM.messenger.redrawTab[q.USER_ID]}for(var n in q.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[n]){this.BXIM.messenger.showMessage[n]=d.util.array_unique(d.util.array_merge(q.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]))}else{this.BXIM.messenger.showMessage[n]=q.USERS_MESSAGE[n]}}if(h&&this.BXIM.messenger.chat[q.USER_ID.toString().substr(4)].fake){this.BXIM.messenger.chat[q.USER_ID.toString().substr(4)].name=d.message("IM_M_USER_NO_ACCESS")}for(var n in q.CHAT){q.CHAT[n].date_create=new Date(q.CHAT[n].date_create);this.BXIM.messenger.chat[n]=q.CHAT[n]}for(var n in q.USER_IN_CHAT){this.BXIM.messenger.userInChat[n]=q.USER_IN_CHAT[n]}for(var n in q.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[n]=q.USER_BLOCK_CHAT[n]}if(q.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var n in q.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[n]=q.OPENLINES.canVoteAsHead[n]}}if(this.BXIM.messenger.currentTab==q.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}}if(q.NETWORK_ID!=""){this.BXIM.messenger.currentTab=q.USER_ID?q.USER_ID:0;delete this.BXIM.messenger.users[q.NETWORK_ID];if(!this.BXIM.messenger.bot[q.USER_ID]){this.BXIM.messenger.bot[q.USER_ID]=this.BXIM.messenger.bot[q.NETWORK_ID]}delete this.BXIM.messenger.bot[q.NETWORK_ID];if(this.MobileActionEqual("RECENT")){var s=0;for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(this.BXIM.messenger.recent[n].userId==q.NETWORK_ID){s++;this.BXIM.messenger.recent[n].userId=q.USER_ID;this.BXIM.messenger.recent[n].recipientId=q.USER_ID;this.BXIM.messenger.recent[n].senderId=q.USER_ID}else{if(this.BXIM.messenger.recent[n].userId==q.USER_ID){s++}}}if(s>1){for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(this.BXIM.messenger.recent[n].userId==q.USER_ID){this.recentListHide(q.USER_ID,false);break}}}d.MessengerCommon.userListRedraw()}else{if(this.isMobile()&&this.MobileActionEqual("DIALOG")){app.onCustomEvent("onImDialogNetworkOpen",{NETWORK_ID:q.NETWORK_ID,USER_ID:q.USER_ID,USER:this.BXIM.messenger.users[q.USER_ID]})}}}if(h){for(var n in q.READED_LIST){for(var o in q.READED_LIST[n]){q.READED_LIST[n][o].date=new Date(q.READED_LIST[n][o].date)}this.BXIM.messenger.readedList[n]=q.READED_LIST[n]}}else{for(var n in q.READED_LIST){q.READED_LIST[n].date=new Date(q.READED_LIST[n].date);this.BXIM.messenger.readedList[n]=q.READED_LIST[n]}}if(h&&this.BXIM.messenger.chat[q.CHAT_ID]&&this.BXIM.messenger.chat[q.CHAT_ID].type=="livechat"){var r=this.livechatGetSession(q.CHAT_ID);if(r.readed=="Y"){r.readedTime=r.readedTime?new Date(r.readedTime):new Date();this.BXIM.messenger.readedList["chat"+q.CHAT_ID]={messageId:r.readedId,date:r.readedTime}}}this.changeUnreadMessage(q.UNREAD_MESSAGE);this.drawTab(q.USER_ID,this.BXIM.messenger.currentTab==q.USER_ID,p);if(this.BXIM.messenger.currentTab==q.USER_ID&&this.BXIM.messenger.readedList[q.USER_ID]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(q.USER_ID,false)}else{this.drawReadMessage(q.USER_ID,this.BXIM.messenger.readedList[q.USER_ID].messageId,this.BXIM.messenger.readedList[q.USER_ID].date,false)}}this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){this.readMessage(q.USER_ID,true,false)}if(this.isMobile()){setTimeout(d.delegate(function(){this.BXIM.messenger.autoScroll()},this),100)}d.onCustomEvent(b,"onImLoadLastMessage",[g,true,q]);l(g,true,q)}else{this.BXIM.messenger.redrawTab[g]=true;if(q.ERROR=="ACCESS_DENIED"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}else{if(q.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(function(){this.loadLastMessage(g)},this),2000);d.onCustomEvent(b,"onImError",[q.ERROR,q.BITRIX_SESSID])}else{if(q.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(d.delegate(function(){this.loadLastMessage(g)},this),10000)}d.onCustomEvent(b,"onImError",[q.ERROR])}}}l(g,false,q)}},this);var k=this.isMobile()||this.BXIM.isFocus();if(h&&this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].owner==0&&this.BXIM.messenger.chat[f].type=="lines"){k=false}var j=d.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&D="+g+"&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:h?"Y":"N",USER_ID:g,USER_LOAD:"Y",TAB:this.BXIM.messenger.currentTab,READ:k?"Y":"N",MOBILE:this.isMobile()?"Y":"N",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",SEARCH_MARK:!h&&this.BXIM.messenger.users[g]&&this.BXIM.messenger.users[g].search_mark?this.BXIM.messenger.users[g].search_mark:"",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:e,onprogress:function(m){if(m.position==0&&m.totalSize==0){i()}},onfailure:i})};a.prototype.openDialog=function(i,f,h){var g=d.MessengerCommon.getUserParam(i);if(g.id<=0){return false}this.BXIM.messenger.currentTab=i?i:0;if(i.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[i.toString().substr(4)]&&this.BXIM.messenger.chat[i.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}else{if(this.BXIM.messenger.chat[i.toString().substr(4)]&&this.BXIM.messenger.chat[i.toString().substr(4)].type=="lines"){this.BXIM.messenger.openLinesFlag=true}}}d.localStorage.set("mct",this.BXIM.messenger.currentTab,15);if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanelChat.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanelCall.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-hide"}}f=f==true;h=h!=false;var j=[];if(typeof(this.BXIM.messenger.showMessage[i])!="undefined"&&this.BXIM.messenger.showMessage[i].length>0){if(this.BXIM.messenger.showMessage[i]&&this.BXIM.messenger.unreadMessage[i]&&this.BXIM.messenger.showMessage[i].length!=0&&this.BXIM.messenger.showMessage[i].length==this.BXIM.messenger.unreadMessage[i].length){this.drawTab(i,true);d.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");var k=d.create("div",{props:{className:"bx-notifier-content-link-history"},children:[d.create("span",{props:{className:"bx-messenger-content-load-img"}}),d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_MESSAGE")})]});this.BXIM.messenger.redrawTab[i]=true;this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(k,this.BXIM.messenger.popupMessengerBodyWrap.firstChild);if(this.isMobile()){setTimeout(d.delegate(function(){this.BXIM.messenger.autoScroll()},this),100)}}else{if(!g.fake&&this.BXIM.messenger.showMessage[i].length>=15){if(this.isMobile()&&this.BXIM.webComponent){this.drawTab(i,true);this.BXIM.messenger.redrawTab[i]=true}else{this.BXIM.messenger.redrawTab[i]=false}}else{this.drawTab(i,true);this.BXIM.messenger.redrawTab[i]=true}}}else{if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){d.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");j=[d.create("div",{props:{className:"bx-messenger-content-empty"},children:[d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[i]=true}else{if(typeof(this.BXIM.messenger.showMessage[i])=="undefined"){d.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");j=[d.create("div",{props:{className:"bx-messenger-content-load"},children:[d.create("span",{props:{className:"bx-messenger-content-load-img"}}),d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[i]=true}else{if(this.BXIM.messenger.redrawTab[i]&&this.BXIM.messenger.showMessage[i].length==0){d.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");j=[d.create("div",{props:{className:"bx-messenger-content-load"},children:[d.create("span",{props:{className:"bx-messenger-content-load-img"}}),d.create("span",{props:{className:"bx-messenger-content-load-text"},html:d.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[i]=[]}else{var e="";if(this.isBot(i)&&this.BXIM.messenger.users[i]){e=d.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[i].name)}else{e=d.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE")}d.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");j=[d.create("div",{props:{className:"bx-messenger-content-empty"},children:[d.create("span",{props:{className:"bx-messenger-content-load-text"},html:e})]})]}}}}if(j.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";d.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:j})}if(f){this.BXIM.messenger.extraClose()}if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[i]?this.BXIM.messenger.textareaHistory[i]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[i]?this.BXIM.messenger.textareaHistory[i]:""}if(this.BXIM.messenger.redrawTab[i]){if(this.BXIM.settings.loadLastMessage){this.loadLastMessage(i)}else{if(this.BXIM.messenger.openChatFlag){d.MessengerCommon.loadChatData(i.toString().substr(4))}else{d.MessengerCommon.loadUserData(i)}delete this.BXIM.messenger.redrawTab[i];this.drawTab(i,true)}}else{this.drawTab(i,true)}if(!this.BXIM.messenger.redrawTab[i]){if(this.isMobile()){this.BXIM.isFocusMobile(d.delegate(function(l){if(l){d.MessengerCommon.readMessage(i)}},this))}else{if(this.BXIM.isFocus()){this.readMessage(i)}}}if(!this.isMobile()){this.BXIM.messenger.resizeMainWindow()}if(d.MessengerCommon.countWriting(i)){if(this.BXIM.messenger.openChatFlag){d.MessengerCommon.drawWriting(0,i)}else{d.MessengerCommon.drawWriting(i)}}else{if(this.BXIM.messenger.readedList[i]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(i,false)}else{this.drawReadMessage(i,this.BXIM.messenger.readedList[i].messageId,this.BXIM.messenger.readedList[i].date,false)}}}if(!this.isMobile()&&h){this.BXIM.webrtc.callOverlayToggleSize(true)}d.onCustomEvent("onImDialogOpen",[{id:i}]);if(this.isMobile()){BXMobileApp.onCustomEvent("onImDialogOpen",{id:i},true)}};a.prototype.drawTab=function(k,m,o,h){o=o||0;h=h!==false;if(!k){k=this.BXIM.messenger.currentTab}if(this.BXIM.messenger.popupMessenger==null||k!=this.BXIM.messenger.currentTab){return false}if(typeof(this.messageGroup)!="object"){this.messageGroup={}}this.messageGroup["default"]={};var l=true;if(this.BXIM.messenger.openChatFlag){var j=k.toString().substr(4);if(this.BXIM.messenger.chat[j]){if(this.BXIM.messenger.chat[j].type=="open"){if(!d.MessengerCommon.userInChat(j)){if(this.isMobile()){BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"IM_PUBLIC_"+j,force:this.BXIM.messenger.redrawTab[k]?false:true},true)}else{d.PULL.extendWatch("IM_PUBLIC_"+j,this.BXIM.messenger.redrawTab[k]?false:true)}}}else{if(this.BXIM.messenger.chat[j].type=="lines"){l=false}}}}if(this.isPage()&&h){if(l){if(d.MessengerWindow.currentTab!="im"){d.MessengerWindow.changeTab("im")}}else{if(this.BXIM.settings.linesTabEnable){if(d.MessengerWindow.currentTab!="im-ol"){d.MessengerWindow.changeTab("im-ol")}}}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";d.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");if(!this.BXIM.messenger.showMessage[k]||this.BXIM.messenger.showMessage[k].length<=0){var n="";var f=null;if(this.isBot(k)&&this.BXIM.messenger.users[k]){n=d.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[k].name)}else{n=d.message(this.BXIM.settings.loadLastMessage?"IM_M_NO_MESSAGE_2":"IM_M_NO_MESSAGE");f=d.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[d.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:d.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:d.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}})}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(d.create("div",{props:{className:"bx-messenger-content-empty"},children:[d.create("span",{props:{className:"bx-messenger-content-load-text"},html:n}),f]}))}if(this.BXIM.messenger.showMessage[k]){this.BXIM.messenger.showMessage[k].sort(d.delegate(function(q,s){if(!this.BXIM.messenger.message[q]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[q].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return -1}else{if(t>r){return 1}else{if(q<s){return -1}else{if(q>s){return 1}else{return 0}}}}},this))}else{this.BXIM.messenger.showMessage[k]=[]}for(var g=0;g<this.BXIM.messenger.showMessage[k].length;g++){if(this.isMobile()&&this.BXIM.webComponent&&this.BXIM.messenger.showMessage[k][g].toString().indexOf("temp")==0){continue}d.MessengerCommon.drawMessage(k,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[k][g]],false)}if(o>0&&o<20){if(!this.BXIM.messenger.openChatFlag||this.BXIM.messenger.chat[k.toString().substr(4)]){var p=false;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[k.toString().substr(4)].date_create){if((this.BXIM.messenger.chat[k.toString().substr(4)].date_create.getTime()/1000)+2500000>(new Date().getTime())/1000){p=true}}if(!p){var f=d.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[d.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:d.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:d.delegate(function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)},this)}});this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(f,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}}m=m!=false;if(m){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}if(this.BXIM.messenger.unreadMessage[k]&&this.BXIM.messenger.unreadMessage[k].length>0){var e=d("im-message-"+this.BXIM.messenger.unreadMessage[k][0]);if(e&&e.parentNode.parentNode.parentNode.parentNode.parentNode){d.scrollToNode(e.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}d.onCustomEvent("onImDrawTab",[{id:k,hasMessage:this.BXIM.messenger.showMessage[k]&&this.BXIM.messenger.showMessage[k].length>0}]);delete this.BXIM.messenger.redrawTab[k]};a.prototype.sendMessageAjax=function(f,i,j,h){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){return false}d.MessengerCommon.drawProgessMessage("temp"+f);if(this.BXIM.messenger.sendMessageFlag<0){this.BXIM.messenger.sendMessageFlag=0}clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+f]);if(this.BXIM.messenger.sendMessageTmp[f]){return false}this.BXIM.messenger.sendMessageTmp[f]=true;h=h==true;this.BXIM.messenger.sendMessageFlag++;var e="N";if(h&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[i.toString().substr(4)]){e="Y"}this.recentListAdd({id:"temp"+f,date:new Date(),skipDateCheck:true,recipientId:i,senderId:this.BXIM.userId,text:j,userId:i,userIsChat:h,params:{CLASS:e=="Y"?"bx-messenger-content-item-system":""}},true);d.onCustomEvent("onImBeforeMessageSend",[{recipientId:i,messageText:j}]);var g=d.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:120,data:{IM_SEND_MESSAGE:"Y",CHAT:h?"Y":"N",ID:"temp"+f,RECIPIENT_ID:i,MESSAGE:j,OL_SILENT:e,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:d.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(m){this.BXIM.messenger.sendMessageFlag--;if(m&&m.BITRIX_SESSID){d.message({bitrix_sessid:m.BITRIX_SESSID})}if(m&&m.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.message[m.TMP_ID].text=m.SEND_MESSAGE;this.BXIM.messenger.message[m.TMP_ID].id=m.ID;this.BXIM.messenger.message[m.TMP_ID].date=new Date(m.SEND_DATE);if(m.SEND_MESSAGE_PARAMS){this.BXIM.messenger.message[m.TMP_ID].params=m.SEND_MESSAGE_PARAMS}for(var n in m.SEND_MESSAGE_FILES){if(!this.BXIM.messenger.disk.files[m.CHAT_ID]){this.BXIM.messenger.disk.files[m.CHAT_ID]={}}if(this.BXIM.messenger.disk.files[m.CHAT_ID][n]){continue}m.SEND_MESSAGE_FILES[n].date=new Date(m.SEND_MESSAGE_FILES[n].date);this.BXIM.messenger.disk.files[m.CHAT_ID][n]=m.SEND_MESSAGE_FILES[n]}this.BXIM.messenger.message[m.ID]=this.BXIM.messenger.message[m.TMP_ID];if(this.BXIM.messenger.popupMessengerLastMessage==m.TMP_ID){this.BXIM.messenger.popupMessengerLastMessage=m.ID}delete this.BXIM.messenger.message[m.TMP_ID];var u=this.BXIM.messenger.message[m.ID];var q=d.util.array_search(""+m.TMP_ID+"",this.BXIM.messenger.showMessage[m.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[m.RECIPIENT_ID][q]){this.BXIM.messenger.showMessage[m.RECIPIENT_ID][q]=""+m.ID+""}for(var n=0;n<this.BXIM.messenger.recent.length;n++){if(this.BXIM.messenger.recent[n].id==m.TMP_ID){this.BXIM.messenger.recent[n].id=""+m.ID+"";break}}if(m.RECIPIENT_ID==this.BXIM.messenger.currentTab){var o=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+m.TMP_ID+""}},true);if(o){o.setAttribute("data-messageid",""+m.ID+"");if(o.getAttribute("data-blockmessageid")==""+m.TMP_ID+""){o.setAttribute("data-blockmessageid",""+m.ID+"")}else{var s=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+m.TMP_ID+""}},true);if(s){s.setAttribute("data-blockmessageid",""+m.ID+"")}}var p=d.findChild(o,{attribute:{"data-messageid":""+m.TMP_ID+""}},true);if(p){p.setAttribute("data-messageid",""+m.ID+"")}}var l=d("im-message-"+m.TMP_ID);if(l){l.id="im-message-"+m.ID;var r={oneSmileInMessage:false};l.innerHTML=d.MessengerCommon.prepareText(m.SEND_MESSAGE,false,true,true,null,r);if(r.oneSmileInMessage){var t=d.findChildByClassName(o,"bx-messenger-content-item-content");if(t){d.addClass(t,"bx-messenger-content-item-content-transparent")}}}var k=d.findChildByClassName(o,"bx-messenger-content-item-date");if(k){k.innerHTML=d.MessengerCommon.formatDate(u.date,d.MessengerCommon.getDateFormatType("MESSAGE"))}d.MessengerCommon.clearProgessMessage(m.ID)}if(this.BXIM.messenger.history[m.RECIPIENT_ID]){this.BXIM.messenger.history[m.RECIPIENT_ID].push(u.id)}else{this.BXIM.messenger.history[m.RECIPIENT_ID]=[u.id]}this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(m.SEND_MESSAGE_PARAMS){if(m.SEND_MESSAGE_PARAMS.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){d.addClass(o.firstElementChild,"bx-messenger-content-item-content-rich-link")}if(m.RECIPIENT_ID.toString().substr(0,4)=="chat"){if(this.isMobile()){d.onCustomEvent(b,"onPull-im",[{command:"messageParamsUpdate",params:{id:m.ID,type:"chat",chatId:m.CHAT_ID,senderId:m.SENDER_ID,params:m.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{d.onCustomEvent(b,"onPullEvent-im",["messageParamsUpdate",{id:m.ID,type:"chat",chatId:m.CHAT_ID,senderId:m.SENDER_ID,params:m.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}else{if(this.isMobile()){d.onCustomEvent(b,"onPull-im",[{command:"messageParamsUpdate",params:{id:m.ID,type:"private",chatId:m.CHAT_ID,fromUserId:m.SENDER_ID,toUserId:m.RECIPIENT_ID,senderId:m.SENDER_ID,params:m.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision,}}])}else{d.onCustomEvent(b,"onPullEvent-im",["messageParamsUpdate",{id:m.ID,type:"private",chatId:m.CHAT_ID,fromUserId:m.SENDER_ID,toUserId:m.RECIPIENT_ID,senderId:m.SENDER_ID,params:m.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}}if(d.PULL){d.PULL.setUpdateStateStepCount(2,5)}d.MessengerCommon.updateStateVar(m,true,true);d.localStorage.set("msm",{id:m.ID,recipientId:m.RECIPIENT_ID,date:m.SEND_DATE,text:m.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:m.MESSAGE,USERS_MESSAGE:m.USERS_MESSAGE,USERS:m.USERS,USER_IN_GROUP:m.USER_IN_GROUP},5);if(this.isMobile()&&document.body.offsetHeight<=b.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else{if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}(this.BXIM.messenger.popupMessengerBodyAnimation=new d.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:d.easing.makeEaseInOut(d.easing.transitions.quart),step:d.delegate(function(v){this.BXIM.messenger.popupMessengerBody.scrollTop=v.scroll},this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}}else{if(m&&m.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(function(){this.BXIM.messenger.sendMessageTmp[f]=false;this.sendMessageAjax(f,i,j,h)},this),2000);d.onCustomEvent(b,"onImError",[m.ERROR,m.BITRIX_SESSID])}else{if(m&&m.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(d.delegate(function(){this.BXIM.messenger.sendMessageTmp[f]=false;this.sendMessageAjax(f,i,j,h)},this),10000)}d.onCustomEvent(b,"onImError",[m.ERROR])}else{this.BXIM.messenger.sendMessageTmp[f]=false;var o=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+f}},true);var k=d.findChildByClassName(o,"bx-messenger-content-item-date");if(k){if(m.ERROR=="SESSION_ERROR"||m.ERROR=="AUTHORIZE_ERROR"||m.ERROR=="UNKNOWN_ERROR"||m.ERROR=="IM_MODULE_NOT_INSTALLED"){k.innerHTML=d.message("IM_M_NOT_DELIVERED")}else{k.innerHTML=m.ERROR}}d.onCustomEvent(b,"onImError",["SEND_ERROR",m.ERROR,m.TMP_ID,m.SEND_DATE,m.SEND_MESSAGE,m.RECIPIENT_ID]);d.MessengerCommon.drawProgessMessage("temp"+f,{title:d.message("IM_M_RETRY"),chat:h?"Y":"N"});if(this.BXIM.messenger.message["temp"+f]){this.BXIM.messenger.message["temp"+f].retry=true}}}}},this),onfailure:d.delegate(function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[f]=false;var k=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+f}},true);var m=d.findChildByClassName(k,"bx-messenger-content-item-date");if(m){m.innerHTML=d.message("IM_M_NOT_DELIVERED")}d.MessengerCommon.drawProgessMessage("temp"+f,{title:d.message("IM_M_RETRY"),chat:h?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof(g)=="object"&&g.status==0){d.onCustomEvent(b,"onImError",["CONNECT_ERROR"])}}catch(l){}if(this.BXIM.messenger.message["temp"+f]){this.BXIM.messenger.message["temp"+f].retry=true}},this)})};a.prototype.sendMessageRetry=function(){var h=this.BXIM.messenger.currentTab;var f=[];for(var e=0;e<this.BXIM.messenger.showMessage[h].length;e++){var g=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[h][e]];if(!g||g.id.toString().indexOf("temp")!=0){continue}g.text=d.MessengerCommon.prepareTextBack(g.text);f.push(g)}if(f.length<=0){return false}f.sort(function(j,k){j=j.id.substr(4);k=k.id.substr(4);if(j<k){return -1}else{if(j>k){return 1}else{return 0}}});for(var e=0;e<f.length;e++){this.sendMessageRetryTimeout(f[e],100*e)}};a.prototype.sendMessageRetryTimeout=function(e,f){clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(d.delegate(function(){d.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat")},this),f)};a.prototype.getLastMessageInDialog=function(f){var e=false;if(this.BXIM.messenger.showMessage[f]&&this.BXIM.messenger.showMessage[f].length>0){var g=this.BXIM.messenger.showMessage[f][this.BXIM.messenger.showMessage[f].length-1];e=this.BXIM.messenger.message[g]}return e};a.prototype.joinToChat=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].type!="open"){return false}if(d.MessengerCommon.userInChat(e)){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.ajax({url:this.BXIM.pathToAjax+"?CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_CHAT_JOIN:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.popupMessengerTextarea.disabled=false;this.BXIM.messenger.popupMessengerTextarea.focus()},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.messageUrlAttachDelete=function(f,h){if(f.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[f]||!this.BXIM.messenger.message[f].params||!this.BXIM.messenger.message[f].params.ATTACH||!this.BXIM.messenger.message[f].params.URL_ID||this.BXIM.messenger.message[f].params.URL_ID.indexOf(parseInt(h))==-1&&this.BXIM.messenger.message[f].params.URL_ID.indexOf(h.toString())==-1){return false}for(var g=0;g<this.BXIM.messenger.message[f].params.ATTACH.length;g++){if(!this.BXIM.messenger.message[f].params.ATTACH[g]){continue}if(this.BXIM.messenger.message[f].params.ATTACH[g].ID==h){delete this.BXIM.messenger.message[f].params.ATTACH[g];break}}for(var g=0;g<this.BXIM.messenger.message[f].params.URL_ID.length;g++){if(!this.BXIM.messenger.message[f].params.URL_ID[g]){continue}if(this.BXIM.messenger.message[f].params.URL_ID[g]==h){delete this.BXIM.messenger.message[f].params.URL_ID[g];break}}var j=d("im-message-"+f);var e=d.MessengerCommon.drawAttach(f,this.BXIM.messenger.message[f].chatId,this.BXIM.messenger.message[f].params.ATTACH);j.nextElementSibling.innerHTML="";if(e.length>0){d.adjust(j.nextElementSibling,{children:e})}if(e.length<=0){d.removeClass(j.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}d.ajax({url:this.BXIM.pathToAjax+"?URL_ATTACH_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_URL_ATTACH_DELETE:"Y",ID:f,ATTACH_ID:h,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()}});return true};a.prototype.messageLike=function(m,l){if(m.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[m]||this.BXIM.messenger.popupMessengerLikeBlock[m]){return false}l=typeof(l)=="undefined"?false:l;if(!this.BXIM.messenger.message[m].params){this.BXIM.messenger.message[m].params={}}if(!this.BXIM.messenger.message[m].params.LIKE){this.BXIM.messenger.message[m].params.LIKE=[]}var e=d.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[m].params.LIKE);if(!l){var n=e?"minus":"plus";if(n=="plus"){this.BXIM.messenger.message[m].params.LIKE.push(this.BXIM.userId);e=true}else{var g=[];for(var j=0;j<this.BXIM.messenger.message[m].params.LIKE.length;j++){if(this.BXIM.messenger.message[m].params.LIKE[j]!=this.BXIM.userId){g.push(this.BXIM.messenger.message[m].params.LIKE[j])}}this.BXIM.messenger.message[m].params.LIKE=g;e=false}}var f=this.BXIM.messenger.message[m].params.LIKE.length>0?this.BXIM.messenger.message[m].params.LIKE.length:"";if(d("im-message-"+m)){var k=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+m+""}},false);var o=d.findChildByClassName(k,"bx-messenger-content-item-like");var h=d.findChildByClassName(k,"bx-messenger-content-like-digit",false);if(e){d.addClass(o,"bx-messenger-content-item-liked")}else{d.removeClass(o,"bx-messenger-content-item-liked")}if(f>0){h.setAttribute("title",d.message("IM_MESSAGE_LIKE_LIST"));d.removeClass(h.parentNode,"bx-messenger-content-like-digit-off")}else{h.setAttribute("title","");d.addClass(h.parentNode,"bx-messenger-content-like-digit-off")}h.innerHTML=f}if(this.isMobile()){app.exec("callVibration")}if(!l){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[m]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[m]=setTimeout(d.delegate(function(){this.BXIM.messenger.popupMessengerLikeBlock[m]=true;d.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:m,ACTION:n,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(i){if(i.ERROR==""){this.BXIM.messenger.message[m].params.LIKE=i.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[m]=false;d.MessengerCommon.messageLike(m,true)},this),onfailure:d.delegate(function(i){this.BXIM.messenger.popupMessengerLikeBlock[m]=false},this)})},this),1000)}return true};a.prototype.messageIsLike=function(e){return(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&typeof(this.BXIM.messenger.message[e].params.LIKE)=="object"&&d.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE))};a.prototype.checkEditMessage=function(h,g){g=g||"list";if(this.BXIM.messenger.openLinesFlag){var f=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)])}var e=false;if(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"){return e}if(this.BXIM.ppServerStatus&&parseInt(h)!=0&&h.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[h]&&(this.BXIM.messenger.message[h].date.getTime()/1000)+259200>(new Date().getTime())/1000&&(!this.BXIM.messenger.message[h].params||this.BXIM.messenger.message[h].params.IS_DELETED!="Y")&&d("im-message-"+h)&&d.util.in_array(h,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){if(this.BXIM.messenger.openLinesFlag){if(this.BXIM.messenger.message[h].senderId==this.BXIM.userId){if(g=="edit"){e=this.BXIM.messenger.openlines.canUpdateOwnMessage.indexOf(f)>-1}else{if(g=="delete"){e=this.BXIM.messenger.openlines.canDeleteOwnMessage.indexOf(f)>-1}}}else{if(this.BXIM.messenger.openlines.canDeleteMessage.indexOf(f)>-1&&g=="delete"){e=true}}if(e&&f!="network"){if(!this.BXIM.messenger.message[h].params||typeof(this.BXIM.messenger.message[h].params.CONNECTOR_MID)=="undefined"||this.BXIM.messenger.message[h].params.CONNECTOR_MID.length<=0){e=false}}}else{if(this.BXIM.messenger.message[h].senderId==this.BXIM.userId){e=true}}}return e};a.prototype.editMessageAjax=function(f,e){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){return false}this.BXIM.messenger.editMessageCancel();if(!d.MessengerCommon.checkEditMessage(f,"edit")){return false}if(e==d.MessengerCommon.prepareTextBack(this.BXIM.messenger.message[f].text,true)){return false}e=e.replace("    ","\t");e=d.util.trim(e);if(e.length<=0){d.MessengerCommon.deleteMessageAjax(f);return false}e=d.MessengerCommon.prepareMention(this.BXIM.messenger.currentTab,e);d.MessengerCommon.drawProgessMessage(f);d.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_EDIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_EDIT_MESSAGE:"Y",ID:f,MESSAGE:e,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(g){d.MessengerCommon.clearProgessMessage(f)},this),onfailure:d.delegate(function(){d.MessengerCommon.clearProgessMessage(f)},this)})};a.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(this.BXIM.isAdmin&&this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.message[e].chatId&&this.BXIM.messenger.generalChatId==this.BXIM.messenger.message[e].chatId){}else{if(!d.MessengerCommon.checkEditMessage(e,"delete")){return false}}d.MessengerCommon.drawProgessMessage(e);d.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(f){if(f.ERROR){return false}if(this.BXIM.messenger.message[e]){this.BXIM.messenger.message[e].isNowDeleted=true}d.MessengerCommon.clearProgessMessage(e)},this),onfailure:d.delegate(function(){d.MessengerCommon.clearProgessMessage(e)},this)});return true};a.prototype.shareMessageAjax=function(g,f,e){d.MessengerCommon.drawProgessMessage(g);d.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SHARE&TYPE="+f+"&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SHARE_MESSAGE:"Y",ID:g,TYPE:f,DATE:e?e:0,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){if(h.ERROR){return false}d.MessengerCommon.clearProgessMessage(g)},this),onfailure:d.delegate(function(){d.MessengerCommon.clearProgessMessage(g)},this)});return true};a.prototype.drawKeyboard=function(o,k,f){if(!f||f=="N"){return null}var e=null;var m=[];var g=null;var j=null;for(var h=0;h<f.length;h++){if(f[h].TYPE=="NEWLINE"){g=d.create("div",{props:{className:"bx-messenger-keyboard-new-line"}})}else{if(f[h].CONTEXT&&(this.isMobile()&&f[h].CONTEXT=="DESKTOP"||!this.isMobile()&&f[h].CONTEXT=="MOBILE")){continue}var l="";if(f[h].WIDTH){l=l+"width: "+f[h].WIDTH+"px;"}else{if(f[h].DISPLAY=="BLOCK"){l=l+"width: 225px;"}}if(f[h].BG_COLOR){l=l+"background-color: "+f[h].BG_COLOR+";"}if(f[h].TEXT_COLOR){l=l+"color: "+f[h].TEXT_COLOR+";"}if(f[h].DISABLED&&f[h].DISABLED=="Y"){j='<span class="bx-messenger-keyboard-button-text" data-disabled="Y" style="'+l+'">'+f[h].TEXT+"</span>"}else{if(f[h].LINK){j='<a href="'+f[h].LINK+'" target="_blank" class="bx-messenger-keyboard-button-text" style="'+l+'">'+f[h].TEXT+"</a>"}else{if(f[h].FUNCTION){var n=f[h].FUNCTION.toString().replace("#MESSAGE_ID#",k).replace("#DIALOG_ID#",o).replace("#USER_ID#",this.BXIM.userId);j='<a href="javascript:void(1);" onclick="'+n+'; BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+l+'">'+f[h].TEXT+"</a>"}else{if(f[h].APP_ID){f[h].APP_PARAMS=f[h].APP_PARAMS?f[h].APP_PARAMS:"";j='<a href="javascript:void(1);" onclick="BXIM.messenger.textareaIconDialogClick('+parseInt(f[h].APP_ID)+", "+k+", '"+(d.util.htmlspecialchars(f[h].APP_PARAMS))+'\'); BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+l+'">'+f[h].TEXT+"</a>"}else{j='<span class="bx-messenger-keyboard-button-text" data-dialogId="'+o+'" data-messageId="'+k+'" data-blockAfterClick="'+f[h].BLOCK+'" data-command="'+d.util.htmlspecialchars(f[h].COMMAND)+'" data-commandParams="'+d.util.htmlspecialchars(f[h].COMMAND_PARAMS)+'" data-botId="'+f[h].BOT_ID+'" style="'+l+'">'+f[h].TEXT+"</span>"}}}}g=d.create("span",{props:{className:"bx-messenger-keyboard-button bx-messenger-keyboard-button-"+(f[h].DISPLAY.toLowerCase())},children:[j]})}m.push(g)}if(m.length>0){e=d.create("div",{attrs:{id:"im-message-keyboard-"+k},props:{className:"bx-messenger-keyboard"},children:m})}return e};a.prototype.clickButtonKeyboard=function(){if(d.proxy_context.tagName=="A"){return true}if(this.sendBotCommand){return true}var n=d.proxy_context.getAttribute("data-dialogId");var l=d.proxy_context.getAttribute("data-messageId");var o=d.proxy_context.getAttribute("data-botId");var g=d.proxy_context.getAttribute("data-command");var k=d.proxy_context.getAttribute("data-commandParams");var h=d.proxy_context.getAttribute("data-disabled");var f=d.proxy_context.getAttribute("data-blockAfterClick");if(h=="Y"||d.hasClass(d.proxy_context,"bx-messenger-keyboard-button-block")){return true}this.sendBotCommand=true;if(!this.sendBotCommandBlock[o]){this.sendBotCommandBlock[o]={}}this.sendBotCommandBlock[o][l]=true;if(f=="Y"){var m=d("im-message-keyboard-"+l);if(m){var e=d.findChildrenByClassName(m,"bx-messenger-keyboard-button-text",false);for(var j=0;j<e.length;j++){d.addClass(e[j],"bx-messenger-keyboard-button-block")}}}d.addClass(d.proxy_context,"bx-messenger-keyboard-button-progress bx-messenger-keyboard-button-block");d.ajax({url:this.BXIM.pathToCallAjax+"?BOT_COMMAND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_BOT_COMMAND:"Y",BOT_ID:o,COMMAND:g,COMMAND_PARAMS:k,DIALOG_ID:n,MESSAGE_ID:l,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(i){this.sendBotCommand=false},this),onfailure:d.delegate(function(){this.sendBotCommand=false},this)});return true};a.prototype.drawAttach=function(p,o,C,g){if(!C||C.length==0){return[]}var v=[];if(typeof(C)!="object"){v.push(C)}else{v=C}g=g||{};var u=this.getUserIdByChatId(o);var l=[];for(var Q=0;Q<v.length;Q++){var x=v[Q];if(!x){continue}var E="";if(typeof(x.COLOR)!="undefined"){E=x.COLOR}else{if(u&&this.BXIM.messenger.users[u]){E=this.BXIM.messenger.users[u].color}else{if(this.BXIM.messenger.chat[o]){E=this.BXIM.messenger.chat[o].color}else{if(this.BXIM.messenger.users[this.BXIM.userId]){E=this.BXIM.messenger.users[this.BXIM.userId].color}}}}if(typeof(x.BLOCKS)!="object"){continue}var S=typeof(x.ID)!="undefined"?x.ID:0;var G=[];var F=false;if(S&&this.BXIM.messenger.message[p]&&this.BXIM.messenger.message[p].params&&this.BXIM.messenger.message[p].params.URL_ID&&(this.BXIM.messenger.message[p].params.URL_ID.indexOf(S)>-1||this.BXIM.messenger.message[p].params.URL_ID.indexOf(parseInt(S))>-1)){if(!this.BXIM.settings.enableRichLink){continue}if(this.BXIM.messenger.message[p].senderId==this.BXIM.userId){F=true}}if(F){G.push(d.create("span",{props:{className:"bx-messenger-attach-delete"},attrs:{"data-attachId":S,"data-messageId":p,"data-action":"url"}}))}for(var P=0;P<x.BLOCKS.length;P++){var w=x.BLOCKS[P];var K=null;if(w.USER&&w.USER.length>0){var y=[];for(var R=0;R<w.USER.length;R++){var m=null;if(w.USER[R].NETWORK_ID){m=d.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"network","data-networkId":w.USER[R].NETWORK_ID},html:w.USER[R].NAME})}else{if(w.USER[R].BOT_ID){if(this.BXIM.messenger.users[w.USER[R].BOT_ID]){w.USER[R].NAME=this.BXIM.messenger.users[w.USER[R].BOT_ID].name;w.USER[R].AVATAR=this.BXIM.messenger.users[w.USER[R].BOT_ID].avatar}else{if(!this.BXIM.messenger.bot[w.USER[R].BOT_ID]){w.USER[R].AVATAR=""}}m=d.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"user","data-userId":w.USER[R].BOT_ID},html:w.USER[R].NAME})}else{if(w.USER[R].USER_ID){m=d.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax "+(w.USER[R].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":w.USER[R].USER_ID},html:w.USER[R].NAME});if(this.BXIM.messenger.users[w.USER[R].USER_ID]){w.USER[R].AVATAR=this.BXIM.messenger.users[w.USER[R].USER_ID].avatar}}else{if(w.USER[R].CHAT_ID){m=d.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":w.USER[R].CHAT_ID},html:w.USER[R].NAME})}else{if(w.USER[R].LINK){m=d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.USER[R].LINK),target:"_blank"},props:{className:"bx-messenger-attach-user-name"},html:w.USER[R].NAME})}else{m=d.create("span",{props:{className:"bx-messenger-attach-user-name"},html:w.USER[R].NAME})}}}}}var f="user";if(w.USER[R].AVATAR_TYPE=="CHAT"){f="chat"}else{if(w.USER[R].AVATAR_TYPE=="BOT"){f="bot"}}var M=d.create("span",{props:{className:"bx-messenger-attach-user"},children:[d.create("span",{props:{className:"bx-messenger-attach-user-avatar"},children:[w.USER[R].AVATAR?d.create("img",{attrs:{src:d.util.htmlspecialcharsback(this.formatUrl(w.USER[R].AVATAR))},props:{className:"bx-messenger-attach-user-avatar-img"}}):d.create("span",{attrs:{style:"background-color: "+E},props:{className:"bx-messenger-attach-user-avatar-img bx-messenger-attach-"+f+"-avatar-default "}})]}),m]});y.push(M)}K=d.create("span",{props:{className:"bx-messenger-attach-users"},children:y})}else{if(w.LINK&&w.LINK.length>0){var s=[];for(var R=0;R<w.LINK.length;R++){var m=d.create("span",{props:{className:"bx-messenger-attach-link-name"},html:w.LINK[R].NAME?w.LINK[R].NAME:w.LINK[R].LINK});if(w.LINK[R].NETWORK_ID){m=d.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":w.LINK[R].NETWORK_ID},children:[m]})}else{if(w.LINK[R].USER_ID){m=d.create("span",{props:{className:"bx-messenger-ajax "+(w.LINK[R].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":w.LINK[R].USER_ID},children:[m]})}else{if(w.LINK[R].CHAT_ID){m=d.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":w.LINK[R].CHAT_ID},children:[m]})}else{m=d.create("span",{props:{className:"bx-messenger-attach-link-name"},children:[d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.LINK[R].LINK),target:"_blank"},html:w.LINK[R].NAME?w.LINK[R].NAME:w.LINK[R].LINK})]})}}}var N=null;if(w.LINK[R].DESC){N=d.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:w.LINK[R].DESC})}var I=null;if(w.LINK[R].HTML){I=d.create("div",{props:{className:"bx-messenger-attach-link-html"},html:w.LINK[R].HTML});var q=d.create("span",{props:{className:"bx-messenger-attach-link"+(w.LINK[R].PREVIEW?" bx-messenger-attach-link-with-preview":"")},children:[m,N,I]})}else{if(w.LINK[R].PREVIEW){I=d.create("span",{props:{className:"bx-messenger-file-image-src"},children:[d.create("img",{attrs:{src:d.util.htmlspecialcharsback(w.LINK[R].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}}),]});var q=d.create("div",{children:[m,N,I]})}else{var q=d.create("div",{children:[m,N]})}}s.push(q)}K=d.create("span",{props:{className:"bx-messenger-attach-links"},children:s})}else{if(w.RICH_LINK&&w.RICH_LINK.length>0){var s=[];for(var R=0;R<w.RICH_LINK.length;R++){var T=null;var m=d.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},html:w.RICH_LINK[R].NAME?w.RICH_LINK[R].NAME:w.RICH_LINK[R].LINK});if(w.RICH_LINK[R].NETWORK_ID){m=d.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":w.RICH_LINK[R].NETWORK_ID},children:[m]})}else{if(w.RICH_LINK[R].USER_ID){m=d.create("span",{props:{className:"bx-messenger-ajax "+(w.RICH_LINK[R].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":w.RICH_LINK[R].USER_ID},children:[m]})}else{if(w.RICH_LINK[R].CHAT_ID){m=d.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":w.RICH_LINK[R].CHAT_ID},children:[m]})}else{if(w.RICH_LINK[R].HTML){m=d.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},children:[d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.RICH_LINK[R].LINK),target:"_blank"},html:w.RICH_LINK[R].NAME?w.RICH_LINK[R].NAME:w.RICH_LINK[R].LINK})]})}T=d.create("div",{props:{className:"bx-messenger-attach-rich-link-source"},html:d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.RICH_LINK[R].LINK)}}).hostname})}}}var N=null;if(w.RICH_LINK[R].DESC){N=d.create("span",{props:{className:"bx-messenger-attach-rich-link-desc"},html:w.RICH_LINK[R].DESC})}var I=null;if(w.RICH_LINK[R].HTML){I=d.create("div",{props:{className:"bx-messenger-attach-rich-link-html"},html:w.RICH_LINK[R].HTML});var q=d.create("span",{props:{className:"bx-messenger-attach-rich-link"+(w.RICH_LINK[R].PREVIEW?" bx-messenger-attach-rich-link-with-preview":"")},children:[m,N,I]})}else{if(w.RICH_LINK[R].PREVIEW){I=d.create("span",{props:{className:"bx-messenger-file-image-src"},children:[d.create("img",{attrs:{src:d.util.htmlspecialcharsback(w.RICH_LINK[R].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}}),]});var q=d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.RICH_LINK[R].LINK),target:"_blank"},props:{className:"bx-messenger-file-image"},children:[I,d.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[m,N,T]})]})}else{var q=d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.RICH_LINK[R].LINK),target:"_blank"},props:{className:"bx-messenger-file-image bx-messenger-file-image-without-preview"},children:[d.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[m,N,T]})]})}}s.push(q)}K=d.create("span",{props:{className:"bx-messenger-attach-rich-links"},children:s})}else{if(w.MESSAGE&&w.MESSAGE.length>0){K=d.create("span",{props:{className:"bx-messenger-attach-message"},html:this.decodeBbCode(w.MESSAGE)})}else{if(w.HTML&&w.HTML.length>0){K=d.create("span",{props:{className:"bx-messenger-attach-message"},html:w.HTML})}else{if(w.GRID&&w.GRID.length>0){var n=[];for(var R=0;R<w.GRID.length;R++){var r=this.decodeBbCode(w.GRID[R].VALUE);if(w.GRID[R].USER_ID){r='<span class="bx-messenger-ajax '+(w.GRID[R].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+w.GRID[R].USER_ID+'">'+r+"</span>"}else{if(w.GRID[R].CHAT_ID){r='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+w.GRID[R].CHAT_ID+'">'+r+"</span>"}else{if(w.GRID[R].LINK){r='<a href="'+w.GRID[R].LINK+'" target="_blank">'+r+"</a>"}}}var e=w.GRID[R].WIDTH?"width: "+w.GRID[R].WIDTH+"px":"";var h=w.GRID[R].HEIGHT?"max-height: "+w.GRID[R].HEIGHT+"px;":"";var O=0;var H=null;var D=null;if(h){D=d.create("div",{props:{className:"bx-messenger-attach bx-messenger-attach-block-name"},attrs:{style:"position: absolute; left: -1000px;"+(w.GRID[R].DISPLAY=="ROW"?e:"")},html:r});document.body.appendChild(D);if(w.GRID[R].HEIGHT>=D.offsetHeight){h=""}else{O=D.offsetHeight}d.remove(D)}if(h){H=d.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+(w.GRID[R].DISPLAY.toLowerCase())+" bx-messenger-attach-block-spoiler"},attrs:{style:w.GRID[R].DISPLAY=="LINE"?e:""},children:[d.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:w.GRID[R].DISPLAY=="ROW"?e:""},children:[d.create("span",{props:{className:"bx-messenger-attach-block-spoiler-name"},html:w.GRID[R].NAME}),d.create("span",{props:{className:"bx-messenger-attach-block-spoiler-icon"}})]}),d.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:h+(w.GRID[R].COLOR?"color: "+w.GRID[R].COLOR:""),"data-min-height":w.GRID[R].HEIGHT,"data-max-height":O},children:[d.create("span",{html:r})]})]})}else{H=d.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+(w.GRID[R].DISPLAY.toLowerCase())},attrs:{style:w.GRID[R].DISPLAY=="LINE"?e:""},children:[d.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:w.GRID[R].DISPLAY=="ROW"?e:""},html:w.GRID[R].NAME}),d.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:(w.GRID[R].COLOR?"color: "+w.GRID[R].COLOR:"")},html:r})]})}n.push(H)}K=d.create("span",{props:{className:"bx-messenger-attach-blocks"},children:n})}else{if(w.DELIMITER){var t="";if(w.DELIMITER.SIZE){t+="width: "+w.DELIMITER.SIZE+"px;"}if(w.DELIMITER.COLOR){t+="background-color: "+w.DELIMITER.COLOR}if(t){t={style:t}}K=d.create("span",{props:{className:"bx-messenger-attach-delimiter"},attrs:t})}else{if(w.IMAGE&&w.IMAGE.length>0){var J=[];for(var R=0;R<w.IMAGE.length;R++){if(!w.IMAGE[R].NAME){w.IMAGE[R].NAME=""}if(!w.IMAGE[R].PREVIEW){w.IMAGE[R].PREVIEW=w.IMAGE[R].LINK}var B=d.create("a",{props:{className:"bx-messenger-file-image-src"},attrs:{href:d.util.htmlspecialcharsback(w.IMAGE[R].LINK),target:"_blank",title:w.IMAGE[R].NAME},children:[d.create("img",{attrs:{src:d.util.htmlspecialcharsback(w.IMAGE[R].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-attach-image bx-messenger-file-image-link"}})]});J.push(B)}K=d.create("span",{props:{className:"bx-messenger-attach-images"},children:J})}else{if(w.FILE&&w.FILE.length>0){var z=[];for(var R=0;R<w.FILE.length;R++){var A=w.FILE[R].NAME?w.FILE[R].NAME:w.FILE[R].LINK;if(this.isMobile()){if(A.length>20){A=A.substr(0,7)+"..."+A.substr(A.length-10,A.length)}}else{if(A.length>43){A=A.substr(0,20)+"..."+A.substr(A.length-20,A.length)}}A=d.create("span",{attrs:{title:w.FILE[R].NAME},props:{className:"bx-messenger-file-title"},children:[d.create("span",{props:{className:"bx-messenger-file-title-name"},html:A})]});var L=d.create("div",{props:{className:"bx-messenger-file"},children:[d.create("div",{props:{className:"bx-messenger-file-attrs"},children:[d.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:d.util.htmlspecialcharsback(w.FILE[R].LINK),target:"_blank"},children:[A]}),w.FILE[R].SIZE?d.create("span",{props:{className:"bx-messenger-file-size"},html:d.UploaderUtils.getFormattedSize(w.FILE[R].SIZE)}):null]}),d.create("div",{props:{className:"bx-messenger-file-download"},children:[d.create("a",{attrs:{href:d.util.htmlspecialcharsback(w.FILE[R].LINK),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:d.message("IM_F_DOWNLOAD")})]})]});z.push(L)}K=d.create("span",{props:{className:"bx-messenger-attach-files"},children:z})}}}}}}}}}G.push(K)}if(G.length>0){l.push(d.create("div",{props:{className:"bx-messenger-attach"},attrs:{style:E=="transparent"?"border: 0; padding-left: 0;":"border-color: "+E},children:G}))}}return l};a.prototype.diskDrawFiles=function(l,w,t){if(!this.BXIM.disk.enable||!l||!w){return[]}var v=[];if(typeof(w)!="object"){v.push(w)}else{v=w}t=t||{};var g=true;var k=[];for(var q=0;q<v.length;q++){var u=this.BXIM.disk.files[l]&&this.BXIM.disk.files[l][v[q]];if(!u){var u={id:v[q],chatId:l};var e=t.boxId?t.boxId:"im-file";k.push(d.create("div",{attrs:{id:e+"-"+u.id,"data-chatId":u.chatId,"data-fileId":u.id,"data-boxId":e},props:{className:"bx-messenger-file"},children:[d.create("span",{props:{className:"bx-messenger-file-deleted"},html:d.message("IM_F_DELETED")})]}));continue}if(t.status){if(typeof(t.status)!="object"){t.status=[t.status]}if(!d.util.in_array(u.status,t.status)){continue}}var m=null;if(u.preview||u.urlPreview){var h=null;if(u.preview&&typeof(u.preview)!="string"){h=u.preview;if(u.urlPreview){u.preview=""}}else{h=d.create("img",{attrs:{src:this.formatUrl(u.urlPreview?u.urlPreview:u.preview),height:u.image?(u.image.height>400?"400":u.image.height):"auto"},props:{className:"bx-messenger-file-image-text bx-messenger-file-image-type-"+u.type},events:{load:function(){this.parentNode.style.background="#fff";this.removeAttribute("height")}}})}if(g){var r=null;if(u.type=="video"){if(this.isMobile()){r=d.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[d.create("div",{events:{click:d.delegate(function(i){d.localStorage.set("impmh",true,1);app.openDocument({url:this.formatUrl(u.urlDownload),filename:u.name.toString().toLowerCase()});return d.PreventDefault(i)},this)},props:{className:"bx-messenger-file-image-type-video-button-play"}})]})}else{r=d.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[d.create("div",{props:{className:"bx-messenger-file-image-type-video-button-download-1"}}),d.create("div",{props:{className:"bx-messenger-file-image-type-video-button-download-2"}})]})}}if(u.type=="video"&&u.urlDownload||u.type!="video"&&u.urlPreview&&u.urlShow){if(this.isMobile()){m=d.create("div",{props:{className:"bx-messenger-file-preview"},children:[d.create("span",{props:{className:"bx-messenger-file-image"},children:[d.create("span",{events:{click:d.delegate(function(){var z=this.BXIM.disk.files[l][w];var i=d.findParent(d.proxy_context,{className:"bx-messenger-content-item"});if(i&&i.getAttribute("data-messageid").indexOf("temp")==0){return false}if(z.type=="image"){this.BXIM.messenger.openPhotoGallery(z.urlShow)}else{if(z.type=="video"){d.localStorage.set("impmh",true,1);app.openDocument({url:z.urlShow,filename:z.name.toString().toLowerCase()})}}},this)},attrs:{"data-chatId":u.chatId,"data-diskId":u.id},props:{className:"bx-messenger-file-image-src"},children:[r,h]})]})]})}else{m=d.create("div",{props:{className:"bx-messenger-file-preview"},children:[d.create("span",{props:{className:"bx-messenger-file-image"},children:[d.create("a",{attrs:{href:this.formatUrl(u.urlShow),target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[r,h]})]}),]})}}else{m=d.create("div",{props:{className:"bx-messenger-file-preview"},children:[d.create("span",{props:{className:"bx-messenger-file-image"},children:[d.create("span",{props:{className:"bx-messenger-file-image-src"},children:[h]})]}),]})}}else{m=d.create("div",{props:{className:"bx-messenger-file-preview"},children:[d.create("span",{props:{className:"bx-messenger-file-image"},children:[d.create("span",{props:{className:"bx-messenger-file-image-src"},children:[h]})]}),]})}}var x=u.name;if(this.isMobile()){if(x.length>20){x=x.substr(0,7)+"..."+x.substr(x.length-10,x.length)}}else{if(x.length>43){x=x.substr(0,20)+"..."+x.substr(x.length-20,x.length)}}var y=d.create("span",{attrs:{title:u.name},props:{className:"bx-messenger-file-title"},children:[d.create("span",{props:{className:"bx-messenger-file-title-name"},html:x})]});if(g&&(u.urlShow||u.urlDownload)){if(this.isMobile()){y=d.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){d.localStorage.set("impmh",true,1);app.openDocument({url:u.urlDownload,filename:u.name.toString().toLowerCase()})}},children:[y]})}else{y=d.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:this.formatUrl(u.urlShow?u.urlShow:u.urlDownload),target:"_blank"},children:[y]})}}y=d.create("div",{props:{className:"bx-messenger-file-attrs"},children:[y,d.create("span",{props:{className:"bx-messenger-file-size"},html:d.UploaderUtils.getFormattedSize(u.size)}),]});var p=null;if(u.status=="done"){if(!this.isMobile()){p=d.create("div",{props:{className:"bx-messenger-file-download"},children:[!u.urlDownload||!g?null:d.create("a",{attrs:{href:this.formatUrl(u.urlDownload),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:d.message("IM_F_DOWNLOAD")}),!u.urlDownload||!this.BXIM.disk.enable||this.BXIM.context=="LINES"?null:d.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:d.message("IM_F_DOWNLOAD_DISK"),events:{click:d.delegate(function(){var z=d.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var i=d.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var A=d.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(z,i,{boxId:A})},this)}})]})}else{p=d.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else{if(u.status=="upload"){var f={};var j="";var o=null;var n="";var s="";if(u.authorId==this.BXIM.userId&&u.progress>=0){s=d.message("IM_F_UPLOAD_2").replace("#PERCENT#",u.progress);f={width:u.progress+"%"};o=d.create("span",{attrs:{title:d.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{s=d.message("IM_F_UPLOAD");n=" bx-messenger-file-progress-infinite"}p=d.create("div",{props:{className:"bx-messenger-progress-box"},children:[d.create("span",{attrs:{title:s},props:{className:"bx-messenger-file-progress"},children:[d.create("span",{props:{className:"bx-messenger-file-progress-line"+n},style:f})]}),o]})}else{if(u.status=="error"){p=d.create("span",{props:{className:"bx-messenger-file-status-error"},html:u.errorText?u.errorText:d.message("IM_F_ERROR")})}}}if(!p){return false}if(v.length==1&&t.showInner=="Y"){k=[m,y,p]}else{var e=t.boxId?t.boxId:"im-file";k.push(d.create("div",{attrs:{id:e+"-"+u.id,"data-chatId":u.chatId,"data-fileId":u.id,"data-boxId":e},props:{className:"bx-messenger-file"},children:[m,y,p]}))}}return k};a.prototype.diskRedrawFile=function(h,f,j){j=j||{};var i=j.boxId?j.boxId:"im-file";var g=d(i+"-"+f);if(g){var e=this.diskDrawFiles(h,f,{showInner:"Y",boxId:i});if(e){g.innerHTML="";d.adjust(g,{children:e})}}};a.prototype.diskChatDialogFileInited=function(h,f,g){g.messageText=g.messageText||"";var e=g.form.CHAT_ID.value;if(!this.BXIM.disk.files[e]){this.BXIM.disk.files[e]={}}this.BXIM.disk.files[e][h]={id:h,tempId:h,chatId:e,date:new Date(),type:f.isImage?"image":"file",preview:f.isImage?f.canvas:"",name:f.name,size:f.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};if(!this.BXIM.disk.filesRegister[e]){this.BXIM.disk.filesRegister[e]={}}this.BXIM.disk.filesRegister[e][h]={id:h,type:this.BXIM.disk.files[e][h].type,mimeType:f.file.type,name:this.BXIM.disk.files[e][h].name,size:this.BXIM.disk.files[e][h].size};this.diskChatDialogFileRegister(e,g.messageText)};a.prototype.diskChatDialogFileRegister=function(e,f){f=f||"";clearTimeout(this.BXIM.disk.timeout[e]);this.BXIM.disk.timeout[e]=setTimeout(d.delegate(function(){var j=0;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].type!="private"){j="chat"+e}else{for(var h in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[h]==e){j=h;break}}}if(!j){return false}var g="N";if(j.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[e]){g="Y"}var i=[];for(var l in this.BXIM.disk.filesRegister[e]){i.push(l)}var k="tempFile"+this.BXIM.disk.fileTmpId;this.BXIM.messenger.message[k]={id:k,chatId:e,senderId:this.BXIM.userId,recipientId:j,date:new Date(),text:d.MessengerCommon.prepareText(f,true),params:{FILE_ID:i,CLASS:g=="Y"?"bx-messenger-content-item-system":""}};if(!this.BXIM.messenger.showMessage[j]){this.BXIM.messenger.showMessage[j]=[]}this.BXIM.messenger.showMessage[j].push(k);d.MessengerCommon.drawMessage(j,this.BXIM.messenger.message[k]);d.MessengerCommon.drawProgessMessage(k);this.recentListAdd({id:k,date:new Date(),skipDateCheck:true,recipientId:j,senderId:this.BXIM.userId,text:f?f:"["+d.message("IM_F_FILE")+"]",userId:j,userIsChat:j.toString().substr(0,4)=="chat",params:{}},true);this.BXIM.messenger.sendMessageFlag++;this.BXIM.messenger.popupMessengerFileFormInput.setAttribute("disabled",true);this.BXIM.disk.OldBeforeUnload=b.onbeforeunload;b.onbeforeunload=function(){if(typeof(d.PULL)!="undefined"&&typeof(d.PULL.tryConnectDelay)=="function"){d.PULL.tryConnectDelay()}return d.message("IM_F_EFP")};d.ajax({url:this.BXIM.pathToFileAjax+"?FILE_REGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_REGISTER:"Y",CHAT_ID:e,RECIPIENT_ID:j,TEXT:f,MESSAGE_TMP_ID:k,FILES:JSON.stringify(this.BXIM.disk.filesRegister[e]),OL_SILENT:g,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(p){if(p.ERROR!=""){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[k];d.MessengerCommon.drawTab(j);b.onbeforeunload=this.BXIM.disk.OldBeforeUnload;this.BXIM.disk.filesRegister[e]={};if(this.BXIM.disk.formAgents.imDialog["clear"]){this.BXIM.disk.formAgents.imDialog.clear()}return false}this.BXIM.messenger.sendMessageFlag--;var o=[];var w={};for(var m in p.FILE_ID){var s=p.FILE_ID[m];delete this.BXIM.disk.filesRegister[p.CHAT_ID][s.TMP_ID];if(parseInt(s.FILE_ID)>0){w[s.TMP_ID]=s.FILE_ID;this.BXIM.disk.filesProgress[s.TMP_ID]=s.FILE_ID;this.BXIM.disk.filesMessage[s.TMP_ID]=p.MESSAGE_ID;this.BXIM.disk.files[p.CHAT_ID][s.FILE_ID]={};for(var v in this.BXIM.disk.files[p.CHAT_ID][s.TMP_ID]){this.BXIM.disk.files[p.CHAT_ID][s.FILE_ID][v]=this.BXIM.disk.files[p.CHAT_ID][s.TMP_ID][v]}this.BXIM.disk.files[p.CHAT_ID][s.FILE_ID]["id"]=s.FILE_ID;delete this.BXIM.disk.files[p.CHAT_ID][s.TMP_ID];this.BXIM.disk.files[p.CHAT_ID][s.FILE_ID]["name"]=s.FILE_NAME;if(d("im-file-"+s.TMP_ID)){d("im-file-"+s.TMP_ID).setAttribute("data-fileId",s.FILE_ID);d("im-file-"+s.TMP_ID).id="im-file-"+s.FILE_ID;d.MessengerCommon.diskRedrawFile(p.CHAT_ID,s.FILE_ID)}o.push(s.FILE_ID)}else{this.BXIM.disk.files[p.CHAT_ID][s.TMP_ID]["status"]="error";d.MessengerCommon.diskRedrawFile(p.CHAT_ID,s.TMP_ID)}}this.BXIM.messenger.message[p.MESSAGE_ID]=d.clone(this.BXIM.messenger.message[p.MESSAGE_TMP_ID]);this.BXIM.messenger.message[p.MESSAGE_ID]["id"]=p.MESSAGE_ID;this.BXIM.messenger.message[p.MESSAGE_ID]["params"]["FILE_ID"]=o;if(p.MESSAGE_TEXT){this.BXIM.messenger.message[p.MESSAGE_ID]["text"]=p.MESSAGE_TEXT}if(this.BXIM.messenger.popupMessengerLastMessage==p.MESSAGE_TMP_ID){this.BXIM.messenger.popupMessengerLastMessage=p.MESSAGE_ID}delete this.BXIM.messenger.message[p.MESSAGE_TMP_ID];var t=d.util.array_search(""+p.MESSAGE_TMP_ID+"",this.BXIM.messenger.showMessage[p.RECIPIENT_ID]);if(this.BXIM.messenger.showMessage[p.RECIPIENT_ID][t]){this.BXIM.messenger.showMessage[p.RECIPIENT_ID][t]=""+p.MESSAGE_ID+""}if(d("im-message-"+p.MESSAGE_TMP_ID)){if(p.MESSAGE_TEXT){d("im-message-"+p.MESSAGE_TMP_ID).innerHTML=p.MESSAGE_TEXT}d("im-message-"+p.MESSAGE_TMP_ID).id="im-message-"+p.MESSAGE_ID;var q=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+p.MESSAGE_TMP_ID}},true);if(q){q.setAttribute("data-messageid",""+p.MESSAGE_ID+"");if(q.getAttribute("data-blockmessageid")==""+p.MESSAGE_TMP_ID){q.setAttribute("data-blockmessageid",""+p.MESSAGE_ID+"")}}else{var u=d.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+p.MESSAGE_TMP_ID}},true);if(u){u.setAttribute("data-blockmessageid",""+p.MESSAGE_ID+"")}}var n=d.findChildByClassName(q,"bx-messenger-content-item-date");if(n){n.innerHTML=d.MessengerCommon.formatDate(this.BXIM.messenger.message[p.MESSAGE_ID].date,d.MessengerCommon.getDateFormatType("MESSAGE"))}}d.MessengerCommon.clearProgessMessage(p.MESSAGE_ID);if(this.BXIM.messenger.history[p.RECIPIENT_ID]){this.BXIM.messenger.history[p.RECIPIENT_ID].push(p.MESSAGE_ID)}else{this.BXIM.messenger.history[p.RECIPIENT_ID]=[p.MESSAGE_ID]}var r="N";if(p.RECIPIENT_ID.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[p.CHAT_ID]){r="Y"}this.BXIM.messenger.popupMessengerFileFormRegChatId.value=p.CHAT_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=p.MESSAGE_ID;this.BXIM.messenger.popupMessengerFileFormRegMessageHidden.value=r;this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify(w);this.BXIM.disk.formAgents.imDialog.submit();this.BXIM.messenger.popupMessengerFileFormInput.removeAttribute("disabled")},this),onfailure:d.delegate(function(){this.BXIM.messenger.sendMessageFlag--;delete this.BXIM.messenger.message[k];this.BXIM.disk.filesRegister[e]={};d.MessengerCommon.drawTab(j);b.onbeforeunload=this.BXIM.disk.OldBeforeUnload;if(this.BXIM.disk.formAgents.imDialog["clear"]){this.BXIM.disk.formAgents.imDialog.clear()}},this)});this.BXIM.disk.fileTmpId++},this),500)};a.prototype.diskChatDialogFileStart=function(f,i,g,j){var e=this.BXIM.disk.filesProgress[f.id];var h=g.streams.packages.getItem(j).data;if(!this.BXIM.disk.files[h.REG_CHAT_ID][e]){return false}this.BXIM.disk.files[h.REG_CHAT_ID][e].progress=parseInt(i);d.MessengerCommon.diskRedrawFile(h.REG_CHAT_ID,e)};a.prototype.diskChatDialogFileProgress=function(f,i,g,j){var e=this.BXIM.disk.filesProgress[f.id];var h=g.streams.packages.getItem(j).data;if(!this.BXIM.disk.files[h.REG_CHAT_ID][e]){return false}this.BXIM.disk.files[h.REG_CHAT_ID][e].progress=parseInt(i);d.MessengerCommon.diskRedrawFile(h.REG_CHAT_ID,e)};a.prototype.diskChatDialogFileDone=function(e,f,g,h){if(!this.BXIM.disk.files[f.file.fileChatId][f.file.fileId]){return false}if(this.BXIM.disk.files[f.file.fileChatId]&&this.BXIM.disk.files[f.file.fileChatId][f.file.fileId]){f.file.fileParams.preview=this.BXIM.disk.files[f.file.fileChatId][f.file.fileId]["preview"]}if(!this.BXIM.disk.files[f.file.fileChatId]){this.BXIM.disk.files[f.file.fileChatId]={}}f.file.fileParams.date=new Date(f.file.fileParams.date);this.BXIM.disk.files[f.file.fileChatId][f.file.fileId]=f.file.fileParams;d.MessengerCommon.diskRedrawFile(f.file.fileChatId,f.file.fileId);delete this.BXIM.disk.filesMessage[f.file.fileTmpId];b.onbeforeunload=this.BXIM.disk.OldBeforeUnload};a.prototype.diskChatDialogFileError=function(i,f,g,j){var e=this.BXIM.disk.filesProgress[i.id];var h=g.streams.packages.getItem(j).data;if(!this.BXIM.disk.files[h.REG_CHAT_ID][e]){return false}i.deleteFile();this.BXIM.disk.files[h.REG_CHAT_ID][e].status="error";this.BXIM.disk.files[h.REG_CHAT_ID][e].errorText=f.error;d.MessengerCommon.diskRedrawFile(h.REG_CHAT_ID,e);b.onbeforeunload=this.BXIM.disk.OldBeforeUnload};a.prototype.diskChatDialogUploadError=function(i,h,g){var f=i.post.REG_PARAMS?JSON.parse(i.post.REG_PARAMS):{};var e={};for(var j in f){if(this.BXIM.disk.filesMessage[j]){delete this.BXIM.disk.filesMessage[j]}if(this.BXIM.disk.filesRegister[i.post.REG_CHAT_ID]){delete this.BXIM.disk.filesRegister[i.post.REG_CHAT_ID][j];delete this.BXIM.disk.filesRegister[i.post.REG_CHAT_ID][f[j]]}if(this.BXIM.disk.files[i.post.REG_CHAT_ID]){if(this.BXIM.disk.files[i.post.REG_CHAT_ID][f[j]]){this.BXIM.disk.files[i.post.REG_CHAT_ID][f[j]].status="error";d.MessengerCommon.diskRedrawFile(i.post.REG_CHAT_ID,f[j])}if(this.BXIM.disk.files[i.post.REG_CHAT_ID][j]){this.BXIM.disk.files[i.post.REG_CHAT_ID][j].status="error";d.MessengerCommon.diskRedrawFile(i.post.REG_CHAT_ID,j)}}delete this.BXIM.disk.filesProgress[j]}d.ajax({url:this.BXIM.pathToFileAjax+"?FILE_UNREGISTER&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_FILE_UNREGISTER:"Y",CHAT_ID:i.post.REG_CHAT_ID,FILES:i.post.REG_PARAMS,MESSAGES:JSON.stringify(e),IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()}});b.onbeforeunload=this.BXIM.disk.OldBeforeUnload;d.MessengerCommon.drawTab(this.getRecipientByChatId(i.post.REG_CHAT_ID))};a.prototype.phoneCheckDesktop=function(f){f=f===true;var e=new d.Promise();if(f&&this.isMobile()){e.resolve();return e}d.desktopUtils.runningCheck(function(){e.reject()},function(){e.resolve()});return e};a.prototype.pullPhoneEvent=function(){if(this.BXIM.options.frameMode){return false}var e=d.delegate(function(j,i){if(this.isMobile()){i=j.params;j=j.command;console.info("pull info: ",j,i)}if(j=="invite"){if(this.isMobile()&&i.PULL_TIME_AGO&&i.PULL_TIME_AGO>30){return false}if(!this.BXIM.webrtc.phoneSupport()){return false}if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive){return false}if(d.localStorage.get("viInitedCall")||d.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop(true).then(function(){if(i.CRM&&i.CRM.FOUND){this.BXIM.webrtc.phoneCrm=i.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.phonePortalCall=i.portalCall?true:false;if(this.BXIM.webrtc.phonePortalCall&&i.portalCallData){for(var k in i.portalCallData.users){i.portalCallData.users[k].last_activity_date=new Date(i.portalCallData.users[k].last_activity_date);i.portalCallData.users[k].mobile_last_date=new Date(i.portalCallData.users[k].mobile_last_date);i.portalCallData.users[k].idle=i.portalCallData.users[k].idle?new Date(i.portalCallData.users[k].idle):false;i.portalCallData.users[k].absent=i.portalCallData.users[k].absent?new Date(i.portalCallData.users[k].absent):false;this.BXIM.messenger.users[k]=i.portalCallData.users[k]}for(var k in i.portalCallData.hrphoto){this.BXIM.messenger.hrphoto[k]=i.portalCallData.hrphoto[k]}i.callerId=this.BXIM.messenger.users[i.portalCallUserId].name;i.phoneNumber="";if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:i.portalCallData.users[i.portalCallUserId].name,PHOTO:i.portalCallData.users[i.portalCallUserId].avatar}}}this.BXIM.webrtc.phoneCallConfig=i.config?i.config:{};this.BXIM.webrtc.phoneCallTime=0;this.BXIM.repeatSound("ringtone",5000);if(this.isPage()){d.MessengerWindow.changeTab("im")}d.MessengerCommon.phoneCommand("wait",{CALL_ID:i.callId,DEBUG_INFO:this.getDebugInfo()});this.BXIM.webrtc.phoneIncomingWait({chatId:i.chatId,callId:i.callId,callerId:i.callerId,lineNumber:i.lineNumber,companyPhoneNumber:i.phoneNumber,isCallback:i.isCallback,showCrmCard:i.showCrmCard,crmEntityType:i.crmEntityType,crmEntityId:i.crmEntityId,crmActivityId:i.crmActivityId,crmActivityEditUrl:i.crmActivityEditUrl,portalCall:i.portalCall,portalCallUserId:i.portalCallUserId,portalCallData:i.portalCallData,config:i.config})}.bind(this))}else{if(j=="answer_self"){if(this.BXIM.webrtc.callSelfDisabled||this.BXIM.webrtc.phoneCallId!=i.callId){return false}this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.isMobile()){this.BXIM.webrtc.callOverlayClose()}else{this.BXIM.webrtc.phoneCallView.close()}this.BXIM.webrtc.callInit=true;this.BXIM.webrtc.phoneCallId=i.callId}else{if(j=="timeout"){if(this.BXIM.webrtc.phoneCallId!=i.callId){return false}clearInterval(this.BXIM.webrtc.phoneConnectedInterval);d.localStorage.remove("viInitedCall");var h=this.BXIM.webrtc.phoneCallExternal;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;var g=this.BXIM.webrtc.phoneNumber;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle,{failedCode:i.failedCode})}if(h&&i.failedCode==486){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayStatus(d.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.callOverlayState(d.MobileCallUI.form.state.CALLBACK)}else{if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("offline");this.BXIM.webrtc.phoneCallView.setStatusText(d.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.sipPhoneError)}}}else{if(h&&i.failedCode==480){if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(d.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.callOverlayState(d.MobileCallUI.form.state.FINISHED)}else{if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("error");this.BXIM.webrtc.phoneCallView.setStatusText(d.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.sipPhoneError)}}}else{if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("error");this.BXIM.webrtc.callOverlayStatus(d.message("IM_PHONE_DECLINE"));this.BXIM.webrtc.callOverlayState(d.MobileCallUI.form.state.FINISHED)}else{if(this.BXIM.webrtc.phoneCallView){if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setStatusText("");this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(d.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}}}}else{if(j=="outgoing"){if(this.isMobile()&&i.PULL_TIME_AGO&&i.PULL_TIME_AGO>30){return false}if(!this.BXIM.webrtc.phoneCallView){return false}this.phoneCheckDesktop(true).then(function(){this.BXIM.webrtc.phoneCallDevice=i.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=i.portalCall?true:false;if(this.BXIM.webrtc.callInit&&(this.BXIM.webrtc.phoneNumber==i.phoneNumber||i.phoneNumber.indexOf(this.BXIM.webrtc.phoneNumber)>=0)){this.BXIM.webrtc.phoneNumber=i.phoneNumber;if(i.external&&this.BXIM.webrtc.phoneCallId==i.callIdTmp||!this.BXIM.webrtc.phoneCallId){this.BXIM.webrtc.phoneCallExternal=i.external?true:false;if(this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setProgress("connect");this.BXIM.webrtc.phoneCallView.setStatusText(d.message("IM_PHONE_WAIT_ANSWER"))}this.BXIM.webrtc.phoneCallConfig=i.config?i.config:{};this.BXIM.webrtc.phoneCallId=i.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCrm=i.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else{if(this.BXIM.webrtc.phoneCallView){if(i.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmData(i.CRM);this.BXIM.webrtc.phoneCallView.setCrmEntity({type:i.crmEntityType,id:i.crmEntityId,activityId:i.crmActivityId,activityEditUrl:i.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.setConfig(i.config);this.BXIM.webrtc.phoneCallView.setCallId(i.callId);if(i.lineNumber){this.BXIM.webrtc.phoneCallView.setLineNumber(i.lineNumber)}if(i.lineName){this.BXIM.webrtc.phoneCallView.setCompanyPhoneNumber(i.lineName)}this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}if(this.BXIM.webrtc.phonePortalCall&&this.BXIM.messenger.users[i.portalCallUserId]){if(this.isMobile()){this.BXIM.webrtc.phoneCrm.FOUND="Y";this.BXIM.webrtc.phoneCrm.CONTACT={NAME:i.portalCallData.users[i.portalCallUserId].name,PHOTO:i.portalCallData.users[i.portalCallUserId].avatar}}else{if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setPortalCall(true);this.BXIM.webrtc.phoneCallView.setPortalCallData(i.portalCallData);this.BXIM.webrtc.phoneCallView.setPortalCallUserId(i.portalCallUserId)}}}}else{if(!this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallId=i.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCallConfig=i.config?i.config:{};this.BXIM.webrtc.phoneCrm=i.CRM;this.BXIM.webrtc.phoneDisplayExternal({callId:i.callId,config:i.config?i.config:{},phoneNumber:i.phoneNumber,portalCall:i.portalCall,portalCallUserId:i.portalCallUserId,portalCallData:i.portalCallData,showCrmCard:i.showCrmCard,crmEntityType:i.crmEntityType,crmEntityId:i.crmEntityId})}}}.bind(this))}else{if(j=="start"){if(this.BXIM.webrtc.phoneCallId!=i.callId){return false}this.BXIM.webrtc.callOverlayTimer("start");this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.webrtc.phoneCallId==i.callId&&this.BXIM.webrtc.phoneCallDevice=="PHONE"&&(this.BXIM.webrtc.phoneCallDevice==i.callDevice||this.BXIM.webrtc.phonePortalCall)){this.BXIM.webrtc.phoneOnCallConnected()}else{if(this.BXIM.webrtc.phoneCallId==i.callId&&i.callDevice=="PHONE"&&this.BXIM.webrtc.phoneIncoming){this.BXIM.webrtc.phoneCallDevice="PHONE";if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneOnCallConnected()}}if(i.CRM){this.BXIM.webrtc.phoneCrm=i.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}if(this.BXIM.webrtc.phoneNumber!=""){this.BXIM.webrtc.phoneNumberLast=this.BXIM.webrtc.phoneNumber;this.BXIM.setLocalConfig("phone_last",this.BXIM.webrtc.phoneNumber)}}else{if(j=="hold"||j=="unhold"){if(this.BXIM.webrtc.phoneCallId==i.callId){this.BXIM.webrtc.phoneHolded=j=="hold"}}else{if(j=="update_crm"){if(this.BXIM.webrtc.phoneCallId==i.callId&&i.CRM&&i.CRM.FOUND){this.BXIM.webrtc.phoneCrm=i.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify){this.BXIM.webrtc.callNotify.adjustPosition()}}else{if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(i.CRM);if(i.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:i.crmEntityType,id:i.crmEntityId,activityId:i.crmActivityId,activityEditUrl:i.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}}else{if(j=="inviteTransfer"){if(this.isMobile()){return false}if(!this.BXIM.webrtc.phoneSupport()){return false}if(this.isMobile()&&i.PULL_TIME_AGO&&i.PULL_TIME_AGO>30){return false}if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive){return false}this.phoneCheckDesktop().then(function(){if(i.CRM&&i.CRM.FOUND){this.BXIM.webrtc.phoneCrm=i.CRM}this.BXIM.repeatSound("ringtone",5000);d.MessengerCommon.phoneCommand("waitTransfer",{CALL_ID:i.callId});this.BXIM.webrtc.phoneTransferEnabled=true;this.BXIM.webrtc.phoneIncomingWait({chatId:i.chatId,callId:i.callId,callerId:i.callerId,lineNumber:i.phoneNumber,companyPhoneNumber:i.phoneNumber,showCrmCard:i.showCrmCard,crmEntityType:i.crmEntityType,crmEntityId:i.crmEntityId,crmActivityId:i.crmActivityId,crmActivityEditUrl:i.crmActivityEditUrl,config:i.config,})}.bind(this))}else{if(j=="cancelTransfer"||j=="timeoutTransfer"){if(this.BXIM.webrtc.phoneCallId==i.callId&&!this.BXIM.webrtc.callSelfDisabled){this.BXIM.webrtc.callInit=false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.isMobile()){this.BXIM.webrtc.callOverlayClose()}else{this.BXIM.webrtc.phoneCallView.setStatusText(d.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}else{if(j=="declineTransfer"){if(this.BXIM.webrtc.phoneCallId==i.callId){this.BXIM.webrtc.errorInviteTransfer()}}else{if(j=="completeTransfer"){if(this.BXIM.webrtc.phoneCallId==i.callId){if(i.transferUserId!=this.BXIM.userId||this.isMobile()){this.BXIM.webrtc.successInviteTransfer()}else{this.BXIM.webrtc.phoneTransferEnabled=false;d.localStorage.set("vite",false,1);if(i.callDevice=="PHONE"){this.BXIM.stopRepeatSound("ringtone");if(this.isMobile()){this.BXIM.messenger.openMessenger(this.BXIM.messenger.currentTab)}this.BXIM.webrtc.phoneCallDevice="PHONE";this.BXIM.webrtc.phoneOnCallConnected()}if(i.CRM){this.BXIM.webrtc.phoneCrm=i.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}}}}else{if(j=="phoneDeviceActive"){this.BXIM.webrtc.phoneDeviceActive=i.active=="Y"}else{if(j=="changeDefaultLineId"){this.BXIM.webrtc.phoneDefaultLineId=i.defaultLineId}else{if(j=="replaceCallerId"){var f=d.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",i.callerId);this.BXIM.webrtc.setCallOverlayTitle(f);if(i.CRM){this.BXIM.webrtc.phoneCrm=i.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm()}else{if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(i.CRM);if(i.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:i.crmEntityType,id:i.crmEntityId,activityId:i.crmActivityId,activityEditUrl:i.crmActivityEditUrl});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}}else{if(j=="showExternalCall"){if(this.isMobile()){return false}if(this.BXIM.webrtc.callInit||this.BXIM.webrtc.callActive){return false}if(d.localStorage.get("viInitedCall")||d.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop().then(function(){if(i.CRM&&i.CRM.FOUND){this.BXIM.webrtc.phoneCrm=i.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.showExternalCall({callId:i.callId,fromUserId:i.fromUserId,toUserId:i.toUserId,isCallback:i.isCallback,phoneNumber:i.phoneNumber,lineNumber:i.lineNumber,companyPhoneNumber:i.companyPhoneNumber,showCrmCard:i.showCrmCard,crmEntityType:i.crmEntityType,crmEntityId:i.crmEntityId,crmActivityId:i.crmActivityId,crmActivityEditUrl:i.crmActivityEditUrl,config:i.config,portalCall:i.portalCall,portalCallData:i.portalCallData,portalCallUserId:i.portalCallUserId})}.bind(this))}else{if(j=="hideExternalCall"){if(this.isMobile()){return false}if(this.BXIM.webrtc.callActive&&this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallId==i.callId){this.BXIM.webrtc.hideExternalCall()}}}}}}}}}}}}}}}}}},this);if(this.isMobile()){BXMobileApp.addCustomEvent("onPull-voximplant",e)}else{d.addCustomEvent("onPullEvent-voximplant",e)}};a.prototype.phoneCommand=function(h,g,f,e){if(!this.BXIM.webrtc.phoneSupport()){return false}f=f!=false;g=typeof(g)=="object"?g:{};d.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:f,data:{IM_PHONE:"Y",COMMAND:h,PARAMS:JSON.stringify(g),IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:function(i){if(d.type.isFunction(e)){e(i)}}});return true};a.prototype.phoneCorrect=function(e){e=d.util.trim(e.toString());if(e.substr(0,2)=="+8"&&e.length>10){e="008"+e.substr(2)}e=e.replace(/[^0-9#*;,]/g,"");if(e.substr(0,2)=="80"||e.substr(0,2)=="81"||e.substr(0,2)=="82"){}else{if(e.substr(0,2)=="00"&&e.length>=9){e=e.substr(2)}else{if(e.substr(0,3)=="011"&&e.length>=10){e=e.substr(3)}else{if(e.substr(0,1)=="8"&&e.length>=11){e="7"+e.substr(1)}else{if(e.substr(0,1)=="0"&&e.length>=8){e=e.substr(1)}}}}}return e};a.prototype.phoneOnIncomingCall=function(f){if(this.BXIM.webrtc.phoneCurrentCall){return false}var e={};if(this.isMobile()){e=d.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents}this.BXIM.webrtc.phoneCurrentCall=f.call;this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,d.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,d.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,d.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.answer()};a.prototype.phoneGetCallParams=function(){var e=d.type.isPlainObject(this.BXIM.webrtc.phoneParams)?d.clone(this.BXIM.webrtc.phoneParams):{};if(this.BXIM.webrtc.phoneFullNumber!=this.BXIM.webrtc.phoneNumber){e.FULL_NUMBER=this.BXIM.webrtc.phoneFullNumber}return JSON.stringify(e)};a.prototype.phoneCallStart=function(){this.BXIM.webrtc.phoneParams.CALLER_ID="";this.BXIM.webrtc.phoneParams.USER_ID=this.BXIM.userId;this.BXIM.webrtc.phoneLog("Call params: ",this.BXIM.webrtc.phoneNumber,this.BXIM.webrtc.phoneParams);if(!this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneOnSDKReady();return false}if(!this.isMobile()&&false){this.BXIM.webrtc.phoneCurrentCall=true;this.BXIM.webrtc.callActive=true;this.BXIM.webrtc.phoneOnCallConnected();this.BXIM.webrtc.phoneCrm.FOUND="N";this.BXIM.webrtc.phoneCrm.CONTACT_URL="#";this.BXIM.webrtc.phoneCrm.LEAD_URL="#";this.BXIM.webrtc.callOverlayDrawCrm()}else{var e={};if(this.isMobile()){e=d.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents;this.BXIM.webrtc.phoneAPI.setOperatorACDStatus("ONLINE")}this.BXIM.webrtc.phoneCurrentCall=this.BXIM.webrtc.phoneAPI.call(this.BXIM.webrtc.phoneNumber,false,this.phoneGetCallParams());this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,d.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,d.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,d.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStart,d.delegate(this.BXIM.webrtc.phoneOnProgressToneStart,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStop,d.delegate(this.BXIM.webrtc.phoneOnProgressToneStop,this.BXIM.webrtc));if(this.isMobile()){this.BXIM.webrtc.phoneCurrentCall.start()}}d.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_INIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"init",NUMBER:this.BXIM.webrtc.phoneNumber,NUMBER_USER:d.util.htmlspecialcharsback(this.BXIM.webrtc.phoneNumberUser),IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(g){if(g.ERROR==""){if(!(g.HR_PHOTO.length==0)){for(var f in g.HR_PHOTO){this.BXIM.messenger.hrphoto[f]=g.HR_PHOTO[f]}this.BXIM.webrtc.callOverlayUserId=g.DIALOG_ID}else{this.BXIM.webrtc.callOverlayChatId=g.DIALOG_ID.substr(4)}}},this)})};a.prototype.phoneCallFinish=function(){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);d.localStorage.remove("viInitedCall");clearInterval(this.BXIM.webrtc.phoneCallTimeInterval);this.BXIM.webrtc.callOverlayTimer("pause");if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){d.MessengerCommon.phoneCommand("deviceHungup",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else{if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneTransferEnabled&&this.BXIM.webrtc.phoneTransferUser==0){d.MessengerCommon.phoneCommand("declineTransfer",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else{if(this.BXIM.webrtc.callInit&&this.BXIM.webrtc.phoneIncoming){d.MessengerCommon.phoneCommand("skip",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}}if(!this.isMobile()){this.BXIM.desktop.closeTopmostWindow()}if(this.BXIM.webrtc.phoneCurrentCall){try{this.BXIM.webrtc.phoneCurrentCall.hangup()}catch(f){}this.BXIM.webrtc.phoneCurrentCall=null;this.BXIM.webrtc.phoneLog("Call hangup call")}else{if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(d.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneAPI.disconnect()}},this),500)}}if(this.isMobile()){}else{if(this.BXIM.webrtc.popupKeyPad){this.BXIM.webrtc.popupKeyPad.close()}if(this.BXIM.webrtc.popupTransferDialog){this.BXIM.webrtc.popupTransferDialog.close()}d.localStorage.set("vite",false,1)}this.BXIM.webrtc.phoneRinging=0;this.BXIM.webrtc.phoneIncoming=false;this.BXIM.webrtc.phoneCallId="";this.BXIM.webrtc.phoneCallExternal=false;this.BXIM.webrtc.phoneCallDevice="WEBRTC";this.BXIM.webrtc.phoneNumber="";this.BXIM.webrtc.phoneNumberUser="";this.BXIM.webrtc.phoneParams={};this.BXIM.webrtc.callOverlayOptions={};this.BXIM.webrtc.callSelfDisabled=false;this.BXIM.webrtc.phoneMicMuted=false;this.BXIM.webrtc.phoneHolded=false;this.BXIM.webrtc.phoneMicAccess=false;this.BXIM.webrtc.phoneTransferUser=0;this.BXIM.webrtc.phoneTransferEnabled=false};a.prototype.phoneAuthorize=function(){d.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_AUTHORIZE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_PHONE:"Y",COMMAND:"authorize",UPDATE_INFO:this.BXIM.webrtc.phoneCheckBalance?"Y":"N",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(f){if(f&&f.BITRIX_SESSID){d.message({bitrix_sessid:f.BITRIX_SESSID})}if(f.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.webrtc.phoneCheckBalance=false;if(f.HR_PHOTO){for(var e in f.HR_PHOTO){this.BXIM.messenger.hrphoto[e]=f.HR_PHOTO[e]}}if(this.isMobile()){this.BXIM.webrtc.phoneLogin=f.LOGIN;this.BXIM.webrtc.phoneServer=f.SERVER;this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);d.MobileVoximplant.loginWithOneTimeKey(f.LOGIN+"@"+f.SERVER,f.HASH)}else{this.BXIM.webrtc.phoneLogin=f.LOGIN;this.BXIM.webrtc.phoneServer=f.SERVER}this.BXIM.webrtc.phoneCallerID=f.CALLERID;this.BXIM.webrtc.phoneApiInit()}else{if(f.ERROR=="AUTHORIZE_ERROR"&&(this.isDesktop()||this.isMobile())&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(function(){this.phoneAuthorize()},this),5000);d.onCustomEvent(b,"onImError",[f.ERROR])}else{if(f.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(d.delegate(function(){this.phoneAuthorize()},this),2000);d.onCustomEvent(b,"onImError",[f.ERROR,f.BITRIX_SESSID])}else{this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",f.ERROR,f.CODE);if(f.ERROR=="AUTHORIZE_ERROR"||f.ERROR=="SESSION_ERROR"){d.onCustomEvent(b,"onImError",[f.ERROR]);this.BXIM.webrtc.callAbort(d.message("IM_PHONE_401"))}else{this.BXIM.webrtc.callAbort(f.ERROR+(this.BXIM.webrtc.debug?"<br />("+d.message("IM_ERROR_CODE")+": "+f.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle)}}}}},this),onfailure:d.delegate(function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(d.message("IM_M_CALL_ERR"))},this)})};a.prototype.phoneOnAuthResult=function(f){if(f.result){if(this.BXIM.webrtc.phoneCallDevice=="PHONE"){return false}this.BXIM.webrtc.phoneLog("Authorize result","success");if(this.BXIM.webrtc.phoneIncoming){d.MessengerCommon.phoneCommand((this.BXIM.webrtc.phoneTransferEnabled?"readyTransfer":"ready"),{CALL_ID:this.BXIM.webrtc.phoneCallId})}else{if(this.BXIM.webrtc.callInitUserId==this.BXIM.userId){d.MessengerCommon.phoneCallStart()}}}else{if(!this.isMobile()&&f.code==302){d.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_ONETIMEKEY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"onetimekey",KEY:f.key,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(e){if(e.ERROR==""){this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);this.BXIM.webrtc.phoneAPI.loginWithOneTimeKey(this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer,e.HASH)}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("onetimekey",e.ERROR,e.CODE);if(e.CODE){this.BXIM.webrtc.callAbort(d.message("IM_PHONE_ERROR_CONNECT"))}else{this.BXIM.webrtc.callAbort(e.ERROR+(this.debug?"<br />("+d.message("IM_ERROR_CODE")+": "+e.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle)}}},this),onfailure:d.delegate(function(){this.BXIM.webrtc.callAbort(d.message("IM_M_CALL_ERR"));this.BXIM.webrtc.phoneCallFinish()},this)})}else{if(f.code==401||f.code==400||f.code==403||f.code==404||f.code==302){this.BXIM.webrtc.callAbort(d.message("IM_PHONE_401"));this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true;d.MessengerCommon.phoneCommand("authorize_error")}else{this.BXIM.webrtc.callAbort(d.message("IM_M_CALL_ERR"))}this.BXIM.webrtc.callOverlayProgress("offline");if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle)}this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("Authorize result","failed",f.code);this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin=""}}};a.prototype.phoneOnCallFailed=function(g){this.BXIM.webrtc.phoneLog("Call failed",g.code,g.reason);var f=d.message("IM_PHONE_END");if(g.code==603){f=d.message("IM_PHONE_DECLINE")}else{if(g.code==380){f=d.message("IM_PHONE_ERR_SIP_LICENSE")}else{if(g.code==436){f=d.message("IM_PHONE_ERR_NEED_RENT")}else{if(g.code==438){f=d.message("IM_PHONE_ERR_BLOCK_RENT")}else{if(g.code==400){f=d.message("IM_PHONE_ERR_LICENSE")}else{if(g.code==401){f=d.message("IM_PHONE_401")}else{if(g.code==480||g.code==503){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){f=d.message("IM_PHONE_NO_EMERGENCY")}else{f=d.message("IM_PHONE_UNAVAILABLE")}}else{if(g.code==484||g.code==404){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){f=d.message("IM_PHONE_NO_EMERGENCY")}else{f=d.message("IM_PHONE_INCOMPLETED")}}else{if(g.code==402){f=d.message("IM_PHONE_NO_MONEY")+(this.BXIM.isAdmin?" "+d.message("IM_PHONE_PAY_URL_NEW"):"")}else{if(g.code==486&&this.BXIM.webrtc.phoneRinging>1){f=d.message("IM_M_CALL_ST_DECLINE")}else{if(g.code==486){f=d.message("IM_PHONE_ERROR_BUSY")}else{if(g.code==403){f=d.message("IM_PHONE_403");this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true}}}}}}}}}}}}this.BXIM.webrtc.phoneCallFinish();if(g.code==408||g.code==403){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(d.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneAPI.disconnect()}},this),500)}}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(f);if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle)}};a.prototype.phoneOnCallDisconnected=function(f){this.BXIM.webrtc.phoneLog("Call disconnected",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.id():"-",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.state():"-");if(this.BXIM.webrtc.phoneCurrentCall){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayStatus(d.message("IM_M_CALL_ST_END"));if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayState(d.MobileCallUI.form.state.FINISHED)}else{this.BXIM.playSound("stop");this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle);if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(d.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(d.delegate(function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneAPI.disconnect()}},this),500)}};a.prototype.phoneOnProgressToneStart=function(f){if(!this.BXIM.webrtc.phoneCurrentCall){return false}this.BXIM.webrtc.phoneLog("Progress tone start",this.BXIM.webrtc.phoneCurrentCall.id());this.BXIM.webrtc.phoneRinging++;this.BXIM.webrtc.callOverlayStatus(d.message("IM_PHONE_WAIT_ANSWER"))};a.prototype.phoneOnProgressToneStop=function(f){if(!this.BXIM.webrtc.phoneCurrentCall){return false}this.BXIM.webrtc.phoneLog("Progress tone stop",this.BXIM.webrtc.phoneCurrentCall.id())};a.prototype.phoneOnConnectionEstablished=function(f){this.BXIM.webrtc.phoneLog("Connection established",this.BXIM.webrtc.phoneAPI.connected())};a.prototype.phoneOnConnectionFailed=function(f){this.BXIM.webrtc.phoneLog("Connection failed");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(d.message("IM_M_CALL_ERR"))};a.prototype.phoneOnConnectionClosed=function(f){this.BXIM.webrtc.phoneLog("Connection closed");this.BXIM.webrtc.phoneSDKinit=false};a.prototype.phoneOnMicResult=function(f){this.BXIM.webrtc.phoneMicAccess=f.result;this.BXIM.webrtc.phoneLog("Mic Access Allowed",f.result);if(!this.isMobile()){clearTimeout(this.BXIM.webrtc.callDialogAllowTimeout);if(this.BXIM.webrtc.callDialogAllow){this.BXIM.webrtc.callDialogAllow.close()}}if(f.result){this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(d.message("IM_M_CALL_ST_CONNECT"))}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(d.message("IM_M_CALL_ST_NO_ACCESS"));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(d.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(d.PhoneCallView.CallState.idle)}}};a.prototype.phoneOnNetStatsReceived=function(h){if(!this.BXIM.webrtc.phoneCurrentCall||this.BXIM.webrtc.phoneCurrentCall.state()!="CONNECTED"){return false}var f=(100-parseInt(h.stats.packetLoss));var g=this.BXIM.webrtc.callPhoneOverlayMeter(f);this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"meter",PACKETLOSS:h.stats.packetLoss,PERCENT:f,GRADE:g}))};a.prototype.phoneHold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){return false}this.BXIM.webrtc.phoneHolded=true;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{d.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};a.prototype.phoneUnhold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){return false}this.BXIM.webrtc.phoneHolded=false;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{d.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};a.prototype.phoneToggleHold=function(e){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){return false}if(typeof(e)!="undefined"){this.BXIM.webrtc.phoneHolded=!e}if(this.BXIM.webrtc.phoneHolded){if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{d.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}else{if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{d.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}this.BXIM.webrtc.phoneHolded=!this.BXIM.webrtc.phoneHolded};a.prototype.phoneSendDTMF=function(e){if(!this.BXIM.webrtc.phoneCurrentCall){return false}this.BXIM.webrtc.phoneLog("Send DTMF code",this.BXIM.webrtc.phoneCurrentCall.id(),e);this.BXIM.webrtc.phoneCurrentCall.sendTone(e)};a.prototype.phoneStartCallViaRestApp=function(f,e,g){d.rest.callMethod("voximplant.call.startViaRest",{NUMBER:f,LINE_ID:e,PARAMS:g,SHOW:"Y"})};a.prototype.phoneGetCallFields=function(g){if(!this.BXIM.messenger.chat[g]||this.BXIM.messenger.chat[g].type!="call"){return{crm:false}}var e=this.BXIM.messenger.chat[g];var f=e.entity_data_1.toString().split("|");if(f.length<3||f[0]!=="Y"){return{crm:false}}else{return{crm:true,crmEntityType:f[1],crmEntityId:f[2],crmShowUrl:this.BXIM.path.crm[f[1]].replace("#ID#",f[2])}}};a.prototype.getHrPhoto=function(f,e){var g="";if(f=="phone"){g="/bitrix/js/im/images/hidef-phone-v3.png"}else{if(this.BXIM.messenger.hrphoto[f]){g=this.BXIM.messenger.hrphoto[f];if(this.BXIM.messenger.hrphoto[f]!="/bitrix/js/im/images/hidef-avatar-v3.png"){e=""}}else{if(!this.BXIM.messenger.users[f]||this.BXIM.messenger.users[f].avatar==this.BXIM.pathToBlankImage){g="/bitrix/js/im/images/hidef-avatar-v3.png"}else{g=this.BXIM.messenger.users[f].avatar;e=""}}}return{src:g,color:e}};a.prototype.linesBodyScroll=function(){if(this.isMobile()&&document.body.offsetHeight<=b.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0;return false}if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null){this.BXIM.messenger.popupMessengerBodyAnimation.stop()}d.defer(function(){(this.BXIM.messenger.popupMessengerBodyAnimation=new d.easing({duration:600,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(d.MessengerCommon.isMobile()?0:1)},transition:d.easing.makeEaseInOut(d.easing.transitions.quart),step:d.delegate(function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll},this)})).animate()},this)()}else{d.defer(function(){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(d.MessengerCommon.isMobile()?0:1)},this)()}};a.prototype.linesGetSessionHistory=function(e){d.ajax({url:this.BXIM.pathToAjax+"?SESSION_GET_HISTORY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"sessionGetHistory",SESSION_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(g){if(g&&g.BITRIX_SESSID){d.message({bitrix_sessid:g.BITRIX_SESSID})}if(g.ERROR==""){for(var f in g.FILES){if(!this.BXIM.messenger.disk.files[g.CHAT_ID]){this.BXIM.messenger.disk.files[g.CHAT_ID]={}}if(this.BXIM.messenger.disk.files[g.CHAT_ID][f]){continue}g.FILES[f].date=new Date(g.FILES[f].date);this.BXIM.messenger.disk.files[g.CHAT_ID][f]=g.FILES[f]}this.BXIM.messenger.sendAjaxTry=0;for(var f in g.MESSAGE){g.MESSAGE[f].date=new Date(g.MESSAGE[f].date);this.BXIM.messenger.message[f]=g.MESSAGE[f]}for(var f in g.USERS){g.USERS[f].last_activity_date=new Date(g.USERS[f].last_activity_date);g.USERS[f].mobile_last_date=new Date(g.USERS[f].mobile_last_date);g.USERS[f].idle=g.USERS[f].idle?new Date(g.USERS[f].idle):false;g.USERS[f].absent=g.USERS[f].absent?new Date(g.USERS[f].absent):false;this.BXIM.messenger.users[f]=g.USERS[f]}for(var f in g.CHAT){if(!this.BXIM.messenger.chat[f]){g.CHAT[f].date_create=new Date(g.CHAT[f].date_create);this.BXIM.messenger.chat[f]=g.CHAT[f]}}this.BXIM.messenger.linesShowHistory(g.CHAT_ID,{HISTORY:g.USERS_MESSAGE,FILES:g.FILES,CAN_JOIN:g.CAN_JOIN,CAN_VOTE_HEAD:g.CAN_VOTE_HEAD,SESSION_VOTE_HEAD:g.SESSION_VOTE_HEAD,SESSION_ID:g.SESSION_ID})}else{if(g.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(g.ERROR)}else{if(g.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(function(){a.prototype.linesGetSessionHistory(sessionID)},1000);d.onCustomEvent(b,"onImError",[g.ERROR,g.BITRIX_SESSID])}else{if(g.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;d.onCustomEvent(b,"onImError",[g.ERROR])}}}}},this),onfailure:d.delegate(function(){this.BXIM.messenger.sendAjaxTry=0},this)})};a.prototype.linesJoinSession=function(e){d.ajax({url:this.BXIM.pathToAjax+"?JOIN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"joinSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesStartSession=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}d.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_CHAT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesStartSessionByMessage=function(e){if(!this.BXIM.messenger.message[e]||this.BXIM.userId!=this.BXIM.messenger.chat[this.BXIM.messenger.message[e].chatId].owner){return false}var f=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(f)){return false}this.BXIM.messenger.blockJoinChat[f]=true;d.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSessionByMessage",CHAT_ID:f,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this)})};a.prototype.linesOpenSession=function(f,e){e=e||{};d.ajax({url:this.BXIM.pathToAjax+"?OPEN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"openSession",USER_CODE:f,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(g){if(g.ERROR==""){if(e.SLIDER=="Y"){this.BXIM.messenger.openMessengerSlider("chat"+g.CHAT_ID,e)}else{this.BXIM.messenger.openMessenger("chat"+g.CHAT_ID,e)}}else{if(g.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(g.ERROR)}}},this)})};a.prototype.linesVoteDraw=function(h){if(!this.BXIM.messenger.message[h]||!this.BXIM.messenger.message[h].params||!this.BXIM.messenger.message[h].params.IMOL_VOTE){return null}var i=this.BXIM.messenger.message[h];var g=false;if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){var f=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.message[h].chatId]);if(!f){return null}if(!this.BXIM.messenger.users[this.BXIM.userId].connector&&!(f=="livechat"||f=="network")){return null}g=!this.BXIM.messenger.users[this.BXIM.userId].connector}else{if(!this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"){return null}}var j="";var e=false;if(i.params.IMOL_VOTE=="like"){e=true;j=i.params.IMOL_VOTE_LIKE}else{if(i.params.IMOL_VOTE=="dislike"){e=true;j=i.params.IMOL_VOTE_DISLIKE}else{j=i.params.IMOL_VOTE_TEXT}}return d.create("div",{attrs:{"data-messageId":h},props:{className:"bx-messenger-content-item-vote-block"+(e?" bx-messenger-content-item-vote-block-done":"")},children:[d.create("div",{props:{className:"bx-messenger-content-item-vote-block-text"},html:d.util.htmlspecialchars(j)}),d.create("div",{props:{className:"bx-messenger-content-item-vote-block-buttons"},children:[d.create("span",{attrs:{title:d.message("IM_OL_VOTE_LIKE")},props:{className:"bx-messenger-content-item-vote-block-like"+(g?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:g?function(){}:d.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,d.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"like")},this)}}),d.create("span",{attrs:{title:d.message("IM_OL_VOTE_DISLIKE")},props:{className:"bx-messenger-content-item-vote-block-dislike"+(g?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:g?function(){}:d.delegate(function(){this.linesVoteSend(this.BXIM.messenger.currentTab,d.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"dislike")},this)}})]}),d.create("div",{props:{className:"bx-messenger-content-item-vote-block-final"},children:[d.create("span",{props:{className:i.params.IMOL_VOTE=="dislike"?"bx-messenger-content-item-vote-block-smile-dislike":"bx-messenger-content-item-vote-block-smile-like"}})]})]})};a.prototype.linesVoteResultDraw=function(f,j){if(!this.BXIM.messenger.message[f]||!this.BXIM.messenger.message[f].params||!this.BXIM.messenger.message[f].params.IMOL_VOTE_SID){return j}var g=this.BXIM.messenger.message[f];var e="";if(typeof(g.params.IMOL_VOTE_USER)=="undefined"||g.params.IMOL_VOTE_USER==0){e=d.message("IM_OL_VOTE_WO")}else{if(g.params.IMOL_VOTE_USER==5){e='<span class="bx-smile bx-im-smile-like" title="'+d.message("IM_MESSAGE_LIKE")+'"></span>'}else{e='<span class="bx-smile bx-im-smile-dislike" title="'+d.message("IM_MESSAGE_DISLIKE")+'"></span>'}}var i=this.linesGetSession(this.BXIM.messenger.chat[g.chatId]);var h=this.linesVoteHeadNodes(g.params.IMOL_VOTE_SID,g.params.IMOL_VOTE_HEAD,i.canVoteHead);return d.create("div",{attrs:{"data-messageId":f},children:[d.create("div",{props:{className:"bx-messenger-content-item-vote-message-text"},html:j}),d.create("div",{props:{className:"bx-messenger-content-item-vote-result"},children:[d.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[d.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:d.message("IM_OL_VOTE_USER")+":"}),d.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},html:e})]}),d.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[d.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:d.message("IM_OL_VOTE_HEAD")+":"}),d.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[h]})]})]})]})};a.prototype.linesVoteSend=function(e,f,h){if(!this.BXIM.messenger.message[f]||!this.BXIM.messenger.message[f].params||!this.BXIM.messenger.message[f].params.IMOL_VOTE){return false}if((this.BXIM.messenger.message[f].date.getTime()/1000)+86400<(new Date().getTime())/1000){this.BXIM.openConfirm(d.message("IM_OL_VOTE_END"));return false}if(e.toString().substr(0,4)=="chat"){if(!this.BXIM.messenger.users[this.BXIM.userId].connector){return false}}else{if(!this.BXIM.messenger.bot[e]||this.BXIM.messenger.bot[e].type!="network"){return null}}this.BXIM.messenger.message[f].params.IMOL_VOTE=h;var g=d("im-message-"+f);if(g){g.innerHTML="";g.appendChild(this.linesVoteDraw(f))}d.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_LINES_VOTE_SEND:"Y",DIALOG_ID:e,MESSAGE_ID:f,RATING:h,IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){if(this.BXIM.messenger.popupMessengerLiveChatDelayedForm){clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(d.delegate(function(){this.BXIM.messenger.linesLivechatFormShow(this.BXIM.messenger.popupMessengerLiveChatDelayedForm);this.BXIM.messenger.popupMessengerLiveChatDelayedForm=null},this),1000)}},this)})};a.prototype.linesSaveToQuickAnswers=function(e,g){if(!this.BXIM.messenger.message[e]){return false}var f=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(f)){return false}this.BXIM.messenger.blockJoinChat[f]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_SAVE_TO_QUICK_ANSWERS&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"saveToQuickAnswers",CHAT_ID:f,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(h){this.BXIM.messenger.blockJoinChat[f]=false;if(g!==true){if(h.ERROR){this.BXIM.openConfirm(h.ERROR)}else{this.BXIM.openConfirm(d.message("IM_SAVE_TO_QUICK_ANSWERS_SUCCESS"));this.BXIM.messenger.message[e].quick_saved=true}}},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false;if(g!==true){this.BXIM.openConfirm(d.message("IM_SAVE_TO_QUICK_ANSWERS_ERROR"))}},this)})};a.prototype.linesVoteHeadNodes=function(i,f,h,e){f=f||0;h=h||false;var g=d.delegate(function(){var k=d.proxy_context.getAttribute("data-rating");var j=d.proxy_context.getAttribute("data-sessionId");d.proxy_context.parentNode.previousSibling.style.width=(k*20)+"%";if(e){e.setAttribute("data-rating",k)}this.linesVoteHeadSend(j,k);if(this.BXIM.messenger.popupTooltip){this.BXIM.messenger.popupTooltip.close()}},this);return d.create("div",{props:{className:"bx-lines-rating-box"},children:[d.create("div",{props:{className:"bx-lines-rating-box-current"},attrs:{style:"width:"+(f*20)+"%"}}),h?d.create("div",{props:{className:"bx-lines-rating-box-live"},children:[d.create("span",{attrs:{"data-rating":1,"data-sessionId":i},props:{className:"bx-lines-rating-box-item"},events:{click:g}}),d.create("span",{attrs:{"data-rating":2,"data-sessionId":i},props:{className:"bx-lines-rating-box-item"},events:{click:g}}),d.create("span",{attrs:{"data-rating":3,"data-sessionId":i},props:{className:"bx-lines-rating-box-item"},events:{click:g}}),d.create("span",{attrs:{"data-rating":4,"data-sessionId":i},props:{className:"bx-lines-rating-box-item"},events:{click:g}}),d.create("span",{attrs:{"data-rating":5,"data-sessionId":i},props:{className:"bx-lines-rating-box-item"},events:{click:g}})]}):null]})};a.prototype.linesVoteHeadSend=function(f,e){f=parseInt(f);e=parseInt(e);if(f<=0||e<=0||e>5){return false}d.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"voteHead",SESSION_ID:f,RATING:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},});return true};a.prototype.linesCanVoteAsHead=function(e){if(!this.BXIM.messenger.openlines||!this.BXIM.messenger.openlines.canVoteAsHead||!this.BXIM.messenger.openlines.canVoteAsHead[e]){return false}return true};a.prototype.linesGetCrmPath=function(f,e){if(!this.BXIM.path.crm[f]){return""}return this.BXIM.path.crm[f].replace("#ID#",e)};a.prototype.linesGetSession=function(e){var h=null;if(!e||e.type!="lines"){return h}h={};h.source=this.linesGetSource(e);var g=e.entity_id.toString().split("|");h.connector=g[0];h.lineId=g[1];h.canVoteHead=this.linesCanVoteAsHead(g[1]);var f=e.entity_data_1.toString().split("|");h.crm=typeof(f[0])!="undefined"&&f[0]=="Y"?"Y":"N";h.crmEntityType=typeof(f[1])!="undefined"?f[1]:"NONE";h.crmEntityId=typeof(f[2])!="undefined"?f[2]:0;h.crmLink="";h.pin=typeof(f[3])!="undefined"&&f[3]=="Y"?"Y":"N";h.wait=typeof(f[4])!="undefined"&&f[4]=="Y"?"Y":"N";h.id=typeof(f[5])!="undefined"?parseInt(f[5]):Math.round(new Date()/1000)+e.id;h.dateCreate=typeof(f[6])!="undefined"||f[6]>0?parseInt(f[6]):h.id;if(h.crmEntityType!="NONE"){h.crmLink=this.linesGetCrmPath(h.crmEntityType,h.crmEntityId)}return h};a.prototype.linesSetSession=function(e,g){var f=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="lines"){return f}f=this.linesGetSession(this.BXIM.messenger.chat[e]);if(typeof(g.crm)!="undefined"){f.crm=g.crm}if(typeof(g.crmEntityType)!="undefined"){f.crmEntityType=g.crmEntityType}if(typeof(g.crmEntityId)!="undefined"){f.crmEntityId=g.crmEntityId}if(typeof(g.pin)!="undefined"){f.pin=g.pin}if(typeof(g.wait)!="undefined"){f.wait=g.wait}if(typeof(g.id)!="undefined"){f.id=g.id}if(typeof(g.dateCreate)!="undefined"){f.dateCreate=g.dateCreate}this.BXIM.messenger.chat[e].entity_data_1=[f.crm,f.crmEntityType,f.crmEntityId,f.pin,f.wait,f.id,f.dateCreate].join("|");return f};a.prototype.livechatGetSession=function(e){var g=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="livechat"){return g}g={};var f=this.BXIM.messenger.chat[e].entity_data_1.toString().split("|");g.readed=typeof(f[0])!="undefined"&&f[0]=="Y"?"Y":"N";g.readedId=typeof(f[1])!="undefined"?f[1]:0;g.readedTime=typeof(f[2])!="undefined"?f[2]:false;g.sessionId=typeof(f[3])!="undefined"?f[3]:0;g.showForm=typeof(f[4])!="undefined"?f[4]:"Y";return g};a.prototype.linesGetSource=function(e){var f="";if(!e||!(e.type=="livechat"||e.type=="lines")){return f}if(e.type=="livechat"){f="livechat"}else{f=(e.entity_id.toString().split("|"))[0]}if(f=="skypebot"){f="skype"}else{f=f.replace(".","_")}return f};a.prototype.linesAnswer=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES"){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_ANSWER&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"answer",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesSkip=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(e)){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_SKIP&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"skip",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesActivateSilentMode=function(f,e,g){if(!g){return false}if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(f)){return false}e=e=="Y"?"Y":"";if(this.BXIM.messenger.chat[f].entity_data_3==e){return false}this.BXIM.messenger.blockJoinChat[f]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_SILENT_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"silentMode",ACTIVATE:e?"Y":"N",CHAT_ID:f,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false;this.BXIM.messenger.chat[f].entity_data_3=e},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this)})};a.prototype.linesActivatePinMode=function(f,e){if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(f)){return false}e=e=="Y"?"Y":"N";this.BXIM.messenger.blockJoinChat[f]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_PIN_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"pinMode",ACTIVATE:e,CHAT_ID:f,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false;d.MessengerCommon.linesSetSession(f,{pin:e})},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this)})};a.prototype.linesCloseDialog=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(e)){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.MessengerCommon.dialogCloseCurrent();d.ajax({url:this.BXIM.pathToAjax+"?LINES_CLOSE_DIALOG&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"closeDialog",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;d.MessengerCommon.linesSetSession(e,{wait:"Y"});this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesMarkAsSpam=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES"){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_MARK_SPAM&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"markSpam",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false;this.linesSetSession(e,{id:0,wait:"Y"});this.dialogCloseCurrent();this.BXIM.messenger.redrawChatHeader({userRedraw:false})},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesInterceptSession=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES"){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_INTERCEPT_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"interceptSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesCreateLead=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(e)){return false}var f=this.linesGetSession(this.BXIM.messenger.chat[e]);if(f.crm=="Y"){return false}this.BXIM.messenger.blockJoinChat[e]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_CREATE_LEAD&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"createLead",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[e]=false},this)})};a.prototype.linesChangeCrmEntity=function(e){if(!this.BXIM.messenger.message[e]){return false}var f=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(f)){return false}var g=this.linesGetSession(this.BXIM.messenger.chat[f]);if(g.crm=="N"){return false}this.linesChangeCrmEntityMessageId=e;if(b.obCrm&&b.obCrm.olCrmSelector){b.obCrm.olCrmSelector.Open()}else{d.ajax({url:BXIM.pathToAjax+"?CRM_SELECTOR&V="+BXIM.revision,method:"POST",timeout:30,data:{IM_CRM_SELECTOR:"Y",sessid:d.bitrix_sessid()}});d.addCustomEvent("onCrmSelectorInit",function(j,i,h){if(i!="olCrmSelector"){return true}setTimeout(function(){b.obCrm[i].Open();b.obCrm[i].AddOnSaveListener(function(k){d.MessengerCommon.linesChangeCrmEntityAjax(k)})},200)})}};a.prototype.linesChangeCrmEntityAjax=function(e){var l=false;for(var j in e.company){l=e.company[j]}if(!l){for(var j in e.contact){l=e.contact[j]}}if(!l){for(var j in e.lead){l=e.lead[j]}}if(!l){return false}var g=this.linesChangeCrmEntityMessageId;if(!this.BXIM.messenger.message[g]){return false}var h=this.BXIM.messenger.message[g].chatId;if(this.BXIM.messenger.blockJoinChat[h]){return false}if(this.BXIM.messenger.chat[h]&&this.BXIM.messenger.chat[h].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(h)){return false}var f=l.id.split("_")[1];var k=l.type;this.BXIM.messenger.blockJoinChat[h]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_CHANGE_CRM_ENTITY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"changeCrmEntity",CHAT_ID:h,MESSAGE_ID:g,ENTITY_TYPE:k,ENTITY_ID:f,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[h]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[h]=false},this)})};a.prototype.linesCancelCrmExtend=function(e){if(!this.BXIM.messenger.message[e]){return false}var f=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[f]){return false}if(this.BXIM.messenger.chat[f]&&this.BXIM.messenger.chat[f].entity_type!="LINES"){return false}if(!d.MessengerCommon.userInChat(f)){return false}this.BXIM.messenger.blockJoinChat[f]=true;d.ajax({url:this.BXIM.pathToAjax+"?LINES_CANCEL_CRM_EXTEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"cancelCrmExtend",CHAT_ID:f,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:d.bitrix_sessid()},onsuccess:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this),onfailure:d.delegate(function(){this.BXIM.messenger.blockJoinChat[f]=false},this)});d.remove(d("im-message-keyboard-"+e))};a.prototype.getMessagePlural=function(e,g){var f,h;h=d.message("LANGUAGE_ID")||"en";g=parseInt(g);if(g<0){g=-1*g}if(h){switch(h){case"de":case"en":f=((g!==1)?1:0);break;case"ru":case"ua":f=(((g%10===1)&&(g%100!==11))?0:(((g%10>=2)&&(g%10<=4)&&((g%100<10)||(g%100>=20)))?1:2));break;default:f=1;break}}else{f=1}return d.message(e+"_PLURAL_"+f)};a.prototype.openRenamePortal=function(e){if(e&&d.hasClass(e,"bx-messenger-keyboard-button-block")){return false}if(this.isMobile()){app.alert({text:d.message("IM_FUNCTION_FOR_BROWSER")})}if(this.isDesktop()){d.desktop.browse(this.BXIM.path.profile+"?b24renameform=1","desktopApp")}else{if(typeof(d.Bitrix24)!="undefined"){d.Bitrix24.renamePortal()}else{this.BXIM.confirm(d.message("IM_UNKNOWN_ERROR"))}}return true};d.MessengerCommon=new a();var c=function(){this.list={};this.updateInterval=1000;clearInterval(this.updateIntervalId);this.updateIntervalId=setInterval(this.worker.bind(this),this.updateInterval)};c.prototype.start=function(f,i,g,h,e){i=i===null?"default":i;g=parseInt(g);if(g<=0||i.toString().length<=0){return false}if(typeof this.list[f]=="undefined"){this.list[f]={}}this.list[f][i]={dateStop:new Date().getTime()+g,callback:typeof h=="function"?h:function(){},callbackParams:typeof e=="undefined"?{}:e};return true};c.prototype.stop=function(f,g,e){g=g===null?"default":g;if(g.toString().length<=0||typeof this.list[f]=="undefined"){return false}if(!this.list[f][g]){return true}if(e!==true){this.list[f][g]["callback"](g,this.list[f][g]["callbackParams"])}delete this.list[f][g];return true};c.prototype.stopAll=function(e){for(var f in this.list){if(this.list.hasOwnProperty(f)){for(var g in this.list[f]){if(this.list[f].hasOwnProperty(g)){this.stop(f,g,e)}}}}return true};c.prototype.worker=function(){for(var e in this.list){if(!this.list.hasOwnProperty(e)){continue}for(var f in this.list[e]){if(!this.list[e].hasOwnProperty(f)||this.list[e][f]["dateStop"]>new Date()){continue}this.stop(e,f)}}return true};c.prototype.destroy=function(){clearInterval(this.updateIntervalId);this.stopAll(true);return true};d.MessengerTimer=new c()})(window);