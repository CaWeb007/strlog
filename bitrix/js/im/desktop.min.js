(function(a){if(a.BX.desktop){return}var c=a.BX;var b=function(){this.apiReady=typeof(BXDesktopSystem)!="undefined"||typeof(BXDesktopWindow)!="undefined";this.clientVersion=0;this.disableLogin=false;this.autorun=null;this.lastSetIcon=null;this.showNotifyId={};this.htmlWrapperHead=null;this.topmostWindow=null;this.topmostWindowTimeout=null;this.path={};this.path.mainUserOptions="/desktop_app/options.ajax.php";this.path.pathToAjax="/desktop_app/im.ajax.php";this.path.pathToPull="/desktop_app/pull.ajax.php";this.tabItems={};this.tabRedrawTimeout=null;this.syncStatus=null;this.syncPauseBlock=false;this.inited=false;this.sizeInited=false;this.minWidth=515;this.minHeight=384;this.timeoutDelayOfLogout=null;this.eventHandlers={};this.addCustomEvent("bxImLogoutInit",c.delegate(function(d,e){this.logout(d,e,true)},this));c.bind(a,"keydown",c.delegate(function(d){if(d.keyCode==82&&(d.ctrlKey==true||d.metaKey==true)){if(d.shiftKey==true&&typeof(BXIM)!="undefined"){BXIM.setLocalConfig("global_msz_v2",false);c.desktop.apiReady=false;console.log("NOTICE: User use /windowReload + /clearWindowSize")}else{console.log("NOTICE: User use /windowReload")}this.windowReload()}else{if(d.keyCode==68&&(d.ctrlKey==true||d.metaKey==true)&&d.shiftKey==true){this.openDeveloperTools();console.log("NOTICE: User use /openDeveloperTools")}else{if(d.keyCode==76&&(d.ctrlKey==true||d.metaKey==true)&&d.shiftKey==true){this.openLogsFolder();console.log("NOTICE: User use /openLogsFolder")}}}},this))};b.prototype.init=function(d){d=d||{};if(this.inited){return true}this.inited=true;this.setWindowResizable(true);this.setWindowMinSize({Width:c.MessengerWindow.minWidth,Height:c.MessengerWindow.minHeight});if(this.ready()){console.log(c.message("BXD_DEFAULT_TITLE").replace("#VERSION#",this.getApiVersion(true)));c.debugEnable(true)}if(!c.browser.IsMac()&&document.head){document.head.insertBefore(c.create("style",{attrs:{type:"text/css"},html:"@font-face { font-family: 'helvetica neue'; src: local('Arial'); } @font-face { font-family: 'Helvetica'; src: local('Arial'); }"}),document.head.firstChild)}if(this.ready()){c.ready(function(){c.addClass(document.body,"bx-desktop")})}else{c.ready(function(){c.addClass(document.body,"im-desktop-content")})}c.addCustomEvent("onMessengerWindowInit",c.delegate(function(){this.userInfo=c.MessengerWindow.getUserInfo();this.contentMenu=c.MessengerWindow.contentMenu;this.content=c.MessengerWindow.content;c.onCustomEvent(a,"onDesktopInit",[this]);c.desktop.onCustomEvent("onDesktopInit",[this])},this));c.addCustomEvent("onPullRevisionUp",function(f,e){c.PULL.closeConfirm();console.log("NOTICE: Window reload, becouse PULL REVISION UP ("+e+" -> "+f+")");location.reload()});c.addCustomEvent("onPullError",c.delegate(function(e,f){if(e=="AUTHORIZE_ERROR"){this.setIconStatus("offline");this.login(function(){console.log("DESKTOP LOGIN: success after PullError");c.PULL.setPrivateVar("_pullTryConnect",true);c.PULL.updateState("13",true)})}else{if(e=="RECONNECT"){this.setIconStatus("offline")}}},this));c.addCustomEvent("onImError",c.delegate(function(e,f){if(e=="AUTHORIZE_ERROR"||e=="SEND_ERROR"&&f=="AUTHORIZE_ERROR"){this.setIconStatus("offline");this.login(c.delegate(function(){this.setIconStatus("online");var g="DESKTOP LOGIN: success after ImError";console.log(g);if(typeof(BXIM)!="undefined"){c.desktop.log("phone."+BXIM.userEmail+".log",g);BXIM.messenger.connectionStatus("online",false)}},this))}else{if(e=="CONNECT_ERROR"){this.setIconStatus("offline")}}},this));if(this.ready()){c.userOptions.setAjaxPath(this.path.mainUserOptions);c.addCustomEvent("onPullStatus",c.delegate(function(e){if(e=="offline"){this.setIconStatus("offline")}else{this.setIconStatus(BXIM&&BXIM.settings?BXIM.settings.status:"online")}},this));c.bind(a,"online",c.delegate(function(){this.setIconStatus(BXIM&&BXIM.settings?BXIM.settings.status:"online")},this));c.bind(a,"offline",c.delegate(function(){this.setIconStatus("offline")},this));this.addCustomEvent("BXWakeAction",c.delegate(function(){this.setIconStatus(BXIM&&BXIM.settings?BXIM.settings.status:"online")},this));this.addCustomEvent("BXSleepAction",c.delegate(function(){this.setIconStatus("offline")},this));this.addCustomEvent("BXExitApplication",c.delegate(function(){this.preventShutdown();this.logout(true,"exit_event")},this))}this.addCustomEvent("BXChangeTab",c.delegate(function(e){this.changeTab(e)},this));this.addCustomEvent("BXTrayConstructMenu",c.delegate(function(){this.onCustomEvent("main","BXTrayMenu",[]);setTimeout(function(){c.desktop.finalizeTrayMenu()})},this));this.addCustomEvent("BXFileStorageSyncPauseChanged",c.delegate(this.onSyncStatusChanged,this))};b.prototype.notSupported=function(){this.setWindowMinSize({Width:864,Height:493});this.setWindowSize({Width:864,Height:493});this.setWindowResizable(false);this.setWindowTitle(c.message("BXD_DEFAULT_TITLE").replace("#VERSION#",this.getApiVersion(true)));var d=c.create("div",{props:{className:"bx-desktop-update-box"},children:[c.create("div",{props:{className:"bx-desktop-update-box-text"},html:c.message("BXD_NEED_UPDATE")}),c.create("div",{props:{className:"bx-desktop-update-box-btn"},events:{click:c.delegate(function(){this.checkUpdate(true)},this)},html:c.message("BXD_NEED_UPDATE_BTN")})]});c.ready(function(){document.body.innerHTML="";document.body.appendChild(d);c.onCustomEvent(a,"onDesktopOutdated",[this])})};b.prototype.getCurrentUrl=function(){return document.location.protocol+"//"+document.location.hostname+(document.location.port==""?"":":"+document.location.port)};b.prototype.ready=function(){return this.apiReady};b.prototype.diskReady=function(){return this.apiReady&&typeof(BXFileStorage)!="undefined"};b.prototype.login=function(f){if(this.disableLogin){console.log("DESKTOP LOGIN: command was disabled");return false}var d="DESKTOP LOGIN: try to login";console.log(d);if(typeof(BXIM)!="undefined"){c.desktop.log("phone."+BXIM.userEmail+".log",d)}if(!this.ready()){this.windowReload();return false}var e={};if(typeof(f)=="function"){e.success=c.delegate(function(g){if(typeof(g)=="string"){c.message({bitrix_sessid:g})}f(g);this.onCustomEvent("main","BXLoginSuccess",[g])},this)}else{e.success=c.delegate(this.loginSuccessCallback,this)}BXDesktopSystem.Login(e);return true};b.prototype.loginSuccessCallback=function(d){if(typeof(d)=="string"){c.message({bitrix_sessid:d})}if(!this.ready()){return false}this.windowReload();return true};b.prototype.showLoginForm=function(){BXDesktopSystem.Logout(1,"login_form")};b.prototype.windowReload=function(){location.reload()};b.prototype.logout=function(d,f,e){d=d==true;this.apiReady=false;c.ajax({url:this.path.pathToAjax+"?DESKTOP_LOGOUT",method:"POST",dataType:"json",timeout:30,data:{IM_DESKTOP_LOGOUT:"Y",sessid:c.bitrix_sessid()},onsuccess:c.delegate(function(){if(f){console.log("Logout reason: "+f)}if(d){BXDesktopSystem.Shutdown()}else{BXDesktopSystem.Logout(2)}},this),onfailure:c.delegate(function(){if(f){console.log("Logout reason (fail): "+f)}if(d){BXDesktopSystem.Shutdown()}else{BXDesktopSystem.Logout(3)}},this)});return true};b.prototype.checkUpdate=function(d){if(typeof(BXDesktopSystem)=="undefined"){return false}d=typeof(d)!="boolean"?false:d;if(!d&&this.enableInVersion(16)){BXDesktopSystem.ExecuteCommand("update.check",{NotifyNoUpdates:true,ShowNotifications:true})}else{this.browse(c.browser.IsMac()?"http://dl.bitrix24.com/b24/bitrix24_desktop.dmg":"http://dl.bitrix24.com/b24/bitrix24_desktop.exe","desktopApp")}return true};b.prototype.getApiVersion=function(d){if(typeof(BXDesktopSystem)=="undefined"){return 0}if(!this.clientVersion){this.clientVersion=BXDesktopSystem.GetProperty("versionParts")}return d?this.clientVersion.join("."):this.clientVersion[3]};b.prototype.enableInVersion=function(d){if(typeof(BXDesktopSystem)=="undefined"){return false}return this.getApiVersion()>=parseInt(d)};b.prototype.addCustomEvent=function(d,e){if(!this.ready()){return false}var f=function(j){var g=[];for(var h in j.detail){g.push(j.detail[h])}e.apply(a,g)};if(!this.eventHandlers[d]){this.eventHandlers[d]=[]}this.eventHandlers[d].push(f);a.addEventListener(d,f);return true};b.prototype.removeCustomEvents=function(d){if(!this.eventHandlers[d]){return false}this.eventHandlers[d].forEach(function(e){a.removeEventListener(d,e)});this.eventHandlers[d]=[]};b.prototype.onCustomEvent=function(h,f,d){if(!this.ready()){return false}if(arguments.length==2){d=f;f=h;h="all"}else{if(arguments.length<2){return false}}var j={};for(var g=0;g<d.length;g++){j[g]=d[g]}if(h=="all"){var e=opener?opener:top;for(var g=0;g<e.BXWindows.length;g++){if(e.BXWindows[g]&&e.BXWindows[g].name!=""&&e.BXWindows[g].BXDesktopWindow&&e.BXWindows[g].BXDesktopWindow.DispatchCustomEvent){e.BXWindows[g].BXDesktopWindow.DispatchCustomEvent(f,j)}}e.BXDesktopWindow.DispatchCustomEvent(f,j)}else{if(h=this.findWindow(h)){h.DispatchCustomEvent(f,j)}}return true};b.prototype.findWindow=function(e){if(!this.ready()){return null}if(typeof(e)=="undefined"){e="main"}var d=opener?opener:top;if(e=="main"){return d.BXDesktopWindow}else{for(var f=0;f<d.BXWindows.length;f++){if(d.BXWindows[f].name===e){return d.BXWindows[f].BXDesktopWindow}}}return null};b.prototype.windowIsFocused=function(){if(!this.ready()){return false}return BXDesktopWindow.GetProperty("isForeground")};b.prototype.setIconStatus=function(d){if(!this.ready()){return false}if(this.lastSetIcon==d){return false}this.lastSetIcon=d;BXDesktopSystem.SetIconStatus(d);return true};b.prototype.setIconBadge=function(e,d){if(!this.ready()){return false}d=d===true;if(this.isActiveWindow()){BXDesktopSystem.SetIconBadge(e+"",d)}return true};b.prototype.setIconTooltip=function(d){if(!this.ready()){return false}return BXDesktopSystem.ExecuteCommand("tooltip.change",d)};b.prototype.setWindowResizable=function(d){if(!this.ready()){return false}BXDesktopWindow.SetProperty("resizable",d!==false);return false};b.prototype.setWindowClosable=function(d){if(!this.ready()){return false}BXDesktopWindow.SetProperty("closable",d!==false);return false};b.prototype.flashIcon=function(d){if(!this.ready()){return false}BXDesktopSystem.FlashIcon(d==true);return true};b.prototype.getWorkArea=function(){if(!this.ready()){return false}var d=BXDesktopSystem.GetWorkArea();return{top:d[0],left:d[1],right:d[2],bottom:d[3]}};b.prototype.showNotification=function(f,d,e){if(!this.ready()||d==""){return false}if(this.showNotifyId[f]){return false}this.showNotifyId[f]=true;BXDesktopSystem.ExecuteCommand("notification.show.html",this.getHtmlPage(d,e,"desktop-notify-popup"));return true};b.prototype.adjustSize=function(e,d){return c.MessengerWindow.adjustSize(e,d)};b.prototype.resize=function(){if(!this.ready()){return false}BXDesktopWindow.SetProperty("clientSize",{Width:document.body.offsetWidth,Height:document.body.offsetHeight});return true};b.prototype.syncPause=function(d,e){if(!this.diskReady()){return false}if(e){this.syncPauseBlock=d}if(!this.syncPauseBlock||this.syncPauseBlock&&e){this.syncStatus=!d;BXFileStorage.SyncPause(!this.syncStatus);c.onCustomEvent(a,"onDesktopSyncPause",[this.syncStatus])}return true};b.prototype.onSyncStatusChanged=function(d){this.syncPause(d,true)};b.prototype.getSyncStatus=function(){return this.syncStatus};b.prototype.windowCommand=function(d,g){if(!this.ready()){return false}if(arguments.length==1){g=d;d=a}if(g=="show"&&d==a){c.desktop.setActiveWindow()}try{if(g=="show"||g=="hide"||g=="focus"||g=="freeze"||g=="unfreeze"){d.BXDesktopWindow.ExecuteCommand(g)}else{if(g=="close"){if(d.opener){if(d.name.indexOf("topmost")>=0||d.name.indexOf("notif")>=0){d.BXDesktopWindow.ExecuteCommand("close")}else{d.close()}}else{d.BXDesktopWindow.ExecuteCommand("hide")}}}}catch(f){console.log("ExecuteCommand Error",g,d,f);console.trace()}return true};b.prototype.openTopmostWindow=function(e,f,d){if(!this.ready()){return false}this.closeTopmostWindow();this.topmostWindow=BXDesktopSystem.ExecuteCommand("topmost.show.html",this.getHtmlPage(e,f,d));return true};b.prototype.closeTopmostWindow=function(){if(this.topmostWindow){this.windowCommand(this.topmostWindow,"close");this.topmostWindow=null}return true};b.prototype.getHtmlPage=function(e,f,d){if(!this.ready()){return}e=e||"";f=f||"";d=d||"";if(this.htmlWrapperHead==null){this.htmlWrapperHead=document.head.outerHTML.replace(/BX\.PULL\.start\([^)]*\);/g,"")}if(e!=""&&c.type.isDomNode(e)){e=e.outerHTML}if(f!=""&&c.type.isDomNode(f)){f=f.outerHTML}if(f!=""){f='<script type="text/javascript">BX.ready(function(){'+f+"});<\/script>"}return"<!DOCTYPE html><html>"+this.htmlWrapperHead+'<body class="im-desktop im-desktop-popup '+d+'">'+e+f+"</body></html>"};b.prototype.openDeveloperTools=function(){if(typeof(BXDesktopWindow)=="undefined"){return false}BXDesktopWindow.OpenDeveloperTools();return true};b.prototype.openLogsFolder=function(){if(!this.ready()){return false}BXDesktopSystem.OpenLogsFolder();return true};b.prototype.browse=function(d){if(typeof(BXDesktopSystem)=="undefined"){return false}BXDesktopSystem.ExecuteCommand("browse",d);return true};b.prototype.autorunStatus=function(d){if(!this.ready()){return false}if(typeof(d)!="boolean"){if(this.autorun==null){this.autorun=BXDesktopSystem.GetProperty("autostart")}}else{this.autorun=d;BXDesktopSystem.SetProperty("autostart",this.autorun)}return this.autorun};b.prototype.diskAttachStatus=function(){if(!this.ready()){return false}return BitrixDisk?BitrixDisk.enabled:false};b.prototype.clipboardSelected=function(g,d){d=d||false;var i="";var j=0;var k=0;if(typeof(g)=="object"&&(g.tagName=="TEXTAREA"||g.tagName=="INPUT")){j=g.selectionStart;k=g.selectionEnd;i=g.value.substring(j,k);if(d){if(i&&i.indexOf(" ")>-1){i=""}else{var l=g.value.substr(0,j).search(/([-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/\x20])(?!.*[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/\x20])/)+1;var f=g.value.substr(l).search(/[-'`~!@#$%^&*()_|+=?;:'",.<>\{\}\[\]\\\/\x20]/);f=(f>0?f:g.value.length);i=g.value.substr(l,f);j=l;k=l+f}}}else{if(!d&&a.getSelection().toString().length>0){var h=a.getSelection().getRangeAt(0).cloneContents();var e=document.createElement("div");e.appendChild(h);i=e.innerHTML}}if(i.length>0){i=c.util.htmlspecialcharsback(i);i=i.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("\t");i=i.replace(/<img.*?data-code="([^"]*)".*?>/ig,"$1");i=i.replace(/&nbsp;/ig," ").replace(/&copy;/,"(c)");i=i.replace(/<div class=\"bx-messenger-hr\"><\/div>/ig,"\n");i=i.replace(/<span class=\"bx-messenger-clear\"><\/span>/ig,"\n");i=i.replace(/<s>([^"]*)<\/s>/ig,"");i=i.replace(/<(\/*)([buis]+)>/ig,"[$1$2]");i=i.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/ig,"$1");i=i.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gmi,"["+c.message("BXD_QUOTE_BLOCK")+"]");i=i.replace("<br />","\n").replace(/<\/?[^>]+>/gi,"")}return{text:i,selectionStart:j,selectionEnd:k}};b.prototype.clipboardCopy=function(h,d){if(!this.ready()){return false}document.execCommand(d==true?"cut":"copy");var g=c.create("textarea",{style:{position:"absolute",opacity:0,top:-1000,left:-1000}});document.body.insertBefore(g,document.body.firstChild);g.focus();document.execCommand("paste");var f=g.value;if(typeof(h)=="function"){var e=h(g.value);if(typeof(e)!="undefined"){f=g.value=e}g.selectionStart=0;document.execCommand("copy")}c.remove(g);return f};b.prototype.clipboardCut=function(){return this.clipboardCopy(null,true)};b.prototype.clipboardPaste=function(){if(!this.ready()){return false}document.execCommand("paste");return true};b.prototype.clipboardDelete=function(){if(!this.ready()){return false}document.execCommand("delete");return true};b.prototype.clipboardUndo=function(){if(!this.ready()){return false}document.execCommand("undo");return true};b.prototype.clipboardRedo=function(){if(!this.ready()){return false}document.execCommand("redo");return true};b.prototype.clipboardReplaceText=function(f,e,d,g){if(!this.ready()){return false}f.focus();f.selectionStart=e;f.selectionEnd=d;if(d-e<g.length){d=e+g.length}document.execCommand("insertText",false,g);f.selectionStart=d;f.selectionEnd=d;return true};b.prototype.selectAll=function(d){if(!this.ready()){return false}d.selectionStart=0;return true};b.prototype.getLocalConfig=function(f,g){g=typeof(g)=="undefined"?null:g;if(!this.ready()){return g}var d=BXDesktopSystem.QuerySettings(f,g+"");if(typeof(d)=="string"&&d.length>0){try{d=JSON.parse(d)}catch(h){d=g}}return d};b.prototype.setLocalConfig=function(d,e){if(!this.ready()){return false}if(typeof(e)=="object"){e=JSON.stringify(e)}else{if(typeof(e)=="boolean"){e=e?"true":"false"}else{if(typeof(e)=="undefined"){e=""}else{if(typeof(e)!="string"){e=e+""}}}}BXDesktopSystem.StoreSettings(d,e);return true};b.prototype.removeLocalConfig=function(d){if(!this.ready()){return false}BXDesktopSystem.StoreSettings(d,null);return true};b.prototype.log=function(d,e){if(!this.ready()){return false}BXDesktopSystem.Log(d,e);return true};b.prototype.createWindow=function(d,e){BXDesktopSystem.GetWindow(d,e)};b.prototype.getWindowTitle=function(d){if(!this.ready()){return false}BXDesktopWindow.GetProperty("title");return true};b.prototype.setWindowTitle=function(d){if(!this.ready()){return false}if(typeof(d)=="undefined"){return false}d=c.util.trim(d);if(d.length<=0){return false}BXDesktopWindow.SetProperty("title",d);return true};b.prototype.setWindowPosition=function(d){if(!this.ready()){return false}BXDesktopWindow.SetProperty("position",d);return true};b.prototype.setWindowSize=function(d){if(!this.ready()){return false}BXDesktopWindow.SetProperty("clientSize",d);if(d.Width&&d.Height){c.MessengerWindow.adjustSize(d.Width,d.Height)}return true};b.prototype.setWindowMinSize=function(d){if(!this.ready()){return false}if(!d.Width||!d.Height){return false}c.MessengerWindow.minWidth=d.Width;c.MessengerWindow.minHeight=d.Height;BXDesktopWindow.SetProperty("minClientSize",d);return true};b.prototype.addTrayMenuItem=function(d){if(!this.ready()){return false}BXDesktopWindow.AddTrayMenuItem(d);return true};b.prototype.finalizeTrayMenu=function(){if(!this.ready()){return false}BXDesktopWindow.EndTrayMenuItem();return true};b.prototype.preventShutdown=function(){if(!this.ready()){return false}BXDesktopSystem.PreventShutdown();return true};b.prototype.diskReportStorageNotification=function(e,d){if(!this.ready()){return false}BXDesktopSystem.ReportStorageNotification(e,d);return true};b.prototype.diskOpenFolder=function(){if(!this.ready()){return false}BXFileStorage.OpenFolder();return true};b.prototype.addSeparator=function(d){return c.MessengerWindow.addSeparator(d)};b.prototype.addTab=function(d){return c.MessengerWindow.addTab(d)};b.prototype.changeTab=function(d,e){return c.MessengerWindow.changeTab(d,e)};b.prototype.closeTab=function(d){return c.MessengerWindow.closeTab(d)};b.prototype.setTabBadge=function(d,e){return c.MessengerWindow.setTabBadge(d,e)};b.prototype.updateTabBadge=function(){if(!this.ready()){return false}var e=0;for(var d in c.MessengerWindow.tabItems){if(c.MessengerWindow.tabItems[d].badge){e+=c.MessengerWindow.tabItems[d].badge}}if(e<=0){e=""}else{if(e>50){e="50+"}}BXDesktopSystem.SetTabBadge(this.getContextWindow(),e+"")};b.prototype.setTabContent=function(d,e){return c.MessengerWindow.setTabContent(d,e)};b.prototype.isActiveWindow=function(){if(!this.ready()){return false}return BXDesktopSystem.IsActiveTab()};b.prototype.getActiveWindow=function(){if(!this.ready()){return 1}return BXDesktopSystem.ActiveTab()};b.prototype.getContextWindow=function(){if(!this.ready()){return 1}if(this.isActiveWindow()){return this.getActiveWindow()}else{if(this.getActiveWindow()==TAB_CP){return TAB_B24NET}else{return TAB_CP}}};b.prototype.setActiveWindow=function(d){if(!this.ready()){return false}if(typeof(d)!="undefined"){if(d==TAB_B24NET||d==TAB_CP){BXDesktopSystem.SetActiveTabI(d)}}else{BXDesktopSystem.SetActiveTab()}};b.prototype.getUserInfo=function(){return c.MessengerWindow.getUserInfo()};c.desktop=new b()})(window);