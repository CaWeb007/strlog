var WebRTCPlugin=function(){this.plugin=this.UI.plugin=new BXCordovaPlugin("MobileWebRTC");this.CallBackExecute=function(){this.plugin.CallBackExecute.apply(this.plugin,arguments)}};WebRTCPlugin.prototype={UI:{state:{OUTGOING_CALL:"outgoing_call",INCOMING_CALL:"incoming_call",CONVERSATION:"conversation",FAIL_CALL:"fail_call"},exec:function(a,b){console.log(this);this.plugin.exec(a,b)},show:function(b,a){var c=a||{};c.state=b;return this.exec("showUi",c)},close:function(a){return this.plugin.exec("closeUi",a)},showLocalVideo:function(a){return this.plugin.exec("showLocalVideo",a)}},createPeerConnection:function(a){return this.plugin.exec("createPeerConnection",a)},createOffer:function(a){return this.plugin.exec("createOffer",a)},createAnswer:function(a){return this.plugin.exec("createAnswer",a)},addIceCandidates:function(a){return this.plugin.exec("addIceCandidates",a)},setRemoteDescription:function(a){return this.plugin.exec("setRemoteDescription",a)},getUserMedia:function(a){return this.plugin.exec("getUserMedia",a)},onReconnect:function(a){return this.plugin.exec("onReconnect",a)},setEventListeners:function(a){return this.plugin.exec("setEventListeners",a)}};window.webrtc=webrtc=new WebRTCPlugin();MobileWebrtc=function(){this.siteDir=(typeof mobileSiteDir=="undefined"?"/":mobileSiteDir);this.signalingLink=this.siteDir+"mobile/ajax.php?mobile_action=calls&";this.initiator=false;this.callUserId=0;this.debug=false;this.eventTimeRange=30;this.incomingCallTimeOut=2;this.delayedIncomingCall={};this.incomingCallTimeOutId=null;this.callBackUserId=0;this.callChatId=0;this.callToGroup=false;this.waitTimeout=false;this.callGroupUsers=[];this.callInit=false;this.callActive=false;this.ready=false;this.pcStart={};this.connected={};this.sessionDescription={};this.remoteSessionDescription={};this.iceCandidates=[];this.iceCandidatesToSend=[];this.iceCandidateTimeout=0;this.peerConnectionInited=false;this.utcOffest=BX.localStorage.get("bxUTCOffset");if(this.utcOffest==null){this.utcOffest=0;BX.ajax({url:this.siteDir+"mobile/?mobile_action=service&service_id=server_utc",method:"GET",dataType:"json",timeout:30,async:true,onsuccess:BX.proxy(function(a){if(a){var b=Math.round((new Date).getTime()/1000);this.utcOffest=a.server_utc_time-b;BX.localStorage.set("bxUTCOffset",this.utcOffest,43200)}},this),onfailure:BX.proxy(function(){},this)})}webrtc.setEventListeners({onAnswer:BX.proxy(this.onAnswer,this),onDecline:BX.proxy(this.onDecline,this),onCallback:BX.proxy(this.onCallback,this),onClose:BX.proxy(this.onClose,this),onUserMediaSuccess:BX.proxy(this.onUserMediaSuccess,this),onDisconnect:BX.proxy(this.onDisconnect,this),onPeerConnectionCreated:BX.proxy(this.onPeerConnectionCreated,this),onIceCandidateDiscovered:BX.proxy(this.onIceCandidateDiscovered,this),onLocalSessionDescriptionCreated:BX.proxy(this.onLocalSessionDescriptionCreated,this),onIceConnectionStateChanged:BX.proxy(this.onIceConnectionStateChanged,this),onIceGatheringStateChanged:BX.proxy(this.onIceGatheringStateChanged,this),onSignalingStateChanged:BX.proxy(this.onSignalingStateChanged,this),onError:BX.proxy(this.onError,this)})};MobileWebrtc.prototype.attachListeners=function(){webrtc.setEventListeners({onAnswer:BX.proxy(this.onAnswer,this),onDecline:BX.proxy(this.onDecline,this),onCallback:BX.proxy(this.onCallback,this),onClose:BX.proxy(this.onClose,this),onUserMediaSuccess:BX.proxy(this.onUserMediaSuccess,this),onDisconnect:BX.proxy(this.onDisconnect,this),onPeerConnectionCreated:BX.proxy(this.onPeerConnectionCreated,this),onIceCandidateDiscovered:BX.proxy(this.onIceCandidateDiscovered,this),onLocalSessionDescriptionCreated:BX.proxy(this.onLocalSessionDescriptionCreated,this),onIceConnectionStateChanged:BX.proxy(this.onIceConnectionStateChanged,this),onIceGatheringStateChanged:BX.proxy(this.onIceGatheringStateChanged,this),onSignalingStateChanged:BX.proxy(this.onSignalingStateChanged,this),onError:BX.proxy(this.onError,this)})};MobileWebrtc.prototype.getUserId=function(){return BX.message("USER_ID")};MobileWebrtc.prototype.callInvite=function(a,b,c){if(a==this.getUserId()||this.callInit){return}if(this.delayedIncomingCall.chatId&&this.delayedIncomingCall.senderId==a){this.clearDelayedCallData()}var d=!(typeof b!="undefined"&&b===false);var e=(c===true);this.callInit=true;this.video=d;this.initiator=true;this.isConversationUIReady=false;this.ajaxCall("CALL_INVITE",{COMMAND:"invite",CHAT_ID:a,CHAT:"N",VIDEO:(d?"Y":"N")},BX.delegate(function(f){if(f.ERROR){if(e){this.resetState();this.callInit=false;this.finishDialog()}else{if(f.ERROR=="SESSION_ERROR"){BX.message.bitrix_sessid=f.BITRIX_SESSID;this.callInit=false;this.callInvite(a,b,true)}else{if(f.ERROR=="AUTHORIZE_ERROR"){app.BasicAuth({success:BX.delegate(function(){this.callInit=false;this.callInvite(a,b,true)},this)})}}}return}this.isConversationUIReady=true;this.initiator=true;this.callChatId=f.CHAT_ID;this.callToGroup=f.CALL_TO_GROUP;this.callUserId=a;this.attachListeners();webrtc.UI.show(webrtc.UI.state.OUTGOING_CALL,{data:f,video:d,recipient:{avatar:f.HR_PHOTO[this.callUserId],name:f.USERS[this.callUserId]["name"]},caller:{avatar:f.HR_PHOTO[this.getUserId()],name:f.USERS[this.getUserId()]["name"]}});BX.onCustomEvent("onMobileRTCReadyToConversation")},this),BX.delegate(function(f){this.resetState();this.callInit=false;this.finishDialog()},this))};MobileWebrtc.prototype.showIncomingCall=function(a){this.callChatId=a.chatId;this.callToGroup=false;this.callUserId=a.senderId;this.initiator=false;this.callInit=true;this.callCommand(this.callChatId,"wait");this.attachListeners();webrtc.UI.show(webrtc.UI.state.INCOMING_CALL,{data:a,video:a.video,caller:{name:a.users[a.senderId]["name"],avatar:a.hrphoto[a.senderId]}})};MobileWebrtc.prototype.clearDelayedCallData=function(){clearTimeout(this.incomingCallTimeOutId);this.incomingCallTimeOutId=null;this.delayedIncomingCall={}};MobileWebrtc.prototype.resetState=function(){this.connected={};this.initiator=false;this.callInit=false;this.video=false;this.callActive=false;this.callChatId=0;this.callUserId=0;this.isMobile=false;this.peerConnectionInited=false;this.iceCandidates=[];this.iceCandidatesToSend=[];this.isConversationUIReady=false};MobileWebrtc.prototype.callSignaling=function(a,b){this.ajaxCall("CALL_SIGNALING",{COMMAND:"signaling",CHAT_ID:this.callChatId,RECIPIENT_ID:a,PEER:JSON.stringify(b)})};MobileWebrtc.prototype.callCommand=function(a,d,c,b){a=parseInt(a);c=typeof(c)=="object"?c:{};if(a>0){this.ajaxCall("CALL_SHARED",{COMMAND:d,CHAT_ID:a,RECIPIENT_ID:this.callUserId,PARAMS:JSON.stringify(c)})}};MobileWebrtc.prototype.finishDialog=function(){webrtc.UI.close()};MobileWebrtc.prototype.signalingPeerData=function(b,d){var c=JSON.parse(d);if(c.type==="offer"){this.remoteSessionDescription=c.sdp;webrtc.createPeerConnection()}else{if(c.type==="answer"){webrtc.setRemoteDescription(c)}else{if(c.type==="candidate"){if(this.peerConnectionInited){webrtc.addIceCandidates(c.candidates)}else{for(var a=0;a<c.candidates.length;a++){this.iceCandidates.push(c.candidates[a])}}}}}};MobileWebrtc.prototype.ajaxCall=function(c,b,a,e){var d=b;d.MOBILE="Y";d.IS_MOBILE="Y";d.IM_CALL="Y";d.IM_AJAX_CALL="Y";d.sessid=BX.bitrix_sessid();BX.ajax({url:this.signalingLink+c,method:"POST",dataType:"json",timeout:30,async:true,data:d,onsuccess:a,onfailure:e})};MobileWebrtc.prototype.getUTCOffset=function(){return this.utcOffest*1000};MobileWebrtc.prototype.getTimeDiff=function(c){var b=(new Date).getTime()+this.getUTCOffset();var a=Date.parse(c);return Math.abs((b-a)/1000)};MobileWebrtc.prototype.timesUp=function(a){return((Math.abs((new Date).getTime()+this.getUTCOffset()-a)/1000)>=this.eventTimeRange)};MobileWebrtc.prototype.onDecline=function(a){this.callCommand(this.callChatId,"decline",{ACTIVE:(this.callActive)?"Y":"N",INITIATOR:(this.initiator)?"Y":"N"});this.resetState()};MobileWebrtc.prototype.onAnswer=function(a){webrtc.UI.show(webrtc.UI.state.CONVERSATION);webrtc.getUserMedia({video:a.video});this.waitTimeout=false;this.callToGroup=false;this.callChatId=a.chatId;this.callUserId=a.senderId;this.callActive=true;this.initiator=false;this.ajaxCall("CALL_ANSWER",{COMMAND:"answer",CHAT_ID:this.callChatId,CALL_TO_GROUP:this.callToGroup?"Y":"N",RECIPIENT_ID:this.callUserId})};MobileWebrtc.prototype.onCallback=function(){if(this.callBackUserId>0){this.callInvite(this.callBackUserId)}};MobileWebrtc.prototype.onClose=function(){this.callBackUserId=0;this.resetState()};MobileWebrtc.prototype.onDisconnect=function(){this.peerConnectionInited=false};MobileWebrtc.prototype.onIceCandidateDiscovered=function(a){this.iceCandidatesToSend.push({type:"candidate",label:a.candidate.sdpMLineIndex,id:a.candidate.sdpMid,candidate:a.candidate.candidate});clearTimeout(this.iceCandidateTimeout);this.iceCandidateTimeout=setTimeout(BX.delegate(function(){if(this.iceCandidatesToSend.length===0){return false}this.onIceCandidate(this.callUserId,{type:"candidate",candidates:this.iceCandidatesToSend});this.iceCandidatesToSend=[]},this),250)};MobileWebrtc.prototype.onPeerConnectionCreated=function(){this.peerConnectionInited=true;if(this.initiator){webrtc.createOffer()}else{webrtc.createAnswer({sdp:this.remoteSessionDescription})}};MobileWebrtc.prototype.onIceCandidate=function(a,b){this.callSignaling(a,b)};MobileWebrtc.prototype.onIceConnectionStateChanged=function(a){};MobileWebrtc.prototype.onIceGatheringStateChanged=function(a){};MobileWebrtc.prototype.onSignalingStateChanged=function(a){};MobileWebrtc.prototype.onLocalSessionDescriptionCreated=function(a){this.sessionDescription=a;if(this.iceCandidates.length>0){webrtc.addIceCandidates(this.iceCandidates);this.iceCandidates=[]}this.callSignaling(this.callUserId,this.sessionDescription)};MobileWebrtc.prototype.onUserMediaSuccess=function(a){webrtc.UI.showLocalVideo();this.connected[this.getUserId()]=true;this.callCommand(this.callChatId,"ready");if(this.connected[this.callUserId]&&this.initiator){webrtc.createPeerConnection()}};MobileWebrtc.prototype.onError=function(a){this.resetState()};window.mwebrtc=new MobileWebrtc();BX.addCustomEvent("onPullEvent-im",BX.proxy(function(d,c){var b=this.getTimeDiff(c.SERVER_TIME)>=this.eventTimeRange;if(d=="call"){if(c.command=="ready"){this.connected[c.senderId]=true;if(this.connected[this.getUserId()]&&this.initiator==true){webrtc.createPeerConnection()}}else{if(c.command=="decline"||c.command=="end_call"){if(this.callInit){if(this.callChatId==c.chatId){if(this.initiator&&!this.connected[this.callUserId]){this.callBackUserId=this.callUserId;webrtc.UI.show(webrtc.UI.state.FAIL_CALL,{message:BX.message("MOBILEAPP_CALL_DECLINE")})}else{webrtc.UI.close()}this.resetState()}}else{if(this.delayedIncomingCall.chatId==c.chatId){this.clearDelayedCallData()}}}else{if(c.command=="end_call"){if((this.delayedIncomingCall.chatId&&this.delayedIncomingCall.chatId==c.chatId)){if(this.delayedIncomingCall.chatId==c.chatId){clearTimeout(this.incomingCallTimeOutId);this.incomingCallTimeOutId=null;this.delayedIncomingCall={}}}}else{if(c.command=="waitTimeout"){if(this.callChatId==c.chatId){this.resetState();this.finishDialog()}}else{if(!b&&(c.command=="invite"||c.command=="invite_join")){if(c.callToGroup){console.log("Call to group");return}if(!this.callInit){if(this.incomingCallTimeOutId==null){this.delayedIncomingCall=c;this.incomingCallTimeOutId=setTimeout(BX.proxy(function(){this.showIncomingCall(this.delayedIncomingCall);this.delayedIncomingCall={};this.incomingCallTimeOutId=null},this),this.incomingCallTimeOut*1000)}}else{if(c.command=="invite"){if(this.callChatId==c.chatId){this.callCommand(c.chatId,"busy_self")}else{this.ajaxCall("CALL_BUSY",{COMMAND:"busy",CHAT_ID:c.chatId,RECIPIENT_ID:c.senderId,VIDEO:c.video?"Y":"N"})}}else{if(this.initiator&&this.callChatId==c.chatId&&!this.callActive){this.onAnswer(c)}}}}else{if(c.command=="answer"&&this.initiator==true){if(!this.isConversationUIReady){var a=function(){BX.onCustomEvent("onPullEvent-im",[d,c]);BX.removeCustomEvent("onMobileRTCReadyToConversation",a)};BX.addCustomEvent("onMobileRTCReadyToConversation",a);return}if(this.callInit){this.initiator=true;this.callActive=true;webrtc.UI.show(webrtc.UI.state.CONVERSATION);if(typeof c.video=="undefined"){c.video=this.video}webrtc.getUserMedia({video:c.video})}}else{if(c.command=="decline_self"&&this.callChatId==c.chatId||c.command=="answer_self"&&!this.callActive){if(this.delayedIncomingCall.chatId==c.chatId){this.clearDelayedCallData()}this.resetState();this.finishDialog()}else{if(this.callInit&&this.callChatId==c.chatId){if(c.command=="signaling"&&this.connected[this.getUserId()]){if(this.callInit&&this.callChatId==c.chatId){this.signalingPeerData(c.senderId,c.peer)}}else{if(c.command=="busy"){if(this.callInit&&this.callChatId==c.chatId){this.callBackUserId=this.callUserId;webrtc.UI.show(webrtc.UI.state.FAIL_CALL,{message:BX.message("MOBILEAPP_CALL_BUSY")});this.resetState()}}else{if(c.command=="errorAccess"){if(this.callInit&&this.callChatId==c.chatId){this.callBackUserId=this.callUserId;webrtc.UI.show(webrtc.UI.state.FAIL_CALL,{message:BX.message("MOBILEAPP_CALL_NO_ACCESS")});this.callInit=false}}else{if(c.command=="reconnect"){this.initiator=false;webrtc.onReconnect()}}}}}}}}}}}}}},mwebrtc));