if(!DragNDrop){in_array=function(a,c){var b;for(b=0;b<a.length;b++){if(a[b]===c){return true}}return false};function CreateActivity(oActivity){if(!oActivity.Type){oActivity={Type:oActivity}}var t=oActivity.Type,a;if(arAllActivities[t.toLowerCase()]&&arAllActivities[t.toLowerCase()]["JSCLASS"]){a=eval("new "+arAllActivities[t.toLowerCase()]["JSCLASS"]+"()");if(!oActivity.Properties){oActivity.Properties={}}else{if(oActivity.Properties instanceof Array){var k,properties=BX.clone(oActivity.Properties);oActivity.Properties={};for(k in properties){if(properties.hasOwnProperty(k)){oActivity.Properties[k]=properties[k]}}}}if(!oActivity.Properties.Title){oActivity.Properties.Title=arAllActivities[t.toLowerCase()]["NAME"]}if(!oActivity.Icon&&arAllActivities[t.toLowerCase()]["ICON"]){oActivity.Icon=arAllActivities[t.toLowerCase()]["ICON"]}}else{if(typeof window[t]!=="undefined"){a=eval("new "+t+"()")}else{a=new UnknownBizProcActivity()}}a.Init(oActivity);return a}function JSToPHPHidd(c,b,a){if(typeof BPDesignerUseJson!=="undefined"&&BPDesignerUseJson){c[a]=JSON.stringify(b,function(j,h){if(typeof(h)=="boolean"){return h?"1":"0"}return h});return true}var f,e,d;if(typeof(b)=="object"){f=[];var g=false;if(b instanceof Array){g=true;for(e in b){if(parseInt(e)!=e){g=false;break}}}if(g){for(e=0;e<b.length;e++){JSToPHPHidd(c,b[e],a+"["+e+"]")}}else{for(d in b){JSToPHPHidd(c,b[d],a+"["+d+"]")}}return true}if(typeof(b)=="boolean"){if(b){c[a]="1"}else{c[a]="0"}return true}c[a]=b;return true}function JSToPHP(b,a){if(typeof BPDesignerUseJson!=="undefined"&&BPDesignerUseJson){return a+"="+encodeURIComponent(JSON.stringify(b,function(h,g){if(typeof(g)=="boolean"){return g?"1":"0"}return g}))}var e,d,c;if(typeof(b)=="object"){e=[];var f=false;if(b instanceof Array){f=true;for(d in b){if(parseInt(d)!=d){f=false;break}}}if(f){for(d=0;d<b.length;d++){e.push(JSToPHP(b[d],a+"["+d+"]"))}}else{for(c in b){e.push(JSToPHP(b[c],a+"["+c+"]"))}}return e.join("&",e)}if(typeof(b)=="boolean"){if(b){return a+"=1"}return a+"=0"}return a+"="+encodeURIComponent(b)}function ActGetRealPos(a){if(!a||!a.offsetParent){return false}return BX.pos(a,true)}function XMLEncode(a){if(!(typeof(a)=="string"||a instanceof String)){return a}a=a.replace(/&/g,"&amp;");a=a.replace(/"/g,"&quot;");a=a.replace(/'/g,"&apos;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a}function HTMLEncode(a){if(!(typeof(a)=="string"||a instanceof String)){return a}a=a.replace(/&/g,"&amp;");a=a.replace(/"/g,"&quot;");a=a.replace(/</g,"&lt;");a=a.replace(/>/g,"&gt;");return a}function GenUniqId(){return parseInt(Math.random()*100000)+"_"+parseInt(Math.random()*100000)+"_"+parseInt(Math.random()*100000)+"_"+parseInt(Math.random()*100000)}function FindActivityById(c,d){if(c.Name==d){return c}var a=false;if(c.Children){for(var b=0;b<c.Children.length;b++){a=FindActivityById(c.Children[b],d);if(a){return a}}}return a}function _crt(f,h){f=f||1;h=h||1;var e,b,g,a,d=document.createElement("TABLE");d.width="100%";d.cellSpacing="0";d.cellPadding="0";d.border="0";for(e=0;e<f;e++){g=d.insertRow(-1);for(b=0;b<h;b++){a=g.insertCell(-1);a.align="center";a.vAlign="center"}}return d}BizProcActivity=function(){var a=this;a.childActivities=[];a.parentActivity=null;a.Name="A"+GenUniqId();a.Type="Activity";a.Properties={Title:""};arAllId[a.Name]=true;this.Init=function(d){if(d.Name){if(!arAllId[d.Name]){delete arAllId[this.Name];this.Name=d.Name;arAllId[this.Name]=true}}if(d.Properties){this.Properties=BX.clone(d.Properties)}if(d.Icon){this.Icon=d.Icon}if(d.Type){this.Type=d.Type}this.height=0;this.width=0;var c;this.childActivities=[];if(!d.Children&&d.childActivities){d.Children=d.childActivities}for(var b in d.Children){if(!d.Children.hasOwnProperty(b)){continue}c=CreateActivity(d.Children[b]);c.parentActivity=this;this.childActivities[this.childActivities.length]=c}};a.SerializeToXML=function(d){if(a.childActivities){var c='<activity class="'+XMLEncode(a.Type)+'" name="'+XMLEncode(a.Properties.Title)+'" id="'+XMLEncode(a.Name)+'" params="" >';for(var b=0;b<a.childActivities.length;b++){c=c+a.childActivities[b].SerializeToXML()}return c+"</activity>"}else{return'<activity class="'+XMLEncode(a.Type)+'" name="'+XMLEncode(a.Properties.Title)+'" id="'+XMLEncode(a.Name)+'" params="" />'}};a.Serialize=function(){var c={Type:a.Type,Name:a.Name,Properties:a.Properties,Children:[]};if(a.childActivities){for(var b=0;b<a.childActivities.length;b++){c.Children.push(a.childActivities[b].Serialize())}}return c};a.OnRemoveClick=function(b){a.parentActivity.RemoveChild(a)};a.OnSettingsClick=function(b){a.Settings()};a.Settings=function(b){(new BX.CDialog({content_url:"/bitrix/admin/"+MODULE_ID+"_bizproc_activity_settings.php?mode=public&bxpublic=Y&lang="+BX.message("LANGUAGE_ID")+"&entity="+ENTITY,content_post:"id="+encodeURIComponent(a.Name)+"&decode=Y&document_type="+encodeURIComponent(document_type)+"&activity="+encodeURIComponent(a.Type)+"&"+JSToPHP(arWorkflowParameters,"arWorkflowParameters")+"&"+JSToPHP(arWorkflowVariables,"arWorkflowVariables")+"&"+JSToPHP(Array(rootActivity.Serialize()),"arWorkflowTemplate")+"&current_site_id="+encodeURIComponent(CURRENT_SITE_ID)+"&sessid="+BX.bitrix_sessid(),height:500,width:800})).Show()};a.RemoveResources=function(b){if(a.div&&a.div.parentNode){a.div.parentNode.removeChild(a.div);a.div=null}};a.RemoveChild=function(d){var c,b;for(c=0;c<a.childActivities.length;c++){if(a.childActivities[c].Name==d.Name){while(d.childActivities.length>0){d.childActivities[0].parentActivity.RemoveChild(d.childActivities[0])}d.childActivities=[];d.RemoveResources();a.childActivities[c].parentActivity=null;delete a.childActivities[c];for(b=c;b<a.childActivities.length-1;b++){a.childActivities[b]=a.childActivities[b+1]}a.childActivities.pop();delete arAllId[d.Name];break}}BPTemplateIsModified=true};a.SetError=function(c,b){if(!a.div){return false}if(c===false){a.div.className="activity"}else{a.div.className="activityerr"}if(b===true&&c!==false){BX.scrollToNode(a.div)}};a.Draw=function(m){a.div=m.appendChild(document.createElement("DIV"));a.div.className="activity";var e=a.div.appendChild(document.createElement("DIV"));e.className="activityhead";var j=e.appendChild(document.createElement("DIV"));j.className="activityheadr";var i=j.appendChild(document.createElement("DIV"));i.className="activityheadl";var h=i.appendChild(document.createElement("A"));h.className="activitydel";h.onclick=this.OnRemoveClick;var f=i.appendChild(document.createElement("A"));f.className="activityset";f.onclick=this.OnSettingsClick;if(this.OnHideClick){var d=i.appendChild(document.createElement("A"));d.className="activitymin";d.onclick=this.OnHideClick}var g=i.appendChild(document.createElement("DIV"));g.style.padding="5px";g.style.cursor="move";g.onmousedown=function(o){if(!o){o=window.event}var p=DragNDrop.StartDrag(o,a);p.innerHTML=this.parentNode.parentNode.parentNode.parentNode.parentNode.innerHTML;p.style.width=this.parentNode.parentNode.parentNode.parentNode.offsetWidth+"px"};var c=a.div.appendChild(document.createElement("DIV"));c.style.backgroundColor="#ffffff";c.style.borderLeft="2px #bebabb solid";c.style.borderRight="2px #bebabb solid";c.style.overflowX="hidden";c.style.overflowY="hidden";c.style.height=(a.activityHeight?a.activityHeight:"30px");c.ondblclick=a.OnSettingsClick;if(a.activityContent){c.appendChild(a.activityContent)}else{var k=c.appendChild(document.createElement("DIV"));if(a.Icon){k.style.background="url("+a.Icon+") left center no-repeat"}else{k.style.background="url(/bitrix/images/bizproc/act_icon.gif) left center no-repeat"}k.style.height="30px";k.style.margin="2px";k.style.paddingLeft="24px";k.style.textAlign="left";k.innerHTML=HTMLEncode(a.Properties["Title"]);k.setAttribute("title",a.Properties["Title"])}var n=a.div.appendChild(document.createElement("DIV"));n.style.background="url(/bitrix/images/bizproc/act_b.gif)";n.style.height="4px";n.style.overflowY="hidden";var l=n.appendChild(document.createElement("DIV"));l.style.background="url(/bitrix/images/bizproc/act_br.gif) right top no-repeat";var b=l.appendChild(document.createElement("DIV"));b.style.background="url(/bitrix/images/bizproc/act_bl.gif) left top no-repeat";b.style.height="4px";a.div.style.margin="0 auto";a.div.style.width=(a.activityWidth?a.activityWidth:"170px");if(a.CheckFields&&a.CheckFields()===false){a.SetError(true)}};this.SetHeight=function(b){this.height=b};a.findChildById=function(d){if(a.childActivities){for(var b=0;b<a.childActivities.length;b++){if(d===a.childActivities[b]["Name"]){return a.childActivities[b]}else{var c=a.childActivities[b].findChildById(d);if(c){return c}}}}return null}};function _DragNDrop(){var a=this;var c,b;var d=true;a.GetDrDr=function(){if(a.drdrop){return}a.drdrop=document.body.appendChild(document.createElement("DIV"));a.drdrop.style.display="none";a.drdrop.style.position="absolute";a.drdrop.style.zIndex="50000";a.drdrop.style.MozOpacity=0.6;a.drdrop.style.opacity=0.6;a.drdrop.style.filter="gray() alpha(opacity=60)";a.drdrop.style.border="1px solid #CCCCCC";a.drdrop.style.fontSize="12px";a.antiselect=document.body.appendChild(document.createElement("DIV"));a.antiselect.id="antiselect";a.antiselect.style.left="0";a.antiselect.style.top="0";a.antiselect.style.position="absolute";a.antiselect.style.MozUserSelect="none !important";a.antiselect.style.display="none";a.antiselect.style.backgroundColor="#FFFFFF";a.antiselect.style.MozOpacity=0.01;a.antiselect.style.zIndex="100000";jsUtils.addEvent(document.body,"mousemove",a.Dragging);jsUtils.addEvent(document.body,"mouseup",a.Drop)};a.obj=null;a.StartDrag=function(h,g){a.obj=g;a.GetDrDr();if(!h){h=window.event}a.antiselect.style.display="block";var f=jsUtils.GetWindowScrollSize();a.antiselect.style.width=f.scrollWidth+"px";a.antiselect.style.height=f.scrollHeight+"px";a.antiselect.style.opacity=0.01;a.antiselect.style.filter="gray() alpha(opacity=01)";a.dragging=true;a.drdrop.style.display="block";a.scrollPos=jsUtils.GetWindowScrollPos();a.drdrop.style.top=h.clientY+a.scrollPos.scrollTop+1+"px";a.drdrop.style.left=h.clientX+a.scrollPos.scrollLeft+1+"px";return a.drdrop};a.Handlers={};a.AddHandler=function(e,g){a.Handlers[e]=a.Handlers[e]||[];var f="i"+Math.random();a.Handlers[e][f]=g;return f};a.RemoveHandler=function(e,f){if(a.Handlers[e][f]){delete a.Handlers[e][f]}};a.Dragging=function(h){if(!a.dragging){return}if(!h){h=window.event}BX.fixEventPageXY(h);var l=h.pageX;var j=h.pageY;a.drdrop.style.left=l+1+"px";a.drdrop.style.top=j+1+"px";var g=BX.GetWindowInnerSize();var k=BX.GetWindowScrollPos();if((g.innerHeight-30)<h.clientY){window.scrollBy(0,20)}if((g.innerWidth-30)<h.clientX){window.scrollBy(20,0)}if(k.scrollTop>0&&h.clientY<30){window.scrollBy(0,-20)}if(k.scrollLeft>0&&h.clientX<30){window.scrollBy(-20,0)}if(document.selection&&document.selection.empty){document.selection.empty()}else{window.getSelection().removeAllRanges()}for(var f in a.Handlers.ondragging){if(!a.Handlers.ondragging.hasOwnProperty(f)){continue}if(a.Handlers.ondragging[f]){a.Handlers.ondragging[f](h,l,j)}}};a._UnS=function(){if(a.antiselect){a.antiselect.style.display="none"}};a.Drop=function(g){if(!a.dragging){return}if(!g){g=window.event}var k=jsUtils.GetWindowScrollPos();var j=g.clientX+k.scrollLeft+1+"px";var h=g.clientY+k.scrollTop+1+"px";for(var f in a.Handlers.ondrop){if(!a.Handlers.ondrop.hasOwnProperty(f)){continue}if(a.Handlers.ondrop[f]){a.Handlers.ondrop[f](j,h,g)}}a.dragging=false;a.drdrop.style.display="none";setTimeout(a._UnS,0)}}UnknownBizProcActivity=function(){var a=new BizProcActivity();a.Draw=function(k){a.div=k.appendChild(document.createElement("DIV"));a.div.className="activityerr";var d=a.div.appendChild(document.createElement("DIV"));d.className="activityhead";var h=d.appendChild(document.createElement("DIV"));h.className="activityheadr";var g=h.appendChild(document.createElement("DIV"));g.className="activityheadl";var f=g.appendChild(document.createElement("A"));f.className="activitydel";f.onclick=this.OnRemoveClick;var e=g.appendChild(document.createElement("DIV"));e.style.padding="5px";e.style.cursor="not-allowed";var c=a.div.appendChild(document.createElement("DIV"));c.style.backgroundColor="#E6E6E6";c.style.borderLeft="2px #bebabb solid";c.style.borderRight="2px #bebabb solid";c.style.overflowX="hidden";c.style.overflowY="hidden";c.style.height=(a.activityHeight?a.activityHeight:"30px");var i=c.appendChild(document.createElement("DIV"));i.style.background="url(/bitrix/images/bizproc/act_icon.gif) left center no-repeat";i.style.height="30px";i.style.margin="2px";i.style.paddingLeft="24px";i.style.textAlign="left";i.innerHTML=HTMLEncode(a.Properties["Title"]);i.setAttribute("title",a.Properties["Title"]);var l=a.div.appendChild(document.createElement("DIV"));l.style.background="url(/bitrix/images/bizproc/act_bt.gif)";l.style.backgroundColor="#E6E6E6";l.style.height="4px";l.style.overflowY="hidden";var j=l.appendChild(document.createElement("DIV"));j.style.background="url(/bitrix/images/bizproc/act_br.gif) right top no-repeat";var b=j.appendChild(document.createElement("DIV"));b.style.background="url(/bitrix/images/bizproc/act_bl.gif) left top no-repeat";b.style.height="4px";a.div.style.margin="0 auto";a.div.style.width=(a.activityWidth?a.activityWidth:"170px")};return a};BX.namespace("BX.Bizproc");BX.Bizproc.cloneTypeControl=function(o){var j=document.getElementById(o);var f=j.rows.length;var a=j.insertRow(f);var k=a.insertCell(0);var g=j.rows[f-1].cells[0].innerHTML;var c=0,q,l,d;while(true){q=g.indexOf("[n",c);if(q<0){break}l=g.indexOf("]",q);if(l<0){break}d=parseInt(g.substr(q+2,l-q));g=g.substr(0,q)+"[n"+(++d)+"]"+g.substr(l+1);c=q+1}c=0;while(true){q=g.indexOf("__n",c);if(q<0){break}l=g.indexOf("_",q+2);if(l<0){break}d=parseInt(g.substr(q+3,l-q));g=g.substr(0,q)+"__n"+(++d)+"_"+g.substr(l+1);c=l+1}k.innerHTML=g;var m=new RegExp("<script>[^\000]*?<\/script>","ig");var b=g.match(m);if(b){for(var h=0;h<b.length;h++){if(b[h]!=""){q=b[h].substring(8,b[h].length-9);jsUtils.EvalGlobal(q)}}}};BX.Bizproc.cloneTypeControlHtml=function(j,k){var g=document.getElementById(j);var d=g.rows.length;var a=g.insertRow(d);var h=a.insertCell(0);var f=g.rows[d-1].cells[0].innerHTML;var b=0,l,i,c=0;l=f.indexOf("[n",b);if(l>-1){i=f.indexOf("]",l);if(i>-1){c=parseInt(f.substr(l+2,i-l));++c}}BX.ajax({method:"GET",dataType:"html",url:"/bitrix/tools/bizproc_get_html_editor.php?site_id="+BX.message("SITE_ID")+"&editor_id="+k+"__n"+c+"_&field_name="+k+"[n"+c+"]",onsuccess:function(e){h.innerHTML=e}})};var DragNDrop=new _DragNDrop()};