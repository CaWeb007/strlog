(function(){var a=window.BX;a.namespace("BX.Bizproc");if(a.Bizproc.Selector){return}a.Bizproc.Selector={delimiter:"=",listenKeyCode:187,currentData:{},inputElement:null,popup:null,selectedTab:null,activitiesItemsCache:null};a.Bizproc.Selector.initSelectors=function(c){if(!c){c=document}var f,e,d,b=c.querySelectorAll('[data-role="bp-selector-button"]');if(b){for(d=0;d<b.length;++d){e=JSON.parse(b[d].getAttribute("data-bp-selector-props"));if(typeof e!=="object"){continue}f=document.getElementById(e.controlId);if(!f){continue}a.bind(f,"keydown",function(g){a.Bizproc.Selector.onSearch(this,g)});f.setAttribute("autocomplete","off")}}};a.Bizproc.Selector.getTabItems=function(b){var c;for(c=0;c<this.currentData.length;++c){if(this.currentData[c]["tabId"]===b){return this.currentData[c]["items"]}}return[]};a.Bizproc.Selector.getActivitiesItems=function(){if(this.activitiesItemsCache===null){this.activitiesItemsCache=this.getTemplateActivitiesItems([rootActivity.Serialize()],arAllActivities)}return this.activitiesItemsCache};a.Bizproc.Selector.getTemplateActivitiesItems=function(f,b){var m=[],d,l,h,e,g;for(d=0,l=f.length;d<l;++d){h=f[d].Type.toLowerCase();if(b[h]){e=b[h]}if(e&&e.RETURN){for(g in e.RETURN){if(!e.RETURN.hasOwnProperty(g)){continue}m.push({text:e.RETURN[g].NAME,description:f[d].Properties.Title||e.NAME,value:"{="+f[d].Name+":"+g+"}"})}}if(f[d].Children&&f[d].Children.length>0){var k=this.getTemplateActivitiesItems(f[d].Children,b);for(var c=0;c<k.length;++c){m.push(k[c])}}}return m};a.Bizproc.Selector.getTabsCounters=function(){var c,b={};for(c=0;c<this.currentData.length;++c){b[this.currentData[c]["tabId"]]=this.currentData[c]["items"].length}return b};a.Bizproc.Selector.getListElement=function(){return a.findChild(this.popup.contentContainer,{className:"bp-selector-list"},true)};a.Bizproc.Selector.getSelectedItem=function(){return a.findChild(this.popup.contentContainer,{className:"bp-selector-item-selected"},true)};a.Bizproc.Selector.getTabsElements=function(){return a.findChildren(this.popup.contentContainer,{className:"bp-selector-tab"},true)};a.Bizproc.Selector.closePopup=function(){if(this.popup){this.popup.close()}};a.Bizproc.Selector.insertItemValue=function(h,f){var d=this.inputElement.value.substr(0,this.inputElement.selectionEnd),c=this.inputElement.value.substr(0,d.lastIndexOf(this.delimiter)),e=h.getAttribute("data-value")+(f?this.delimiter:""),g=this.inputElement.value.substr(this.inputElement.selectionEnd),b=parseInt(h.getAttribute("data-cursor-position"));if(isNaN(b)){b=e.length}if(c.substr(-1)==="{"){c=c.substr(0,c.length-1)}this.inputElement.value=c+e+g;this.inputElement.selectionEnd=c.length+b};a.Bizproc.Selector.onSearch=function(c,g){var f=this,b=true;if(c.mentionListen){if(g.keyCode==27){c.mentionListen=false;this.closePopup();return a.PreventDefault(g)}else{if(g.keyCode==13&&this.popup){var d=this.getSelectedItem();if(d){this.insertItemValue(d,g.shiftKey===true);if(g.shiftKey!==true){this.closePopup()}}return a.PreventDefault(g)}else{if((g.keyCode==37||g.keyCode==39||g.keyCode==9)&&this.popup){this.SelectNextTab(g.keyCode==37?-1:1);return a.PreventDefault(g)}else{if((g.keyCode==38||g.keyCode==40)&&this.popup){this.SelectNextItem(g.keyCode==38?-1:1);return a.PreventDefault(g)}else{if(g.altKey===true||g.ctrlKey===true||(g.shiftKey===true&&g.keyCode==16)){}else{setTimeout(a.delegate(function(){var e=this.value.substr(0,this.selectionEnd);if(e.lastIndexOf(f.delimiter)<0){f.closePopup();return false}e=e.substr(e.lastIndexOf(f.delimiter),this.selectionEnd-e.lastIndexOf(f.delimiter));if(e.length<=0){f.closePopup();return false}e=e.substr(1);if(e.substr(0,1)==" "){f.closePopup();return false}if(f.popup){f.updatePopupContent(e)}},c),10)}}}}}}else{if(g.shiftKey===false&&g.keyCode==f.listenKeyCode){if(!c.mentionListen){setTimeout(a.delegate(function(){var e=this.value.substr(this.selectionEnd-1,1);if(e!=f.delimiter){return false}this.mentionListen=true;f.closePopup();f.popup=new a.PopupWindow("bx-bizproc-selector",this,{lightShadow:true,offsetTop:0,closeIcon:true,offsetLeft:0,autoHide:true,bindOptions:{position:"bottom"},closeByEsc:true,zIndex:200,events:{onPopupShow:function(){a.WindowManager.currently_loaded=this;this.CloseDialog=this.Close=function(){a.WindowManager.currently_loaded=null;if(f.popup!==null){var h=a.WindowManager.Get();if(h&&!h.unclosable){h.Close()}}}},onPopupClose:function(){this.destroy();setTimeout(function(){a.WindowManager.currently_loaded=null},50)},onPopupDestroy:a.delegate(function(){f.popup=null;f.activitiesItemsCache=null;this.mentionListen=false},this)},content:a.create("DIV",{children:[f.generatePopupContent()]})});f.popup.show();f.inputElement=this},c),100)}}}if(!b){return a.PreventDefault(g)}};a.Bizproc.Selector.extractMenuItem=function(f,c,e){var b=[];var d;for(d in c){if(!c.hasOwnProperty(d)){continue}b.push({text:c[d].Name,value:"{="+e+":"+d+"}"})}return this.filterItems(b,f)};a.Bizproc.Selector.filterItems=function(d,f){var b=[],e;f=f?f.toLowerCase():"";var c=f&&a.correctText?a.correctText(f,{replace_way:"AUTO",mixed:true}).toLowerCase():"";for(e=0;e<d.length;++e){if(!f||d[e].text.toLowerCase().indexOf(f)>=0||d[e].value.toLowerCase().indexOf(f)>=0||d[e].text.toLowerCase().indexOf(c)>=0||d[e].value.toLowerCase().indexOf(c)>=0){b.push(d[e])}}return b};a.Bizproc.Selector.updateCurrentData=function(d){var b=[];if(a.util.object_keys(arWorkflowParameters).length>0){b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_PARAMETERS"),tabId:"parameters",items:this.extractMenuItem(d,arWorkflowParameters,"Template")})}if(a.util.object_keys(arWorkflowVariables).length>0){b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_VARIABLES"),tabId:"variables",items:this.extractMenuItem(d,arWorkflowVariables,"Variable")})}if(a.util.object_keys(arWorkflowConstants).length>0){b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_CONSTANTS"),tabId:"constants",items:this.extractMenuItem(d,arWorkflowConstants,"Constant")})}if(typeof arDocumentFields!=="undefined"){b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_DOCUMENT"),tabId:"document",items:this.extractMenuItem(d,arDocumentFields,"Document")})}var c=this.getActivitiesItems();if(c.length>0){b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_ACTIVITIES"),tabId:"activities",items:this.filterItems(c,d)})}b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_SYSTEM"),tabId:"system",items:this.filterItems([{text:a.message("BIZPROC_JS_BP_SELECTOR_WORKFLOW_ID"),value:"{=Workflow:ID}"},{text:a.message("BIZPROC_JS_BP_SELECTOR_TARGET_USER"),value:"{=Template:TargetUser}"},{text:a.message("BIZPROC_JS_BP_SELECTOR_USER_ID"),value:"{=User:ID}"},{text:a.message("BIZPROC_JS_BP_SELECTOR_NOW"),value:"{=System:Now}"},{text:a.message("BIZPROC_JS_BP_SELECTOR_NOW_LOCAL"),value:"{=System:NowLocal}"},{text:a.message("BIZPROC_JS_BP_SELECTOR_DATE"),value:"{=System:Date}"}],d)});b.push({tabName:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTIONS"),tabId:"functions",items:this.filterItems([{text:"abs",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_ABS_DESCRIPTION"),value:"{{=abs()}}",cursorPosition:7},{text:"dateadd",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_DATEADD_DESCRIPTION"),value:"{{=dateadd(,)}}",cursorPosition:11},{text:"datediff",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_DATEDIFF_DESCRIPTION"),value:"{{=datediff(,,)}}",cursorPosition:12},{text:"if",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_IF_DESCRIPTION"),value:"{{=if(,,)}}",cursorPosition:6},{text:"intval",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_INTVAL_DESCRIPTION"),value:"{{=intval()}}",cursorPosition:10},{text:"floatval",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_FLOATVAL_DESCRIPTION"),value:"{{=floatval()}}",cursorPosition:12},{text:"min",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_MIN_DESCRIPTION"),value:"{{=min(,)}}",cursorPosition:7},{text:"max",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_MAX_DESCRIPTION"),value:"{{=max(,)}}",cursorPosition:7},{text:"rand",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_RAND_DESCRIPTION"),value:"{{=rand(,)}}",cursorPosition:8},{text:"round",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_ROUND_DESCRIPTION"),value:"{{=round(,)}}",cursorPosition:9},{text:"ceil",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_CEIL_DESCRIPTION"),value:"{{=ceil()}}",cursorPosition:8},{text:"floor",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_FLOOR_DESCRIPTION"),value:"{{=floor()}}",cursorPosition:9},{text:"substr",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_SUBSTR_DESCRIPTION"),value:"{{=substr(,,)}}",cursorPosition:10},{text:"strpos",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_STRPOS_DESCRIPTION"),value:"{{=strpos(,)}}",cursorPosition:10},{text:"merge",description:a.message("BIZPROC_JS_BP_SELECTOR_FUNCTION_MERGE_DESCRIPTION"),value:"{{=merge(,)}}",cursorPosition:9}],d)});this.currentData=b;return b};a.Bizproc.Selector.generatePopupContent=function(j){var b=a.create("DIV",{attrs:{className:"bp-selector-popup"}});var d=a.create("UL",{attrs:{className:"bp-selector-tabs"}});var h=a.create("UL",{attrs:{className:"bp-selector-list"}});b.appendChild(d);b.appendChild(h);var g=this.updateCurrentData(j);var c,e,f=this;for(c=0;c<g.length;++c){e=a.create("LI",{attrs:{className:"bp-selector-tab"},html:g[c].tabName+' (<span class="counter-value">'+g[c].items.length+"</span>)"});e.setAttribute("data-tab-id",g[c].tabId);e.setAttribute("hidefocus","true");if(!this.selectedTab&&c===0||this.selectedTab==g[c].tabId){a.addClass(e,"selected");this.updateList(h,g[c].items)}a.bind(e,"click",function(i){f.selectTab(this);a.focus(f.inputElement);return a.PreventDefault(i)});d.appendChild(e)}return b};a.Bizproc.Selector.updatePopupContent=function(j){var h=this.getListElement();var e,c,b,g=this.updateCurrentData(j);var f=this.getTabsCounters();var d=this.getTabsElements();for(e=0;e<d.length;++e){c=d[e].getAttribute("data-tab-id");b=a.findChild(d[e],{className:"counter-value"});b.innerHTML=f[c]||0;if(a.hasClass(d[e],"selected")){this.updateList(h,this.getTabItems(c))}}};a.Bizproc.Selector.SelectNextTab=function(j){var g,c,e,f,b,d=this.getTabsElements();for(e=0,f=d.length;e<f;++e){g=a.hasClass(d[e],"selected");if(g&&j<0){b=e-1>=0?e-1:f-1;a.removeClass(d[e],"selected");a.addClass(d[b],"selected");c=d[b].getAttribute("data-tab-id");break}if(g&&j>0){b=e+1<=f-1?e+1:0;a.removeClass(d[e],"selected");a.addClass(d[b],"selected");c=d[b].getAttribute("data-tab-id");break}}var h=this.getListElement();this.updateList(h,this.getTabItems(c));this.selectedTab=c};a.Bizproc.Selector.selectTab=function(d){var e=this.getListElement();var c=this.getTabsElements();for(var b=0;b<c.length;++b){if(c[b]==d){a.addClass(d,"selected");this.updateList(e,this.getTabItems(d.getAttribute("data-tab-id")))}else{a.removeClass(c[b],"selected")}}this.selectedTab=d.getAttribute("data-tab-id")};a.Bizproc.Selector.SelectNextItem=function(h){var g=this.getListElement();var f,d,e,b=0,c=a.findChildren(g,{className:"bp-selector-item"},true);for(d=0,e=c.length;d<e;++d){f=a.hasClass(c[d],"bp-selector-item-selected");if(f&&h<0){b=d-1>=0?d-1:e-1;a.removeClass(c[d],"bp-selector-item-selected");a.addClass(c[b],"bp-selector-item-selected");break}if(f&&h>0){b=d+1<=e-1?d+1:0;a.removeClass(c[d],"bp-selector-item-selected");a.addClass(c[b],"bp-selector-item-selected");break}}this.fixListScroll(g,c[b])};a.Bizproc.Selector.updateList=function(g,b){a.cleanNode(g);var c,f,d,e=this;if(b.length===0){d=a.create("LI",{html:a.message("BIZPROC_JS_BP_SELECTOR_EMPTY_LIST")});a.addClass(d,"bp-selector-item-empty");g.appendChild(d)}for(c=0;c<b.length;++c){f=b[c];d=a.create("LI",{html:a.util.htmlspecialchars(f.text)+(f.description?'<span class="bp-selector-item-description"> '+a.util.htmlspecialchars(f.description)+"</span>":"")});d.setAttribute("data-value",f.value);d.setAttribute("data-cursor-position",f.cursorPosition||"");d.setAttribute("hidefocus","true");a.addClass(d,"bp-selector-item");if(c===0){a.addClass(d,"bp-selector-item-selected")}a.bind(d,"click",function(h){e.insertItemValue(this,h.shiftKey===true);if(h.shiftKey!==true){e.closePopup()}a.focus(e.inputElement);return a.PreventDefault(h)});g.appendChild(d)}g.scrollTop=0};a.Bizproc.Selector.fixListScroll=function(e,d){var c=a.pos(e);var b=a.pos(d);if(b.bottom>c.bottom||b.top<c.top){e.scrollTop+=(b.bottom>c.bottom?(b.bottom-c.bottom):(b.top-c.top))}}})();