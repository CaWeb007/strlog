BX.namespace("BX.Bizproc");if(typeof BX.Bizproc.doInlineTask==="undefined"){BX.Bizproc.doInlineTask=function(b,c,a){if(a){if(a.__waiting){return false}a.__waiting=true;if(BX.hasClass(a,"bp-button")){BX.addClass(a,"bp-button-wait")}}if(!b||!b.TASK_ID){return false}b.sessid=BX.bitrix_sessid();BX.ajax({method:"POST",dataType:"json",url:"/bitrix/tools/bizproc_do_task_ajax.php",data:b,onsuccess:function(d){if(d.ERROR){window.alert(d.ERROR)}if(a){a.__waiting=false;BX.removeClass(a,"bp-button-wait")}if(d.SUCCESS&&c){c(arguments)}}});return false};BX.Bizproc.taskPopupInstance=null;BX.Bizproc.taskPopupCallback=null;BX.Bizproc.showTaskPopup=function(c,e,b,d,a){if(d){if(d.__waiting){return false}d.__waiting=true;if(BX.hasClass(d,"bp-button")){BX.addClass(d,"bp-button-wait")}}BX.Bizproc.taskPopupInstance=null;BX.Bizproc.taskPopupCallback=null;BX.ajax({method:"GET",dataType:"html",url:"/bitrix/components/bitrix/bizproc.task/popup.php?site_id="+BX.message("SITE_ID")+"&TASK_ID="+c+(b?"&USER_ID="+b:"")+(a?"&IFRAME=Y":""),onsuccess:function(h){if(d){d.__waiting=false;BX.removeClass(d,"bp-button-wait")}var i=BX.create("div",{style:{width:"800px"}});i.innerHTML=h;var g="",f=BX.findChild(i,{className:"bp-popup-title"},true);if(f){g=f.textContent;BX.remove(f)}BX.Bizproc.taskPopupInstance=new BX.PopupWindow("bp-task-popup-"+c+Math.round(Math.random()*100000),null,{content:i,closeIcon:true,titleBar:g,contentColor:"white",contentNoPaddings:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(j){j.destroy();if(BX.Bizproc.delegationPopup){BX.Bizproc.delegationPopup.destroy()}BX.Bizproc.delegationPopup=null}}});BX.Bizproc.taskPopupCallback=e;BX.load(["/bitrix/components/bitrix/bizproc.task/templates/.default/style.css"],function(){BX.Bizproc.taskPopupInstance.show()})}});return false};BX.Bizproc.delegationPopup=null;BX.Bizproc.delegationSelected=null;BX.Bizproc.showDelegationPopup=function(c,b,a){if(BX.Bizproc.delegationPopup){BX.Bizproc.delegationPopup.show();return false}BX.ajax({method:"GET",dataType:"html",url:"/bitrix/components/bitrix/bizproc.task/delegate.php?SITE_ID="+BX.message("SITE_ID")+"&sessid="+BX.bitrix_sessid(),onsuccess:function(d){BX.Bizproc.delegationSelected=null;BX.Bizproc.delegationPopup=new BX.PopupWindow("bp-task-delegation-"+Math.round(Math.random()*100000),c,{content:d,lightShadow:true,offsetTop:3,zIndex:0,autoHide:true,closeByEsc:true,bindOptions:{forceBindPosition:true},angle:{position:"top",offset:20},buttons:[new BX.PopupWindowButton({text:BX.message("BPAT_DELEGATE_SELECT"),className:"popup-window-button-accept",events:{click:function(f){BX.Bizproc.delegateTask(b,a,BX.Bizproc.delegationSelected);BX.Bizproc.delegationPopup.close()}}}),new BX.PopupWindowButtonLink({text:BX.message("BPAT_DELEGATE_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(f){if(!f){f=window.event}BX.Bizproc.delegationPopup.close();if(f){BX.PreventDefault(f)}}}})]});BX.Bizproc.delegationPopup.show()}});return false};BX.Bizproc.delegationOnSelect=function(a){BX.Bizproc.delegationSelected=a.id};BX.Bizproc.delegateTask=function(b,a,d){var c={SITE_ID:BX.message("SITE_ID"),action:"delegate",sessid:BX.bitrix_sessid(),task_id:b,from_user_id:a,to_user_id:d};BX.ajax({action:"delegate",method:"POST",dataType:"json",url:"/bitrix/components/bitrix/bizproc.task/delegate.php",data:c,onsuccess:function(e){window.alert(e.message);if(e.success){if(!!BX.Bizproc.taskPopupInstance){BX.Bizproc.taskPopupInstance.close()}if(BX.Bizproc.taskPopupCallback){BX.Bizproc.taskPopupCallback()}else{window.location.reload()}}}})};BX.Bizproc.showWorkflowInfoPopup=function(a){BX.ajax({method:"GET",dataType:"html",url:"/bitrix/components/bitrix/bizproc.workflow.info/popup.php?site_id="+BX.message("SITE_ID")+"&WORKFLOW_ID="+a,onsuccess:function(b){BX.load(["/bitrix/components/bitrix/bizproc.workflow.info/templates/.default/style.css"],function(){var f=BX.create("div",{style:{width:"800px"}});f.innerHTML=b;var e="",d=BX.findChild(f,{className:"bp-popup-title"},true);if(d){e=d.textContent;BX.remove(d)}var c=new BX.PopupWindow("bp-wfi-popup-"+a+Math.round(Math.random()*100000),null,{content:f,closeIcon:true,titleBar:e,contentColor:"white",contentNoPaddings:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(g){g.destroy()}}});c.show()})}});return false};BX.Bizproc.showWorkflowLogPopup=function(b,a){if(!BX.type.isPlainObject(a)){a={}}BX.ajax({method:"GET",dataType:"html",url:"/bitrix/components/bitrix/bizproc.log/popup.php?site_id="+BX.message("SITE_ID")+"&WORKFLOW_ID="+b,onsuccess:function(d){var e=BX.create("div",{style:{width:"800px"}});e.innerHTML=d;var c=new BX.PopupWindow("bp-wfi-popup-"+b+Math.round(Math.random()*100000),null,{content:e,closeIcon:true,titleBar:a.title||"",contentColor:"white",contentNoPaddings:true,zIndex:-100,offsetLeft:0,offsetTop:0,closeByEsc:true,draggable:{restrict:false},overlay:{backgroundColor:"black",opacity:30},events:{onPopupClose:function(f){f.destroy()}}});c.show()}});return false};BX.Bizproc.postTaskForm=function(f,h){if(f.BPRUNNING){return}BX.PreventDefault(h);f.action="/bitrix/tools/bizproc_do_task_ajax.php";f.BPRUNNING=true;var a,g,c=document.activeElement;if((!c||!c.type)&&h.explicitOriginalTarget){c=h.explicitOriginalTarget}if(!!c&&c.type&&c.type.toLowerCase()=="submit"&&!!c.name&&!!c.value){a=c.name;g=c.value}if(!f.target){if(null==f.BXFormTarget){var b="formTarget_"+Math.random();f.BXFormTarget=document.body.appendChild(BX.create("IFRAME",{props:{name:b,id:b,src:"javascript:void(0)"},style:{display:"none"}}))}f.target=f.BXFormTarget.name}var d=null;if(a){d=BX.findChild(f,{property:{type:"submit",name:a}},true)}if(d){BX.addClass(d,"bp-button-wait")}f.BXFormCallback=function(e){f.BPRUNNING=false;if(d){BX.removeClass(d,"bp-button-wait")}e=BX.parseJSON(e);if(e&&e.ERROR){window.alert(e.ERROR)}else{if(!!BX.Bizproc.taskPopupInstance){BX.Bizproc.taskPopupInstance.close()}if(!!BX.Bizproc.taskPopupCallback){BX.Bizproc.taskPopupCallback()}}};BX.bind(f.BXFormTarget,"load",BX.proxy(BX.ajax._submit_callback,f));BX.submit(f,a,g)}}if(typeof BX.Bizproc.WorkflowFaces==="undefined"){BX.Bizproc.WorkflowFaces={};BX.Bizproc.WorkflowFaces.showFaces=function(d,b,c,a){if(typeof b.__popup==="undefined"){b.__popup=new BX.PopupWindow("bp-wf-faces-"+Math.round(Math.random()*100000),b,{lightShadow:true,offsetLeft:-51,offsetTop:3,zIndex:0,autoHide:true,closeByEsc:true,bindOptions:{position:"bottom"},angle:{position:"top",offset:78},content:BX.Bizproc.WorkflowFaces.createMenu(d,c,a)})}if(b.__popup.isShown()){b.__popup.close()}else{b.__popup.show()}return false};BX.Bizproc.WorkflowFaces.createMenu=function(h,a,n){var j,f,q=h.length,d;var g=[];for(j=0;j<q;++j){var p,b=h[j],c=[];for(f=0,d=b.USERS.length;f<d;++f){p="bp-popup-parallel-avatar-ready";if(b.USERS[f].STATUS=="0"){p=""}else{if(b.USERS[f].STATUS=="2"||b.USERS[f].STATUS=="4"){p="bp-popup-parallel-avatar-cancel"}}var m=["<a>",'<span class="bp-popup-parallel-avatar '+p+'"><span>'+(b.USERS[f].PHOTO_SRC?'<img src="'+b.USERS[f].PHOTO_SRC+'" alt="">':"")+"</span></span>",'<span class="bp-popup-parallel-name" title="'+b.USERS[f].FULL_NAME+'">'+b.USERS[f].FULL_NAME+"</span>","</a>"];c.push(m.join(""))}var e=c.join("");if(q==1&&!n){g.push(e)}else{p="bp-popup-parallel-avatar-ready";if(b.USERS[0].STATUS=="0"){p=""}else{if(b.USERS[0].STATUS=="2"||b.USERS[0].STATUS=="4"){p="bp-popup-parallel-avatar-cancel"}}var o=['<a class="'+(c.length>1||a?"bp-popup-parallel-parent":"")+'">',!a?'<span class="bp-popup-parallel-avatar '+p+'"><span>'+(b.USERS[0].PHOTO_SRC?'<img src="'+b.USERS[0].PHOTO_SRC+'" alt="">':"")+"</span></span>":"",'<span class="bp-popup-parallel-name" title="'+b.NAME+'">'+(!a?b.USERS[0].FULL_NAME:b.NAME)+"</span>","</a>"];g.push('<div class="bp-popup-parallel-sub">'+o.join("")+(c.length>1||a?'<div class="bp-popup-parallel">'+e+"</div></div>":""))}}return'<div class="bp-popup-parallel">'+g.join("")+"</div>"}};