(function(){BX.namespace("BX.Bizproc");if(BX.Bizproc.Starter){return}var a=0;var e=function(){window.alert(BX.message("BIZPROC_JS_BP_STARTER_REQUEST_FAILURE"))};var b={instances:[],put:function(g){this.instances.push(g);return this},findSimilar:function(k){var g=[k];for(var j=0;j<this.instances.length;++j){var h=this.instances[j];if(h!==k&&h.moduleId===k.moduleId&&h.entity===k.entity&&h.documentType===k.documentType){g.push(h)}}return g},fireEvent:function(l,j,h){var k=this.findSimilar(l);for(var g=0;g<k.length;++g){BX.onCustomEvent(k[g],j,h)}}};var d=function(g){this.id=++a;this.templates=g.templates||null;this.moduleId=g.moduleId;this.entity=g.entity;this.documentType=g.documentType;this.documentId=g.documentId;this.ajaxUrl=g.ajaxUrl||"/bitrix/components/bitrix/bizproc.workflow.start/ajax.php";b.put(this)};d.singleStart=function(h,g){var i=new d(h);if(BX.type.isFunction(g)){BX.addCustomEvent(i,"onAfterStartWorkflow",g)}if(h.hasParameters){i.showParametersPopup(h.templateId,{title:h.templateName})}else{i.startWorkflow(h.templateId)}};d.prototype={showTemplatesMenu:function(g){if(this.templates===null){this.loadTemplates(this.showTemplatesPopupMenu.bind(this,g))}else{this.showTemplatesPopupMenu(g)}},showTemplatesPopupMenu:function(g){var n=this,j,m,l,h=[];var k=function(o,i){this.popupWindow.close();o.preventDefault();n.onTemplateMenuItemClick(i.template)};for(j=0;j<this.templates.length;++j){m=this.templates[j];l={text:m.name,template:m,title:m.description,onclick:k};h.push(l)}if(!h.length){this.showEmptyTemplatesHint(g)}else{BX.PopupMenu.show("bp-starter-tpl-menu-"+this.id,g,h,{zIndex:200,autoHide:true})}},showEmptyTemplatesHint:function(h){var i=BX.message("BIZPROC_JS_BP_STARTER_NO_TEMPLATES");var g=new BX.PopupWindow("bp-starter-tpl-empty"+this.id,h,{lightShadow:true,autoHide:true,darkMode:true,offsetLeft:40,angle:{position:"top",offset:40},bindOptions:{position:"bottom"},zIndex:1100,events:{onPopupClose:function(){this.destroy()}},content:BX.create("div",{attrs:{style:"padding-right: 5px; width: 200px;"},text:i})});g.show()},loadTemplates:function(h){var g=this;this.callAction("get_templates",{},function(i){g.templates=i.templates;h(i)})},onTemplateMenuItemClick:function(g){if(!g.hasParameters){this.startWorkflow(g.id)}else{this.showParametersPopup(g.id,{title:g.name})}},startWorkflow:function(g){var h=this;this.callAction("start_workflow",{template_id:g},function(i){b.fireEvent(h,"onAfterStartWorkflow",i)})},showParametersPopup:function(g,i){var h=this;if(!BX.type.isPlainObject(i)){i={}}this.loadParametersHtml({template_id:g},function(k){var j,o=BX.create("div",{html:k});var m=o.querySelector('[data-role="bizproc-start-form"]');h.prepareParametersForm(m,g);var l=m.querySelector('[data-role="bizproc-form-buttons"]');if(l){BX.remove(l)}var n=new f(m);n.init();j=new BX.PopupWindow("bp-starter-parameters-popup-"+h.id,null,{content:o,width:600,closeIcon:true,titleBar:i.title||"",closeByEsc:true,draggable:{restrict:false},events:{onPopupClose:function(p){p.destroy()}},buttons:[new BX.PopupWindowButton({text:BX.message("BIZPROC_JS_BP_STARTER_START"),className:"popup-window-button-accept",events:{click:function(p){BX.fireEvent(m,"submit")}}}),new BX.PopupWindowButtonLink({text:BX.message("BIZPROC_JS_BP_STARTER_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(p){j.close()}}})]});BX.bind(m,"submit",function(p){p.preventDefault();h.submitParametersForm(m,function(q){j.close();b.fireEvent(h,"onAfterStartWorkflow",q)})});j.show()})},showAutoStartParametersPopup:function(h,j){var i=this;if(!BX.type.isPlainObject(j)){j={}}var g=function(l){var o;if(BX.type.isDomNode(l)){o=l.firstChild}else{o=BX.create("div",{html:l})}var m=o.querySelector('[data-role="bizproc-start-form"]');i.prepareParametersForm(m,null,"check_parameters");var n=new f(m);n.init();var k=new BX.PopupWindow("bp-starter-parameters-popup-"+i.id,null,{content:o,width:600,closeIcon:true,titleBar:j.title||BX.message("BIZPROC_JS_BP_STARTER_AUTOSTART"),closeByEsc:true,draggable:{restrict:false},events:{onPopupClose:function(p){p.destroy()}},buttons:[new BX.PopupWindowButton({text:BX.message("BIZPROC_JS_BP_STARTER_SAVE"),className:"popup-window-button-accept",events:{click:function(p){BX.fireEvent(m,"submit")}}}),new BX.PopupWindowButtonLink({text:BX.message("BIZPROC_JS_BP_STARTER_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(p){k.close()}}})]});BX.bind(m,"submit",function(p){p.preventDefault();i.submitParametersForm(m,function(q){k.close();if(j.callback){j.callback(q)}})});k.show()};if(j.contentNode){g(j.contentNode)}else{this.loadParametersHtml({auto_execute_type:h},g.bind(this))}},loadParametersHtml:function(g,h){g.sessid=BX.bitrix_sessid();g.site_id=BX.message("SITE_ID");g.module_id=this.moduleId;g.entity=this.entity;g.document_type=this.documentType;if(this.documentId){g.document_id=this.documentId}BX.ajax({method:"POST",dataType:"html",url:"/bitrix/components/bitrix/bizproc.workflow.start/popup.php",data:g,onsuccess:function(i){h(i)},onfailure:e})},prepareParametersForm:function(h,g,i){if(g){h.appendChild(BX.create("input",{attrs:{type:"hidden",name:"template_id",value:g}}))}h.appendChild(BX.create("input",{attrs:{type:"hidden",name:"module_id",value:this.moduleId}}));h.appendChild(BX.create("input",{attrs:{type:"hidden",name:"entity",value:this.entity}}));h.appendChild(BX.create("input",{attrs:{type:"hidden",name:"ajax_action",value:i?i:"start_workflow"}}));h.action=this.ajaxUrl},submitParametersForm:function(g,i){var h=new FormData(g);BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:h,preparePost:false,onsuccess:function(j){if(j.success){if(i){i(j.data)}}else{window.alert(j.errors.join("\n"))}},onfailure:e})},callAction:function(g,h,i){h.sessid=BX.bitrix_sessid();h.site=BX.message("SITE_ID");h.ajax_action=g;h.module_id=this.moduleId;h.entity=this.entity;h.document_type=this.documentType;h.document_id=this.documentId;BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:h,onsuccess:function(j){if(j.success){i(j.data,j)}else{window.alert(j.errors.join("\n"))}},onfailure:e})}};BX.Bizproc.Starter=d;var f=function(h,g){this.node=h;this.config=g||{}};f.prototype={init:function(){this.replaceControls()},replaceControls:function(){var j;if(c.canUse()){var h=this.node.querySelectorAll(".bizproc-modern-type-control-wrapper-user");for(j=0;j<h.length;++j){this.replaceUserControl(h[j])}}var g=this.node.querySelectorAll(".bizproc-modern-type-control-wrapper-file");for(j=0;j<g.length;++j){this.replaceFileControl(g[j])}},replaceUserControl:function(g){var i={};var h=g.querySelector(".bizproc-modern-type-control");i.valueInputName=h.name;i.multiple=BX.hasClass(h,"bizproc-modern-type-control-multiple");i.required=BX.hasClass(h,"bizproc-modern-type-control-required");BX.cleanNode(g);new c(this,g,i)},replaceFileControl:function(g){var h=g.querySelector(".bizproc-modern-type-control");var k=BX.hasClass(h,"bizproc-modern-type-control-multiple");var i=k?h.name.replace("[n0]","[]"):h.name;BX.cleanNode(g);g.appendChild(this.createFileControlNode(i));if(k){var j=BX.create("span",{attrs:{className:"webform-small-button webform-small-button-accept bizproc-modern-type-control-file-clone-button"},text:BX.message("BIZPROC_JS_BP_STARTER_CONTROL_CLONE"),events:{click:this.cloneFileControl.bind(this,g,i)}});g.appendChild(j)}},createFileControlNode:function(i){var g=BX.create("input",{props:{type:"file",name:i}});var j=BX.create("span",{attrs:{className:"bizproc-modern-type-control-button"},children:[BX.create("span",{attrs:{className:"webform-small-button"},text:BX.message("BIZPROC_JS_BP_STARTER_FILE_CHOOSE")}),g]});var h=BX.create("span",{attrs:{className:"bizproc-modern-type-control-file-value-name"}});BX.bind(g,"change",function(){h.textContent=this.parseFileLabel(g.value)}.bind(this));return BX.create("div",{children:[j,h],attrs:{className:"bizproc-modern-type-control-file-replaced"}})},cloneFileControl:function(g,h){g.insertBefore(this.createFileControlNode(h),g.lastChild)},parseFileLabel:function(h){var g;if(h.lastIndexOf("\\")){g=h.lastIndexOf("\\")+1}else{g=h.lastIndexOf("/")+1}return h.slice(g)},getAjaxUrl:function(){return this.config.ajaxUrl||"/bitrix/components/bitrix/bizproc.workflow.start/ajax.php"}};var c=function(i,g,h){var j=this;this.container=g;this.itemsNode=BX.create("span");this.inputBoxNode=BX.create("span",{attrs:{className:"feed-add-destination-input-box"}});this.inputNode=BX.create("input",{props:{type:"text"},attrs:{className:"feed-add-destination-inp"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=BX.create("a",{attrs:{className:"feed-add-destination-link"}});BX.addClass(g,"bizproc-modern-destination");g.appendChild(this.itemsNode);g.appendChild(this.inputBoxNode);g.appendChild(this.tagNode);this.component=i;this.data=null;this.dialogId=BX.util.getRandomString(7);this.createValueNode(h.valueInputName||"");this.selected=h.selected?BX.clone(h.selected):[];this.selectOne=!h.multiple;this.required=h.required||false;BX.bind(this.tagNode,"focus",function(k){j.openDialog({bByFocusEvent:true});return BX.PreventDefault(k)});BX.bind(this.container,"click",function(k){j.openDialog();return BX.PreventDefault(k)});this.addItems(this.selected);this.tagNode.innerHTML=(this.selected.length<=0?BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_CHOOSE"):BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_EDIT"))};c.canUse=function(){return !!BX.SocNetLogDestination};c.prototype={getData:function(g){var h=this;if(h.ajaxProgress){return}h.ajaxProgress=true;BX.ajax({method:"POST",dataType:"json",url:h.component.getAjaxUrl(),data:{ajax_action:"get_destination_data",sessid:BX.bitrix_sessid(),site:BX.message("SITE_ID")},onsuccess:function(i){h.data=i.data||{};h.ajaxProgress=false;h.initDialog(g)}})},initDialog:function(n){var m,r=this,l=this.data;if(!l){r.getData(n);return}var j={};for(m=0;m<r.selected.length;++m){j[r.selected[m].id]=r.selected[m].entityType}var p={users:l.USERS||{},department:l.DEPARTMENT||{},departmentRelation:l.DEPARTMENT_RELATION||{}};var h={users:l.LAST.USERS||{}};if(!p.departmentRelation){p.departmentRelation=BX.SocNetLogDestination.buildDepartmentRelation(p.department)}if(!r.inited){r.inited=true;var g=r.inputNode;g.id=r.dialogId+"input";var q=r.inputBoxNode;q.id=r.dialogId+"input-box";var k=this.tagNode;k.id=this.dialogId+"tag";var o=r.itemsNode;BX.SocNetLogDestination.init({name:r.dialogId,searchInput:g,extranetUser:false,bindMainPopup:{node:r.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:r.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,callback:{select:function(u,t,s,i){r.addItem(u,t);if(r.selectOne){BX.SocNetLogDestination.closeDialog()}},unSelect:function(i){if(r.selectOne){return}r.unsetValue(i.entityId);BX.SocNetLogDestination.BXfpUnSelectCallback.call({formName:r.dialogId,inputContainerName:o,inputName:g.id,tagInputName:k.id,tagLink1:BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_CHOOSE"),tagLink2:BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_EDIT")},i)},openDialog:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:q.id,inputName:g.id,tagInputName:k.id}),closeDialog:BX.delegate(BX.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:q.id,inputName:g.id,tagInputName:k.id}),openSearch:BX.delegate(BX.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:q.id,inputName:g.id,tagInputName:k.id}),closeSearch:BX.delegate(BX.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:q.id,inputName:g.id,tagInputName:k.id})},items:p,itemsLast:h,itemsSelected:j,useClientDatabase:false,destSort:l.DEST_SORT||{},allowAddUser:false});BX.bind(g,"keyup",BX.delegate(BX.SocNetLogDestination.BXfpSearch,{formName:r.dialogId,inputName:g.id,tagInputName:k.id}));BX.bind(g,"keydown",BX.delegate(BX.SocNetLogDestination.BXfpSearchBefore,{formName:r.dialogId,inputName:g.id}));BX.SocNetLogDestination.BXfpSetLinkName({formName:r.dialogId,tagInputName:k.id,tagLink1:BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_CHOOSE"),tagLink2:BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_EDIT")})}n()},addItem:function(p,o){var n=this;var g=this.inputNode;var k=this.tagNode;var m=this.itemsNode;if(!BX.findChild(m,{attr:{"data-id":p.id}},false,false)){if(n.selectOne&&n.inited){var j=[];for(var l=0;l<m.childNodes.length;++l){j.push({itemId:m.childNodes[l].getAttribute("data-id"),itemType:m.childNodes[l].getAttribute("data-type")})}n.initDialog(function(){for(var q=0;q<j.length;++q){BX.SocNetLogDestination.deleteItem(j[q].itemId,j[q].itemType,n.dialogId)}});BX.cleanNode(m);n.cleanValue()}var h=this.createItemNode({text:p.name,deleteEvents:{click:function(i){if(n.selectOne&&n.required){n.openDialog()}else{n.initDialog(function(){BX.SocNetLogDestination.deleteItem(p.id,o,n.dialogId);BX.remove(h);n.unsetValue(p.entityId)})}BX.PreventDefault(i)}}});this.setValue(p.entityId);h.setAttribute("data-id",p.id);h.setAttribute("data-type",o);m.appendChild(h);if(!p.entityType){p.entityType=o}}g.value="";k.innerHTML=BX.message("BIZPROC_JS_BP_STARTER_DESTINATION_EDIT")},addItems:function(g){for(var h=0;h<g.length;++h){this.addItem(g[h],g[h].entityType)}},openDialog:function(h){var g=this;this.initDialog(function(){BX.SocNetLogDestination.openDialog(g.dialogId,h)})},destroy:function(){if(this.inited){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()}},createItemNode:function(g){return BX.create("span",{attrs:{className:"bizproc-modern-destination-item"},children:[BX.create("span",{attrs:{className:"bizproc-modern-destination-name"},html:g.text||""}),BX.create("span",{attrs:{className:"bizproc-modern-destination-delete"},events:g.deleteEvents})]})},createValueNode:function(g){this.valueNode=BX.create("input",{props:{type:"hidden",name:g}});this.container.appendChild(this.valueNode)},setValue:function(k){if(/^\d+$/.test(k)){k="["+k+"]"}if(this.selectOne){this.valueNode.value=k}else{var h,g=[],j=this.valueNode.value.split(";");for(h=0;h<j.length;++h){if(!j[h]||k==j[h]){continue}g.push(j[h])}g.push(k);this.valueNode.value=g.join(";")}},unsetValue:function(k){if(/^\d+$/.test(k)){k="["+k+"]"}if(this.selectOne){this.valueNode.value=""}else{var h,g=[],j=this.valueNode.value.split(";");for(h=0;h<j.length;++h){if(!j[h]||k==j[h]){continue}g.push(j[h])}this.valueNode.value=g.join(";")}},cleanValue:function(){this.valueNode.value=""}}})();