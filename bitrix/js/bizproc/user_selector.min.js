BX.namespace("BX.Bizproc");BX.Bizproc.UserSelector=(function(b){var a=function(c){this.id="bp-user-selector-"+b.util.getRandomString(7);this.bindTo=c.bindTo;this.selected={};if(c.selected){for(var d=0;d<c.selected.length;++d){this.selected[c.selected[d].id]="user"}}this.addCallback=c.addCallback;this.parentPopup=c.parentPopup;this.bind()};a.canUse=function(){return !!b.SocNetLogDestination};a.loadData=function(c){if(!this.data){var d=this;b.ajax({method:"POST",dataType:"json",url:"/bitrix/tools/bizproc/user_selector.php",data:{ajax_action:"get_destination_data",sessid:b.bitrix_sessid(),site:b.message("SITE_ID")},onsuccess:function(e){d.data=e.data||{};if(c){c()}}})}else{if(c){c()}}};a.prototype={bind:function(){b.bind(this.bindTo,"click",this.onBindClick.bind(this));if(this.parentPopup){b.addCustomEvent(this.parentPopup,"onPopupClose",this.onParentPopupClose.bind(this))}},initDialog:function(){if(!a.canUse()){return false}if(this.inited){return true}var c={users:a.data.users||{},department:a.data.department||{},departmentRelation:a.data.departmentRelation||{}};var e={users:a.data.last.USERS||{}};if(!c.departmentRelation){c.departmentRelation=b.SocNetLogDestination.buildDepartmentRelation(c.department)}var d=this.addCallback;b.SocNetLogDestination.init({name:this.id,showSearchInput:true,bindMainPopup:{node:this.bindTo,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:true,sendAjaxSearch:true,allowAddUser:false,extranetUser:false,useClientDatabase:false,items:c,itemsLast:e,itemsSelected:this.selected,destSort:a.data.destSort||{},callback:{select:function(j,i,h,l,g,k){if(k!=="select"){return}var f={id:parseInt(j.entityId),name:b.util.htmlspecialcharsback(j.name),title:b.util.htmlspecialcharsback(j.desc),photo:j.avatar};d(f);b.SocNetLogDestination.closeDialog()}}});return(this.inited=true)},onBindClick:function(){if(this.initDialog()){b.SocNetLogDestination.openDialog(this.id)}},onParentPopupClose:function(){if(this.inited){if(b.SocNetLogDestination.isOpenDialog()){b.SocNetLogDestination.closeDialog()}}}};return a})(window.BX||window.top.BX);