BX.namespace("BX.UI");if(typeof BX.UI.EntityConfigType==="undefined"){BX.UI.EntityConfigType={COLUMN:"column",SECTION:"section",INCLUDED_AREA:"included_area",FIELD:"field"}}if(typeof BX.UI.EntityConfigFactory==="undefined"){BX.UI.EntityConfigFactory={createByType:function(c,b){var a;if(c===BX.UI.EntityConfigType.COLUMN){a=BX.UI.EntityConfigColumn.create(b)}else{if(c===BX.UI.EntityConfigType.SECTION){a=BX.UI.EntityConfigSection.create(b)}else{if(c===BX.UI.EntityConfigType.INCLUDED_AREA){a=BX.UI.EntityConfigIncludedArea.create(b)}else{a=BX.UI.EntityConfigField.create(b)}}}return a}}}if(typeof BX.UI.EntityConfig==="undefined"){BX.UI.EntityConfig=function(){this._id="";this._settings={};this._scope=BX.UI.EntityConfigScope.undefined;this._userScopes=null;this._userScopeId=null;this._enableScopeToggle=true;this._canUpdatePersonalConfiguration=true;this._canUpdateCommonConfiguration=false;this._data={};this._items=[];this._options={};this._isChanged=false;this.categoryName="";this.moduleId=""};BX.UI.EntityConfig.prototype={initialize:function(g,d){this._id=BX.type.isNotEmptyString(g)?g:BX.util.getRandomString(4);this._settings=d?d:{};this._scope=BX.prop.getString(this._settings,"scope",BX.UI.EntityConfigScope.personal);this._userScopes=BX.prop.getObject(this._settings,"userScopes",null);this._userScopeId=BX.prop.getString(this._settings,"userScopeId",null);this.moduleId=BX.prop.getString(this._settings,"moduleId",null);this._enableScopeToggle=BX.prop.getBoolean(this._settings,"enableScopeToggle",true);this._canUpdatePersonalConfiguration=BX.prop.getBoolean(this._settings,"canUpdatePersonalConfiguration",true);this._canUpdateCommonConfiguration=BX.prop.getBoolean(this._settings,"canUpdateCommonConfiguration",false);this._data=BX.prop.getArray(this._settings,"data",[]);this._items=[];for(var b=0,f=this._data.length;b<f;b++){var e=this._data[b];var c=BX.prop.getString(e,"type","");var a=BX.UI.EntityConfigFactory.createByType(c,{data:e});this._items.push(a)}this._options=BX.prop.getObject(this._settings,"options",{});this.categoryName=BX.prop.getString(this._settings,"categoryName","ui.form.editor")},findItemByName:function(a){for(var b=0,d=this._items.length;b<d;b++){var c=this._items[b];if(c.getName()===a){return c}}return null},findItemIndexByName:function(a){for(var b=0,d=this._items.length;b<d;b++){var c=this._items[b];if(c.getName()===a){return b}}return -1},toJSON:function(){var a=[];for(var b=0,c=this._items.length;b<c;b++){a.push(this._items[b].toJSON())}return a},addSchemeElementAt:function(b,a){var c=BX.UI.EntityConfigFactory.createByType(b.getType(),{data:b.createConfigItem()});if(a>=0&&a<this._items.length){this._items.splice(a,0,c)}else{this._items.push(c)}this._isChanged=true},moveSchemeElement:function(c,b){var f=this._items.length;var e=f-1;if(b<0||b>f){b=e}var a=this.findItemIndexByName(c.getName());if(a<0||a===b){return}var d=this._items[a];this._items.splice(a,1);f--;if(b<f){this._items.splice(b,0,d)}else{this._items.push(d)}this._isChanged=true},updateSchemeElement:function(e){var d;var b=e.getParent();if(b&&b.getType()==="section"){var a=this.findItemByName(b.getName());if(a){d=a.findFieldIndexByName(e.getName());if(d>=0){var c=BX.UI.EntityConfigFactory.createByType(BX.UI.EntityConfigType.FIELD,{data:e.createConfigItem()});a.setField(c,d);this._isChanged=true}}}else{d=this.findItemIndexByName(e.getName());if(d>=0){this._items[d]=BX.UI.EntityConfigFactory.createByType(e.getType(),{data:e.createConfigItem()});this._isChanged=true}}},removeSchemeElement:function(b){var a=this.findItemIndexByName(b.getName());if(a<0){return}this._items.splice(a,1);this._isChanged=true},isChangeable:function(){if(this._scope===BX.UI.EntityConfigScope.common||this._scope===BX.UI.EntityConfigScope.custom){return this._canUpdateCommonConfiguration}else{if(this._scope===BX.UI.EntityConfigScope.personal){return this._canUpdatePersonalConfiguration}}return false},isCanChangeCommonConfiguration:function(){return this._canUpdateCommonConfiguration},isChanged:function(){return this._isChanged},isScopeToggleEnabled:function(){return this._enableScopeToggle},getScope:function(){return this._scope},setScope:function(a,c,b){var d=new BX.Promise();if(!this._enableScopeToggle||(this._scope===a&&a!==BX.UI.EntityConfigScope.custom)||(this._scope===a&&this._userScopeId===c)){window.setTimeout(function(){d.fulfill()},0);return d}this._scope=a;this._userScopeId=c;this.moduleId=b;this._data=[];this._items=[];BX.ajax.runComponentAction("bitrix:ui.form.config","setScope",{data:{categoryName:this.categoryName,moduleId:this.moduleId,guid:this._id,scope:this._scope,userScopeId:(this._userScopeId||0)}}).then(function(e){d.fulfill()});return d},registerField:function(a){var b=a.getParent();if(!b){return}var c=this.findItemByName(b.getName());if(!c){return}c.addField(BX.UI.EntityConfigField.create({data:a.createConfigItem()}));this.save()},unregisterField:function(a){var b=a.getParent();if(!b){return}var d=this.findItemByName(b.getName());if(!d){return}var c=d.findFieldByName(a.getName());if(!c){return}d.removeFieldByIndex(c.getIndex());this.save()},save:function(b,a){b=!!b;a=!!a;var d=new BX.Promise();if(!this._isChanged&&!b){window.setTimeout(function(){d.fulfill()},0);return d}var c={guid:this._id,config:this.toJSON(),params:{scope:this._scope},categoryName:this.categoryName};if(a){c.params["options"]=this._options}if(b){c.params["forAllUsers"]="Y";c.params["delete"]="Y"}if(this._scope===BX.UI.EntityConfigScope.custom){c.params["userScopeId"]=this._userScopeId}BX.ajax.runComponentAction("bitrix:ui.form","saveConfiguration",{mode:"ajax",data:c}).then(function(){d.fulfill()});this._isChanged=false;return d},reset:function(a){var b={guid:this._id,params:{scope:this._scope},categoryName:this.categoryName};if(a){b.params["forAllUsers"]="Y"}var c=new BX.Promise();BX.ajax.runComponentAction("bitrix:ui.form","resetConfiguration",{mode:"ajax",data:b}).then(function(){c.fulfill()});return c},forceCommonScopeForAll:function(){var a=new BX.Promise();BX.ajax.runComponentAction("bitrix:ui.form","forceCommonScopeForAll",{mode:"ajax",data:{guid:this._id,categoryName:this.categoryName}}).then(function(){a.fulfill()});return a},getOption:function(b,a){return BX.prop.getString(this._options,b,a)},setOption:function(a,b){if(typeof(b)==="undefined"||b===null){return}if(BX.prop.getString(this._options,a,null)===b){return}this._options[a]=b;if(this._scope===BX.UI.EntityConfigScope.common){BX.userOptions.save(this.categoryName,this._id+"_common_opts",a,b,true)}else{if(this._scope===BX.UI.EntityConfigScope.custom){BX.userOptions.save(this.categoryName,this._id+"_custom_opts_"+this._userScopeId,a,b,true)}else{BX.userOptions.save("crm.entity.editor",this._id+"_opts",a,b,false)}}}};BX.UI.EntityConfig.create=function(c,b){var a=new BX.UI.EntityConfig();a.initialize(c,b);return a}}if(typeof BX.UI.EntityConfigItem==="undefined"){BX.UI.EntityConfigItem=function(){this._settings={};this._data={};this._name="";this._title=""};BX.UI.EntityConfigItem.prototype={initialize:function(a){this._settings=a?a:{};this._data=BX.prop.getObject(this._settings,"data",[]);this._name=BX.prop.getString(this._data,"name","");this._title=BX.prop.getString(this._data,"title","");this.doInitialize()},doInitialize:function(){},getType:function(){return""},getName:function(){return this._name},getTitle:function(){return this._title},toJSON:function(){return{}}}}if(typeof BX.UI.EntityConfigColumn==="undefined"){BX.UI.EntityConfigColumn=function(){BX.UI.EntityConfigColumn.superclass.constructor.apply(this);this._sections=[]};BX.extend(BX.UI.EntityConfigColumn,BX.UI.EntityConfigItem);BX.UI.EntityConfigColumn.prototype.doInitialize=function(){var d=BX.prop.getArray(this._data,"elements",[]);for(var b=0,c=d.length;b<c;b++){if(d[b].type==="section"||d[b].type==="included_area"){var a=BX.UI.EntityConfigFactory.createByType(d[b].type,{data:d[b]});this.addSection(a)}}};BX.UI.EntityConfigColumn.prototype.getType=function(){return BX.UI.EntityConfigType.COLUMN};BX.UI.EntityConfigColumn.prototype.getSections=function(){return this._sections};BX.UI.EntityConfigColumn.prototype.findSectionByName=function(b){var a=this.findSectionIndexByName(b);return a>=0?this._sections[a]:null};BX.UI.EntityConfigColumn.prototype.findSectionIndexByName=function(a){for(var b=0,c=this._sections.length;b<c;b++){var d=this._sections[b];if(d.getName()===a){return b}}return -1};BX.UI.EntityConfigColumn.prototype.findFieldByName=function(b){var a=this.findFieldIndexByName(b);return a>=0?this._sections[a]:null};BX.UI.EntityConfigColumn.prototype.findFieldIndexByName=function(a){for(var b=0,c=this._sections.length;b<c;b++){var d=this._sections[b];if(d.getName()===a){return b}}return -1};BX.UI.EntityConfigColumn.prototype.addSection=function(a){this._sections.push(a)};BX.UI.EntityConfigColumn.prototype.setSection=function(b,a){this._sections[a]=b};BX.UI.EntityConfigColumn.prototype.removeSectionByIndex=function(a){if(a<0||a>=this._sections.length){return false}this._sections.splice(a,1);return true};BX.UI.EntityConfigColumn.prototype.toJSON=function(){var a={name:this._name,type:this.getType(),data:BX.prop.getObject(this._data,"data",{}),elements:[]};for(var b=0,c=this._sections.length;b<c;b++){a.elements.push(this._sections[b].toJSON())}return a};BX.UI.EntityConfigColumn.create=function(b){var a=new BX.UI.EntityConfigColumn();a.initialize(b);return a}}if(typeof BX.UI.EntityConfigSection==="undefined"){BX.UI.EntityConfigSection=function(){BX.UI.EntityConfigSection.superclass.constructor.apply(this);this._fields=[]};BX.extend(BX.UI.EntityConfigSection,BX.UI.EntityConfigItem);BX.UI.EntityConfigSection.prototype.doInitialize=function(){this._fields=[];var c=BX.prop.getArray(this._data,"elements",[]);for(var a=0,b=c.length;a<b;a++){var d=BX.UI.EntityConfigField.create({data:c[a]});d.setIndex(a);this._fields.push(d)}};BX.UI.EntityConfigSection.prototype.getType=function(){return BX.UI.EntityConfigType.SECTION};BX.UI.EntityConfigSection.prototype.getFields=function(){return this._fields};BX.UI.EntityConfigSection.prototype.findFieldByName=function(b){var a=this.findFieldIndexByName(b);return a>=0?this._fields[a]:null};BX.UI.EntityConfigSection.prototype.findFieldIndexByName=function(a){for(var b=0,c=this._fields.length;b<c;b++){var d=this._fields[b];if(d.getName()===a){return b}}return -1};BX.UI.EntityConfigSection.prototype.addField=function(a){this._fields.push(a)};BX.UI.EntityConfigSection.prototype.setField=function(b,a){this._fields[a]=b};BX.UI.EntityConfigSection.prototype.removeFieldByIndex=function(a){var b=this._fields.length;if(a<0||a>=b){return false}this._fields.splice(a,1);return true};BX.UI.EntityConfigSection.prototype.toJSON=function(){var a={name:this._name,title:this._title,type:this.getType(),data:BX.prop.getObject(this._data,"data",{}),elements:[]};for(var b=0,c=this._fields.length;b<c;b++){a.elements.push(this._fields[b].toJSON())}return a};BX.UI.EntityConfigSection.create=function(b){var a=new BX.UI.EntityConfigSection();a.initialize(b);return a}}if(typeof BX.UI.EntityConfigIncludedArea==="undefined"){BX.UI.EntityConfigIncludedArea=function(){BX.UI.EntityConfigIncludedArea.superclass.constructor.apply(this);this._params={}};BX.extend(BX.UI.EntityConfigIncludedArea,BX.UI.EntityConfigItem);BX.UI.EntityConfigIncludedArea.prototype.doInitialize=function(){this._params=BX.prop.getObject(this._data,"data",{})};BX.UI.EntityConfigIncludedArea.prototype.getType=function(){return BX.UI.EntityConfigType.INCLUDED_AREA};BX.UI.EntityConfigIncludedArea.prototype.toJSON=function(){return{name:this._name,title:this._title,data:this._params,type:this.getType()}};BX.UI.EntityConfigIncludedArea.create=function(b){var a=new BX.UI.EntityConfigIncludedArea();a.initialize(b);return a}}if(typeof BX.UI.EntityConfigField==="undefined"){BX.UI.EntityConfigField=function(){BX.UI.EntityConfigField.superclass.constructor.apply(this);this._index=-1;this._optionFlags=0;this._options={}};BX.extend(BX.UI.EntityConfigField,BX.UI.EntityConfigItem);BX.UI.EntityConfigField.prototype.doInitialize=function(){this._optionFlags=BX.prop.getInteger(this._data,"optionFlags",0);this._options=BX.prop.getObject(this._data,"options",{})};BX.UI.EntityConfigField.prototype.toJSON=function(){var a={name:this._name};if(this._title!==""){a.title=this._title}a.optionFlags=this._optionFlags;a.options=this._options;return a};BX.UI.EntityConfigField.prototype.getIndex=function(){return this._index};BX.UI.EntityConfigField.prototype.setIndex=function(a){this._index=a};BX.UI.EntityConfigField.create=function(b){var a=new BX.UI.EntityConfigField();a.initialize(b);return a}};