(function(){BX.namespace("BX.UI");BX.UI.Dropdown=function(a){this.popupWindow=null;this.items=[];this.defaultItems=[];this.itemsContainer=null;this.popupConatiner=null;this.footerItems=null;this.targetElement=a.targetElement;this.CurrentItem=null;this.searchAction=BX.prop.getString(a,"searchAction","");this.searchOptions=BX.prop.getObject(a,"searchOptions",{});this.messages=BX.prop.getObject(a,"messages",{});this.isChanged=false;this.isDisabled=BX.prop.getBoolean(a,"isDisabled",false);this.enableCreation=BX.prop.getBoolean(a,"enableCreation",false);this.enableCreationOnBlur=BX.prop.getBoolean(a,"enableCreationOnBlur",true);this.isEmbedded=BX.prop.getBoolean(BX.prop.getObject(a,"context",{}),"isEmbedded",false);this.quickForm=document.querySelectorAll(".crm-kanban-quick-form");this.ajaxRequestTimer=null;this.autocompleteDelay=BX.prop.getInteger(a,"autocompleteDelay",0);this.minSearchStringLength=BX.prop.getInteger(a,"minSearchStringLength",2);this.documentClickHandler=BX.delegate(this.onDocumentClick,this);this.emptyValueEventHandle=0;this.events=a.events||{};this.bindEvents();this.updateItemsList(a.items);this.setDefaultItems(a.items);this.setFooterItems(a.footerItems);if(this.targetElement!=="undefined"&&(typeof this.targetElement!=="undefined")){this.init()}};BX.UI.Dropdown.prototype={bindEvents:function(){if(this.events){for(var a in this.events){if(BX.type.isFunction(this.events[a])){BX.addCustomEvent(this,"BX.UI.Dropdown:"+a,this.events[a])}}}},init:function(){setTimeout(function(){BX.bind(this.targetElement,"input",function(){if(this.isDisabled){return}if(this.targetElement.value.length===0){this.enableTargetElement();return}this.getPopupWindow().show()}.bind(this))}.bind(this),100);this.targetElement.addEventListener("click",function(a){this.destroyPopupWindow();if(this.isDisabled){return}if(this.CurrentItem&&this.CurrentItem.title.length===this.targetElement.value.length){this.disableTargetElement()}else{if(this.targetElement.value.length>0){this.disableTargetElement()}}if(this.popupWindow){BX.PreventDefault(a)}this.getPopupWindow().show()}.bind(this),true);setTimeout(function(){this.targetElement.addEventListener("focus",function(){if(this.isDisabled){return}this.getPopupWindow().show();if(!this.popupAlertContainer){return}}.bind(this),true)}.bind(this),100);BX.bind(this.targetElement,"keyup",BX.throttle(function(a){if(this.isDisabled){return}if(this.targetElement.value===""){return}if(a.key==="Escape"){if(this.isDisabled){return}if(this.targetElement.value!==""&&!this.popupWindow){this.getPopupWindow().show()}else{BX.PreventDefault(a)}}}.bind(this),1000));this.targetElement.addEventListener("keyup",function(a){if(this.isDisabled){return}if(a.keyCode===40){this.handleDownArrow()}else{if(a.keyCode===38){this.handleUpArrow()}else{if(a.keyCode===13){if(this.highlightedItem){this.handleItemClick(this.highlightedItem);this.getPopupWindow().close()}if(this.highlightedItem&&this.CurrentItem===this.popupAlertContainer){this.onEmptyValueEvent();return}if((this.CurrentItem&&this.CurrentItem.title.length!==this.targetElement.value.length)||(!this.CurrentItem&&this.targetElement.value.length>0)){this.onEmptyValueEvent();return}if(this.popupWindow&&this.enableCreation){this.destroyPopupWindow()}}else{this.handleTypeInField()}}}if(this.targetElement.value!==""&&!this.popupWindow){this.getPopupWindow().show();return}if(a.keyCode===9&&!this.popupWindow){this.getPopupWindow().show();return}if(a.keyCode===9&&this.targetElement.value===""&&!this.popupWindow){this.getPopupWindow().show()}if(!this.enableCreation){this.targetElement.addEventListener("keyup",function(b){if(b.key==="Escape"){this.resetInputValue()}}.bind(this));BX.bind(document,"click",this.documentClickHandler)}}.bind(this));this.targetElement.addEventListener("keydown",function(a){if(this.isDisabled){return}if((a.keyCode===9&&this.CurrentItem&&this.CurrentItem.title.length!==this.targetElement.value.length)||(a.keyCode===9&&!this.CurrentItem&&this.targetElement.value.length>0)){this.onEmptyValueEvent();return}if(a.keyCode===9&&!this.popupWindow){this.getPopupWindow().show();return}if(a.keyCode===9&&this.targetElement.value===""&&!this.popupWindow){this.getPopupWindow().show();return}if(a.keyCode===9&&this.popupWindow){this.destroyPopupWindow()}}.bind(this))},onDocumentClick:function(){if(this.isTargetElementChanged()){if(!this.enableCreationOnBlur){this.resetInputValue();this.setItems(this.getDefaultItems());BX.cleanNode(this.popupAlertContainer);this.newAlertContainer=null;return}else{this.onEmptyValueEvent()}}},isTargetElementChanged:function(){return(this.CurrentItem&&this.CurrentItem.title.length!==this.targetElement.value.length)||(!this.CurrentItem&&this.targetElement.value.length>0)},getDefaultItems:function(){return this.defaultItems},setDefaultItems:function(a){this.defaultItems=a},getItems:function(){return this.items},updateItemsList:function(a){this.setDefaultItems(a);this.setItems(a)},setItems:function(a){this.items=a;if(this.popupWindow){this.renderItemsToInnerContainer();this.popupWindow.adjustPosition({forceBindPosition:true})}},handleTypeInField:function(){if(!this.isChanged){this.isChanged=true}var a=this.getItemsListContainer();if(!this.targetElement.value){this.setItems(this.getDefaultItems());a.classList.remove("ui-dropdown-loader-active");BX.cleanNode(this.popupAlertContainer);this.newAlertContainer=null;BX.onCustomEvent(this,"BX.UI.Dropdown:onReset",[this])}else{if(this.targetElement.value.length>=this.minSearchStringLength){BX.onCustomEvent(this,"BX.UI.Dropdown:onBeforeSearchStart",[this,this.targetElement.value]);clearTimeout(this.ajaxRequestTimer);this.ajaxRequestTimer=setTimeout(this.searchItemsByStrDelayed.bind(this),this.autocompleteDelay);a.classList.add("ui-dropdown-loader-active")}}},searchItemsByStrDelayed:function(){var a=this.getItemsListContainer();var b={searchQuery:this.targetElement.value};BX.onCustomEvent(this,"BX.UI.Dropdown:onSearchStart",[this,b]);this.searchItemsByStr(b.searchQuery).then(function(c){BX.onCustomEvent(this,"BX.UI.Dropdown:onSearchComplete",[this,c]);return c}.bind(this)).then(function(c){if(!this.newAlertContainer&&this.enableCreation&&BX.Type.isDomNode(this.popupAlertContainer)){var d=this.getNewAlertContainer(c);if(BX.Type.isDomNode(d)){this.popupAlertContainer.appendChild(d)}BX.bind(document,"click",this.documentClickHandler)}this.setItems(c);a.classList.remove("ui-dropdown-loader-active")}.bind(this))},searchItemsByStr:function(a){return BX.ajax.runAction(this.searchAction,{data:{searchQuery:a,options:this.searchOptions}}).then(this.onSearchRequestSuccess.bind(this))},onSearchRequestSuccess:function(a){return BX.prop.getArray(BX.prop.getObject(a,"data",{}),"items",[])},getFooterItems:function(){return this.footerItems},setFooterItems:function(a){if(Array.isArray(a)){this.footerItems=a}},getPopupWindow:function(){if(!this.popupWindow){this.popupWindow=new BX.PopupWindow("dropdown",this.targetElement,{autoHide:true,content:this.popupConatiner?this.popupContainer:this.getPopupContainer(),contentColor:"white",closeByEsc:true,className:"ui-dropdown-window",events:{onPopupClose:function(){this.popupWindow.destroy();this.popupWindow=null;this.itemListContainer=null;this.itemListInnerContainer=null;this.newAlertContainer=null;this.popupAlertContainer=null}.bind(this)}});if(this.isEmbedded&&this.quickForm){this.popupWindow.setOffset({offsetLeft:this.getQuickFormOffsetWidth(),})}}this.setWidthPopup();BX.bind(window,"resize",this.setWidthPopup.bind(this));return this.popupWindow},getQuickFormOffsetWidth:function(){var a=BX.findParent(this.getPopupWindow().bindElement,{className:"crm-kanban-quick-form"});this.popupWindow.popupContainer.style.width=a.offsetWidth+"px";var b=-(this.targetElement.getBoundingClientRect().left-a.getBoundingClientRect().left);return b},setWidthPopup:function(){if(!this.isEmbedded&&this.quickForm){if(this.popupWindow&&this.targetElement){this.popupWindow.popupContainer.style.width=this.targetElement.offsetWidth+"px"}}},onEmptyValueEvent:function(){this.emptyValueEventHandle=window.setTimeout(function(){this.emptyValueEventHandle=0;if(this.enableCreation){BX.onCustomEvent(this,"BX.UI.Dropdown:onAdd",[this,{title:this.targetElement.value}]);this.setItems(this.getDefaultItems());BX.cleanNode(this.popupAlertContainer);this.newAlertContainer=null}else{this.resetInputValue()}}.bind(this),0)},resetInputValue:function(){this.targetElement.value="";BX.onCustomEvent(this,"BX.UI.Dropdown:onReset",[this])},destroyPopupWindow:function(){BX.unbind(document,"click",this.documentClickHandler);if(!this.popupWindow){return}this.popupWindow.close()},getPopupContainer:function(){this.popupContainer=this.getItemsListContainer();this.popupContainer.appendChild(this.getItemsListInnerContainer());this.popupContainer.appendChild(this.getPopupAlertContainer());this.renderItemsToInnerContainer();if(this.footerItems){this.popupContainer.appendChild(this.getLoaderContainer());this.popupContainer.appendChild(this.getFooterContent())}return this.popupContainer},getPopupAlertContainer:function(){if(!this.popupAlertContainer){this.popupAlertContainer=BX.create("div",{attrs:{className:"ui-dropdown-alert-container"}})}return this.popupAlertContainer},getNewAlertContainer:function(a){if(!this.newAlertContainer){this.newAlertContainer=BX.create("div",{props:{className:"ui-dropdown-alert"},events:{click:this.onEmptyValueEvent.bind(this)},children:[this.alertContainerValue=BX.create("div",{attrs:{className:"ui-dropdown-alert-name"},text:this.targetElement.value}),BX.create("div",{attrs:{className:"ui-dropdown-alert-text"},text:BX.prop.getString(this.messages,this.enableCreation?"creationLegend":"notFound","")})]});this.targetElement.addEventListener("input",function(){this.alertContainerValue.textContent=this.targetElement.value}.bind(this));if(!this.enableCreation){this.targetElement.addEventListener("input",function(){this.alertContainerValue.style.display="none"}.bind(this))}}if(a.length>0&&!this.enableCreation){this.newAlertContainer.style.display="none"}else{this.newAlertContainer.style.display=""}return this.newAlertContainer},getItemsListContainer:function(){if(!this.itemListContainer){this.itemListContainer=BX.create("div",{attrs:{className:"ui-dropdown-container"}})}return this.itemListContainer},getItemsListInnerContainer:function(){if(!this.itemListInnerContainer){this.itemListInnerContainer=BX.create("div",{attrs:{className:"ui-dropdown-inner"}})}return this.itemListInnerContainer},getItemNodeList:function(){var a=[];this.getItems().forEach(function(h){var g=BX.prop.getObject(h,"attributes",{});var f=BX.prop.getArray(g,"phone",[]);var i=BX.prop.getArray(g,"email",[]);var d=BX.prop.getArray(g,"web",[]);var c=f.length>0?f[0].value:"";var e=i.length>0?i[0].value:"";var b=(d.length>0?d[0].value:"");h.node=BX.create("div",{attrs:{className:"ui-dropdown-item"},events:{click:this.handleItemClick.bind(this,h)},children:[BX.create("div",{attrs:{className:"ui-dropdown-item-name"},text:h.title}),BX.create("div",{attrs:{className:"ui-dropdown-item-subname"},text:h.subTitle||""}),BX.create("div",{attrs:{className:"ui-dropdown-contact-info"},children:[c!==""?BX.create("div",{attrs:{className:"ui-dropdown-contact-info-item ui-dropdown-item-phone"},text:c}):null,e!==""?BX.create("div",{attrs:{className:"ui-dropdown-contact-info-item ui-dropdown-item-email"},text:e}):null,b!==""?BX.create("div",{attrs:{className:"ui-dropdown-contact-info-item ui-dropdown-item-web"},text:b}):null]})]});a.push(h.node)},this);return a},renderItemsToInnerContainer:function(){var a=this.getItemsListInnerContainer();BX.cleanNode(a);var c=this.getItemNodeList();for(var b=0;b<c.length;b++){a.appendChild(c[b])}return a},getLoaderContainer:function(){return BX.create("div",{props:{className:"ui-dropdown-loader-container"},html:'<svg class="ui-dropdown-loader" viewBox="25 25 50 50"><circle class="ui-dropdown-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"></circle><circle class="ui-dropdown-loader-inner-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"></circle></svg>'})},getFooterContent:function(){var a=BX.create("div",{});this.getFooterItems().forEach(function(b){var c=BX.create("div",{attrs:{className:"ui-dropdown-footer"},children:[BX.create("div",{attrs:{className:"ui-dropdown-caption-box"},children:[BX.create("div",{attrs:{className:"ui-dropdown-caption"},text:b.caption})]})]});b.buttons.forEach(function(d){c.appendChild(BX.create("div",{attrs:{className:"ui-dropdown-button-add"},text:d.caption,events:d.events}))});a.appendChild(c)});return a},handleUpArrow:function(){if(this.newAlertContainer&&this.popupAlertContainer.classList.contains("ui-dropdown-item-highlight")){if(this.items&&this.items.length>0){a=this.getItemByIndex(this.items.length-1);this.popupAlertContainer.classList.remove("ui-dropdown-item-highlight");this.cleanHighlightingItem();this.highlightItem(a)}return}if(!this.items){return}var b=this.getHighlightItemIndex();var a=null;if(b===null){a=this.getLastItem()}else{if(this.items.length>=b+1){a=this.getItemByIndex(b-1)}}if(a){this.cleanHighlightingItem();this.highlightItem(a)}},handleDownArrow:function(){var b=this.getHighlightItemIndex();if(this.newAlertContainer&&this.popupAlertContainer.classList.contains("ui-dropdown-item-highlight")){return}if(!this.items||this.items.length===0){if(this.newAlertContainer&&!this.popupAlertContainer.classList.contains("ui-dropdown-item-highlight")){this.popupAlertContainer.classList.add("ui-dropdown-item-highlight")}return}if(b===this.items.length-1){if(this.newAlertContainer&&!this.popupAlertContainer.classList.contains("ui-dropdown-item-highlight")){this.cleanHighlightingItem();this.popupAlertContainer.classList.add("ui-dropdown-item-highlight")}return}var a=null;if(b===null){a=this.getFirstItem()}else{a=this.getItemByIndex(b+1)}if(a){this.cleanHighlightingItem();this.highlightItem(a)}},scrollToItem:function(){var d=this.getItemsListInnerContainer();var e=d.getBoundingClientRect();var c=this.highlightedItem.node.getBoundingClientRect();var a=e.bottom-c.bottom;var b=e.top-c.top;if(a<0){d.scrollTop=d.scrollTop+Math.abs(a)}else{if(b>0){d.scrollTop=d.scrollTop-b}}},highlightItem:function(a){a.node.classList.add("ui-dropdown-item-highlight");this.highlightedItem=a;this.scrollToItem()},cleanHighlightingItem:function(){if(this.highlightedItem){this.highlightedItem.node.classList.remove("ui-dropdown-item-highlight")}this.highlightedItem=null},getHighlightItemIndex:function(){var a=null;var b=this.getItems();for(var c=0;c<b.length;c++){if(b[c].node.classList.contains("ui-dropdown-item-highlight")){return c}}return a},getItemIndex:function(c){var a=this.getItems();for(var b=0;b<a.length;b++){if(a[b]===c){return b}}return false},getFirstItem:function(){if(!this.items||this.items.length===0){return null}return this.items[0]},getLastItem:function(){var a=this.getItems();if(!a){return}return a[a.length-1]},getItemByIndex:function(b){var a=this.getItems();if(a[b]){return a[b]}return null},handleItemClick:function(b,a){if(this.emptyValueEventHandle>0){window.clearTimeout(this.emptyValueEventHandle);this.emptyValueEventHandle=0}this.CurrentItem=b;BX.onCustomEvent(this,"BX.UI.Dropdown:onSelect",[this,b])},selectTargetElementValue:function(){this.targetElement.select();this.targetElement.focus()},disableTargetElement:function(){this.targetElement.select();this.targetElement.focus();this.targetElement.addEventListener("keyup",function(b){var a=b.charCode||b.keyCode;if(this.targetElement===document.activeElement){if(a===8){return true}else{if(a===37||a===39){if(this.targetElement.value.length>0&&this.targetElement===document.activeElement){this.selectTargetElementValue()}}else{if(this.targetElement.value.length>0&&this.targetElement===document.activeElement){return true}else{BX.PreventDefault(b)}}}}}.bind(this))},enableTargetElement:function(){this.targetElement.addEventListener("keyup",function(){return true}.bind(this))}};BX.UI.DropdownUser=function(a){BX.UI.Dropdown.call(this,a)};BX.UI.DropdownUser.prototype={__proto__:BX.UI.Dropdown.prototype,renderItem:function(a){itemsContainer.appendChild(BX.create("div",{attrs:{className:"ui-dropdown-item ui-dropdown-item-user"},children:[BX.create("div",{attrs:{className:"ui-dropdown-item-icon"},text:a.user}),BX.create("div",{attrs:{className:"ui-dropdown-info-box"},children:[BX.create("div",{attrs:{className:"ui-dropdown-item-name"},text:a.title}),BX.create("div",{attrs:{className:"ui-dropdown-item-subname"},text:a.subtitle}),BX.create("div",{attrs:{className:"ui-dropdown-item-value"},text:a.value})]})]}))}}})();