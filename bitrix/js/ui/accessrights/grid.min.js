(function(){BX.namespace("BX.UI");BX.UI.AccessRights=function(a){a=a||{};this.options=a;this.renderTo=a.renderTo;this.buttonPanel=BX.UI.ButtonPanel||null;this.layout={container:null};this.component=a.component?a.component:null;this.actionSave=a.actionSave?a.actionSave:"save";this.actionDelete=a.actionDelete?a.actionDelete:"delete";this.actionLoad=a.actionLoad?a.actionLoad:"load";this.mode=a.mode?a.mode:"ajax";this.openPopupEvent=a.openPopupEvent?a.openPopupEvent:null;this.popupContainer=a.popupContainer?a.popupContainer:null;this.additionalSaveParams=a.additionalSaveParams?a.additionalSaveParams:null;this.loadParams=a.loadParams?a.loadParams:null;this.loader=null;this.timer=null;this.initData();if(a.userGroups){this.userGroups=a.userGroups}if(a.accessRights){this.accessRights=a.accessRights}this.isRequested=false;this.loadData();this.bindEvents()};BX.UI.AccessRights.prototype={bindEvents:function(){BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:updateRole",this.updateRole.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:accessOn",this.updateAccessRight.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:accessOff",this.updateAccessRight.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:update",this.adjustButtonPanel.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:addRole",this.addUserGroup.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:addRole",this.addRoleColumn.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:copyRole",this.addRoleColumn.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:copyRole",this.addUserGroup.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:removeRole",this.removeRoleColumn.bind(this));BX.addCustomEvent("BX.UI.AccessRights.ColumnItem:removeRole",this.adjustButtonPanel.bind(this));BX.addCustomEvent("BX.Main.SelectorV2:onGetEntityTypes",this.onGetEntityTypes.bind(this))},initData:function(){this.accessRights=[];this.userGroups=[];this.accessRightsSections=[];this.headSection=null;this.members=[];this.columns=[]},fireEventReset:function(){BX.onCustomEvent(window,"BX.UI.AccessRights:reset",this)},fireEventRefresh:function(){BX.onCustomEvent(window,"BX.UI.AccessRights:refresh",this)},getButtonPanel:function(){return this.buttonPanel},showNotification:function(a){BX.UI.Notification.Center.notify({content:a,position:"top-right",autoHideDelay:3000,})},sendActionRequest:function(){if(this.isRequested){return}this.isRequested=true;this.timer=setTimeout(function(){this.blockGrid()}.bind(this),1000);var b=false;var c=[];for(var a=0;a<this.userGroups.length;a++){if(this.userGroups[a].id==0){b=true}c.push({accessCodes:this.userGroups[a].accessCodes,id:this.userGroups[a].id,title:this.userGroups[a].title,type:this.userGroups[a].type,accessRights:this.userGroups[a].accessRights})}BX.ajax.runComponentAction(this.component,this.actionSave,{mode:this.mode,data:{userGroups:c,parameters:this.additionalSaveParams},}).then(function(){if(b){this.reloadGrid()}this.isRequested=false;this.showNotification(BX.message("JS_UI_ACCESSRIGHTS_STTINGS_HAVE_BEEN_SAVED"));this.unBlockGrid();this.fireEventRefresh();setTimeout(function(){this.adjustButtonPanel()}.bind(this));clearTimeout(this.timer);this.buttonPanel.getContainer().querySelector(".ui-btn-wait").classList.remove("ui-btn-wait")}.bind(this),function(){this.isRequested=false;this.showNotification("Error message");this.unBlockGrid();clearTimeout(this.timer);this.buttonPanel.getContainer().querySelector(".ui-btn-wait").classList.remove("ui-btn-wait")}.bind(this));BX.onCustomEvent(window,"BX.UI.AccessRights:preservation",this)},deleteActionRequest:function(a){if(this.isRequested){return}this.isRequested=true;this.timer=setTimeout(function(){this.blockGrid()}.bind(this),1000);BX.ajax.runComponentAction(this.component,this.actionDelete,{mode:this.mode,data:{roleId:a},}).then(function(){this.isRequested=false;this.showNotification(BX.message("JS_UI_ACCESSRIGHTS_ROLE_REMOVE"));this.unBlockGrid();clearTimeout(this.timer)}.bind(this),function(){this.isRequested=false;this.showNotification("Error message");this.unBlockGrid();clearTimeout(this.timer)}.bind(this))},reloadGrid:function(){this.initData();BX.ajax.runComponentAction(this.component,this.actionLoad,{mode:this.mode,data:{parameters:this.loadParams},}).then(function(a){if(a.data.ACCESS_RIGHTS&&a.data.USER_GROUPS){this.accessRights=a.data.ACCESS_RIGHTS;this.userGroups=a.data.USER_GROUPS;this.loadData();this.draw()}this.unBlockGrid()}.bind(this),function(){this.unBlockGrid()}.bind(this))},blockGrid:function(){var b=this.layout.container.getBoundingClientRect().top<0?"0":this.layout.container.getBoundingClientRect().top;this.layout.container.classList.add("ui-access-rights-block");this.layout.container.style.height="calc(100vh - "+b+"px)";setTimeout(function(){this.layout.container.style.height="calc(100vh - "+b+"px)"}.bind(this));var a=this;this.getLoader().then(function(){a.loader.show()})},unBlockGrid:function(){this.layout.container.classList.remove("ui-access-rights-block");this.layout.container.style.height=null;var a=this;this.getLoader().then(function(){a.loader.hide()})},loadLoaderExtension:function(){return new Promise(function(a){if(BX.Loader){return a()}BX.loadExt("main.loader").then(function(){a()})})},getLoader:function(){var a=this;return new Promise(function(b){a.loadLoaderExtension().then(function(){if(!a.loader){a.loader=new BX.Loader({target:a.layout.container})}b()})})},removeRoleColumn:function(c){this.headSection.removeColumn(c.data);this.accessRightsSections.map(function(d){d.removeColumn(c.data)});var a=this.userGroups.indexOf(c.data.userGroup);this.userGroups.splice(a,1);var b=c.data.userGroup.id;this.deleteActionRequest(b)},addRoleColumn:function(b){if(!b){return}var c=this.accessRightsSections;for(var a=0;a<c.length;a++){b.headSection=false;b.newColumn=true;c[a].addColumn(b);c[a].scrollToRight(c[a].getColumnsContainer().scrollWidth-c[a].getColumnsContainer().offsetWidth,"stop")}b.headSection=true;b.newColumn=true;this.headSection.addColumn(b)},addUserGroup:function(a){a=a||{};this.userGroups.push(a)},updateRole:function(b){var a=this.userGroups.indexOf(b.data.userGroup);if(a>=0){this.userGroups[a].title=b.data.text}},adjustButtonPanel:function(){var a=this.getMainContainer().querySelectorAll(".ui-access-rights-column-item-changer-on");var b=this.getMainContainer().querySelectorAll(".ui-access-rights-column-new");var c=this.getMainContainer().querySelectorAll(".ui-access-rights-members-item-new");if(a.length>0||b.length>0||c.length>0){this.buttonPanel.show()}else{this.buttonPanel.hide()}},updateAccessRight:function(a){var e=a.data;var f=this.userGroups[this.userGroups.indexOf(e.userGroup)];var c=e.access.id;for(var b=0;b<f.accessRights.length;b++){var d=f.accessRights[b];if(d.id===c){(d.value==="0")?d.value="1":d.value="0";return}}f.accessRights.push({id:c,value:e.switcher.checked?"1":"0"})},loadData:function(){this.accessRights.map(function(b,a){b.id=a;this.accessRightsSections.push(this.addSection(b))}.bind(this))},getColumns:function(){return this.columns},getSections:function(){return this.accessRightsSections},getUserGroups:function(){this.userGroups.forEach(function(b){if(b.accessCodes){for(var a in b.members){b.accessCodes[a]=b.members[a].type}}});return this.userGroups},getHeadSection:function(){if(!this.headSection){this.headSection=new BX.UI.AccessRights.Section({headSection:true,userGroups:this.userGroups,grid:this})}return this.headSection},addSection:function(a){a=a||{};return new BX.UI.AccessRights.Section({id:a.id,title:a.sectionTitle,rights:a.rights?a.rights:[],grid:this})},getSection:function(){return BX.create("div",{props:{className:"ui-access-rights-section"}})},getMainContainer:function(){if(!this.layout.container){this.layout.container=BX.create("div",{props:{className:"ui-access-rights"}})}return this.layout.container},draw:function(){var a=document.createDocumentFragment();a.appendChild(this.getHeadSection().render());this.getSections().map(function(b){a.appendChild(b.render())}.bind(this));this.layout.container=null;this.getMainContainer().appendChild(a);this.renderTo.innerHTML="";this.renderTo.appendChild(this.layout.container);this.afterRender()},afterRender:function(){this.getHeadSection().adjustEars();this.getSections().map(function(a){a.adjustEars()})},onMemberSelect:function(b){var a=BX.UI.AccessRights.buildOption(b);if(!a){return}if(b.state==="select"){BX.onCustomEvent("BX.UI.AccessRights:addToAccessCodes",a)}},onMemberUnselect:function(b){var a=BX.UI.AccessRights.buildOption(b);if(!a){return}BX.onCustomEvent("BX.UI.AccessRights:removeFromAccessCodes",a)},onGetEntityTypes:function(){var b=BX.Main.selectorManagerV2.controls;var a=b[Object.keys(b)[0]];a.entityTypes.USERGROUPS={options:{enableSearch:"Y",searchById:"Y",addTab:"Y",returnItemUrl:(a.getOption("returnItemUrl")=="N"?"N":"Y")}}}};BX.UI.AccessRights.buildOption=function(f){var i=BX.Main.selectorManagerV2.controls;var e=i[Object.keys(i)[0]].selectorInstance;var h="bx-data-column-id";var c=e.bindOptions.node;if(!c.hasAttribute(h)||typeof f.item==="undefined"){return false}var b=c.getAttribute(h);var d=f.item.id;var g=f.entityType;var a={};a[d]=g;return{accessCodes:a,columnId:b,item:f.item}}})();