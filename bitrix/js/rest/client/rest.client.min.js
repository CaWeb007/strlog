"use strict";(function(){if(!window.BX){window.BX={}}else{if(window.BX.RestClient){return}}var h=window.BX;h.RestClient=function(i){i=i||{};this.endpoint=i.endpoint||"/rest";this.queryParams=i.queryParams||"";this.cors=i.cors===true};h.RestClient.prototype.callMethod=function(m,k,l,j,i){return f({method:m,data:k,callback:l,sendCallback:j,logTag:i,endpoint:this.endpoint,queryParams:this.queryParams,cors:this.cors})};h.RestClient.prototype.callBatch=function(v,u,t,s,q){var l=g.isArray(v)?[]:{};var k=0;var m=function(i){f.batch(i,u,t,s,this.endpoint,this.queryParams,this.cors,q)}.bind(this);for(var o in v){var j=null,n=null;if(!!v[o]&&v.hasOwnProperty(o)){if(g.isArray(v[o])){j=v[o][0];n=v[o][1]}else{if(!!v[o].method){j=v[o].method;n=v[o].params}}if(!!j){k++;l[o]=[j,n]}}}if(k>0){var p=function(w){return function(i){l[w]=l[w][0]+"?"+i;if(--k<=0){m(l)}}};for(var r in l){if(l.hasOwnProperty(r)){f.prepareData(l[r][1],"",p(r))}}}};h.RestClient.prototype.setEndpoint=function(i){this.endpoint=i};h.RestClient.prototype.enableCorsRequest=function(i){this.cors=i===true};h.RestClient.prototype.setQueryParams=function(i){this.queryParams=i};if(typeof h.namespace!=="undefined"){var c=new h.RestClient();if(typeof h.rest=="undefined"){h.rest={}}h.rest.callMethod=function(m,k,l,j,i){return c.callMethod(m,k,l,j,i)};h.rest.callBatch=function(j,m,i,l,k){return c.callBatch(j,m,i,l,k)}}var g={isArray:function(i){return i&&Object.prototype.toString.call(i)=="[object Array]"},isFunction:function(i){return i===null?false:(typeof(i)=="function"||i instanceof Function)},isString:function(i){return i===""?true:(i?(typeof(i)=="string"||i instanceof String):false)},isDomNode:function(i){return i&&typeof(i)=="object"&&"nodeType" in i},isDate:function(i){return i&&Object.prototype.toString.call(i)=="[object Date]"},buildQueryString:function(l){var i="";for(var j in l){if(!l.hasOwnProperty(j)){continue}var k=l[j];if(this.isArray(k)){k.forEach(function(n,m){i+=encodeURIComponent(j+"["+m+"]")+"="+encodeURIComponent(n)+"&"})}else{i+=encodeURIComponent(j)+"="+encodeURIComponent(k)+"&"}}if(i.length>0){i=i.substr(0,i.length-1)}return i},clone:function(n,m){var o,k,j;if(m!==false){m=true}if(n===null){return null}if(this.isDomNode(n)){o=n.cloneNode(m)}else{if(typeof n=="object"){if(this.isArray(n)){o=[];for(k=0,j=n.length;k<j;k++){if(typeof n[k]=="object"&&m){o[k]=this.clone(n[k],m)}else{o[k]=n[k]}}}else{o={};if(n.constructor){if(this.isDate(n)){o=new Date(n)}else{o=new n.constructor()}}for(k in n){if(typeof n[k]=="object"&&m){o[k]=this.clone(n[k],m)}else{o[k]=n[k]}}}}else{o=n}}return o}};var f=function(k){var j=!!k.callback&&g.isFunction(k.callback);var q=typeof h.Promise==="undefined"||j?null:new h.Promise();var n=k.sendCallback||function(){};var r=k.withoutRestoringCsrf||false;var m=k.loginAttempt||0;var p=f.xhr();var i=k.endpoint+"/"+f.escape(k.method)+".json"+(k.logTag?"?logTag="+k.logTag:"");p.open("POST",i);p.setRequestHeader("Content-Type","application/x-www-form-urlencoded");if(k.cors){p.withCredentials=true}var l=false;p.onprogress=function(){};p.ontimeout=function(){};p.timeout=0;p.onload=function(){if(l){return}p.onload=function(){};var t=f.isSuccess(p);var s=p.status;if(t){var v=p.responseText;if(v.length>0){try{v=JSON.parse(v)}catch(w){t=false}}if(s==401){if(v.extended_error==="user_not_authorized"&&m===0){if(v.sessid){console.warn("BX.rest: csrf-token has expired, replace to a new token");h.message({bitrix_sessid:v.sessid})}if("BXDesktopSystem" in window){console.warn("BX.rest: you are not authorized, trying to log in");k.loginAttempt=1;BXDesktopSystem.Login({success:function(){console.warn("BX.rest: successfully logged in, repeating request");if(!j){k.callback=function(x){if(x.error()){q.reject(x)}else{q.fulfill(x)}}}f(k)}});return true}}else{if(v.sessid&&!r){h.message({bitrix_sessid:v.sessid});console.warn("BX.rest: your csrf-token has expired, send query with a new token");k.withoutRestoringCsrf=true;if(!j){k.callback=function(x){if(x.error()){q.reject(x)}else{q.fulfill(x)}}}f(k);return true}}}else{if(s==0){v={result:{},error:"ERROR_NETWORK",error_description:"A network error occurred while the request was being executed."}}else{if(s==200){if(v.length<=0){v={result:{},error:"BLANK_ANSWER",error_description:"Empty answer with correct http code, network error possible."}}}else{if(v.length<=0){v={result:{},error:"BLANK_ANSWER_WITH_ERROR_CODE",error_description:"Empty answer with error http code: "+s}}}}}}p=null;if(t){var u=new a(v,k,s);if(j){k.callback.apply(window,[u])}else{if(u.error()){q.reject(u)}else{q.fulfill(u)}}}else{var u=new a({error:"ERROR_UNEXPECTED_ANSWER",error_description:"Server returned an unexpected response.",ex:{}},k,0);if(j){k.callback.apply(window,[u])}else{q.reject(u)}}};p.onerror=function(t){var s=new a({error:"ERROR_NETWORK",error_description:"A network error occurred while the request was being executed.",ex:t},k,0);if(j){k.callback.apply(window,[s])}else{q.reject(s)}};var o="";if(k.queryParams){o=g.buildQueryString(k.queryParams)}else{if(typeof h.bitrix_sessid!=="undefined"){o="sessid="+h.bitrix_sessid()}}if(typeof k.start!=="undefined"){o+="&start="+parseInt(k.start)}if(!!k.data){f.prepareData(k.data,"",function(s){o+="&"+s;p.send(o);n(p)})}else{p.send(o);n(p)}return j||!q?p:q};f.batch=function(j,p,i,m,o,l,n,k){return f({method:"batch",data:{halt:!!i?1:0,cmd:j},callback:function(w,u,s){if(!p){return false}var t=w.error();var y=w.data();var r=g.isArray(j)?[]:{};for(var v in j){if(!!j[v]&&j.hasOwnProperty(v)){if(g.isString(j[v])){var x=j[v].split("?")}else{x=[g.isArray(j[v])?j[v][0]:j[v].method,g.isArray(j[v])?j[v][1]:j[v].data]}if(y&&typeof y.result!=="undefined"&&(typeof y.result[v]!=="undefined"||typeof y.result_error[v]!=="undefined")){r[v]=new a({result:typeof y.result[v]!=="undefined"?y.result[v]:{},error:y.result_error[v]||undefined,total:y.result_total[v],time:y.result_time[v],next:y.result_next[v]},{method:x[0],data:x[1],callback:p,endpoint:o,queryParams:l,cors:n},w.status)}else{if(t){r[v]=new a({result:{},error:t.ex,total:0},{method:x[0],data:x[1],callback:p,endpoint:o,queryParams:l,cors:n},w.status)}}}}p.apply(window,[r])},sendCallback:m,endpoint:o,queryParams:l,cors:n,logTag:k})};f.xhr=function(){return new XMLHttpRequest()};f.escape=function(i){return encodeURIComponent(i)};f.prepareData=function(q,o,r){var m="",s=[];if(g.isString(q)||q===null){r.call(document,q||"")}else{for(var n in q){if(!q.hasOwnProperty(n)){continue}var j=f.escape(n);if(o){j=o+"["+j+"]"}if(typeof q[n]==="object"){if(g.isArray(q[n])&&q[n].length<=0){continue}s.push([j,q[n]])}else{if(m.length>0){m+="&"}if(typeof q[n]==="boolean"){m+=j+"="+(q[n]?1:0)}else{m+=j+"="+f.escape(q[n])}}}var k=s.length;if(k>0){var l=function(i){m+=(!!i?"&":"")+i;if(--k<=0){r.call(document,m)}};var p=k;for(var n=0;n<p;n++){if(g.isDomNode(s[n][1])){if(s[n][1].tagName.toUpperCase()==="INPUT"&&s[n][1].type==="file"){if(b.canUse()){b(s[n][1],(function(i){return function(t){if(g.isArray(t)&&t.length>0){l(i+"[0]="+f.escape(t[0])+"&"+i+"[1]="+f.escape(t[1]))}else{l(i+"=")}}})(s[n][0]))}}else{if(typeof s[n][1].value!=="undefined"){l(s[n][0]+"="+f.escape(s[n][1].value))}else{l("")}}}else{if(g.isDate(s[n][1])){l(s[n][0]+"="+f.escape(s[n][1].toJSON()))}else{if(g.isArray(s[n][1])&&s[n][1].length<=0){l(s[n][0]+"=")}else{f.prepareData(s[n][1],s[n][0],l)}}}}}else{r.call(document,m)}}};f.isSuccess=function(i){return typeof i.status==="undefined"||(i.status>=200&&i.status<300)||i.status===304||i.status>=400&&i.status<500||i.status===1223||i.status===0};var a=function(k,j,i){this.answer=k;this.query=g.clone(j);this.status=i;if(typeof this.answer.next!=="undefined"){this.answer.next=parseInt(this.answer.next)}if(typeof this.answer.error!=="undefined"){this.answer.ex=new e(this.status,typeof this.answer.error==="string"?this.answer:this.answer.error)}};a.prototype.data=function(){return this.answer.result};a.prototype.time=function(){return this.answer.time};a.prototype.error=function(){return this.answer.ex};a.prototype.error_description=function(){return this.answer.error_description};a.prototype.more=function(){return !isNaN(this.answer.next)};a.prototype.total=function(){return parseInt(this.answer.total)};a.prototype.next=function(i){if(this.more()){this.query.start=this.answer.next;if(!!i&&g.isFunction(i)){this.query.callback=i}return f(this.query)}return false};var e=function(i,j){this.status=i;this.ex=j};e.prototype.getError=function(){return this.ex};e.prototype.getStatus=function(){return this.status};e.prototype.toString=function(){return this.ex.error+(!!this.ex.error_description?": "+this.ex.error_description:"")+" ("+this.status+")"};var d=function(l){var j=new Uint8Array(l);var n="";if(typeof j.forEach==="function"){j.forEach(function(i){n+=String.fromCharCode(i)})}else{var m=j.length;for(var k=0;k<m;k+=1){n+=String.fromCharCode(j[k])}}return btoa(n)};var b=function(p,m){if(b.canUse()){var o=p.files,l=0,k=p.multiple?[]:null;for(var n=0,q;q=o[n];n++){var j=new window.FileReader();j.BXFILENAME=o[n].name;j.onload=function(r){r=r||window.event;var i=[this.BXFILENAME,d(r.target.result)];if(k===null){k=i}else{k.push(i)}if(--l<=0){m(k)}};j.readAsArrayBuffer(q)}l=n;if(l<=0){m(k)}}};b.canUse=function(){return !!window.FileReader}})();