(function(){BX.namespace("BX.rest");if(!!BX.rest.AppLayout){return}BX.rest.AppLayout=function(b){this.params={firstRun:!!b.firstRun,appHost:b.appHost,appProto:b.appProto,authId:b.authId,authExpires:b.authExpires,refreshId:b.refreshId,placement:b.placement,formName:b.formName,frameName:b.frameName,loaderName:b.loaderName,layoutName:b.layoutName,ajaxUrl:b.ajaxUrl,controlUrl:b.controlUrl,isAdmin:!!b.isAdmin,staticHtml:!!b.staticHtml,id:b.id,appId:b.appId,appV:b.appV,appI:b.appI,appSid:b.appSid,memberId:b.memberId,restPath:b.restPath,proto:b.proto,userOptions:b.userOptions,appOptions:b.appOptions,placementId:!!b.placementId?b.placementId:0,placementOptions:b.placementOptions};this.userSelectorControl=[null,null];this.userSelectorControlCallback=null;this.bAccessLoaded=false;this._appOptionsStack=[];this._inited=false;this._destroyed=false;this.deniedInterface=[];this.selectUserCallback_1_value=[];this.messageInterface=new (BX.rest.AppLayout.initializePlacement(this.params.placement))();BX.bind(window,"message",BX.proxy(this.receiveMessage,this))};BX.rest.AppLayout.openApplication=function(m,o,e,g){var d=BX.message("REST_APPLICATION_URL").replace("#ID#",parseInt(m));d=BX.util.add_url_param(d,{_r:Math.random()});var f={};if(o&&typeof o==="object"){for(var j in o){if(!o.hasOwnProperty(j)){continue}if(j.search("bx24_")===0){var v=j.replace("bx24_","");f[v]=o[j];delete o[j]}}if(o.hasOwnProperty("options")){if(typeof o.options==="object"){appOptions=o.options}if(o.hasOwnProperty("params")){o=o.params}}}var u={ID:m,PLACEMENT_OPTIONS:o,POPUP:1};if(!!e){if(typeof e.PLACEMENT!=="undefined"){u.PLACEMENT=e.PLACEMENT}if(typeof e.PLACEMENT_ID!=="undefined"){u.PLACEMENT_ID=e.PLACEMENT_ID}}var k={url:d,anchor:null,target:null};var h=BX.SidePanel.Instance.getUrlRule(d,k);var b=h&&h.options?BX.clone(h.options):{};b.cacheable=false;b.contentCallback=function(i){var w=new top.BX.Promise();top.BX.ajax.post(i.url,{sessid:BX.bitrix_sessid(),site:BX.message("SITE_ID"),PARAMS:{template:"",params:u}},function(x){w.fulfill(x)});return w};b.events=(b.events?b.events:{});b.events["onClose"]=function(){if(!!g){g()}};var c=["width","leftBoundary","title","label"];for(var p in f){if(!f.hasOwnProperty(p)){continue}for(var t in c){if(p===c[t]){switch(p){case"leftBoundary":if(BX.type.isNumber(f[p])){b.customLeftBoundary=Number(f[p])}break;case"width":if(BX.type.isNumber(f[p])){b.width=Number(f[p])}break;case"title":if(BX.type.isString(f[p])){b.title=String(f[p])}break;case"label":var l=f[p];if(BX.type.isObject(l)){var n={aqua:"#06bab1",green:"#a5de00",orange:"#ffa801",brown:"#b57051",pink:"#f968b6",blue:"#2eceff",grey:"#a1a6ac",violet:"#6b52cc"};if(l.hasOwnProperty("bgColor")){var r="";for(var s in n){if(l.bgColor===s){r=n[s];break}}f[p]["bgColor"]=r}b.label=f[p]}break}}}}BX.SidePanel.Instance.open(d,b);var q=top.BX.SidePanel.Instance.getTopSlider();top.BX.addCustomEvent(top,"Rest:AppLayout:ApplicationInstall",function(w,i){i.redirect=false;q.close(false,function(){BX.rest.AppLayout.openApplication(m,o,e,g)})})};BX.rest.AppLayout.prototype={init:function(){if(!this._inited&&!!document.forms[this.params.formName]){var b=BX(this.params.loaderName);BX.bind(BX(this.params.frameName),"load",function(){BX.addClass(b,"app-loading-msg-loaded");BX.removeClass(this,"app-loading");setTimeout(function(){BX.remove(b)},300)});if(this.params.staticHtml){BX(this.params.frameName).src=document.forms[this.params.formName].action}else{document.forms[this.params.formName].submit()}this._inited=true}},destroy:function(){BX.unbind(window,"message",BX.proxy(this.receiveMessage,this));BX(this.params.frameName).parentNode.removeChild(BX(this.params.frameName));this._destroyed=true},query:function(c,d){var b={sessid:BX.bitrix_sessid(),site:BX.message("SITE_ID"),PARAMS:{template:"",params:{ID:this.params.id}}};if(!!c){b=BX.mergeEx(b,c)}return BX.ajax({dataType:"json",method:"POST",url:this.params.ajaxUrl,data:b,onsuccess:d})},receiveMessage:function(g){g=g||window.event;if(g.origin!=this.params.appProto+"://"+this.params.appHost||!BX.type.isString(g.data)){return}var f=a(g.data,":"),c=[];if(f[3]!=this.params.appSid){return}if(f[1]){c=JSON.parse(f[1])}if(!!this.messageInterface[f[0]]&&!BX.util.in_array(f[0],this.deniedInterface)){var b=f[2];var d=!b?BX.DoNothing:BX.delegate(function(e){var h=BX(this.params.frameName);if(!!h&&!!h.contentWindow){h.contentWindow.postMessage(b+":"+(typeof e=="undefined"?"":JSON.stringify(e)),this.params.appProto+"://"+this.params.appHost)}},this);this.messageInterface[f[0]].apply(this,[c,d])}},denyInterface:function(b){this.deniedInterface=BX.util.array_merge(this.deniedInterface,b)},allowInterface:function(c){var b=[];for(var d=0;d<this.deniedInterface.length;d++){if(!BX.util.in_array(this.deniedInterface[d],c)){b.push(this.deniedInterface[d])}}this.deniedInterface=b},sendAppOptions:function(){if(this._appOptionsStack.length>0){var b=this._appOptionsStack;this._appOptionsStack=[];var d=[];for(var c=0;c<b.length;c++){d.push({name:b[c][0],value:b[c][1]})}var e={action:"set_option",options:d};this.query(e,function(g){for(var f=0;f<b.length;f++){b[f][2](g)}})}},loadControl:function(c,d,b){if(!d){d={}}d.control=c;d.sessid=BX.bitrix_sessid();BX.ajax({method:"POST",url:this.params.controlUrl,data:d,processScriptsConsecutive:true,onsuccess:b})},reInstall:function(){BX.proxy(this.messageInterface.setInstallFinish,this)({value:false})},selectUserCallback_0:function(b){var c=BX.util.array_values(b);if(!!c&&c.length>0){BX.defer(this.userSelectorControl[0].close,this.userSelectorControl[0])();if(!!this.userSelectorControlCallback){this.userSelectorControlCallback.apply(this,[c[0]])}}},selectUserCallback_1:function(b){if(b===true){var c=BX.util.array_values(this.selectUserCallback_1_value);BX.defer(this.userSelectorControl[1].close,this.userSelectorControl[1])();if(!!this.userSelectorControlCallback){this.userSelectorControlCallback.apply(this,[c])}}else{this.selectUserCallback_1_value=b}},hideUpdate:function(c,b){BX.userOptions.save("app_options","params_"+this.params.appId+"_"+this.params.appV,"skip_update_"+c,1);b()}};BX.rest.AppLayout.initizalizePlacementInterface=function(b){var c=function(){};BX.extend(c,b);c.prototype.events=BX.clone(c.superclass.events);return c};BX.rest.AppLayout.initializePlacement=function(b){b=(b+"").toUpperCase();if(!BX.rest.AppLayout.placementInterface[b]){BX.rest.AppLayout.placementInterface[b]=BX.rest.AppLayout.initizalizePlacementInterface(b==="DEFAULT"?BX.rest.AppLayout.MessageInterface:BX.rest.AppLayout.MessageInterfacePlacement)}return BX.rest.AppLayout.placementInterface[b]};BX.rest.AppLayout.initializePlacementByEvent=function(b,c){BX.addCustomEvent(c,function(f){var e=BX.rest.AppLayout.initializePlacement(b);if(!!f.events){for(var d=0;d<f.events.length;d++){e.prototype.events.push(f.events[d])}}for(var g in f){if(g!=="events"&&f.hasOwnProperty(g)){e.prototype[g]=f[g]}}})};BX.rest.AppLayout.MessageInterface=function(){};BX.rest.AppLayout.MessageInterface.prototype={events:[],getInitData:function(c,b){b({LANG:BX.message("LANGUAGE_ID"),DOMAIN:location.host,PROTOCOL:this.params.proto,PATH:this.params.restPath,AUTH_ID:this.params.authId,AUTH_EXPIRES:this.params.authExpires,REFRESH_ID:this.params.refreshId,MEMBER_ID:this.params.memberId,FIRST_RUN:this.params.firstRun,IS_ADMIN:this.params.isAdmin,INSTALL:this.params.appI,USER_OPTIONS:this.params.userOptions,APP_OPTIONS:this.params.appOptions,PLACEMENT:this.params.placement,PLACEMENT_OPTIONS:this.params.placementOptions});this.params.firstRun=false},getInterface:function(f,c){var b={command:[],event:[]};for(var e in this.messageInterface){if(e!=="events"&&e!=="constructor"&&!BX.rest.AppLayout.MessageInterfacePlacement.prototype[e]&&!BX.util.in_array(e,this.deniedInterface)){b.command.push(e)}}for(var d=0;d<this.messageInterface.events.length;d++){b.event.push(this.messageInterface.events[d])}c(b)},refreshAuth:function(c,b){c={action:"access_refresh"};this.query(c,BX.delegate(function(d){if(!!d.access_token){this.params.authId=d.access_token;this.params.authExpires=d.expires_in;this.params.refreshId=d.refresh_token;b({AUTH_ID:this.params.authId,AUTH_EXPIRES:this.params.authExpires,REFRESH_ID:this.params.refreshId})}else{alert("Unable to get new token! Reload page, please!")}},this))},resizeWindow:function(e,b){var c=BX(this.params.layoutName);e.width=e.width=="100%"?e.width:((parseInt(e.width)||100)+"px");e.height=parseInt(e.height);if(!!e.width){c.style.width=e.width}if(!!e.height){c.style.height=e.height+"px"}var d=BX.pos(c);b({width:d.width,height:d.height})},setTitle:function(c,b){BX.ajax.UpdatePageTitle(c.title);b(c)},setScroll:function(c,b){if(!!c&&typeof c.scroll!="undefined"&&c.scroll>=0){window.scrollTo(BX.GetWindowScrollPos().scrollLeft,parseInt(c.scroll))}b(c)},setUserOption:function(c,b){this.params.userOptions[c.name]=c.value;BX.userOptions.save("app_options","options_"+this.params.appId,c.name,c.value);b(c)},setAppOption:function(c,b){if(this.params.isAdmin){this._appOptionsStack.push([c.name,c.value,b]);BX.defer(this.sendAppOptions,this)()}},setInstall:function(c,b){BX.userOptions.save("app_options","params_"+this.params.appId+"_"+this.params.appV,"install",!!c.install?1:0);b(c)},setInstallFinish:function(d,b){var c={action:"set_installed",v:typeof d.value=="undefined"||d.value!==false?"Y":"N"};this.query(c,BX.delegate(function(f){var e={redirect:true};top.BX.onCustomEvent(top,"Rest:AppLayout:ApplicationInstall",[c.v,e],false);if(e.redirect){window.location=BX.util.add_url_param(window.location.href,{install_finished:!!f.result?"Y":"N"})}},this))},selectUser:function(e,b){this.userSelectorControlCallback=b;var d=parseInt(e.mult+0);if(d){if(this.userSelectorControl[d]){this.userSelectorControl[d].close();this.userSelectorControl[d].destroy();this.userSelectorControl[d]=null}}else{if(!!this.userSelectorControl[d]){this.userSelectorControl[d].show();return}}var c={name:"USER_"+d,onchange:"user_selector_cb_"+(parseInt(Math.random()*100000)),site_id:BX.message("SITE_ID")};if(d){c.mult=true}window[c.onchange]=BX.delegate(this["selectUserCallback_"+d],this);this.loadControl("user_selector",c,BX.delegate(function(f){this.userSelectorControl[d]=BX.PopupWindowManager.create("app-user-popup-"+d,null,{autoHide:true,content:f,zIndex:5000});if(d){this.userSelectorControl[d].setButtons([new BX.PopupWindowButton({text:BX.message("REST_ALT_USER_SELECT"),className:"popup-window-button-accept",events:{click:function(){window[c.onchange](true)}}})])}this.userSelectorControl[parseInt(e.mult+0)].show();BX("USER_"+d+"_selector_content").style.display="block"},this))},selectAccess:function(e,b){if(!this.bAccessLoaded){this.loadControl("access_selector",{},BX.defer(function(){this.bAccessLoaded=true;BX.defer(this.messageInterface.selectAccess,this)(e,b)},this))}else{BX.Access.Init({groups:{disabled:true}});e.value=e.value||[];var c={};for(var d=0;d<e.value.length;d++){c[e.value[d]]=true}BX.Access.SetSelected(c);BX.Access.ShowForm({zIndex:5000,callback:function(g){var f=[];for(var h in g){if(g.hasOwnProperty(h)){for(var i in g[h]){if(g[h].hasOwnProperty(i)){f.push(g[h][i])}}}}b(f)}})}},selectCRM:function(d,b,c){if(!c){this.loadControl("crm_selector",{entityType:d.entityType,multiple:!!d.multiple?"Y":"N",value:d.value},BX.delegate(function(){BX.defer(this.messageInterface.selectCRM,this)(d,b,true)},this));return}if(!window.obCrm){setTimeout(BX.delegate(function(){BX.proxy(this.messageInterface.selectCRM,this)(d,b,true)},this),500)}else{obCrm.restCrmSelector.Open();obCrm.restCrmSelector.AddOnSaveListener(function(e){b(e);obCrm.restCrmSelector.Clear()})}},reloadWindow:function(){window.location.reload()},imCallTo:function(b){top.BXIM.callTo(b.userId,!!b.video)},imPhoneTo:function(b){top.BXIM.phoneTo(b.phone)},imOpenMessenger:function(b){top.BXIM.openMessenger(b.dialogId)},imOpenHistory:function(b){top.BXIM.openHistory(b.dialogId)},openApplication:function(c,b){BX.rest.AppLayout.openApplication(this.params.id,c,{},b)},closeApplication:function(d,b){var c=BX.message("REST_APPLICATION_VIEW_URL").replace("#APP#",this.params.appId);if(top.BX.SidePanel.Instance.isOpen()&&top.BX.SidePanel.Instance.getTopSlider().url.match(new RegExp("^"+c))){top.BX.SidePanel.Instance.close(false,b)}else{c=BX.message("REST_PLACEMENT_URL").replace("#PLACEMENT_ID#",parseInt(this.params.placementId));if(top.BX.SidePanel.Instance.isOpen()&&top.BX.SidePanel.Instance.getTopSlider().url.match(new RegExp("^"+c))){top.BX.SidePanel.Instance.close(false,b)}else{c=BX.message("REST_APPLICATION_URL").replace("#ID#",parseInt(this.params.id));if(top.BX.SidePanel.Instance.isOpen()&&top.BX.SidePanel.Instance.getTopSlider().url.match(new RegExp("^"+c))){top.BX.SidePanel.Instance.close(false,b)}}}}};BX.rest.AppLayout.MessageInterfacePlacement=BX.rest.AppLayout.initizalizePlacementInterface(BX.rest.AppLayout.MessageInterface);BX.rest.AppLayout.MessageInterfacePlacement.prototype.placementBindEvent=function(d,b){if(!!d.event&&BX.util.in_array(d.event,this.messageInterface.events)){var c=BX.delegate(function(){if(!this._destroyed){b.apply(this,arguments)}else{BX.removeCustomEvent(d.event,c)}},this);BX.addCustomEvent(d.event,c)}};BX.rest.layoutList={};BX.rest.placementList={};BX.rest.AppLayout.placementInterface={};BX.rest.AppLayout.get=function(b){return BX.rest.layoutList[b]};BX.rest.AppLayout.set=function(c,b,d){c=(c+"").toUpperCase();d.appSid=b;d.placement=c;BX.rest.layoutList[b]=new BX.rest.AppLayout(d);return BX.rest.layoutList[b]};BX.rest.AppLayout.getPlacement=function(b){return BX.rest.placementList[(b+"").toUpperCase()]};BX.rest.AppLayout.setPlacement=function(c,b){BX.rest.placementList[(c+"").toUpperCase()]=b};BX.rest.AppLayout.initialize=function(c,b){c=(c+"").toUpperCase();BX.rest.layoutList[c]=BX.rest.layoutList[b];BX.rest.layoutList[c].init()};BX.rest.AppLayout.destroy=function(c){var b=BX.rest.AppLayout.get(c);if(!!b){b.destroy()}BX.rest.layoutList[b.params.appSid]=null;if(!!BX.rest.AppLayout.placementInterface[c]){BX.rest.layoutList[c]=null}};function a(c,b){var d=c.split(b);return[d[0],d.slice(1,d.length-2).join(b),d[d.length-2],d[d.length-1]]}})();