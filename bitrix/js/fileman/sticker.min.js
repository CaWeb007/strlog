function BXSticker(b,c,a){this.MESS=a;this.Stickers=c||[];this.Params=b;this.sessid_get=b.sessid_get;this.bShowStickers=b.bShowStickers;this.curEditorStickerInd=false;this.oneGifSrc="/bitrix/images/1.gif";this.colorSchemes=[{name:"bxst-yellow",color:"#FFFCB3",title:this.MESS.Yellow},{name:"bxst-green",color:"#DBFCCD",title:this.MESS.Green},{name:"bxst-blue",color:"#DCE7F7",title:this.MESS.Blue},{name:"bxst-red",color:"#FCDFDF",title:this.MESS.Red},{name:"bxst-purple",color:"#F6DAF8",title:this.MESS.Purple},{name:"bxst-gray",color:"#F5F5F5",title:this.MESS.Gray}];this.curPageCount=this.Params.curPageCount;if(this.Params.useHotkeys){BX.bind(document,"keyup",BX.proxy(this.OnKeyUp,this))}window.__bxst_result={};if(b.bShowStickers){this.Init(b)}}BXSticker.prototype={Init:function(a){this.oMarkerConfig={attr:{title:true,src:true,href:true,alt:true,"class":true,className:true,id:true,name:true,type:true,value:true},impAttr:{src:true,id:true,name:true,href:true}};this.Params.changeColorEffect=true;this.arStickers=[];this.posReg={};this.bInited=true;this.access=this.Params.access;this._arSavedStickers={};BX.bind(document,"mousedown",BX.proxy(this.OnMousedown,this));var b=this;BX.addCustomEvent("onMenuOpen",function(){var c=BX.findChild(BX("bxst-show-sticker-icon"),{className:"icon"},true);if(c){if(b.bShowStickers){BX.addClass(c,"checked")}else{BX.removeClass(c,"checked")}}b.UpdateStickersCount()});this.DisplayStickers(!!a.bVisEffects);this.ShowEditor({ind:-1})},ShowAll:function(c,e){if(typeof c=="undefined"){c=!this.bShowStickers}var g=this;var f=BX.findChild(BX("bxst-show-sticker-icon"),{className:"icon"},true);if(f){if(c){BX.addClass(f,"checked")}else{BX.removeClass(f,"checked")}}this.bShowStickers=c;window.__bxst_result.show=null;window.__bxst_result.stickers=null;this.Request(c?"show_stickers":"hide_stickers",{pageUrl:this.Params.pageUrl,b_inited:this.bInited?"Y":"N"},function(h){if(g.bInited){return}g.bShowStickers=window.__bxst_result.show;if(window.__bxst_result.stickers){g.Stickers=window.__bxst_result.stickers;g.Params.bVisEffects=true;if(!g.bInited){g.Init(g.Params)}if(e){g.AddSticker()}}});if(!c){this.HideAll()}else{if(c&&this.bInited){var b;for(var d=0,a=this.arStickers.length;d<a;d++){b=this.arStickers[d];b.pWin.Get().style.display="block";b.pShadow.style.display="block";if(b.pMarker){b.pMarker.style.display=""}}}}},HideAll:function(){var b;for(var c=0,a=this.arStickers.length;c<a;c++){b=this.arStickers[c];b.pWin.Get().style.display="none";b.pShadow.style.display="none";if(b.pMarker){b.pMarker.style.display="none"}}},AddSticker:function(a,f,c){if(!this.bInited){return this.ShowAll(true,true)}if(!this.bShowStickers&&this.bInited){this.ShowAll(true,false)}if(this.curEditorStickerInd!==false){var e=this;this.SaveAndCloseEditor(this.curEditorStickerInd,true,true);return setTimeout(function(){e.AddSticker(a,f,c)},300)}var b;if(a){b=this.ConvertStickerObj(a)}else{b={bNew:true,personal:false,colorInd:parseInt(this.Params.start_color),width:parseInt(this.Params.start_width),height:parseInt(this.Params.start_height),collapsed:false,completed:false,info:"&nbsp;"}}var d=this.CreateWindow(b,!!f,c);if(b.bNew){this.SetMarker(d,"area")}},CreateWindow:function(p,y,j){var e=new BX.CWindow(false,"float");e.Show(true);e.Get().style.zIndex=e.zIndex=this.Params.zIndex;e.SETTINGS.min_width=this.Params.min_width;e.SETTINGS.min_height=this.Params.min_height;BX.addClass(e.Get(),"bx-sticker");e.DenyClose();var u=this.access=="R",s=!!p.bNew,v=this,n,m=this.arStickers.length,r=e.Get().appendChild(BX.create("DIV",{props:{className:"bxst-header",id:"bxst_head_"+m}})),h=r.appendChild(BX.create("DIV",{props:{className:"bxst-id-cont bxst-title"},html:p.id>0?'<a href="'+this.Params.pageUrl+"?show_sticker="+p.id+'"><span>'+p.id+"</span></a>":""})),D=r.appendChild(BX.create("DIV",{props:{className:"bxst-check-cont"}})),A=D.appendChild(BX.create("INPUT",{props:{id:"bxst_conplited_"+m,name:"bxst_conplited_"+m,type:"checkbox",value:"Y",title:this.MESS.Complete}})),w=D.appendChild(BX.create("LABEL",{attrs:{"for":"bxst_conplited_"+m,title:this.MESS.Complete},text:this.MESS.CompleteLabel})),b=r.appendChild(BX.create("DIV",{props:{id:"bxst_col_title_"+m,className:"bxst-col-title-cont",title:this.MESS.UnCollapseTitle}})),z=r.appendChild(BX.create("DIV",{props:{className:"bxst-close bxst-but",title:this.MESS.Close}})).appendChild(BX.create("IMG",{props:{id:"bxst_close_"+m,src:this.oneGifSrc,className:"bxst-sprite"}})),t=r.appendChild(BX.create("DIV",{props:{className:"bxst-collapse bxst-but"}})).appendChild(BX.create("IMG",{props:{id:"bxst_collapse_"+m,src:this.oneGifSrc,className:"bxst-sprite",title:this.MESS.Collapse}}));if(s||this.Params.curUserId==p.authorId){n=r.appendChild(BX.create("DIV",{props:{id:"bxst_type_"+m,className:"bxst-type-cont"}}));n.appendChild(BX.create("DIV",{props:{className:"bxst-type-l bxst-type-corn"}}));n.appendChild(BX.create("DIV",{props:{className:"bxst-type-c bxst-type-c-publ"}})).appendChild(BX.create("SPAN",{props:{},text:this.MESS.Public}));n.appendChild(BX.create("DIV",{props:{className:"bxst-type-c  bxst-type-c-pers"}})).appendChild(BX.create("SPAN",{props:{},text:this.MESS.Personal}));n.appendChild(BX.create("DIV",{props:{className:"bxst-type-r bxst-type-corn"}}));if(!u){n.onclick=function(){if(!e.__stWasDragged){v.SetType(parseInt(this.id.substr("bxst_type_".length)),true)}}}this.SetUnselectable([n])}var x=e.Get().appendChild(BX.create("DIV",{props:{id:"bxst_body_"+m,className:"bxst-content"}}));var l=x.appendChild(BX.create("DIV",{props:{id:"bxst_content_"+m,className:"bxst-content-area"}}));var g=e.Get().appendChild(BX.create("DIV",{props:{className:"bxst-footer"}})),c=g.appendChild(BX.create("DIV",{props:{className:"bxst-marker-area-but"}})).appendChild(BX.create("IMG",{props:{id:"bxst_marker_but0_"+m,src:this.oneGifSrc,className:"bxst-sprite",title:this.MESS.SetMarkerArea}})),a=g.appendChild(BX.create("DIV",{props:{className:"bxst-marker-elem-but"}})).appendChild(BX.create("IMG",{props:{id:"bxst_marker_but1_"+m,src:this.oneGifSrc,className:"bxst-sprite",title:this.MESS.SetMarkerEl}})),f=g.appendChild(BX.create("DIV",{props:{className:"bxst-ctrl-txt bxst-color-but"}})).appendChild(BX.create("SPAN",{props:{id:"bxst_color_"+m},text:this.MESS.Color})),E=g.appendChild(BX.create("DIV",{props:{className:"bxst-ctrl-txt bxst-add-but"}})).appendChild(BX.create("SPAN",{props:{id:"bxst_add_but_"+m},text:this.MESS.Add})),o=g.appendChild(BX.create("DIV",{props:{className:"bxst-resizer"}})).appendChild(BX.create("IMG",{props:{src:this.oneGifSrc,className:"bxst-sprite"}}));var d=g.appendChild(BX.create("DIV",{props:{className:"bxst-info-icon"}})).appendChild(BX.create("IMG",{props:{id:"bxst_info_"+m,src:this.oneGifSrc,className:"bxst-sprite"},style:{display:s?"none":"block"}}));var B=new BX.CHintSimple({parent:d,hint:p.info});if(u){BX.addClass(e.Get(),"bx-sticker-readonly")}var q=BX.GetWindowInnerSize();var C=BX.GetWindowScrollPos();if(s||p.left<=0||p.top<=0){p.left=e.Get().style.left=parseInt(C.scrollLeft+q.innerWidth/2-parseInt(e.Get().offsetWidth)/2)+Math.round(p.width/2);p.top=Math.max(parseInt(C.scrollTop+q.innerHeight/2-parseInt(e.Get().offsetHeight)/2),0)-Math.round(p.height/2)}e.StickerInd=m;if(s){E.style.display="none"}pShadow=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-shadow"},style:{zIndex:parseInt(e.Get().style.zIndex)-5}}));this.RegisterSticker({obj:p,pWin:e,pCheck:A,pCloseBut:z,pCollapseBut:t,pCollapsedTitle:b,pBody:x,pHead:r,pTypeCont:n||false,pContentArea:l,pIdsCont:h,pShadow:pShadow,bButPanelShowed:true,pMarkerAreaBut:c,pMarkerElementBut:a,pColorBut:f,pAddBut:E,pInfo:d,pHint:B,_over:!s&&!j,bButPanelShowed:!s&&!j});this.AdjustToSize(m,p.width,p.height);this.SetColorScheme(m,p.colorInd,false);this.SetType(m,false,p.personal?"personal":"public");this.SetCompleted(m,p.completed,false);this.CollapseSticker(m,false,p.collapsed);e.SetDraggable(r);BX.addCustomEvent(e,"onWindowDragStart",function(){this.__stWasDragged=true});BX.addCustomEvent(e,"onWindowDragFinished",function(){v.OnDragEnd(this)});BX.addCustomEvent(e,"onWindowDrag",function(){v.OnDragDrop(this)});e.SetResize(o);BX.addCustomEvent(e,"onWindowResize",function(){v.AdjustToSize(this.StickerInd)});BX.addCustomEvent(e,"onWindowResizeStart",function(){v.OnResizeStart(this)});BX.addCustomEvent(e,"onWindowResizeFinished",function(){v.OnResizeEnd(this)});r.ondblclick=function(){v.CollapseSticker(parseInt(this.id.substr("bxst_head_".length)),true)};t.onclick=function(){if(!e.__stWasDragged){v.CollapseSticker(parseInt(this.id.substr("bxst_collapse_".length)),true)}};if(!u){z.onclick=function(){if(!e.__stWasDragged){v.CloseSticker(parseInt(this.id.substr("bxst_close_".length)),true)}};E.onclick=function(){v.AddToSticker(parseInt(this.id.substr("bxst_add_but_".length)))};A.onclick=function(){if(!e.__stWasDragged){v.SetCompleted(parseInt(this.id.substr("bxst_conplited_".length)),!!this.checked,true)}};f.onclick=function(){v.ShowColorSelector(parseInt(this.id.substr("bxst_color_".length)))};c.onclick=function(){v.SetMarker(parseInt(this.id.substr("bxst_marker_but0_".length)),"area")};a.onclick=function(){v.SetMarker(parseInt(this.id.substr("bxst_marker_but1_".length)),"element")}}else{A.disabled=true}if(!s&&!j&&!p.collapsed){e.Get().style.height=(p.height-24)+"px"}if(s){var k=this.GetSuitablePosition(p.left,p.top);if(k!==true){p.left=k.left;p.top=k.top}}else{h.style.display="block"}this.RegisterPosition(p.left,p.top);e.Get().style.left=p.left+"px";e.Get().style.top=p.top+"px";this.AdjustShadow(m);this.SetUnselectable([z,t,f,c,c,o]);if(s||j===true){this.ShowEditor({ind:m});if(j){this.OnDivMouseOver(m,true);this.DisplayMarker(m)}}else{x.style.overflow="auto";l.innerHTML=p.html_content;this.DisplayMarker(m);if(p.id==this.Params.focusOnSticker){window.scrollTo(0,p.top>200?p.top-200:0);this.Hightlight(m,true);this.BlinkRed(m)}}if(!u){x.onclick=function(){if(!this.id){return}var F=parseInt(this.id.substr("bxst_body_".length));if(v.curEditorStickerInd!==F){v.ShowEditor({ind:F})}}}e.Get().onmouseover=function(){v.OnDivMouseOver(m,true)};e.Get().onmouseout=function(){v.OnDivMouseOver(m,false)};return m},UpdateNewSticker:function(b){var a=this.arStickers[b];a.pAddBut.style.display="block";a.pInfo.style.display="block";a.pIdsCont.style.display="block";a.pIdsCont.innerHTML='<a href="'+this.Params.pageUrl+"?show_sticker="+a.obj.id+'"><span>'+a.obj.id+"</span></a>";if(b===this.curEditorStickerInd&&typeof window.oLHESticker=="object"){setTimeout(function(){oLHESticker.SetFocusToEnd()},100);setTimeout(function(){oLHESticker.SetFocusToEnd()},500)}},RegisterPosition:function(b,c){var f=20,a=Math.round(b/f)*f,e=Math.round(c/f)*f;this.posReg[a+"_"+e]=true},GetSuitablePosition:function(b,c,f){var g=20,a=Math.round(b/g)*g,e=Math.round(c/g)*g;if(this.posReg[a+"_"+e]){return this.GetSuitablePosition(b+g,c+g,true)}else{if(f){return{left:b,top:c}}}return true},RegisterSticker:function(a){this.arStickers.push(a);return this.arStickers.length-1},AdjustToSize:function(e,b,d){var c,a=this.arStickers[e];if(typeof b=="undefined"||typeof d=="undefined"){b=parseInt(a.pWin.Get().style.width);d=parseInt(a.pWin.Get().style.height)}else{a.pWin.Get().style.width=b+"px";a.pWin.Get().style.height=d+"px"}if(BX.browser.IsIE()&&!BX.browser.IsDoctype()){c=d-19-27-0}else{c=d-19-24-0}if(window.oLHESticker){window.oLHESticker.pFrame.style.width=(b-2)+"px";window.oLHESticker.pFrame.style.height=(c-2)+"px";window.oLHESticker.ResizeFrame(c-2)}a.pCollapsedTitle.style.width=(b-100)+"px";a.pBody.style.height=c+"px";this.AdjustShadow(e)},AdjustShadow:function(b){var a=this.arStickers[b];if(a.obj.closed&&a.pShadow.parentNode){return a.pShadow.parentNode.removeChild(a.pShadow)}a.pShadow.style.top=(parseInt(a.pWin.Get().style.top)+4)+"px";a.pShadow.style.left=(parseInt(a.pWin.Get().style.left)+3)+"px";a.pShadow.style.width=a.pWin.Get().style.width;a.pShadow.style.height=a.pWin.Get().style.height},AdjustEditorSizeAndPos:function(b){var a=this.arStickers[b];this.pEditorCont.style.top=(parseInt(a.pWin.Get().style.top)+20)+"px";this.pEditorCont.style.left=a.pWin.Get().style.left;this.pEditorCont.style.width=a.pWin.Get().style.width;this.pEditorCont.style.height=a.pBody.style.height;this.pEditorCont.style.zIndex=parseInt(a.pWin.Get().style.zIndex)+10},AdjustHintToCursor:function(a,b){a.style.left=(b.realX+30)+"px";a.style.top=(b.realY-12)+"px"},AdjustScrollPosToCursor:function(){},AdjustStickerToArea:function(f){var b,g,d=BX.GetWindowInnerSize(document),a=BX.GetWindowScrollPos(document),c=this.arStickers[f],e=(c.obj.marker&&c.obj.marker.adjust)?0:10;if(c.pMarker&&c.obj.marker){b=c.obj.marker.left+c.obj.marker.width-60;g=c.obj.marker.top-c.obj.height+e;if(b+c.obj.width>d.innerWidth){b=d.innerWidth-c.obj.width-30}if(g<a.scrollTop+50){g=c.obj.marker.top+c.obj.marker.height-e}}this.MoveToPos(f,{left:b,top:g});c.obj.top=g;c.obj.left=b;if(this.arStickers[f].obj.id){this.SaveSticker(f)}},MoveToPos:function(l,a){var e=this.arStickers[l];var g=parseInt(e.obj.top),n=parseInt(e.obj.left),u=parseInt(a.top),b=parseInt(a.left),c=parseInt(g),h=parseInt(n),p=this,j=0,q=g>u,t=n>b,k=BX.browser.IsIE()?10:10,r=BX.browser.IsIE()?10:10,w=Math.ceil(Math.abs((n-b)/50)),v=Math.ceil(Math.abs((g-u)/50)),o=t?-w:w,m=q?-v:v;var f=function(x,d){if(x!==false){e.pWin.Get().style.top=x+"px"}if(d!==false){e.pWin.Get().style.left=d+"px"}p.AdjustShadow(l)};var s=setInterval(function(){if(u!=c&&c!==false){c+=Math.round(m*j/2)}if(b!=h&&h!==false){h+=Math.round(o*j/2)}if(c!==false&&(!q&&c>=u||q&&c<=u)){c=u}if(h!==false&&(!t&&h>=b||t&&h<=b)){h=b}f(c,h);if(c==u){c=false}if(h==b){h=false}if(c===false&&h===false){clearInterval(s);return p.OnDragEnd(e.pWin)}j++},k)},ChangeColor:function(e,c,d,a){var b=this.arStickers[e];if(!this.Params.changeColorEffect){d=false}if(d&&a===true){this.Params.start_color=c;return this.ShowColorOverlay(e,c,true)}else{if((d&&a===false)||!d){this.SetColorScheme(e,c,true);if(d){return this.ShowColorOverlay(e,c,false)}}}},SetColorScheme:function(d,b,e){if(d===this.curEditorStickerInd&&typeof window.oLHESticker=="object"){if(window.oLHESticker.pEditorDocument&&window.oLHESticker.pEditorDocument.body){window.oLHESticker.pEditorDocument.body.className=this.colorSchemes[b].name}}this.arStickers[d].obj.colorInd=b;for(var c=0,a=this.colorSchemes.length;c<a;c++){if(c==b){BX.addClass(this.arStickers[d].pWin.Get(),this.colorSchemes[c].name)}else{BX.removeClass(this.arStickers[d].pWin.Get(),this.colorSchemes[c].name)}}if(this.arStickers[d].pMarker){this.arStickers[d].pMarker.className="bxst-sticker-marker "+this.colorSchemes[b].name}if(e&&this.arStickers[d].obj.id>0){var f=this;if(this.arStickers[d]._colTimeout){clearTimeout(this.arStickers[d]._colTimeout);this.arStickers[d]._colTimeout=null}f.SaveSticker(d)}},SetType:function(d,e,c){var b=this.arStickers[d],a=(typeof c=="undefined")?!b.obj.personal:c=="personal";if(!b.pTypeCont){return}if(a){BX.addClass(b.pTypeCont,"bxst-type-pers");BX.removeClass(b.pTypeCont,"bxst-type-publ");b.pTypeCont.title=this.MESS.PersonalTitle}else{BX.addClass(b.pTypeCont,"bxst-type-publ");BX.removeClass(b.pTypeCont,"bxst-type-pers");b.pTypeCont.title=this.MESS.PublicTitle}b.obj.personal=a;if(b.obj.id&&e){this.SaveSticker(d)}},SetCompleted:function(a,c,b){this.arStickers[a].obj.completed=c;this.arStickers[a].pCheck.checked=c;if(this.arStickers[a].obj.id&&b){this.SaveSticker(a)}},CloseSticker:function(e,f,d){var c=this.arStickers[e];if(f&&c.obj.authorName&&this.Params.curUserId!=c.obj.authorId&&!confirm(this.MESS.CloseConfirm.replace("#USER_NAME#",c.obj.authorName))){return}c.obj.closed=!c.obj.closed;if(e===this.curEditorStickerInd){this.curEditorStickerInd=false}this.arStickers[e].pWin.Close(true);this.arStickers[e].pWin.onUnRegister(true);if(c.pMarkerNode){BX.removeClass(c.pMarkerNode,"bxst-sicked")}if(c.pMarker&&c.pMarker.parentNode){c.pMarker.parentNode.removeChild(c.pMarker)}this.AdjustShadow(e);if(this.arStickers[e].obj.id&&f){this.SaveSticker(e);BX.admin.panel.Notify(this.MESS.CloseNotify.replace(/(.*?)#LINK#(.*?)#LINK#/ig,'$1<span class="bxst-close-notify-link" onclick="window.oBXSticker.ShowList(\'current\'); return false;">$2</span>'))}var b=document.body.getElementsByTagName("A");if(b&&b[0]){BX.focus(b[0])}},CollapseSticker:function(b,c,d){var a=this.arStickers[b];if(typeof d=="undefined"){d=!a.obj.collapsed}if(c&&this.curEditorStickerInd===b){this.SaveAndCloseEditor(b,true,false)}if(d){BX.addClass(a.pWin.Get(),"bxst-collapsed");a.pCollapseBut.title=this.MESS.UnCollapse;a.pWin.Get().style.height="19px";a.pCollapsedTitle.innerHTML=this.GetCollapsedContent(a.obj.html_content)}else{BX.removeClass(a.pWin.Get(),"bxst-collapsed");a.pCollapseBut.title=this.MESS.Collapse;a.pWin.Get().style.height=parseInt(a.obj.height)+"px"}this.AdjustShadow(b);a.obj.collapsed=d;if(a.obj.id&&c){this.SaveSticker(b)}},OnDragEnd:function(b){setTimeout(function(){b.__stWasDragged=false},200);var a=b.StickerInd;this.arStickers[a].obj.top=parseInt(b.Get().style.top);this.arStickers[a].obj.left=parseInt(b.Get().style.left);this.SaveSticker(a)},OnDragDrop:function(a){this.AdjustShadow(a.StickerInd)},OnResizeEnd:function(b){var a=b.StickerInd;this.arStickers[a].bResizingNow=false;this.arStickers[a].obj.width=parseInt(b.Get().style.width);this.arStickers[a].obj.height=parseInt(b.Get().style.height);if(this.arStickers[a].obj.id){this.SaveSticker(a)}},OnResizeStart:function(a){this.arStickers[a.StickerInd].bResizingNow=true},ShowEditor:function(b){var c=b.ind===-1,d=this,a=this.arStickers[b.ind];if(!this.pEditorCont){this.pEditorCont=(c?document.body:a.pBody).appendChild(BX.create("DIV",{props:{className:"bxst-lhe-cont"}}))}this.pEditorCont.style.visibility="hidden";if(window.oLHESticker){if(this.bLoadLHEEditor){this.PrepareEditorAfterLoading();this.bLoadLHEEditor=false}if(!c){this.DisplayEditor(a,b.ind)}}else{if(!this.bLoadLHEEditor){this.Request("load_lhe",{},function(f){d.pEditorCont.innerHTML=f;var e=setInterval(function(){if(typeof window.LoadLHE_LHEBxStickers=="undefined"){return}clearInterval(e);if(!d.bLoadLHEEditor&&!window.oLHESticker){LoadLHE_LHEBxStickers()}return setTimeout(function(){d.bLoadLHEEditor=true;d.ShowEditor(b)},50)},50)})}else{if(d.bLoadLHEEditor&&!window.oLHESticker){return setTimeout(function(){d.ShowEditor(b)},50)}}}},PrepareEditorAfterLoading:function(){if(!oLHESticker){return}oLHESticker.oSpecialParsers.st_title={Parse:function(c,b,a){b=b.replace(/\[ST_TITLE\]((?:\s|\S)*?)\[\/ST_TITLE\]/ig,'<span id="'+a.SetBxTag(false,{tag:"st_title"})+'" class="bxst-title" >$1</span>');return b},UnParse:function(d,c,a){var b="[ST_TITLE]";for(i=0;i<c.arNodes.length;i++){b+=a._RecursiveGetHTML(c.arNodes[i])}b+="[/ST_TITLE]";return b}};BX.addCustomEvent(oLHESticker,"OnUnParseContentAfter",function(){this.__sContent=this.__sContent.replace(/\[\/ST_TITLE\](?:\n|\r)+/ig,"[/ST_TITLE]\n")})},DisplayEditor:function(a,f,c){var j=this;if(!c){a.pBody.appendChild(this.pEditorCont);this.AdjustToSize(f);oLHESticker.SetContent(a.obj.content||(this.GetNewStickerContent()+"\n"));oLHESticker.CreateFrame();oLHESticker.SetEditorContent(oLHESticker.content);window.oLHESticker.pEditorDocument.body.className=this.colorSchemes[a.obj.colorInd].name;if(this.Params.useHotkeys){BX.bind(window.oLHESticker.pEditorDocument,"keyup",BX.proxy(this.OnKeyUp,this))}setTimeout(function(){try{window.oLHESticker.pEditorDocument.execCommand("styleWithCSS",false,false)}catch(d){}},100);setTimeout(function(){try{window.oLHESticker.pEditorDocument.execCommand("styleWithCSS",false,false)}catch(d){}},500);setTimeout(function(){try{window.oLHESticker.pEditorDocument.execCommand("styleWithCSS",false,false)}catch(d){}},1000);this.curEditorStickerInd=f;a.pBody.style.overflow="hidden";var b=0,h=1,g=22;var e=setInterval(function(){if(b>=g){b=g}else{b+=h}a.pContentArea.style.top=b+"px";if(b==g){clearInterval(e);j.DisplayEditor(a,f,true)}},BX.browser.IsIE()?5:10)}else{setTimeout(function(){a.pBody.style.overflow="auto";j.pEditorCont.style.visibility="visible";a.pContentArea.style.display="none";j.pEditorCont.style.display="block";setTimeout(function(){oLHESticker.SetFocusToEnd()},100)},100)}},AddToSticker:function(b){var a=this.arStickers[b];if(this.curEditorStickerInd===b&&window.oLHESticker){oLHESticker.SetFocusToEnd();oLHESticker.InsertHTML("<br />"+oLHESticker.ParseContent(this.GetNewStickerContent())+"<br />");setTimeout(function(){oLHESticker.SetFocusToEnd()},100)}else{a.obj.content+="\n"+this.GetNewStickerContent();this.ShowEditor({ind:b})}},Request:function(d,e,c,a){a=a===true;if(a){BX.showWait()}var b="/bitrix/admin/fileman_stickers.php?sticker_action="+d+"&"+this.sessid_get+"&site_id="+this.Params.site_id;return BX.ajax.post(b,e||{},function(f){if(a){BX.closeWait()}if(c){setTimeout(function(){c(f)},10)}})},SetUnselectable:function(c){if(typeof c!="object"){c=[c]}for(var b=0,a=c.length;b<a;b++){BX.setUnselectable(c[b]);c[b].ondragstart=function(d){return BX.PreventDefault(d)}}},ShowColorOverlay:function(f,d,a){var g=this,e=0,c,b=this.arStickers[f];if(!this.pColorOverlay){this.pColorOverlay=document.body.appendChild(BX.create("DIV",{props:{className:"bx-sticker-overlay"}}))}this.pColorOverlay.style.zIndex=parseInt(b.pWin.Get().style.zIndex)+10;this.pColorOverlay.style.top=b.pWin.Get().style.top;this.pColorOverlay.style.left=b.pWin.Get().style.left;this.pColorOverlay.style.width=b.pWin.Get().style.width;this.pColorOverlay.style.height=b.pWin.Get().style.height;c=setInterval(function(){if(e>2){if(a){g.ChangeColor(f,d,true,false)}else{g.pColorOverlay.className="bx-sticker-overlay"}return clearInterval(c)}if(a){g.pColorOverlay.className="bx-sticker-overlay bx-sticker-op-"+e}else{g.pColorOverlay.className="bx-sticker-overlay bx-sticker-op-"+(3-e)}e++},20)},DisplayStickers:function(c){for(var b=0,a=this.Stickers.length;b<a;b++){this.AddSticker(this.Stickers[b],c)}},MousePos:function(a){if(window.event){a=window.event}if(a.pageX||a.pageY){a.realX=a.pageX;a.realY=a.pageY}else{if(a.clientX||a.clientY){a.realX=a.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft)-document.documentElement.clientLeft;a.realY=a.clientY+(document.documentElement.scrollTop||document.body.scrollTop)-document.documentElement.clientTop}}return a},SaveAndCloseEditor:function(e,d,c){if(!window.oLHESticker||this.bLoadLHEEditor){var g=this;return setTimeout(function(){g.SaveAndCloseEditor(e,d)},100)}var a=this.arStickers[e];oLHESticker.SaveContent();var b=oLHESticker.GetContent();var f=oLHESticker.ParseContent(b);a.obj.html_content=f;a.pContentArea.innerHTML=f;this.arStickers[e].obj.content=b;if(d!==false){a.pContentArea.style.display="block";this.pEditorCont.style.display="none";a.pContentArea.style.top="0px";a.pBody.style.overflow="auto";this.curEditorStickerInd=false}if(c!==false){this.SaveSticker(e)}},GetNewStickerContent:function(){var a=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")));return"[ST_TITLE]"+BX.util.htmlspecialchars(this.Params.curUserName)+" "+a+"[/ST_TITLE]\n"},SaveSticker:function(c){if(this.access=="R"){return}if(this.curEditorStickerInd===c){this.SaveAndCloseEditor(c,false,false)}var a=this.arStickers[c];var d=this;var b=Math.round(Math.random()*100000);window.__bxst_result[b]=false;if(typeof a.obj.content=="undefined"){a.obj.content=this.GetNewStickerContent()+"\n"}if(a.obj.bNew){if(this._arSavedStickers[c]){return}this._arSavedStickers[c]=true}this.Request("save_sticker",{reqid:b,id:a.obj.bNew?0:a.obj.id,page_url:this.Params.pageUrl,page_title:this.Params.pageTitle,personal:a.obj.personal?"Y":"N",content:a.obj.content,width:a.obj.width,height:a.obj.height,top:a.obj.top,left:a.obj.left,color:a.obj.colorInd,collapsed:a.obj.collapsed?"Y":"N",completed:a.obj.completed?"Y":"N",closed:a.obj.closed?"Y":"N",marker:a.obj.marker},function(){if(window.__bxst_result[b]){var e=!!a.obj.bNew;d.arStickers[c].obj=d.ConvertStickerObj(window.__bxst_result[b]);if(d.arStickers[c].pHint){d.arStickers[c].pHint.HINT=d.arStickers[c].obj.info;if(d.arStickers[c].pHint.CONTENT_TEXT){d.arStickers[c].pHint.CONTENT_TEXT.innerHTML=d.arStickers[c].obj.info}}if(e){d.UpdateNewSticker(c);if(!d.arStickers[c].obj.closed){d.curPageCount++;d.UpdateStickersCount()}}else{if(d.arStickers[c].obj.closed){d.curPageCount--;d.UpdateStickersCount()}}}window.__bxst_result[b]=null})},GetCollapsedContent:function(b){var a="";if(b.indexOf("bxst-title")!=-1){a=b.replace(/<span[^>]*?class="bxst-title"[^>]*?>((?:\s|\S)*?)<\/span>/ig,function(d,c){if(c.indexOf(String.fromCharCode(160))>0){return'<span class="bxst-title">'+c.substr(0,c.indexOf(String.fromCharCode(160)))+"</span> "}return c});a=a.replace(/<br( \/)?>/ig," ")}if(a!=""){return a}return b},ConvertStickerObj:function(a){return{bNew:false,id:parseInt(a.ID),personal:a.PERSONAL=="Y",colorInd:a.COLOR||0,content:a.CONTENT,html_content:a.HTML_CONTENT,top:parseInt(a.POS_TOP),left:parseInt(a.POS_LEFT),width:parseInt(a.WIDTH),height:parseInt(a.HEIGHT),collapsed:a.COLLAPSED=="Y",completed:a.COMPLETED=="Y",closed:a.CLOSED=="Y",info:a.INFO,authorName:a.AUTHOR,authorId:a.CREATED_BY,marker:(a.MARKER_ADJUST||a.MARKER_WIDTH||a.MARKER_HEIGHT)?{top:parseInt(a.MARKER_TOP),left:parseInt(a.MARKER_LEFT),width:parseInt(a.MARKER_WIDTH),height:parseInt(a.MARKER_HEIGHT),adjust:a.MARKER_ADJUST}:{}}},SetMarker:function(c,d){var e=this;var a=this.arStickers[c];this.bHightlightElementMode=false;this.bSelectAreaMode=false;BX.removeClass(a.pMarkerElementBut,"bxst-pressed");BX.removeClass(a.pMarkerAreaBut,"bxst-pressed");if(!this.oMarker){this.oMarker={}}this.oMarker.StickerInd=c;if(a.pMarkerNode){BX.removeClass(a.pMarkerNode,"bxst-sicked")}if(a.pMarker){a.pMarker.style.display="none";a.pMarker.style.top="-1000px"}if(a.markerResizer&&a.markerResizer.cont){a.markerResizer.cont.style.display="none"}if(a.obj&&a.obj.marker){a.obj.marker={}}this.oMarker.node=null;a.bSetMarkerMode=true;if(d=="area"){BX.addClass(a.pMarkerAreaBut,"bxst-pressed");setTimeout(function(){e.bSelectAreaMode=true},10);if(!this.oMarker.pOverlay){this.oMarker.pOverlay=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-marker-overlay"}}))}this.oMarker.pOverlay.style.display="block";var b=BX.GetWindowScrollSize(document);this.oMarker.pOverlay.style.width=b.scrollWidth+"px";this.oMarker.pOverlay.style.height=b.scrollHeight+"px";if(!this.oMarker.pCursorHint){this.oMarker.pCursorHint=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-cursor-hint"},text:this.MESS.CursorHint}))}this.oMarker.pCursorHint.style.top="";this.oMarker.pCursorHint.style.left="";this.oMarker.pCursorHint.style.display="block";this.oMarker.pWnd=document.body.appendChild(BX.create("DIV"));this.oMarker.pWnd.className="bxst-cur-marker "+this.colorSchemes[a.obj.colorInd].name}else{BX.addClass(a.pMarkerElementBut,"bxst-pressed");setTimeout(function(){e.bHightlightElementMode=true},10)}BX.bind(document,"mousemove",BX.proxy(this.OnMouseMove,this));BX.bind(document,"mouseup",BX.proxy(this.OnMouseUp,this))},OnMousedown:function(f){if(this.curEditorStickerInd!==false&&window.oLHESticker&&!window.oLHESticker.bPopup){var b=this.arStickers[this.curEditorStickerInd];if(b&&b.pWin.Get()){var m=this.bSelectAreaMode||this.bHightlightElementMode,g=3,h=parseInt(b.pWin.Get().style.top)-g,c=parseInt(b.pWin.Get().style.left)-g,k=c+parseInt(b.pWin.Get().style.width)+g*2,a=h+parseInt(b.pWin.Get().style.height)+g*2;f=this.MousePos(f);if(f.realX<c||f.realX>k||f.realY<h||f.realY>a){this.SaveAndCloseEditor(this.curEditorStickerInd,!m,!m)}}}if(this.bSelectAreaMode){f=this.MousePos(f);this.bDrawMarkerMode=true;if(this.oMarker.pCursorHint){this.oMarker.pCursorHint.style.display="none"}this.oMarker.from={top:f.realY,left:f.realX}}else{if(this.bHightlightElementMode){var l=false;if(this.pCurMarkeredNode){l=true;var j=this.pCurMarkeredNode.pNode.className;if(j&&(j.indexOf("bx-sticker")!=-1||j.indexOf("bxst")!=-1)&&j.indexOf("bxst-sicked")==-1){l=false}if(l){l=!BX.findParent(this.pCurMarkeredNode.pNode,{className:new RegExp("bx-sticker","ig")})}}if(l){return BX.PreventDefault(f)}else{this.MarkerHightlightNode()}}}},OnMouseMove:function(f){if(this.bHightlightElementMode){var g;if(f.target){g=f.target}else{if(f.srcElement){g=f.srcElement}}if(g.nodeType==3){g=g.parentNode}if(g&&g.nodeName){this.MarkerHightlightNode(g)}}if(this.bSelectAreaMode){f=this.MousePos(f);if(this.oMarker.pCursorHint){this.AdjustHintToCursor(this.oMarker.pCursorHint,f)}if(!this.bDrawMarkerMode){return}this.oMarker.to={top:f.realY,left:f.realX};var d=this.oMarker.from.top,c=this.oMarker.from.left,a=Math.abs(this.oMarker.to.left-this.oMarker.from.left),b=Math.abs(this.oMarker.to.top-this.oMarker.from.top);if(this.oMarker.to.top<=this.oMarker.from.top&&this.oMarker.to.left>=this.oMarker.from.left){d=this.oMarker.to.top;c=this.oMarker.from.left}else{if(this.oMarker.to.top>this.oMarker.from.top&&this.oMarker.to.left>this.oMarker.from.left){d=this.oMarker.from.top;c=this.oMarker.from.left}else{if(this.oMarker.to.top>this.oMarker.from.top&&this.oMarker.to.left<this.oMarker.from.left){d=this.oMarker.from.top;c=this.oMarker.to.left}else{if(this.oMarker.to.top<this.oMarker.from.top&&this.oMarker.to.left<this.oMarker.from.left){d=this.oMarker.to.top;c=this.oMarker.to.left}}}}this.oMarker.pWnd.style.display="block";this.oMarker.pWnd.style.width=a+"px";this.oMarker.pWnd.style.height=b+"px";this.oMarker.pWnd.style.top=d+"px";this.oMarker.pWnd.style.left=c+"px";this.oMarker.top=d;this.oMarker.left=c;this.oMarker.width=a;this.oMarker.height=b}},OnMouseUp:function(c){if(this.bHightlightElementMode&&this.pCurMarkeredNode){var b=false;var d=this.pCurMarkeredNode.pNode.className;if(d&&(d.indexOf("bx-sticker")!=-1||d.indexOf("bxst")!=-1)&&d.indexOf("bxst-sicked")==-1){b=true}if(!b){b=!!BX.findParent(this.pCurMarkeredNode.pNode,{className:new RegExp("bx-sticker","ig")})}if(!b){this.oMarker.node=this.pCurMarkeredNode.pNode}}this.bDrawMarkerMode=false;this.bHightlightElementMode=false;this.bSelectAreaMode=false;if(this.oMarker.StickerInd>=0&&this.arStickers[this.oMarker.StickerInd]){var a=this.arStickers[this.oMarker.StickerInd];BX.removeClass(a.pMarkerElementBut,"bxst-pressed");BX.removeClass(a.pMarkerAreaBut,"bxst-pressed");a.bSetMarkerMode=false}BX.unbind(document,"mousemove",BX.proxy(this.OnMouseMove,this));BX.unbind(document,"mouseup",BX.proxy(this.OnMouseUp,this));if(this.oMarker.pOverlay){this.oMarker.pOverlay.style.display="none"}if(this.oMarker.pCursorHint){this.oMarker.pCursorHint.style.display="none"}if(!b){this.CreateMarker(this.oMarker)}},MarkerHightlightNode:function(a){if(this.pCurMarkeredNode){if(this.pCurMarkeredNode.onclick){this.pCurMarkeredNode.pNode.onclick=this.pCurMarkeredNode.onclick}if(this.pCurMarkeredNode.onmousedown){this.pCurMarkeredNode.pNode.onmousedown=this.pCurMarkeredNode.onmousedown}BX.removeClass(this.pCurMarkeredNode.pNode,"bxst-sicked")}if(a){this.pCurMarkeredNode={pNode:a};if(a.onclick){this.pCurMarkeredNode.onclick=a.onclick}if(a.onmousedown){this.pCurMarkeredNode.onmousedown=a.onmousedown}a.onmousedown=BX.proxy(this.OnMousedown,this);a.onclick=function(){return BX.PreventDefault(arguments[0])};BX.addClass(a,"bxst-sicked")}else{this.pCurMarkeredNode=false}},CreateMarker:function(b){if(!b){return}var a=this.arStickers[b.StickerInd];if(b.node){a.pMarkerNode=b.node;a.obj.marker={adjust:this.GetNodeAdjustInfo(b.node)};var c=BX.pos(a.pMarkerNode);if(c){a.obj.marker.top=c.top-2;a.obj.marker.left=c.left-2;a.obj.marker.width=c.width-4;a.obj.marker.height=c.height-4}}else{a.obj.marker={top:b.top,left:b.left,width:b.width,height:b.height}}if(a.obj.marker&&(a.obj.marker.adjust||(a.obj.marker.width&&a.obj.marker.height&&a.obj.marker.top&&a.obj.marker.left))){this.DisplayMarker(b.StickerInd,true);this.AdjustStickerToArea(b.StickerInd)}if(this.oMarker.pWnd){this.oMarker.pWnd.style.display="none"}if(!a.pWin.__stWasDragged){this.SaveSticker(b.StickerInd)}},DisplayMarker:function(c,b){var a=this.arStickers[c];if(a.pMarker){a.pMarker.style.display="none"}if(a.obj.marker&&a.obj.marker.adjust){if(!a.pMarkerNode){a.pMarkerNode=this.FindMarkerNode(a.obj.marker.adjust)}if(a.pMarkerNode){var d=BX.pos(a.pMarkerNode);if(d){if(!a.pMarker){a.pMarker=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-sticker-marker "+this.colorSchemes[a.obj.colorInd].name}}))}if(b){BX.addClass(a.pMarker,"bxst-marker-over")}a.pMarker.style.display="";a.pMarker.style.width=(d.width-4)+"px";a.pMarker.style.height=(d.height-4)+"px";a.pMarker.style.top=(d.top-2)+"px";a.pMarker.style.left=(d.left-2)+"px"}BX.removeClass(a.pMarkerNode,"bxst-sicked");return}}if(a.obj.marker&&a.obj.marker.width>0){if(!a.pMarker){a.pMarker=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-sticker-marker "+this.colorSchemes[a.obj.colorInd].name}}))}if(b){BX.addClass(a.pMarker,"bxst-marker-over")}a.pMarker.style.display="";a.pMarker.style.width=a.obj.marker.width+"px";a.pMarker.style.height=a.obj.marker.height+"px";a.pMarker.style.top=a.obj.marker.top+"px";a.pMarker.style.left=a.obj.marker.left+"px"}},GetNodeAdjustInfo:function(b){var a=this._GetNodeAdjustInfo(b);a=this._GetNodeAdjustSiblings(b,a);return a},_GetNodeAdjustInfo:function(d){var c={nodeName:d.nodeName.toLowerCase(),attr:{},innerHTML:null};if(d.innerHTML&&d.innerHTML.length){c.innerHTML=BX.util.trim(d.innerHTML.toLowerCase());c.innerHTML=c.innerHTML.replace(/class=""/ig,"");c.innerHTML=c.innerHTML.replace(/class=''/ig,"");c.innerHTML=c.innerHTML.replace(/\n+/ig,"");c.innerHTML=c.innerHTML.replace(/\r+/ig,"");c.innerHTML=c.innerHTML.replace(/\s+/ig," ");if(c.innerHTML.length>250){c.innerHTML=c.innerHTML.substr(0,250)}}if(d.attributes){var b,a=d.attributes.length;for(b=0;b<a;b++){name=d.attributes[b].name;if(!name||typeof name!="string"){continue}name=name.toLowerCase();if(this.oMarkerConfig.attr[name]){val=d.attributes[b].value;if(name=="class"||name=="classname"){name="classname";val=val.replace("bxst-sicked","");val=BX.util.trim(val)}if(val.length>0){c.attr[name]=val}}}}return c},_GetNodeAdjustSiblings:function(h,e){e.withId={};var c=BX.findParent(h,{attr:{id:new RegExp(".+","ig")}});if(c){e.withId.parent=c.getAttribute("id")}var g=BX.findChild(h,{attr:{id:new RegExp(".+","ig")}},true,true);if(g){e.withId.children=[];for(var d=0,b=g.length;d<b;d++){e.withId.children.push(g[d].getAttribute("id"))}}var f=BX.findPreviousSibling(h,{attr:{id:new RegExp(".+","ig")}});if(f){e.withId.prevSibling=f.getAttribute("id")}var a=BX.findNextSibling(h,{attr:{id:new RegExp(".+","ig")}});if(a){e.withId.nextSibling=a.getAttribute("id")}return e},FindMarkerNode:function(p){var e=false;if(!p||!p.nodeName){return false}if(!p.attr){p.attr={}}if(p.attr.id){e=BX(p.attr.id)}var m=[];var k;if(!e){if(!p.withId){p.withId={}}if(p.withId.prevSibling){var h=BX(p.withId.prevSibling);if(h){while(h=h.nextSibling){k=this.TestNodeWithAttributes(h,p);if(k){m.push(k)}if(k.coincide==100){break}}}}if(p.withId.nextSibling){var a=BX(p.withId.nextSibling);if(a){while(a=a.previousSibling){k=this.TestNodeWithAttributes(a,p);if(k){m.push(k)}if(k.coincide==100){break}}}}if(p.withId.children){var j,g=p.withId.children.length,c,b;for(j=0;j<g;j++){c=BX(p.withId.children[j]);if(c){b=c;while(true){b=BX.findParent(b,{tagName:p.nodeName});if(!b){break}k=this.TestNodeWithAttributes(a,p);if(k){m.push(k)}if(k.coincide==100){break}}}}}var n;if(p.withId.parent){n=BX(p.withId.parent)}if(!n){n=document.body}var d=n.getElementsByTagName(p.nodeName);var j,g=d.length;for(j=0;j<g;j++){k=this.TestNodeWithAttributes(d[j],p);if(k){m.push(k)}if(k.coincide==100){break}}}else{m.push({coincide:100,node:e,bImpAttrCoincide:true})}var j,g=m.length;var f=[],o=0,q=false;for(j=0;j<g;j++){if(m[j].coincide>o){o=m[j].coincide;q=m[j].node;f=[]}if(m[j].coincide==o&&m[j].node!=q){f.push(m[j].node)}}if(f.length==0&&q){return q}else{f[0]}return false},TestNodeWithAttributes:function(e,d){if(!e||!e.nodeName){return false}var c={coincide:0,node:e};var g=this._GetNodeAdjustInfo(e);if(g.nodeName!=d.nodeName){return false}var h=0;var a=typeof d.innerHTML=="string";if(typeof g.innerHTML!="string"&&a){return false}var f=0;for(i in d.attr){if(typeof d.attr[i]=="string"){f++}}if(f>0){h=100/(f+(a?1:0));var b=true;for(i in d.attr){if(typeof d.attr[i]=="string"){if(d.attr[i]==g.attr[i]){c.coincide+=h}else{if(this.oMarkerConfig.impAttr[i]){b=false}}}}c.bImpAttrCoincide=b}if(a&&g.innerHTML==d.innerHTML){c.coincide+=f>0?h:95}c.coincide=Math.round(c.coincide);if(c.coincide>0){return c}return false},OnDivMouseOver:function(b,d){var a=this.arStickers[b];if(a.bSetMarkerMode){return this.ShowButtonsPanel(b,true,false)}a._over=d;if(a._overTimeout){clearTimeout(a._overTimeout)}var c=this;a._overTimeout=setTimeout(function(){if(a._over==d){c.ShowButtonsPanel(b,d);c.Hightlight(b,d)}},d?100:500)},ShowButtonsPanel:function(b,o,a){if(!this.Params.bHideBottom){o=true;a=false}a=a!==false;var k=this,c=this.arStickers[b],j=24,n=3,g=1,m=c.obj.height-(c.bButPanelShowed?0:j),l=m+j*(o?1:-1),e=BX.browser.IsIE()?3:10;if(this.bSelectAreaMode||this.bHightlightElementMode||c.obj.collapsed||c.obj.closed||c.bColSelShowed||c.bResizingNow){return}if(c.bButPanelShowed==o){c.pWin.Get().style.height=m+"px";return this.AdjustShadow(b)}var f=setInterval(function(){m+=n*g*(o?1:-1);if(o&&m>=l||!o&&m<=l){m=l}c.pWin.Get().style.height=m+"px";k.AdjustShadow(b);if(m==l){clearInterval(f);c.bButPanelShowed=o}g++},e)},ShowColorSelector:function(f){var h=this,d=this.arStickers[f],a;if(!d){return}if(!d.pColSelector){d.pColSelector=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-col-sel"}}));for(var e=0,c=this.colorSchemes.length;e<c;e++){a=d.pColSelector.appendChild(BX.create("SPAN",{props:{id:"bxst_"+f+"_"+e,className:"bxst-col-pic "+this.colorSchemes[e].name,title:this.colorSchemes[e].title}}));a.onclick=function(){h.ChangeColor(f,parseInt(this.id.substr(("bxst_"+f+"_").length)),true,true);h.ShowColorSelector(f)}}d.pColSelector.style.zIndex=this.Params.zIndex+20}d.bColSelShowed=!d.bColSelShowed;if(d.bColSelShowed){var g=BX.pos(d.pColorBut);d.pColSelector.style.top=(parseInt(g.top)+16)+"px";d.pColSelector.style.left=(g.left)+"px";d.pColSelector.style.display="block";this.ShowOverlay(true,this.Params.zIndex+15);this.pTransOverlay.onmousedown=function(){h.ShowColorSelector(f)};BX.bind(document,"keydown",BX.proxy(function(b){this.OnKeyDown(b,f)},this))}else{d.pColSelector.style.display="none";this.ShowOverlay(false);BX.unbind(document,"keydown",BX.proxy(function(b){this.OnKeyDown(b,f)},this))}},ShowOverlay:function(a,c){if(!this.pTransOverlay){this.pTransOverlay=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-trans-overlay"}}))}if(a){this.pTransOverlay.style.display="block";this.pTransOverlay.style.zIndex=c||800;var b=BX.GetWindowScrollSize(document);this.pTransOverlay.style.width=b.scrollWidth+"px";this.pTransOverlay.style.height=b.scrollHeight+"px"}else{this.pTransOverlay.style.display="none";this.pTransOverlay.onmousedown=BX.False}},OnKeyDown:function(d,c){if(!d){d=window.event}var b=d.which||d.keyCode;if(b==27){var a=this.arStickers[c];if(a&&a.bColSelShowed){this.ShowColorSelector(c)}}},Hightlight:function(b,c){var a=this.arStickers[b];if(a.bOver===c){return}a.bOver=c;if(c){if(a.pMarker){BX.addClass(a.pMarker,"bxst-marker-over")}BX.addClass(a.pWin.Get(),"bx-sticker-over");BX.addClass(a.pHead,"bxst-header-over");a.pWin.Get().style.top=(parseInt(a.pWin.Get().style.top)-1)+"px";a.pWin.Get().style.left=(parseInt(a.pWin.Get().style.left)-1)+"px"}else{if(a.pMarker){BX.removeClass(a.pMarker,"bxst-marker-over")}BX.removeClass(a.pWin.Get(),"bx-sticker-over");BX.removeClass(a.pHead,"bxst-header-over");a.pWin.Get().style.top=(parseInt(a.pWin.Get().style.top)+1)+"px";a.pWin.Get().style.left=(parseInt(a.pWin.Get().style.left)+1)+"px"}},BlinkRed:function(f){var g=this,e=4,d=0,c=0,b,a=this.arStickers[f];if(!this.pBlinkRed){this.pBlinkRed=document.body.appendChild(BX.create("DIV",{props:{className:"bxst-blink-red"}}))}this.pBlinkRed.style.zIndex=parseInt(a.pWin.Get().style.zIndex)+10;this.pBlinkRed.style.top=a.pWin.Get().style.top;this.pBlinkRed.style.left=a.pWin.Get().style.left;this.pBlinkRed.style.width=a.pWin.Get().style.width;this.pBlinkRed.style.height=a.pWin.Get().style.height;bFadeIn=true;b=setInterval(function(){if(d>2){if(bFadeIn){g.pBlinkRed.className="bxst-blink-red bx-sticker-op-3";d=1}else{g.pBlinkRed.className="bxst-blink-red";d=0}c++;bFadeIn=!bFadeIn;if(c>=e){clearInterval(b)}return}if(bFadeIn){g.pBlinkRed.className="bxst-blink-red bx-sticker-op-"+d}else{g.pBlinkRed.className="bxst-blink-red bx-sticker-op-"+(3-d)}d++},BX.browser.IsIE()?30:60)},ShowList:function(a){if(!this.List){this.List=new BXStickerList(this)}this.List.Show(a)},OnKeyUp:function(b){if(!b){b=window.event}var a=b.which||b.keyCode;if(a==17){var c=this;this._bCtrlPressed=true;setTimeout(function(){c._bCtrlPressed=false},400)}else{if(a==16){var c=this;this._bShiftPressed=true;setTimeout(function(){c._bShiftPressed=false},400)}else{if((this._bShiftPressed||b.shiftKey)&&(b.ctrlKey||this._bCtrlPressed)){if(a==83&&this.Params.access=="W"){this.AddSticker();return BX.PreventDefault(b)}else{if(a==88){this.ShowAll();return BX.PreventDefault(b)}else{if(a==76){this.ShowList("current");return BX.PreventDefault(b)}}}}}}},UpdateStickersCount:function(){if(this.curPageCount<0||isNaN(parseInt(this.curPageCount))){this.curPageCount=0}var a=BX.findChild(BX("bxst-show-sticker-icon"),{tagName:"B"},true);if(a){a.innerHTML="("+this.curPageCount+")"}}};function BXStickerList(a){this.BXSticker=a;this.access=this.BXSticker.access;this.MESS=this.BXSticker.MESS;this.arCurPageIds={}}BXStickerList.prototype={Show:function(b){if(this.bShowed){return}var a={content_url:"/bitrix/admin/fileman_stickers.php?sticker_action=show_list&"+this.BXSticker.sessid_get+"&cur_page="+encodeURIComponent(this.BXSticker.Params.pageUrl)+"&type="+b+"&site_id="+this.BXSticker.Params.site_id,title:this.MESS.StickerListTitle,width:this.BXSticker.Params.listWidth,height:this.BXSticker.Params.listHeight,min_width:800,min_height:400,resizable:true,resize_id:"bx_sticker_list_resize_id"};this.type=b;this.bRefreshPage=false;this.naviSize=this.BXSticker.Params.listNaviSize;this.oDialog=new BX.CDialog(a);this.oDialog.Show();this.oDialog.SetButtons([this.oDialog.btnClose]);this.bShowed=true;var c=this;BX.addCustomEvent(this.oDialog,"onWindowUnRegister",function(){c.bShowed=false;if(c.bRefreshPage){window.location=window.location}});BX.addCustomEvent(this.oDialog,"onWindowResizeFinished",function(){c.AdjustNaviSize()});BX.addCustomEvent(this.oDialog,"onWindowExpand",function(){c.AdjustNaviSize()});BX.addCustomEvent(this.oDialog,"onWindowNarrow",function(){c.AdjustNaviSize()})},OnLoad:function(g){this.pAllBut=BX("bxstl_fil_all_but");this.pMyBut=BX("bxstl_fil_my_but");this.pColorCont=BX("bxstl_col_cont");this.pOpenedBut=BX("bxstl_fil_opened_but");this.pClosedBut=BX("bxstl_fil_closed_but");this.pAllStickersBut=BX("bxstl_fil_all_p_but");this.pItemsTable=BX("bxstl_items_table");this.pItemsTableCnt=BX("bxstl_items_table_cnt");this.pNaviCont=BX("bxstl_navi_cont");if(this.access=="W"){this.pActionSel=BX("bxstl_action_sel");this.pActionBut=BX("bxstl_action_ok")}this.pPageSelect=BX("bxstl_fil_page_sel");if(this.type=="current"){this.BXSticker.Params.filterParams.status="all";this.BXSticker.Params.filterParams.page="current"}else{if(this.type=="all"){this.BXSticker.Params.filterParams.status="opened";this.BXSticker.Params.filterParams.page="all"}}var h=this;var f=this.BXSticker.Params.filterParams.colors;if(f&&f!="all"&&f.length>0){this.checkedColors=[false,false,false,false,false,false];for(var e=0,a=f.length;e<a;e++){if(f[e]!=99){this.checkedColors[parseInt(f[e])]=true}}}else{this.checkedColors=[true,true,true,true,true,true]}if(!this.bRefreshPage&&window.__bxst_result.cur_page_ids!==false&&typeof window.__bxst_result.cur_page_ids=="object"){for(var e in window.__bxst_result.cur_page_ids){this.arCurPageIds[parseInt(window.__bxst_result.cur_page_ids[e])]=true}}var e,a=this.BXSticker.colorSchemes.length,c,d,b=(BX.browser.IsIE()&&!BX.browser.IsDoctype())?'style="width: 12px; height: 12px"':"";for(e=0;e<a;e++){c=this.BXSticker.colorSchemes[e];d=this.pColorCont.appendChild(BX.create("DIV",{props:{id:"bxstl_color_"+e,className:"bxstl-color-pick"+(this.checkedColors[e]?" bxstl-color-pick-ch":""),title:c.title},html:'<div class="bxstl-col-pic-l"></div><div class="bxstl-col-pic-c"><div class="'+c.name+'" '+b+'>&nbsp;</div></div><div class="bxstl-col-pic-r"></div>'}));d.onclick=function(){var j=parseInt(this.id.substr("bxstl_color_".length));h.checkedColors[j]=!h.checkedColors[j];if(h.checkedColors[j]){BX.addClass(this,"bxstl-color-pick-ch")}else{BX.removeClass(this,"bxstl-color-pick-ch")}h.ReloadList()}}this.SetStickerType(this.BXSticker.Params.filterParams.type,false);this.pAllBut.onclick=function(){h.SetStickerType("all")};this.pMyBut.onclick=function(){h.SetStickerType("my")};this.SetStickerStatus(this.BXSticker.Params.filterParams.status,false);this.pOpenedBut.onclick=function(){h.SetStickerStatus("opened")};this.pClosedBut.onclick=function(){h.SetStickerStatus("closed")};this.pAllStickersBut.onclick=function(){h.SetStickerStatus("all")};if(this.access=="W"){this.pActionBut.onclick=function(){h.Action()}}this.pPageSelect.onchange=function(){h.SetPage(this.value)};this.SetPage(this.BXSticker.Params.filterParams.page=="current"?this.BXSticker.Params.pageUrl:this.BXSticker.Params.filterParams.page,false);g=parseInt(g);this.oDialog.SetTitle(this.MESS.StickerListTitle+" ("+g+")");this.EnableActionBut(false)},SetStickerStatus:function(a,b){if(a=="opened"){BX.addClass(this.pOpenedBut,"bxstl-but-checked");BX.removeClass(this.pClosedBut,"bxstl-but-checked");BX.removeClass(this.pAllStickersBut,"bxstl-but-checked")}else{if(a=="closed"){BX.removeClass(this.pOpenedBut,"bxstl-but-checked");BX.addClass(this.pClosedBut,"bxstl-but-checked");BX.removeClass(this.pAllStickersBut,"bxstl-but-checked")}else{BX.removeClass(this.pOpenedBut,"bxstl-but-checked");BX.removeClass(this.pClosedBut,"bxstl-but-checked");BX.addClass(this.pAllStickersBut,"bxstl-but-checked")}}this.StickersStatus=a;if(b!==false){this.ReloadList()}},SetStickerType:function(a,b){if(a=="all"){BX.addClass(this.pAllBut,"bxstl-but-checked");BX.removeClass(this.pMyBut,"bxstl-but-checked")}else{BX.addClass(this.pMyBut,"bxstl-but-checked");BX.removeClass(this.pAllBut,"bxstl-but-checked")}this.StickersType=a;if(b!==false){this.ReloadList()}},SetPage:function(b,a){this.pPageSelect.value=b;this.StickersPage=b;if(a!==false){this.ReloadList()}},NaviGet:function(a,c){var b={};b["PAGEN_"+c]=a;this.ReloadList(b)},ReloadList:function(c){var d=this;if(!c){c={}}c.sticker_just_res="Y";c.colors=[99];c.sticker_type=this.StickersType;c.sticker_status=this.StickersStatus;c.sticker_page=this.StickersPage;c.navi_size=this.naviSize;c.cur_page=this.BXSticker.Params.pageUrl;c.type=this.type;var b,a=this.checkedColors.length;for(b=0;b<a;b++){if(this.checkedColors[b]===true){c.colors.push(b)}}window.__bxst_result.list_rows_count=false;window.__bxst_result.cur_page_ids=false;this.BXSticker.Request("show_list",c,function(e){var g=e.split("#BX_STICKER_SPLITER#");if(g.length==2){d.pItemsTableCnt.innerHTML=g[0];d.pNaviCont.innerHTML=g[1]}if(window.__bxst_result.list_rows_count!==false){d.oDialog.SetTitle(d.MESS.StickerListTitle+" ("+parseInt(window.__bxst_result.list_rows_count)+")")}if(!d.bRefreshPage&&window.__bxst_result.cur_page_ids!==false&&typeof window.__bxst_result.cur_page_ids=="object"){for(var f in window.__bxst_result.cur_page_ids){d.arCurPageIds[parseInt(window.__bxst_result.cur_page_ids[f])]=true}}d.pItemsTable=BX("bxstl_items_table");d.EnableActionBut(false)},true)},AdjustToSize:function(a,b){return},AdjustNaviSize:function(){var b,a=parseInt(this.oDialog.GetContent().style.height),d=40,c=(a-100-80);if(c!=(d*this.naviSize)){b=Math.floor(c/d)}if(b<5){b=5}if(b>30){b=30}if(this.naviSize!=b){this.naviSize=b;this.ReloadList()}},CheckAll:function(d){var c,b=this.pItemsTable.rows.length,a=false;for(c=1;c<b;c++){if(this.pItemsTable.rows[c].cells.length==7){this.pItemsTable.rows[c].cells[6].firstChild.checked=!!d;a=true}}if(a){this.EnableActionBut(d)}},Action:function(){if(this.access!="W"){return}var c=this.pActionSel.value;if(c==""||(c=="del"&&!confirm(this.MESS.DelConfirm))){return}var b,a=this.pItemsTable.rows.length,d=[];for(b=1;b<a;b++){if(this.pItemsTable.rows[b].cells.length<7){continue}ch=this.pItemsTable.rows[b].cells[6].firstChild;if(ch.checked){d.push(ch.value);if(!this.bRefreshPage&&this.arCurPageIds[parseInt(ch.value)]){this.bRefreshPage=true}}}this.ReloadList({list_action:c,list_ids:d})},EnableActionBut:function(b){if(this.access!="W"){return}if(b=="check"){var c,a=this.pItemsTable.rows.length,b=false;for(c=1;c<a;c++){if(this.pItemsTable.rows[c].cells.length<7){continue}if(this.pItemsTable.rows[c].cells[6].firstChild.checked){b=true;break}}}this.pActionBut.disabled=!b;this.pActionSel.disabled=!b}};