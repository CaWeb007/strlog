function JCLightHTMLEditor(a){this.Init(a)}JCLightHTMLEditor.items={};JCLightHTMLEditor.prototype={Init:function(q){this.id=q.id;JCLightHTMLEditor.items[this.id]=this;var o=this;this.arConfig=q;this.bxTags={};this.bFocused=false;q.timeoutCount=q.timeoutCount||0;this.bPopup=false;this.buttonsIndex={};this.parseAlign=true;this.parseTable=true;this.lastCursorId="bxed-last-cursor";this.bHandleOnPaste=this.arConfig.bHandleOnPaste!==false;this.arBBTags=["p","u","div","table","tr","td","th","img","a","center","left","right","justify"];this._turnOffCssCount=0;if(this.arConfig.arBBTags){this.arBBTags=this.arBBTags.concat(this.arConfig.arBBTags)}this.arConfig.width=this.arConfig.width?parseInt(this.arConfig.width)+(this.arConfig.width.indexOf("%")==-1?"px":"%"):"100%";this.arConfig.height=this.arConfig.height?parseInt(this.arConfig.height)+(this.arConfig.height.indexOf("%")==-1?"px":"%"):"100%";this.SetConstants();this.sEditorMode="html";this.toolbarLineCount=1;this.CACHE={};this.arVideos={};this.content=this.arConfig.content;this.oSpecialParsers={};BX.onCustomEvent(window,"LHE_OnBeforeParsersInit",[this]);this.oSpecialParsers.cursor={Parse:function(j,i,h){return i.replace(/#BXCURSOR#/ig,'<span id="'+h.lastCursorId+'"></span>')},UnParse:function(j,i,h){return"#BXCURSOR#"}};if(q.parsers){for(var a in q.parsers){if(q.parsers[a]){this.oSpecialParsers[a]=q.parsers[a]}}}this.bDialogOpened=false;this.pFrame=BX("bxlhe_frame_"+this.id);if(!this.pFrame){if(q.timeoutCount<100){setTimeout(function(){q.timeoutCount++;o.Init(q)},1)}return}this.pFrame.style.display="block";this.pFrame.style.width=this.arConfig.width;this.pFrame.style.height=this.arConfig.height;this.pFrameTable=this.pFrame.firstChild;this.pButtonsCell=this.pFrameTable.rows[0].cells[0];this.pButtonsCont=this.pButtonsCell.firstChild;this.pEditCont=this.pFrameTable.rows[1].cells[0];if(this.arConfig.height.indexOf("%")==-1){var n=parseInt(this.arConfig.height)-this.toolbarLineCount*27;if(n>0){this.pEditCont.style.height=n+"px"}}this.CreateFrame();this.pSourceDiv=this.pEditCont.appendChild(BX.create("DIV",{props:{className:"lha-source-div"}}));this.pTextarea=this.pSourceDiv.appendChild(BX.create("TEXTAREA",{props:{className:"lha-textarea",rows:25,id:this.arConfig.inputId}}));this.pHiddenInput=this.pFrame.appendChild(BX.create("INPUT",{props:{type:"hidden",name:this.arConfig.inputName}}));this.pTextarea.onfocus=function(){o.bTextareaFocus=true};this.pTextarea.onblur=function(){o.bTextareaFocus=false};this.pTextarea.style.fontFamily=this.arConfig.fontFamily;this.pTextarea.style.fontSize=this.arConfig.fontSize;this.pTextarea.style.fontSize=this.arConfig.lineHeight;if(this.pHiddenInput.form){BX.bind(this.pHiddenInput.form,"submit",function(){try{o.SaveContent();o.pHiddenInput.value=o.pTextarea.value=o.pHiddenInput.value.replace(/#BXCURSOR#/ig,"")}catch(h){}})}if(this.arConfig.arSmiles&&this.arConfig.arSmiles.length>0){this.sortedSmiles=[];var g,c,m,f,d,e;for(g=0,c=this.arConfig.arSmiles.length;g<c;g++){m=this.arConfig.arSmiles[g];if(!m.codes||m.codes==m.code){this.sortedSmiles.push(m)}else{if(m.codes.length>0){e=m.codes.split(" ");for(f=0,d=e.length;f<d;f++){this.sortedSmiles.push({name:m.name,path:m.path,code:e[f]})}}}}this.sortedSmiles=this.sortedSmiles.sort(function(i,h){return h.code.length-i.code.length})}if(!this.arConfig.bBBCode&&this.arConfig.bConvertContentFromBBCodes){this.arConfig.bBBCode=true}this.bBBCode=this.arConfig.bBBCode;if(this.bBBCode){if(this.InitBBCode&&typeof this.InitBBCode=="function"){this.InitBBCode()}}this.bBBParseImageSize=this.arConfig.bBBParseImageSize;if(this.arConfig.bResizable){if(this.arConfig.bManualResize){this.pResizer=BX("bxlhe_resize_"+this.id);this.pResizer.title=BX.message.ResizerTitle;if(!this.arConfig.minHeight||parseInt(this.arConfig.minHeight)<=0){this.arConfig.minHeight=100}if(!this.arConfig.maxHeight||parseInt(this.arConfig.maxHeight)<=0){this.arConfig.maxHeight=2000}this.pResizer.unselectable="on";this.pResizer.ondragstart=function(h){return BX.PreventDefault(h)};this.pResizer.onmousedown=function(){o.InitResizer();return false}}if(this.arConfig.bAutoResize){BX.bind(this.pTextarea,"keydown",BX.proxy(this.AutoResize,this));BX.addCustomEvent(this,"onShow",BX.proxy(this.AutoResize,this))}}this.AddButtons();this.parseAlign=!this.arConfig.bBBCode||!!(this.buttonsIndex.Justify||this.buttonsIndex.JustifyLeft);this.parseTable=!this.arConfig.bBBCode||!!this.buttonsIndex.Table;if(!this.parseAlign||!this.parseTable){var b=[];for(var d in this.arBBTags){if(!this.parseAlign&&(this.arBBTags[d]=="center"||this.arBBTags[d]=="left"||this.arBBTags[d]=="right"||this.arBBTags[d]=="justify")){continue}if(!this.parseTable&&(this.arBBTags[d]=="table"||this.arBBTags[d]=="tr"||this.arBBTags[d]=="td"||this.arBBTags[d]=="th")){continue}b.push(this.arBBTags[d])}this.arBBTags=b}this.SetContent(this.content);this.SetEditorContent(this.content);this.oTransOverlay=new LHETransOverlay({zIndex:995},this);BX.onCustomEvent(window,"LHE_OnInit",[this,false]);BX.bind(this.pEditorDocument,"click",BX.proxy(this.OnClick,this));BX.bind(this.pEditorDocument,"mousedown",BX.proxy(this.OnMousedown,this));if(this.arConfig.bSaveOnBlur){BX.bind(document,"mousedown",BX.proxy(this.OnDocMousedown,this))}if(this.arConfig.ctrlEnterHandler&&typeof window[this.arConfig.ctrlEnterHandler]=="function"){this.ctrlEnterHandler=window[this.arConfig.ctrlEnterHandler]}if(BX.browser.IsAndroid()&&/Android\s[1-3].[0-9]/i.test(navigator.userAgent)){this.arConfig.bSetDefaultCodeView=true}if(this.arConfig.bSetDefaultCodeView){if(this.sourseBut){this.sourseBut.oBut.handler(this.sourseBut)}else{this.SetView("code")}}BX.ready(function(){if(o.pFrame.offsetWidth==0&&o.pFrame.offsetWidth==0){o.onShowInterval=setInterval(function(){if(o.pFrame.offsetWidth!=0&&o.pFrame.offsetWidth!=0){BX.onCustomEvent(o,"onShow");clearInterval(o.onShowInterval)}},500)}else{BX.onCustomEvent(o,"onShow")}});this.adjustBodyInterval=1000;this._AdjustBodyWidth();BX.removeClass(this.pButtonsCont,"lhe-stat-toolbar-cont-preload")},CreateFrame:function(){if(this.iFrame&&this.iFrame.parentNode){this.pEditCont.removeChild(this.iFrame);this.iFrame=null}this.iFrame=this.pEditCont.appendChild(BX.create("IFRAME",{props:{id:"LHE_iframe_"+this.id,className:"lha-iframe",src:"javascript:void(0)",frameborder:0}}));if(this.iFrame.contentDocument&&!BX.browser.IsIE()){this.pEditorDocument=this.iFrame.contentDocument}else{this.pEditorDocument=this.iFrame.contentWindow.document}this.pEditorWindow=this.iFrame.contentWindow},ReInit:function(a){if(typeof a=="undefined"){a=""}this.SetContent(a);this.CreateFrame();this.SetEditorContent(this.content);this.SetFocus();BX.onCustomEvent(window,"LHE_OnInit",[this,true])},SetConstants:function(){this.reBlockElements=/^(TITLE|TABLE|SCRIPT|TR|TBODY|H1|H2|H3|H4|H5|H6|ADDRESS|PRE|OL|UL|LI)$/i;this.oneGif=this.arConfig.oneGif;this.imagePath=this.arConfig.imagePath;if(!this.arConfig.fontFamily){this.arConfig.fontFamily="Helvetica, Verdana, Arial, sans-serif"}if(!this.arConfig.fontSize){this.arConfig.fontSize="12px"}if(!this.arConfig.lineHeight){this.arConfig.lineHeight="16px"}this.arColors=["#FF0000","#FFFF00","#00FF00","#00FFFF","#0000FF","#FF00FF","#FFFFFF","#EBEBEB","#E1E1E1","#D7D7D7","#CCCCCC","#C2C2C2","#B7B7B7","#ACACAC","#A0A0A0","#959595","#EE1D24","#FFF100","#00A650","#00AEEF","#2F3192","#ED008C","#898989","#7D7D7D","#707070","#626262","#555","#464646","#363636","#262626","#111","#000000","#F7977A","#FBAD82","#FDC68C","#FFF799","#C6DF9C","#A4D49D","#81CA9D","#7BCDC9","#6CCFF7","#7CA6D8","#8293CA","#8881BE","#A286BD","#BC8CBF","#F49BC1","#F5999D","#F16C4D","#F68E54","#FBAF5A","#FFF467","#ACD372","#7DC473","#39B778","#16BCB4","#00BFF3","#438CCB","#5573B7","#5E5CA7","#855FA8","#A763A9","#EF6EA8","#F16D7E","#EE1D24","#F16522","#F7941D","#FFF100","#8FC63D","#37B44A","#00A650","#00A99E","#00AEEF","#0072BC","#0054A5","#2F3192","#652C91","#91278F","#ED008C","#EE105A","#9D0A0F","#A1410D","#A36209","#ABA000","#588528","#197B30","#007236","#00736A","#0076A4","#004A80","#003370","#1D1363","#450E61","#62055F","#9E005C","#9D0039","#790000","#7B3000","#7C4900","#827A00","#3E6617","#045F20","#005824","#005951","#005B7E","#003562","#002056","#0C004B","#30004A","#4B0048","#7A0045","#7A0026"];this.systemCSS="img.bxed-anchor{background-image: url("+this.imagePath+"lhe_iconkit.gif)!important; background-position: -260px 0!important; height: 20px!important; width: 20px!important;}\nbody{font-family:"+this.arConfig.fontFamily+"; font-size: "+this.arConfig.fontSize+"; line-height:"+this.arConfig.lineHeight+"}\np{padding:0!important; margin: 0!important;}\nspan.bxed-noscript{color: #0000a0!important; padding: 2px!important; font-style:italic!important; font-size: 90%!important;}\nspan.bxed-noindex{color: #004000!important; padding: 2px!important; font-style:italic!important; font-size: 90%!important;}\nimg.bxed-flash{border: 1px solid #B6B6B8!important; background: url("+this.imagePath+"flash.gif) #E2DFDA center center no-repeat !important;}\ntable{border: 1px solid #B6B6B8!important; border-collapse: collapse;}\ntable td{border: 1px solid #B6B6B8!important; padding: 2px 5px;}\nimg.bxed-video{border: 1px solid #B6B6B8!important; background-color: #E2DFDA!important; background-image: url("+this.imagePath+"video.gif); background-position: center center!important; background-repeat:no-repeat!important;}\nimg.bxed-hr{padding: 2px!important; width: 100%!important; height: 2px!important;}\n";if(this.arConfig.documentCSS){this.systemCSS+="\n"+this.arConfig.documentCSS}this.tabNbsp="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";this.tabNbspRe1=new RegExp(String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160),"ig");this.tabNbspRe2=new RegExp(String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)+String.fromCharCode(160)+" ","ig")},OnMousedown:function(a){if(!a){a=window.event}this.bFocused=true},OnClick:function(a){this.bFocused=true;this.CheckBr()},OnDblClick:function(a){return},OnContextMenu:function(g,b){return;var i=this,f,a,h;if(!g){g=this.pEditorWindow.event}if(g.pageX||g.pageY){a=g.pageX-this.pEditorDocument.body.scrollLeft;h=g.pageY-this.pEditorDocument.body.scrollTop}else{if(g.clientX||g.clientY){a=g.clientX;h=g.clientY}}f=this.CACHE.frame_pos;if(!f){this.CACHE.frame_pos=f=BX.pos(this.pEditCont)}a+=f.left;h+=f.top;var d;if(g.target){d=g.target}else{if(g.srcElement){d=g.srcElement}}if(d.nodeType==3){d=d.parentNode}if(!d||!d.nodeName){return}var c=this.oContextMenu.Show({oPos:{left:a,top:h},pElement:d});return BX.PreventDefault(g)},OnKeyDown:function(g){if(!g){g=window.event}BX.onCustomEvent(this,"OnDocumentKeyDown",[g]);var d=g.which||g.keyCode;if(g.ctrlKey&&!g.shiftKey&&!g.altKey){switch(d){case 66:case 98:this.executeCommand("Bold");return BX.PreventDefault(g);case 105:case 73:this.executeCommand("Italic");return BX.PreventDefault(g);case 117:case 85:this.executeCommand("Underline");return BX.PreventDefault(g);case 81:if(this.quoteBut){this.quoteBut.oBut.handler(this.quoteBut);return BX.PreventDefault(g)}}}if(this.bHandleOnPaste&&((g.ctrlKey&&!g.shiftKey&&!g.altKey&&g.keyCode==86)||(!g.ctrlKey&&g.shiftKey&&!g.altKey&&g.keyCode==45)||(g.metaKey&&!g.shiftKey&&!g.altKey&&g.keyCode==86))){this.OnPaste()}if(this.bCodeBut&&g.shiftKey&&g.keyCode==46){var f=this.GetSelectionObject();if(f){if(f.className=="lhe-code"){f.parentNode.removeChild(f);return BX.PreventDefault(g)}else{if(f.parentNode){var c=BX.findParent(f,{className:"lhe-code"});if(c){c.parentNode.removeChild(c);return BX.PreventDefault(g)}}}}}if(d==9&&this.arConfig.bReplaceTabToNbsp){this.InsertHTML(this.tabNbsp);return BX.PreventDefault(g)}if(this.bCodeBut&&g.keyCode==13){if(BX.browser.IsIE()||BX.browser.IsSafari()||BX.browser.IsChrome()){var b=this.GetSelectionObject();if(b){var a=false;if(b&&b.nodeName&&b.nodeName.toLowerCase()=="pre"){a=true}if(!a){a=!!BX.findParent(b,{tagName:"pre"})}if(a){if(BX.browser.IsIE()){this.InsertHTML('<br/><img src="'+this.oneGif+'" height="20" width="1"/>')}else{if(BX.browser.IsSafari()||BX.browser.IsChrome()){this.InsertHTML(" \r\n")}}return BX.PreventDefault(g)}}}}if((g.keyCode==13||g.keyCode==10)&&g.ctrlKey&&this.ctrlEnterHandler){this.SaveContent();this.ctrlEnterHandler()}if(this.arConfig.bAutoResize&&this.arConfig.bResizable){if(this._resizeTimeout){clearTimeout(this._resizeTimeout);this._resizeTimeout=null}this._resizeTimeout=setTimeout(BX.proxy(this.AutoResize,this),200)}if(this._CheckBrTimeout){clearTimeout(this._CheckBrTimeout);this._CheckBrTimeout=null}this._CheckBrTimeout=setTimeout(BX.proxy(this.CheckBr,this),1000)},OnDocMousedown:function(a){if(this.bFocused){if(!a){a=window.event}var b;if(a.target){b=a.target}else{if(a.srcElement){b=a.srcElement}}if(b.nodeType==3){b=b.parentNode}if(!this.bPopup&&!BX.findParent(b,{className:"bxlhe-frame"})){this.SaveContent();this.bFocused=false}}},SetView:function(a){if(this.sEditorMode==a){return}this.SaveContent();if(a=="code"){this.iFrame.style.display="none";this.pSourceDiv.style.display="block";this.SetCodeEditorContent(this.GetContent())}else{this.iFrame.style.display="block";this.pSourceDiv.style.display="none";this.SetEditorContent(this.GetContent());this.CheckBr()}this.sEditorMode=a;BX.onCustomEvent(this,"OnChangeView")},SaveContent:function(){var a=this.sEditorMode=="code"?this.GetCodeEditorContent():this.GetEditorContent();if(this.bBBCode){a=this.OptimizeBB(a)}this.SetContent(a);BX.onCustomEvent(this,"OnSaveContent",[a])},SetContent:function(a){this.pHiddenInput.value=this.pTextarea.value=this.content=a},GetContent:function(){return this.content.toString()},SetEditorContent:function(a){if(this.pEditorDocument){a=this.ParseContent(a);if(this.pEditorDocument.designMode){try{this.pEditorDocument.designMode="off"}catch(b){alert("SetEditorContent: designMode='off'")}}this.pEditorDocument.open();this.pEditorDocument.write("<html><head></head><body>"+a+"</body></html>");this.pEditorDocument.close();this.pEditorDocument.body.style.padding="8px";this.pEditorDocument.body.style.margin="0";this.pEditorDocument.body.style.borderWidth="0";this.pEditorDocument.body.style.fontFamily=this.arConfig.fontFamily;this.pEditorDocument.body.style.fontSize=this.arConfig.fontSize;this.pEditorDocument.body.style.lineHeight=this.arConfig.lineHeight;BX.bind(this.pEditorDocument,"keydown",BX.proxy(this.OnKeyDown,this));if(BX.browser.IsIE()){if(this.bHandleOnPaste){BX.bind(this.pEditorDocument.body,"paste",BX.proxy(this.OnPaste,this))}this.pEditorDocument.body.contentEditable=true}else{if(this.pEditorDocument.designMode){this.pEditorDocument.designMode="on";this._TurnOffStyleWithCSS(true)}}if(this.arConfig.bConvertContentFromBBCodes){this.ShutdownBBCode()}}},_TurnOffStyleWithCSS:function(a){try{this._turnOffCssCount++;if(this._turnOffCssCount<5&&a!==false){a=true}this.pEditorDocument.execCommand("styleWithCSS",false,false);try{this.pEditorDocument.execCommand("useCSS",false,true)}catch(b){}}catch(b){if(a===true){setTimeout(BX.proxy(this._TurnOffStyleWithCSS,this),500)}}},_AdjustBodyWidth:function(){if(!BX.browser.IsChrome()){if(this.pEditorDocument&&this.pEditorDocument.body){var a=this.pEditorDocument.body.innerHTML;if(a!=this.lastEditedBodyHtml){this.adjustBodyInterval=500;var b=this;this.pEditorDocument.body.style.width=null;this.lastEditedBodyHtml=a;setTimeout(function(){var c=BX.GetWindowScrollSize(b.pEditorDocument).scrollWidth-16;if(c>0){b.pEditorDocument.body.style.width=c+"px"}},50)}else{this.adjustBodyInterval=5000}}setTimeout(BX.proxy(this._AdjustBodyWidth,this),this.adjustBodyInterval)}},GetEditorContent:function(){var a=this.UnParseContent();return a},SetCodeEditorContent:function(a){this.pHiddenInput.value=this.pTextarea.value=a},GetCodeEditorContent:function(){return this.pTextarea.value},OptimizeHTML:function(g){var h=0,a=true,b=["b","em","font","h\\d","i","li","ol","p","small","span","strong","u","ul"],e=function(){f--;a=true;return" "},j,c,f,d;while(h++<20&&a){a=false;for(f=0,d=b.length;f<d;f++){c=b[f];j=new RegExp("<"+c+"[^>]*?>\\s*?</"+c+">","ig");g=g.replace(j,e);j=new RegExp("<"+c+"\\s+?[^>]*?/>","ig");g=g.replace(j,e);j=new RegExp("<(("+c+"+?)(?:\\s+?[^>]*?)?)>([\\s\\S]+?)<\\/\\2>\\s*?<\\1>([\\s\\S]+?)<\\/\\2>","ig");g=g.replace(j,function(n,m,l,k,i){a=true;return"<"+m+">"+k+" "+i+"</"+l+">"})}}return g},_RecursiveDomWalker:function(m,b){var n={arAttributes:{},arNodes:[],type:null,text:"",arStyle:{}};switch(m.nodeType){case 9:n.type="document";break;case 1:if(m.tagName.length<=0||m.tagName.substring(0,1)=="/"){return}n.text=m.tagName.toLowerCase();if(n.text=="script"){break}n.type="element";var g=m.attributes,d,c=g.length;if(m.nodeName.toLowerCase()=="a"&&m.innerHTML==""&&(this.bBBCode||!m.getAttribute("name"))){return}for(d=0;d<c;d++){if(g[d].specified||(n.text=="input"&&g[d].nodeName.toLowerCase()=="value")){var k=g[d].nodeName.toLowerCase();if(k=="style"){n.arAttributes[k]=m.style.cssText;n.arStyle=m.style;if(n.arStyle.display=="none"){n.type="text";n.text="";break}if(n.arStyle.textAlign&&(n.text=="div"||n.text=="p"||n.text=="span")){var f=n.arStyle.textAlign;BX.util.in_array(n.arStyle.textAlign,["left","right","center","justify"]);n.arStyle={};n.text="span";n.arAttributes.style="text-align:"+f+";display:block;";n.arStyle.textAlign=f;n.arStyle.display="block"}}else{if(k=="src"||k=="href"||k=="width"||k=="height"){n.arAttributes[k]=m.getAttribute(k,2)}else{if(!this.bBBCode&&k=="align"&&BX.util.in_array(g[d].nodeValue,["left","right","center","justify"])){n.text="span";n.arAttributes.style="text-align:"+g[d].nodeValue+";display:block;";n.arStyle.textAlign=g[d].nodeValue;n.arStyle.display="block"}else{n.arAttributes[k]=g[d].nodeValue}}}}}break;case 3:n.type="text";var h=m.nodeValue;if(this.arConfig.bReplaceTabToNbsp){h=h.replace(this.tabNbspRe1,"\t");h=h.replace(this.tabNbspRe2,"\t")}if(!b||(b.text!="pre"&&b.arAttributes["class"]!="lhe-code")){h=h.replace(/\n+/g," ");h=h.replace(/ +/g," ")}n.text=h;break}if(n.type!="text"){var a=m.childNodes,e,c=a.length;for(e=0;e<c;e++){n.arNodes.push(this._RecursiveDomWalker(a[e],n))}}return n},_RecursiveGetHTML:function(m){if(!m||typeof m!="object"||!m.arAttributes){return""}var c,h="",b=m.arAttributes.id;if(m.text=="img"&&!b){b=this.SetBxTag(false,{tag:"img",params:{src:m.arAttributes.src}})}if(b){var d=this.GetBxTag(b);if(d.tag){var a=this.oSpecialParsers[d.tag];if(a&&a.UnParse){return a.UnParse(d,m,this)}else{if(d.params&&d.params.value){return"\n"+d.params.value+"\n"}else{return""}}}}if(m.arAttributes._moz_editor_bogus_node){return""}if(this.bBBCode){var g=this.UnParseNodeBB(m);if(g!==false){return g}}bFormatted=true;if(m.text.toLowerCase()!="body"){h=this.GetNodeHTMLLeft(m)}var l=false;var k="";if(typeof m.bFormatted!="undefined"){bFormatted=!!m.bFormatted}if(bFormatted&&m.type!="text"){if(this.reBlockElements.test(m.text)&&!(m.oParent&&m.oParent.text&&m.oParent.text.toLowerCase()=="pre")){for(var e=0;e<m.iLevel-3;e++){k+="  "}l=true;h="\r\n"+k+h}}for(var f=0;f<m.arNodes.length;f++){h+=this._RecursiveGetHTML(m.arNodes[f])}if(m.text.toLowerCase()!="body"){h+=this.GetNodeHTMLRight(m)}if(l){h+="\r\n"+(k==""?"":k.substr(2))}return h},GetNodeHTMLLeft:function(d){if(d.type=="text"){return BX.util.htmlspecialchars(d.text)}var a,c,b;if(d.type=="element"){b="<"+d.text;for(c in d.arAttributes){a=d.arAttributes[c];if(c.substring(0,4).toLowerCase()=="_moz"){continue}if(d.text.toUpperCase()=="BR"&&c.toLowerCase()=="type"&&a=="_moz"){continue}if(c=="style"){if(a.length>0&&a.indexOf("-moz")!=-1){a=BX.util.trim(a.replace(/-moz.*?;/ig,""))}if(d.text=="td"){a=BX.util.trim(a.replace(/border-image:\s*none;/ig,""))}if(a.length<=0){continue}}b+=" "+c+'="'+(d.bDontUseSpecialchars?a:BX.util.htmlspecialchars(a))+'"'}if(d.arNodes.length<=0&&!this.IsPairNode(d.text)){return b+" />"}return b+">"}return""},GetNodeHTMLRight:function(a){if(a.type=="element"&&(a.arNodes.length>0||this.IsPairNode(a.text))){return"</"+a.text+">"}return""},IsPairNode:function(a){if(a.substr(0,1)=="h"||a=="br"||a=="img"||a=="input"){return false}return true},executeCommand:function(b,c){this.SetFocus();var a=this.pEditorWindow.document.execCommand(b,false,c);this.SetFocus();if(this.arConfig.bAutoResize&&this.arConfig.bResizable){this.AutoResize()}return a},queryCommand:function(a){var b="";if(!this.pEditorDocument.queryCommandEnabled||!this.pEditorDocument.queryCommandValue){return null}if(!this.pEditorDocument.queryCommandEnabled(a)){return null}return this.pEditorDocument.queryCommandValue(a)},SetFocus:function(){if(this.sEditorMode!="html"){return}BX.focus(this.pEditorWindow.focus?this.pEditorWindow:this.pEditorDocument.body);this.bFocused=true},SetFocusToEnd:function(){this.CheckBr();var a=BX.GetWindowScrollSize(this.pEditorDocument);this.pEditorWindow.scrollTo(0,a.scrollHeight);this.SetFocus();this.SelectElement(this.pEditorDocument.body.lastChild)},SetCursorFF:function(){if(this.sEditorMode!="code"&&!BX.browser.IsIE()){var b=this;try{this.iFrame.blur();this.iFrame.focus();setTimeout(function(){b.iFrame.blur();b.iFrame.focus()},600);setTimeout(function(){b.iFrame.blur();b.iFrame.focus()},1000)}catch(a){}}},CheckBr:function(){if(this.CheckBrTimeout){clearTimeout(this.CheckBrTimeout);this.CheckBrTimeout=false}var a=this;this.CheckBrTimeout=setTimeout(function(){var c=a.pEditorDocument.body.lastChild;if(c&&c.nodeType==1){var d=c.nodeName.toUpperCase();var b=/^(TITLE|TABLE|SCRIPT|DIV|H1|H2|H3|H4|H5|H6|ADDRESS|PRE|OL|UL|LI|BLOCKQUOTE|FORM|CENTER|)$/i;if(b.test(d)){a.pEditorDocument.body.appendChild(a.pEditorDocument.createElement("BR"))}}},200)},ParseContent:function(b,a){var e=this;var c=[];b=b.replace(/\[code\]((?:\s|\S)*?)\[\/code\]/ig,function(h,f){var g="";if(!e.bBBCode){g=' id="'+e.SetBxTag(false,{tag:"code"})+'" '}c.push("<pre "+g+'class="lhe-code" title="'+BX.message.CodeDel+'">'+BX.util.htmlspecialchars(f)+"</pre>");return"#BX_CODE"+(c.length-1)+"#"});if(!a){BX.onCustomEvent(this,"OnParseContent")}if(this.arConfig.bBBCode){b=this.ParseBB(b)}b=b.replace(/(<td[^>]*>)\s*(<\/td>)/ig,'$1<br _moz_editor_bogus_node="on">$2');if(this.arConfig.bReplaceTabToNbsp){b=b.replace(/\t/ig,this.tabNbsp)}if(!BX.browser.IsIE()){b=b.replace(/<hr[^>]*>/ig,function(f){return'<img class="bxed-hr" src="'+e.imagePath+'break_page.gif" id="'+e.SetBxTag(false,{tag:"hr",params:{value:f}})+'"/>'})}for(var d in this.oSpecialParsers){if(this.oSpecialParsers[d]&&this.oSpecialParsers[d].Parse){b=this.oSpecialParsers[d].Parse(d,b,this)}}if(!a){setTimeout(function(){e.AppendCSS(e.systemCSS);setTimeout(function(){e.pEditorDocument.body.style.fontFamily="";e.pEditorDocument.body.style.fontSize=""},1)},300)}if(c.length>0){b=b.replace(/#BX_CODE(\d+)#/ig,function(g,f){return c[f]||g})}if(this.bBBCode){b=b.replace(/&amp;#91;/ig,"[");b=b.replace(/&amp;#93;/ig,"]")}b=BX.util.trim(b);if(this.arConfig.bBBCode&&!b.match(/(<br[^>]*>)$/ig)){b+="<br/>"}return b},UnParseContent:function(){BX.onCustomEvent(this,"OnUnParseContent");var c=this._RecursiveGetHTML(this._RecursiveDomWalker(this.pEditorDocument.body,false));if(this.bBBCode){if(!BX.browser.IsIE()){c=c.replace(/\r/ig,"")}c=c.replace(/\n/ig,"")}var e=[["#BR#(#TAG_BEGIN#)","$1"],["(#TAG_BEGIN#)(?:#BR#)*?(#TAG_END#)","$1$2"],["(#TAG_BEGIN#)([\\s\\S]*?)#TAG_END#(?:\\n|\\r|\\s)*?#TAG_BEGIN#([\\s\\S]*?)(#TAG_END#)",function(k,j,i,h,g){return j+i+"#BR#"+h+g},true],["^#TAG_BEGIN#",""],["([\\s\\S]*?(\\[\\/\\w+\\])*?)#TAG_BEGIN#([\\s\\S]*?)#TAG_END#([\\s\\S]*?)",function(k,j,i,h,g){if(i&&i.toLowerCase&&i.toLowerCase()=="[/list]"){return j+h+"#BR#"+g}return j+"#BR#"+h+"#BR#"+g},true],["#TAG_END#","#BR#"]];var d,b,a=e.length,f;if(this.bBBCode){if(BX.browser.IsOpera()){c=c.replace(/(?:#BR#)*?\[\/P\]/ig,"[/P]")}for(b=0;b<a;b++){d=e[b][0];d=d.replace(/#TAG_BEGIN#/g,"\\[P\\]");d=d.replace(/#TAG_END#/g,"\\[\\/P\\]");d=d.replace(/\\\\/ig,"\\\\");d=new RegExp(d,"igm");if(e[b][2]===true){while(true){f=c.replace(d,e[b][1]);if(f==c){break}else{c=f}}}else{c=c.replace(d,e[b][1])}}c=c.replace(/^((?:\s|\S)*?)(?:\n|\r|\s)+$/ig,"$1\n\n");for(b=0;b<a;b++){d=e[b][0];d=d.replace(/#TAG_BEGIN#/g,"\\[DIV\\]");d=d.replace(/#TAG_END#/g,"\\[\\/DIV\\]");d=d.replace(/\\\\/ig,"\\\\");if(e[b][2]===true){while(true){f=c.replace(new RegExp(d,"igm"),e[b][1]);if(f==c){break}else{c=f}}}else{c=c.replace(new RegExp(d,"igm"),e[b][1])}}c=c.replace(/#BR#/ig,"\n");c=c.replace(/\[DIV]/ig,"");c=BX.util.htmlspecialcharsback(c)}this.__sContent=c;BX.onCustomEvent(this,"OnUnParseContentAfter");c=this.__sContent;return c},InitResizer:function(){this.oTransOverlay.Show();var e=this,d=BX.pos(this.pFrame),a=false;var b=function(f){f=f||window.event;BX.fixEventPageY(f);a=f.pageY-d.top;if(a<e.arConfig.minHeight){a=e.arConfig.minHeight;document.body.style.cursor="not-allowed"}else{if(a>e.arConfig.maxHeight){a=e.arConfig.maxHeight;document.body.style.cursor="not-allowed"}else{document.body.style.cursor="n-resize"}}e.pFrame.style.height=a+"px";e.ResizeFrame(a)};var c=function(f){if(e.arConfig.autoResizeSaveSize){BX.userOptions.save("fileman","LHESize_"+e.id,"height",a)}e.arConfig.height=a;document.body.style.cursor="";if(e.oTransOverlay&&e.oTransOverlay.bShowed){e.oTransOverlay.Hide()}BX.unbind(document,"mousemove",b);BX.unbind(document,"mouseup",c)};BX.bind(document,"mousemove",b);BX.bind(document,"mouseup",c)},AutoResize:function(){var d=parseInt(this.arConfig.autoResizeOffset||80),b=parseInt(this.arConfig.autoResizeMaxHeight||0),c=parseInt(this.arConfig.autoResizeMinHeight||50),a,e=this;if(this.autoResizeTimeout){clearTimeout(this.autoResizeTimeout)}this.autoResizeTimeout=setTimeout(function(){if(e.sEditorMode=="html"){a=e.pEditorDocument.body.offsetHeight;var f=e.pEditorDocument.body,j=f.lastChild,h=false,g;while(true){if(!j){break}if(j.offsetTop){h=j.offsetTop+(j.offsetHeight||0);a=h+d;break}else{j=j.previousSibling}}var k=BX.GetWindowSize(e.pEditorDocument);if(k.scrollHeight-k.innerHeight>5){a=Math.max(k.scrollHeight+d,a)}}else{a=(e.pTextarea.value.split("\n").length+5)*17}if(a>parseInt(e.arConfig.height)){if(BX.browser.IsIOS()){b=Infinity}else{if(!b||b<10){b=Math.round(BX.GetWindowInnerSize().innerHeight*0.9)}}a=Math.min(a,b);a=Math.max(a,c);e.SmoothResizeFrame(a)}},300)},MousePos:function(a){if(window.event){a=window.event}if(a.pageX||a.pageY){a.realX=a.pageX;a.realY=a.pageY}else{if(a.clientX||a.clientY){a.realX=a.clientX+(document.documentElement.scrollLeft||document.body.scrollLeft)-document.documentElement.clientLeft;a.realY=a.clientY+(document.documentElement.scrollTop||document.body.scrollTop)-document.documentElement.clientTop}}return a},SmoothResizeFrame:function(a){var g=this,f=parseInt(this.pFrame.offsetHeight),e=0,d=a>f,c=BX.browser.IsIE()?50:50,b=5;if(!d){return}if(this.smoothResizeInterval){clearInterval(this.smoothResizeInterval)}this.smoothResizeInterval=setInterval(function(){if(d){f+=Math.round(b*e);if(f>a){clearInterval(g.smoothResizeInterval);if(f>a){f=a}}}else{f-=Math.round(b*e);if(f<a){f=a;clearInterval(g.smoothResizeInterval)}}g.pFrame.style.height=f+"px";g.ResizeFrame(f);e++},c)},ResizeFrame:function(b){var e=7,f=this.arConfig.bManualResize?3:0,a=b||parseInt(this.pFrame.offsetHeight),d=this.pFrame.offsetWidth;this.pFrameTable.style.height=a+"px";var c=a-this.buttonsHeight-f;if(c>0){this.pEditCont.style.height=c+"px";this.pTextarea.style.height=c+"px"}this.pTextarea.style.width=(d>e)?(d-e)+"px":"auto";this.pButtonsCell.style.height=this.buttonsHeight+"px"},AddButtons:function(){var m,f,k,p,s,c=this.arConfig.toolbarConfig;this.buttonsCount=0;if(!c){c=["Bold","Italic","Underline","Strike","RemoveFormat","InsertHR","Anchor","CreateLink","DeleteLink","Image","Justify","InsertOrderedList","InsertUnorderedList","Outdent","Indent","BackColor","ForeColor","Video","StyleList","HeaderList","FontList","FontSizeList","Table"]}if(oBXLEditorUtils.oTune&&oBXLEditorUtils.oTune[this.id]){var e=oBXLEditorUtils.oTune[this.id].ripButtons,o=oBXLEditorUtils.oTune[this.id].buttons;if(e){m=0;while(m<c.length){if(e[c[m]]){c=BX.util.deleteFromArray(c,m)}else{m++}}}if(o){for(var h=0,d=o.length;h<d;h++){if(o[h].ind==-1||o[h].ind>=c.length){c.push(o[h].but.id)}else{c=BX.util.insertIntoArray(c,o[h].ind,o[h].but.id)}}}}var r=0,a=0,g=r,q,b=parseInt(this.pButtonsCont.offsetWidth);this.ToolbarStartLine(true);for(m in c){k=c[m];if(typeof k!="string"||!c.hasOwnProperty(m)){continue}if(k=="=|="){this.ToolbarNewLine();g=r}else{if(LHEButtons[k]){if(this.bBBCode&&LHEButtons[k].bBBHide){continue}this.buttonsIndex[k]=m;q=this.AddButton(LHEButtons[k],k);if(q){g+=parseInt(q.style.width)||23;if(g+a>b&&b>0){b=parseInt(this.pButtonsCont.offsetWidth);if(g+a>b&&b>0){this.ToolbarNewLine();this.pButtonsCont.appendChild(q);g=r}}}}}}this.ToolbarEndLine();if(typeof this.arConfig.controlButtonsHeight=="undefined"){this.buttonsHeight=this.toolbarLineCount*27}else{this.buttonsHeight=parseInt(this.arConfig.controlButtonsHeight||0)}this.arConfig.minHeight+=this.buttonsHeight;this.arConfig.maxHeight+=this.buttonsHeight;BX.addCustomEvent(this,"onShow",BX.proxy(this.ResizeFrame,this))},AddButton:function(e,g){if(e.parser&&e.parser.obj){this.oSpecialParsers[e.parser.name]=e.parser.obj}this.buttonsCount++;var b;if(!e.type||!e.type=="button"){if(g=="Code"){this.bCodeBut=true}var a=new window.LHEButton(e,this);if(a&&a.oBut){if(g=="Source"){this.sourseBut=a}else{if(g=="Quote"){this.quoteBut=a}}b=this.pButtonsCont.appendChild(a.pCont)}}else{if(e.type=="Colorpicker"){var h=new window.LHEColorPicker(e,this);b=this.pButtonsCont.appendChild(h.pCont)}else{if(e.type=="List"){var f=new window.LHEList(e,this);b=this.pButtonsCont.appendChild(f.pCont)}}}if(e.parsers){for(var d=0,c=e.parsers.length;d<c;d++){if(e.parsers[d]&&e.parsers[d].obj){this.oSpecialParsers[e.parsers[d].name]=e.parsers[d].obj}}}return b},AddParser:function(a){if(a&&a.name&&typeof a.obj=="object"){this.oSpecialParsers[a.name]=a.obj}},ToolbarStartLine:function(a){if(!a&&BX.browser.IsIE()){this.pButtonsCont.appendChild(BX.create("IMG",{props:{src:this.oneGif,className:"lhe-line-ie"}}))}this.pButtonsCont.appendChild(BX.create("DIV",{props:{className:"lhe-line-begin"}}))},ToolbarEndLine:function(){this.pButtonsCont.appendChild(BX.create("DIV",{props:{className:"lhe-line-end"}}))},ToolbarNewLine:function(){this.toolbarLineCount++;this.ToolbarEndLine();this.ToolbarStartLine()},OpenDialog:function(a){var b=new window.LHEDialog(a,this)},GetSelectionObject:function(){var e,g,b;if(this.pEditorDocument.selection){e=this.pEditorDocument.selection;g=e.createRange();if(e.type=="Control"){return g.commonParentElement()}return g.parentElement()}else{e=this.pEditorWindow.getSelection();if(!e){return false}var a,d,c=e.rangeCount,f;for(var d=0;d<c;d++){g=e.getRangeAt(d);a=g.startContainer;if(a.nodeType!=3){if(a.nodeType==1&&a.childNodes.length<=0){f=a}else{f=a.childNodes[g.startOffset]}}else{temp=g.commonAncestorContainer;while(temp&&temp.nodeType==3){temp=temp.parentNode}f=temp}b=(d==0)?f:BXFindParentElement(b,f)}return b}},GetSelectionObjects:function(){var f;if(this.pEditorDocument.selection){f=this.pEditorDocument.selection;var e=f.createRange();if(f.type=="Control"){return e.commonParentElement()}return e.parentElement()}else{f=this.pEditorWindow.getSelection();if(!f){return false}var g;var a,b;var d=[];for(var c=0;c<f.rangeCount;c++){g=f.getRangeAt(c);a=g.startContainer;if(a.nodeType!=3){if(a.nodeType==1&&a.childNodes.length<=0){d[d.length]=a}else{d[d.length]=a.childNodes[g.startOffset]}}else{b=g.commonAncestorContainer;while(b&&b.nodeType==3){b=b.parentNode}d[d.length]=b}}if(d.length>1){return d}return d[0]}},GetSelectionRange:function(g,f){try{var c=g||this.pEditorDocument,b=f||this.pEditorWindow,h,a=this.GetSelection(c,b);if(a){if(c.createRange){if(a.getRangeAt){h=a.getRangeAt(0)}else{h=document.createRange();h.setStart(a.anchorNode,a.anchorOffset);h.setEnd(a.focusNode,a.focusOffset)}}else{h=a.createRange()}}else{h=false}}catch(d){h=false}return h},SelectRange:function(h,g,f){try{if(!h){return}var c=g||this.pEditorDocument,b=f||this.pEditorWindow;this.ClearSelection(c,b);if(c.createRange){var a=b.getSelection();a.removeAllRanges();a.addRange(h)}else{h.select()}}catch(d){}},SelectElement:function(d){try{var g,c=this.pEditorDocument,b=this.pEditorWindow;if(b.getSelection){var a=b.getSelection();a.selectAllChildren(d);g=a.getRangeAt(0);if(g.selectNode){g.selectNode(d)}}else{c.selection.empty();g=c.selection.createRange();g.moveToElementText(d);g.select()}return g}catch(f){}},GetSelectedText:function(a){var b="";if(a.startContainer&&a.endContainer){if(a.startContainer==a.endContainer&&(a.endContainer.nodeType==3||a.endContainer.nodeType==1)){b=a.startContainer.textContent.substring(a.startOffset,a.endOffset)}}else{if(a.text==a.htmlText){b=a.text}}return b||""},ClearSelection:function(d,c){var b=d||this.pEditorDocument,a=c||this.pEditorWindow;if(a.getSelection){a.getSelection().removeAllRanges()}else{b.selection.empty()}},GetSelection:function(c,b){if(!c){c=document}if(!b){b=window}var a=false;if(b.getSelection){a=b.getSelection()}else{if(c.getSelection){a=c.getSelection()}else{if(c.selection){a=c.selection}}}return a},InsertHTML:function(a){try{this.SetFocus();if(BX.browser.IsIE()){var b=this.pEditorDocument.selection.createRange();if(b.pasteHTML){b.pasteHTML(a);b.collapse(false);b.select()}}else{if(BX.browser.IsIE11()){this.PasteHtmlAtCaret(a)}else{this.pEditorWindow.document.execCommand("insertHTML",false,a)}}}catch(c){}if(this.arConfig.bAutoResize&&this.arConfig.bResizable){this.AutoResize()}},PasteHtmlAtCaret:function(g,j){var i=this.pEditorWindow,k=this.pEditorDocument,c,h;if(i.getSelection){c=i.getSelection();if(c.getRangeAt&&c.rangeCount){h=c.getRangeAt(0);h.deleteContents();var d=k.createElement("div");d.innerHTML=g;var l=k.createDocumentFragment(),e,b;while((e=d.firstChild)){b=l.appendChild(e)}var a=l.firstChild;h.insertNode(l);if(b){h=h.cloneRange();h.setStartAfter(b);if(j){h.setStartBefore(a)}else{h.collapse(true)}c.removeAllRanges();c.addRange(h)}}}else{if((c=k.selection)&&c.type!="Control"){var f=c.createRange();f.collapse(true);c.createRange().pasteHTML(g);if(j){h=c.createRange();h.setEndPoint("StartToStart",f);h.select()}}}},AppendCSS:function(c){c=BX.util.trim(c);if(c.length<=0){return false}var f=this.pEditorDocument,a=f.getElementsByTagName("HEAD");if(a.length!=1){return false}if(BX.browser.IsIE()){setTimeout(function(){try{if(f.styleSheets.length==0){a[0].appendChild(f.createElement("STYLE"))}f.styleSheets[0].cssText+=c}catch(g){}},100)}else{try{var b=f.createElement("STYLE");a[0].appendChild(b);b.appendChild(f.createTextNode(c))}catch(d){}}return true},SetBxTag:function(a,b){var c;if(b.id||a&&a.id){c=b.id||a.id}if(!c){c="bxid_"+Math.round(Math.random()*1000000)}else{if(this.bxTags[c]&&!b.tag){b.tag=this.bxTags[c].tag}}b.id=c;if(a){a.id=b.id}this.bxTags[b.id]=b;return b.id},GetBxTag:function(a){if(a){if(typeof a!="string"&&a.id){a=a.id}if(a&&a.length>0&&this.bxTags[a]&&this.bxTags[a].tag){this.bxTags[a].tag=this.bxTags[a].tag.toLowerCase();return this.bxTags[a]}}return{tag:false}},GetAttributesList:function(d){d=d+" ";var b={},a=[],c=false,e=this;d=d.replace(/<\?.*?\?>/ig,function(f){a.push(f);return"#BXPHP"+(a.length-1)+"#"});d=d.replace(/([^\w]??)(\w+?)=([^\s\'"]+?)(\s)/ig,function(j,i,h,g,f){g=g.replace(/#BXPHP(\d+)#/ig,function(l,k){return a[k]||l});b[h.toLowerCase()]=BX.util.htmlspecialcharsback(g);return i});d=d.replace(/([^\w]??)(\w+?)\s*=\s*("|\')([^\3]*?)\3/ig,function(j,i,h,g,f){f=f.replace(/#BXPHP(\d+)#/ig,function(l,k){return a[k]||l});b[h.toLowerCase()]=BX.util.htmlspecialcharsback(f);return i});return b},RidOfNode:function(d,a){if(!d||d.nodeType!=1){return}var c,f=d.tagName.toLowerCase(),b=["span","strike","del","font","code","div"];if(BX.util.in_array(f,b)){if(a!==true){for(c=d.attributes.length-1;c>=0;c--){if(BX.util.trim(d.getAttribute(d.attributes[c].nodeName.toLowerCase()))!=""){return false}}}var e=d.childNodes;while(e.length>0){d.parentNode.insertBefore(e[0],d)}d.parentNode.removeChild(d);return true}return false},WrapSelectionWith:function(d,b){this.SetFocus();var f,g;if(!d){d="SPAN"}var a="FONT",h,l,c,j=[];try{this.pEditorDocument.execCommand("styleWithCSS",false,false)}catch(k){}this.executeCommand("FontName","bitrixtemp");c=this.pEditorDocument.getElementsByTagName(a);for(h=c.length-1;h>=0;h--){if(c[h].getAttribute("face")!="bitrixtemp"){continue}l=BX.create(d,b,this.pEditorDocument);j.push(l);while(c[h].firstChild){l.appendChild(c[h].firstChild)}c[h].parentNode.insertBefore(l,c[h]);c[h].parentNode.removeChild(c[h])}if(this.arConfig.bAutoResize&&this.arConfig.bResizable){this.AutoResize()}return j},SaveSelectionRange:function(){if(this.sEditorMode=="code"){this.oPrevRangeText=this.GetSelectionRange(document,window)}else{this.oPrevRange=this.GetSelectionRange()}},RestoreSelectionRange:function(){if(this.sEditorMode=="code"){this.IESetCarretPos(this.oPrevRangeText)}else{if(this.oPrevRange){this.SelectRange(this.oPrevRange)}}},focus:function(b,a){setTimeout(function(){try{b.focus();if(a){b.select()}}catch(c){}},100)},InitBBCode:function(){this.stack=[];var a=this;this.pTextarea.onkeydown=BX.proxy(this.OnKeyDownBB,this);this._GetNodeHTMLLeft=this.GetNodeHTMLLeft;this._GetNodeHTMLRight=this.GetNodeHTMLRight;this.GetNodeHTMLLeft=this.GetNodeHTMLLeftBB;this.GetNodeHTMLRight=this.GetNodeHTMLRightBB},ShutdownBBCode:function(){this.bBBCode=false;this.arConfig.bBBCode=false;this.pTextarea.onkeydown=null;this.GetNodeHTMLLeft=this._GetNodeHTMLLeft;this.GetNodeHTMLRight=this._GetNodeHTMLRight;this.arConfig.bConvertContentFromBBCodes=false},FormatBB:function(f){var b=f.pBut,e=f.value,a=f.tag.toUpperCase(),d=a;if(a=="FONT"||a=="COLOR"||a=="SIZE"){a+="="+e}if((!BX.util.in_array(a,this.stack)||this.GetTextSelection())&&!(a=="FONT"&&e=="none")){if(!this.WrapWith("["+a+"]","[/"+d+"]")){this.stack.push(a);if(b&&b.Check){b.Check(true)}}}else{var c=false;while(c=this.stack.pop()){this.WrapWith("[/"+c+"]","");if(b&&b.Check){b.Check(false)}if(c==a){break}}}},GetTextSelection:function(){var a=false;if(typeof this.pTextarea.selectionStart!="undefined"){a=this.pTextarea.value.substr(this.pTextarea.selectionStart,this.pTextarea.selectionEnd-this.pTextarea.selectionStart)}else{if(document.selection&&document.selection.createRange){a=document.selection.createRange().text}else{if(window.getSelection){a=window.getSelection();a=a.toString()}}}return a},IESetCarretPos:function(b){if(!b||!BX.browser.IsIE()||b.text.length!=0){return}b.moveStart("character",-this.pTextarea.value.length);var c=b.text.length;var a=this.pTextarea.createTextRange();a.collapse(true);a.moveEnd("character",c);a.moveStart("character",c);a.select()},WrapWith:function(e,i,h){if(!e){e=""}if(!i){i=""}if(!h){h=""}if(e.length<=0&&i.length<=0&&h.length<=0){return true}var c=!!h;var k=this.GetTextSelection();if(!this.bTextareaFocus){this.pTextarea.focus()}var g=(k?"select":c?"after":"in");if(c){h=e+h+i}else{if(k){h=e+k+i}else{h=e+i}}if(typeof this.pTextarea.selectionStart!="undefined"){var f=this.pTextarea.scrollTop,a=this.pTextarea.selectionStart,d=this.pTextarea.selectionEnd;this.pTextarea.value=this.pTextarea.value.substr(0,a)+h+this.pTextarea.value.substr(d);if(g=="select"){this.pTextarea.selectionStart=a;this.pTextarea.selectionEnd=a+h.length}else{if(g=="in"){this.pTextarea.selectionStart=this.pTextarea.selectionEnd=a+e.length}else{this.pTextarea.selectionStart=this.pTextarea.selectionEnd=a+h.length}}this.pTextarea.scrollTop=f}else{if(document.selection&&document.selection.createRange){var b=document.selection.createRange();var j=b.duplicate();h=h.replace(/\r?\n/g,"\n");b.text=h;b.setEndPoint("StartToStart",j);b.setEndPoint("EndToEnd",j);if(g=="select"){b.collapse(true);h=h.replace(/\r\n/g,"1");b.moveEnd("character",h.length)}else{if(g=="in"){b.collapse(false);b.moveEnd("character",e.length);b.collapse(false)}else{b.collapse(false);b.moveEnd("character",h.length);b.collapse(false)}}b.select()}else{this.pTextarea.value+=h}}return true},ParseBB:function(e){e=BX.util.htmlspecialchars(e);e=e.replace(/[\r\n\s\t]?\[table\][\r\n\s\t]*?\[tr\]/ig,"[TABLE][TR]");e=e.replace(/\[tr\][\r\n\s\t]*?\[td\]/ig,"[TR][TD]");e=e.replace(/\[tr\][\r\n\s\t]*?\[th\]/ig,"[TR][TH]");e=e.replace(/\[\/td\][\r\n\s\t]*?\[td\]/ig,"[/TD][TD]");e=e.replace(/\[\/tr\][\r\n\s\t]*?\[tr\]/ig,"[/TR][TR]");e=e.replace(/\[\/td\][\r\n\s\t]*?\[\/tr\]/ig,"[/TD][/TR]");e=e.replace(/\[\/th\][\r\n\s\t]*?\[\/tr\]/ig,"[/TH][/TR]");e=e.replace(/\[\/tr\][\r\n\s\t]*?\[\/table\][\r\n\s\t]?/ig,"[/TR][/TABLE]");e=e.replace(/[\r\n\s\t]*?\[\/list\]/ig,"[/LIST]");e=e.replace(/[\r\n\s\t]*?\[\*\]?/ig,"[*]");var h=["b","u","i",["s","del"],"table","tr","td","th"],d,a,c,b=h.length,f;for(c=0;c<b;c++){if(typeof h[c]=="object"){d=h[c][0];a=h[c][1]}else{d=a=h[c]}e=e.replace(new RegExp("\\[(\\/?)"+d+"\\]","ig"),"<$1"+a+">")}e=e.replace(/\[url\]((?:\s|\S)*?)\[\/url\]/ig,'<a href="$1">$1</a>');e=e.replace(/\[url\s*=\s*((?:[^\[\]]*?(?:\[[^\]]+?\])*[^\[\]]*?)*)\s*\]((?:\s|\S)*?)\[\/url\]/ig,'<a href="$1">$2</a>');var g=this;e=e.replace(/\[img(?:\s*?width=(\d+)\s*?height=(\d+))?\]((?:\s|\S)*?)\[\/img\]/ig,function(m,i,j,l){var k="";i=parseInt(i);j=parseInt(j);if(i&&j&&g.bBBParseImageSize){k=' width="'+i+'" height="'+j+'"'}return'<img  src="'+l+'"'+k+"/>"});c=0;while(e.toLowerCase().indexOf("[color=")!=-1&&e.toLowerCase().indexOf("[/color]")!=-1&&c++<20){e=e.replace(/\[color=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/color\]/ig,'<font color="$1">$2</font>')}c=0;while(e.toLowerCase().indexOf("[list=")!=-1&&e.toLowerCase().indexOf("[/list]")!=-1&&c++<20){e=e.replace(/\[list=1\]((?:\s|\S)*?)\[\/list\]/ig,"<ol>$1</ol>")}c=0;while(e.toLowerCase().indexOf("[list")!=-1&&e.toLowerCase().indexOf("[/list]")!=-1&&c++<20){e=e.replace(/\[list\]((?:\s|\S)*?)\[\/list\]/ig,"<ul>$1</ul>")}e=e.replace(/\[\*\]/ig,"<li>");c=0;while(e.toLowerCase().indexOf("[font=")!=-1&&e.toLowerCase().indexOf("[/font]")!=-1&&c++<20){e=e.replace(/\[font=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/font\]/ig,'<font face="$1">$2</font>')}c=0;while(e.toLowerCase().indexOf("[size=")!=-1&&e.toLowerCase().indexOf("[/size]")!=-1&&c++<20){e=e.replace(/\[size=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/size\]/ig,'<font size="$1">$2</font>')}e=e.replace(/\n/ig,"<br />");return e},UnParseNodeBB:function(a){if(a.text=="br"){return"#BR#"}if(a.type=="text"){return false}if(a.text=="pre"&&a.arAttributes["class"]=="lhe-code"){return"[CODE]"+this.RecGetCodeContent(a)+"[/CODE]"}a.bbHide=true;if(a.text=="font"&&a.arAttributes.color){a.bbHide=false;a.text="color";a.bbValue=a.arAttributes.color}else{if(a.text=="font"&&a.arAttributes.size){a.bbHide=false;a.text="size";a.bbValue=a.arAttributes.size}else{if(a.text=="font"&&a.arAttributes.face){a.bbHide=false;a.text="font";a.bbValue=a.arAttributes.face}else{if(a.text=="del"){a.bbHide=false;a.text="s"}else{if(a.text=="strong"||a.text=="b"){a.bbHide=false;a.text="b"}else{if(a.text=="em"||a.text=="i"){a.bbHide=false;a.text="i"}else{if(a.text=="blockquote"){a.bbHide=false;a.text="quote"}else{if(a.text=="ol"){a.bbHide=false;a.text="list";a.bbBreakLineRight=true;a.bbValue="1"}else{if(a.text=="ul"){a.bbHide=false;a.text="list";a.bbBreakLineRight=true}else{if(a.text=="li"){a.bbHide=false;a.text="*";a.bbBreakLine=true;a.bbHideRight=true}else{if(a.text=="a"){a.bbHide=false;a.text="url";a.bbValue=a.arAttributes.href}else{if(this.parseAlign&&(a.arAttributes.align||a.arStyle.textAlign)&&!(BX.util.in_array(a.text.toLowerCase(),["table","tr","td","th"]))){var b=a.arStyle.textAlign||a.arAttributes.align;if(BX.util.in_array(b,["left","right","center","justify"])){a.bbHide=false;a.text=b}else{a.bbHide=!BX.util.in_array(a.text,this.arBBTags)}}else{if(BX.util.in_array(a.text,this.arBBTags)){a.bbHide=false}}}}}}}}}}}}}return false},RecGetCodeContent:function(c){if(!c||!c.arNodes||!c.arNodes.length){return""}var b="";for(var a=0;a<c.arNodes.length;a++){if(c.arNodes[a].type=="text"){b+=c.arNodes[a].text}else{if(c.arNodes[a].type=="element"&&c.arNodes[a].text=="br"){b+=(this.bBBCode?"#BR#":"\n")}else{if(c.arNodes[a].arNodes){b+=this.RecGetCodeContent(c.arNodes[a])}}}}if(this.bBBCode){if(BX.browser.IsIE()){b=b.replace(/\r/ig,"#BR#")}else{b=b.replace(/\n/ig,"#BR#")}}else{if(BX.browser.IsIE()){b=b.replace(/\n/ig,"\r\n")}}return b},GetNodeHTMLLeftBB:function(b){if(b.type=="text"){var c=BX.util.htmlspecialchars(b.text);c=c.replace(/\[/ig,"&#91;");c=c.replace(/\]/ig,"&#93;");return c}var a="";if(b.bbBreakLine){a+="\n"}if(b.type=="element"&&!b.bbHide){a+="["+b.text.toUpperCase();if(b.bbValue){a+="="+b.bbValue}a+="]"}return a},GetNodeHTMLRightBB:function(b){var a="";if(b.bbBreakLineRight){a+="\n"}if(b.type=="element"&&(b.arNodes.length>0||this.IsPairNode(b.text))&&!b.bbHide&&!b.bbHideRight){a+="[/"+b.text.toUpperCase()+"]"}return a},OptimizeBB:function(g){var h=0,a=true,b=["b","i","u","s","color","font","size","quote"],e=function(){f--;a=true;return" "},j,c,f,d;while(h++<20&&a){a=false;for(f=0,d=b.length;f<d;f++){c=b[f];j=new RegExp("\\["+c+"[^\\]]*?\\]\\s*?\\[/"+c+"\\]","ig");g=g.replace(j,e);if(c!=="quote"){j=new RegExp("\\[(("+c+"+?)(?:\\s+?[^\\]]*?)?)\\]([\\s\\S]+?)\\[\\/\\2\\](\\s*?)\\[\\1\\]([\\s\\S]+?)\\[\\/\\2\\]","ig");g=g.replace(j,function(o,n,l,k,m,i){if(m.indexOf("\n")!=-1){return o}a=true;return"["+n+"]"+k+" "+i+"[/"+l+"]"})}}}g=g.replace(/[\r\n\s\t]*?\[\/list\]/ig,"\n[/LIST]");g=g.replace(/[\r\n\s\t]*?\[\/list\]/ig,"\n[/LIST]");g=g.replace(/\n*$/ig,"");return g},RemoveFormatBB:function(){var e=this.GetTextSelection();if(e){var c=0,d=["b","i","u","s","color","font","size"],b,a=d.length;while(c<30){str1=e;for(b=0;b<a;b++){e=e.replace(new RegExp("\\[("+d[b]+")[^\\]]*?\\]([\\s\\S]*?)\\[/\\1\\]","ig"),"$2")}if(e==str1){break}c++}this.WrapWith("","",e)}},OnKeyDownBB:function(b){if(!b){b=window.event}var a=b.which||b.keyCode;if(b.ctrlKey&&!b.shiftKey&&!b.altKey){switch(a){case 66:case 98:this.FormatBB({tag:"B"});return BX.PreventDefault(b);case 105:case 73:this.FormatBB({tag:"I"});return BX.PreventDefault(b);case 117:case 85:this.FormatBB({tag:"U"});return BX.PreventDefault(b);case 81:this.FormatBB({tag:"QUOTE"});return BX.PreventDefault(b)}}if(a==9){this.WrapWith("","","\t");return BX.PreventDefault(b)}if((b.keyCode==13||b.keyCode==10)&&b.ctrlKey&&this.ctrlEnterHandler){this.SaveContent();this.ctrlEnterHandler()}},GetCutHTML:function(b){if(this.curCutId){var a=this.pEditorDocument.getElementById(this.curCutId);if(a){a.parentNode.insertBefore(BX.create("BR",{},this.pEditorDocument),a);a.parentNode.removeChild(a)}}this.curCutId=this.SetBxTag(false,{tag:"cut"});return'<img src="'+this.oneGif+'" class="bxed-cut" id="'+this.curCutId+'" title="'+BX.message.CutTitle+'"/>'},OnPaste:function(){if(this.bOnPasteProcessing){return}this.bOnPasteProcessing=true;var b=this;var a=this.pEditorDocument.body.scrollTop;setTimeout(function(){b.bOnPasteProcessing=false;b.InsertHTML('<span style="visibility: hidden;" id="'+b.SetBxTag(false,{tag:"cursor"})+'" ></span>');b.SaveContent();setTimeout(function(){var c=b.GetContent();if(/<\w[^>]*(( class="?MsoNormal"?)|(="mso-))/gi.test(c)){c=b.CleanWordText(c)}b.SetEditorContent(c);setTimeout(function(){try{var f=b.pEditorDocument.getElementById(b.lastCursorId);if(f&&f.parentNode){var d=f.offsetTop-30;if(d>0){if(a>0&&a+parseInt(b.pFrame.offsetHeight)>d){b.pEditorDocument.body.scrollTop=a}else{b.pEditorDocument.body.scrollTop=d}}b.SelectElement(f);f.parentNode.removeChild(f);b.SetFocus()}}catch(g){}},100)},100)},100)},CleanWordText:function(f){f=f.replace(/<(P|B|U|I|STRIKE)>&nbsp;<\/\1>/g," ");f=f.replace(/<o:p>([\s\S]*?)<\/o:p>/ig,"$1");f=f.replace(/<span[^>]*display:\s*?none[^>]*>([\s\S]*?)<\/span>/gi,"");f=f.replace(/<!--\[[\s\S]*?\]-->/ig,"");f=f.replace(/<!\[[\s\S]*?\]>/ig,"");f=f.replace(/<\\?\?xml[^>]*>/ig,"");f=f.replace(/<o:p>\s*<\/o:p>/ig,"");f=f.replace(/<\/?[a-z1-9]+:[^>]*>/gi,"");f=f.replace(/<([a-z1-9]+[^>]*) class=([^ |>]*)(.*?>)/gi,"<$1$3");f=f.replace(/<([a-z1-9]+[^>]*) [a-z]+:[a-z]+=([^ |>]*)(.*?>)/gi,"<$1$3");f=f.replace(/&nbsp;/ig," ");f=f.replace(/\s+?/gi," ");f=f.replace(/\s*mso-[^:]+:[^;"]+;?/gi,"");f=f.replace(/\s*margin: 0cm 0cm 0pt\s*;/gi,"");f=f.replace(/\s*margin: 0cm 0cm 0pt\s*"/gi,'"');f=f.replace(/\s*TEXT-INDENT: 0cm\s*;/gi,"");f=f.replace(/\s*TEXT-INDENT: 0cm\s*"/gi,'"');f=f.replace(/\s*TEXT-ALIGN: [^\s;]+;?"/gi,'"');f=f.replace(/\s*PAGE-BREAK-BEFORE: [^\s;]+;?"/gi,'"');f=f.replace(/\s*FONT-VARIANT: [^\s;]+;?"/gi,'"');f=f.replace(/\s*tab-stops:[^;"]*;?/gi,"");f=f.replace(/\s*tab-stops:[^"]*/gi,"");f=f.replace(/<FONT[^>]*>([\s\S]*?)<\/FONT>/gi,"$1");f=f.replace(/\s*face="[^"]*"/gi,"");f=f.replace(/\s*face=[^ >]*/gi,"");f=f.replace(/\s*FONT-FAMILY:[^;"]*;?/gi,"");f=f.replace(/<(\w[^>]*) class=([^ |>]*)([^>]*)/gi,"<$1$3");f=f.replace(/<(\w[^>]*) style="([^\"]*)"([^>]*)/gi,"<$1$3");f=f.replace(/\s*style="\s*"/gi,"");f=f.replace(/<(\w[^>]*) lang=([^ |>]*)([^>]*)/gi,"<$1$3");var b=0;while(f.toLowerCase().indexOf("<span")!=-1&&f.toLowerCase().indexOf("</span>")!=-1&&b++<20){f=f.replace(/<span[^>]*?>([\s\S]*?)<\/span>/gi,"$1")}var d,c,a,e=["b","strong","i","u","font","span","strike"];while(true){d=f;for(c in e){a=e[c];f=f.replace(new RegExp("<"+a+"[^>]*?>(\\s*?)<\\/"+a+">","gi"),"$1");f=f.replace(new RegExp("<\\/"+a+"[^>]*?>(\\s*?)<"+a+">","gi"),"$1")}if(d==f){break}}f=f.replace(/<(?:[^\s>]+)[^>]*>([\s\n\t\r]*)<\/\1>/g,"$1");f=f.replace(/<(?:[^\s>]+)[^>]*>(\s*)<\/\1>/g,"$1");f=f.replace(/<(?:[^\s>]+)[^>]*>(\s*)<\/\1>/g,"$1");f=f.replace(/<xml[^>]*?(?:>\s*?<\/xml)?(?:\/?)?>/ig,"");f=f.replace(/<meta[^>]*?(?:>\s*?<\/meta)?(?:\/?)?>/ig,"");f=f.replace(/<link[^>]*?(?:>\s*?<\/link)?(?:\/?)?>/ig,"");f=f.replace(/<style[\s\S]*?<\/style>/ig,"");f=f.replace(/<table([\s\S]*?)>/gi,"<table>");f=f.replace(/<tr([\s\S]*?)>/gi,"<tr>");f=f.replace(/(<td[\s\S]*?)width=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<td[\s\S]*?)height=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<td[\s\S]*?)style=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<td[\s\S]*?)valign=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<td[\s\S]*?)nowrap=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<td[\s\S]*?)nowrap([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<col[\s\S]*?)width=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");f=f.replace(/(<col[\s\S]*?)style=("|')[\s\S]*?\2([\s\S]*?>)/gi,"$1$3");if(BX.browser.IsOpera()){f=f.replace(/REF\s+?_Ref\d+?[\s\S]*?MERGEFORMAT\s([\s\S]*?)\s[\s\S]*?<\/xml>/gi," $1 ")}return f}};BXLEditorUtils=function(){this.oTune={};this.setCurrentEditorId("default")};BXLEditorUtils.prototype={setCurrentEditorId:function(a){this.curId=a},prepare:function(){if(!this.oTune[this.curId]){this.oTune[this.curId]={buttons:[],ripButtons:{}}}},addButton:function(a,b){if(!a||!a.id){return false}if(typeof b=="undefined"){b=-1}this.prepare();this.oTune[this.curId].buttons.push({but:a,ind:b});return true},removeButton:function(a){this.prepare();this.oTune[this.curId].ripButtons[a]=true}};oBXLEditorUtils=new BXLEditorUtils();function BXFindParentElement(c,a){var b,j=[],h=[];while((c=c.parentNode)!=null){j[j.length]=c}while((a=a.parentNode)!=null){h[h.length]=a}var d,g=0,f=0;if(j.length<h.length){d=j.length;f=h.length-d}else{d=h.length;g=j.length-d}for(var e=0;e<d-1;e++){if(BXElementEqual(j[e+g],h[e+f])){return j[e+g]}}return j[0]}window.BXFindParentByTagName=function(a,b){b=b.toUpperCase();while(a&&(a.nodeType!=1||a.tagName.toUpperCase()!=b)){a=a.parentNode}return a};function SetAttr(c,a,b){if(a=="className"&&!BX.browser.IsIE()){a="class"}if(b.length<=0){c.removeAttribute(a)}else{c.setAttribute(a,b)}}function BXCutNode(a){while(a.childNodes.length>0){a.parentNode.insertBefore(a.childNodes[0],a)}a.parentNode.removeChild(a)};