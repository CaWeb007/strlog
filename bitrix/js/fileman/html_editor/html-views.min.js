(function(){function c(h,g,f){this.editor=h;this.element=g;this.container=f;this.config=h.config||{};this.isShown=null;this.bbCode=h.bbCode;BX.addCustomEvent(this.editor,"OnClickBefore",BX.proxy(this.OnClick,this))}c.prototype={Focus:function(){if(!document.querySelector||this.element.ownerDocument.querySelector(":focus")===this.element){return}try{this.element.focus()}catch(f){}},Hide:function(){this.isShown=false;this.container.style.display="none"},Show:function(){this.isShown=true;this.container.style.display=""},Disable:function(){this.element.setAttribute("disabled","disabled")},Enable:function(){this.element.removeAttribute("disabled")},OnClick:function(f){},IsShown:function(){return !!this.isShown}};function e(g,h,f){a.superclass.constructor.apply(this,arguments);this.name="textarea";this.InitEventHandlers();if(!this.element.value&&this.editor.config.content){this.SetValue(this.editor.config.content,false)}}BX.extend(e,c);e.prototype.Clear=function(){this.element.value=""};e.prototype.GetValue=function(g){var f=this.IsEmpty()?"":this.element.value;if(g){f=this.parent.parse(f)}return f};e.prototype.SetValue=function(f,g,h){if(g){f=this.editor.Parse(f,true,h)}this.editor.dom.pValueInput.value=this.element.value=f};e.prototype.SaveValue=function(){if(this.editor.inited){this.editor.dom.pValueInput.value=this.element.value}};e.prototype.HasPlaceholderSet=function(){var f=this.element.getAttribute("placeholder")||null,g=this.element.value;return !g||(g===f)};e.prototype.IsEmpty=function(){var f=BX.util.trim(this.element.value);return f===""||this.HasPlaceholderSet()};e.prototype.InitEventHandlers=function(){var f=this;BX.bind(this.element,"focus",function(){f.editor.On("OnTextareaFocus");f.isFocused=true});BX.bind(this.element,"blur",function(){f.editor.On("OnTextareaBlur");f.isFocused=false});BX.bind(this.element,"keydown",function(g){f.editor.textareaKeyDownPreventDefault=false;if((g.ctrlKey||g.metaKey)&&!g.altKey&&g.keyCode===f.editor.KEY_CODES.enter){f.editor.On("OnCtrlEnter",[g,f.editor.GetViewMode()]);return BX.PreventDefault(g)}f.editor.On("OnTextareaKeydown",[g]);if(f.editor.textareaKeyDownPreventDefault){return BX.PreventDefault(g)}});BX.bind(this.element,"keyup",function(g){f.editor.On("OnTextareaKeyup",[g])})};e.prototype.IsFocused=function(){return this.isFocused};e.prototype.ScrollToSelectedText=function(f){};e.prototype.SelectText=function(h){var g=this.element.value,f=g.indexOf(h);if(f!=-1){this.element.focus();this.element.setSelectionRange(f,f+h.length)}};e.prototype.GetTextSelection=function(){var f=false;if(this.element.selectionStart!=undefined){f=this.element.value.substr(this.element.selectionStart,this.element.selectionEnd-this.element.selectionStart)}else{if(document.selection&&document.selection.createRange){f=document.selection.createRange().text}else{if(window.getSelection){f=window.getSelection();f=f.toString()}}}return f};e.prototype.WrapWith=function(k,o,n){if(!k){k=""}if(!o){o=""}if(!n){n=""}if(k.length<=0&&o.length<=0&&n.length<=0){return true}var i=!!n,h=this.GetTextSelection(),m=(h?"select":(i?"after":"in"));if(i){n=k+n+o}else{if(h){n=k+h+o}else{n=k+o}}if(this.element.selectionStart!=undefined){var l=this.element.scrollTop,f=this.element.selectionStart,j=this.element.selectionEnd;this.element.value=this.element.value.substr(0,f)+n+this.element.value.substr(j);if(m=="select"){this.element.selectionStart=f;this.element.selectionEnd=f+n.length}else{if(m=="in"){this.element.selectionStart=this.element.selectionEnd=f+k.length}else{this.element.selectionStart=this.element.selectionEnd=f+n.length}}this.element.scrollTop=l}else{if(document.selection&&document.selection.createRange){var g=document.selection.createRange();var p=g.duplicate();n=n.replace(/\r?\n/g,"\n");g.text=n;g.setEndPoint("StartToStart",p);g.setEndPoint("EndToEnd",p);if(m=="select"){g.collapse(true);n=n.replace(/\r\n/g,"1");g.moveEnd("character",n.length)}else{if(m=="in"){g.collapse(false);g.moveEnd("character",k.length);g.collapse(false)}else{g.collapse(false);g.moveEnd("character",n.length);g.collapse(false)}}g.select()}else{this.element.value+=n}}return true};e.prototype.GetCursorPosition=function(){return this.element.selectionStart};function a(h,g,f){a.superclass.constructor.apply(this,arguments);this.name="wysiwyg";this.caretNode="<br>"}BX.extend(a,c);a.prototype.OnCreateIframe=function(){this.document=this.editor.sandbox.GetDocument();this.element=this.document.body;this.editor.document=this.document;this.textarea=this.editor.dom.textarea;this.isFocused=false;this.InitEventHandlers();window.rangy.init();this.Enable()};a.prototype.Clear=function(){this.element.innerHTML=this.caretNode};a.prototype.GetValue=function(f,g){this.iframeValue=this.IsEmpty()?"":this.editor.GetInnerHtml(this.element);this.editor.On("OnIframeBeforeGetValue",[this.iframeValue]);if(f){this.iframeValue=this.editor.Parse(this.iframeValue,false,g)}return this.iframeValue};a.prototype.SetValue=function(f,g){if(g){f=this.editor.Parse(f)}this.element.innerHTML=f;this.CheckContentLastChild(this.element);this.editor.On("OnIframeSetValue",[f])};a.prototype.Show=function(){this.isShown=true;this.container.style.display="";this.ReInit()};a.prototype.ReInit=function(){this.Disable();this.Enable();this.editor.On("OnIframeReInit")};a.prototype.Hide=function(){this.isShown=false;this.container.style.display="none"};a.prototype.Disable=function(){this.element.removeAttribute("contentEditable")};a.prototype.Enable=function(){this.element.setAttribute("contentEditable","true")};a.prototype.Focus=function(g){if(BX.browser.IsIE()&&this.HasPlaceholderSet()){this.Clear()}if(!document.querySelector||this.element.ownerDocument.querySelector(":focus")!==this.element||!this.IsFocused()){if(BX.browser.IsIOS()){var f=this;if(this.focusTimeout){clearTimeout(this.focusTimeout)}this.focusTimeout=setTimeout(function(){var i=document.documentElement.scrollTop||document.body.scrollTop,h=document.documentElement.scrollLeft||document.body.scrollLeft;BX.focus(f.element);window.scrollTo(h,i)},200)}else{BX.focus(this.element)}}if(g&&this.element.lastChild){if(this.element.lastChild.nodeName==="BR"){this.editor.selection.SetBefore(this.element.lastChild)}else{this.editor.selection.SetAfter(this.element.lastChild)}}};a.prototype.SetFocusedFlag=function(f){this.isFocused=f};a.prototype.IsFocused=function(){return this.isFocused};a.prototype.GetTextContent=function(g){var f=this.editor.util.GetTextContent(this.element);return g===true?f.replace(/\uFEFF/ig,""):f};a.prototype.HasPlaceholderSet=function(){return this.textarea&&this.GetTextContent()==this.textarea.getAttribute("placeholder")};a.prototype.IsEmpty=function(h){if(!document.querySelector){return false}var g=this.element.innerHTML,f="blockquote, ul, ol, img, embed, object, table, iframe, svg, video, audio, button, input, select, textarea";return g===""||g===this.caretNode||this.HasPlaceholderSet()||(this.GetTextContent(h)===""&&!this.element.querySelector(f))};a.prototype._initObjectResizing=function(){var h=["width","height"],g=h.length,f=this.element;this.commands.exec("enableObjectResizing",this.config.allowObjectResizing);if(this.config.allowObjectResizing){if(browser.supportsEvent("resizeend")){dom.observe(f,"resizeend",function(l){var n=l.target||l.srcElement,k=n.style,j=0,m;for(;j<g;j++){m=h[j];if(k[m]){n.setAttribute(m,parseInt(k[m],10));k[m]=""}}redraw(f)})}}else{if(browser.supportsEvent("resizestart")){dom.observe(f,"resizestart",function(i){i.preventDefault()})}}};var b=function(h){if(h.setActive){try{h.setActive()}catch(j){}}else{var i=h.style,k=doc.documentElement.scrollTop||doc.body.scrollTop,g=doc.documentElement.scrollLeft||doc.body.scrollLeft,f={position:i.position,top:i.top,left:i.left,WebkitUserSelect:i.WebkitUserSelect};dom.setStyles({position:"absolute",top:"-99999px",left:"-99999px",WebkitUserSelect:"none"}).on(h);h.focus();dom.setStyles(f).on(h);if(win.scrollTo){win.scrollTo(g,k)}}};a.prototype.InitEventHandlers=function(){var l=this,j=this.editor,k=this.GetValue(),h=this.element,g=this.editor.sandbox.GetWindow(),f=!BX.browser.IsOpera()?h:this.editor.sandbox.GetWindow();if(this._eventsInitedObject&&this._eventsInitedObject===f){return}this._eventsInitedObject=f;BX.bind(f,"focus",function(){j.On("OnIframeFocus");l.isFocused=true;if(k!==l.GetValue()){BX.onCustomEvent(j,"OnIframeChange")}});BX.bind(f,"blur",function(){j.On("OnIframeBlur");l.isFocused=false;setTimeout(function(){k=l.GetValue()},0)});BX.bind(f,"contextmenu",function(m){if(m&&!m.ctrlKey&&!m.shiftKey&&(BX.getEventButton(m)&BX.MSRIGHT)){j.On("OnIframeContextMenu",[m,m.target||m.srcElement,l.contMenuRangeCollapsed])}});BX.bind(f,"mousedown",function(p){var m=j.selection.GetRange(),o=p.target||p.srcElement,n=j.GetBxTag(o);l.contMenuRangeCollapsed=m&&m.collapsed;if(j.synchro.IsSyncOn()){j.synchro.StopSync()}if(BX.browser.IsIE10()||BX.browser.IsIE11()){j.phpParser.RedrawSurrogates()}if(o.nodeName=="BODY"||!j.phpParser.CheckParentSurrogate(o)){setTimeout(function(){m=j.selection.GetRange();if(m&&m.collapsed&&m.startContainer&&m.startContainer==m.endContainer){var q=j.phpParser.CheckParentSurrogate(m.startContainer);if(q){j.selection.SetInvisibleTextAfterNode(q);j.selection.SetInvisibleTextBeforeNode(q)}}},10)}j.action.actions.quote.checkSpaceAfterQuotes(o);j.selection.SaveRange(false);setTimeout(function(){j.selection.SaveRange(false)},10);j.On("OnIframeMouseDown",[p,o,n])});BX.bind(f,"touchend",function(){l.Focus()});BX.bind(f,"touchstart",function(){l.Focus()});BX.bind(f,"click",function(n){var m=n.target||n.srcElement;j.On("OnIframeClick",[n,m])});BX.bind(f,"dblclick",function(n){var m=n.target||n.srcElement;j.On("OnIframeDblClick",[n,m])});BX.bind(f,"mouseup",function(n){var m=n.target||n.srcElement;if(!j.synchro.IsSyncOn()){j.synchro.StartSync()}j.On("OnIframeMouseUp",[n,m])});BX.bind(h,"dragover",function(){j.On("OnIframeDragOver",arguments)});BX.bind(h,"dragenter",function(){j.On("OnIframeDragEnter",arguments)});BX.bind(h,"dragleave",function(){j.On("OnIframeDragLeave",arguments)});BX.bind(h,"dragexit",function(){j.On("OnIframeDragExit",arguments)});BX.bind(h,"drop",function(){j.On("OnIframeDrop",arguments)});if(BX.browser.IsFirefox()){BX.bind(h,"dragover",function(m){m.preventDefault()});BX.bind(h,"dragenter",function(m){m.preventDefault()})}BX.bind(h,"drop",BX.delegate(this.OnPasteHandler,this));BX.bind(h,"paste",BX.delegate(this.OnPasteHandler,this));BX.bind(h,"keyup",function(o){var n=o.keyCode,m=j.selection.GetSelectedNode(true);l.SetFocusedFlag(true);if(n===j.KEY_CODES.space||n===j.KEY_CODES.enter){if(n===j.KEY_CODES.enter){l.OnEnterHandlerKeyUp(o,n,m)}j.On("OnIframeNewWord")}else{l.OnKeyUpArrowsHandler(o,n)}j.selection.SaveRange();j.On("OnIframeKeyup",[o,n,m]);if(n===j.KEY_CODES.backspace&&BX.browser.IsChrome()&&m&&m.nodeType=="3"&&m.nextSibling&&m.nextSibling.nodeType=="3"){l.editor.selection.ExecuteAndRestoreSimple(function(){l.editor.util.SetTextContent(m,l.editor.util.GetTextContent(m)+l.editor.util.GetTextContent(m.nextSibling));m.nextSibling.parentNode.removeChild(m.nextSibling)})}if(!j.util.FirstLetterSupported()&&l.editor.parser.firstNodeCheck){l.editor.parser.FirstLetterCheckNodes("","",true)}if(BX.browser.IsChrome()){if(l.stopBugusScrollTimeout){clearTimeout(l.stopBugusScrollTimeout)}l.stopBugusScrollTimeout=setTimeout(function(){l.stopBugusScroll=false},200)}});BX.bind(h,"mousedown",function(o){var n=o.target||o.srcElement;if(!j.util.CheckImageSelectSupport()&&n.nodeName==="IMG"){j.selection.SelectNode(n)}if(!j.util.CheckPreCursorSupport()&&n.nodeName==="PRE"){var m=j.selection.GetSelectedNode(true);if(m&&m!=n){l.FocusPreElement(n,true)}}});BX.bind(h,"keydown",BX.proxy(this.KeyDown,this));if(BX.browser.IsChrome()){BX.bind(window,"scroll",BX.proxy(function(m){if(l.stopBugusScroll){if((!l.savedScroll||!l.savedScroll.scrollTop)&&l.lastSavedScroll){l.savedScroll=l.lastSavedScroll}if(l.savedScroll&&!l.lastSavedScroll){l.lastSavedScroll=l.savedScroll}l._RestoreScrollTop()}},this))}var i={IMG:BX.message.SrcTitle+": ",A:BX.message.UrlTitle+": "};BX.bind(h,"mouseover",function(o){var n=o.target||o.srcElement,m=(n.getAttribute("href")||n.getAttribute("src")),p=n.nodeName;if(i[p]&&!n.hasAttribute("title")&&m&&m.indexOf("data:image/")===-1){n.setAttribute("title",i[p]+m);n.setAttribute("data-bx-clean-attribute","title")}});this.editor.InitClipboardHandler()};a.prototype.KeyDown=function(o){var l=this,r=o.keyCode,f=this.editor.KEY_CODES;this.SetFocusedFlag(true);this.editor.iframeKeyDownPreventDefault=false;if(BX.browser.IsChrome()){this.stopBugusScroll=true;this.savedScroll=BX.GetWindowScrollPos(document)}var h=this.editor.SHORTCUTS[r],m=this.editor.selection.GetSelectedNode(true),j=this.editor.selection.GetRange(),k=this.document.body,p;if((BX.browser.IsIE()||BX.browser.IsIE10()||BX.browser.IsIE11())&&!BX.util.in_array(r,[16,17,18,20,65,144,37,38,39,40])){if(m&&m.nodeName=="BODY"||j.startContainer&&j.startContainer.nodeName=="BODY"||(j.startContainer==k.firstChild&&j.endContainer==k.lastChild&&j.startOffset==0&&j.endOffset==k.lastChild.length)){BX.addCustomEvent(this.editor,"OnIframeKeyup",BX.proxy(this._IEBodyClearHandler,this))}}if((BX.browser.IsIE()||BX.browser.IsIE10()||BX.browser.IsIE11())&&r==f.backspace){BX.addCustomEvent(this.editor,"OnIframeKeyup",BX.proxy(this._IEBodyClearHandlerEx,this))}this.isUserTyping=true;if(this.typingTimeout){this.typingTimeout=clearTimeout(this.typingTimeout)}this.typingTimeout=setTimeout(function(){l.isUserTyping=false},1000);this.editor.synchro.StartSync(200);this.editor.On("OnIframeKeydown",[o,r,h,m]);if(this.editor.iframeKeyDownPreventDefault){return BX.PreventDefault(o)}if((o.ctrlKey||o.metaKey)&&!o.altKey&&h){this.editor.action.Exec(h);return BX.PreventDefault(o)}if(r===f.backspace&&j.startOffset==0&&j.startContainer.nodeType==3&&j.startContainer.parentNode.firstChild==j.startContainer&&j.startContainer.parentNode&&j.startContainer.parentNode.nodeName=="BLOCKQUOTE"&&j.startContainer.parentNode.className){j.startContainer.parentNode.className=""}if(r===f["delete"]&&j.collapsed&&j.endContainer.nodeType==3&&j.endOffset==j.endContainer.length){var i=this.editor.util.GetNextNotEmptySibling(j.endContainer);if(i){if(i.nodeName=="BR"){i=this.editor.util.GetNextNotEmptySibling(i)}if(i&&i.nodeName=="BLOCKQUOTE"&&i.className){i.className=""}}}if(m&&m.nodeName==="IMG"&&(r===f.backspace||r===f["delete"])){p=m.parentNode;p.removeChild(m);if(p.nodeName==="A"&&!p.firstChild){p.parentNode.removeChild(p)}setTimeout(function(){l.editor.util.Refresh(l.element)},0);BX.PreventDefault(o)}if(j.collapsed&&this.OnKeyDownArrowsHandler(o,r,j)===false){return false}if((o.ctrlKey||o.metaKey)&&!o.altKey&&r===f.enter){if(this.IsFocused()){this.editor.On("OnIframeBlur")}this.editor.On("OnCtrlEnter",[o,this.editor.GetViewMode()]);return BX.PreventDefault(o)}if(BX.browser.IsFirefox()&&m&&(r===f["delete"]||r===f.backspace)){var q=m.nodeName=="LI"?m:BX.findParent(m,{tag:"LI"},k);if(q&&q.firstChild&&q.firstChild.nodeName=="I"){var n=BX.findParent(q,{tag:"UL"},k);if(n){var g=this.editor.action.actions.insertUnorderedList.getCustomBullitClass(n);if(g){setTimeout(function(){if(n&&q&&q.innerHTML!==""){l.editor.action.actions.insertUnorderedList.checkCustomBullitList(n,g)}},0)}}}}if(!this.editor.util.FirstLetterSupported()&&l.editor.parser.firstNodeCheck&&r===this.editor.KEY_CODES.backspace){l.editor.parser.FirstLetterBackspaceHandler(j)}if(!o.shiftKey&&(r===f.enter||r===f.backspace)){return this.OnEnterHandler(o,r,m,j)}if(r===f.pageUp||r===f.pageDown){this.savedScroll=BX.GetWindowScrollPos(document);BX.addCustomEvent(this.editor,"OnIframeKeyup",BX.proxy(this._RestoreScrollTop,this));setTimeout(BX.proxy(this._RestoreScrollTop,this),0)}};a.prototype._RestoreScrollTop=function(f){if(this.savedScroll){window.scrollTo(this.savedScroll.scrollLeft,this.savedScroll.scrollTop);this.savedScroll=null}BX.removeCustomEvent(this.editor,"OnIframeKeyup",BX.proxy(this._RestoreScrollTop,this))};a.prototype._IEBodyClearHandler=function(g){var f=this.document.body.firstChild;if(g.keyCode==this.editor.KEY_CODES.enter&&f.nodeName=="P"&&f!=this.document.body.lastChild){if(f.innerHTML&&f.innerHTML.toLowerCase()=="<br>"){var h=f.nextSibling;this.editor.util.ReplaceWithOwnChildren(f);f=h}}if(f&&f.nodeName=="P"&&f==this.document.body.lastChild){this.editor.util.ReplaceWithOwnChildren(f)}BX.removeCustomEvent(this.editor,"OnIframeKeyup",BX.proxy(this._IEBodyClearHandler,this))};a.prototype._IEBodyClearHandlerEx=function(g){var f=this.document.body.firstChild;if(g.keyCode==this.editor.KEY_CODES.backspace&&f&&f.nodeName=="P"&&f==this.document.body.lastChild&&(this.editor.util.IsEmptyNode(f,true,true)||f.innerHTML&&f.innerHTML.toLowerCase()=="<br>")){this.editor.util.ReplaceWithOwnChildren(f)}BX.removeCustomEvent(this.editor,"OnIframeKeyup",BX.proxy(this._IEBodyClearHandlerEx,this))};a.prototype.OnEnterHandler=function(o,t,m,j){if(BX.browser.IsChrome()){this.document.body.style.minHeight=(parseInt(this.document.body.style.minHeight)+1)+"px";this.document.body.style.minHeight=(parseInt(this.document.body.style.minHeight)-1)+"px"}if(!m){return}var l=this;function i(v){if(v){if(v.nodeName!=="P"&&v.nodeName!=="DIV"){v=BX.findParent(v,function(x){return x.nodeName==="P"||x.nodeName==="DIV"},l.document.body)}var w=l.editor.util.GetInvisibleTextNode();if(v){v.parentNode.insertBefore(w,v);l.editor.util.ReplaceWithOwnChildren(v);l.editor.selection.SelectNode(w)}}}var p,u,n,q=["LI","P","H1","H2","H3","H4","H5","H6"],g=["UL","OL","MENU"];if(BX.util.in_array(m.nodeName,q)){n=m}else{n=BX.findParent(m,function(v){return BX.util.in_array(v.nodeName,q)},this.document.body)}if(n){if(n.nodeName==="LI"){if(t===l.editor.KEY_CODES.enter&&n&&n.parentNode){var k=l.editor.action.actions.insertUnorderedList.getCustomBullitClass(n.parentNode)}setTimeout(function(){var x=l.editor.selection.GetSelectedNode(true);if(x){p=BX.findParent(x,function(y){return BX.util.in_array(y.nodeName,g)},l.document.body);if(t===l.editor.KEY_CODES.enter&&n&&n.parentNode){l.editor.action.actions.insertUnorderedList.checkCustomBullitList(n.parentNode,k,true)}if(p&&BX.browser.IsChrome()&&t===l.editor.KEY_CODES.enter){var w,v=p.getElementsByTagName("LI");for(w=0;w<v.length;w++){v[w].innerHTML=v[w].innerHTML.replace(/\uFEFF/ig,"")}}if(!p){i(x)}}},0)}else{if(n.nodeName.match(/H[1-6]/)&&t===this.editor.KEY_CODES.enter){setTimeout(function(){i(l.editor.selection.GetSelectedNode())},0)}}return true}if(t===this.editor.KEY_CODES.enter&&!BX.browser.IsFirefox()&&this.editor.action.IsSupported("insertLineBreak")){if(BX.browser.IsIE10()||BX.browser.IsIE11()){this.editor.action.Exec("insertHTML","<br>"+this.editor.INVISIBLE_SPACE)}else{if(BX.browser.IsChrome()){this.editor.action.Exec("insertLineBreak");if(BX.browser.IsMac()){var f="bx-editor-temp-"+Math.round(Math.random()*1000000);this.editor.action.Exec("insertHTML",'<span id="'+f+'">'+this.editor.INVISIBLE_SPACE+"</span>");var s=this.editor.GetIframeElement(f);if(s){BX.remove(s)}}else{this.editor.action.Exec("insertHTML",this.editor.INVISIBLE_SPACE)}}else{this.editor.action.Exec("insertLineBreak")}}return BX.PreventDefault(o)}if((BX.browser.IsChrome()||BX.browser.IsIE10()||BX.browser.IsIE11())&&t==this.editor.KEY_CODES.backspace&&j.collapsed){var r=BX.create("SPAN",false,this.document);this.editor.selection.InsertNode(r);var h=r.previousSibling;if(h&&h.nodeType==3&&this.editor.util.IsEmptyNode(h,false,false)){BX.remove(h)}this.editor.selection.SetBefore(r);BX.remove(r)}};a.prototype.OnEnterHandlerKeyUp=function(i,h,g){if(g){var j=this;if(!BX.util.in_array(g.nodeName,this.editor.GetBlockTags())){g=BX.findParent(g,function(k){return BX.util.in_array(k.nodeName,j.editor.GetBlockTags())},this.document.body)}if(g&&BX.util.in_array(g.nodeName,this.editor.GetBlockTags())){var f=BX.util.trim(g.innerHTML).toLowerCase();if(this.editor.util.IsEmptyNode(g,true,true)||f==""||f=="<br>"){g.removeAttribute("class")}}}};a.prototype.OnKeyDownArrowsHandler=function(m,l,i){var k,g,f,h,j=this.editor.KEY_CODES;this.keyDownRange=i;if(l===j.right||l===j.down){k=i.endContainer;f=k?k.nextSibling:false;g=k?k.parentNode:false;if(k.nodeType==3&&k.length==i.endOffset&&g&&g.nodeName!=="BODY"&&(!f||(f&&f.nodeName=="BR"&&!f.nextSibling))&&(this.editor.util.IsBlockElement(g)||this.editor.util.IsBlockNode(g))){this.editor.selection.SetInvisibleTextAfterNode(g,true);return BX.PreventDefault(m)}else{if(k.nodeType==3&&this.editor.util.IsEmptyNode(k)&&f&&(this.editor.util.IsBlockElement(f)||this.editor.util.IsBlockNode(f))){BX.remove(k);if(f.firstChild){this.editor.selection.SetBefore(f.firstChild)}else{this.editor.selection.SetAfter(f)}return BX.PreventDefault(m)}else{if(k.nodeType==3&&k.length==i.endOffset&&g&&g.nodeName!=="BODY"&&f&&f.nodeName=="BR"&&!f.nextSibling&&(this.editor.util.IsBlockElement(g)||this.editor.util.IsBlockNode(g))){this.editor.selection.SetInvisibleTextAfterNode(g,true);return BX.PreventDefault(m)}}}}else{if(l===j.left||l===j.up){k=i.startContainer;g=k?k.parentNode:false;h=k?k.previousSibling:false;if(k.nodeType==3&&i.endOffset===0&&g&&g.nodeName!=="BODY"&&!h&&(this.editor.util.IsBlockElement(g)||this.editor.util.IsBlockNode(g))){this.editor.selection.SetInvisibleTextBeforeNode(g);return BX.PreventDefault(m)}else{if(k.nodeType==3&&this.editor.util.IsEmptyNode(k)&&h&&(this.editor.util.IsBlockElement(h)||this.editor.util.IsBlockNode(h))){BX.remove(k);if(h.lastChild){this.editor.selection.SetAfter(h.lastChild)}else{this.editor.selection.SetBefore(h)}return BX.PreventDefault(m)}}}}return true};a.prototype.OnKeyUpArrowsHandler=function(z,l){var x=this,t,o,q,y,w,r=this.editor.selection.GetRange(),v,n,j,u,s,k,p,m,f,i,g,h=this.editor.KEY_CODES;if(l===h.right||l===h.down){this.editor.selection.GetStructuralTags();if(r.collapsed){v=r.endContainer;s=this.editor.util.IsEmptyNode(v);p=this.editor.selection.CheckLastRange(r);j=v.nextSibling;if(!this.editor.util.CheckPreCursorSupport()){if(v.nodeName==="PRE"){t=v}else{if(v.nodeType==3){t=BX.findParent(v,{tag:"PRE"},this.element)}}if(t){if(this.keyDownRange){y=this.keyDownRange.endContainer;w=y==t?t:BX.findParent(y,function(A){return A==t},this.element)}x.FocusPreElement(t,false,w?null:"start")}}if(v.nodeType==3&&s&&j){v=j;s=this.editor.util.IsEmptyNode(v)}k=this.editor.util.CheckSurrogateNode(v);if(k){q=v.nextSibling;if(q&&q.nodeType==3&&this.editor.util.IsEmptyNode(q)){this.editor.selection._MoveCursorAfterNode(q)}else{this.editor.selection._MoveCursorAfterNode(v)}BX.PreventDefault(z)}else{if(v.nodeType==1&&v.nodeName!="BODY"&&!s){if(p){this.editor.selection._MoveCursorAfterNode(v);BX.PreventDefault(z)}}else{if(p&&v.nodeType==3&&!s){n=v.parentNode;if(n&&v===n.lastChild&&n.nodeName!="BODY"){this.editor.selection._MoveCursorAfterNode(n)}}else{if(v.nodeType==3&&v.parentNode){n=v.parentNode;u=n.previousSibling;if((this.editor.util.IsBlockElement(n)||this.editor.util.IsBlockNode(n))&&u&&u.nodeType==3&&this.editor.util.IsEmptyNode(u)){BX.remove(u)}}}}}}else{m=r.startContainer;f=r.endContainer;i=this.editor.util.CheckSurrogateNode(m);g=this.editor.util.CheckSurrogateNode(f);if(i){o=m.previousSibling;if(o&&o.nodeType==3&&this.editor.util.IsEmptyNode(o)){r.setStartBefore(o)}else{r.setStartBefore(m)}this.editor.selection.SetSelection(r)}if(g){q=f.nextSibling;if(q&&q.nodeType==3&&this.editor.util.IsEmptyNode(q)){r.setEndAfter(q)}else{r.setEndAfter(f)}this.editor.selection.SetSelection(r)}}}else{if(l===h.left||l===h.up){this.editor.selection.GetStructuralTags();if(r.collapsed){v=r.startContainer;s=this.editor.util.IsEmptyNode(v);p=this.editor.selection.CheckLastRange(r);if(v.nodeType==3&&s&&v.previousSibling){v=v.previousSibling;s=this.editor.util.IsEmptyNode(v)}if(!this.editor.util.CheckPreCursorSupport()){if(v.nodeName==="PRE"){t=v}else{if(v.nodeType==3){t=BX.findParent(v,{tag:"PRE"},this.element)}}if(t){if(this.keyDownRange){y=this.keyDownRange.startContainer;w=y==t?t:BX.findParent(y,function(A){return A==t},this.element)}x.FocusPreElement(t,false,w?null:"end")}}k=this.editor.util.CheckSurrogateNode(v);if(k){o=v.previousSibling;if(o&&o.nodeType==3&&this.editor.util.IsEmptyNode(o)){this.editor.selection._MoveCursorBeforeNode(o)}else{this.editor.selection._MoveCursorBeforeNode(v)}BX.PreventDefault(z)}else{if(v.nodeType==1&&v.nodeName!="BODY"&&!s){if(p){this.editor.selection._MoveCursorBeforeNode(v);BX.PreventDefault(z)}}else{if(p&&v.nodeType==3&&!s){n=v.parentNode;if(n&&v===n.firstChild&&n.nodeName!="BODY"){this.editor.selection._MoveCursorBeforeNode(n)}}else{if(v.nodeType==3&&v.parentNode){n=v.parentNode;u=n.nextSibling;if((this.editor.util.IsBlockElement(n)||this.editor.util.IsBlockNode(n))&&u&&u.nodeType==3&&this.editor.util.IsEmptyNode(u)){BX.remove(u)}}}}}}else{m=r.startContainer;f=r.endContainer;i=this.editor.util.CheckSurrogateNode(m);g=this.editor.util.CheckSurrogateNode(f);if(i){o=m.previousSibling;if(o&&o.nodeType==3&&this.editor.util.IsEmptyNode(o)){r.setStartBefore(o)}else{r.setStartBefore(m)}this.editor.selection.SetSelection(r)}if(g){q=f.nextSibling;if(q&&q.nodeType==3&&this.editor.util.IsEmptyNode(q)){r.setEndAfter(q)}else{r.setEndAfter(f)}this.SetSelection(r)}}}}this.keyDownRange=null};a.prototype.FocusPreElement=function(i,f,g){var h=this;if(this._focusPreElementTimeout){this._focusPreElementTimeout=clearTimeout(this._focusPreElementTimeout)}if(f){this._focusPreElementTimeout=setTimeout(function(){h.FocusPreElement(i,false,g)},100);return}BX.focus(i);if(g=="end"&&i.lastChild){this.editor.selection.SetAfter(i.lastChild)}else{if(g=="start"&&i.firstChild){this.editor.selection.SetBefore(i.firstChild)}}};a.prototype.OnPasteHandler=function(n){if(!this.editor.skipPasteHandler){this.editor.skipPasteHandler=true;this.editor.pasteNodeIndex={};var f=document.documentElement.scrollTop||document.body.scrollTop,q=document.documentElement.scrollLeft||document.body.scrollLeft,m=this,j=[],h,k,g,p;function l(r){if(r&&r.setAttribute){var i=Math.round(Math.random()*1000000);m.editor.pasteNodeIndex[i]=true;r.setAttribute("data-bx-paste-flag",i)}}h=this.document.body;if(h){p=h.querySelectorAll("*");for(k=0;k<p.length;k++){if(p[k].nodeType==1&&p[k].nodeName!="BODY"&&p[k].nodeName!="HEAD"){j.push(p[k])}}for(k=0;k<h.parentNode.childNodes.length;k++){g=h.parentNode.childNodes[k];if(g.nodeType==1&&g.nodeName!="BODY"&&g.nodeName!="HEAD"){j.push(g)}}}for(k=0;k<j.length;k++){l(j[k])}var o=this.editor.synchro.IsSyncOn();if(o){this.editor.synchro.StopSync()}if(this.editor.iframeView.pasteHandlerTimeout){clearTimeout(this.editor.iframeView.pasteHandlerTimeout)}this.pasteHandlerTimeout=setTimeout(function(){m.editor.SetCursorNode();m.editor.pasteHandleMode=true;m.editor.bbParseContentMode=true;m.editor.synchro.lastIframeValue=false;if(!m.editor.skipPasteControl){m.editor.pasteControl.SaveIframeContent(m.GetValue());m.editor.pasteControl.CheckAndShow()}m.editor.synchro.FromIframeToTextarea(true,true);m.editor.pasteHandleMode=false;m.editor.bbParseContentMode=false;m.editor.synchro.lastTextareaValue=false;m.editor.synchro.FromTextareaToIframe(true);m.editor.RestoreCursor();m.editor.On("OnIframePaste");m.editor.On("OnIframeNewWord");m.editor.skipPasteHandler=false;if(o){m.editor.synchro.StartSync()}if(window.scrollTo){window.scrollTo(q,f)}},10)}};a.prototype.InitAutoLinking=function(){var r=this,i=this.editor,q=i.action.IsSupportedByBrowser("autoUrlDetect"),f=BX.browser.IsIE()||BX.browser.IsIE9()||BX.browser.IsIE10();if(q){i.action.Exec("autoUrlDetect",false)}if(i.config.autoLink===false){return}var s={CODE:1,PRE:1,A:1,SCRIPT:1,HEAD:1,TITLE:1,STYLE:1},w=/(((?:https?|ftp):\/\/|www\.)[^\s'"<]{3,500})/gi,m=/[\.a-z0-9_\-]+@[\.a-z0-9_\-]+\.[\.a-z0-9_\-]+/gi,u=100,n={")":"(","]":"[","}":"{"};this.editor.autolinkUrlRegExp=w;this.editor.autolinkEmailRegExp=m;function l(){try{if(h()){i.selection.ExecuteAndRestore(function(y,z){if(z&&z.parentNode){j(z.parentNode)}})}}catch(x){}}function h(){var z,y,x=false,A=i.GetIframeDoc(),B=A.createTreeWalker(A.body,NodeFilter.SHOW_TEXT,null,false);while(z=B.nextNode()){y=z.nodeValue||"";if((y.match(m)||y.match(w))&&z.parentNode&&z.parentNode.nodeName!="A"){x=true;break}}return x}function j(y){if(y&&!s[y.nodeName]){var x=BX.findParent(y,function(z){return !!s[z.nodeName]},y.ownerDocument.body);if(x){return y}if(y===y.ownerDocument.documentElement){y=y.ownerDocument.body}return t(y)}}function p(x){x=BX.util.htmlspecialchars(x);return x.replace(w,function(A,z){var C=(z.match(/([^\w\u0430-\u0456\u0451\/\-#](,?))$/i)||[])[1]||"",y=n[C];z=z.replace(/([^\w\u0430-\u0456\u0451\/\-#](,?))$/i,"");if(z.split(y).length>z.split(C).length){z=z+C;C=""}var B=z,D=BX.util.htmlspecialchars(z);if(z.length>u){D=D.substr(0,u)+"..."}if(B.substr(0,4)==="www."){B="http://"+B}BX.onCustomEvent(r.editor,"OnAfterUrlConvert",[B]);return'<a href="'+B+'">'+D+"</a>"+C})}function k(x){x=BX.util.htmlspecialchars(x);return x.replace(m,function(z){var B=(z.match(/([^\w\/\-](,?))$/i)||[])[1]||"",y=n[B];z=z.replace(/([^\w\/\-](,?))$/i,"");if(z.split(y).length>z.split(B).length){z=z+B;B=""}var A="mailto:"+z;return'<a href="'+A+'">'+z+"</a>"+B})}function v(y){var x=y._bx_autolink_temp_div;if(!x){x=y._bx_autolink_temp_div=y.createElement("div")}return x}function t(B){var A,x,y;if(B&&!s[B.nodeName]){if(B.nodeType===3&&B.data.match(w)&&B.parentNode){x=B.parentNode;y=v(x.ownerDocument);y.innerHTML="<span></span>"+p(B.data);y.removeChild(y.firstChild);while(y.firstChild){x.insertBefore(y.firstChild,B)}x.removeChild(B)}else{if(B.nodeType===3&&B.data.match(m)&&B.parentNode){x=B.parentNode;y=v(x.ownerDocument);y.innerHTML="<span></span>"+k(B.data);y.removeChild(y.firstChild);while(y.firstChild){x.insertBefore(y.firstChild,B)}x.removeChild(B)}else{if(B.nodeType===1){var C=B.childNodes,z;for(z=0;z<C.length;z++){t(C[z])}A=B}}}}return A}if(!f||(f&&q)){BX.addCustomEvent(i,"OnIframeNewWord",function(){if(i.autolinkTimeout){i.autolinkTimeout=clearTimeout(i.autolinkTimeout)}i.autolinkTimeout=setTimeout(l,500)});BX.addCustomEvent(i,"OnSubmit",function(){try{j(i.GetIframeDoc().body)}catch(x){}})}var g=i.sandbox.GetDocument().getElementsByTagName("a"),o=function(x){var y=BX.util.trim(i.util.GetTextContent(x));if(y.substr(0,4)==="www."){y="http://"+y}return y};BX.addCustomEvent(i,"OnIframeKeydown",function(B,A,C,z){if(g.length>0&&z){var y=BX.findParent(z,{tag:"A"},z.ownerDocument.body);if(y){var x=o(y);setTimeout(function(){var D=o(y);if(D===x){return}if(D.match(w)){y.setAttribute("href",D)}},0)}}})};a.prototype.IsUserTypingNow=function(f){return this.isFocused&&this.isShown&&this.isUserTyping};a.prototype.CheckContentLastChild=function(f){if(!f){f=this.element}var g=f.lastChild;if(g&&(this.editor.util.IsEmptyNode(g,true)&&this.editor.util.IsBlockNode(g.previousSibling)||this.editor.phpParser.IsSurrogate(g))){f.appendChild(BX.create("BR",{},f.ownerDocument));f.appendChild(this.editor.util.GetInvisibleTextNode())}};function d(g,f,h){this.INTERVAL=500;this.editor=g;this.textareaView=f;this.iframeView=h;this.lastFocused="wysiwyg";this.InitEventHandlers()}d.prototype={FromIframeToTextarea:function(g,i){var h;if(this.editor.bbCode){h=this.iframeView.GetValue(this.editor.bbParseContentMode,false);h=BX.util.trim(h);if(h!==this.lastIframeValue){var f=this.editor.bbParser.Unparse(h);this.textareaView.SetValue(f,false,i||this.editor.bbParseContentMode);if(typeof this.lastSavedIframeValue!=="undefined"&&this.lastSavedIframeValue!=h){this.editor.On("OnContentChanged",[f,h])}this.lastSavedIframeValue=h;this.lastIframeValue=h}}else{h=this.iframeView.GetValue();h=BX.util.trim(h);if(h!==this.lastIframeValue){this.textareaView.SetValue(h,true,i);if(typeof this.lastSavedIframeValue!=="undefined"&&this.lastSavedIframeValue!=h){this.editor.On("OnContentChanged",[this.textareaView.GetValue()||"",h||""])}this.lastSavedIframeValue=h;this.lastIframeValue=h}}},FromTextareaToIframe:function(g){var h=this.textareaView.GetValue();if(h!==this.lastTextareaValue){if(h){if(this.editor.bbCode){var f=this.editor.bbParser.Parse(h);f=f.replace(/\u2060/ig,'<span id="bx-cursor-node"> </span>');this.iframeView.SetValue(f,g)}else{h=h.replace(/\u2060/ig,'<span id="bx-cursor-node"> </span>');this.iframeView.SetValue(h,g)}}else{this.iframeView.Clear()}this.lastTextareaValue=h;this.editor.On("OnContentChanged",[h||"",this.iframeView.GetValue()||""])}},FullSyncFromIframe:function(){this.lastIframeValue=false;this.FromIframeToTextarea(true,true);this.lastTextareaValue=false;this.FromTextareaToIframe(true)},Sync:function(){var g=true;var f=this.editor.currentViewName;if(f==="split"){if(this.GetSplitMode()==="code"){this.FromTextareaToIframe(g)}else{this.FromIframeToTextarea(g)}}else{if(f==="code"){this.FromTextareaToIframe(g)}else{this.FromIframeToTextarea(g)}}},GetSplitMode:function(){var f=false;if(this.editor.currentViewName=="split"){if(this.editor.iframeView.IsFocused()){f="wysiwyg"}else{if(this.editor.textareaView.IsFocused()){f="code"}else{f=this.lastFocused}}}return f},InitEventHandlers:function(){var f=this;BX.addCustomEvent(this.editor,"OnTextareaFocus",function(){f.lastFocused="code";f.StartSync()});BX.addCustomEvent(this.editor,"OnIframeFocus",function(){f.lastFocused="wysiwyg";f.StartSync()});BX.addCustomEvent(this.editor,"OnTextareaBlur",BX.delegate(this.StopSync,this));BX.addCustomEvent(this.editor,"OnIframeBlur",BX.delegate(this.StopSync,this))},StartSync:function(f){var h=this;if(this.interval){this.interval=clearTimeout(this.interval)}this.delay=f||this.INTERVAL;function g(){h.delay=h.INTERVAL;h.Sync();h.interval=setTimeout(g,h.delay)}this.interval=setTimeout(g,h.delay)},StopSync:function(){if(this.interval){this.interval=clearTimeout(this.interval)}},IsSyncOn:function(){return !!this.interval},OnIframeMousedown:function(h,g,f){},IsFocusedOnTextarea:function(){var f=this.editor.currentViewName;return f==="code"||f==="split"&&this.GetSplitMode()==="code"}};window.BXEditorTextareaView=e;window.BXEditorIframeView=a;window.BXEditorViewsSynchro=d})();