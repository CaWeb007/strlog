(function(){function a(){function d(f){this.editor=f;this.listLoaded=false;this.snippets=this.editor.config.snippets;this.HandleList();this.Init()}d.prototype={Init:function(){BX.addCustomEvent(this.editor,"OnApplySiteTemplate",BX.proxy(this.OnTemplateChanged,this))},SetSnippets:function(f){this.snippets=this.editor.config.snippets=this.editor.snippetsTaskbar.snippets=f;this.HandleList()},GetList:function(){return this.snippets[this.editor.GetTemplateId()]},HandleList:function(){var g,f=this.GetList().items;if(f){for(g in f){if(f.hasOwnProperty(g)){f[g].key=f[g].path.replace("/",",")}}}},ReloadList:function(f){this.editor.snippetsTaskbar.ClearSearchResult();var g=this;this.editor.Request({getData:this.editor.GetReqData("load_snippets_list",{site_template:this.editor.GetTemplateId(),clear_cache:f?"Y":"N"}),handler:function(h){if(h.result){g.SetSnippets(h.snippets);g.RebuildAll()}}})},FetchPlainListOfCategories:function(j,k,f){var h,g=j.length;for(h=0;h<g;h++){f.push({level:k,key:j[h].key,section:j[h].section});if(j[h].children&&j[h].children.length>0){this.FetchPlainListOfCategories(j[h].children,k+1,f)}}},AddNewCategory:function(f){var g=this;this.editor.Request({getData:this.editor.GetReqData("snippet_add_category",{site_template:this.editor.GetTemplateId(),category_name:f.name,category_parent:f.parent}),handler:function(h){if(h.result){g.SetSnippets(h.snippets);g.RebuildAll()}}})},RemoveCategory:function(f){var g=this;this.editor.Request({getData:this.editor.GetReqData("snippet_remove_category",{site_template:this.editor.GetTemplateId(),category_path:f.path}),handler:function(h){if(h.result){g.SetSnippets(h.snippets);g.RebuildAll()}}})},RenameCategory:function(f){var g=this;this.editor.Request({getData:this.editor.GetReqData("snippet_rename_category",{site_template:this.editor.GetTemplateId(),category_path:f.path,category_new_name:f.newName}),handler:function(h){if(h.result){g.SetSnippets(h.snippets);g.RebuildAll()}}})},SaveSnippet:function(f){var g=this;this.editor.Request({postData:this.editor.GetReqData("edit_snippet",{site_template:this.editor.GetTemplateId(),path:f.path.replace(",","/"),name:f.name,code:f.code,description:f.description,current_path:f.currentPath}),handler:function(h){if(h.result){g.SetSnippets(h.snippets);g.RebuildAll()}}})},RemoveSnippet:function(f){var g=this;this.editor.Request({getData:this.editor.GetReqData("remove_snippet",{site_template:this.editor.GetTemplateId(),path:f.path.replace(",","/")}),handler:function(h){if(h.result){g.SetSnippets(h.snippets);g.RebuildAll()}}})},RebuildAll:function(){var f=this.editor.GetDialog("snippetsCategories");if(f&&f.IsOpen()){f.DisplayAddForm(false);f.BuildTree(this.GetList().groups)}if(this.snippets[this.editor.GetTemplateId()]&&this.editor.snippetsTaskbar){this.editor.snippetsTaskbar.BuildTree(this.snippets[this.editor.GetTemplateId()].groups,this.snippets[this.editor.GetTemplateId()].items)}var g=this.editor.GetDialog("editSnippet");if(g&&g.IsOpen()){g.SetCategories()}},OnTemplateChanged:function(){this.ReloadList(false)}};function c(f){c.superclass.constructor.apply(this,arguments);this.id="snippets";this.snippets=this.editor.config.snippets;this.templateId=this.editor.templateId;this.title=BX.message("BXEdSnippetsTitle");this.searchPlaceholder=BX.message("BXEdSnipSearchPlaceHolder");this.uniqueId="taskbar_"+this.editor.id+"_"+this.id;this.Init()}BX.extend(c,window.BXHtmlEditor.Taskbar);c.prototype.Init=function(){this.BuildSceleton();if(this.snippets[this.templateId]){this.BuildTree(this.snippets[this.templateId].groups,this.snippets[this.templateId].items)}var f=this;f.editor.phpParser.AddBxNode("snippet_icon",{Parse:function(g){return g.code||""}})};c.prototype.GetMenuItems=function(){var f=this;return[{text:BX.message("BXEdAddSnippet"),title:BX.message("BXEdAddSnippet"),className:"",onclick:function(){f.editor.GetDialog("editSnippet").Show();BX.PopupMenu.destroy(f.uniqueId+"_menu")}},{text:BX.message("RefreshTaskbar"),title:BX.message("RefreshTaskbar"),className:"",onclick:function(){f.editor.snippets.ReloadList(true);BX.PopupMenu.destroy(f.uniqueId+"_menu")}},{text:BX.message("BXEdManageCategories"),title:BX.message("BXEdManageCategories"),className:"",onclick:function(){f.editor.GetDialog("snippetsCategories").Show();BX.PopupMenu.destroy(f.uniqueId+"_menu")}}]};c.prototype.HandleElementEx=function(h,f,i){this.editor.SetBxTag(f,{tag:"snippet_icon",params:i});h.title=i.description||i.title;var g=h.appendChild(BX.create("SPAN",{props:{className:"bxhtmled-right-side-item-edit-btn",title:BX.message("BXEdSnipEdit")}}));this.editor.SetBxTag(g,{tag:"_snippet",params:i});BX.bind(g,"mousedown",BX.proxy(this.EditSnippet,this))};c.prototype.EditSnippet=function(h){var g=h.target||h.srcElement;function f(){BX.removeClass(g,"bxhtmled-right-side-item-edit-btn-active");BX.unbind(document,"mouseup",f)}BX.addClass(g,"bxhtmled-right-side-item-edit-btn-active");BX.bind(document,"mouseup",f);this.editor.GetDialog("editSnippet").Show(g);return BX.PreventDefault(h)};c.prototype.BuildTree=function(g,f){c.superclass.BuildTree.apply(this,arguments);if((!g||g.length==0)&&(!f||f.length==0)){this.pTreeCont.appendChild(BX.create("DIV",{props:{className:"bxhtmled-no-snip"},text:BX.message("BXEdSnipNoSnippets")}))}};function e(f,g){g=g||{};g.id="bx_edit_snippet";g.width=600;this.zIndex=3007;this.id="edit_snippet";e.superclass.constructor.apply(this,[f,g]);this.SetContent(this.Build());BX.addClass(this.oDialog.DIV,"bx-edit-snip-dialog");BX.addCustomEvent(this,"OnDialogSave",BX.proxy(this.Save,this))}BX.extend(e,window.BXHtmlEditor.Dialog);e.prototype.Save=function(){this.editor.snippets.SaveSnippet({path:this.pCatSelect.value,name:this.pName.value,code:this.pCode.value,description:this.pDesc.value,currentPath:this.currentPath})};e.prototype.Build=function(){this.pCont=BX.create("DIV",{props:{className:"bxhtmled-edit-snip-cnt"}});function g(s,q,m){var p,o,n;p=s.insertRow(-1);if(m){p.className="bxhtmled-add-row"}o=p.insertCell(-1);o.className="bxhtmled-left-c";if(q&&q.label){o.appendChild(BX.create("LABEL",{props:{className:q.required?"bxhtmled-req":""},text:q.label})).setAttribute("for",q.id)}n=p.insertCell(-1);n.className="bxhtmled-right-c";return{row:p,leftCell:o,rightCell:n}}this.arTabs=[{id:"base",name:BX.message("BXEdSnipBaseSettings")},{id:"additional",name:BX.message("BXEdSnipAddSettings")}];var h=this.BuildTabControl(this.pCont,this.arTabs);this.arTabs=h.tabs;var l=this,i,k,f=BX.create("TABLE",{props:{className:"bxhtmled-dialog-tbl"}}),j=BX.create("TABLE",{props:{className:"bxhtmled-dialog-tbl"}});i=g(f,{label:BX.message("BXEdSnipName")+":",id:this.id+"-name",required:true});this.pName=i.rightCell.appendChild(BX.create("INPUT",{props:{type:"text",id:this.id+"-name",placeholder:BX.message("BXEdSnipNamePlaceHolder")}}));i=g(f,{label:BX.message("BXEdSnipCode")+":",id:this.id+"-code",required:true});this.pCode=i.rightCell.appendChild(BX.create("TEXTAREA",{props:{id:this.id+"-code",placeholder:BX.message("BXEdSnipCodePlaceHolder")},style:{height:"250px"}}));this.arTabs[0].cont.appendChild(f);i=g(j,{label:BX.message("BXEdSnipCategory")+":",id:this.id+"-category"});this.pCatSelect=i.rightCell.appendChild(BX.create("SELECT",{props:{id:this.id+"-category"},style:{maxWidth:"280px"}}));this.pCatManageBut=i.rightCell.appendChild(BX.create("INPUT",{props:{className:"bxhtmled-manage-cat",type:"button",value:"...",title:BX.message("BXEdManageCategories")}}));this.pCatManageBut.onclick=function(){l.editor.GetDialog("snippetsCategories").Show()};i=g(j,{label:BX.message("BXEdSnipDescription")+":",id:this.id+"-hint"});this.pDesc=i.rightCell.appendChild(BX.create("TEXTAREA",{props:{id:this.id+"-hint",placeholder:BX.message("BXEdSnipDescriptionPlaceholder")}}));this.arTabs[1].cont.appendChild(j);i=BX.adjust(j.insertRow(-1),{style:{display:"none"}});k=BX.adjust(i.insertCell(-1),{props:{className:"bxhtmled--centr-c"},attrs:{colsPan:2}});k.appendChild(BX.create("INPUT",{props:{className:"",type:"button",value:BX.message("BXEdSnipRemove")},events:{click:function(){if(confirm(BX.message("BXEdSnipRemoveConfirm"))){l.editor.snippets.RemoveSnippet({path:l.currentPath});l.Close()}}}}));this.delSnipRow=i;return this.pCont};e.prototype.Show=function(i){this.SetTitle(BX.message("BXEdEditSnippetDialogTitle"));this.SetCategories();var h={},g=this.editor.GetBxTag(i),f=!g||!g.tag;if(!f){h=g.params;this.currentPath=(h.path==""?"":h.path.replace(",","/")+"/")+h.name;this.delSnipRow.style.display=""}else{this.currentPath="";this.delSnipRow.style.display="none"}this.pName.value=h.title||"";this.pCode.value=h.code||"";this.pDesc.value=h.description||"";this.pCatSelect.value=h.key||"";e.superclass.Show.apply(this,arguments)};e.prototype.SetCategories=function(){this.pCatSelect.options.length=0;this.pCatSelect.options.add(new Option(BX.message("BXEdSnippetsTitle"),"",true,true));var h,m=" . ",g,k,f=[],l=this.editor.snippetsTaskbar.GetSectionsTreeInfo();this.editor.snippets.FetchPlainListOfCategories(l,1,f);for(k=0;k<f.length;k++){h="";for(g=0;g<f[k].level;g++){h+=m}h+=f[k].section.name;this.pCatSelect.options.add(new Option(h,f[k].key,false,false))}};function b(f,g){g=g||{};g.id="bx_snippets_cats";g.width=400;g.zIndex=3010;this.id="snippet_categories";b.superclass.constructor.apply(this,[f,g]);this.SetContent(this.Build());this.oDialog.ClearButtons();this.oDialog.SetButtons([this.oDialog.btnClose]);BX.addClass(this.oDialog.DIV,"bx-edit-snip-cat-dialog")}BX.extend(b,window.BXHtmlEditor.Dialog);b.prototype.Save=function(){};b.prototype.Build=function(){this.pCont=BX.create("DIV",{props:{className:"bxhtmled-snip-cat-cnt"}});this.pAddCatWrap=this.pCont.appendChild(BX.create("DIV",{props:{className:"bxhtmled-snip-cat-add-wrap"}}));this.pAddCatBut=this.pAddCatWrap.appendChild(BX.create("SPAN",{props:{className:"bxhtmled-snip-cat-add-but"},text:BX.message("BXEdSnipCatAdd")}));BX.bind(this.pAddCatBut,"click",BX.proxy(this.DisplayAddForm,this));var g=this.pAddCatWrap.appendChild(BX.create("TABLE",{props:{className:"bxhtmled-snip-cat-add-tbl"}}));var f,h;f=g.insertRow(-1);h=f.insertCell(-1);h.className="bxhtmled-left-c";h.appendChild(BX.create("LABEL",{props:{className:"bxhtmled-req"},attrs:{"for":this.id+"-cat-name"},text:BX.message("BXEdSnipCatAddName")+":"}));h=f.insertCell(-1);h.className="bxhtmled-right-c";this.pCatName=h.appendChild(BX.create("INPUT",{props:{type:"text",id:this.id+"-cat-name"}}));f=g.insertRow(-1);h=f.insertCell(-1);h.className="bxhtmled-left-c";h.appendChild(BX.create("LABEL",{props:{className:"bxhtmled-req"},attrs:{"for":this.id+"-cat-par"},text:BX.message("BXEdSnipParCategory")+":"}));h=f.insertCell(-1);h.className="bxhtmled-right-c";this.pCatPar=h.appendChild(BX.create("SELECT",{props:{id:this.id+"-cat-par"}}));f=g.insertRow(-1);h=f.insertCell(-1);h.colSpan=2;h.style.textAlign="center";this.pSaveCat=h.appendChild(BX.create("INPUT",{props:{type:"button",className:"adm-btn-save bxhtmled-snip-save-but",value:BX.message("BXEdSnipCatAddBut")}}));BX.bind(this.pSaveCat,"click",BX.proxy(this.AddNewCategory,this));this.pCatListWrap=this.pCont.appendChild(BX.create("DIV",{props:{className:"bxhtmled-snip-cat-list-wrap"}}));return this.pCont};b.prototype.AddNewCategory=function(){this.editor.snippets.AddNewCategory({name:this.pCatName.value,parent:this.pCatPar.value,siteTemplate:""})};b.prototype.DisplayAddForm=function(f){if(this.animation){this.animation.stop()}if(f!==true&&f!==false){f=!this.bAddCatOpened}f=f!==false;if(this.bAddCatOpened!==f){if(f){this.DisableKeyCheck();BX.bind(this.pCatName,"keydown",BX.proxy(this.AddCatKeydown,this));this.SetParentCategories();this.animationStartHeight=25;this.animationEndHeight=160;BX.focus(this.pCatName)}else{this.EnableKeyCheck();BX.unbind(this.pCatName,"keydown",BX.proxy(this.AddCatKeydown,this));this.animationStartHeight=160;this.animationEndHeight=25}var g=this;this.animation=new BX.easing({duration:300,start:{height:this.animationStartHeight},finish:{height:this.animationEndHeight},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(h){g.pAddCatWrap.style.height=h.height+"px"},complete:BX.proxy(function(){this.animation=null},this)});this.animation.animate();this.bAddCatOpened=f}this.ResetAddCategoryForm()};b.prototype.SetParentCategories=function(){this.pCatPar.options.length=0;this.pCatPar.options.add(new Option(BX.message("BXEdSnippetsTitle"),"",true,true));var h,m=" . ",g,k,f=[],l=this.editor.snippetsTaskbar.GetSectionsTreeInfo();this.editor.snippets.FetchPlainListOfCategories(l,1,f);for(k=0;k<f.length;k++){if(f[k].level<2){h="";for(g=0;g<f[k].level;g++){h+=m}h+=f[k].section.name;this.pCatPar.options.add(new Option(h,f[k].key,false,false))}}};b.prototype.Show=function(){this.SetTitle(BX.message("BXEdManageCategoriesTitle"));this.BuildTree(this.editor.snippets.GetList().groups);this.bAddCatOpened=false;this.pAddCatWrap.style.height="";b.superclass.Show.apply(this,arguments)};b.prototype.BuildTree=function(g){BX.cleanNode(this.pCatListWrap);this.catIndex={};for(var f=0;f<g.length;f++){this.BuildCategory(g[f])}};b.prototype.BuildCategory=function(q){var k=this,f=this.GetCategoryContByPath(q.path),s=BX.create("DIV",{props:{className:"bxhtmled-tskbr-sect-outer"}}),l=s.appendChild(BX.create("DIV",{props:{className:"bxhtmled-tskbr-sect"}})),n=l.appendChild(BX.create("SPAN",{props:{className:"bxhtmled-tskbr-sect-icon bxhtmled-tskbr-sect-icon-open"}})),p=l.appendChild(BX.create("SPAN",{props:{className:"bxhtmled-tskbr-sect-title"},text:q.title||q.name})),g=l.appendChild(BX.create("INPUT",{props:{type:"text",className:"bxhtmled-tskbr-name-input"}})),o=s.appendChild(BX.create("DIV",{props:{className:"bxhtmled-tskb-child"},style:{display:"block"}})),m=l.appendChild(BX.create("SPAN",{props:{className:"bxhtmled-right-side-item-edit-btn",title:BX.message("BXEdSnipCatEdit")}})),j=l.appendChild(BX.create("SPAN",{props:{className:"bxhtmled-right-side-item-del-btn",title:BX.message("BXEdSnipCatDelete")}}));BX.bind(j,"mousedown",BX.proxy(this.DisableDD(),this));BX.bind(m,"mousedown",BX.proxy(this.DisableDD(),this));BX.bind(g,"mousedown",BX.proxy(this.DisableDD(),this));BX.bind(j,"click",function(){if(confirm(BX.message("BXEdDropCatConfirm"))){var t=q.path==""?q.name:q.path+"/"+q.name;k.editor.snippets.RemoveCategory({path:t})}});BX.bind(m,"click",function(){k.ShowRename(true,q,g,l)});o.style.display="block";var r=q.path==""?q.name:q.path+","+q.name;var h=q.path==""?0:1;var i={key:r,children:[],section:q};this.catIndex[r]={icon:n,outerCont:s,cont:l,childCont:o,sect:i};if(h>0){BX.addClass(l,"bxhtmled-tskbr-sect-"+h);BX.addClass(n,"bxhtmled-tskbr-sect-icon-"+h)}f.appendChild(s)};b.prototype.ShowRename=function(f,i,g,h){f=f!==false;if(f){BX.addClass(h,"bxhtmled-tskbr-sect-rename");this.currentRenamedCat={section:i,renameInput:g,pGroupTitle:h};g.value=i.name;this.DisableKeyCheck();BX.bind(g,"keydown",BX.proxy(this.RenameKeydown,this));BX.focus(g);g.select()}else{BX.removeClass(h,"bxhtmled-tskbr-sect-rename");BX.unbind(g,"keydown",BX.proxy(this.RenameKeydown,this));this.EnableKeyCheck();this.currentRenamedCat=false}};b.prototype.RenameKeydown=function(i){if(i&&this.currentRenamedCat){if(i.keyCode==this.editor.KEY_CODES.escape){this.ShowRename(false,this.currentRenamedCat.section,this.currentRenamedCat.renameInput,this.currentRenamedCat.pGroupTitle);BX.PreventDefault(i)}else{if(i.keyCode==this.editor.KEY_CODES.enter){var f=BX.util.trim(this.currentRenamedCat.renameInput.value),h=this.currentRenamedCat.section,g=h.path==""?h.name:h.path+"/"+h.name;if(f!==""){this.editor.snippets.RenameCategory({path:g,newName:f})}this.ShowRename(false,this.currentRenamedCat.section,this.currentRenamedCat.renameInput,this.currentRenamedCat.pGroupTitle);BX.PreventDefault(i)}}}};b.prototype.AddCatKeydown=function(f){if(f&&this.bAddCatOpened){if(f.keyCode==this.editor.KEY_CODES.escape){this.DisplayAddForm(false);BX.PreventDefault(f)}else{if(f.keyCode==this.editor.KEY_CODES.enter){this.AddNewCategory();BX.PreventDefault(f)}}}};b.prototype.DisableDD=function(){jsDD.Disable();BX.bind(document,"mouseup",BX.proxy(this.EnableDD,this))};b.prototype.EnableDD=function(){jsDD.Enable();BX.unbind(document,"mouseup",BX.proxy(this.EnableDD,this))};b.prototype.OnDragFinish=function(){};b.prototype.GetCategoryContByPath=function(f){if(f==""||!this.catIndex[f]){return this.pCatListWrap}else{return this.catIndex[f].childCont}};b.prototype.ResetAddCategoryForm=function(f){this.pCatName.value="";this.pCatPar.value=""};window.BXHtmlEditor.SnippetsControl=c;window.BXHtmlEditor.BXEditorSnippets=d;window.BXHtmlEditor.dialogs.editSnippet=e;window.BXHtmlEditor.dialogs.snippetsCategories=b}if(window.BXHtmlEditor&&window.BXHtmlEditor.dialogs){a()}else{BX.addCustomEvent(window,"OnEditorBaseControlsDefined",a)}})();