(function(f){var d;function c(j){this.InitUtil();this.dom={};this.bxTags={};this.EMPTY_IMAGE_SRC="/bitrix/images/1.gif";this.HTML5_TAGS=["abbr","article","aside","audio","bdi","canvas","command","datalist","details","figcaption","figure","footer","header","hgroup","keygen","mark","meter","nav","output","progress","rp","rt","ruby","svg","section","source","summary","time","track","video","wbr"];this.BLOCK_TAGS=["H1","H2","H3","H4","H5","H6","P","BLOCKQUOTE","DIV","SECTION","PRE"];this.NESTED_BLOCK_TAGS=["BLOCKQUOTE","DIV"];this.TABLE_TAGS=["TD","TR","TH","TABLE","TBODY","CAPTION","COL","COLGROUP","TFOOT","THEAD"];this.BBCODE_TAGS=["P","U","TABLE","TR","TD","TH","IMG","A","CENTER","LEFT","RIGHT","JUSTIFY"];this.HTML_ENTITIES=["&iexcl;","&cent;","&pound;","&curren;","&yen;","&brvbar;","&sect;","&uml;","&copy;","&ordf;","&laquo;","&not;","&reg;","&macr;","&deg;","&plusmn;","&sup2;","&sup3;","&acute;","&micro;","&para;","&middot;","&cedil;","&sup1;","&ordm;","&raquo;","&frac14;","&frac12;","&frac34;","&iquest;","&Agrave;","&Aacute;","&Acirc;","&Atilde;","&Auml;","&Aring;","&AElig;","&Ccedil;","&Egrave;","&Eacute;","&Ecirc;","&Euml;","&Igrave;","&Iacute;","&Icirc;","&Iuml;","&ETH;","&Ntilde;","&Ograve;","&Oacute;","&Ocirc;","&Otilde;","&Ouml;","&times;","&Oslash;","&Ugrave;","&Uacute;","&Ucirc;","&Uuml;","&Yacute;","&THORN;","&szlig;","&agrave;","&aacute;","&acirc;","&atilde;","&auml;","&aring;","&aelig;","&ccedil;","&egrave;","&eacute;","&ecirc;","&euml;","&igrave;","&iacute;","&icirc;","&iuml;","&eth;","&ntilde;","&ograve;","&oacute;","&ocirc;","&otilde;","&ouml;","&divide;","&oslash;","&ugrave;","&uacute;","&ucirc;","&uuml;","&yacute;","&thorn;","&yuml;","&OElig;","&oelig;","&Scaron;","&scaron;","&Yuml;","&circ;","&tilde;","&ndash;","&mdash;","&lsquo;","&rsquo;","&sbquo;","&ldquo;","&rdquo;","&bdquo;","&dagger;","&Dagger;","&permil;","&lsaquo;","&rsaquo;","&euro;","&Alpha;","&Beta;","&Gamma;","&Delta;","&Epsilon;","&Zeta;","&Eta;","&Theta;","&Iota;","&Kappa;","&Lambda;","&Mu;","&Nu;","&Xi;","&Omicron;","&Pi;","&Rho;","&Sigma;","&Tau;","&Upsilon;","&Phi;","&Chi;","&Psi;","&Omega;","&alpha;","&beta;","&gamma;","&delta;","&epsilon;","&zeta;","&eta;","&theta;","&iota;","&kappa;","&lambda;","&mu;","&nu;","&xi;","&omicron;","&pi;","&rho;","&sigmaf;","&sigma;","&tau;","&upsilon;","&phi;","&chi;","&psi;","&omega;","&bull;","&hellip;","&prime;","&Prime;","&oline;","&frasl;","&trade;","&larr;","&uarr;","&rarr;","&darr;","&harr;","&part;","&sum;","&minus;","&radic;","&infin;","&int;","&asymp;","&ne;","&equiv;","&le;","&ge;","&loz;","&spades;","&clubs;","&hearts;"];if(!BX.browser.IsIE()){this.HTML_ENTITIES=this.HTML_ENTITIES.concat(["&thetasym;","&upsih;","&piv;","&weierp;","&image;","&real;","&alefsym;","&crarr;","&lArr;","&uArr;","&rArr;","&dArr;","&hArr;","&forall;","&exist;","&empty;","&nabla;","&isin;","&notin;","&ni;","&prod;","&lowast;","&prop;","&ang;","&and;","&or;","&cap;","&cup;","&there4;","&sim;","&cong;","&sub;","&sup;","&nsub;","&sube;","&supe;","&oplus;","&otimes;","&perp;","&sdot;","&lceil;","&rceil;","&lfloor;","&rfloor;","&lang;","&rang;","&diams;"])}this.SHORTCUTS={"66":"bold","73":"italic","85":"underline"};this.KEY_CODES={backspace:8,enter:13,escape:27,space:32,"delete":46,left:37,right:39,up:38,down:40,z:90,y:89,shift:16,ctrl:17,alt:18,cmd:91,cmdRight:93,pageUp:33,pageDown:34};this.INVISIBLE_SPACE="\uFEFF";this.INVISIBLE_CURSOR="\u2060";this.NORMAL_WIDTH=1020;this.MIN_WIDTH=700;this.MIN_HEIGHT=100;this.MAX_HANDLED_FORMAT_LENGTH=50000;this.MAX_HANDLED_FORMAT_TIME=500;this.iframeCssText="";this.InitConfig(this.CheckConfig(j));if(!j.lazyLoad){this.Init()}}c.prototype={Init:function(){if(this.inited){return}this.parser=new BXHtmlEditor.BXEditorParser(this);this.On("OnEditorInitedBefore",[this]);if(!this.BuildSceleton()){return}this.HTMLStyler=b;this.dom.textarea=this.dom.textareaCont.appendChild(BX.create("TEXTAREA",{props:{className:"bxhtmled-textarea"}}));this.dom.pValueInput=BX("bxed_"+this.id);if(!this.dom.pValueInput){this.dom.pValueInput=this.dom.cont.appendChild(BX.create("INPUT",{props:{type:"hidden",id:"bxed_"+this.id,name:this.config.inputName}}))}this.dom.pValueInput.value=this.config.content;this.dom.form=this.dom.textarea.form||false;this.document=null;this.sandbox=this.CreateIframeSandBox();var j=this.sandbox.GetIframe();j.style.width="100%";j.style.height="100%";this.textareaView=new BXEditorTextareaView(this,this.dom.textarea,this.dom.textareaCont);this.iframeView=new BXEditorIframeView(this,this.dom.textarea,this.dom.iframeCont);this.synchro=new BXEditorViewsSynchro(this,this.textareaView,this.iframeView);if(this.bbCode){this.bbParser=new BXHtmlEditor.BXEditorBbCodeParser(this)}this.phpParser=new BXHtmlEditor.BXEditorPhpParser(this);this.components=new BXHtmlEditor.BXEditorComponents(this);this.styles=new a(this);this.overlay=new BXHtmlEditor.Overlay(this);this.BuildToolbar();if(this.showTaskbars){this.taskbarManager=new BXHtmlEditor.TaskbarManager(this,true);if(this.showComponents){this.componentsTaskbar=new BXHtmlEditor.ComponentsControl(this);this.taskbarManager.AddTaskbar(this.componentsTaskbar)}if(this.showSnippets){this.snippets=new BXHtmlEditor.BXEditorSnippets(this);this.snippetsTaskbar=new BXHtmlEditor.SnippetsControl(this,this.taskbarManager);this.taskbarManager.AddTaskbar(this.snippetsTaskbar)}this.taskbarManager.ShowTaskbar(this.showComponents?this.componentsTaskbar.GetId():this.snippetsTaskbar.GetId())}else{this.dom.taskbarCont.style.display="none"}this.contextMenu=new BXHtmlEditor.ContextMenu(this);if(this.config.showNodeNavi){this.nodeNavi=new BXHtmlEditor.NodeNavigator(this);this.nodeNavi.Show()}this.pasteControl=new BXHtmlEditor.PasteControl(this);this.InitEventHandlers();this.ResizeSceleton();if(this.showTaskbars&&this.config.taskbarShown){this.taskbarManager.Show(false)}this.inited=true;this.On("OnEditorInitedAfter",[this]);if(!this.CheckBrowserCompatibility()){this.dom.cont.parentNode.insertBefore(BX.create("DIV",{props:{className:"bxhtmled-warning"},text:BX.message("BXEdInvalidBrowser")}),this.dom.cont)}this.InitImageUploader();this.Show();BX.onCustomEvent(BXHtmlEditor,"OnEditorCreated",[this])},InitConfig:function(m){this.config=m;this.id=this.config.id;this.dialogs={};this.bbCode=!!this.config.bbCode;this.config.splitVertical=!!this.config.splitVertical;this.config.splitRatio=parseFloat(this.config.splitRatio);this.config.view=this.config.view||"wysiwyg";this.config.taskbarShown=!!this.config.taskbarShown;this.config.taskbarWidth=parseInt(this.config.taskbarWidth);this.config.showNodeNavi=this.config.showNodeNavi!==false;this.config.setFocusAfterShow=this.config.setFocusAfterShow!==false;this.cssCounter=0;this.iframeCssText=this.config.iframeCss;this.fileDialogsLoaded=this.bbCode||this.config.useFileDialogs===false;if(this.config.bbCodeTags&&this.bbCode){this.BBCODE_TAGS=this.config.bbCodeTags}if(this.config.minBodyWidth){this.MIN_WIDTH=parseInt(this.config.minBodyWidth)}if(this.config.minBodyHeight){this.MIN_HEIGHT=parseInt(this.config.minBodyHeight)}if(this.config.normalBodyWidth){this.NORMAL_WIDTH=parseInt(this.config.normalBodyWidth)}this.normalWidth=this.NORMAL_WIDTH;if(!this.config.height){this.config.height=this.MIN_HEIGHT}if(!this.config.width){this.config.width=this.MIN_WIDTH}if(this.config.smiles){this.smilesIndex={};this.sortedSmiles=[];var n,k,l,o;for(n=0;n<this.config.smiles.length;n++){k=this.config.smiles[n];if(!k.codes||k.codes==k.code){this.smilesIndex[this.config.smiles[n].code]=k;this.sortedSmiles.push(k)}else{if(k.codes.length>0){o=k.codes.split(" ");for(l=0;l<o.length;l++){this.smilesIndex[o[l]]=k;this.sortedSmiles.push({name:k.name,path:k.path,code:o[l]})}}}}this.sortedSmiles=this.sortedSmiles.sort(function(p,j){return j.code.length-p.code.length})}this.allowPhp=!!this.config.allowPhp;this.lpa=!this.config.allowPhp&&this.config.limitPhpAccess;this.templateId=this.config.templateId;this.componentFilter=this.config.componentFilter;this.showSnippets=this.config.showSnippets!==false;this.showComponents=this.config.showComponents!==false&&(this.allowPhp||this.lpa);this.showTaskbars=this.config.showTaskbars!==false&&(this.showSnippets||this.showComponents);this.templates={};this.templates[this.templateId]=this.config.templateParams},InitEventHandlers:function(){var j=this;BX.bind(this.dom.cont,"click",BX.proxy(this.OnClick,this));BX.bind(this.dom.cont,"mousedown",BX.proxy(this.OnMousedown,this));BX.bind(f,"resize",function(){j.ResizeSceleton()});if(BX.adminMenu){BX.addCustomEvent(BX.adminMenu,"onAdminMenuResize",function(){j.ResizeSceleton()})}BX.addCustomEvent(this,"OnIframeFocus",function(){j.bookmark=null;if(j.statusInterval){clearInterval(j.statusInterval)}j.statusInterval=setInterval(BX.proxy(j.CheckCurrentStatus,j),500)});BX.addCustomEvent(this,"OnIframeBlur",function(){j.bookmark=null;if(j.statusInterval){clearInterval(j.statusInterval)}j.iframeView.stopBugusScroll=false});BX.addCustomEvent(this,"OnTextareaFocus",function(){j.bookmark=null;if(j.statusInterval){clearInterval(j.statusInterval)}});BX.addCustomEvent(this,"OnSurrogateDblClick",function(l,k,n,m){if(k){switch(k.tag){case"php":case"javascript":case"htmlcomment":case"iframe":case"style":j.GetDialog("Source").Show(k);break}}});if(this.dom.form){BX.bind(this.dom.form,"submit",BX.proxy(this.OnSubmit,this));if(this.config.initAutosave!==false){setTimeout(function(){if(j.dom.form.BXAUTOSAVE){j.InitAutosaveHandlers()}},100)}}BX.addCustomEvent(this,"OnSpecialcharInserted",function(l){var k=j.GetLastSpecialchars(),m=BX.util.array_search(l,k);if(m!==-1){k=BX.util.deleteFromArray(k,m);k.unshift(l)}else{k.unshift(l);k.pop()}j.config.lastSpecialchars=k;j.SaveOption("specialchars",k.join("|"))});this.parentDialog=BX.WindowManager.Get();if(this.parentDialog&&this.parentDialog.DIV&&BX.isNodeInDom(this.parentDialog.DIV)&&BX.findParent(this.dom.cont,function(k){return k==j.parentDialog.DIV})){BX.addCustomEvent(this.parentDialog,"onWindowResizeExt",function(){j.ResizeSceleton()})}if(this.config.autoResize){BX.addCustomEvent(this,"OnIframeKeyup",BX.proxy(this.AutoResizeSceleton,this));BX.addCustomEvent(this,"OnInsertHtml",BX.proxy(this.AutoResizeSceleton,this));BX.addCustomEvent(this,"OnIframeSetValue",BX.proxy(this.AutoResizeSceleton,this));BX.addCustomEvent(this,"OnFocus",BX.proxy(this.AutoResizeSceleton,this))}BX.addCustomEvent(this,"OnIframeKeyup",BX.proxy(this.CheckBodyHeight,this))},BuildSceleton:function(){var j=false;this.dom.cont=BX("bx-html-editor-"+this.id);if(this.dom.cont&&BX.isNodeInDom(this.dom.cont)){this.dom.toolbarCont=BX("bx-html-editor-tlbr-cnt-"+this.id);this.dom.toolbar=BX("bx-html-editor-tlbr-"+this.id);this.dom.areaCont=BX("bx-html-editor-area-cnt-"+this.id);this.dom.iframeCont=BX("bx-html-editor-iframe-cnt-"+this.id);this.dom.textareaCont=BX("bx-html-editor-ta-cnt-"+this.id);this.dom.resizerOverlay=BX("bx-html-editor-res-over-"+this.id);this.dom.splitResizer=BX("bx-html-editor-split-resizer-"+this.id);this.dom.splitResizer.style.display="none";this.dom.splitResizer.className=this.config.splitVertical?"bxhtmled-split-resizer-ver":"bxhtmled-split-resizer-hor";BX.bind(this.dom.splitResizer,"mousedown",BX.proxy(this.StartSplitResize,this));this.dom.taskbarCont=BX("bx-html-editor-tskbr-cnt-"+this.id);this.dom.navCont=BX("bx-html-editor-nav-cnt-"+this.id);this.dom.fileDialogsWrap=BX("bx-html-editor-file-dialogs-"+this.id);j=true}return j},ResizeSceleton:function(j,v,m){var o=this;if(this.expanded){var p=BX.GetWindowInnerSize(document);j=this.config.width=p.innerWidth;v=this.config.height=p.innerHeight}if(!j){j=this.config.width}if(!v){v=this.config.height}this.dom.cont.style.minWidth=this.MIN_WIDTH+"px";this.dom.cont.style.minHeight=this.MIN_HEIGHT+"px";var k,s;if(this.resizeTimeout){clearTimeout(this.resizeTimeout);this.resizeTimeout=null}if(j.toString().indexOf("%")!==-1){k=j;j=this.dom.cont.offsetWidth;if(!j){this.resizeTimeout=setTimeout(function(){o.ResizeSceleton(j,v,m)},500);return}}else{if(j<this.MIN_WIDTH){j=this.MIN_WIDTH}k=j+"px"}this.dom.cont.style.width=k;this.dom.toolbarCont.style.width=k;if(v.toString().indexOf("%")!==-1){s=v;v=this.dom.cont.offsetHeight}else{if(v<this.MIN_HEIGHT){v=this.MIN_HEIGHT}s=v+"px"}this.dom.cont.style.height=s;var t=Math.max(j,this.MIN_WIDTH),n=Math.max(v,this.MIN_HEIGHT),r=this.toolbar.GetHeight(),q=this.showTaskbars?(this.taskbarManager.GetWidth(true,t*0.8)):0,u=n-r-(this.config.showNodeNavi&&this.nodeNavi?this.nodeNavi.GetHeight():0),l=t-q;this.dom.areaCont.style.top=r?r+"px":0;this.SetAreaContSize(l,u,m);this.dom.taskbarCont.style.height=u+"px";this.dom.taskbarCont.style.width=q+"px";if(this.showTaskbars){this.taskbarManager.Resize(q,u)}this.toolbar.AdaptControls(j);this.On("OnEditorResizedAfter",[{width:j,height:v}])},CheckBodyHeight:function(){if(this.iframeView.IsShown()){var l=8,j,k=this.GetIframeDoc();if(k&&k.body){j=k.body.parentNode.offsetHeight-l*2;if(j<=20){setTimeout(BX.proxy(this.CheckBodyHeight,this),300)}else{if(this.config.autoResize||j>k.body.offsetHeight){k.body.style.minHeight=j+"px"}}}}},GetSceletonSize:function(){return{width:this.dom.cont.offsetWidth,height:this.dom.cont.offsetHeight}},AutoResizeSceleton:function(){if(this.expanded||!this.IsShown()||this.iframeView.IsEmpty()){return}var l=parseInt(this.config.autoResizeMaxHeight||0),m=parseInt(this.config.autoResizeMinHeight||50),k=this.dom.areaCont.offsetHeight,j,n=this;if(this.autoResizeTimeout){clearTimeout(this.autoResizeTimeout)}this.autoResizeTimeout=setTimeout(function(){j=n.GetHeightByContent();if(j>k){if(BX.browser.IsIOS()){l=Infinity}else{if(!l||l<10){l=Math.round(BX.GetWindowInnerSize().innerHeight*0.9)}}j=Math.min(j,l);j=Math.max(j,m);n.SmoothResizeSceleton(j)}},300)},GetHeightByContent:function(){var n=parseInt(this.config.autoResizeOffset||80),m;if(this.GetViewMode()=="wysiwyg"){var j=this.GetIframeDoc().body,l=j.lastChild,k=false;m=j.offsetHeight;while(true){if(!l){break}if(l.offsetTop){k=l.offsetTop+(l.offsetHeight||0);m=k+n;break}else{l=l.previousSibling}}var o=BX.GetWindowSize(this.GetIframeDoc());if(o.scrollHeight-o.innerHeight>5){m=Math.max(o.scrollHeight+n,m)}}else{m=(this.textareaView.element.value.split("\n").length+5)*17}return m},SmoothResizeSceleton:function(j){this.On("AutoResizeStarted");var q=this,m=this.GetSceletonSize(),p=m.height,o=0,n=j>p,l=50,k=5;if(!n){return}if(this.smoothResizeInt){clearInterval(this.smoothResizeInt)}this.smoothResizeInt=setInterval(function(){p+=Math.round(k*o);var r=p>=j;if(p>j){clearInterval(q.smoothResizeInt);if(p>j){p=j}}q.config.height=p;q.ResizeSceleton();if(r){q.On("AutoResizeFinished")}o++},l)},SetAreaContSize:function(j,r,k){j+=2;this.dom.areaCont.style.width=j+"px";this.dom.areaCont.style.height=r+"px";if(k&&k.areaContTop){this.dom.areaCont.style.top=k.areaContTop+"px"}var m=3;if(this.currentViewName=="split"){function l(u,t,s){if(u<t){u=t}if(u>s){u=s}return u}var n=10,q,p,o;if(this.config.splitVertical==true){q=k&&k.deltaX?k.deltaX:0;p=l((j*this.config.splitRatio/(1+this.config.splitRatio))-q,n,j-n);o=j-p;this.dom.iframeCont.style.width=(p-m)+"px";this.dom.iframeCont.style.height=r+"px";this.dom.iframeCont.style.top=0;this.dom.iframeCont.style.left=0;this.dom.textareaCont.style.width=(o-m)+"px";this.dom.textareaCont.style.height=r+"px";this.dom.textareaCont.style.top=0;this.dom.textareaCont.style.left=p+"px";this.dom.splitResizer.className="bxhtmled-split-resizer-ver";this.dom.splitResizer.style.top=0;this.dom.splitResizer.style.left=(p-3)+"px";this.dom.textareaCont.style.height=r+"px"}else{q=k&&k.deltaY?k.deltaY:0;p=l((r*this.config.splitRatio/(1+this.config.splitRatio))-q,n,r-n);o=r-p;this.dom.iframeCont.style.width=(j-m)+"px";this.dom.iframeCont.style.height=p+"px";this.dom.iframeCont.style.top=0;this.dom.iframeCont.style.left=0;this.dom.textareaCont.style.width=(j-m)+"px";this.dom.textareaCont.style.height=o+"px";this.dom.textareaCont.style.top=p+"px";this.dom.textareaCont.style.left=0;this.dom.splitResizer.className="bxhtmled-split-resizer-hor";this.dom.splitResizer.style.top=(p-3)+"px";this.dom.splitResizer.style.left=0}if(k&&k.updateSplitRatio){this.config.splitRatio=p/o;this.SaveOption("split_ratio",this.config.splitRatio)}}else{this.dom.iframeCont.style.width=(j-m)+"px";this.dom.iframeCont.style.height=r+"px";this.dom.iframeCont.style.top=0;this.dom.iframeCont.style.left=0;this.dom.textareaCont.style.width=(j-m)+"px";this.dom.textareaCont.style.height=r+"px";this.dom.textareaCont.style.top=0;this.dom.textareaCont.style.left=0}},BuildToolbar:function(){this.toolbar=new BXHtmlEditor.Toolbar(this,this.GetTopControls())},GetTopControls:function(){this.On("GetTopButtons",[f.BXHtmlEditor.Controls]);return f.BXHtmlEditor.Controls},CreateIframeSandBox:function(){return new e(BX.proxy(this.OnCreateIframe,this),{editor:this,cont:this.dom.iframeCont})},OnCreateIframe:function(){if(!document.body.contains(this.dom.iframeCont)){return}this.On("OnCreateIframeBefore");this.iframeView.OnCreateIframe();this.selection=new i(this);this.action=new BXEditorActions(this);this.config.content=this.dom.pValueInput.value;this.SetContent(this.config.content,true);this.undoManager=new h(this);this.action.Exec("styleWithCSS",false,true);this.iframeView.InitAutoLinking();if(this.config.view!="wysiwyg"){var m,j=false,l=false,k=this.toolbar.GetControlsMap();if(this.config.view=="split"){for(m=0;m<k.length;m++){if(k[m]&&k[m].id=="ChangeView"){j=true;break}}if(!j){this.config.view="wysiwyg"}}if(this.config.view!="wysiwyg"){for(m=0;m<k.length;m++){if(k[m]&&(k[m].id=="BbCode"||k[m].id=="ChangeView")){l=true;break}}if(!l){this.config.view="wysiwyg"}}}this.SetView(this.config.view,false);if(this.config.setFocusAfterShow!==false){this.Focus(false)}this.sandbox.inited=true;this.On("OnCreateIframeAfter",[this])},GetDialog:function(j,k){if(!this.dialogs[j]&&f.BXHtmlEditor.dialogs[j]){this.dialogs[j]=new f.BXHtmlEditor.dialogs[j](this,k)}return this.dialogs[j]||null},Show:function(){this.dom.cont.style.display=""},Hide:function(){this.dom.cont.style.display="none"},IsShown:function(){return this.inited&&this.dom.cont.style.display!=="none"&&this.dom.cont.offsetWidth>0&&BX.isNodeInDom(this.dom.cont)},SetView:function(k,j){this.On("OnSetViewBefore");if(k=="split"&&this.bbCode){k="wysiwyg"}if(this.currentViewName!=k){if(k=="wysiwyg"){this.iframeView.Show();this.textareaView.Hide();this.dom.splitResizer.style.display="none";this.CheckBodyHeight()}else{if(k=="code"){this.iframeView.Hide();this.textareaView.Show();this.CheckCurrentStatus(false);this.dom.splitResizer.style.display="none"}else{if(k=="split"){this.textareaView.Show();this.iframeView.Show();this.dom.splitResizer.style.display="";this.CheckBodyHeight()}}}this.currentViewName=k}if(j!==false){this.SaveOption("view",k)}this.ResizeSceleton();this.On("OnSetViewAfter")},GetViewMode:function(){return this.currentViewName},SetContent:function(l,k){this.On("OnSetContentBefore");if(this.bbCode){var j=this.bbParser.Parse(l);this.iframeView.SetValue(j,k)}else{this.iframeView.SetValue(l,k)}this.textareaView.SetValue(l,false);this.On("OnSetContentAfter")},Focus:function(j){if(this.currentViewName=="wysiwyg"){this.iframeView.Focus(j)}else{if(this.currentViewName=="code"){this.textareaView.Focus(j)}else{if(this.currentViewName=="split"){if(this.synchro.GetSplitMode()=="wysiwyg"){this.iframeView.Focus(j)}else{this.textareaView.Focus(j)}}}}this.On("OnFocus");return this},SaveContent:function(){if(this.currentViewName=="wysiwyg"||(this.currentViewName=="split"&&this.synchro.GetSplitMode()=="wysiwyg")){this.synchro.lastIframeValue="";this.synchro.FromIframeToTextarea(true,true)}else{this.textareaView.SaveValue()}},GetContent:function(){this.SaveContent();return this.textareaView.GetValue()},IsExpanded:function(){return this.expanded},Expand:function(l){if(l==undefined){l=!this.expanded}var r=this,u=BX.GetWindowInnerSize(document),p,w,t,n,j,o,k,q;if(l){var m=BX.GetWindowScrollPos(document),v=BX.pos(this.dom.cont);p=this.dom.cont.offsetWidth;w=this.dom.cont.offsetHeight;t=v.top;n=v.left;j=u.innerWidth;o=u.innerHeight;k=m.scrollTop;q=m.scrollLeft;this.savedSize={width:p,height:w,top:t,left:n,scrollLeft:m.scrollLeft,scrollTop:m.scrollTop,configWidth:this.config.width,configHeight:this.config.height};this.config.width=j;this.config.height=o;BX.addClass(this.dom.cont,"bx-html-editor-absolute");this._bodyOverflow=document.body.style.overflow;document.body.style.overflow="hidden";this.dummieDiv=BX.create("DIV");this.dummieDiv.style.width=p+"px";this.dummieDiv.style.height=w+"px";this.dom.cont.parentNode.insertBefore(this.dummieDiv,this.dom.cont);document.body.appendChild(this.dom.cont);BX.addCustomEvent(this,"OnIframeKeydown",BX.proxy(this.CheckEscCollapse,this));BX.bind(document.body,"keydown",BX.proxy(this.CheckEscCollapse,this));BX.bind(f,"scroll",BX.proxy(this.PreventScroll,this))}else{p=this.dom.cont.offsetWidth;w=this.dom.cont.offsetHeight;t=this.savedSize.scrollTop;n=this.savedSize.scrollLeft;j=this.savedSize.width;o=this.savedSize.height;k=this.savedSize.top;q=this.savedSize.left;BX.removeCustomEvent(this,"OnIframeKeydown",BX.proxy(this.CheckEscCollapse,this));BX.unbind(document.body,"keydown",BX.proxy(this.CheckEscCollapse,this));BX.unbind(f,"scroll",BX.proxy(this.PreventScroll,this))}this.dom.cont.style.width=p+"px";this.dom.cont.style.height=w+"px";this.dom.cont.style.top=t+"px";this.dom.cont.style.left=n+"px";var s=this.GetContent();this.expandAnimation=new BX.easing({duration:300,start:{height:w,width:p,top:t,left:n},finish:{height:o,width:j,top:k,left:q},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(x){r.dom.cont.style.width=x.width+"px";r.dom.cont.style.height=x.height+"px";r.dom.cont.style.top=x.top+"px";r.dom.cont.style.left=x.left+"px";r.ResizeSceleton(x.width.toString(),x.height.toString())},complete:function(){r.expandAnimation=null;if(!l){r.util.ReplaceNode(r.dummieDiv,r.dom.cont);r.dummieDiv=null;r.dom.cont.style.width="";r.dom.cont.style.height="";r.dom.cont.style.top="";r.dom.cont.style.left="";BX.removeClass(r.dom.cont,"bx-html-editor-absolute");document.body.style.overflow=r._bodyOverflow;r.config.width=r.savedSize.configWidth;r.config.height=r.savedSize.configHeight;r.ResizeSceleton()}setTimeout(function(){r.CheckAndReInit(s)},10)}});this.expandAnimation.animate();this.expanded=l},CheckEscCollapse:function(l,k,m,j){if(!k){k=l.keyCode}if(this.IsExpanded()&&k==this.KEY_CODES.escape&&!this.IsPopupsOpened()){this.Expand(false);return BX.PreventDefault(l)}},PreventScroll:function(j){f.scrollTo(this.savedSize.scrollLeft,this.savedSize.scrollTop);return BX.PreventDefault(j)},IsPopupsOpened:function(){return !!(this.dialogShown||this.popupShown||this.contextMenuShown||this.overlay.bShown)},ReInitIframe:function(){this.sandbox.InitIframe();this.iframeView.OnCreateIframe();this.synchro.StopSync();this.synchro.lastTextareaValue="";this.synchro.FromTextareaToIframe(true);this.synchro.StartSync();this.iframeView.ReInit();this.selection.lastCheckedRange=null;if(this.config.setFocusAfterShow!==false){this.Focus()}},CheckAndReInit:function(j){if(this.sandbox.inited){var l=this.sandbox.GetWindow();if(l){var k=this.sandbox.GetDocument();if(k!==this.iframeView.document||!k.head||k.head.innerHTML==""){this.iframeView.document=k;this.iframeView.element=k.body;this.ReInitIframe()}else{if(k.body){k.body.style.minHeight=""}}}else{throw new Error("HtmlEditor: CheckAndReInit error iframe isn't in the DOM")}}if(j!==undefined){this.SetContent(j,true);this.CheckBodyHeight()}},Disable:function(){},Enable:function(){},CheckConfig:function(j){if(j.content===undefined){j.content=""}return j},GetInnerHtml:function(k){var l="%7E",j="&amp;",m=k.innerHTML;if(m.indexOf(j)!==-1||m.indexOf(l)!==-1){m=m.replace(/(?:href|src)\s*=\s*("|')([\s\S]*?)(\1)/ig,function(n){n=n.replace(/%7E/ig,"~");n=n.replace(/&amp;/ig,"&");return n})}m=m.replace(/(?:title|alt)\s*=\s*("|')([\s\S]*?)(\1)/ig,function(n){n=n.replace(/</g,"&lt;");n=n.replace(/>/g,"&gt;");return n});if(this.bbCode){m=m.replace(/[\s\n\r]*?<!--[\s\S]*?-->[\s\n\r]*?/ig,"")}return m},InitUtil:function(){var k=this;this.util={};if("textContent" in document.documentElement){this.util.SetTextContent=function(l,m){l.textContent=m};this.util.GetTextContent=function(l){return l.textContent}}else{if("innerText" in document.documentElement){this.util.SetTextContent=function(l,m){l.innerText=m};this.util.GetTextContent=function(l){return l.innerText}}else{this.util.SetTextContent=function(l,m){l.nodeValue=m};this.util.GetTextContent=function(l){return l.nodeValue}}}this.util.AutoCloseTagSupported=function(){var m=document.createElement("div"),l,n;m.innerHTML="<p><div></div>";n=m.innerHTML.toLowerCase();l=n==="<p></p><div></div>"||n==="<p><div></div></p>";k.util.AutoCloseTagSupported=function(){return l};return l};this.util.FirstLetterSupported=function(){var l=!BX.browser.IsChrome()&&!BX.browser.IsSafari();k.util.FirstLetterSupported=function(){return l};return l};this.util.CheckGetAttributeTruth=function(){var m=document.createElement("td"),l=m.getAttribute("rowspan")!="1";k.util.CheckGetAttributeTruth=function(){return l};return l};this.util.CheckHTML5Support=function(o){if(!o){o=document}var l=false,m="<article>bitrix</article>",n=o.createElement("div");n.innerHTML=m;l=n.innerHTML.toLowerCase()===m;k.util.CheckHTML5Support=function(){return l};return l};this.util.CheckHTML5FullSupport=function(q){if(!q){q=document}var o,m=k.GetHTML5Tags(),l=false,p=q.createElement("div");for(var n=0;n<m.length;n++){o="<"+m[n]+">bitrix</"+m[n]+">";p.innerHTML=o;l=p.innerHTML.toLowerCase()===o;if(!l){break}}k.util.CheckHTML5FullSupport=function(){return l};return l};this.util.GetEmptyImage=function(){return k.EMPTY_IMAGE_SRC};this.util.CheckDataTransferSupport=function(){var l=false;try{l=!!(f.Clipboard||f.DataTransfer).prototype.getData}catch(m){}k.util.CheckDataTransferSupport=function(){return l};return l};this.util.CheckImageSelectSupport=function(){var l=!(BX.browser.IsChrome()||BX.browser.IsSafari());k.util.CheckImageSelectSupport=function(){return l};return l};this.util.CheckPreCursorSupport=function(){var l=!(BX.browser.IsIE()||BX.browser.IsIE10()||BX.browser.IsIE11());k.util.CheckPreCursorSupport=function(){return l};return l};this.util.Refresh=function(o){if(o&&o.parentNode){var s="bx-editor-refresh";BX.addClass(o,s);BX.removeClass(o,s);if(BX.browser.IsFirefox()){try{var n,r=o.ownerDocument,l=r.getElementsByTagName("I"),q=l.length;for(n=0;n<l.length;n++){l[n].setAttribute("data-bx-orgig-i",true)}r.execCommand("italic",false,null);r.execCommand("italic",false,null);var m=r.getElementsByTagName("I");if(m.length!==q){for(n=0;n<m.length;n++){if(m[n].getAttribute("data-bx-orgig-i")){m[n].removeAttribute("data-bx-orgig-i")}else{k.util.ReplaceWithOwnChildren(m[n])}}}}catch(p){}}}};this.util.addslashes=function(l){l=l.replace(/\\/g,"\\\\");l=l.replace(/"/g,'\\"');return l};this.util.stripslashes=function(l){l=l.replace(/\\"/g,'"');l=l.replace(/\\\\/g,"\\");return l};this.util.ReplaceNode=function(m,l){m.parentNode.insertBefore(l,m);m.parentNode.removeChild(m);return l};this.util.spaceUrlEncode=function(l){l=l.replace(/ /g,"%20");return l};this.util.spaceUrlDecode=function(l){l=l.replace(/%20/g," ");return l};this.util.DocumentHasTag=function(o,l){var n={},m=k.id+":"+l,p=n[m];if(!p){p=n[m]=o.getElementsByTagName(l)}return p.length>0};this.util.IsSplitPoint=function(m,n){var l=n>0&&n<m.childNodes.length;if(rangy.dom.isCharacterDataNode(m)){if(n==0){l=!!m.previousSibling}else{if(n==m.length){l=!!m.nextSibling}else{l=true}}}return l};this.util.SplitNodeAt=function(o,m,n){var l;if(rangy.dom.isCharacterDataNode(m)){if(n==0){n=rangy.dom.getNodeIndex(m);m=m.parentNode}else{if(n==m.length){n=rangy.dom.getNodeIndex(m)+1;m=m.parentNode}else{l=rangy.dom.splitDataNode(m,n)}}}if(!l){l=m.cloneNode(false);if(l.id){l.removeAttribute("id")}var p;while((p=m.childNodes[n])){l.appendChild(p)}rangy.dom.insertAfter(l,m)}if(m&&m.nodeName=="BODY"){return l}return(m==o)?l:k.util.SplitNodeAt(o,l.parentNode,rangy.dom.getNodeIndex(l))};this.util.ReplaceWithOwnChildren=function(m){var l=m.parentNode;while(m.firstChild){l.insertBefore(m.firstChild,m)}l.removeChild(m)};this.util.IsBlockElement=function(m){var l=BX.style(m,"display");return l&&l.toLowerCase()==="block"};this.util.IsBlockNode=function(l){return l&&l.nodeType==1&&BX.util.in_array(l.nodeName,k.GetBlockTags())};this.util.CopyAttributes=function(l,q,p){if(q&&p){var o,m,n=l.length;for(m=0;m<n;m++){o=l[m];if(q[o]){p[o]=q[o]}}}};this.util.RenameNode=function(n,m){var l=n.ownerDocument.createElement(m),o;while(o=n.firstChild){l.appendChild(o)}k.util.CopyAttributes(["align","className"],n,l);if(n.style.cssText!=""){l.style.cssText=n.style.cssText}n.parentNode.replaceChild(l,n);return l};this.util.GetInvisibleTextNode=function(){return k.iframeView.document.createTextNode(k.INVISIBLE_SPACE)};this.util.IsEmptyNode=function(m,o,n){var l;if(m.nodeType==3){l=m.data===""||m.data===k.INVISIBLE_SPACE||(m.data==="\n"&&o);if(!l&&n&&m.data.toString().match(/^[\s\n\r\t]+$/ig)){l=true}}else{if(m.nodeType==1){l=m.innerHTML===""||m.innerHTML===k.INVISIBLE_SPACE;if(!l&&n&&m.innerHTML.toString().match(/^[\s\n\r\t]+$/ig)){l=true}}}return l};var j=document.documentElement;if("textContent" in j){this.util.SetTextContent=function(l,m){l.textContent=m};this.util.GetTextContent=function(l){return l.textContent}}else{if("innerText" in j){this.util.SetTextContent=function(l,m){l.innerText=m};this.util.GetTextContent=function(l){return l.innerText}}else{this.util.SetTextContent=function(l,m){l.nodeValue=m};this.util.GetTextContent=function(l){return l.nodeValue}}}this.util.GetTextContentEx=function(q){var p,o,r=[],s=q.cloneNode(true),l=s.getElementsByTagName("SCRIPT"),n=s.getElementsByTagName("A");for(p=l.length-1;p>=0;p--){BX.remove(l[p])}for(p=n.length-1;p>=0;p--){var m=n[p].href;if(m.toLowerCase().indexOf("javascript:")!==-1){k.util.ReplaceNode(n[p],n[p].ownerDocument.createTextNode(k.util.GetTextContent(n[p])))}else{r.push('<a href="'+n[p].href+'">'+k.util.GetTextContent(n[p])+"</a>");k.util.ReplaceNode(n[p],n[p].ownerDocument.createTextNode("#BX~TMP~LINK"+(r.length-1)+"#"))}}o=k.util.GetTextContent(s);if(r.length>0){o=o.replace(/#BX~TMP~LINK(\d+)#/ig,function(u,t){return r[t]||""})}return o};this.util.RgbToHex=function(m){if(!m){m=""}if(m.search("rgb")!==-1){function l(n){return("0"+parseInt(n).toString(16)).slice(-2)}m=m.replace(/rgba\(0,\s*0,\s*0,\s*0\)/ig,"transparent");m=m.replace(/rgba?\((\d{1,3}),\s*(\d{1,3}),\s*(\d{1,3})(?:,\s*([\d\.]{1,3}))?\)/ig,function(r,q,p,o,n){return"#"+l(q)+l(p)+l(o)})}return m};this.util.CheckCss=function(o,p,l){var n=true,m;for(m in p){if(p.hasOwnProperty(m)){if(o.style[m]!=""){n=n&&(l?o.style[m]==p[m]:true)}else{n=false}}}return n};this.util.SetCss=function(o,m){if(o&&m&&typeof m=="object"){for(var l in m){if(m.hasOwnProperty(l)){o.style[l]=m[l]}}}};this.util.InsertAfter=function(m,l){return rangy.dom.insertAfter(m,l)};this.util.GetNodeDomOffset=function(m){var l=0;while(m.parentNode&&m.parentNode.nodeName!=="BODY"){m=m.parentNode;l++}return l};this.util.CheckSurrogateNode=function(l){return k.phpParser.CheckParentSurrogate(l)};this.util.CheckSurrogateDd=function(l){return k.phpParser.CheckSurrogateDd(l)};this.util.GetPreviousNotEmptySibling=function(m){var l=m.previousSibling;while(l&&l.nodeType==3&&k.util.IsEmptyNode(l,true,true)){l=l.previousSibling}return l};this.util.GetNextNotEmptySibling=function(m){var l=m.nextSibling;while(l&&l.nodeType==3&&k.util.IsEmptyNode(l,true,true)){l=l.nextSibling}return l};this.util.IsEmptyLi=function(l){if(l&&l.nodeName=="LI"){return k.util.IsEmptyNode(l,true,true)||l.innerHTML.toLowerCase()=="<br>"}return false};this.util.FindParentEx=function(m,n,l){if(BX.checkNode&&BX.checkNode(m,n)){return m}return BX.findParent(m,n,l)};this.util.IsEmptyObject=function(m){for(var l in m){if(m.hasOwnProperty(l)){return false}}return true}},Parse:function(k,j,l){j=!!j;this.content=k;this.On("OnParse",[j]);if(j){this.content=this.parser.Parse(this.content,this.GetParseRules(),this.GetIframeDoc(),true,j);if((l===true||this.textareaView.IsShown())&&!this.bbCode){this.content=this.FormatHtml(this.content)}this.content=this.phpParser.ParseBxNodes(this.content)}else{this.content=this.phpParser.ParsePhp(this.content);this.content=this.parser.Parse(this.content,this.GetParseRules(),this.GetIframeDoc(),true,j)}this.On("OnAfterParse",[j]);return this.content},On:function(k,j){BX.onCustomEvent(this,k,j||[])},GetIframeDoc:function(){if(!this.document){this.document=this.sandbox.GetDocument();BX.addCustomEvent(this,"OnIframeReInit",BX.proxy(function(){this.document=this.sandbox.GetDocument()},this))}return this.document},GetParseRules:function(){this.rules=d;this.On("OnGetParseRules");var j=this;this.GetParseRules=function(){return j.rules};return this.rules},GetHTML5Tags:function(){return this.HTML5_TAGS},GetBlockTags:function(){return this.BLOCK_TAGS},SetBxTag:function(j,k){var l;if(k.id||j&&j.id){l=k.id||j.id}if(!l){l="bxid"+Math.round(Math.random()*1000000000)}else{if(this.bxTags[l]){if(!k.tag){k.tag=this.bxTags[l].tag}}}k.id=l;if(j){j.id=k.id}this.bxTags[k.id]=k;return k.id},GetBxTag:function(j){var k;if(typeof j=="object"&&j&&j.id){k=j.id}else{k=j}if(k){if(typeof k!="string"&&k.id){k=k.id}if(k&&k.length>0&&this.bxTags[k]&&this.bxTags[k].tag){this.bxTags[k].tag=this.bxTags[k].tag.toLowerCase();return this.bxTags[k]}}return{tag:false}},OnMousedown:function(k){var j=k.target||k.srcElement;if(j&&(j.getAttribute||j.parentNode)){var m=this,l=j.getAttribute("data-bx-type");if(!l){j=BX.findParent(j,function(o){return o==m.dom.cont||(o.getAttribute&&o.getAttribute("data-bx-type"))},this.dom.cont);l=(j&&j.getAttribute)?j.getAttribute("data-bx-type"):null}if(l=="action"){return BX.PreventDefault(k)}}return true},OnClick:function(k){var j=k.target||k.srcElement,l=(j&&j.getAttribute)?j.getAttribute("data-bx-type"):false;this.On("OnClickBefore",[{e:k,target:j,bxType:l}]);this.CheckCommand(j)},CheckCommand:function(j){if(j&&(j.getAttribute||j.parentNode)){var n=this,m=j.getAttribute("data-bx-type");if(!m){j=BX.findParent(j,function(o){return o==n.dom.cont||(o.getAttribute&&o.getAttribute("data-bx-type"))},this.dom.cont);m=(j&&j.getAttribute)?j.getAttribute("data-bx-type"):null}if(m=="action"){var l=j.getAttribute("data-bx-action"),k=j.getAttribute("data-bx-value");if(this.action.IsSupported(l)){this.action.Exec(l,k)}}}},SetSplitMode:function(k,j){this.config.splitVertical=!!k;if(j!==false){this.SaveOption("split_vertical",this.config.splitVertical?1:0)}this.SetView("split",j)},GetSplitMode:function(){return this.config.splitVertical},StartSplitResize:function(p){this.dom.resizerOverlay.style.display="block";var k=0,j=0,r=BX.GetWindowScrollPos(),m=p.clientX+r.scrollLeft,l=p.clientY+r.scrollTop,o=this;function n(u,t){var s=u.clientX+r.scrollLeft,v=u.clientY+r.scrollTop;if(m==s&&l==v){return}k=m-s;j=l-v;o.ResizeSceleton(0,0,{deltaX:k,deltaY:j,updateSplitRatio:t})}function q(s){n(s,true);BX.unbind(document,"mousemove",n);BX.unbind(document,"mouseup",q);o.dom.resizerOverlay.style.display="none"}BX.bind(document,"mousemove",n);BX.bind(document,"mouseup",q)},Request:function(m){if(!m.url){m.url=this.config.actionUrl}if(m.bIter!==false){m.bIter=true}if(!m.postData&&!m.getData){m.getData=this.GetReqData()}var l=m.getData?m.getData.reqId:m.postData.reqId;var n=this,j=0;var k=function(p){function o(){var q=m.handler(n.GetRequestRes(l),p);if(q===false&&++j<20&&m.bIter){setTimeout(o,5)}else{n.ClearRequestRes(l)}}setTimeout(o,50)};if(m.postData){BX.ajax.post(m.url,m.postData,k)}else{BX.ajax.get(m.url,m.getData,k)}},GetRequestRes:function(j){if(top.BXHtmlEditorAjaxResponse[j]!=undefined){return top.BXHtmlEditorAjaxResponse[j]}return{}},ClearRequestRes:function(j){if(top.BXHtmlEditorAjaxResponse){top.BXHtmlEditorAjaxResponse[j]=null;delete top.BXHtmlEditorAjaxResponse[j]}},GetReqData:function(j,k){if(!k){k={}}if(j){k.action=j}k.sessid=BX.bitrix_sessid();k.bx_html_editor_request="Y";k.reqId=Math.round(Math.random()*1000000);return k},GetTemplateId:function(){return this.templateId},GetSiteId:function(){return this.config.siteId},GetComponentFilter:function(){return this.componentFilter},GetTemplateParams:function(){return this.templates[this.templateId]},GetTemplateStyles:function(){var j=this.templates[this.templateId]||{};return j.STYLES||""},ApplyTemplate:function(m){if(this.templateId!==m){if(this.templates[m]){this.templateId=m;var o=this.templates[m],l,p=this.sandbox.GetDocument(),k=p.head||p.getElementsByTagName("HEAD")[0],n=k.getElementsByTagName("STYLE"),j=k.getElementsByTagName("LINK");for(l=0;l<n.length;l++){if(n[l].getAttribute("data-bx-template-style")=="Y"){BX.cleanNode(n[l],true)}}l=0;while(l<j.length){if(j[l].getAttribute("data-bx-template-style")=="Y"){BX.remove(j[l],true)}else{l++}}if(o.STYLES){k.appendChild(BX.create("STYLE",{props:{type:"text/css"},text:o.STYLES},p)).setAttribute("data-bx-template-style","Y")}if(o&&o.EDITOR_STYLES){for(l=0;l<o.EDITOR_STYLES.length;l++){k.appendChild(BX.create("link",{props:{rel:"stylesheet",href:o.EDITOR_STYLES[l]+"_"+this.cssCounter++}},p)).setAttribute("data-bx-template-style","Y")}}this.On("OnApplySiteTemplate",[m])}else{var q=this;this.Request({getData:this.GetReqData("load_site_template",{site_template:m}),handler:function(r){q.templates[m]=r;q.ApplyTemplate(m)}})}}},FormatHtml:function(k,j){if(k.length<this.MAX_HANDLED_FORMAT_LENGTH||j===true){if(!this.formatter){this.formatter=new f.BXHtmlEditor.BXCodeFormatter(this)}var m=new Date().getTime();k=this.formatter.Format(k);var l=new Date().getTime();if(l-m>this.MAX_HANDLED_FORMAT_TIME){this.MAX_HANDLED_FORMAT_LENGTH-=5000}}return k},GetFontFamilyList:function(){if(!this.fontFamilyList){this.fontFamilyList=[{value:["Times New Roman","Times"],name:"Times New Roman"},{value:["Courier New"],name:"Courier New"},{value:["Arial","Helvetica"],name:"Arial / Helvetica"},{value:["Arial Black","Gadget"],name:"Arial Black"},{value:["Tahoma","Geneva"],name:"Tahoma / Geneva"},{value:"Verdana",name:"Verdana"},{value:["Georgia","serif"],name:"Georgia"},{value:"monospace",name:"monospace"}];this.On("GetFontFamilyList",[this.fontFamilyList])}return this.fontFamilyList},CheckCurrentStatus:function(j){var l,o,p,n,m=this.GetActiveActions();if(j===false){for(o in m){if(m.hasOwnProperty(o)&&this.action.IsSupported(o)){l=m[o];l.control.SetValue(false,null,o)}}}if(!this.iframeView.IsFocused()){return this.On("OnIframeBlur")}var k=this.selection.GetRange();if(!k||!k.isValid()){return this.On("OnIframeBlur")}for(o in m){if(m.hasOwnProperty(o)&&this.action.IsSupported(o)){l=m[o];p=this.action.CheckState(o,l.value);n=l.control.GetValue();if(p){l.control.SetValue(true,p,o)}else{l.control.SetValue(false,null,o)}}}},RegisterCheckableAction:function(j,k){if(!this.checkedActionList){this.checkedActionList={}}this.checkedActionList[j]=k},GetActiveActions:function(){return this.checkedActionList},SaveOption:function(j,k){BX.userOptions.save("html_editor",this.config.settingsKey,j,k)},GetCurrentCssClasses:function(j){return this.styles.GetCSS(this.templateId,this.templates[this.templateId].STYLES,this.templates[this.templateId].PATH||"",j||false)},GetStylesDescription:function(k){if(!k){k=this.templateId}var j={};if(k&&this.templates[k]){j=this.templates[k].STYLES_TITLE||{}}return j},IsInited:function(){return !!this.inited},IsContentChanged:function(){var k=this.config.content.replace(/[\s\n\r\t]+/ig,""),j=this.GetContent().replace(/[\s\n\r\t]+/ig,"");return k!=j},IsSubmited:function(){return this.isSubmited},OnSubmit:function(){if(!this.isSubmited&&this.dom.cont.style.display!=="none"){this.RemoveCursorNode();this.isSubmited=true;if(this.iframeView.IsFocused()){this.On("OnIframeBlur")}this.On("OnSubmit");this.SaveContent()}},AllowBeforeUnloadHandler:function(){this.beforeUnloadHandlerAllowed=true},DenyBeforeUnloadHandler:function(){this.beforeUnloadHandlerAllowed=false},Destroy:function(){if(this.sandbox){this.sandbox.Destroy()}if(this.Check()){BX.remove(this.dom.cont)}},Check:function(){return this.dom.cont&&BX.isNodeInDom(this.dom.cont)},IsVisible:function(){return this.Check()&&this.dom.cont.offsetWidth>0},GetLastSpecialchars:function(){var j=["&cent;","&sect;","&euro;","&pound;","&yen;","&copy;","&reg;","&laquo;","&raquo;","&deg;","&plusmn;","&para;","&hellip;","&prime;","&Prime;","&trade;","&asymp;","&ne;","&lt;","&gt;"];if(this.config.lastSpecialchars&&typeof this.config.lastSpecialchars=="object"&&this.config.lastSpecialchars.length>1){return this.config.lastSpecialchars}else{return j}},GetIframeElement:function(k){var j=this.GetIframeDoc();return j?j.getElementById(k):null},RegisterDialog:function(k,j){f.BXHtmlEditor.dialogs[k]=j},SetConfigHeight:function(j){this.config.height=j;if(this.IsExpanded()){this.savedSize.configHeight=j;this.savedSize.height=j}},CheckBrowserCompatibility:function(){return !(BX.browser.IsOpera()||BX.browser.IsIE8()||BX.browser.IsIE7()||BX.browser.IsIE6()||!document.querySelectorAll)},GetCursorHtml:function(){return'<span id="bx-cursor-node"> </span>'},SetCursorNode:function(j){if(!j){j=this.selection.GetRange()}this.RemoveCursorNode();this.selection.InsertHTML(this.GetCursorHtml(),j)},RestoreCursor:function(){var j=this.GetIframeElement("bx-cursor-node");if(j){this.selection.SetAfter(j);BX.remove(j)}},RemoveCursorNode:function(){if(this.synchro.IsFocusedOnTextarea()){}else{var j=this.GetIframeElement("bx-cursor-node");if(j){this.selection.SetAfter(j);BX.remove(j)}}},AddButton:function(k){if(k.compact==undefined){k.compact=false}if(k.toolbarSort==undefined){k.toolbarSort=301}if(k.hidden==undefined){k.hidden=false}var j=function(m,l){j.superclass.constructor.apply(this,arguments);this.id=k.id;this.title=k.name;if(k.iconClassName){this.className+=" "+k.iconClassName}if(k.action){this.action=k.action}if(k.disabledForTextarea!==undefined){this.disabledForTextarea=k.disabledForTextarea}this.Create();if(k.src){this.pCont.firstChild.style.background='url("'+k.src+'") no-repeat scroll 0 0'}if(l){l.appendChild(this.GetCont())}};BX.extend(j,f.BXHtmlEditor.Button);if(k.handler){j.prototype.OnClick=k.handler}f.BXHtmlEditor.Controls[k.id]=j;BX.addCustomEvent(this,"GetControlsMap",function(l){l.push({id:k.id,compact:k.compact,hidden:k.hidden,sort:k.toolbarSort,checkWidth:k.checkWidth==undefined?true:!!k.checkWidth,offsetWidth:(k.offsetWidth||32)})})},AddCustomParser:function(k){if(this.phpParser&&this.phpParser.AddCustomParser){this.phpParser.AddCustomParser(k)}else{var j=this;BX.addCustomEvent("OnEditorInitedAfter",function(){j.phpParser.AddCustomParser(k)})}},AddParser:function(j){if(j&&j.name&&typeof j.obj=="object"){this.parser.specialParsers[j.name]=j.obj}},InsertHtml:function(k,j){if(!this.synchro.IsFocusedOnTextarea()){this.Focus();if(this.selection.lastCheckedRange&&this.selection.lastCheckedRange.range&&!j){try{this.selection.SetSelection(this.selection.lastCheckedRange.range)}catch(m){}}if(!j){j=this.selection.GetRange()}if(!j&&this.selection.lastRange){j=this.selection.lastRange}if(j){if(!j.collapsed&&j.startContainer==j.endContainer&&j.startContainer.nodeName!=="BODY"){var l=this.util.CheckSurrogateNode(j.startContainer);if(l){this.selection.SetAfter(l)}}this.selection.InsertHTML(k,j);this.selection.ScrollIntoView()}}},ParseContentFromBbCode:function(j){if(this.bbCode){j=this.bbParser.Parse(j);j=this.Parse(j,true,true)}return j},LoadFileDialogs:function(k){var j=this;this.Request({getData:this.GetReqData("load_file_dialogs",{editor_id:this.id}),handler:function(m,l){l=BX.util.trim(l);j.dom.fileDialogsWrap.innerHTML=l;j.fileDialogsLoaded=true;setTimeout(k,100)}})},InitAutosaveHandlers:function(){var j=this,k=this.dom.form;try{BX.addCustomEvent(this,"OnSubmit",function(){k.BXAUTOSAVE.Init()});BX.addCustomEvent(this,"OnContentChanged",function(){k.BXAUTOSAVE.Init()});BX.addCustomEvent(k,"onAutoSave",function(m,n){if(j.IsShown()&&!j.IsSubmited()){n[j.config.inputName]=j.GetContent()}});BX.addCustomEvent(k,"onAutoSaveRestore",function(m,n){if(j.IsShown()){j.SetContent(n[j.config.inputName],true)}})}catch(l){}},InitImageUploader:function(){if(this.config.uploadImagesFromClipboard!==false){var j=this.config.actionUrl;j+=(j.indexOf("?")!==-1?"&":"?")+"action=uploadfile";this.imageUploader=BX.Uploader.getInstance({id:this.CID,streams:1,allowUpload:"A",uploadFileUrl:j,uploadMethod:"immediate",showImage:false,sortItems:false,input:null,placeHolder:null,uploadFormData:"N"});var k=this;BX.addCustomEvent(this,"OnImageDataUriHandle",function(n,l){var m=BX.UploaderUtils.dataURLToBlob(l.src);if(m&&m.size>0&&m.type.indexOf("image/")==0){m.name=(m.name||l.title||(this.GetDefaultImageName()+"."+m.type.substr(6)));m.uniqId=l.uniqId;m.editorBase64Src=l.src;k.imageUploader.onChange([m])}});BX.addCustomEvent(this.imageUploader,"onFileIsCreated",function(m,l){BX.addCustomEvent(l,"onUploadDone",function(o,n){k.HandleImageDataUriCaughtUploadedCallback({src:o.file.editorBase64Src,uniqId:o.file.uniqId},{src:n.file.uploadedPath})})})}},GetDefaultImageName:function(){var j={value:false};this.On("OnGetDefaultUploadImageName",[j]);if(!j.value){j.value="content-img"}return j.value},InitClipboardHandler:function(){var k=this;this.base64Images=[];function j(l){k.pasteCheckItteration++;var m;for(m=0;m<l.length;m++){if(!l[m].getAttribute("data-bx-paste-check")){if(l[m].complete){k.CheckImage(l[m],false)}else{BX.bind(l[m],"load",BX.proxy(k.CheckImage,k))}l[m].setAttribute("data-bx-paste-check","Y")}}if(k.pasteCheckItteration==1){setTimeout(function(){j(l)},500)}else{if(k.pasteCheckItteration<15){setTimeout(function(){j(l)},1000)}}}BX.bind(this.iframeView.element,"paste",function(s){var n=false,q=s.clipboardData;if(q&&q.items){var p=q.items[0];if(p&&p.type.indexOf("image/")>-1){var o=p.getAsFile();if(o){var m=new FileReader();m.readAsDataURL(o);m.onload=function(u){n=true;var t=new Image();t.src=u.target.result;setTimeout(function(){k.selection.InsertNode(t);k.HandleImageDataUri(t)},100)}}}}if(!n){var r=k.GetIframeDoc(),l=r.body.getElementsByTagName("IMG");k.pasteCheckItteration=0;j(l)}});BX.addCustomEvent(this,"OnImageDataUriCaughtUploaded",BX.proxy(this.HandleImageDataUriCaughtUploadedCallback,this))},GetBase64Image:function(l){var k,j=false;for(k=0;k<this.base64Images.length;k++){if(this.base64Images[k].source==l){j=this.base64Images[k]}}return j},RegisterBase64Image:function(k,j){this.base64Images.push({source:k,status:j,index:this.base64Images.length})},CheckImage:function(k,j){if(k&&k.getAttribute){var l=k.getAttribute("src");if(l.indexOf("data:image/")!==-1){this.HandleImageDataUri(k)}if(j!==false){BX.unbind(k,"load",BX.proxy(this.CheckImage,this))}}},HandleImageDataUri:function(k){if(!k.getAttribute("data-bx-unique-id")){this.skipPasteControl=true;if(this.pasteControl.isOpened){this.pasteControl.Hide()}var j=this.GetBase64Image(k.src);if(j===false){this.RegisterBase64Image(k.src,"requested");var l="bx_base64_id_"+Math.round(Math.random()*1000000000);k.setAttribute("data-bx-unique-id",l);k.removeAttribute("data-bx-orig-src");this.On("OnImageDataUriHandle",[this,{src:k.src,title:k.title||"",uniqId:l}])}else{if(j.status=="uploaded"){this.HandleImageDataUriCaughtUploadedCallback({src:k.src,title:k.title||"",uniqId:j.uniqId},{src:j.fileSrc},j.htmlForInsert||null)}}}},HandleImageDataUriCaughtUploadedCallback:function(k,m,n){if(k&&k.uniqId&&m&&m.src){var p=this.GetBase64Image(k.src);if(p&&!p.fileSrc){p.status="uploaded";p.uniqId=k.uniqId;p.fileSrc=m.src;p.htmlForInsert=n}var l,o,j=this.GetIframeDoc().body.getElementsByTagName("IMG");for(l=0;l<j.length;l++){o=j[l];if(o.getAttribute("data-bx-unique-id")==k.uniqId||o.getAttribute("src")==k.src){if(n&&n.replacement){this.selection.SetAfter(o);this.selection.InsertHTML(n.replacement);BX.remove(o);if(n.callback){setTimeout(n.callback,300)}}else{o.src=m.src;o.setAttribute("src",m.src);o.setAttribute("data-bx-orig-src",m.src);o.removeAttribute("data-bx-paste-check");o.removeAttribute("data-bx-unique-id")}}}}this.skipPasteControl=false}};f.BXEditor=c;function e(k,j){this.callback=k||BX.DoNothing;this.config=j||{};this.editor=this.config.editor;this.iframe=this.CreateIframe();this.bSandbox=false;this.windowProperties=["parent","top","opener","frameElement","frames","localStorage","globalStorage","sessionStorage","indexedDB"];this.windowProperties2=["open","close","openDialog","showModalDialog","alert","confirm","prompt","openDatabase","postMessage","XMLHttpRequest","XDomainRequest"];this.documentProperties=["referrer","write","open","close"]}e.prototype={GetIframe:function(){return this.iframe},GetWindow:function(){this._readyError()},GetDocument:function(){this._readyError()},Destroy:function(){var j=this.GetIframe();j.parentNode.removeChild(j)},_readyError:function(){throw new Error("Sandbox: Sandbox iframe isn't loaded yet")},CreateIframe:function(){var k=this,j=BX.create("IFRAME",{props:{className:"bx-editor-iframe",frameborder:0,allowtransparency:"true",width:0,height:0,marginwidth:0,marginheight:0}});j.onload=function(){j.onreadystatechange=j.onload=null;k.OnLoadIframe(j)};j.onreadystatechange=function(){if(/loaded|complete/.test(j.readyState)){j.onreadystatechange=j.onload=null;k.OnLoadIframe(j)}};this.config.cont.appendChild(j);return j},OnLoadIframe:function(l){if(BX.isNodeInDom(l)){var o=this,j=l.contentWindow,n=j.document;this.InitIframe(l);j.onerror=function(q,r,p){throw new Error("Sandbox: "+q,r,p)};if(this.bSandbox){var k,m;for(k=0,m=this.windowProperties.length;k<m;k++){this._unset(j,this.windowProperties[k])}for(k=0,m=this.windowProperties2.length;k<m;k++){this._unset(j,this.windowProperties2[k],BX.DoNothing())}for(k=0,m=this.documentProperties.length;k<m;k++){this._unset(n,this.documentProperties[k])}this._unset(n,"cookie","",true)}this.loaded=true;setTimeout(function(){o.callback(o)},0)}},InitIframe:function(j){j=this.iframe||j;var k=j.contentWindow.document,l=this.GetHtml(this.config.stylesheets,this.editor.GetTemplateStyles());k.open("text/html","replace");k.write(l);k.close();this.GetWindow=function(){return j.contentWindow};this.GetDocument=function(){return j.contentWindow.document};this.editor.On("OnIframeInit")},GetHtml:function(m,n){var p="",l="",k;if(this.editor.config.bodyClass||this.editor.IsExpanded()){var j=this.editor.config.bodyClass||"";if(this.editor.IsExpanded()){j+=" fullscreen"}p+=' class="'+BX.util.trim(j)+'"'}if(this.editor.config.bodyId){p+=' id="'+this.editor.config.bodyId+'"'}var o=this.editor.GetTemplateParams();if(o&&o.EDITOR_STYLES){for(k=0;k<o.EDITOR_STYLES.length;k++){l+='<link data-bx-template-style="Y" rel="stylesheet" href="'+o.EDITOR_STYLES[k]+"_"+this.editor.cssCounter+++'">'}}m=typeof m==="string"?[m]:m;if(m){for(k=0;k<m.length;k++){l+='<link rel="stylesheet" href="'+m[k]+'">'}}l+='<link rel="stylesheet" href="'+this.editor.config.cssIframePath+"_"+this.editor.cssCounter+++'">';if(typeof n==="string"){l+='<style type="text/css" data-bx-template-style="Y">'+n+"</style>"}if(this.editor.iframeCssText&&this.editor.iframeCssText.length>0){l+='<style type="text/css">'+this.editor.iframeCssText+"</style>"}return"<!DOCTYPE html><html><head>"+l+"</head><body"+p+"></body></html>"},_unset:function(k,m,l,o){try{k[m]=l}catch(n){}try{k.__defineGetter__(m,function(){return l})}catch(n){}if(o){try{k.__defineSetter__(m,function(){})}catch(n){}}if(!crashesWhenDefineProperty(m)){try{var j={get:function(){return l}};if(o){j.set=function(){}}Object.defineProperty(k,m,j)}catch(n){}}}};function i(j){this.editor=j;this.document=j.sandbox.GetDocument();BX.addCustomEvent(this.editor,"OnIframeReInit",BX.proxy(function(){this.document=this.editor.sandbox.GetDocument()},this));f.rangy.init()}i.prototype={GetBookmark:function(){if(!this.editor.synchro.IsFocusedOnTextarea()){var j=this.GetRange();return j&&j.cloneRange()}return false},SetBookmark:function(j){if(j&&this.editor.currentViewName!=="code"){this.SetSelection(j)}},SaveBookmark:function(){this.lastRange=this.GetBookmark();return this.lastRange},GetLastRange:function(){if(this.lastRange){return this.lastRange}},RestoreBookmark:function(){if(this.lastRange){this.SetBookmark(this.lastRange);this.lastRange=false}},SetBefore:function(k){var j=rangy.createRange(this.document);j.setStartBefore(k);j.setEndBefore(k);return this.SetSelection(j)},SetAfter:function(k){var j=rangy.createRange(this.document);j.setStartAfter(k);j.setEndAfter(k);return this.SetSelection(j)},SelectNode:function(l){if(!l){return}var o=rangy.createRange(this.document),r=l.nodeType===1,s="canHaveHTML" in l?l.canHaveHTML:(l.nodeName!=="IMG"),q=r?l.innerHTML:l.data,n=(q===""||q===this.editor.INVISIBLE_SPACE),j=BX.style(l,"display"),k=(j==="block"||j==="list-item");if((BX.browser.IsIE()||BX.browser.IsIE10()||BX.browser.IsIE11())&&l&&BX.util.in_array(l.nodeName.toUpperCase(),this.editor.TABLE_TAGS)){if(l.tagName=="TABLE"||l.tagName=="TBODY"){var m=l.rows[0],t=l.rows[l.rows.length-1];o.setStartBefore(m.cells[0]);o.setEndAfter(t.cells[t.cells.length-1])}else{if(l.tagName=="TR"||l.tagName=="TH"){o.setStartBefore(l.cells[0]);o.setEndAfter(l.cells[l.cells.length-1])}else{o.setStartBefore(l);o.setEndAfter(l)}}this.SetSelection(o);return o}if(n&&r&&s){try{l.innerHTML=this.editor.INVISIBLE_SPACE}catch(p){}}if(s){o.selectNodeContents(l)}else{o.selectNode(l)}if(s&&n&&r){o.collapse(k)}else{if(s&&n){o.setStartAfter(l);o.setEndAfter(l)}}try{this.SetSelection(o)}catch(p){}return o},GetSelectedNode:function(l){var k,m,j;if(l&&this.document.selection&&this.document.selection.type==="Control"){j=this.document.selection.createRange();if(j&&j.length){k=j.item(0)}}if(!k){m=this.GetSelection();if(m.focusNode===m.anchorNode){k=m.focusNode}}if(!k){j=this.GetRange();k=j?j.commonparentContainer:this.document.body}if(k&&k.ownerDocument!=this.editor.GetIframeDoc()){k=this.document.body}return k},ExecuteAndRestore:function(k,u){var o=this.document.body,m=u&&o.scrollTop,p=u&&o.scrollLeft,s="_bx-editor-temp-placeholder",v='<span class="'+s+'">'+this.editor.INVISIBLE_SPACE+"</span>",n=this.GetRange(),t;if(!n){k(o,o);return}var l=n.createContextualFragment(v);n.insertNode(l);try{k(n.startContainer,n.endContainer)}catch(r){setTimeout(function(){throw r},0)}if(document.querySelector){var j=this.document.querySelector("."+s);if(j){t=rangy.createRange(this.document);t.selectNode(j);t.deleteContents();this.SetSelection(t)}else{o.focus()}}if(u){o.scrollTop=m;o.scrollLeft=p}try{if(j&&j.parentNode){j.parentNode.removeChild(j)}}catch(q){}},ExecuteAndRestoreSimple:function(j){var m=this.GetRange(),n=this.document.body,u,k,l,q,o;if(!m){j(n,n);return}q=m.getNodes([3]);k=q[0]||m.startContainer;l=q[q.length-1]||m.endContainer;o={collapsed:m.collapsed,startContainer:k,startOffset:k===m.startContainer?m.startOffset:0,endContainer:l,endOffset:l===m.endContainer?m.endOffset:l.length};try{j(m.startContainer,m.endContainer)}catch(p){setTimeout(function(){throw p},0)}u=rangy.createRange(this.document);try{u.setStart(o.startContainer,o.startOffset)}catch(t){}try{u.setEnd(o.endContainer,o.endOffset)}catch(s){}try{this.SetSelection(u)}catch(r){}},InsertHTML:function(l,k){var j=rangy.createRangyRange(this.document),n=j.createContextualFragment(l),m=n.lastChild;this.InsertNode(n,k);if(m){this.SetAfter(m)}this.editor.On("OnInsertHtml")},InsertNode:function(k,j){if(!j||!j.isValid||!j.isValid()){j=this.GetRange()}if(j){j.insertNode(k)}this.editor.On("OnInsertHtml")},RemoveNode:function(l){this.editor.On("OnHtmlContentChangedByControl");var k=l.parentNode,j=l.nextSibling;BX.remove(l);this.editor.util.Refresh(k);if(j){this.editor.selection.SetBefore(j);this.editor.Focus()}this.editor.synchro.StartSync(100)},Surround:function(k,j){j=j||this.GetRange();if(j){try{j.surroundContents(k);this.SelectNode(k)}catch(l){k.appendChild(j.extractContents());j.insertNode(k)}}},ScrollIntoView:function(){var k,m=this,q=this.document,n=this.editor.sandbox.GetWindow(),r=q.documentElement.scrollHeight>q.documentElement.offsetHeight;if(r&&n){var l=q.__scrollIntoViewElement=q.__scrollIntoViewElement||(function(){return BX.create("SPAN",{html:m.editor.INVISIBLE_SPACE},q)})(),p=0;this.InsertNode(l);if(l.parentNode){k=l;do{p+=k.offsetTop||0;k=k.offsetParent}while(k);l.parentNode.removeChild(l)}var j=BX.GetWindowScrollPos(q),o=BX.GetWindowInnerSize(q);if(p>j.scrollTop+o.innerHeight-40){n.scrollTo(j.scrollLeft,p)}}},SelectLine:function(){var m="getSelection" in f&&"modify" in f.getSelection();if(m){var s=this.document.defaultView,w=s.getSelection();w.modify("move","left","lineboundary");w.modify("extend","right","lineboundary")}else{if(this.document.selection){var r=this.document.selection.createRange(),p=r.boundingTop,x=r.boundingHeight,q=this.document.body.scrollWidth,l,k,t,o,n;if(!r.moveToPoint){return}if(p===0){t=this.document.createElement("span");this.insertNode(t);p=t.offsetTop;t.parentNode.removeChild(t)}p+=1;for(o=-10;o<q;o+=2){try{r.moveToPoint(o,p);break}catch(v){}}l=p;k=this.document.selection.createRange();for(n=q;n>=0;n--){try{k.moveToPoint(n,l);break}catch(u){}}r.setEndPoint("EndToEnd",k);r.select()}}},GetText:function(){var j=this.GetSelection();return j?j.toString():""},GetNodes:function(j,l){var k=this.GetRange();if(k){return k.getNodes([j],l)}else{return[]}},GetRange:function(p,n){if(!p){if(!this.editor.iframeView.IsFocused()&&n!==false){var o=this.editor.GetIframeDoc(),j=o.documentElement.scrollTop||o.body.scrollTop,q=o.documentElement.scrollLeft||o.body.scrollLeft;this.editor.iframeView.Focus();var k=o.documentElement.scrollTop||o.body.scrollTop,r=o.documentElement.scrollLeft||o.body.scrollLeft;if(k!==j||r!==q){var m=this.editor.sandbox.GetWindow();if(m){m.scrollTo(q,j)}}}p=this.GetSelection()}var l=p&&p.rangeCount&&p.getRangeAt(0);if(l.commonAncestorContainer&&l.commonAncestorContainer.nodeName=="#document"){l.selectNodeContents(this.editor.GetIframeDoc().body)}return l},GetSelection:function(j){return rangy.getSelection(j||this.document.defaultView||this.document.parentWindow)},SetSelection:function(j){var l=this.document.defaultView||this.document.parentWindow,k=rangy.getSelection(l);return k.setSingleRange(j)},GetStructuralTags:function(){if(!this.structuralTags){var j=/^TABLE/i;this.structuralTags={LI:/^UL|OL|MENU/i,DT:/^DL/i,DD:/^DL/i,TD:j,TR:j,TH:j,TBODY:j,TFOOT:j,THEAD:j,CAPTION:j,COL:j,COLGROUP:j};this.structuralTagsMatchRe=/^LI|DT|DD|TD|TR|TH|TBODY|CAPTION|COL|COLGROUP|TFOOT|THEAD/i}return this.structuralTags},SetCursorBeforeNode:function(j){},_GetNonTextLastChild:function(k){var j=k.lastChild;while(j.nodeType!=1&&j.previousSibling){j=j.previousSibling}return j.nodeType==1?j:false},_GetNonTextFirstChild:function(k){var j=k.firstChild;while(j.nodeType!=1&&j.nextSibling){j=j.nextSibling}return j.nodeType==1?j:false},_MoveCursorBeforeNode:function(l){var n=this,j,k,m;this.GetStructuralTags();if(l.nodeType==1&&l.nodeName.match(this.structuralTagsMatchRe)){m=this._GetNonTextFirstChild(l.parentNode)===l;if(!m){return}j=this.structuralTags[l.nodeName];if(j){k=BX.findParent(l,function(o){if(o.nodeName.match(j)){return true}m=m&&n._GetNonTextFirstChild(o.parentNode)===o;return false},l.ownerDocument.BODY);if(k&&m){l=k}else{return}}}this.SetInvisibleTextBeforeNode(l)},_MoveCursorAfterNode:function(m){var n=this,k,l,j;this.GetStructuralTags();if(m.nodeType==1&&m.nodeName.match(this.structuralTagsMatchRe)){j=this._GetNonTextLastChild(m.parentNode)===m;if(!j){return}k=this.structuralTags[m.nodeName];if(k){l=BX.findParent(m,function(o){if(o.nodeName.match(k)){return true}j=j&&n._GetNonTextLastChild(o.parentNode)===o;return false},m.ownerDocument.BODY);if(l&&j){m=l}else{return}}}this.SetInvisibleTextAfterNode(m)},SaveRange:function(k){var j=this.GetRange(false,k);if(j){this.lastCheckedRange={endOffset:j.endOffset,endContainer:j.endContainer,range:j}}else{setTimeout(BX.proxy(this.SaveRange,this),0)}},CheckLastRange:function(j){return this.lastCheckedRange&&this.lastCheckedRange.endOffset==j.endOffset&&this.lastCheckedRange.endContainer==j.endContainer},SetInvisibleTextAfterNode:function(k,l){var j=this.editor.util.GetInvisibleTextNode();if(k.nextSibling&&k.nextSibling.nodeType==3&&this.editor.util.IsEmptyNode(k.nextSibling)){this.editor.util.ReplaceNode(k.nextSibling,j)}else{this.editor.util.InsertAfter(j,k)}if(l){this.SetBefore(j)}else{this.SetAfter(j)}this.editor.Focus()},SetInvisibleTextBeforeNode:function(k){var j=this.editor.util.GetInvisibleTextNode();if(k.previousSibling&&k.previousSibling.nodeType==3&&this.editor.util.IsEmptyNode(k.previousSibling)){this.editor.util.ReplaceNode(k.previousSibling,j)}else{k.parentNode.insertBefore(j,k)}this.SetBefore(j);this.editor.Focus()},GetCommonAncestorForRange:function(j){return j.collapsed?j.startContainer:rangy.dom.getCommonAncestor(j.startContainer,j.endContainer)}};function g(j){this.isElementMerge=(j.nodeType==1);this.firstTextNode=this.isElementMerge?j.lastChild:j;this.firstNode=j;this.textNodes=[this.firstTextNode]}g.prototype={DoMerge:function(){var k,j=this.textNodes.length,o=[],n,l,m;for(k=0;k<j;++k){n=this.textNodes[k];if(this.textNodes[k].nodeType!==3){return false}l=n.parentNode;o[k]=n.data;if(k){l.removeChild(n);if(!l.hasChildNodes()){l.parentNode.removeChild(l)}}}this.firstTextNode.data=m=o.join("");return m},GetLength:function(){var k=this.textNodes.length,j=0;while(k--){j+=this.textNodes[k].length}return j}};function b(m,j,n,k,l){this.editor=m;this.document=m.iframeView.document;this.tagNames=j||[defaultTagName];this.arStyle=n||{};this.cssClass=k||"";this.similarClassRegExp=null;this.normalize=l;this.applyToAnyTagName=false}b.prototype={GetStyledParent:function(l,k){k=k!==false;var j,m;while(l){if(l.nodeType==1){m=this.CheckCssStyle(l,k);j=this.CheckCssClass(l);if(BX.util.in_array(l.tagName.toLowerCase(),this.tagNames)&&j&&m){return l}}l=l.parentNode}return false},CheckCssStyle:function(k,j){return this.editor.util.CheckCss(k,this.arStyle,j)},SimplifyNodesWithCss:function(l){var j,k=l.parentNode;if(k.childNodes.length==1){if(l.nodeName==k.nodeName){for(j in this.arStyle){if(this.arStyle.hasOwnProperty(j)&&l.style[j]){k.style[j]=l.style[j]}}this.editor.util.ReplaceWithOwnChildren(l)}else{for(j in this.arStyle){if(this.arStyle.hasOwnProperty(j)&&k.style[j]&&l.style[j]){k.style[j]=""}}}}},CheckCssClass:function(j){return !this.cssClass||(this.cssClass&&BX.hasClass(j,this.cssClass))},PostApply:function(u,r){var q,j=u[0],k=u[u.length-1],m=[],v,o=j,l=k,s=0,w=k.length,n,p;for(q=0;q<u.length;++q){n=u[q];p=this.GetAdjacentMergeableTextNode(n.parentNode,false);if(p){if(!v){v=new g(p);m.push(v)}v.textNodes.push(n);if(n===j){o=v.firstTextNode;s=o.length}if(n===k){l=v.firstTextNode;w=v.GetLength()}}else{v=null}}var t=this.GetAdjacentMergeableTextNode(k.parentNode,true);if(t){if(!v){v=new g(k);m.push(v)}v.textNodes.push(t)}if(m.length){for(q=0;q<m.length;++q){m[q].DoMerge()}r.setStart(o,s);r.setEnd(l,w)}u=r.getNodes([3]);for(q=0;q<u.length;++q){n=u[q];this.SimplifyNodesWithCss(n.parentNode)}},NormalizeNewNode:function(m,j){var l=m.parentNode;if(l&&l.nodeName!=="BODY"){var n=this.GetNonEmptyChilds(l),o=this.CheckCssStyle(l,false),k=this.CheckCssClass(l);if(n.length==1&&l.nodeName==m.nodeName&&o&&k){l.parentNode.insertBefore(m,l);BX.remove(l)}}return j},GetNonEmptyChilds:function(l){var k,m=l.childNodes,j=[];for(k=0;k<m.length;k++){if(m[k].nodeType==1||(m[k].nodeType==3&&m[k].nodeValue!=""&&m[k].nodeValue!=this.editor.INVISIBLE_SPACE&&!m[k].nodeValue.match(/^[\s\n\r\t]+$/ig))){j.push(m[k])}}return j},GetAdjacentMergeableTextNode:function(l,j){var n=(l.nodeType==3),k=n?l.parentNode:l,o,m=j?"nextSibling":"previousSibling";if(n){o=l[m];if(o&&o.nodeType==3){return o}}else{}return null},AreElementsMergeable:function(k,j){return rangy.dom.arrayContains(this.tagNames,(k.tagName||"").toLowerCase())&&rangy.dom.arrayContains(this.tagNames,(j.tagName||"").toLowerCase())&&k.className.replace(/\s+/g," ")==j.className.replace(/\s+/g," ")&&this.CompareNodeAttributes(k,j)},CompareNodeAttributes:function(p,n){if(p.attributes.length!=n.attributes.length){return false}var o,j=p.attributes.length,m,k,l;for(o=0;o<j;o++){m=p.attributes[o];l=m.name;if(l!="class"){k=n.attributes.getNamedItem(l);if(m.specified!=k.specified){return false}if(m.specified&&m.nodeValue!==k.nodeValue){return false}}}return true},CreateContainer:function(){var k=this.document.createElement(this.tagNames[0]);if(this.cssClass){k.className=this.cssClass}if(this.arStyle){for(var j in this.arStyle){if(this.arStyle.hasOwnProperty(j)){k.style[j]=this.arStyle[j]}}}return k},ApplyToTextNode:function(m){var l=m.parentNode,j;if(l.childNodes.length==1&&BX.util.in_array(l.tagName.toLowerCase(),this.tagNames)){if(this.cssClass){BX.addClass(l,this.cssClass)}if(this.arStyle){for(j in this.arStyle){if(this.arStyle.hasOwnProperty(j)){l.style[j]=this.arStyle[j]}}}}else{if(l.childNodes.length==1){if(this.cssClass&&BX.hasClass(l,this.cssClass)){BX.removeClass(l,this.cssClass)}if(this.arStyle){for(j in this.arStyle){if(this.arStyle.hasOwnProperty(j)&&l.style[j]){l.style[j]=""}}}}var k=this.CreateContainer();m.parentNode.insertBefore(k,m);k.appendChild(m)}},IsRemovable:function(j){return rangy.dom.arrayContains(this.tagNames,j.tagName.toLowerCase())&&BX.util.trim(j.className)==this.cssClass},IsAvailableTextNodeParent:function(j){return j&&j.nodeName&&j.nodeName!=="OL"&&j.nodeName!=="UL"&&j.nodeName!=="MENU"&&j.nodeName!=="TBODY"&&j.nodeName!=="TFOOT"&&j.nodeName!=="THEAD"&&j.nodeName!=="TABLE"&&j.nodeName!=="DL"},UndoToTextNode:function(n,l,j){if(!l.containsNode(j)){var k=l.cloneRange();k.selectNode(j);BX.isParentForNode(j,l.endContainer);if(l.endContainer.nodeName!=="BODY"&&k.isPointInRange(l.endContainer,l.endOffset)&&this.editor.util.IsSplitPoint(l.endContainer,l.endOffset)&&BX.isParentForNode(j,l.endContainer)){this.editor.util.SplitNodeAt(j,l.endContainer,l.endOffset);l.setEndAfter(j)}if(l.startContainer.nodeName!=="BODY"&&k.isPointInRange(l.startContainer,l.startOffset)&&this.editor.util.IsSplitPoint(l.startContainer,l.startOffset)&&BX.isParentForNode(j,l.startContainer)){j=this.editor.util.SplitNodeAt(j,l.startContainer,l.startOffset)}}if(j&&j.nodeName!="BODY"&&this.IsRemovable(j)){if(this.arStyle){for(var m in this.arStyle){if(this.arStyle.hasOwnProperty(m)&&j.style[m]){j.style[m]=""}}}if(!j.style.cssText||BX.util.trim(j.style.cssText)===""){this.editor.util.ReplaceWithOwnChildren(j)}else{if(this.tagNames.length>1||this.tagNames[0]!=="span"){this.editor.util.RenameNode(j,"span")}}}},ApplyToRange:function(l){var o=l.getNodes([3]);if(!o.length){try{var n=this.CreateContainer();l.surroundContents(n);l=this.NormalizeNewNode(n,l);this.SelectNode(l,n);return l}catch(p){}}l.splitBoundaries();o=l.getNodes([3]);if(!o.length&&l.collapsed&&l.startContainer==l.endContainer){var k=this.editor.util.GetInvisibleTextNode();this.editor.selection.InsertNode(k);o=[k]}if(o.length){var q;for(var m=0,j=o.length;m<j;++m){q=o[m];if(!this.GetStyledParent(q)&&this.IsAvailableTextNodeParent(q.parentNode)){this.ApplyToTextNode(q)}}l.setStart(o[0],0);q=o[o.length-1];l.setEnd(q,q.length);if(this.normalize){this.PostApply(o,l)}}return l},UndoToRange:function(n,o){var r=n.getNodes([3]),l,j;o=o!==false;if(r.length){n.splitBoundaries();r=n.getNodes([3])}else{var k=this.editor.util.GetInvisibleTextNode();n.insertNode(k);n.selectNode(k);r=[k]}var m,p,q=[];for(m=0,p=r.length;m<p;m++){q.push({node:r[m],nesting:this.GetNodeNesting(r[m])})}q=q.sort(function(t,s){return s.nesting-t.nesting});for(m=0,p=q.length;m<p;m++){l=q[m].node;j=this.GetStyledParent(l,o);if(j){this.UndoToTextNode(l,n,j);n=this.editor.selection.GetRange()}}if(p==1){this.SelectNode(n,r[0])}else{n.setStart(r[0],0);n.setEnd(r[r.length-1],r[r.length-1].length);this.editor.selection.SetSelection(n);if(this.normalize){this.PostApply(r,n)}}return n},GetNodeNesting:function(j){return this.editor.util.GetNodeDomOffset(j)},SelectNode:function(k,n){var m=n.nodeType===1,j="canHaveHTML" in n?n.canHaveHTML:true,l=m?n.innerHTML:n.data,p=(l===""||l===this.editor.INVISIBLE_SPACE);if(p&&m&&j){try{n.innerHTML=this.editor.INVISIBLE_SPACE}catch(o){}}k.selectNodeContents(n);if(p&&m){k.collapse(false)}else{if(p){k.setStartAfter(n);k.setEndAfter(n)}}},GetTextSelectedByRange:function(n,j){var k=j.cloneRange();k.selectNodeContents(n);var l=k.intersection(j);var m=l?l.toString():"";k.detach();return m},IsAppliedToRange:function(j,n){var k=[],m,o=j.getNodes([3]);n=n!==false;if(!o.length){m=this.GetStyledParent(j.startContainer,n);return m?[m]:false}var l,p;for(l=0;l<o.length;++l){p=this.GetTextSelectedByRange(o[l],j);m=this.GetStyledParent(o[l],n);if(p!=""&&!m){return false}else{k.push(m)}}return k},ToggleRange:function(j){return this.IsAppliedToRange(j)?this.UndoToRange(j):this.ApplyToRange(j)}};function h(j){this.editor=j;this.history=[this.editor.iframeView.GetValue()];this.position=1;this.document=j.sandbox.GetDocument();this.historyLength=30;BX.addCustomEvent(this.editor,"OnIframeReInit",BX.proxy(function(){this.document=this.editor.sandbox.GetDocument()},this));this.Init()}h.prototype={Init:function(){var j=this;BX.addCustomEvent(this.editor,"OnHtmlContentChangedByControl",BX.delegate(this.Transact,this));BX.addCustomEvent(this.editor,"OnIframeNewWord",BX.delegate(this.Transact,this));BX.addCustomEvent(this.editor,"OnIframeKeyup",BX.delegate(this.Transact,this));BX.addCustomEvent(this.editor,"OnBeforeCommandExec",function(k){if(k){j.Transact()}});BX.addCustomEvent(this.editor,"OnIframeKeydown",BX.proxy(this.Keydown,this))},Keydown:function(n,m,o,l){if((n.ctrlKey||n.metaKey)&&!n.altKey){var j=m===this.editor.KEY_CODES.z&&!n.shiftKey,k=(m===this.editor.KEY_CODES.z&&n.shiftKey)||(m===this.editor.KEY_CODES.y);if(j){this.Undo();return BX.PreventDefault(n)}else{if(k){this.Redo();return BX.PreventDefault(n)}}}if(m!==this.lastKey){if(m===this.editor.KEY_CODES.backspace||m===this.editor.KEY_CODES["delete"]){this.Transact()}this.lastKey=m}},Transact:function(){var l=this.history[this.position-1],j=this.editor.iframeView.GetValue();if(j!==l){var k=this.history.length=this.position;if(k>this.historyLength){this.history.shift();this.position--}this.position++;this.history.push(j);this.CheckControls()}},Undo:function(){if(this.position>1){this.Transact();this.position--;this.Set(this.history[this.position-1]);this.editor.On("OnUndo");this.CheckControls()}},Redo:function(){if(this.position<this.history.length){this.position++;this.Set(this.history[this.position-1]);this.editor.On("OnRedo");this.CheckControls()}},Set:function(j){this.editor.iframeView.SetValue(j);this.editor.Focus(true)},CheckControls:function(){this.editor.On("OnEnableUndo",[this.position>1]);this.editor.On("OnEnableRedo",[this.position<this.history.length])}};function a(j){this.editor=j;this.arStyles={};this.sStyles=""}a.prototype={GetIframe:function(j){if(!this.cssIframe){this.cssIframe=this.CreateIframe(j)}return this.cssIframe},CreateIframe:function(j){this.cssIframe=document.body.appendChild(BX.create("IFRAME",{props:{className:"bx-editor-css-iframe"}}));this.iframeDocument=this.cssIframe.contentDocument||this.cssIframe.contentWindow.document;this.iframeDocument.open("text/html","replace");this.iframeDocument.write('<!DOCTYPE html><html><head><style type="text/css" data-bx-template-style="Y">'+j+"</style></head><body></body></html>");this.iframeDocument.close();return this.cssIframe},GetCSS:function(k,s,q,j){if(!this.arStyles[k]){if(!this.cssIframe){this.cssIframe=this.CreateIframe(s)}else{var m,p=this.iframeDocument,o=p.head||p.getElementsByTagName("HEAD")[0],l=o.getElementsByTagName("STYLE");for(m=0;m<l.length;m++){if(l[m].getAttribute("data-bx-template-style")=="Y"){BX.cleanNode(l[m],true)}}if(s){o.appendChild(BX.create("STYLE",{props:{type:"text/css"},text:s},p)).setAttribute("data-bx-template-style","Y")}}this.arStyles[k]=this.ParseCss()}var n=this.arStyles[k];if(j){var r=[],t;if(typeof j!="object"){j=[j]}j.push("DEFAULT");for(m=0;m<j.length;m++){t=j[m];if(n[t]&&typeof n[t]=="object"){r=r.concat(n[t])}}n=r}return n},ParseCss:function(){var y=this.iframeDocument,q=[],A={},z,u,n,t,s,r,w,v,p,o,m;if(!y.styleSheets){return A}var l=y.styleSheets,x=this.editor.GetStylesDescription();for(t=0,p=l.length;t<p;t++){z=(l[t].rules?l[t].rules:l[t].cssRules);for(s=0,o=z.length;s<o;s++){if(z[s].type!=z[s].STYLE_RULE){continue}u=z[s].selectorText;n=u.split(",");for(r=0,m=n.length;r<m;r++){w=n[r].split(" ");w=w[w.length-1].trim();if(w.substr(0,1)=="."){w=w.substr(1);v="DEFAULT"}else{v=w.split(".");w=(v.length>1)?v[1]:"";v=v[0].toUpperCase()}if(!q[w]){q[w]=true;if(!A[v]){A[v]=[]}A[v].push({className:w,classTitle:x[w]||null,original:n[r],cssText:z[s].style.cssText})}}}}return A}};d={classes:{},tags:{b:{clean_empty:true},strong:{clean_empty:true},i:{clean_empty:true},em:{clean_empty:true},u:{clean_empty:true},del:{clean_empty:true},s:{rename_tag:"del"},strike:{rename_tag:"del"},h1:{},h2:{},h3:{},h4:{},h5:{},h6:{},span:{clean_empty:true},p:{},br:{},div:{},hr:{},nobr:{},code:{},section:{},figure:{},figcaption:{},fieldset:{},legend:{},menu:{rename_tag:"ul"},ol:{},ul:{},li:{},pre:{},table:{},tr:{},td:{check_attributes:{rowspan:"numbers",colspan:"numbers"}},tbody:{},tfoot:{},thead:{},th:{check_attributes:{rowspan:"numbers",colspan:"numbers"}},caption:{},col:{},colgroup:{},dl:{rename_tag:""},dd:{rename_tag:""},dt:{rename_tag:""},iframe:{},noindex:{},font:{rename_tag:"span",convert_attributes:{face:"fontFamily",size:"fontSize",color:"color"},replace_with_children:1},embed:{},noembed:{},object:{},param:{},sup:{},sub:{},address:{},nav:{},aside:{},article:{},main:{},acronym:{},abbr:{},label:{},time:{},small:{},big:{},details:{},summary:{},footer:{},video:{},source:{},audio:{},title:{remove:1},area:{remove:1},command:{remove:1},noframes:{remove:1},bgsound:{remove:1},basefont:{remove:1},head:{remove:1},track:{remove:1},wbr:{remove:1},noscript:{remove:1},svg:{remove:1},keygen:{remove:1},meta:{remove:1},isindex:{remove:1},base:{remove:1},canvas:{remove:1},applet:{remove:1},spacer:{remove:1},frame:{remove:1},style:{remove:1},device:{remove:1},xml:{remove:1},nextid:{remove:1},link:{remove:1},script:{remove:1},comment:{remove:1},frameset:{remove:1},multicol:{rename_tag:"div"},map:{rename_tag:"div"},body:{rename_tag:"div"},html:{rename_tag:"div"},hgroup:{rename_tag:"div"},listing:{rename_tag:"div"},header:{rename_tag:"div"},rt:{rename_tag:"span"},xmp:{rename_tag:"span"},bdi:{rename_tag:"span"},progress:{rename_tag:"span"},dfn:{rename_tag:"span"},rb:{rename_tag:"span"},mark:{rename_tag:"span"},output:{rename_tag:"span"},marquee:{rename_tag:"span"},rp:{rename_tag:"span"},"var":{rename_tag:"span"},tt:{rename_tag:"span"},blink:{rename_tag:"span"},plaintext:{rename_tag:"span"},kbd:{rename_tag:"span"},meter:{rename_tag:"span"},datalist:{rename_tag:"span"},samp:{rename_tag:"span"},bdo:{rename_tag:"span"},ruby:{rename_tag:"span"},ins:{rename_tag:"span"},optgroup:{rename_tag:"span"},form:{},option:{},select:{},textarea:{},button:{},input:{},dir:{rename_tag:"ul"},a:{},img:{check_attributes:{width:"numbers",alt:"alt",src:"url",height:"numbers"},add_class:{align:"align_img"}},q:{check_attributes:{cite:"url"}},blockquote:{check_attributes:{cite:"url"}},center:{rename_tag:"div",add_css:{textAlign:"center"}},cite:{}}}})(window);