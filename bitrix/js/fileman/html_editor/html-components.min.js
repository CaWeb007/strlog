(function(){function a(c){this.editor=c;this.phpParser=this.editor.phpParser;this.listLoaded=false;this.components=this.editor.config.components;this.compNameIndex={};this.componentIncludeMethod="$APPLICATION->IncludeComponent";this.requestUrl="/bitrix/admin/fileman_component_params.php";this.HandleList();this.Init()}a.prototype={Init:function(){BX.addCustomEvent(this.editor,"OnSurrogateDblClick",BX.proxy(this.OnComponentDoubleClick,this))},GetList:function(){return this.components},HandleList:function(){if(this.components&&this.components.items){for(var c=0;c<this.components.items.length;c++){this.compNameIndex[this.components.items[c].name]=c}}},IsComponent:function(e){e=this.phpParser.TrimPhpBrackets(e);e=this.phpParser.CleanCode(e);var c=this.phpParser.ParseFunction(e);if(c&&c.name.toUpperCase()==this.componentIncludeMethod.toUpperCase()){var d=this.phpParser.ParseParameters(c.params);return{name:d[0],template:d[1]||"",params:d[2]||{},parentComponent:(d[3]&&d[3]!="={false}")?d[3]:false,exParams:d[4]||false}}return false},IsReady:function(){return this.listLoaded},GetSource:function(s,l){if(!this.arVA){this.arVA={}}var x="<?"+this.componentIncludeMethod+'(\n\t"'+s.name+'",\n\t"'+(s.template||"")+'",\n';if(s.params&&!this.editor.util.IsEmptyObject(s.params)){x+="\tArray(\n";var h=s.params,r=Object.keys(h).sort(),q,n,f,u,o,w="SEF_URL_TEMPLATES_".length,v="VARIABLE_ALIASES_".length,d,t,e,p,g=false;for(n=0;n<r.length;n++){q=r[n];if(!h.hasOwnProperty(q)){continue}if(!g){g=true}if(typeof(h[q])=="string"){h[q]=this.editor.util.stripslashes(h[q])}else{if(typeof(h[q])=="object"){f="array(";u=0;for(o in h[q]){if(h[q].hasOwnProperty(o)&&typeof(h[q][o])=="string"){u++;f+='"'+this.editor.util.stripslashes(h[q][o])+'",'}}if(u>0){f=f.substr(0,f.length-1)+")"}else{f+=")"}h[q]=f}else{continue}}if(h.SEF_MODE&&h.SEF_MODE.toUpperCase()=="Y"){if(q.substr(0,w)=="SEF_URL_TEMPLATES_"){p=q.substr(w);this.arVA[p]=this.CatchVariableAliases(h[q]);if(!d){x+='\t\t"'+q.substr(0,w-1)+'" => Array(\n';d=true}x+='\t\t\t"'+q.substr(w)+'" => ';if(this.IsPHPBracket(h[q])){x+=this.TrimPHPBracket(h[q])}else{x+='"'+this.editor.util.addslashes(h[q])+'"'}x+=",\n";continue}else{if(d){e=x.lastIndexOf(",");x=x.substr(0,e)+x.substr(e+1);d=false;x+="\t\t),\n"}}if(q.substr(0,v)=="VARIABLE_ALIASES_"){continue}}else{if(h.SEF_MODE=="N"){if(q.substr(0,w)=="SEF_URL_TEMPLATES_"||q=="SEF_FOLDER"){continue}if(q.substr(0,v)=="VARIABLE_ALIASES_"){if(!t){x+='\t\t"'+q.substr(0,v-1)+'" => Array(\n';t=true}x+='\t\t\t"'+q.substr(v)+'" => "'+this.editor.util.addslashes(h[q])+'",\n';continue}else{if(t){e=x.lastIndexOf(",");x=x.substr(0,e)+x.substr(e+1);t=false;x+="\t\t),\n"}}}}x+='\t\t"'+q+'" => ';if(this.IsPHPBracket(h[q])){x+=this.TrimPHPBracket(h[q])}else{if(h[q].substr(0,6).toLowerCase()=="array("){x+=h[q]}else{x+='"'+this.editor.util.addslashes(h[q])+'"'}}x+=",\n"}if(t||d){e=x.lastIndexOf(",");x=x.substr(0,e)+x.substr(e+1);x+="\t\t),\n"}if(g){e=x.lastIndexOf(",");x=x.substr(0,e)+x.substr(e+1)}x+="\t)"}else{x+="Array()";if(this.lastDroppedName==s.name&&l){var m=this.editor.GetBxTag(l);if(m&&m.surrogateId){this.ShowPropertiesDialog(m.params,this.editor.GetBxTag(m.surrogateId))}}}if(s.parentComponent!==false||s.exParams!==false){var c=s.parentComponent;if(!c||c.toLowerCase()=="={false}"){x+=",\nfalse"}else{if(this.IsPHPBracket(c)){x+=",\n"+this.TrimPHPBracket(c)}else{x+=",\n'"+c+"'"}}if(s.exParams!==false&&typeof s.exParams=="object"){x+=",\nArray(";for(q in s.exParams){if(s.exParams.hasOwnProperty(q)&&typeof(s.exParams[q])=="string"){x+="\n\t'"+q+"' => '"+this.editor.util.stripslashes(s.exParams[q])+"',"}}if(x.substr(x.length-1)==","){x=x.substr(0,x.length-1)+"\n"}x+=")"}}x+="\n);?>";return x},GetOnDropHtml:function(d){var c={name:d.name};this.lastDroppedName=d.name;return this.GetSource(c)},CatchVariableAliases:function(g){var f=[],d,e,c=g.match(/(\?|&)(.+?)=#([^#]+?)#/ig);if(!c){return f}for(d=0;d<c.length;d++){e=c[d].match(/(\?|&)(.+?)=#([^#]+?)#/i);f[e[3]]=e[2]}return f},LoadParamsList:function(c){oBXComponentParamsManager.LoadComponentParams({name:c.name,parent:false,template:"",exParams:false,currentValues:{}})},GetComponentData:function(c){var d=this.components.items[this.compNameIndex[c]];return d||{}},IsPHPBracket:function(c){return c.substr(0,2)=="={"},TrimPHPBracket:function(c){return c.substr(2,c.length-3)},OnComponentDoubleClick:function(d,c,g,f){if(c&&c.tag=="component"){this.ShowPropertiesDialog(c.params,d)}},ShowPropertiesDialog:function(e,f){var c=BX.clone(e,1);if(!this.oPropertiesDialog){this.oPropertiesDialog=this.editor.GetDialog("componentProperties",{oBXComponentParamsManager:oBXComponentParamsManager});BX.addCustomEvent(this.oPropertiesDialog,"OnDialogSave",BX.proxy(this.SavePropertiesDialog,this));BX.addCustomEvent(this.oPropertiesDialog.oDialog,"onWindowUnRegister",BX.proxy(this.OnDialogClose,this))}this.currentViewedComponentTag=f;this.oPropertiesDialog.SetTitle(BX.message("ComponentPropsTitle").replace("#COMPONENT_NAME#",c.name));this.oPropertiesDialog.SetContent('<span class="bxcompprop-wait-notice">'+BX.message("ComponentPropsWait")+"</span>");this.oPropertiesDialog.Show();if(this.oPropertiesDialog.oDialog.PARTS.CONTENT_DATA){BX.addClass(this.oPropertiesDialog.oDialog.PARTS.CONTENT_DATA,"bxcompprop-outer-wrap")}var g=this;var d=BX.create("DIV");BX.onCustomEvent(oBXComponentParamsManager,"OnComponentParamsDisplay",[{name:c.name,parent:!!c.parentComponent,template:c.template,exParams:c.exParams,currentValues:c.params,container:d,siteTemplate:this.editor.GetTemplateId(),relPath:this.editor.config.relPath,callback:function(i,h){g.PropertiesDialogCallback(i,h)}}])},PropertiesDialogCallback:function(e,c){if(this.oPropertiesDialog.oDialog.PARTS.CONTENT_DATA){BX.addClass(this.oPropertiesDialog.oDialog.PARTS.CONTENT_DATA,"bxcompprop-outer-wrap")}this.oPropertiesDialog.SetContent(c);var d=this.oPropertiesDialog.GetContentSize();BX.onCustomEvent(oBXComponentParamsManager,"OnComponentParamsResize",[d.width,d.height])},SavePropertiesDialog:function(){var f=this.currentViewedComponentTag,c=this.editor.GetBxTag(f.params.origId),d=oBXComponentParamsManager.GetParamsValues(),e=oBXComponentParamsManager.GetTemplateValue();f.params.origParams.params=c.params.params=d;f.params.origParams.template=c.params.template=e;this.editor.synchro.FullSyncFromIframe();this.lastDroppedName=""},OnDialogClose:function(){if(this.editor.util.IsEmptyObject(this.currentViewedComponentTag.params.origParams.params)&&this.lastDroppedName){this.SavePropertiesDialog()}},ReloadList:function(){var c=this;this.editor.Request({getData:this.editor.GetReqData("load_components_list",{site_template:this.editor.GetTemplateId(),componentFilter:this.editor.GetComponentFilter(),site:this.editor.GetSiteId()}),handler:function(d){c.components=c.editor.config.components=d;c.HandleList();c.editor.componentsTaskbar.BuildTree(c.components.groups,c.components.items)}})},SetComponentIcludeMethod:function(c){this.componentIncludeMethod=c}};function b(){window.BXHtmlEditor.BXEditorComponents=a;function c(d,e){e=e||{};e.id="bx_component_properties";e.height=600;e.width=800;e.resizable=true;this.oBXComponentParamsManager=e.oBXComponentParamsManager;this.id="components_properties";c.superclass.constructor.apply(this,[d,e]);BX.addClass(this.oDialog.DIV,"bxcompprop-dialog");BX.addCustomEvent(this,"OnDialogSave",BX.proxy(this.Save,this))}BX.extend(c,window.BXHtmlEditor.Dialog);c.prototype.OnResize=function(){var d=this.oDialog.PARTS.CONTENT_DATA.offsetWidth,e=this.oDialog.PARTS.CONTENT_DATA.offsetHeight;BX.onCustomEvent(this.oBXComponentParamsManager,"OnComponentParamsResize",[d,e])};c.prototype.OnResizeFinished=function(){};window.BXHtmlEditor.dialogs.componentProperties=c}if(window.BXHtmlEditor&&window.BXHtmlEditor.dialogs){b()}else{BX.addCustomEvent(window,"OnEditorBaseControlsDefined",b)}})();