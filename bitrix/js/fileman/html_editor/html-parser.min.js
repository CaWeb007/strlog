(function(){function d(f){this.editor=f;this.specialParsers={};this.DEFAULT_NODE_NAME="span",this.WHITE_SPACE_REG_EXP=/\s+/,this.defaultRules={tags:{},classes:{}};this.convertedBxNodes=[];this.rules={};if(!this.editor.util.FirstLetterSupported()){this.firstNodeCheck=false;this.FIRST_LETTER_CLASS="bxe-first-letter";this.FIRST_LETTER_CLASS_CHROME="bxe-first-letter-chrome";this.FIRST_LETTER_SPAN="bxe-first-letter-s"}}d.prototype={Parse:function(j,o,m,h,i){if(!m){m=document}this.convertedBxNodes=[];this.firstNodeCheck=false;var p=m.createDocumentFragment(),g=this.GetAsDomElement(j,m),n,f,k;this.SetParseBxMode(i);this.pasteNodeIndexTmp=BX.clone(this.editor.pasteNodeIndex);while(g.firstChild){k=g.firstChild;g.removeChild(k);n=this.Convert(k,h,i,n);if(n){f=!i&&this.CheckBlockNode(n);if(f){}p.appendChild(n);if(f){p.appendChild(this.editor.util.GetInvisibleTextNode())}}}g.innerHTML="";g.appendChild(p);j=this.editor.GetInnerHtml(g);j=this.RegexpContentParse(j,i);return j},SetParseBxMode:function(f){this.bParseBx=!!f},CodeParse:function(f){return f},GetAsDomElement:function(f,i){if(!i){i=document}var g=i.createElement("DIV");if(typeof(f)==="object"&&f.nodeType){g.appendChild(f)}else{if(this.editor.util.CheckHTML5Support()){g.innerHTML=f}else{if(this.editor.util.CheckHTML5FullSupport()){g.style.display="none";i.body.appendChild(g);try{g.innerHTML=f}catch(h){}i.body.removeChild(g)}}}return g},Convert:function(k,j,m,g){var s=false,r=k.nodeType,q=k.childNodes,t,o,n,h;if(r==1){if(k.nodeName=="IMG"){if(!k.getAttribute("data-bx-orig-src")){k.setAttribute("data-bx-orig-src",k.getAttribute("src"))}else{k.setAttribute("src",k.getAttribute("data-bx-orig-src"))}}if(this.editor.pasteHandleMode&&(m||this.editor.bbParseContentMode)){if(k.id=="bx-cursor-node"){return k.ownerDocument.createTextNode(this.editor.INVISIBLE_CURSOR)}var f=k.getAttribute("data-bx-paste-flag");s=f!=="Y"&&!this.pasteNodeIndexTmp[f];if(k&&k.id){h=this.editor.GetBxTag(k.id);if(h.tag){s=false}}if(s){k=this.CleanNodeAfterPaste(k,g);if(!k){return null}q=k.childNodes;r=k.nodeType}k.removeAttribute("data-bx-paste-flag");if(this.pasteNodeIndexTmp[f]){delete this.pasteNodeIndexTmp[f]}}else{if(k.id=="bx-cursor-node"){return k.cloneNode(true)}}if(r==1){if(!k.__bxparsed){if(this.IsAnchor(k)&&!k.getAttribute("data-bx-replace_with_children")){t=k.cloneNode(true);t.innerHTML="";o=null;for(n=0;n<q.length;n++){o=this.Convert(q[n],j,m,o);if(o){t.appendChild(o)}}var p={};for(n=0;n<t.attributes.length;n++){if(t.attributes[n].name!=="name"){p[t.attributes[n].name]=t.attributes[n].value}}k=this.editor.phpParser.GetSurrogateNode("anchor",BX.message("BXEdAnchor")+": #"+t.name,null,{html:t.innerHTML,name:t.name,attributes:p})}else{if(this.IsPrintBreak(k)){k=this.GetPrintBreakSurrogate(k)}}if(k&&k.id){h=this.editor.GetBxTag(k.id);if(h.tag){k.__bxparsed=1;if(this.bParseBx){t=k.ownerDocument.createTextNode("~"+h.id+"~");this.convertedBxNodes.push(h)}else{t=k.cloneNode(true)}return t}}if(!t&&k.nodeType){t=this.ConvertElement(k,m)}}}}else{if(r==3){t=this.HandleText(k)}}if(!t){return null}for(n=0;n<q.length;n++){o=this.Convert(q[n],j,m);if(o){t.appendChild(o)}}if(t.nodeType==1){if(t.style&&BX.util.trim(t.style.cssText)==""&&t.removeAttribute){t.removeAttribute("style")}if(this.editor.config.cleanEmptySpans&&j&&t.childNodes.length<=1&&t.nodeName.toLowerCase()===this.DEFAULT_NODE_NAME&&!t.attributes.length){return t.firstChild}}return t},ConvertElement:function(h,k){var n,m,p,q,r,f=this.editor.GetParseRules().tags,o=h.nodeName.toLowerCase(),g=h.scopeName;if(h.__bxparsed){return null}h.__bxparsed=1;if(h.className==="bx-editor-temp"){return null}if(g&&g!="HTML"){o=g+":"+o}if("outerHTML" in h&&!this.editor.util.AutoCloseTagSupported()&&h.nodeName==="P"&&h.outerHTML.slice(-4).toLowerCase()!=="</p>"){o="div"}if(!this.editor.util.FirstLetterSupported()&&h.className){if(h.className==this.FIRST_LETTER_CLASS&&!this.bParseBx){this.HandleFirstLetterNode(h)}else{if(h.className==this.FIRST_LETTER_CLASS_CHROME&&this.bParseBx){this.HandleFirstLetterNodeBack(h)}}}if(o=="table"&&!this.bParseBx){var j=parseInt(h.getAttribute("border"),10);if(!j){h.removeAttribute("border");h.setAttribute("data-bx-no-border","Y")}}if(o in f){n=f[o];if(!n||n.remove){return null}if(n.clean_empty&&(h.innerHTML===""||h.innerHTML===this.editor.INVISIBLE_SPACE)&&(!h.className||h.className=="")&&(!this.editor.lastCreatedId||this.editor.lastCreatedId!=h.getAttribute("data-bx-last-created-id"))){return null}n=typeof(n)==="string"?{rename_tag:n}:n;r=h.getAttribute("data-bx-new-rule");if(r){n[r]=h.getAttribute("data-bx-"+r)}}else{if(h.firstChild){n={rename_tag:this.DEFAULT_NODE_NAME}}else{return null}}if(n.convert_attributes&&k==false){for(m in n.convert_attributes){if(n.convert_attributes.hasOwnProperty(m)&&h.getAttribute(m)){p=this.ConvertAttributeValueToCss(m,n.convert_attributes[m],h.getAttribute(m));if(p!==false){n.replace_with_children=false;h.style[n.convert_attributes[m]]=p}h.removeAttribute(m)}}}if(n.replace_with_children){q=h.ownerDocument.createDocumentFragment()}else{q=h.ownerDocument.createElement(n.rename_tag||o);this.HandleAttributes(h,q,n,k)}if(r){n[r]=null;delete n[r]}if((!q.className||q.className=="")&&q.removeAttribute){q.removeAttribute("class")}h=null;return q},CleanNodeAfterPaste:function(k,h){var g,n,s=k.nodeName,j=k.innerHTML,p=BX.util.trim(j),m={align:1,alt:1,bgcolor:1,border:1,cellpadding:1,cellspacing:1,color:1,colspan:1,height:1,href:1,rowspan:1,size:1,span:1,src:1,style:1,target:1,title:1,type:1,value:1,width:1},f={B:1,STRONG:1,I:1,EM:1,U:1,DEL:1,S:1,STRIKE:1},t={A:1,SPAN:1,B:1,STRONG:1,I:1,EM:1,U:1,DEL:1,S:1,STRIKE:1,H1:1,H2:1,H3:1,H4:1,H5:1,H6:1,ABBR:1,TIME:1,FIGURE:1,FIGCAPTION:1};if(s=="IFRAME"){return null}if(k.style.display=="none"||k.style.visibility=="hidden"){return null}if(t[s]&&j==""){return null}var r=k.getAttribute("data-bx-clean-attribute");if(r){k.removeAttribute(r);k.removeAttribute("data-bx-clean-attribute")}if(s=="IMG"){var o=k.getAttribute("alt");if(o===""){k.removeAttribute("alt")}else{if(typeof o=="string"&&o!==""&&o.indexOf("://")!==-1){this.CheckAltImage(k)}}k.removeAttribute("class");this.CleanNodeCss(k);return k}if(s=="A"&&(p==""||p=="&nbsp;")){return null}if(s=="A"){}k.removeAttribute("class");k.removeAttribute("id");n=0;while(n<k.attributes.length){g=k.attributes[n].name;if(!m[g]||k.attributes[n].value==""){k.removeAttribute(g)}else{n++}}if(s=="THEAD"){var q=k.getElementsByTagName("TR"),u;for(n=0;n<q.length;n++){if(q[n]&&q[n].getAttribute){u=q[n].getAttribute("style");if(u&&u.indexOf("mso-yfti-irow")!==-1&&u.indexOf("mso-yfti-irow:0")===-1&&u.indexOf("mso-yfti-irow:-1")===-1&&u.indexOf("mso-yfti-firstrow:yes")===-1){k.setAttribute("data-bx-new-rule","rename_tag");k.setAttribute("data-bx-rename_tag","TBODY");break}}}}if(s=="DIV"||k.style.display=="block"||s=="FORM"){if(!k.lastChild||(k.lastChild&&k.lastChild.nodeName!="BR")){k.appendChild(k.ownerDocument.createElement("BR")).setAttribute("data-bx-paste-flag","Y")}if(h&&typeof h=="object"&&h.nodeType==3&&k.firstChild){k.insertBefore(k.ownerDocument.createElement("BR"),k.firstChild).setAttribute("data-bx-paste-flag","Y")}k.setAttribute("data-bx-new-rule","replace_with_children");k.setAttribute("data-bx-replace_with_children","1")}if(s=="B"&&k.style.fontWeight=="normal"){k.setAttribute("data-bx-new-rule","replace_with_children");k.setAttribute("data-bx-replace_with_children","1")}if(f[s]&&this.editor.config.pasteSetDecor){k.setAttribute("data-bx-new-rule","replace_with_children");k.setAttribute("data-bx-replace_with_children","1")}if(f[s]&&this.editor.config.pasteSetDecor){k.setAttribute("data-bx-new-rule","replace_with_children");k.setAttribute("data-bx-replace_with_children","1")}if(this.IsAnchor(k)&&(k.name==""||BX.util.trim(k.name==""))){k.setAttribute("data-bx-new-rule","replace_with_children");k.setAttribute("data-bx-replace_with_children","1")}if(BX.util.in_array(s,this.editor.TABLE_TAGS)&&this.editor.config.pasteClearTableDimen){k.removeAttribute("width");k.removeAttribute("height")}this.CleanNodeCss(k);if(s=="SPAN"&&k.style.cssText==""){k.setAttribute("data-bx-new-rule","replace_with_children");k.setAttribute("data-bx-replace_with_children","1")}if((s=="P"||s=="SPAN"||s=="FONT")&&BX.util.trim(k.innerHTML)=="&nbsp;"){k.innerHTML=" "}return k},CleanNodeCss:function(o){var n,h,m,f,k,p=o.nodeName,g={width:["auto"],height:["auto"]};if(BX.util.in_array(p,this.editor.TABLE_TAGS)&&this.editor.config.pasteClearTableDimen){g={}}if(!this.editor.config.pasteSetColors){g.color=["#000000","#000","black"];g["background-color"]=["transparent","#fff","#ffffff","white"];g.background=1}if(!this.editor.config.pasteSetBorders){g["border-collapse"]=1;g["border-color"]=["transparent","#fff","#ffffff","white"];g["border-style"]=["none","hidden"];g["border-top"]=["0px","0"];g["border-right"]=["0px","0"];g["border-bottom"]=["0px","0"];g["border-left"]=["0px","0"];g["border-top-color"]=["transparent","#fff","#ffffff","white"];g["border-right-color"]=["transparent","#fff","#ffffff","white"];g["border-bottom-color"]=["transparent","#fff","#ffffff","white"];g["border-left-color"]=["transparent","#fff","#ffffff","white"];g["border-top-style"]=["none","hidden"];g["border-right-style"]=["none","hidden"];g["border-bottom-style"]=["none","hidden"];g["border-left-style"]=["none","hidden"];g["border-top-width"]=["0px","0"];g["border-right-width"]=["0px","0"];g["border-bottom-width"]=["0px","0"];g["border-left-width"]=["0px","0"];g["border-width"]=["0px","0"];g.border=["0px","0"]}if(!this.editor.config.pasteSetDecor){g["font-style"]=["normal"];g["font-weight"]=["normal"];g["text-decoration"]=["none"]}if(o.style&&BX.util.trim(o.style.cssText)!=""&&p!=="BR"){n=[];for(k in o.style){if(o.style.hasOwnProperty(k)){if(parseInt(k).toString()===k){m=o.style[k];f=o.style.getPropertyValue(m)}else{m=k;f=o.style.getPropertyValue(m)}if(f===null){continue}if(!g[m]||f.match(/^-(moz|webkit|ms|o)/ig)||f=="inherit"||f=="initial"||(m=="color"&&p=="A")||((p=="SPAN"||p=="P")&&(m=="width"||m=="height"))||(typeof g[m]=="object"&&BX.util.in_array(f.toLowerCase(),g[m]))){continue}if(m.indexOf("color")!==-1){f=this.editor.util.RgbToHex(f);if((typeof g[m]=="object"&&BX.util.in_array(f.toLowerCase(),g[m]))||f=="transparent"){continue}}if(m.indexOf("border")!==-1&&f.indexOf("none")!==-1){continue}n.push({name:m,value:f})}}o.removeAttribute("style");if(n.length>0){for(h=0;h<n.length;h++){o.style[n[h].name]=n[h].value}}}else{o.removeAttribute("style")}},CheckAltImage:function(h){var j=this.editor.GetIframeDoc();function g(m){var k,n=j.getElementsByTagName("IMG");for(k=0;k<n.length;k++){if(n[k].src===m){return n[k]}}}function i(){if(h.src===h.alt&&h.getAttribute("data-bx-orig-src")!==h.src){h.setAttribute("data-bx-orig-src",h.getAttribute("src"))}BX.unbind(h,"load",i);BX.unbind(h,"error",f)}function f(){var m=h.getAttribute("alt"),k=g(h.src);if(!k){BX.unbind(h,"load",i);BX.unbind(h,"error",f);return}if(h.getAttribute("src")!==h.alt){k.setAttribute("src",m)}else{k.setAttribute("src",h.getAttribute("data-bx-orig-src"));BX.unbind(h,"load",i);BX.unbind(h,"error",f)}}BX.bind(h,"load",i);BX.bind(h,"error",f)},HandleText:function(f){var g=f.data;if(this.editor.pasteHandleMode&&g.indexOf("EndFragment:")!==-1){g=g.replace(/Version:\d\.\d(?:\s|\S)*?StartHTML:\d+(?:\s|\S)*?EndHTML:\d+(?:\s|\S)*?StartFragment:\d+(?:\s|\S)*?EndFragment:\d+(?:\s|\n|\t|\r)*/g,"")}return f.ownerDocument.createTextNode(g)},HandleAttributes:function(A,g,q,F){var s={},J=q.set_class,v=q.add_class,h=q.add_css,D=q.set_attributes,p=q.check_attributes,k=q.clear_attributes,o=this.editor.GetParseRules().classes,C=0,u,K={},z,G=[],I=[],m=[],B=[],n,t,j,r,w,y,H,f;if(p){for(y in p){f=this.GetCheckAttributeHandler(p[y]);if(!f){continue}H=f(this.GetAttributeEx(A,y));if(typeof(H)==="string"&&H!==""){s[y]=H}}}var x=A.getAttribute("data-bx-clean-attribute");if(x){A.removeAttribute(x);A.removeAttribute("data-bx-clean-attribute")}if(!k){for(C=0;C<A.attributes.length;C++){w=A.attributes[C];if(F){if(w.name.substr(0,15)=="data-bx-app-ex-"){u=w.name.substr(15);s[u]=A.getAttribute(w.name);K[u]=true}if(K[w.name]){continue}}if(w.name.substr(0,8)=="data-bx-"&&w.name!="data-bx-noindex"&&this.bParseBx){continue}s[w.name]=this.GetAttributeEx(A,w.name)}}if(J){G.push(J)}if(h){for(z in h){if(h.hasOwnProperty(z)){g.style[z]=h[z]}}}B=A.getAttribute("class");if(B){G=G.concat(B.split(this.WHITE_SPACE_REG_EXP))}n=G.length;for(;C<n;C++){j=G[C];if(o[j]){I.push(j)}}if(m.length){s["class"]=m.join(" ")}for(y in s){try{g.setAttribute(y,s[y])}catch(E){}}if(s.src){if(typeof(s.width)!=="undefined"){g.setAttribute("width",s.width)}if(typeof(s.height)!=="undefined"){g.setAttribute("height",s.height)}}},ConvertAttributeValueToCss:function(h,f,i){if(h=="size"&&f=="fontSize"){var g={1:"9px",2:"13px",3:"16px",4:"18px",5:"24px",6:"32px",7:"48px"};if(g[i]){i=g[i]}else{if(i<1){i=false}else{if(i>7){i=g[7]}}}}return i},GetAttributeEx:function(i,g){g=g.toLowerCase();var h,k=i.nodeName;if(k=="IMG"&&g=="src"&&this.IsLoadedImage(i)===true){h=i.getAttribute("src")}else{if(!this.editor.util.CheckGetAttributeTruth()&&"outerHTML" in i){var j=i.outerHTML.toLowerCase(),f=j.indexOf(" "+g+"=")!=-1;h=f?i.getAttribute(g):null}else{h=i.getAttribute(g)}}return h},IsLoadedImage:function(f){try{return f.complete&&!f.mozMatchesSelector(":-moz-broken")}catch(g){if(f.complete&&f.readyState==="complete"){return true}}return false},GetCheckAttributeHandler:function(g){var f=this.GetCheckAttributeHandlers();return f[g]},GetCheckAttributeHandlers:function(){return{url:function(f){return f},alt:function(f){if(!f){return""}return f.replace(/[^ a-z0-9_\-]/gi,"")},numbers:function(f){f=(f||"").replace(/\D/g,"");return f||null}}},HandleBitrixNode:function(f){return f},RegexpContentParse:function(g,f){if(g.indexOf("rgb")!==-1){g=g.replace(/rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+))?\)/ig,function(o,m,k,j,i){function n(p){return("0"+parseInt(p).toString(16)).slice(-2)}return"#"+n(m)+n(k)+n(j)})}if(f&&g.indexOf("data-bx-noindex")!==-1){g=g.replace(/(<a[^<]*?)data\-bx\-noindex="Y"([\s\S]*?>[\s\S]*?\/a>)/ig,function(k,j,i){return"<!--noindex-->"+j+i+"<!--/noindex-->"})}if(f){g=g.replace(/\uFEFF/ig,"")}else{g=g.replace(/\uFEFF+/ig,this.editor.INVISIBLE_SPACE)}if(f&&g.indexOf("#BXAPP")!==-1){var h=this;g=g.replace(/#BXAPP(\d+)#/g,function(j,i){i=parseInt(i,10);return h.editor.phpParser.AdvancedPhpGetFragmentByIndex(i,true)})}return g},IsAnchor:function(f){return f.nodeName=="A"&&!f.href},IsPrintBreak:function(f){return f.style.pageBreakAfter=="always"},GetPrintBreakSurrogate:function(f){var g=this.editor.GetIframeDoc(),h=this.editor.SetBxTag(false,{tag:"printbreak",params:{innerHTML:BX.util.trim(f.innerHTML)},name:BX.message("BXEdPrintBreakName"),title:BX.message("BXEdPrintBreakTitle")});return BX.create("IMG",{props:{src:this.editor.EMPTY_IMAGE_SRC,id:h,className:"bxhtmled-printbreak",title:BX.message("BXEdPrintBreakTitle")}},g)},CheckBlockNode:function(f){return this.editor.phpParser.IsSurrogate(f)||(f.nodeType==1&&(f.style.display=="block"||f.style.display=="inline-block"||f.nodeName=="BLOCKQUOTE"||f.nodeName=="DIV"))},HandleFirstLetterNode:function(h){this.firstNodeCheck=true;h.className=this.FIRST_LETTER_CLASS_CHROME;var i=true,j=this.editor.GetIframeDoc(),g,m,k=this._GetFlTextNode(h),f=this._GetFlSpan(h);if(k){g=BX.util.trim(this.editor.util.GetTextContent(k));if(f){this._FLCleanNodesBeforeFirstSpan(f);m=BX.util.trim(this.editor.util.GetTextContent(f));if(g.substr(0,1)==m&&m.length==1){i=false}else{if(g==m&&m.length>1){i=false;this.editor.SetCursorNode();this.editor.util.InsertAfter(j.createTextNode(g.substr(1)),f);this.editor.RestoreCursor();f.innerHTML=g.substr(0,1)}}this._FLCleanNodesBeforeFirstSpan(f)}if(i){if(f){this.editor.SetCursorNode();this.editor.util.ReplaceWithOwnChildren(f);this.editor.RestoreCursor()}f=BX.create("SPAN",{props:{className:this.FIRST_LETTER_SPAN},text:g.substr(0,1)},h.ownerDocument);this.editor.util.SetTextContent(k,g.substr(1));k.parentNode.insertBefore(f,k);this._FLCleanNodesBeforeFirstSpan(f)}this._FLCleanBogusSpans(h)}},HandleFirstLetterNodeBack:function(g){this.firstNodeCheck=true;g.className=this.FIRST_LETTER_CLASS;var f=this._GetFlSpan(g);if(f){this.editor.util.ReplaceWithOwnChildren(f)}},_GetFlSpan:function(f){return BX.findChild(f,{className:this.FIRST_LETTER_SPAN},1)},_GetFlTextNode:function(h){if(h.innerHTML==""||!h.firstChild){return null}if(h.firstChild&&h.firstChild.nodeType==3&&h.firstChild.nodeValue&&BX.util.trim(h.firstChild.nodeValue)!==""){return h.firstChild}var g=0,i=this,f=h;while(g++<=100){f=BX.findChild(f,function(j){return(BX.util.trim(i.editor.util.GetTextContent(j))!=="")},false);if(f.nodeType==3&&f.nodeValue&&BX.util.trim(f.nodeValue)!==""){return f}}return null},FirstLetterCheckNodes:function(k,f,p){var n=this.editor.GetIframeDoc(),g;if(this.firstNodeCheck||k.indexOf(this.FIRST_LETTER_CLASS)!==-1||p===true){var h,o=n.querySelectorAll("."+this.FIRST_LETTER_CLASS),m=n.querySelectorAll("."+this.FIRST_LETTER_CLASS_CHROME);for(g=0;g<m.length;g++){h=BX.util.trim(m[g].innerHTML);if(h==""||h=="<br>"){BX.remove(m[g]);continue}this.HandleFirstLetterNode(m[g])}for(g=0;g<o.length;g++){this.HandleFirstLetterNode(o[g])}this.firstNodeCheck=!!(o.length||m.length)}if(!this.firstNodeCheck&&k.indexOf(this.FIRST_LETTER_SPAN)!==-1){var j=n.querySelectorAll("."+this.FIRST_LETTER_SPAN);for(g=0;g<j.length;g++){this.editor.util.ReplaceWithOwnChildren(j[g])}}},_FLCleanNodesBeforeFirstSpan:function(f){while(f.previousSibling){BX.remove(f.previousSibling)}},_FLCleanBogusSpans:function(h){var g,f=h.getElementsByTagName("SPAN");for(g=f.length-1;g>=0;g--){if(!f[g].className&&f[g].style.lineHeight&&f[g].style.fontSize){this.editor.util.ReplaceWithOwnChildren(f[g])}}},FirstLetterBackspaceHandler:function(g){if(g.collapsed&&g.startOffset==0){var f=g.startContainer.previousSibling;if(f&&f.className.indexOf(this.FIRST_LETTER_SPAN)!==-1){this.editor.selection.SetAfter(f.lastChild)}}}};function c(f){this.PHP_PATTERN="#BXPHP_IND#";this.editor=f;this.allowed={php:this.editor.allowPhp||this.editor.lpa,javascript:true,style:true,htmlcomment:true,iframe:true,video:true,audio:true,object:true};this.bUseAPP=true;this.APPConfig={arTags_before:["tbody","thead","tfoot","tr","td","th"],arTags_after:["tbody","thead","tfoot","tr","td","th"],arTags:{a:["href","title","class","style"],img:["src","alt","class","style","width","height"],input:["id","name","value"]}};this.customParsers=[];this.arScripts={};this.arJavascripts={};this.arHtmlComments={};this.arIframes={};this.arVideos={};this.arAudio={};this.arStyles={};this.arObjects={};this.surrClass="bxhtmled-surrogate";this.surrogateTags={component:1,php:1,javascript:1,style:1,htmlcomment:1,anchor:1,iframe:1,video:1,audio:1,object:1};BX.addCustomEvent(this.editor,"OnIframeMouseDown",BX.proxy(this.OnSurrogateMousedown,this));BX.addCustomEvent(this.editor,"OnIframeDblClick",BX.proxy(this.OnSurrogateDblClick,this));BX.addCustomEvent(this.editor,"OnIframeKeydown",BX.proxy(this.OnSurrogateKeydown,this));BX.addCustomEvent(this.editor,"OnAfterCommandExec",BX.proxy(this.RenewSurrogates,this))}c.prototype={ParsePhp:function(f){var g=this;if(this.IsAllowed("php")){f=this.ReplacePhpBySymCode(f)}else{f=this.CleanPhp(f)}f=this.CustomContentParse(f);f=this.ReplaceJavascriptBySymCode(f);f=this.ReplaceHtmlCommentsBySymCode(f);f=this.ReplaceIframeBySymCode(f);f=this.ReplaceAudioBySymCode(f);f=this.ReplaceStyleBySymCode(f);f=this.ReplaceObjectBySymCode(f);f=this.ParseBreak(f);f=this.AdvancedPhpParse(f);f=this.ParseSymCode(f);if(this.editor.lpa){f=f.replace(/#PHP(\d+)#/g,function(h){return g.GetSurrogateHTML("php_protected",BX.message("BXEdPhpCode")+" *",BX.message("BXEdPhpCodeProtected"),{value:h})})}return f},ReplacePhpBySymCode:function(v,f){var t=[],k=0,r,o,w,g,n,h,s,q=0;f=f===true;while((k=v.indexOf("<?",k))>=0){q=0;r=k+1;o=false;w=false;while(r<v.length-1){r++;g=v.substr(r,1);if(!w){if(g=="/"&&r+1<v.length){n=v.indexOf("?>",r);if(n==-1){k=v.length;break}n+=2;h=0;if(v.substr(r+1,1)=="*"&&(h=v.indexOf("*/",r+2))>=0){h+=2}else{if(v.substr(r+1,1)=="/"&&(h=v.indexOf("\n",r+2))>=0){h+=1}}if(h>0){if(h>n&&v.substr(r+1,1)!="*"){t.push([k,n,v.substr(k,n-k)]);k=n;break}else{r=h-1}}continue}if(g=="?"&&r+1<v.length&&v.substr(r+1,1)==">"){r=r+2;t.push([k,r,v.substr(k,r-k)]);k=r+1;break}}if(w&&g=="\\"){o=true;continue}if(g=='"'||g=="'"){if(w){if(!o&&s==g){w=false}}else{w=true;s=g}}o=false}if(r>=v.length){break}k=r}this.arScripts={};if(t.length>0){var u="",j=0,m;if(f){for(r=0;r<t.length;r++){m=t[r];u+=v.substr(j,m[0]-j);j=m[1]}}else{for(r=0;r<t.length;r++){m=t[r];u+=v.substr(j,m[0]-j)+this.SavePhpCode(m[2],r);j=m[1]}}v=u+v.substr(j)}return v},CleanPhp:function(f){return this.ReplacePhpBySymCode(f,true)},ReplaceJavascriptBySymCode:function(g){this.arJavascripts={};var h=this,f=0;g=g.replace(/<script[\s\S]*?\/script>/gi,function(i){h.arJavascripts[f]=i;var j=h.GetPattern(f,false,"javascript");f++;return j});return g},ReplaceHtmlCommentsBySymCode:function(g){this.arHtmlComments={};var h=this,f=0;g=g.replace(/(<!--noindex-->)(?:[\s|\n|\r|\t]*?)<a([\s\S]*?)\/a>(?:[\s|\n|\r|\t]*?)(<!--\/noindex-->)/ig,function(m,k,j,i){return'<a data-bx-noindex="Y"'+j+"/a>"});g=g.replace(/<!--[\s\S]*?-->/ig,function(i){h.arHtmlComments[f]=i;return h.GetPattern(f++,false,"html_comment")});return g},ReplaceIframeBySymCode:function(g){this.arIframes={};var h=this,f=0;g=g.replace(/<iframe([\s\S]*?)\/iframe>/gi,function(j,i){var k=h.CheckForVideo(i);if(k){h.arVideos[f]={html:j,provider:k.provider||false,src:k.src||false};return h.GetPattern(f++,false,"video")}else{h.arIframes[f]=j;return h.GetPattern(f++,false,"iframe")}});return g},ReplaceStyleBySymCode:function(g){this.arStyles={};var h=this,f=0;g=g.replace(/<style[\s\S]*?\/style>/gi,function(i){h.arStyles[f]=i;return h.GetPattern(f++,false,"style")});return g},ReplaceAudioBySymCode:function(g){this.arAudio={};var h=this,f=0;g=g.replace(/<audio[\s\S]*?\/audio>/gi,function(i){h.arAudio[f]=i;return h.GetPattern(f++,false,"audio")});return g},ReplaceObjectBySymCode:function(g){this.arObjects={};var h=this,f=0;g=g.replace(/<object[\s\S]*?\/object>/gi,function(i){h.arObjects[f]=i;return h.GetPattern(f++,false,"object")});g=g.replace(/<embed[\s\S]*?(?:\/embed)?>/gi,function(i){h.arObjects[f]=i;return h.GetPattern(f++,false,"object")});return g},CheckForVideo:function(h){var f=new RegExp("(?:src)\\s*=\\s*(\"|')([\\s\\S]*?((?:youtube.com)|(?:youtu.be)|(?:rutube.ru)|(?:vimeo.com)|(?:vk.com)|(?:"+location.host+"))[\\s\\S]*?)(\\1)","ig");var g=f.exec(h);if(g){return{src:g[2],provider:this.GetVideoProviderName(g[3],h)}}else{return false}},GetVideoProviderName:function(h,g){var f="";if(!BX.type.isNotEmptyString(g)){g=""}switch(h){case"youtube.com":case"youtu.be":f="YouTube";break;case"rutube.ru":f="Rutube";break;case"vimeo.com":f="Vimeo";break;case"vk.com":f="Vk";break;case location.host:var i=/((?:provider))=([\S]+)(?:&*)/ig;res=i.exec(g);if(res){f=res[2]}break}return f},SavePhpCode:function(g,f){this.arScripts[f]=g;return this.GetPhpPattern(f,false)},GetPhpPattern:function(g,f){if(f){return new RegExp("#BXPHP_"+g+"#","ig")}else{return"#BXPHP_"+g+"#"}},GetPattern:function(i,h,f){var g;switch(f){case"php":g="#BXPHP_";break;case"javascript":g="#BXJAVASCRIPT_";break;case"html_comment":g="#BXHTMLCOMMENT_";break;case"iframe":g="#BXIFRAME_";break;case"style":g="#BXSTYLE_";break;case"video":g="#BXVIDEO_";break;case"audio":g="#BXAUDIO_";break;case"object":g="#BXOBJECT_";break;default:return""}return h?new RegExp(g+i+"#","ig"):g+i+"#"},ParseSymCode:function(f){var g=this;f=f.replace(/#BX(PHP|JAVASCRIPT|HTMLCOMMENT|IFRAME|STYLE|VIDEO|AUDIO|OBJECT)_(\d+)#/g,function(k,i,j){var h="";if(g.IsAllowed(i.toLowerCase())){switch(i){case"PHP":h=g.GetPhpCodeHTML(g.arScripts[j]);break;case"JAVASCRIPT":h=g.GetJavascriptCodeHTML(g.arJavascripts[j]);break;case"HTMLCOMMENT":h=g.GetHtmlCommentHTML(g.arHtmlComments[j]);break;case"IFRAME":h=g.GetIframeHTML(g.arIframes[j]);break;case"STYLE":h=g.GetStyleHTML(g.arStyles[j]);break;case"VIDEO":h=g.GetVideoHTML(g.arVideos[j]);break;case"AUDIO":h=g.GetAudioHTML(g.arAudio[j]);break;case"OBJECT":h=g.GetObjectHTML(g.arObjects[j]);break}}return h||k});return f},GetPhpCodeHTML:function(j){if(typeof j!=="string"){return null}var f="",h=this.editor.components.IsComponent(j);if(h!==false){var i=this.editor.components.GetComponentData(h.name),g=i.title||h.name,k=(i.params&&i.params.DESCRIPTION)?i.params.DESCRIPTION:k;if(i.className){h.className=i.className||""}f=this.GetSurrogateHTML("component",g,k,h)}else{if(this.editor.allowPhp){f=this.GetSurrogateHTML("php",BX.message("BXEdPhpCode"),BX.message("BXEdPhpCode")+": "+this.GetShortTitle(j,200),{value:j})}else{f=""}}return f},GetJavascriptCodeHTML:function(f){if(typeof f!=="string"){return null}return this.GetSurrogateHTML("javascript","Javascript","Javascript: "+this.GetShortTitle(f,200),{value:f})},GetHtmlCommentHTML:function(f){if(typeof f!=="string"){return null}return this.GetSurrogateHTML("htmlcomment",BX.message("BXEdHtmlComment"),BX.message("BXEdHtmlComment")+": "+this.GetShortTitle(f),{value:f})},GetIframeHTML:function(f){if(typeof f!=="string"){return null}return this.GetSurrogateHTML("iframe",BX.message("BXEdIframe"),BX.message("BXEdIframe")+": "+this.GetShortTitle(f),{value:f})},GetStyleHTML:function(f){if(typeof f!=="string"){return null}return this.GetSurrogateHTML("style",BX.message("BXEdStyle"),BX.message("BXEdStyle")+": "+this.GetShortTitle(f),{value:f})},GetVideoHTML:function(h){var g="video",j=h.params||this.FetchVideoIframeParams(h.html,h.provider);j.value=h.html;var k=this.editor.SetBxTag(false,{tag:g,name:j.title,params:j}),i=this.editor.SetBxTag(false,{tag:"surrogate_dd",params:{origParams:j,origId:k}});this.editor.SetBxTag({id:k},{tag:g,name:j.title,params:j,title:j.title,surrogateId:i});var f='<span id="'+k+'" title="'+j.title+'"  class="'+this.surrClass+' bxhtmled-video-surrogate" style="min-width:'+j.width+"px; max-width:"+j.width+"px; min-height:"+j.height+"px; max-height:"+j.height+'px"><img title="'+j.title+'" id="'+i+'" class="bxhtmled-surrogate-dd" src="'+this.editor.util.GetEmptyImage()+'"/><span class="bxhtmled-surrogate-inner"><span class="bxhtmled-video-icon"></span><span class="bxhtmled-comp-lable" spellcheck=false>'+j.title+"</span></span></span>";return f},GetAudioHTML:function(f){if(typeof f!=="string"){return null}var h="Audio",g=this.FetchVideoIframeParams(f);if(g&&g.src){h+=": "+this.GetShortTitle(BX.util.htmlspecialchars(g.src))}return this.GetSurrogateHTML("audio",h,"Audio: "+this.GetShortTitle(f),{value:f})},GetObjectHTML:function(f){return this.GetSurrogateHTML("object",BX.message("BXEdObjectEmbed"),BX.message("BXEdObjectEmbed")+": "+this.GetShortTitle(f),{value:f})},FetchVideoIframeParams:function(h,i){var f=/((?:src)|(?:title)|(?:width)|(?:height))\s*=\s*("|')([\s\S]*?)(\2)/ig,g={src:"",width:180,height:100,title:i?BX.message("BXEdVideoTitleProvider").replace("#PROVIDER_NAME#",i):BX.message("BXEdVideoTitle"),origTitle:""};h.replace(f,function(k,j,m,n){j=j.toLowerCase();if(j=="width"||j=="height"){n=parseInt(n,10);if(n&&!isNaN(n)){g[j]=n}}else{if(j=="title"){g.origTitle=BX.util.htmlspecialcharsback(n);g.title+=": "+n}else{g[j]=n}}return k});return g},GetSurrogateHTML:function(g,h,k,j){if(k){k=BX.util.htmlspecialchars(k);k=k.replace('"','"')}if(!j){j={}}var m=this.editor.SetBxTag(false,{tag:g,name:h,params:j}),i=this.editor.SetBxTag(false,{tag:"surrogate_dd",params:{origParams:j,origId:m}});this.editor.SetBxTag({id:m},{tag:g,name:h,params:j,title:k,surrogateId:i});if(!this.surrogateTags.tag){this.surrogateTags.tag=1}var f='<span id="'+m+'" title="'+(k||h)+'"  class="'+this.surrClass+(j.className?" "+j.className:"")+'">'+this.GetSurrogateInner(i,k,h)+"</span>";return f},GetSurrogateNode:function(f,g,k,j){var i=this.editor.GetIframeDoc(),m=this.editor.SetBxTag(false,{tag:f,name:g,params:j,title:k}),h=this.editor.SetBxTag(false,{tag:"surrogate_dd",params:{origParams:j,origId:m}});if(!j){j={}}this.editor.SetBxTag({id:m},{tag:f,name:g,params:j,title:k,surrogateId:h});if(!this.surrogateTags.tag){this.surrogateTags.tag=1}return BX.create("SPAN",{props:{id:m,title:k||g,className:this.surrClass+(j.className?" "+j.className:"")},html:this.GetSurrogateInner(h,k,g)},i)},GetSurrogateInner:function(g,h,f){return'<img title="'+(h||f)+'" id="'+g+'" class="bxhtmled-surrogate-dd" src="'+this.editor.util.GetEmptyImage()+'"/><span class="bxhtmled-surrogate-inner"><span class="bxhtmled-right-side-item-icon"></span><span class="bxhtmled-comp-lable" unselectable="on" spellcheck=false>'+BX.util.htmlspecialchars(f)+"</span></span>"},GetShortTitle:function(g,f){if(g.length>100){g=g.substr(0,100)+"..."}return g},_GetUnParsedContent:function(f){var g=this;f=f.replace(/#BX(PHP|JAVASCRIPT|HTMLCOMMENT|IFRAME|STYLE|VIDEO|AUDIO|OBJECT)_(\d+)#/g,function(k,i,j){var h;switch(i){case"PHP":h=g.arScripts[j];break;case"JAVASCRIPT":h=g.arJavascripts[j];break;case"HTMLCOMMENT":h=g.arHtmlComments[j];break;case"IFRAME":h=g.arIframes[j];break;case"STYLE":h=g.arStyles[j];break;case"VIDEO":h=g.arVideos[j].html;break;case"AUDIO":h=g.arAudio[j];break;case"OBJECT":h=g.arObjects[j].html;break}return h});return f},IsSurrogate:function(f){return f&&BX.hasClass(f,this.surrClass)},TrimPhpBrackets:function(f){if(f.substr(0,2)!="<?"){return f}if(f.substr(0,5).toLowerCase()=="<?php"){f=f.substr(5)}else{f=f.substr(2)}f=f.substr(0,f.length-2);return f},TrimQuotes:function(i,h){var f,g;i=i.trim();if(h==undefined){f=i.substr(0,1);g=i.substr(0,1);if((f=='"'&&g=='"')||(f=="'"&&g=="'")){i=i.substring(1,i.length-1)}}else{if(!h.length){return i}f=i.substr(0,1);g=i.substr(0,1);h=h.substr(0,1);if(f==h&&g==h){i=i.substring(1,i.length-1)}}return i},CleanCode:function(n){var g=false,m=false,f="",h=-1,k,j,o;while(h<n.length-1){h++;k=n.substr(h,1);if(!m){if(k=="/"&&h+1<n.length){j=0;if(n.substr(h+1,1)=="*"&&((j=n.indexOf("*/",h+2))>=0)){j+=2}else{if(n.substr(h+1,1)=="/"&&((j=n.indexOf("\n",h+2))>=0)){j+=1}}if(j>0){if(h>j){alert("iti="+h+"="+j)}h=j}continue}if(k==" "||k=="\r"||k=="\n"||k=="\t"){continue}}if(m&&k=="\\"){g=true;f+=k;continue}if(k=='"'||k=="'"){if(m){if(!g&&o==k){m=false}}else{m=true;o=k}}g=false;f+=k}return f},ParseFunction:function(g){var h=g.indexOf("("),f=g.lastIndexOf(")");if(h>=0&&f>=0&&h<f){return{name:g.substr(0,h),params:g.substring(h+1,f)}}return false},ParseParameters:function(k){k=this.CleanCode(k);var g=this.GetParams(k),i,h,f=g.length;for(h=0;h<f;h++){if(g[h].substr(0,6).toLowerCase()=="array("){g[h]=this.GetArray(g[h])}else{i=this.TrimQuotes(g[h]);if(this.IsNum(i)||g[h]!=i){g[h]=i}else{g[h]=this.WrapPhpBrackets(g[h])}}}return g},GetArray:function(k){var f={};if(k.substr(0,6).toLowerCase()!="array("){return k}k=k.substring(6,k.length-1);var h=this.GetParams(k),j,g,i,m;for(m=0;m<h.length;m++){if(h[m].substr(0,6).toLowerCase()=="array("){f[m]=this.GetArray(h[m]);continue}i=h[m].indexOf("=>");if(i==-1){if(h[m]==this.TrimQuotes(h[m])){f[m]=this.WrapPhpBrackets(h[m])}else{f[m]=this.TrimQuotes(h[m])}}else{j=this.TrimQuotes(h[m].substr(0,i));g=h[m].substr(i+2);if(g==this.TrimQuotes(g)){g=this.WrapPhpBrackets(g)}else{g=this.TrimQuotes(g)}if(g.substr(0,6).toLowerCase()=="array("){g=this.GetArray(g)}f[j]=g}}return f},WrapPhpBrackets:function(h){h=h.trim();var f=h.substr(0,1),g=h.substr(0,1);if((f=='"'&&g=='"')||(f=="'"&&g=="'")){return h}return"={"+h+"}"},GetParams:function(h){var p=[],j=0,f,g,n=1,m=1,k,o="";for(k=0;k<h.length;k++){f=h.substr(k,1);if(f=='"'&&m==1&&!g){n*=-1}else{if(f=="'"&&n==1&&!g){m*=-1}else{if(f=="\\"&&!g){g=true;o+=f;continue}}}if(g){g=false}if(m==-1||n==-1){o+=f;continue}if(f=="("){j++}else{if(f==")"){j--}else{if(f==","&&j==0){p.push(o);o="";continue}}}if(j<0){break}o+=f}if(o!=""){p.push(o)}return p},IsNum:function(f){var g=f;f=parseFloat(g);if(isNaN(f)){f=parseInt(g)}if(!isNaN(f)){return g==f}return false},ParseBxNodes:function(j){var h,g=this.editor.parser.convertedBxNodes,f=g.length;for(h=0;h<f;h++){if(g[h].tag=="surrogate_dd"){j=j.replace("~"+g[h].params.origId+"~","")}}this._skipNodeIndex={};this._skipNodeList=[];var k=this;j=j.replace(/~(bxid\d{1,9})~/ig,function(m,o){if(!k._skipNodeIndex[o]){var i=k.editor.GetBxTag(o);if(i&&i.tag){var n=k.GetBxNode(i.tag);if(n){return n.Parse(i.params,o)}}}return""});return j},GetBxNodeList:function(){var f=this;this.arBxNodes={component:{Parse:function(h,g){return f.editor.components.GetSource(h,g)}},component_icon:{Parse:function(g){return f.editor.components.GetOnDropHtml(g)}},surrogate_dd:{Parse:function(i){if(BX.browser.IsFirefox()||!i||!i.origId){return""}var g=f.editor.GetBxTag(i.origId);if(g){f._skipNodeIndex[i.origId]=true;f._skipNodeList.push(i.origId);var h=f.GetBxNode(g.tag);if(h){return h.Parse(g.params)}}return"#parse surrogate_dd#"}},php:{Parse:function(g){return f._GetUnParsedContent(g.value)}},php_protected:{Parse:function(g){return g.value}},javascript:{Parse:function(g){return f._GetUnParsedContent(g.value)}},htmlcomment:{Parse:function(g){return f._GetUnParsedContent(g.value)}},iframe:{Parse:function(g){return f._GetUnParsedContent(g.value)}},style:{Parse:function(g){return f._GetUnParsedContent(g.value)}},video:{Parse:function(g){return f._GetUnParsedContent(g.value)}},audio:{Parse:function(g){return f._GetUnParsedContent(g.value)}},object:{Parse:function(g){return f._GetUnParsedContent(g.value)}},anchor:{Parse:function(h){var i="";if(h.attributes){for(var g in h.attributes){if(h.attributes.hasOwnProperty(g)){i+=g+'="'+h.attributes[g]+'" '}}}return"<a "+i+(h.name?'name="'+h.name+'"':"")+">"+h.html+"</a>"}},pagebreak:{Parse:function(g){return"<BREAK />"}},printbreak:{Parse:function(g){return'<div style="page-break-after: always">'+g.innerHTML+"</div>"}}};this.editor.On("OnGetBxNodeList");return this.arBxNodes},AddBxNode:function(f,g){if(this.arBxNodes==undefined){var h=this;BX.addCustomEvent(this.editor,"OnGetBxNodeList",function(){h.arBxNodes[f]=g})}else{this.arBxNodes[f]=g}},GetBxNode:function(f){if(!this.arBxNodes){this.arBxNodes=this.GetBxNodeList()}return this.arBxNodes[f]||null},OnSurrogateMousedown:function(h,g,f){var i=this;if(f.tag=="surrogate_dd"){BX.bind(g,"dragstart",function(j){i.OnSurrogateDragStart(j,this)});BX.bind(g,"dragend",function(j){i.OnSurrogateDragEnd(j,this,f)})}else{setTimeout(function(){var k=i.CheckParentSurrogate(i.editor.selection.GetSelectedNode());if(k){i.editor.selection.SetAfter(k);if(!k.nextSibling||k.nextSibling.nodeType!=3){var j=i.editor.util.GetInvisibleTextNode();i.editor.selection.InsertNode(j);i.editor.selection.SetAfter(j)}}},0)}},OnSurrogateDragEnd:function(m,n,f){if(!document.querySelectorAll){return}var p=this.editor.GetIframeDoc(),h,q,r,o={},k=p.querySelectorAll(".bxhtmled-surrogate"),j=p.querySelectorAll(".bxhtmled-surrogate-dd"),g=k.length;for(h=0;h<j.length;h++){if(j[h]&&j[h].id==f.id){BX.remove(j[h])}}for(h=0;h<g;h++){q=k[h];if(o[q.id]){if(q.getAttribute("data-bx-paste-flag")=="Y"||!o[q.id].getAttribute("data-bx-paste-flag")){BX.remove(q)}else{if(o[q.id].getAttribute("data-bx-paste-flag")){BX.remove(o[q.id])}}}else{o[q.id]=q;r=this.editor.GetBxTag(q.id);q.innerHTML=this.GetSurrogateInner(r.surrogateId,r.title,r.name)}}},OnSurrogateDragStart:function(g,f){if(BX.browser.IsFirefox()){this.editor.GetIframeDoc().body.appendChild(f)}},CheckParentSurrogate:function(i){if(!i){return false}if(this.IsSurrogate(i)){return i}var h=this,f=0,g=BX.findParent(i,function(j){return(f++>4)||h.IsSurrogate(j)},this.editor.GetIframeDoc().body);return this.IsSurrogate(g)?g:false},CheckSurrogateDd:function(f){return f&&f.nodeType==1&&this.editor.GetBxTag(f).tag=="surrogate_dd"},OnSurrogateClick:function(i,h){var g=this.editor.GetBxTag(h);if(g&&g.tag=="surrogate_dd"){var f=this.editor.GetBxTag(g.params.origId);this.editor.On("OnSurrogateClick",[g,f,h,i])}},OnSurrogateDblClick:function(i,h){var g=this.editor.GetBxTag(h);if(g&&g.tag=="surrogate_dd"){var f=this.editor.GetBxTag(g.params.origId);this.editor.On("OnSurrogateDblClick",[g,f,h,i])}},OnSurrogateKeyup:function(k,j,m,i){var f,h,g=this.editor.selection.GetRange();if(g){if(g.collapsed){}else{}}},OnSurrogateKeydown:function(v,x,r,w){var s,g=this.editor.KEY_CODES,u=this.editor.selection.GetRange(),q,n,k,p=w;if(!u||!u.getNodes){return}if(!u.collapsed){if(x===g.backspace||x===g["delete"]){var t,j=u.getNodes([3]);for(t=0;t<j.length;t++){s=this.editor.util.CheckSurrogateNode(j[t]);if(s){n=this.editor.GetBxTag(s);if(this.surrogateTags[n.tag]){this.RemoveSurrogate(s,n)}}}}}if(x===g["delete"]&&u.collapsed){q=this.editor.util.GetInvisibleTextNode();this.editor.selection.InsertNode(q);this.editor.selection.SetAfter(q);var f=q.nextSibling;if(f){if(f&&f.nodeName=="BR"){f=f.nextSibling}if(f&&f.nodeType==3&&(f.nodeValue=="\n"||this.editor.util.IsEmptyNode(f))){f=f.nextSibling}if(f){BX.remove(q);n=this.editor.GetBxTag(f);if(this.surrogateTags[n.tag]){this.RemoveSurrogate(f,n);return BX.PreventDefault(v)}}}}else{if(x===g.backspace&&u.collapsed){q=this.editor.util.GetInvisibleTextNode();this.editor.selection.InsertNode(q);this.editor.selection.SetAfter(q);var m=this.editor.util.GetPreviousNotEmptySibling(q);if(m&&this.editor.phpParser.IsSurrogate(m)){BX.remove(m);if(q){BX.remove(q)}return BX.PreventDefault(v)}else{if(q){BX.remove(q)}}}}if(u.startContainer&&u.startContainer==u.endContainer&&u.startContainer.nodeName!=="BODY"){p=u.startContainer;k=this.editor.util.CheckSurrogateNode(p);if(k){n=this.editor.GetBxTag(k.id);if(x===g.backspace||x===g["delete"]){this.RemoveSurrogate(k,n);BX.PreventDefault(v)}else{if(x===g.left||x===g.up){var h=k.previousSibling;if(h&&h.nodeType==3&&this.editor.util.IsEmptyNode(h)){this.editor.selection._MoveCursorBeforeNode(h)}else{this.editor.selection._MoveCursorBeforeNode(k)}return BX.PreventDefault(v)}else{if(x===g.right||x===g.down){var o=k.nextSibling;if(o&&o.nodeType==3&&this.editor.util.IsEmptyNode(o)){this.editor.selection._MoveCursorAfterNode(o)}else{this.editor.selection._MoveCursorAfterNode(k)}return BX.PreventDefault(v)}else{if(x===g.shift||x===g.ctrl||x===g.alt||x===g.cmd||x===g.cmdRight){return BX.PreventDefault(v)}else{this.editor.selection._MoveCursorAfterNode(k)}}}}}}},RemoveSurrogate:function(g,f){this.editor.undoManager.Transact();BX.remove(g);this.editor.On("OnSurrogateRemove",[g,f])},CheckHiddenSurrogateDrag:function(){var f,g;for(g=0;g<this.hiddenDd.length;g++){f=this.editor.GetIframeElement(this.hiddenDd[g]);if(f){f.style.visibility=""}}this.hiddenDd=[]},GetAllSurrogates:function(k){if(!document.querySelectorAll){return[]}k=k===true;var n=this.editor.GetIframeDoc(),j=[],h,g,f,m=n.querySelectorAll(".bxhtmled-surrogate");for(h=0;h<m.length;h++){g=m[h];f=this.editor.GetBxTag(g.id);if(f.tag||k){j.push({node:g,bxTag:f})}}return j},RenewSurrogates:function(){var k=true,g,f={},j,h=this.GetAllSurrogates(true);for(g=0;g<h.length;g++){if(!h[g].bxTag.tag){BX.remove(h[g].node);continue}j=h[g].bxTag.surrogateId;if(!f[j]||!k){f[j]=j;h[g].node.innerHTML=this.GetSurrogateInner(h[g].bxTag.surrogateId,h[g].bxTag.title,h[g].bxTag.name)}else{BX.remove(h[g].node)}}},RedrawSurrogates:function(){var f,g=this.GetAllSurrogates();for(f=0;f<g.length;f++){if(g[f].node){BX.addClass(g[f].node,"bxhtmled-surrogate-tmp")}}setTimeout(function(){for(f=0;f<g.length;f++){if(g[f].node){BX.removeClass(g[f].node,"bxhtmled-surrogate-tmp")}}},0)},IsAllowed:function(f){return this.allowed[f]},AdvancedPhpParse:function(f){if(this.bUseAPP){this.arAPPFragments=[];f=this.AdvancedPhpParseInAttributes(f)}return f},AdvancedPhpParseBetweenTableTags:function(n){var j=this;function k(t,s,r,q,i){j.arAPPFragments.push(JS_addslashes(s));return r+q+' data-bx-php-before="#BXAPP'+(j.arAPPFragments.length-1)+'#" '+i}function f(t,s,r,q,i){j.arAPPFragments.push(JS_addslashes(i));return s+">"+q+"<"+r+' style="display:none;" data-bx-php-after="#BXAPP'+(j.arAPPFragments.length-1)+'#"></'+r+">"}var o=j.APPConfig.arTags_before,m=j.APPConfig.arTags_after,g,h,p;for(h=0;h<o.length;h++){g=o[h];if(j.limit_php_access){p=new RegExp("#(PHP(?:\\d{4}))#(\\s*)(<"+g+"[^>]*?)(>)","ig")}else{p=new RegExp("<\\?(.*?)\\?>(\\s*)(<"+g+"[^>]*?)(>)","ig")}n=n.replace(p,k)}for(h=0,l=m.length;h<l;h++){g=m[h];if(j.limit_php_access){p=new RegExp("(</("+g+")[^>]*?)>(\\s*)#(PHP(?:\\d{4}))#","ig")}else{p=new RegExp("(</("+g+")[^>]*?)>(\\s*)<\\?(.*?)\\?>","ig")}n=n.replace(p,f)}return n},AdvancedPhpParseInAttributes:function(n){var o=this,k=this.APPConfig.arTags,h,m,g,j;function f(t,w,v,u,s,r,q){if(s.indexOf("#BXPHP_")===-1){return t}o.arAPPFragments.push(s);var i=o.arAPPFragments.length-1;var p=o.AdvancedPhpGetFragmentByIndex(i,true);return w+v+'="'+p+'" data-bx-app-ex-'+v+'="#BXAPP'+i+'#"'+r}for(h in k){if(k.hasOwnProperty(h)){for(g=0;g<k[h].length;g++){m=k[h][g];j=new RegExp("(<"+h+"(?:[^>](?:\\?>)*?)*?)("+m+")\\s*=\\s*((?:\"|')?)([\\s\\S]*?)\\3((?:[^>](?:\\?>)*?)*?>)","ig");n=n.replace(j,f)}}}return n},AdvancedPhpUnParse:function(f){return f},AdvancedPhpGetFragmentByCode:function(h,g){var f=h.substr(6);f=parseInt(f.substr(0,f.length-1),10);return this.AdvancedPhpGetFragmentByIndex(f,g)},AdvancedPhpGetFragmentByIndex:function(g,f){var i=this,h=this.arAPPFragments[g];h=h.replace(/#BXPHP_(\d+)#/g,function(n,m){var k=i.arScripts[parseInt(m,10)];if(f){var j=i.GetSiteTemplatePath();if(j){k=k.replace(/<\?=\s*SITE_TEMPLATE_PATH;?\s*\?>/i,j);k=k.replace(/<\?\s*echo\s*SITE_TEMPLATE_PATH;?\s*\?>/i,j)}}return k});return h},ParseBreak:function(f){var g=this;f=f.replace(/<break\s*\/*>/gi,function(h){return g.GetSurrogateHTML("pagebreak",BX.message("BXEdPageBreakSur"),BX.message("BXEdPageBreakSurTitle"))});return f},GetSiteTemplatePath:function(){return this.editor.GetTemplateParams().SITE_TEMPLATE_PATH},CustomContentParse:function(g){for(var f=0;f<this.customParsers.length;f++){if(typeof this.customParsers[f]=="function"){g=this.customParsers[f](g)}}return g},AddCustomParser:function(f){if(typeof f=="function"){this.customParsers.push(f)}}};function e(f){this.editor=f;this.parseAlign=true}e.prototype={Unparse:function(g){var f=this.editor.parser.GetAsDomElement(g,this.editor.GetIframeDoc());f.setAttribute("data-bx-parent-node","Y");g=this.GetNodeHtml(f,true);g=g.replace(/#BR#/ig,"\n");g=g.replace(/&nbsp;/ig," ");g=g.replace(/\uFEFF/ig,"");return g},Parse:function(t){var r=this,p,j;t=t.replace(/</ig,"&lt;");t=t.replace(/>/ig,"&gt;");function u(i){if(!i.replace){return i}return i.replace(/("|<|>)/g,"")}var m=[];t=t.replace(/\[code\]((?:\s|\S)*?)\[\/code\]/ig,function(y,i){m.push('<pre class="bxhtmled-code">'+i+"</pre>");return"#BX_CODE"+(m.length-1)+"#"});var n,f;for(n in this.editor.parser.specialParsers){if(this.editor.parser.specialParsers.hasOwnProperty(n)){f=this.editor.parser.specialParsers[n];if(f&&f.Parse){t=f.Parse(n,t,this.editor)}}}if(this.editor.sortedSmiles){var v=[],h=[],o;t=t.replace(/\[(?:\s|\S)*?\]/ig,function(i){h.push(i);return"#BX_TMP_TAG"+(h.length-1)+"#"});t=t.replace(/(?:https?|ftp):\/\//gi,function(i){v.push(i);return"#BX_TMP_URL"+(v.length-1)+"#"});j=this.editor.sortedSmiles.length;var s,g="\\s.,;:!?\\#\\-\\*\\|\\[\\]\\(\\)\\{\\}<>&\\n\\t\\r",q;for(p=0;p<j;p++){o=this.editor.sortedSmiles[p];if(o.path&&o.code){q="";if(o.width){q+="width:"+parseInt(o.width)+"px;"}if(o.height){q+="height:"+parseInt(o.height)+"px;"}if(q!==""){q='style="'+q+'"'}s='<img id="'+r.editor.SetBxTag(false,{tag:"smile",params:o})+'" src="'+o.path+'" title="'+(o.name||o.code)+'" '+q+"/>";t=t.replace(new RegExp("(["+g+"])"+BX.util.preg_quote(o.code)+"(["+g+"])","ig"),"$1"+s+"$2");t=t.replace(new RegExp("(["+g+"])"+BX.util.preg_quote(o.code)+"$","ig"),"$1"+s);t=t.replace(new RegExp("^"+BX.util.preg_quote(o.code)+"(["+g+"])","ig"),s+"$1");t=t.replace(new RegExp("^"+BX.util.preg_quote(o.code)+"$","ig"),s)}}if(v.length>0){t=t.replace(/#BX_TMP_URL(\d+)#/ig,function(y,i){return v[i]||y})}if(h.length>0){t=t.replace(/#BX_TMP_TAG(\d+)#/ig,function(y,i){return h[i]||y})}}t=t.replace(/\[quote\]/ig,'<blockquote class="bxhtmled-quote">');t=t.replace(/\[\/quote\]\n?/ig,"</blockquote>");t=t.replace(/[\r\n\s\t]?\[table\][\r\n\s\t]*?\[tr\]/ig,'<table border="1">[TR]');t=t.replace(/\[tr\][\r\n\s\t]*?\[td\]/ig,"[TR][TD]");t=t.replace(/\[tr\][\r\n\s\t]*?\[th\]/ig,"[TR][TH]");t=t.replace(/\[\/td\][\r\n\s\t]*?\[td\]/ig,"[/TD][TD]");t=t.replace(/\[\/tr\][\r\n\s\t]*?\[tr\]/ig,"[/TR][TR]");t=t.replace(/\[\/td\][\r\n\s\t]*?\[\/tr\]/ig,"[/TD][/TR]");t=t.replace(/\[\/th\][\r\n\s\t]*?\[\/tr\]/ig,"[/TH][/TR]");t=t.replace(/\[\/tr\][\r\n\s\t]*?\[\/table\][\r\n\s\t]?/ig,"[/TR][/TABLE]");t=t.replace(/[\r\n\s\t]*?\[\/list\]/ig,"[/LIST]");t=t.replace(/[\r\n\s\t]*?\[\*\]?/ig,"[*]");t=t.replace(/\[p\]/ig,"<p>");t=t.replace(/\[\/p\]\n?/ig,"</p>");var k=["b","u","i",["s","del"],"table","tr","td","th"],w,x;j=k.length;for(p=0;p<j;p++){if(typeof k[p]=="object"){w=k[p][0];x=k[p][1]}else{w=x=k[p]}t=t.replace(new RegExp("\\[(\\/?)"+w+"\\]","ig"),"<$1"+x+">")}t=t.replace(/\[url\]((?:\s|\S)*?)\[\/url\]/ig,function(y,i){return'<a href="'+u(i)+'">'+i+"</a>"});t=t.replace(/\[url\s*=\s*((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/url\]/ig,function(z,i,y){return'<a href="'+u(i)+'">'+y+"</a>"});t=t.replace(/\[img((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/img\]/ig,function(A,z,y){z=r.FetchImageParams(z);y=u(y);var i="";if(z.width){i+="width:"+parseInt(z.width)+"px;"}if(z.height){i+="height:"+parseInt(z.height)+"px;"}if(i!==""){i='style="'+i+'"'}return'<img  src="'+y+'"'+i+"/>"});p=0;while(t.toLowerCase().indexOf("[color=")!=-1&&t.toLowerCase().indexOf("[/color]")!=-1&&p++<20){t=t.replace(/\[color=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/color\]/ig,function(y,z,i){return'<span style="color:'+u(z)+'">'+i+"</span>"})}p=0;while(t.toLowerCase().indexOf("[list=")!=-1&&t.toLowerCase().indexOf("[/list]")!=-1&&p++<20){t=t.replace(/\[list=1\]((?:\s|\S)*?)\[\/list\]/ig,"<ol>$1</ol>")}p=0;while(t.toLowerCase().indexOf("[list")!=-1&&t.toLowerCase().indexOf("[/list]")!=-1&&p++<20){t=t.replace(/\[list\]((?:\s|\S)*?)\[\/list\]/ig,"<ul>$1</ul>")}t=t.replace(/\[\*\]/ig,"<li>");p=0;while(t.toLowerCase().indexOf("[font=")!=-1&&t.toLowerCase().indexOf("[/font]")!=-1&&p++<20){t=t.replace(/\[font=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/font\]/ig,function(y,z,i){return'<span style="font-family:'+u(z)+'">'+i+"</span>"})}p=0;while(t.toLowerCase().indexOf("[size=")!=-1&&t.toLowerCase().indexOf("[/size]")!=-1&&p++<20){t=t.replace(/\[size=((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/size\]/ig,function(y,z,i){return'<span style="font-size:'+u(z)+'">'+i+"</span>"})}if(this.parseAlign){t=t.replace(/\[(center|left|right|justify)\]/ig,function(i,y){return'<div style="text-align:'+u(y)+'">'});t=t.replace(/\[\/(center|left|right|justify)\]/ig,"</div>")}if(t.toLowerCase().indexOf("[/video]")!=-1){t=t.replace(/\[video((?:\s|\S)*?)\]((?:\s|\S)*?)\[\/video\]/ig,function(i,z,y){return r.GetVideoSourse(y,r.FetchVideoParams(z.trim(z)),i)})}t=t.replace(/\n/ig,"<br />");t=t.replace(/&#91;/ig,"[");t=t.replace(/&#93;/ig,"]");if(m.length>0){t=t.replace(/#BX_CODE(\d+)#/ig,function(y,i){return m[i]||y})}return t},GetNodeHtml:function(h,f){var q={node:h},n="";if(!f){if(h.nodeType==3){var p=BX.util.htmlspecialchars(h.nodeValue);if(!p.match(/[^\n]+/ig)&&h.previousSibling&&h.nextSibling&&this.editor.util.IsBlockNode(h.previousSibling)&&this.editor.util.IsBlockNode(h.nextSibling)){return"\n"}if(BX.browser.IsChrome()&&this.editor.pasteHandleMode&&h.nextSibling&&h.nextSibling.nodeName=="P"){p=p.replace(/\n+/ig,"\n")}if(h.parentNode&&!h.parentNode.getAttribute("data-bx-parent-node")&&BX.util.in_array(h.parentNode.nodeName,["P","DIV","SPAN","TD","TH","B","STRONG","I","EM","U","DEL","S","STRIKE","BLOCKQUOTE"])){p=p.replace(/\n/ig," ")}if(BX.browser.IsMac()||BX.browser.IsFirefox()){p=p.replace(/\n/ig," ")}p=p.replace(/\[/ig,"&#91;");p=p.replace(/\]/ig,"&#93;");return p}if(h.nodeType==1&&h.nodeName=="P"){var k=BX.util.trim(h.innerHTML);k=k.replace(/[\n\r\s]/ig,"").toLowerCase();if(k=="<br>"){h.innerHTML=""}}var m=this.UnParseNodeBB(q);if(m!==false){return m}if(q.bbOnlyChild){f=true}if(!f){if(q.breakLineBefore){n+="\n"}if(h.nodeType==1&&!q.hide){n+="["+q.bbTag;if(q.bbValue){n+="="+q.bbValue}n+="]"}}}if(q.checkNodeAgain){n+=this.GetNodeHtml(h)}else{var j,g,o="";for(j=0;j<h.childNodes.length;j++){g=h.childNodes[j];o+=this.GetNodeHtml(g)}n+=o}if(!f){if(q.breakLineAfter){n+="\n"}if(o==""&&this.IsPairNode(q.bbTag)&&h.nodeName!=="P"&&h.nodeName!=="TD"&&h.nodeName!=="TR"&&h.nodeName!=="TH"){return""}if(h.nodeType==1&&(h.childNodes.length>0||this.IsPairNode(q.bbTag))&&!q.hide&&!q.hideRight){n+="[/"+q.bbTag+"]"}if(q.breakLineAfterEnd||h.nodeType==1&&this.editor.util.IsBlockNode(h)&&this.editor.util.IsBlockNode(h.nextSibling)){n+="\n"}}return n},UnParseNodeBB:function(q){var j,o,k,n=q.node.nodeName.toUpperCase();q.checkNodeAgain=false;if(n=="BR"){return"#BR#"}if(q.node&&q.node.id){j=this.editor.GetBxTag(q.node.id);if(j.tag){var g=this.editor.parser.specialParsers[j.tag];if(g&&g.UnParse){return g.UnParse(j,q,this.editor)}else{if(j.tag=="video"){return j.params.value}else{if(j.tag=="smile"){return j.params.code}else{return""}}}}}if(n=="SCRIPT"){return""}if(n=="IFRAME"&&q.node.src){var f=q.node.src.replace(/https?:\/\//ig,"//"),i=this.editor.phpParser.CheckForVideo('src="'+f+'"');if(i){var h=parseInt(q.node.width),p=parseInt(q.node.height);return"[VIDEO TYPE="+i.provider.toUpperCase()+" WIDTH="+h+" HEIGHT="+p+"]"+f+"[/VIDEO]"}}if(n=="PRE"&&BX.hasClass(q.node,"bxhtmled-code")){return"[CODE]"+this.GetCodeContent(q.node)+"[/CODE]"}if(n=="IMG"){var r="";if(q.node.style.width){r+=" WIDTH="+parseInt(q.node.style.width)}else{if(q.node.width){r+=" WIDTH="+parseInt(q.node.width)}}if(q.node.style.height){r+=" HEIGHT="+parseInt(q.node.style.height)}else{if(q.node.height){r+=" HEIGHT="+parseInt(q.node.height)}}return"[IMG"+r+"]"+q.node.src+"[/IMG]"}q.hide=false;q.bbTag=n;o=BX.util.in_array(n,this.editor.TABLE_TAGS);k=this.parseAlign&&(q.node.style.textAlign||q.node.align)&&!o;if(n=="STRONG"||n=="B"){q.bbTag="B"}else{if(n=="EM"||n=="I"){q.bbTag="I"}else{if(n=="DEL"||n=="S"){q.bbTag="S"}else{if((n=="OL"||n=="UL")){q.bbTag="LIST";q.breakLineAfter=true;q.bbValue=n=="OL"?"1":""}else{if(n=="LI"){if(q.node.lastChild&&q.node.lastChild.nodeName=="BR"){q.node.removeChild(q.node.lastChild)}q.bbTag="*";q.breakLineBefore=true;q.hideRight=true}else{if(n=="A"){q.bbTag="URL";q.bbValue=this.editor.parser.GetAttributeEx(q.node,"href");q.bbValue=q.bbValue.replace(/\[/ig,"&#91;").replace(/\]/ig,"&#93;");if(q.bbValue===""){q.bbOnlyChild=true}}else{if(q.node.style.color&&!o){q.bbTag="COLOR";q.bbValue=this.editor.util.RgbToHex(q.node.style.color);q.node.style.color="";if(q.node.style.cssText!=""){q.checkNodeAgain=true}}else{if(q.node.style.fontFamily&&!o){q.bbTag="FONT";q.bbValue=q.node.style.fontFamily;q.node.style.fontFamily="";if(q.node.style.cssText!=""){q.checkNodeAgain=true}}else{if(q.node.style.fontSize&&!o){q.bbTag="SIZE";q.bbValue=q.node.style.fontSize;q.node.style.fontSize="";if(q.node.style.cssText!=""){q.checkNodeAgain=true}}else{if(n=="BLOCKQUOTE"&&q.node.className=="bxhtmled-quote"&&!q.node.getAttribute("data-bx-skip-check")){q.bbTag="QUOTE";q.breakLineAfterEnd=true;if(k){q.checkNodeAgain=true;q.node.setAttribute("data-bx-skip-check","Y")}}else{if(k){var m=q.node.style.textAlign||q.node.align;if(BX.util.in_array(m,["left","right","center","justify"])){q.hide=false;q.bbTag=m.toUpperCase()}else{q.hide=!BX.util.in_array(n,this.editor.BBCODE_TAGS)}}else{if(!BX.util.in_array(n,this.editor.BBCODE_TAGS)){q.hide=true}}}}}}}}}}}}return false},IsPairNode:function(f){f=f.toUpperCase();return !(f.substr(0,1)=="H"||f=="BR"||f=="IMG"||f=="INPUT")},GetCodeContent:function(h){if(!h||this.editor.util.IsEmptyNode(h)){return""}var g,f="";for(g=0;g<h.childNodes.length;g++){if(h.childNodes[g].nodeType==3){f+=h.childNodes[g].data}else{if(h.childNodes[g].nodeType==1&&h.childNodes[g].nodeName=="BR"){f+="#BR#"}else{f+=this.GetCodeContent(h.childNodes[g])}}}if(BX.browser.IsIE()){f=f.replace(/\r/ig,"#BR#")}else{f=f.replace(/\n/ig,"#BR#")}f=f.replace(/\[/ig,"&#91;");f=f.replace(/\]/ig,"&#93;");return f},GetVideoSourse:function(i,h,f,g){g=g||BX.message.BXEdVideoTitle;return this.editor.phpParser.GetVideoHTML({params:{width:h.width,height:h.height,title:g,origTitle:"",provider:h.type},html:f})},FetchVideoParams:function(n){n=BX.util.trim(n);var k=n.split(" "),j,f,m,h,g={width:180,height:100,type:false};for(j=0;j<k.length;j++){h=k[j].split("=");f=h[0].toLowerCase();m=h[1];if(f=="width"||f=="height"){m=parseInt(m,10);if(m&&!isNaN(m)){g[f]=Math.max(m,100)}}else{if(f=="type"){m=m.toUpperCase();if(m=="YOUTUBE"||m=="RUTUBE"||m=="VIMEO"){g[f]=m}}}}return g},FetchImageParams:function(n){n=BX.util.trim(n);var k=n.split(" "),j,f,m,h,g={};for(j=0;j<k.length;j++){h=k[j].split("=");f=h[0].toLowerCase();m=h[1];if(f=="width"||f=="height"){m=parseInt(m,10);if(m&&!isNaN(m)){g[f]=m}}}return g}};function a(g){this.editor=g;var h=["area","hr","i?frame","link","meta","noscript","style","table","tbody","thead","tfoot"],i=["li","dt","dd","h[1-6]","option","script"];this.reBefore=new RegExp("^<(/?"+h.join("|/?")+"|"+i.join("|")+")[ >]","i");this.reAfter=new RegExp("^<(br|/?"+h.join("|/?")+"|/"+i.join("|/")+")[ >]");var f=["blockquote","div","dl","fieldset","form","frameset","map","ol","p","pre","select","td","th","tr","ul"];this.reLevel=new RegExp("^</?("+f.join("|")+")[ >]");this.lastCode=null;this.lastResult=null}a.prototype={Format:function(f){if(f!=this.lastCode){this.lastCode=f;this.lastResult=this.DoFormat(f)}return this.lastResult},DoFormat:function(g){g+=" ";this.level=0;var m=this,j,o,n=0,f=null,h=null,r="",q="",k=0,p="";this.pieces={};g=g.replace(/<pre[\s\S]*?\/pre>/gi,function(i){m.pieces[k]=i;var t="#BX_CODE_PIECE_"+k+"#";k++;return t});for(j=0;j<g.length;j++){n=j;if(g.substr(j).indexOf("<")==-1){q+=g.substr(j);q=q.replace(/\n\s*\n/g,"\n");q=q.replace(/^[\s\n]*/,"");q=q.replace(/[\s\n]*$/,"");if(q.indexOf("<!--noindex-->")!==-1){q=q.replace(/(<!--noindex-->)(?:[\s|\n|\r|\t]*?)(<a[\s\S]*?\/a>)(?:[\s|\n|\r|\t]*?)(<!--\/noindex-->)(?:[\n|\r|\t]*)/ig,"$1$2$3")}q=q.replace(/#BX_CODE_PIECE_(\d+)#/g,function(i,t){return(t&&m.pieces[t])?m.pieces[t]:i});return q}while(n<g.length&&g.charAt(n)!=="<"){n++}if(j!=n){p=g.substr(j,n-j);if(p.match(/^\s+$/)){p=p.replace(/\s+/g," ");q+=p}else{if(q.charAt(q.length-1)=="\n"){q+=this.GetTabs()}else{if(p.charAt(0)=="\n"){q+="\n"+this.GetTabs();p=p.replace(/^\s+/,"")}}p=p.replace(/\n/g," ");p=p.replace(/\n+/g,"");p=p.replace(/\s+/g," ");q+=p}if(p.match(/\n/)){q+="\n"+this.GetTabs()}}f=n;while(n<g.length&&g.charAt(n)!=">"){n++}r=g.substr(f,n-f);j=n;if(r.substr(1,3)==="!--"){if(!r.match(/--$/)){while(g.substr(n,3)!=="-->"){n++}n+=2;r=g.substr(f,n-f);j=n}if(q.charAt(q.length-1)!=="\n"){q+="\n"}q+=this.GetTabs();q+=r+">\n"}else{if(r[1]==="!"){q=this.PutTag(r+">",q)}else{if(r[1]=="?"){q+=r+">\n"}else{if(o=r.match(/^<(script|style)/i)){o[1]=o[1].toLowerCase();q=this.PutTag(this.CleanTag(r),q);h=String(g.substr(j+1)).toLowerCase().indexOf("</"+o[1]);if(h){p=g.substr(j+1,h);j+=h;q+=p}}else{q=this.PutTag(this.CleanTag(r),q)}}}}}g=g.replace(/#BX_CODE_PIECE_(\d+)#/g,function(i,t){return(t&&m.pieces[t])?m.pieces[t]:i});return g},GetTabs:function(){var g="",f;for(f=0;f<this.level;f++){g+="\t"}return g},CleanTag:function(h){var g,i=/\s*([^= ]+)(?:=((['"']).*?\3|[^ ]+))?/,f="",j="";h=h.replace(/\n/g," ");h=h.replace(/[\s]{2,}/g," ");h=h.replace(/^\s+|\s+$/g," ");if(h.match(/\/$/)){j="/";h=h.replace(/\/+$/,"")}while(g=i.exec(h)){if(g[2]){f+=g[1]+"="+g[2]}else{if(g[1]){f+=g[1]}}f+=" ";h=h.substr(g[0].length)}return f.replace(/\s*$/,"")+j+">"},PutTag:function(f,h){var g=f.match(this.reLevel);if(f.match(this.reBefore)||g){h=h.replace(/\s*$/,"");h+="\n"}if(g&&f.charAt(1)=="/"){this.level--}if(h.charAt(h.length-1)=="\n"){h+=this.GetTabs()}if(g&&"/"!=f.charAt(1)){this.level++}h+=f;if(f.match(this.reAfter)||f.match(this.reLevel)){h=h.replace(/ *$/,"");h+="\n"}return h}};function b(){window.BXHtmlEditor.BXCodeFormatter=a;window.BXHtmlEditor.BXEditorParser=d;window.BXHtmlEditor.BXEditorPhpParser=c;window.BXHtmlEditor.BXEditorBbCodeParser=e}if(window.BXHtmlEditor){b()}else{BX.addCustomEvent(window,"OnBXHtmlEditorInit",b)}})();