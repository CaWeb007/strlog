(function(){BX.namespace("BX.Fileman");if(window.BX.Fileman.PlayerManager){return}BX.Fileman.PlayerManager={isStarted:false,players:[],playing:false,slider:null,addPlayer:function(a){this.players.push(a);this.bindPlayerEvents(a);if(a.autostart||a.lazyload){this.init()}},init:function(){if(this.isStarted){return}this.isStarted=true;BX.ready(BX.proxy(function(){BX.bind(window,"scroll",BX.throttle(BX.Fileman.PlayerManager.onScroll,300,BX.Fileman.PlayerManager));setTimeout(BX.delegate(BX.Fileman.PlayerManager.onScroll,BX.Fileman.PlayerManager),50);if(window!==window.top){if(BX.getClass("top.BX.SidePanel.Instance")){var a=top.BX.SidePanel.Instance.getSliderByWindow(window);if(a){this.slider=a;BX.addCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(function(c){if(c.getSlider()===this.slider){for(var b in this.players){this.players[b].pause()}}},this))}}}},this))},bindPlayerEvents:function(c){var b=c.getEventList();if(b){for(var a=0;a<b.length;a++){BX.addCustomEvent(c,b[a],BX.proxy(function(e,d){BX.onCustomEvent(BX.Fileman.PlayerManager,"PlayerManager."+d,[e])},this))}}},onScroll:function(){if(this.players.length==0){return}var b=false;var a=false;for(var d in this.players){var c=this.players[d];if(!BX(c.id)){this.players.splice(d,1);continue}if(c.lazyload&&!c.inited){if(this.isVisibleOnScreen(c.id,2)){c.init()}}if(!c.autostart){continue}if(c.active){continue}if(c.isEnded()){continue}if(this.isVisibleOnScreen(c.id,1)){if(b===false){b=c}}else{if(c.isPlaying()){c.pause()}}if(c.isPlaying()){a=true}}if(a){return}if(b!==false){if(!b.inited){b.autostart=true}else{if(b.isReady()&&!b.isEnded()){b.mute(true);BX.addCustomEvent(b,"Player:onClick",BX.proxy(b.disableMute,b));b.play()}}}},getElementCoords:function(b){var c=0.25;var e=BX(b).getBoundingClientRect();var f=e.bottom-e.top;var g=e.top+c*f;var a=e.bottom-c*f;var h=e.right-e.left;var d=e.left+c*h;var i=e.right-c*h;coords={top:g+window.pageYOffset,bottom:a+window.pageYOffset,left:d+window.pageXOffset,right:i+window.pageXOffset,originTop:g,originLeft:d,originBottom:a,originRight:i};return coords},isVisibleOnScreen:function(b,a){var l,e=false;var k=this.getElementCoords(b);var g=document.documentElement.clientHeight;var n=window.pageYOffset||document.documentElement.scrollTop;var d=n+g;if(a){a=parseInt(a)}if(a>1){n-=g*(a-1);d+=g*(a-1)}var f=k.top>n&&k.top<d;var c=k.bottom<d&&k.bottom>n;l=f||c;if(l&&a>1){return true}if(!l){return false}var j=BX(b);var i=k.originLeft+(k.originRight-k.originLeft)/2;var h=k.originTop+(k.originBottom-k.originTop)/2+20;var m=document.elementFromPoint(i,h);if(!!m){if(m===j||m.parentNode===j||m.parentNode.parentNode===j){e=true}}return(l&&e)},getPlayerById:function(b){if(!b){return null}for(var a in this.players){if(this.players[a].id===b){return this.players[a]}}return null}};BX.Fileman.Player=function(b,a){this.inited=false;this.id=b;this.hasStarted=false;this.fillParameters(a);BX.Fileman.PlayerManager.addPlayer(this);this.fireEvent("onCreate");BX.bind(BX(this.id),"click",BX.proxy(this.onClick,this));BX.bind(BX(this.id),"keydown",BX.proxy(this.onKeyDown,this))};BX.Fileman.Player.prototype.onClick=function(){var a=BX.findChildByClassName(this.getElement(),"vjs-play-control");if(a){a.focus()}this.active=true;this.fireEvent("onClick")};BX.Fileman.Player.prototype.isPlaying=function(){if(this.vjsPlayer){return(this.vjsPlayer.isReady_&&!this.vjsPlayer.paused())}return false};BX.Fileman.Player.prototype.pause=function(){try{this.vjsPlayer.pause()}catch(a){}this.fireEvent("onPause")};BX.Fileman.Player.prototype.isEnded=function(){if(this.vjsPlayer){return this.vjsPlayer.ended()}return false};BX.Fileman.Player.prototype.isReady=function(){return this.vjsPlayer.isReady_};BX.Fileman.Player.prototype.play=function(){this.setPlayedState();this.hasStarted=true;try{this.vjsPlayer.play()}catch(a){}this.fireEvent("onPlay")};BX.Fileman.Player.prototype.setPlayedState=function(){var a=this.__getStorageHash();if(BX.localStorage){BX.localStorage.set(a,"played",1209600)}};BX.Fileman.Player.prototype.isPlayed=function(){var a=this.__getStorageHash();if(BX.localStorage){return(BX.localStorage.get(a)==="played")}return true};BX.Fileman.Player.prototype.__getStorageHash=function(){var a=this.id;if(this.params.sources&&BX.type.isArray(this.params.sources)&&this.params.sources[0].src){a=this.params.sources[0].src}return"player_"+a};BX.Fileman.Player.prototype.getElement=function(){return BX(this.id)};BX.Fileman.Player.prototype.createElement=function(){var e=this.getElement();if(e){return e}if(!this.id){return null}var c="video";var d="video-js vjs-big-play-centered";if(this.isAudio){c="audio";d="video-js vjs-has-started"}if(this.skin){d+=" "+this.skin}var a={id:this.id,className:d,width:this.width,height:this.height,controls:true};if(this.muted){a.muted=true}e=BX.create(c,{attrs:a});if(this.params.sources){if(BX.type.isArray(this.params.sources)){for(var b in this.params.sources){if(!this.params.sources[b].src||!this.params.sources[b].type){continue}var f=BX.create("source",{attrs:{src:this.params.sources[b].src,type:this.params.sources[b].type}});BX.append(f,e)}}}return e};BX.Fileman.Player.prototype.fillParameters=function(a){this.autostart=a.autostart||false;this.hasFlash=a.hasFlash||false;if(a.playbackRate&&!a.hasFlash){a.playbackRate=parseFloat(a.playbackRate);if(a.playbackRate!=1){if(a.playbackRate<=0){a.playbackRate=1}if(a.playbackRate>3){a.playbackRate=3}}if(a.playbackRate!=1){this.playbackRate=a.playbackRate}}this.volume=a.volume||0.8;this.playlistParams=a.playlistParams||false;this.startTime=a.startTime||0;this.wmvConfig=a.wmvConfig||false;this.onInit=a.onInit;this.lazyload=a.lazyload;this.skin=a.skin||"";this.isAudio=a.isAudio||false;a.width=a.width||400;if(this.isAudio){a.height=a.height||30}else{a.height=a.height||300}this.width=a.width;this.height=a.height;this.duration=a.duration||null;this.params=a;this.active=this.isPlayed()};BX.Fileman.Player.prototype.onKeyDown=function(a){if(a.which==32){this.onClick();if(this.isPlaying()){this.pause()}else{this.play()}a.preventDefault();a.stopPropagation();return false}this.fireEvent("onKeyDown")};BX.Fileman.Player.prototype.setSource=function(a){if(!a){return false}this.vjsPlayer.src(a);this.fireEvent("onSetSource")};BX.Fileman.Player.prototype.getSource=function(){return this.vjsPlayer.src()};BX.Fileman.Player.prototype.init=function(){this.fireEvent("onBeforeInit");if(videojs.players[this.id]){delete videojs.players[this.id]}this.vjsPlayer=videojs(this.id,this.params);this.vjsPlayer.on("error",BX.proxy(function(){if(BX.type.isArray(this.params.sources)&&this.params.sources.length>1){for(var b in this.params.sources){if(this.params.sources.hasOwnProperty(b)){if(this.getAbsoluteURL(this.params.sources[b].src)===this.getSource()&&this.params.sources.length>b+1&&this.previousTrack!==this.getSource()){this.previousTrack=this.getSource();this.setSource(this.params.sources[parseInt(b+1)]);return}}}}this.fireEvent("onError");if(!this.isFlashErrrorShown&&this.hasFlash){this.isFlashErrrorShown=true;var a=this.vjsPlayer.error();if(a&&a.code===4){a.message=a.message+". "+BX.message("PLAYER_FLASH_CHECK");this.vjsPlayer.errorDisplay.content(a.message)}}},this));if(this.hasFlash){setTimeout(BX.proxy(function(){if(!this.inited){this.vjsPlayer.error(BX.message("PLAYER_FLASH_REQUIRED"));this.inited=true}},this),3000)}this.vjsPlayer.ready(BX.proxy(function(){var a=BX.findChildByClassName(BX(this.id),"vjs-play-control");if(a){a.addEventListener("click",BX.proxy(this.onClick,this))}this.vjsPlayer.volume(this.volume);if(this.duration>0){this.vjsPlayer.one("loadedmetadata",BX.proxy(function(){this.vjsPlayer.duration(this.duration)},this))}this.vjsPlayer.one("play",BX.proxy(function(){if(this.playbackRate!=1){this.vjsPlayer.playbackRate(this.playbackRate)}if(this.volume){this.vjsPlayer.volume(this.volume)}if(this.startTime>0){try{this.vjsPlayer.currentTime(this.startTime);var c=BX.findChild(BX(this.id),{"class":"vjs-loading-spinner"},false);if(c){c.remove()}}catch(b){}}this.vjsPlayer.on("volumechange",BX.proxy(function(){this.active=true},this))},this));if(this.playlistParams){this.vjsPlayer.playlist(this.playlistParams)}if(this.wmvConfig){this.vjsPlayer.wmvConfig=this.wmvConfig}this.inited=true;if(BX.type.isFunction(this.onInit)){this.onInit(this)}this.fireEvent("onAfterInit");this.proxyEvents();if(this.autostart&&!this.lazyload){setTimeout(BX.proxy(function(){if(!this.hasStarted){this.play()}},this),200)}},this),true)};BX.Fileman.Player.prototype.getEventList=function(){return["Player:onBeforeInit","Player:onAfterInit","Player:onCreate","Player:onSetSource","Player:onKeyDown","Player:onPlay","Player:onPause","Player:onClick","Player:onError","Player:onEnded"]};BX.Fileman.Player.prototype.fireEvent=function(a){if(BX.type.isNotEmptyString(a)){a="Player:"+a;BX.onCustomEvent(this,a,[this,a])}};BX.Fileman.Player.prototype.mute=function(a){return this.vjsPlayer.muted(a)};BX.Fileman.Player.prototype.disableMute=function(){BX.removeCustomEvent(this,"Player:onClick",BX.proxy(this.disableMute,this));setTimeout(BX.proxy(function(){this.mute(false)},this),100)};BX.Fileman.Player.prototype.proxyEvents=function(){if(!this.inited){return}this.vjsPlayer.on("play",BX.proxy(function(){this.fireEvent("onPlay");this.hasStarted=true},this));this.vjsPlayer.on("pause",BX.proxy(function(){this.fireEvent("onPause")},this));this.vjsPlayer.on("ended",BX.proxy(function(){this.fireEvent("onEnded")},this))};BX.Fileman.Player.prototype.getAbsoluteURL=function(a){if(!a.match(/^https?:\/\//)){var b=document.createElement("div");b.innerHTML='<a href="'+a+'">x</a>';a=b.firstChild.href}return a}})(window);