function BXFMSearch(a){this.Init(a)}BXFMSearch.prototype={Init:function(a){if(this.bInited){return true}var b=this;this.pAddLink=BX("bx_fms_add_lnk");this.pSearchTbl=BX("bx_fms_tbl");this.oSearchDialog=a.oSearchDialog;this.pTabSearch=BX("bx_search_cont");this.pTabReplace=BX("bx_replace_cont");this.lang=a.lang;this.site=a.site;this.arLastPathes=a.arLastPathes;this.sessid_get=a.sessid_get;this.bUseLastValues=true;this.viewMsFilePath=a.viewMsFilePath;this.viewMsFolderPath=a.viewMsFolderPath;this.dateFormat=a.dateFormat;this.pForm=document.forms.bx_search_form;this.pSearchResultCont=BX("bx_search_res_cont");this.pSearchFile=BX("bx_search_file");this.pSearchPhrase=BX("bx_search_phrase");this.pReplacePhrase=BX("bx_replace_phrase");this.pSearchDir=BX("bx_search_dir");this.pSearchSubdir=BX("bx_search_subdir");this.pSearchDirsToo=BX("bx_search_dirs_too");this.pSearchEntire=BX("bx_search_entire");this.pSearchCase=BX("bx_search_case");this.pInResRow=BX("bx_search_in_res_tr");this.pInRes=BX("bx_search_in_res");this.pFDButton=BX("bx_search_fd_but");this.pSearchDateSel=BX("bx_search_date_sel");this.pSearchDateFrom=BX("bx_search_date_from");this.pSearchDateTo=BX("bx_search_date_to");this.pSearchDateDiv=BX("bx_search_date_div");this.pSearchSizeSel=BX("bx_search_size_sel");this.pSearchSizeFrom=BX("bx_search_size_from");this.pSearchSizeTo=BX("bx_search_size_to");this.pSearchSizeDiv=BX("bx_search_size_div");this.pSearchSubdir.onclick=this.pSearchDirsToo.onclick=this.pSearchEntire.onclick=this.pSearchCase.onclick=function(){b.SaveConfig()};this.pAddLink.onclick=function(d){var c=b.pSearchTbl.className.indexOf("bxfm-d-params-add-hide")==-1;b.bShowAdvanced=!c;if(c){BX.addClass(b.pSearchTbl,"bxfm-d-params-add-hide")}else{BX.removeClass(b.pSearchTbl,"bxfm-d-params-add-hide")}b.oSearchDialog.adjustSizeEx();b.SaveConfig();return false};this.pSearchDateSel.onchange=function(){b.pSearchDateDiv.style.display=this.value=="set"?"block":"none";b.oSearchDialog.adjustSizeEx();if(this.value!==0){var i=new Date(),g=new Date(),h=g.getMonth(),f=g.getFullYear(),d=g.getDate(),c=g.getHours(),e=g.getMinutes();b.pSearchDateTo.value=""}if(this.value==0){b.pSearchDateFrom.value="";b.pSearchDateTo.value=""}else{if(this.value=="day"){i.setFullYear(f,h,d-1);b.pSearchDateFrom.value=b.FormatDate(i.getDate(),i.getMonth(),i.getFullYear(),c,e)}else{if(this.value=="week"){i.setFullYear(f,h,d-7);b.pSearchDateFrom.value=b.FormatDate(i.getDate(),i.getMonth(),i.getFullYear(),c,e)}else{if(this.value=="month"){i.setFullYear(f,h-1,d);b.pSearchDateFrom.value=b.FormatDate(i.getDate(),i.getMonth(),i.getFullYear(),c,e)}else{if(this.value=="year"){i.setFullYear(f-1,h,d);b.pSearchDateFrom.value=b.FormatDate(i.getDate(),i.getMonth(),i.getFullYear(),c,e)}}}}}};this.pSearchSizeSel.onchange=function(){b.pSearchSizeDiv.style.display=this.value=="set"?"block":"none";b.oSearchDialog.adjustSizeEx();if(this.value==0){b.pSearchSizeFrom.value="";b.pSearchSizeTo.value=""}else{if(this.value=="100"){b.pSearchSizeFrom.value="";b.pSearchSizeTo.value="100"}else{if(this.value=="100_500"){b.pSearchSizeFrom.value="100";b.pSearchSizeTo.value="500"}else{if(this.value=="500"){b.pSearchSizeFrom.value="500";b.pSearchSizeTo.value=""}}}}};this.pInRes.onclick=function(){var c=!!this.checked;b.pFDButton.disabled=b.pSearchDir.disabled=b.pSearchSubdir.disabled=c};this.oSiteSel=new BXFMSiteSel({id:"site_sel_search",pDiv:BX("bx_search_site_sel"),sites:a.arSites});BX.addCustomEvent(oSearchDialog,"onWindowUnRegister",BX.proxy(this.OnClose,this));if(a.oUserConfig){this.bShowAdvanced=a.oUserConfig.advMode;if(this.bShowAdvanced){BX.removeClass(this.pSearchTbl,"bxfm-d-params-add-hide")}else{BX.addClass(this.pSearchTbl,"bxfm-d-params-add-hide")}this.pSearchSubdir.checked=!!a.oUserConfig.bSubdir;this.pSearchDirsToo.checked=!!a.oUserConfig.bDirsToo;this.pSearchEntire.checked=!!a.oUserConfig.entire;this.pSearchCase.checked=!!a.oUserConfig.bCaseSens}this.Request("clean_old",{},false,false);this.bInited=true},OnOpen:function(a){this.sSess=a.ssess||false;this.SetPath(a.path);this.pInResRow.style.display=a.bSearch?"":"none";if(a.bSearch){if(this.pInRes.checked){this.pFDButton.disabled=this.pSearchDir.disabled=this.pSearchSubdir.disabled=true}}else{this.pInRes.checked=false}if(a.lastValues&&this.bUseLastValues){this.bUseLastValues=false;this.pSearchFile.value=a.lastValues.file||"";this.pSearchPhrase.value=a.lastValues.search_phrase||"";this.pReplacePhrase.value=a.lastValues.replace_phrase||"";this.pSearchDir.value=a.lastValues.dir||"";this.pSearchSubdir.checked=!!a.lastValues.subdir;this.pSearchDirsToo.checked=!!a.lastValues.dirs_too;this.pSearchCase.checked=!!a.lastValues.case_sens;if(a.lastValues.date_sel){this.pSearchDateSel.value=a.lastValues.date_sel;this.pSearchDateSel.onchange();if(a.lastValues.date_from||a.lastValues.date_to){this.pSearchDateFrom.value=a.lastValues.date_from;this.pSearchDateTo.value=a.lastValues.date_to}}if(a.lastValues.size_sel){this.pSearchSizeSel.value=a.lastValues.size_sel;this.pSearchSizeSel.onchange();if(a.lastValues.size_from||a.lastValues.size_to){this.pSearchSizeFrom.value=a.lastValues.size_from;this.pSearchSizeTo.value=a.lastValues.size_to}}}this.pSearchFile.focus();BX.bind(BX.browser.IsIE()?document.body:window,"keydown",BX.proxy(this.OnKeyDown,this))},OnClose:function(){BX.unbind(BX.browser.IsIE()?document.body:window,"keydown",BX.proxy(this.OnKeyDown,this))},OnKeyDown:function(a){if(!a){a=window.event}if(window.oBXFileDialog&&window.oBXFileDialog.bOpened){return}if(oSearchDialog.isOpen&&a.keyCode==13){return this.Search()}},Count:function(){var c=this,b=this.GetPostParams();var a=function(){if(!c.oCountResDialog.isOpen){return}if(window.fmsBtimeout){b.last_path=window.fmsLastPath;c.count_xhr=c.Request("count",b,a)}else{if(c.oCountResInt){clearInterval(c.oCountResInt)}c.oCountResIntCount=0;BX.removeClass(c.pCountResDiv,"bxfm-count-wait");c.oCountResDialog.SetTitle(FM_MESS.CountEnded)}c.intCountResult+=window.fmsResult;if(window.fmsBstoped){c.pReplResCntWarn.style.display="inline";c.pCountResDiv.title=FM_MESS.CountLimitWarn}else{c.pReplResCntWarn.style.display="none";c.pCountResDiv.title=""}c.pCountResCnt.innerHTML=c.intCountResult};if(!c.oCountResDialog){this.oCountResDialog=new BX.CDialog({title:FM_MESS.CountProgress,content:'<div id="bxfm_count_res_div" class="bxfm-count-res-div bxfm-count-wait">'+FM_MESS.CountedFiles+': <span id="bxfm_count_res_cnt">0</span><span id="bxfm_cnt_res_warn" class="bxfm-warn">*</span></div>',height:125,width:250,resizable:false,buttons:[BX.CDialog.btnClose]});this.pCountResCnt=BX("bxfm_count_res_cnt");this.pCountResDiv=BX("bxfm_count_res_div");this.pReplResCntWarn=BX("bxfm_cnt_res_warn");BX.addClass(this.oCountResDialog.PARTS.CONTENT,"bxfm-dialog-content");if(BX.browser.IsIE()){this.pCountResDiv.style.margin="3px 0 2px 2px"}}else{c.pCountResCnt.innerHTML="0";c.pReplResCntWarn.style.display="none";c.pCountResDiv.title="";BX.addClass(c.pCountResDiv,"bxfm-count-wait");this.oCountResDialog.SetTitle(FM_MESS.CountProgress)}this.oCountResDialog.Show();this.intCountResult=0;if(this.oCountResInt){clearInterval(this.oCountResInt)}this.oCountResIntCount=0;this.oCountResInt=setInterval(function(){if(c.oCountResIntCount<3){c.oCountResIntCount++;c.oCountResDialog.SetTitle(c.oCountResDialog.PARAMS.title+" .")}else{c.oCountResIntCount=0;c.oCountResDialog.SetTitle(FM_MESS.CountProgress)}},400);if(this.count_xhr){this.count_xhr.abort()}this.count_xhr=this.Request("count",b,a);BX.addCustomEvent(this.oCountResDialog,"onWindowUnRegister",BX.proxy(function(){if(this.count_xhr){this.count_xhr.abort()}},this))},Search:function(){if(this.bReplace){return this.Replace()}var c=this,b=this.GetPostParams();var a=function(){if(!c.oSearchResDialog.isOpen||c.bSearchDenied){return}var f,d=window.fmsResult.length,j,k,g,e;if(d>0&&c.arSearchResult.length==0){c.pSearchRes.style.display="block";c.oSearchResDialog.PARAMS.buttons[0].enable();c.oSearchResDialog.SetSize({width:600,height:400});c.oSearchResDialog.adjustPos()}for(f=0;f<d;f++){g=window.fmsResult[f];c.arSearchResult.push(g);c.searchCount+=parseInt(g.repl_count);j=c.pSearchResTable.insertRow(-1);j.title=g.path;k=j.insertCell(-1);k.appendChild(BX.create("IMG",{props:{src:g.type_src}}));k=j.insertCell(-1);k.style.textAlign="left";e=((g.b_dir?c.viewMsFolderPath:c.viewMsFilePath)+c.oSiteSel.value).replace("#PATH#",BX.util.urlencode(g.path));k.appendChild(BX.create("A",{props:{href:e,target:"_blank"},text:g.path}));if(c.pSearchPhrase.value!=""){k.appendChild(BX.create("SPAN",{props:{className:"bxfm-search-cnt",title:FM_MESS.SearchInFileTitle},html:" (<span>"+parseInt(g.repl_count)+"</span>)"}))}k=j.insertCell(-1);k.appendChild(document.createTextNode(g.str_date));k=j.insertCell(-1);k.appendChild(document.createTextNode(g.str_size))}if(c.pSearchPhrase.value==""){c.pSearchResCnt.innerHTML=c.arSearchResult.length||0}else{c.pSearchResCnt.innerHTML=c.searchCount||0;c.pSearchResCntFiles.innerHTML=c.arSearchResult.length||0}if(window.fmsBtimeout){b.last_path=window.fmsLastPath;c.xhr=c.Request("search",b,a)}else{if(c.oSearchResInt){clearInterval(c.oSearchResInt)}c.oSearchResIntCount=0;var h=BX("stop");if(h){h.disabled=true}BX.removeClass(c.pSearchResDiv,"bxfm-wait");c.oSearchResDialog.PARAMS.buttons[0].enable();c.oSearchResDialog.SetTitle(FM_MESS.SearchEnded)}if(window.fmsBstoped){c.pSearchResCntWarn.style.display="inline";c.pSearchResDiv.title=FM_MESS.CountLimitWarn}else{c.pSearchResCntWarn.style.display="none";c.pSearchResDiv.title=""}};if(!this.oSearchResDialog){this.oSearchResDialog=new BX.CDialog({title:FM_MESS.SearchProgress,content:'<div id="bxfm_search_res_div" class="bxfm-search-res-div bxfm-wait"><div class="bxfm-wait-1"></div>'+FM_MESS.Counted+': <span id="bxfm_search_res_cnt">0</span><span id="bxfm_sres_warn" class="bxfm-warn">*</span><span class="bxfm-only-for-phrase"><br>'+FM_MESS.ReplCountInFiles+': <span id="bxfm_search_res_files">0</span></span><div class="bxfm-search-res" id="bxfm_search_res"><table><tr class="bxfm-s-res-head"><td class="bxfm-h-type"></td><td class="bxfm-h-path">'+FM_MESS.Path+'</td><td class="bxfm-h-date">'+FM_MESS.Date+'</td><td class="bxfm-h-size">'+FM_MESS.Size+"</td></tr></table></div></div>",height:125,width:450,min_height:220,min_width:450,buttons:[new BX.CWindowButton({title:FM_MESS.ShowRes,id:"show_res",name:"show_res",action:function(){c.DisplaySearchResult()}}),new BX.CWindowButton({title:FM_MESS.Stop,id:"stop",name:"stop",action:function(){if(c.oSearchResInt){clearInterval(c.oSearchResInt)}c.oSearchResIntCount=0;c.bSearchDenied=true;if(c.xhr){c.xhr.abort()}BX.removeClass(c.pSearchResDiv,"bxfm-wait");c.oSearchResDialog.PARAMS.buttons[0].enable();c.oSearchResDialog.SetTitle(FM_MESS.SearchEnded)}}),BX.CDialog.btnClose]});BX.addClass(this.oSearchResDialog.PARTS.CONTENT,"bxfm-dialog-content");this.pSearchResCnt=BX("bxfm_search_res_cnt");this.pSearchResCntFiles=BX("bxfm_search_res_files");this.pSearchRes=BX("bxfm_search_res");this.pSearchResTable=this.pSearchRes.firstChild;this.pSearchResDiv=BX("bxfm_search_res_div");this.pSearchResCntWarn=BX("bxfm_sres_warn");if(BX.browser.IsIE()){this.pSearchResDiv.style.margin="3px 0 2px 2px"}}else{c.pSearchRes.style.display="none";c.pSearchResCnt.innerHTML="0";c.pSearchResCntFiles.innerHTML="0";while(this.pSearchResTable.rows[1]){this.pSearchResTable.deleteRow(-1)}this.pSearchResCntWarn.style.display="none";this.pSearchResDiv.title="";BX.addClass(this.pSearchResDiv,"bxfm-wait");BX.removeClass(this.pSearchResDiv,"bxfm-with-phrase");c.oSearchResDialog.SetTitle(FM_MESS.SearchProgress);c.oSearchResDialog.PARAMS.buttons[1].enable();c.oSearchResDialog.SetSize({width:600,height:125});c.oSearchResDialog.adjustPos()}this.oSearchResDialog.Show();this.arSearchResult=[];this.searchCount=0;this.bSearchDenied=false;this.oSearchResDialog.PARAMS.buttons[0].disable();if(this.pSearchPhrase.value!=""){BX.addClass(this.pSearchResDiv,"bxfm-with-phrase")}this.oSearchResIntCount=0;if(this.oSearchResInt){clearInterval(this.oSearchResInt)}this.oSearchResInt=setInterval(function(){if(c.oSearchResIntCount<3){c.oSearchResIntCount++;c.oSearchResDialog.SetTitle(c.oSearchResDialog.PARAMS.title+" .")}else{c.oSearchResIntCount=0;c.oSearchResDialog.SetTitle(FM_MESS.SearchProgress)}},400);if(this.xhr){this.xhr.abort()}this.xhr=this.Request("search",b,a);BX.addCustomEvent(this.oSearchResDialog,"onWindowUnRegister",BX.proxy(function(){if(this.xhr){this.xhr.abort()}},this));BX.addCustomEvent(this.oSearchResDialog,"onWindowResizeExt",function(e){var d=e.width-35;if(BX.browser.IsIE()){d-=5}if(d>0){c.pSearchRes.style.width=d+"px"}})},Replace:function(){BX.WindowManager.disableKeyCheck();if(this.pSearchPhrase.value==""){alert(FM_MESS.ReplacePhraseWarn);this.pSearchPhrase.focus();return setTimeout(function(){BX.WindowManager.enableKeyCheck()},500)}if(!confirm(FM_MESS.ReplaceConfirm)){return setTimeout(function(){BX.WindowManager.enableKeyCheck()},500)}BX.WindowManager.enableKeyCheck();var c=this,b=this.GetPostParams();var a=function(){if(!c.oReplaceResDialog.isOpen||c.bReplaceDenied){return}var e,d=window.fmsResult.length,h,j,f;if(d>0&&c.arReplaceResult.length==0){c.pReplRes.style.display="block";c.oReplaceResDialog.PARAMS.buttons[0].enable();c.oReplaceResDialog.SetSize({width:600,height:400});c.oReplaceResDialog.adjustPos()}for(e=0;e<d;e++){f=window.fmsResult[e];c.arReplaceResult.push(f);c.replaceCount+=parseInt(f.repl_count);h=c.pReplResTable.insertRow(-1);h.title=f.path;j=h.insertCell(-1);j.appendChild(BX.create("IMG",{props:{src:f.type_src}}));j=h.insertCell(-1);j.style.textAlign="left";href=((f.b_dir?c.viewMsFolderPath:c.viewMsFilePath)+c.oSiteSel.value).replace("#PATH#",BX.util.urlencode(f.path));j.appendChild(BX.create("A",{props:{href:href,target:"_blank"},text:f.path}));j.appendChild(BX.create("SPAN",{props:{className:"bxfm-rep-cnt",title:FM_MESS.ReplInFileTitle},html:" (<span>"+parseInt(f.repl_count)+"</span>)"}));j=h.insertCell(-1);j.appendChild(document.createTextNode(f.str_date));j=h.insertCell(-1);j.appendChild(document.createTextNode(f.str_size))}c.pReplResFilesCnt.innerHTML=c.arReplaceResult.length||0;c.pReplResCnt.innerHTML=c.replaceCount||0;if(window.fmsBtimeout){b.last_path=window.fmsLastPath;c.replace_xhr=c.Request("replace",b,a)}else{if(c.oReplResInt){clearInterval(c.oReplResInt)}c.oReplResIntCount=0;var g=BX("stop");if(g){g.disabled=true}BX.removeClass(c.pReplResDiv,"bxfm-wait");c.oReplaceResDialog.PARAMS.buttons[0].enable();c.oReplaceResDialog.SetTitle(FM_MESS.ReplEnded)}if(window.fmsBstoped){c.pReplResCntWarn.style.display="inline";c.pReplResDiv.title=FM_MESS.CountLimitWarn}else{c.pReplResCntWarn.style.display="none";c.pReplResDiv.title=""}};if(!this.oReplaceResDialog){this.oReplaceResDialog=new BX.CDialog({title:FM_MESS.ReplProgress,content:'<div id="bxfm_repl_res_div" class="bxfm-search-res-div bxfm-wait"><div class="bxfm-wait-1"></div>'+FM_MESS.ReplCounted+': <span id="bxfm_repl_res_cnt">0</span><br>'+FM_MESS.ReplCountInFiles+': <span id="bxfm_repl_res_files">0</span><span id="bxfm_repl_res_warn" class="bxfm-warn">*</span><div class="bxfm-search-res" id="bxfm_repl_res"><table><tr class="bxfm-s-res-head"><td class="bxfm-h-type"></td><td class="bxfm-h-path">'+FM_MESS.Path+'</td><td class="bxfm-h-date">'+FM_MESS.Date+'</td><td class="bxfm-h-size">'+FM_MESS.Size+"</td></tr></table></div></div>",height:150,width:450,min_height:250,min_width:450,buttons:[new BX.CWindowButton({title:FM_MESS.ReplShowRes,id:"show_res",name:"show_res",action:function(){c.DisplayReplaceResult()}}),new BX.CWindowButton({title:FM_MESS.Stop,id:"stop",name:"stop",action:function(){if(c.oReplResInt){clearInterval(c.oReplResInt)}c.oReplResIntCount=0;c.bReplaceDenied=true;if(c.replace_xhr){c.replace_xhr.abort()}BX.removeClass(c.pReplResDiv,"bxfm-wait");c.oReplaceResDialog.PARAMS.buttons[0].enable();c.oReplaceResDialog.SetTitle(FM_MESS.ReplEnded)}}),BX.CDialog.btnClose]});BX.addClass(this.oReplaceResDialog.PARTS.CONTENT,"bxfm-dialog-content");this.pReplResCnt=BX("bxfm_repl_res_cnt");this.pReplResFilesCnt=BX("bxfm_repl_res_files");this.pReplRes=BX("bxfm_repl_res");this.pReplResTable=this.pReplRes.firstChild;this.pReplResDiv=BX("bxfm_repl_res_div");this.pReplResCntWarn=BX("bxfm_repl_res_warn");if(BX.browser.IsIE()){this.pReplResDiv.style.margin="4px 2px 2px 0px"}}else{c.pReplRes.style.display="none";c.pReplResCnt.innerHTML="0";c.pReplResFilesCnt.innerHTML="0";while(this.pReplResTable.rows[1]){this.pReplResTable.deleteRow(-1)}c.pReplResCntWarn.style.display="none";c.pReplResDiv.title="";BX.addClass(this.pReplResDiv,"bxfm-wait");this.oReplaceResDialog.SetTitle(FM_MESS.ReplProgress);this.oReplaceResDialog.PARAMS.buttons[1].enable();this.oReplaceResDialog.SetSize({width:600,height:120});this.oReplaceResDialog.adjustPos()}this.oReplaceResDialog.Show();this.arReplaceResult=[];this.replaceCount=0;this.bReplaceDenied=false;this.oReplaceResDialog.PARAMS.buttons[0].disable();this.oReplResIntCount=0;if(this.oReplResInt){clearInterval(this.oReplResInt)}this.oReplResInt=setInterval(function(){if(c.oReplResIntCount<3){c.oReplResIntCount++;c.oReplaceResDialog.SetTitle(c.oReplaceResDialog.PARAMS.title+" .")}else{c.oReplResIntCount=0;c.oReplaceResDialog.SetTitle(FM_MESS.ReplProgress)}},400);if(this.replace_xhr){this.replace_xhr.abort()}this.replace_xhr=this.Request("replace",b,a);BX.addCustomEvent(this.oReplaceResDialog,"onWindowUnRegister",BX.proxy(function(){if(this.replace_xhr){this.replace_xhr.abort()}},this));BX.addCustomEvent(this.oReplaceResDialog,"onWindowResizeExt",function(e){var d=e.width-35;c.pReplRes.style.width=d+"px"})},GetPostParams:function(){return{file:this.pSearchFile.value,phrase:this.pSearchPhrase.value,replace_phrase:this.pReplacePhrase.value,dir:this.pSearchDir.value,subdir:this.pSearchSubdir.checked?1:0,date_from:this.pSearchDateFrom.value,date_to:this.pSearchDateTo.value,size_from:this.pSearchSizeFrom.value,size_to:this.pSearchSizeTo.value,entire:this.pSearchEntire.checked?1:0,case_sens:this.pSearchCase.checked?1:0,dirs_too:this.pSearchDirsToo.checked?1:0,ssess:this.sSess?this.sSess:0,in_result:this.pInRes.checked?1:0}},DisplayReplaceResult:function(){this.pSearchResultCont.appendChild(BX.create("INPUT",{props:{name:"is_replace",type:"hidden",value:"Y"}}));this.DisplaySearchResult(this.arReplaceResult)},DisplaySearchResult:function(e){if(typeof e!="object"){e=this.arSearchResult}var c,a=e.length,b,d;for(c=0;c<a;c++){b="sres["+c+"]";d=e[c];this.pSearchResultCont.appendChild(BX.create("INPUT",{props:{name:b+"[path]",type:"hidden",value:d.path}}));this.pSearchResultCont.appendChild(BX.create("INPUT",{props:{name:b+"[b_dir]",type:"hidden",value:d.b_dir}}));this.pSearchResultCont.appendChild(BX.create("INPUT",{props:{name:b+"[size]",type:"hidden",value:d.size}}));this.pSearchResultCont.appendChild(BX.create("INPUT",{props:{name:b+"[time]",type:"hidden",value:d.time}}))}this.pForm.submit()},Request:function(d,e,c,a){a=a!==false;if(a){BX.showWait()}var b="/bitrix/admin/fileman_admin.php?lang="+this.lang+"&fu_action="+d+"&site="+this.site+"&"+this.sessid_get+"&fu_site="+this.oSiteSel.value;return BX.ajax.post(b,e||{},function(f){if(a){BX.closeWait()}if(c){setTimeout(function(){c(f)},100)}})},SetTab:function(a){var b=this.oSearchDialog.PARAMS.buttons[0];if(a=="search"){this.pTabSearch.appendChild(this.pTabReplace.firstChild);b.btn.value=b.title=FM_MESS.Find;this.bReplace=false}else{this.pTabReplace.appendChild(this.pTabSearch.firstChild);b.btn.value=b.title=FM_MESS.Replace;this.bReplace=true}this.oSearchDialog.adjustSizeEx()},SetPath:function(a){this.pSearchDir.value=a},FormatDate:function(f,a,g,c,b){var e=this.dateFormat;e=e.replace(/DD/ig,this.ZeroInt(f));e=e.replace(/MM/ig,this.ZeroInt(a+1));e=e.replace(/YY(YY)?/ig,g);if(typeof c!=undefined&&typeof b!=undefined){e+=" "+c+":"+b+":00"}return e},ZeroInt:function(a){a=parseInt(a,10);if(isNaN(a)){a=0}return a<10?"0"+a.toString():a.toString()},SaveConfig:function(){this.Request("search_save_config",{adv_mode:this.bShowAdvanced?1:0,subdir:this.pSearchSubdir.checked?1:0,entire:this.pSearchEntire.checked?1:0,case_sens:this.pSearchCase.checked?1:0,dirs_too:this.pSearchDirsToo.checked?1:0},false,false)}};function BXFMServerPerm(a){this.Params=a;this.Params.bWindows=false;this.Init()}BXFMServerPerm.prototype={Init:function(){var c=this;this.pButSave=BX("bx_sp_save");this.pButApply=BX("bx_sp_apply");this.pButCancel=BX("bx_sp_cancel");this.pNoteSuccess=BX("bxsp_note_success");this.pRecursive=BX("bxsp_recurcive");this.InProcessMess=FM_MESS.InProcess+"...";this.pNoteErrors=BX("bxsp_note_errors");this.pNoteErrorsCont=BX("bxsp_note_errors_cont");this.pButSave.onclick=function(){return c.Process(true)};this.pButApply.onclick=function(){return c.Process(false)};this.pButCancel.onclick=function(){if(c.xhr){if(c.xhr){c.xhr.abort()}c.xhr=false;c.bOnResultDenied=true;if(c.pCurValDiff){c.pCurValDiff.style.display="none"}c.pButSave.disabled=c.pButApply.disabled=false;c.pButCancel.value=FM_MESS.Return;c.pButCancel.Title=FM_MESS.ReturnTitle;for(var d=1,e=c.pFileList.rows.length;d<e;d++){cell=c.pFileList.rows[d].cells[3];if(cell.innerHTML==c.InProcessMess){cell.innerHTML=FM_MESS.Stoped}}}else{window.location=c.Params.backUrl}};this.pFileList=BX("bxsp_file_list");this.pCurValDiff=BX("bxsp_cur_val_diff");var b,a;this.arOwners=["owner","group","public"];this.arFields={};this.pResVal=BX("bxsp_res_value");this.pResVal.onblur=BX.proxy(this.SetValue2Checkboxes,this);this.pResVal.onkeyup=function(){if(this.value.length>=3){c.SetValue2Checkboxes()}};for(b=0;b<3;b++){a=this.arOwners[b];this.arFields[a]={read:BX("bxsp_"+a+"_read"),write:BX("bxsp_"+a+"_write"),exec:BX("bxsp_"+a+"_exec"),value:BX("bxsp_"+a+"_value")};this.arFields[a].read.onclick=this.arFields[a].write.onclick=this.arFields[a].exec.onclick=BX.proxy(this.ChOnChange,this)}if(this.Params.currentValue){this.pResVal.value=this.Params.currentValue;this.SetValue2Checkboxes()}},ChOnChange:function(){var a="",c,b,d;for(c=0;c<3;c++){b=this.arOwners[c];d=(this.arFields[b].read.checked?"1":"0")+(this.arFields[b].write.checked?"1":"0")+(this.arFields[b].exec.checked?"1":"0");d=parseInt(d,2);this.arFields[b].value.value=d;a+=d}this.pResVal.value=a},SetValue2Checkboxes:function(){var e,c,f,d="",b,a=this.pResVal.value||"";if(a.length!=3){a="000"}for(e=0;e<3;e++){f=parseInt(a.substr(e,1));if(isNaN(f)||f>7||f<0){f=0}d+=f.toString();c=this.arOwners[e];this.arFields[c].value.value=f;b=f.toString(2);if(b.length==1){b="00"+b}if(b.length==2){b="0"+b}this.arFields[c].read.checked=b.substr(0,1)==1;this.arFields[c].write.checked=b.substr(1,1)==1;this.arFields[c].exec.checked=b.substr(2,1)==1}this.pResVal.value=d},Request:function(c,d,b,a){a=a!==false;if(a){BX.showWait()}return BX.ajax.post("/bitrix/admin/fileman_server_access.php?lang="+this.Params.lang+"&fu_action="+c+"&site="+this.Params.site+"&"+this.Params.sessid_get,d||{},function(e){if(a){BX.closeWait()}if(b){setTimeout(function(){b(e)},100)}})},Process:function(e){var c,d,b=this.Params.arFiles.length,a=[],g=this.pFileList.rows.length,f=this;this.bOnResultDenied=false;for(d=0;d<b;d++){a.push(this.Params.arFiles[d]["NAME"])}for(d=1;d<g;d++){this.pFileList.rows[d].cells[3].innerHTML=this.InProcessMess}this.pNoteSuccess.style.display="none";this.pNoteErrors.style.display="none";BX.cleanNode(this.pNoteErrorsCont);BX.removeClass(this.pFileList,"bxsp-file-list-init");var h={files:a,recurcive:(this.pRecursive&&this.pRecursive.checked)?"Y":"N",path:this.Params.path};if(this.Params.bSearch){h.search="Y";h.ssess=this.Params.searchSess}h.res_value=this.pResVal.value;var k=function(E){if(f.bOnResultDenied){return}var u,s=window.spResult.length,m,y,o,z,q,A,x,w,v,D,C,t,B,p=f.Params.arFiles.length;for(u=0;u<s;u++){o=window.spResult[u][0];z=false;for(t=0;t<p;t++){B=f.Params.arFiles[t]["PATH"];q=f.pResVal.value;if(o==B){A=BX("bxsp_file_row_"+t);A.cells[2].innerHTML="<b>"+q+"</b>";A.cells[2].title="";if(window.spResult[u][1]){A.cells[3].innerHTML="<span class='bxsp-green'>"+FM_MESS.Ok+"</span>"}else{A.cells[3].innerHTML="<span class='bxsp-red'>"+FM_MESS.Error+"</span>"}z=true;break}}if(!z&&!window.spResult[u][1]){f.pNoteErrors.style.display="block";f.pNoteErrorsCont.appendChild(BX.create("DIV",{text:o}))}}if(window.spBtimeout){h.last_path=window.spLastPath;f.xhr=f.Request("change_perms",h,k)}else{if(f.pCurValDiff){f.pCurValDiff.style.display="none"}f.pNoteSuccess.style.display="block";f.pButSave.disabled=f.pButApply.disabled=false;f.pButCancel.value=FM_MESS.Return;f.pButCancel.Title=FM_MESS.ReturnTitle;f.xhr=false;if(e){setTimeout(function(){window.location=f.Params.backUrl},500)}}};if(this.xhr){this.xhr.abort()}this.xhr=this.Request("change_perms",h,k);this.pButSave.disabled=this.pButApply.disabled=true;this.pButCancel.value=FM_MESS.Stop;this.pButCancel.Title=FM_MESS.StopTitle;return false}};function BXFMCopy(a){this.Init(a)}BXFMCopy.prototype={Init:function(a){if(this.bInited){return true}this.oCopyDialog=a.oCopyDialog;BX.addClass(this.oCopyDialog.PARTS.CONTENT,"bx-fm-copy-dialog");BX.cleanNode(this.oCopyDialog.PARTS.CONTENT_DATA);this.oCopyDialog.PARTS.CONTENT_DATA.appendChild(BX("bx_copy_dialog"));this.arLastPathes=a.arLastPathes;var b=this;this.pAddLink=BX("bx_copy_add_lnk");this.pCopyTbl=BX("bx_copy_table");this.pFilelist=BX("bx_copy_file_list");this.pCopyTo=BX("bx_copy_to");this.pCaseAsk=BX("bx_copy_ask_user");this.pCaseReplace=BX("bx_copy_replace");this.pCaseAutoRename=BX("bx_copy_auto_rename");this.pCaseSkip=BX("bx_copy_skip");this.pCaseAsk.onclick=this.pCaseReplace.onclick=this.pCaseAutoRename.onclick=this.pCaseSkip.onclick=function(){if(this.checked){b.caseOption=this.value}b.SaveConfig()};this.lang=a.lang;this.site=a.site;this.sessid_get=a.sessid_get;BX("bx_copy_dialog").style.display="block";this.viewMsFilePath=a.viewMsFilePath;this.viewMsFolderPath=a.viewMsFolderPath;this.oSiteSel=new BXFMSiteSel({id:"site_sel_copy",pDiv:BX("bx_copy_site_sel"),sites:a.arSites});this.oCopyTo=new BXFMInpSel({id:"cm_copy_to",pInput:this.pCopyTo,Items:this.arLastPathes});this.pAddLink.onclick=function(){var d="bx-copy-cont-tbl-add-hide",c=b.pCopyTbl.className.indexOf(d)==-1;b.bShowAdvanced=!c;if(c){BX.addClass(b.pCopyTbl,d)}else{BX.removeClass(b.pCopyTbl,d)}b.oCopyDialog.adjustSizeEx();b.SaveConfig();return false};this.caseOption="ask";if(a.oUserConfig){this.bShowAdvanced=a.oUserConfig.advMode;if(this.bShowAdvanced){BX.removeClass(b.pCopyTbl,"bx-copy-cont-tbl-add-hide")}else{BX.addClass(b.pCopyTbl,"bx-copy-cont-tbl-add-hide")}this.caseOption=a.oUserConfig.caseOption||"ask"}switch(this.caseOption){case"ask":this.pCaseAsk.checked=true;break;case"replace":this.pCaseReplace.checked=true;break;case"auto_rename":this.pCaseAutoRename.checked=true;break;case"skip":this.pCaseSkip.checked=true;break}BX.addCustomEvent(this.oCopyDialog,"onWindowUnRegister",BX.proxy(this.OnClose,this));this.bInited=true},OnOpen:function(d){this.bCopy=d.bCopy;this.arFiles=[];this.curPath=d.path;this.bSearch=!!d.bSearch;this.searchSess=d.ssess;if(typeof d.arFiles=="object"){this.arFiles=d.arFiles}var c=this.oCopyDialog.PARAMS.buttons[0];if(this.bCopy){this.oCopyDialog.SetTitle(FM_MESS.CopyTitle);c.btn.value=c.title=FM_MESS.Copy}else{this.oCopyDialog.SetTitle(FM_MESS.MoveTitle);c.btn.value=c.title=FM_MESS.Move}BX.cleanNode(this.pFilelist);var b,a=this.arFiles.length;for(b=0;b<a;b++){this.pFilelist.appendChild(BX.create("A",{props:{href:this.GetViewUrl(this.arFiles[b]),target:"_blank"},text:this.GetFileName(this.arFiles[b].path)}));if(b==1&&a>3){this.pFilelist.appendChild(document.createTextNode(" ("+FM_MESS.More.replace("#COUNT#",parseInt(a-b-1))+")"));break}else{if(b<a-1){this.pFilelist.appendChild(document.createTextNode(", "))}}}this.oCopyDialog.adjustSizeEx();BX.bind(BX.browser.IsIE()?document.body:window,"keydown",BX.proxy(this.OnKeyDown,this))},OnClose:function(){BX.unbind(BX.browser.IsIE()?document.body:window,"keydown",BX.proxy(this.OnKeyDown,this))},OnKeyDown:function(a){if(!a){a=window.event}if(window.oBXFileDialog&&window.oBXFileDialog.bOpened){return}if(this.oCopyDialog.isOpen&&a.keyCode==13&&(!this.oAskUserDialog||!this.oAskUserDialog.isOpen)){return this.Process()}},Process:function(c){var e=this,b=this.bCopy?"copy":"move",d={case_option:this.caseOption,files:this.arFiles,copy_to:this.pCopyTo.value},a=function(){if(window.BXFM_NoCopyToDir){if(window.BXFM_NoCopyToDir=="ask_user"&&confirm(FM_MESS.NoFolder.replace("#FOLDER#",e.pCopyTo.value))){d.create_copy_to="Y";e.Request(b,d,a)}else{if(window.BXFM_NoCopyToDir=="access_denied"){alert(FM_MESS.NoFolderNoAccess.replace("#FOLDER#",e.pCopyTo.value))}}window.BXFM_result=null;window.BXFM_NoCopyToDir=null}if(window.BXFM_fileExist){e.ShowAskUserDialog(window.BXFM_fileExist);window.BXFM_fileExist=null}if(window.BXFM_result){var g="";if(window.BXFM_result.status!="ok"){for(var h=0,f=window.BXFM_result.errors.length;h<f;h++){g+=window.BXFM_result.errors[h]+"\n"}}if(g!=""){alert(g)}else{if(!e.bCopy||e.pCopyTo.value===e.curPath){window.location=e.bSearch?window.location:(e.viewMsFolderPath+e.site).replace("#PATH#",BX.util.urlencode(e.curPath))}e.oCopyDialog.Close()}}};if(c){d.uc_answer=c.userCase;d.uc_to_all=c.applyToAll;d.uc_last_path=c.handledFilePath}if(this.bSearch){d.search="Y";d.ssess=this.searchSess}window.BXFM_noCopyToDir=window.BXFM_fileExist=window.BXFM_result=null;this.Request(b,d,a)},GetFileName:function(c){var a=c,b=c.lastIndexOf("/");if(b!==-1){a=c.substr(b+1)}return a},GetViewUrl:function(b,a){var a=a||[false,""];if(a[0]){return((!!b.isDir?this.viewMsFolderPath:this.viewMsFilePath)+a[1]).replace("#PATH#",BX.util.urlencode(b.path))}return((!!b.isDir?this.viewMsFolderPath:this.viewMsFilePath)+this.site).replace("#PATH#",BX.util.urlencode(b.path))},SaveConfig:function(){this.Request("copy_save_config",{adv_mode:this.bShowAdvanced?1:0,case_option:this.caseOption},false,false)},Request:function(d,e,c,a){a=a!==false;if(a){BX.showWait()}var b="/bitrix/admin/fileman_admin.php?lang="+this.lang+"&fu_action="+d+"&site="+this.site+"&"+this.sessid_get+"&fu_site="+this.oSiteSel.value;return BX.ajax.post(b,e||{},function(f){if(a){BX.closeWait()}if(c){setTimeout(function(){c(f)},100)}})},ShowAskUserDialog:function(c){var d=this;if(!this.oAskUserDialog){this.oAskUserDialog=new BX.CAdminDialog({title:"",content:"&nbsp;",height:240,width:600,resizable:false});this.oAskUserDialog.SetButtons([new BX.CWindowButton({title:FM_MESS.Replace,name:"replace",id:"ask_replace",action:function(){d.UserAnswer("replace")}}),new BX.CWindowButton({title:FM_MESS.Skip,name:"skip",action:function(){d.UserAnswer("skip")}}),new BX.CWindowButton({title:FM_MESS.Rename,name:"rename",action:function(){d.UserAnswer("auto_rename")}}),this.oAskUserDialog.btnCancel]);BX.addClass(this.oAskUserDialog.PARTS.CONTENT,"bx-fm-copy-dialog");BX.addClass(this.oAskUserDialog.PARTS.FOOT,"bx-core-dialog-foot-ask");setTimeout(function(){var e=BX("bx_copy_ask_dialog");d.oAskUserDialog.SetContent(e);e.style.display="block";d.pAskToAllCont=e.appendChild(BX.create("DIV",{props:{className:"bx-copy-to-all"},html:"<table><tr><td><input type='checkbox' id='bx_copy_ask_to_all'></td><td><label  for='bx_copy_ask_to_all'>"+FM_MESS.ToAll+"</label></td></tr></table>"}));d.oAskUserDialog.adjustSizeEx();BX.adminPanel.modifyFormElements(e)},50);this.pAskFileName=BX("bx_copy_ask_file_name");this.pAskFolderName=BX("bx_copy_ask_folder");this.pAskSizeRow=BX("bx_copy_ask_size_row");this.pAskFileNew={pName:BX("bx_copy_ask_file1"),pSize:BX("bx_copy_ask_size1"),pDate:BX("bx_copy_ask_date1")};this.pAskFileOld={pName:BX("bx_copy_ask_file2"),pSize:BX("bx_copy_ask_size2"),pDate:BX("bx_copy_ask_date2")};this.pNewNameCont=BX("bxc_ask_nn_cont1");this.pRenBut=this.oAskUserDialog.PARAMS.buttons[2].btn;this.pRenBut.onmouseover=function(){d._NewNamebShow=true;d._ShadeIn(true)};this.pRenBut.onmouseout=function(){d._NewNamebShow=false;setTimeout(function(){d._ShadeIn(false)},3000)};BX.addCustomEvent(this.oAskUserDialog,"onWindowUnRegister",function(){d.oCopyTo.bDenyOpenPopup=false})}this.oAskUserDialog.Show();this.oCopyTo.bDenyOpenPopup=true;this.oAskUserDialog.adjustSizeEx();this.oAskUserDialog.SetTitle(c.fileNew.bDir?FM_MESS.FolderExistTitle:FM_MESS.FileExistTitle);var b=BX("ask_replace");if(this.curPath.replace(/[\s\r\n\/]+$/g,"")==this.pCopyTo.value.replace(/[\s\r\n\/]+$/g,"")&&b){b.disabled=true}else{b.disabled=false}if(this.arFiles.length<=1){this.oAskUserDialog.PARAMS.buttons[1].btn.style.display="none"}else{this.oAskUserDialog.PARAMS.buttons[1].btn.style.display=""}setTimeout(function(){d.pAskToAllCont.style.marginLeft=parseInt(d.oAskUserDialog.PARAMS.buttons[0].btn.offsetLeft)+"px";BX("bx_copy_ask_to_all").disabled=!!(d.arFiles.length<=1)},200);var a=[false,""];if(c.fileNew.site&&c.fileOld.site&&c.fileNew.site!==c.fileOld.site){a=[true,c.fileOld.site]}this.pAskFileName.innerHTML=c.fileNew.name;this.pAskFolderName.innerHTML=this.pCopyTo.value;this.pAskFileOld.pName.innerHTML=this.pAskFileOld.pName.title=c.fileOld.name;this.pAskFileOld.pName.href=this.GetViewUrl({isDir:c.fileOld.bDir,path:c.fileOld.path},a);this.pAskFileOld.pDate.innerHTML=c.fileOld.date;this.pAskFileNew.pName.innerHTML=this.pAskFileNew.pName.title=c.fileNew.name;this.pAskFileNew.pName.href=this.GetViewUrl({isDir:c.fileNew.bDir,path:c.fileNew.path});this.pAskFileNew.pDate.innerHTML=c.fileNew.date;this.oAskUserDialog.newFilePath=c.fileNew.path;if(c.fileNew.size=="-"){this.pAskSizeRow.style.display="none"}else{this.pAskSizeRow.style.display="";this.pAskFileOld.pSize.innerHTML=c.fileOld.size;this.pAskFileNew.pSize.innerHTML=c.fileNew.size}this.pNewNameCont.innerHTML=this.pNewNameCont.title=c.fileNew.alt_name;this.pRenBut.title=FM_MESS.RenameTitle.replace("#NEW_NAME#",c.fileNew.alt_name)},UserAnswer:function(a){this.Process({userCase:a,applyToAll:BX("bx_copy_ask_to_all").checked?1:0,handledFilePath:this.oAskUserDialog.newFilePath});this.oAskUserDialog.Close()},_ShadeIn:function(a){if(this._NewNamebShow!=a){return}var c=this;if(this._shadeInInterval){clearInterval(this._shadeInInterval);this._shadeInInterval=false}var b=a?0:3;this._shadeInInterval=setInterval(function(){if(a){b++}else{b--}c.pNewNameCont.className="bx-copy-new-name bxcnn-"+b;if(b==0||b==3){clearInterval(c._shadeInInterval);c._shadeInInterval=false}},100)}};var BXFMInpSel=function(a){if(!a.Items||!a.Items.length||!a.pInput){return}if(a.popupWidth&&!isNaN(parseInt(a.popupWidth))){this.popupWidth=parseInt(a.popupWidth)}this.id=a.id;this.Items=a.Items;this.pInput=a.pInput;this.posCorrection=a.posCorrection||{left:2,top:21};this.onChange=typeof a.OnChange=="function"?a.OnChange:false;this.onEnterPress=typeof a.OnEnterPress=="function"?a.OnEnterPress:false;this.NoValueMess=a.NoValueMess||"";this.selItemInd=false;BX.addClass(this.pInput,"bxfm-is-inp");var b=this;this.pInput.onclick=function(c){if(b.selItemInd!==false){b.DeSelectItem(b.selItemInd)}if(this.value==b.NoValueMess){BX.removeClass(this,"bxfm-is-label");this.value=""}else{if(this.value!=""){b.bCheckValue=true;b.CheckValue(false)}}b.ShowPopup();return BX.PreventDefault(c)};this.pInput.onfocus=function(){if(this.value==b.NoValueMess){BX.removeClass(this,"bxfm-is-label");this.value=""}};this.pInput.onblur=function(){if(!b.bPopupShowed){b.OnChange()}};if(this.pInput.value==""){this.OnChange(false)}this.pInput.autocomplete="off";this.pInput.onkeyup=function(c){if(b.bDenyOpenPopup){return true}if(!c){c=window.event}if(!c.altKey&&!c.ctrlKey&&c.keyCode!=17&&c.keyCode!=18&&c.keyCode!=16&&c.keyCode!=27&&c.keyCode!=13){return b.CheckValue(true)}};this.pInput.onkeydown=function(c){return b.OnKeyDown(c)}};function BXFMPack(a){this.Init(a)}BXFMPack.prototype={Init:function(a){if(this.bInited){return true}this.oPackDialog=a.oPackDialog;BX.addClass(this.oPackDialog.PARTS.CONTENT,"bx-fm-pack-dialog");BX.cleanNode(this.oPackDialog.PARTS.CONTENT_DATA);this.oPackDialog.PARTS.CONTENT_DATA.appendChild(BX("bx_pack_dialog"));this.arLastPathes=a.arLastPathes;this.pPackCancel=BX("cancel-pack");this.pPackCancel.onclick=function(){if(b.bPacking){b.oPackDialog.SetTitle(FM_MESS.PackFinishing);b.bStopPacking=true;if(b.Params&&b.Params.fileOld){b.Params.fileOld=null;b.bPacking=false;b.oPackDialog.Close()}}else{b.oPackDialog.Close()}};var b=this;this.pCopyTbl=BX("bx_pack_table");this.pFilelist=BX("bx_pack_file_list");this.pPackTo=BX("bx_pack_to");this.pCaseReplace=BX("bx_pack_replace");this.pCaseSkip=BX("bx_pack_skip");this.pCaseReplace.onclick=this.pCaseSkip.onclick=function(){if(this.checked){b.caseOption=this.value}};this.lang=a.lang;this.site=a.site;this.sessid_get=a.sessid_get;BX("bx_pack_dialog").style.display="block";this.viewMsFilePath=a.viewMsFilePath;this.viewMsFolderPath=a.viewMsFolderPath;this.oArcTypeSel=new BXFMArcTypeSel({id:"arc_type_pack",pDiv:BX("bx_pack_arc_type"),types:a.arTypes,bPack:true,typeChangeCallback:function(c){b.ChangeType(c)}});this.oPackTo=new BXFMInpSel({id:"cm_pack_to",pInput:this.pPackTo,Items:this.arLastPathes});this.oSiteSel=new BXFMSiteSel({id:"site_sel_pack",pDiv:BX("bx_pack_site_sel"),sites:a.arSites});this.caseOption="skip";BX.removeClass(b.pCopyTbl,"bx-pack-cont-tbl-add-hide");switch(this.caseOption){case"replace":this.pCaseReplace.checked=true;break;case"skip":this.pCaseSkip.checked=true;break}BX.addCustomEvent(this.oPackDialog,"onWindowUnRegister",BX.proxy(this.OnClose,this));this.pCaseSkip=BX("bx_pack_skip");this.pCaseReplace.onclick=this.pCaseSkip.onclick=function(){if(this.checked){b.caseOption=this.value}};BX.addCustomEvent(this.oPackDialog,"onBeforeWindowClose",function(){b.oPackDialog.denyClose=false;if(b.bPacking){if(!b.forceClose){b.oPackDialog.SetTitle(FM_MESS.PackFinishing);b.bStopPacking=true;if(b.Params&&b.Params.fileOld){b.Params.fileOld=null}else{b.oPackDialog.denyClose=true}}}});this.bInited=true},OnOpen:function(e){this.bPack=e.bPack;this.arFiles=[];this.curPath=e.path;this.bStopPacking=false;this.bPacking=false;this.forceClose=false;this.bSearch=!!e.bSearch;this.searchSess=e.ssess;if(typeof e.arFiles=="object"){this.arFiles=e.arFiles}if(e.arFiles[0]&&e.arFiles[0]=="action_target"){this.arFiles=[{path:e.path,isDir:"1"}]}var b=this.oPackDialog.PARAMS.buttons[1];b.btn.value=FM_MESS.PackCancel;clearInterval(this.counterID);this.pPackTo.value=this.GeneratePath(this.bPack,this.arFiles,"."+this.oArcTypeSel.value.toLowerCase());var d=this.oPackDialog.PARAMS.buttons[0];if(this.bPack){this.oPackDialog.SetTitle(FM_MESS.PackTitle);d.btn.value=d.title=FM_MESS.Pack;if(this.oArcTypeSel.arcTypes.length==1){BX.addClass(this.oArcTypeSel.pDiv,"bx-fm-non-selectable");BX.unbindAll(this.oArcTypeSel.pDiv)}else{BX.removeClass(this.oArcTypeSel.pDiv,"bx-fm-non-selectable");BX.bind(this.oArcTypeSel.pDiv,"click",BX.proxy(this.oArcTypeSel.ShowPopup,this.oArcTypeSel))}BX("bxfm-arctype-line").style.display="table-row";BX("bxfm-pack-option-replace").style.display="none";BX("bxfm-pack-option-skip").style.display="none";BX("bx-pack-d-title-label").style.display="none";this.pCaseSkip.checked=true;this.caseOption="ask"}else{this.oPackDialog.SetTitle(FM_MESS.UnpackTitle);d.btn.value=d.title=FM_MESS.Unpack;BX("bxfm-arctype-line").style.display="none";BX("bx-pack-d-title-label").style.display="table-row";BX("bxfm-pack-option-skip").style.display="table-row";BX("bxfm-pack-option-replace").style.display="table-row";this.pCaseSkip.checked=true;this.caseOption="skip"}BX("ok-pack").disabled=false;BX.cleanNode(this.pFilelist);var c,a=this.arFiles.length;for(c=0;c<a;c++){this.pFilelist.appendChild(BX.create("A",{props:{href:this.GetViewUrl(this.arFiles[c],this.site),target:"_blank"},text:this.GetFileName(this.arFiles[c])}));if(c==1&&a>3){this.pFilelist.appendChild(document.createTextNode(" ("+FM_MESS.More.replace("#COUNT#",parseInt(a-c-1))+")"));break}else{if(c<a-1){this.pFilelist.appendChild(document.createTextNode(", "))}}}this.oPackDialog.adjustSizeEx();BX.bind(BX.browser.IsIE()?document.body:window,"keydown",BX.proxy(this.OnKeyDown,this))},OnClose:function(){clearInterval(this.counterID);BX.unbind(BX.browser.IsIE()?document.body:window,"keydown",BX.proxy(this.OnKeyDown,this))},OnKeyDown:function(a){if(!a){a=window.event}if(window.oBXFileDialog&&window.oBXFileDialog.bOpened){return}if(this.oPackDialog.isOpen&&a.keyCode==13&&(!this.oAskUserDialog||!this.oAskUserDialog.isOpen)){return this.Process()}},Process:function(e){var c=null;if(e){switch(e.userCase){case"rename":var a=this.GetFolderPath(this.pPackTo.value);this.pPackTo.value=a+e.newName;break;case"replace":c="replace";break}}var g=this,d=this.bPack?"pack":"unpack",f={case_option:this.caseOption,files:this.arFiles,packTo:this.pPackTo.value,siteTo:this.oSiteSel.value,startFile:"",quickPath:BX("quick_path").value,arcType:this.oArcTypeSel.value,bPackReplace:c};if(this.counterID){clearInterval(this.counterID)}BX("ok-pack").disabled=true;this.counterID=setInterval(function(){if((g.oPackDialog.PARAMS.title.split(".").length-1)<3){this.oPackDialog.SetTitle(g.oPackDialog.PARAMS.title+" .")}else{this.oPackDialog.SetTitle(g.oPackDialog.PARAMS.title.split(" .")[0])}},500);var b=function(){if(!g.oPackDialog.isOpen){return}if(g.bStopPacking){if(g.bPack&&!window.BXFM_archiveExists){var h=g.GetFileName(f.packTo),k=g.GetFolderPath(f.packTo),j="/bitrix/admin/fileman_admin.php?action=delete&ID="+h+"&path="+k+"&"+g.sessid_get+"&lang="+g.lang+"&site="+g.site;g.bStopPacking=false;tbl_fileman_admin.GetAdminList(j,function(){g.forceClose=true;g.oPackDialog.Close()});return}else{g.forceClose=true;g.oPackDialog.Close();return}}if(window.BXFM_archivePermsError){alert(FM_MESS.PackPermsError);BX("ok-pack").disabled=false;window.BXFM_archivePermsError=null;g.oPackDialog.Close()}else{if(window.BXFM_archiveExists){g.ShowAskUserDialog(window.BXFM_archiveExists);window.BXFM_archiveExists=null;BX("ok-pack").disabled=false}else{if(window.BXFM_archiveFNameError){alert(FM_MESS.PackFNameError);BX("ok-pack").disabled=false;window.BXFM_archiveFNameError=null;g.forceClose=true;g.oPackDialog.Close()}else{switch(d){case"pack":if(window.fmPackTimeout){f.startFile=window.fmPackLastFile}else{if(window.fmPackSuccess){g.forceClose=true;g.oPackDialog.Close();var i=g.GetFolderPath(f.packTo);i=(i.length==(i.lastIndexOf("/")+1)&&i.length!==1)?i.substr(0,i.length-1):i;window.location=(g.viewMsFolderPath+g.oSiteSel.value).replace("#PATH#",BX.util.urlencode(i));return}else{if(window.fmPackErrors){alert(FM_MESS.PackError+": "+window.fmPackErrors)}else{alert(FM_MESS.PackError)}BX.closeWait();g.forceClose=true;g.oPackDialog.Close();return}}break;case"unpack":if(window.fmUnpackSuccess){g.forceClose=true;g.oPackDialog.Close();var i=g.GetFolderPath(f.packTo);i=(i.length==(i.lastIndexOf("/")+1)&&i.length!==1)?i.substr(0,i.length-1):i;window.location=(g.viewMsFolderPath+f.siteTo).replace("#PATH#",BX.util.urlencode(i));return}else{if(window.fmUnpackErrors){alert(FM_MESS.UnpackError+": "+window.fmUnpackErrors)}else{alert(FM_MESS.UnpackError)}BX.closeWait();g.forceClose=true;g.oPackDialog.Close();return}break}if(d=="pack"){if(g.rq){g.rq.abort()}g.rq=g.Request(d,f,b)}}}}};this.bPacking=true;this.rq=this.Request(d,f,b)},GetFolderPath:function(b){var c=b;var a=c.lastIndexOf("/");if(a!="-1"){c=c.slice(0,a)}if(c!="/"){c+="/"}return c},GetFileName:function(c){if(typeof c=="object"){c=c.path}var a=c,b=c.lastIndexOf("/");if(b!==-1&&c.length!==1){a=c.substr(b+1)}return a},MakeArchiveName:function(b){var a=b.substr(b.lastIndexOf("/")+1);if(a.slice(-7)==".tar.gz"){a=a.slice(0,-7)}else{if(a.lastIndexOf(".")!=-1&&a.lastIndexOf(".")!=0){a=a.slice(0,a.lastIndexOf("."))}}return a},MakeFolderArchiveName:function(b){var a=b.substr(b.lastIndexOf("/")+1);return a},GeneratePath:function(e,c,b){if(e&&c.length==1&&!!c[0].isDir==true){return this.GetFolderPath(c[0].path)+this.MakeFolderArchiveName(c[0].path)+b}if(e&&c.length>0){var a=c.length==1?c[0].path:"archive";return this.GetFolderPath(this.arFiles[0].path)+this.MakeArchiveName(a)+b}if(!e){var d=c[0];return this.GetFolderPath(d)}},ChangeType:function(a){a=a.toLowerCase();if(this.arFiles){this.pPackTo.value=this.GeneratePath(this.bPack,this.arFiles,"."+a)}},GetViewUrl:function(b,a){if(typeof b=="object"){return((b.isDir?this.viewMsFolderPath:this.viewMsFilePath)+a).replace("#PATH#",BX.util.urlencode(b.path))}return(this.viewMsFilePath+a).replace("#PATH#",BX.util.urlencode(b))},Request:function(d,e,c,a){a=a!==false;if(a){BX.showWait()}var b="/bitrix/admin/fileman_admin.php?lang="+this.lang+"&fu_action="+d+"&site="+this.site+"&"+this.sessid_get;if(d=="pack"){BX.addClass(this.oArcTypeSel.pDiv,"bx-fm-non-selectable");BX.unbindAll(this.oArcTypeSel.pDiv)}return BX.ajax.post(b,e||{},function(f){if(a){BX.closeWait()}if(c){setTimeout(function(){c(f)},100)}})},ShowAskUserDialog:function(a){var b=this;b.Params=a;if(!this.oAskUserDialog){this.oAskUserDialog=new BX.CAdminDialog({title:"",content:"&nbsp;",height:240,width:500,resizable:false});this.oAskUserDialog.SetButtons([new BX.CWindowButton({title:FM_MESS.Replace,name:"replace",action:function(){b.UserAnswer("replace")}}),new BX.CWindowButton({title:FM_MESS.Rename,name:"rename",action:function(){var c=prompt(FM_MESS.AskNewName,b.Params.fileOld.name);b.Params.fileOld.name=null;if(c){b.UserAnswer("rename",c)}}}),this.oAskUserDialog.btnCancel]);BX.addClass(this.oAskUserDialog.PARTS.CONTENT,"bx-fm-pack-dialog");BX.addClass(this.oAskUserDialog.PARTS.FOOT,"bx-core-dialog-foot-ask");setTimeout(function(){var c=BX("bx_pack_ask_dialog");b.oAskUserDialog.SetContent(c);c.style.display="block";b.oAskUserDialog.adjustSizeEx()},50);this.pAskFileName=BX("bx_pack_ask_file_name");this.pAskFolderName=BX("bx_pack_ask_folder");this.pAskSizeRow=BX("bx_pack_ask_size_row");this.pAskFileOld={pName:BX("bx_pack_ask_file2"),pSize:BX("bx_pack_ask_size2"),pDate:BX("bx_pack_ask_date2")};this.pRenBut=this.oAskUserDialog.PARAMS.buttons[2].btn;BX.addCustomEvent(this.oAskUserDialog,"onWindowUnRegister",function(){b.oPackTo.bDenyOpenPopup=false})}this.oAskUserDialog.Show();if(b.counterID){clearInterval(b.counterID)}this.oPackTo.bDenyOpenPopup=true;this.oAskUserDialog.adjustSizeEx();this.oAskUserDialog.SetTitle(FM_MESS.FileExistTitle);this.pAskFileName.innerHTML=a.fileOld.name;this.pAskFolderName.innerHTML=b.GetFolderPath(this.pPackTo.value);this.pAskFileOld.pName.innerHTML=this.pAskFileOld.pName.title=a.fileOld.name;this.pAskFileOld.pName.href=this.GetViewUrl(a.fileOld.path,a.fileOld.site);this.pAskFileOld.pDate.innerHTML=a.fileOld.date;this.pAskFileOld.pSize.innerHTML=a.fileOld.size},UserAnswer:function(b,a){if(b=="replace"){this.Params=null}this.Process({userCase:b,newName:a});this.oAskUserDialog.Close()}};BXFMInpSel.prototype={ShowPopup:function(c){if(this.bPopupShowed||this.bDenyOpenPopup){return}var b=this;if(c!==false){this.pInput.select()}if(!this.bPopupCreated){this.CreatePopup()}this.Popup.style.display="block";this.bPopupShowed=true;setTimeout(function(){BX.bind(document,"click",BX.proxy(b.ClosePopup,b))},100);this.Popup.style.zIndex=1100;var a=jsUtils.GetRealPos(this.pInput);jsFloatDiv.Show(this.Popup,a.left+this.posCorrection.left,a.top+this.posCorrection.top,3);BX.WindowManager.disableKeyCheck()},ClosePopup:function(a){BX.unbind(document,"click",BX.proxy(this.ClosePopup,this));setTimeout(function(){BX.WindowManager.enableKeyCheck()},200);if(!this.Popup||!this.pInput){return}this.Popup.style.display="none";this.bPopupShowed=false;jsFloatDiv.Close(this.Popup);if(a!==false&&this.pInput.value==""){this.OnChange()}if(this.pInput.focus){this.pInput.focus()}},CreatePopup:function(){var d=this,c,b,a=this.Items.length;this.Popup=document.body.appendChild(BX.create("DIV",{props:{className:"bxfm-is-popup"}}));if(!this.popupWidth){this.Popup.style.width=parseInt(this.pInput.offsetWidth)+"px"}this.bPopupCreated=true;for(b=0;b<a;b++){c=this.Popup.appendChild(BX.create("DIV",{props:{id:"bx_"+this.id+"_"+b,title:this.Items[b].name||this.Items[b].title,className:"bxfm-is-item"},text:this.Items[b].name,events:{mouseover:function(){BX.addClass(this,"bxfm-is-item-over")},mouseout:function(){BX.removeClass(this,"bxfm-is-item-over")},click:function(){var e=this.id.substr(("bx_"+d.id+"_").length);d.curInd=e;d.pInput.value=d.Items[e].name;d.OnChange();d.ClosePopup()}}}));this.Items[b].pCont=c}},OnChange:function(a){var b=this.pInput.value;if(b==""||b==this.NoValueMess){BX.addClass(this.pInput,"bxfm-is-label");this.pInput.value=this.NoValueMess;b=""}else{BX.removeClass(this.pInput,"bxfm-is-label")}if(this.onChange&&a!==false){this.onChange({value:b})}},CheckValue:function(c,e){if(!this.bCheckValue){return}var d=false,g,b,a=this.Items.length,f=this.pInput.value;for(b=0;b<a;b++){g=this.Items[b].name;if((g.length>f.length&&g.substr(0,f.length)==f)||g==f){this.SelectItem(b,c);d=true;break}}if(!d&&e!==false){if(this.selItemInd!==false){this.DeSelectItem(this.selItemInd)}this.ClosePopup(false)}},SelectItem:function(c,b){if(!this.bPopupShowed){this.ShowPopup(false)}if(this.selItemInd!==false){this.DeSelectItem(this.selItemInd)}var d=this.Items[c].pCont;if(b){var a=this.pInput.value.length;BX.cleanNode(d);d.appendChild(BX.create("SPAN",{props:{className:"bxfm-highlighted"},text:this.Items[c].name.substr(0,a)}));d.appendChild(document.createTextNode(this.Items[c].name.substr(a)))}this.selItemInd=c;BX.addClass(d,"bxfm-is-item-concur")},DeSelectItem:function(a){BX.cleanNode(this.Items[a].pCont);this.Items[a].pCont.appendChild(document.createTextNode(this.Items[a].name));BX.removeClass(this.Items[a].pCont,"bxfm-is-item-concur");this.selItemInd=false},OnKeyDown:function(b){if(this.bDenyOpenPopup){return true}if(window.oBXFileDialog&&window.oBXFileDialog.bOpened){return}this.bCheckValue=true;if(!b){b=window.event}if(b.keyCode==13){if(!this.bPopupShowed){if(this.onEnterPress){this.onEnterPress({value:this.pInput.value});return BX.PreventDefault(b)}this.bCheckValue=false;return}if(this.selItemInd){this.bCheckValue=false;this.OnChange();this.ClosePopup();return BX.PreventDefault(b)}}else{if(b.keyCode==27){if(!this.bPopupShowed){return}this.ClosePopup();this.bCheckValue=false;return BX.PreventDefault(b)}else{if(b.keyCode==40||b.keyCode==38){var a;if(b.keyCode==40){if(!this.bPopupShowed){this.CheckValue(false,false);this.bCheckValue=false;this.ShowPopup(false);return}a=this.selItemInd===false?0:this.selItemInd+1;if(a>this.Items.length-1){a=0}}else{if(!this.bPopupShowed){return}a=this.selItemInd===false?this.Items.length-1:this.selItemInd-1;if(a<0){a=this.Items.length-1}}this.pInput.value=this.Items[a].name;this.SelectItem(a,false);this.bCheckValue=false;return BX.PreventDefault(b)}else{if(b.keyCode==39){if(this.selItemInd!==false&&this.bPopupShowed){this.pInput.value=this.Items[this.selItemInd].name;this.SelectItem(this.selItemInd,false);this.bCheckValue=false;this.ClosePopup()}}}}}}};var BXFMSiteSel=function(c){this.pDiv=c.pDiv;this.sites=c.sites;var b,a=this.sites.length;if(a==1){this.bOne=true;this.pDiv.style.display="none";return this.SetSite(0,false)}this.pTitle=this.pDiv.appendChild(BX.create("DIV"));this.pDiv.onclick=BX.proxy(this.ShowPopup,this);this.id=c.id||"site_sel";for(b=0;b<a;b++){if(this.sites[b].current){this.SetSite(b,false);break}}};BXFMSiteSel.prototype={ShowPopup:function(){if(this.bShowed){return this.ClosePopup()}this.bShowed=true;var b=this;if(!this.bCreated){this.CreatePopup()}var a=BX.pos(this.pDiv);this.Popup.style.display="block";this.Popup.style.zIndex=1100;this.Popup.style.top=(a.top+18)+"px";this.Popup.style.left=a.left+"px";BX.WindowManager.disableKeyCheck();setTimeout(function(){BX.bind(document,"click",BX.proxy(b.ClosePopup,b))},100);BX.bind(document,"keydown",BX.proxy(this.OnKeyDown,this))},ClosePopup:function(){BX.unbind(document,"click",BX.proxy(this.ClosePopup,this));BX.unbind(document,"keydown",BX.proxy(this.OnKeyDown,this));setTimeout(function(){BX.WindowManager.enableKeyCheck()},200);if(!this.Popup){return}this.Popup.style.display="none";this.bShowed=false},CreatePopup:function(){var e=this,b,d,c,a=this.sites.length;this.Popup=document.body.appendChild(BX.create("DIV",{props:{className:"bxfm-at-is-popup"}}));this.Popup.style.width="200px";this.bCreated=true;for(c=0;c<a;c++){b=this.sites[c];d=this.Popup.appendChild(BX.create("SPAN",{props:{id:"bx_"+this.id+"_"+c,title:BX.util.htmlspecialchars(b.text),className:"bxfm-site-sel-it"},events:{mouseover:function(){BX.addClass(this,"bxfm-ss-over")},mouseout:function(){BX.removeClass(this,"bxfm-ss-over")},click:function(){var f=this.id.substr(("bx_"+e.id+"_").length);e.SetSite(parseInt(f),true);e.ClosePopup()}}}));d.appendChild(BX.create("DIV",{props:{className:"bxfm-text-overflow"},text:b.text}));if(this.curSiteInd===c){BX.addClass(d,"bxfm-ss-checked")}this.sites[c].row=d}},SetSite:function(b){var a=this.sites[b];if(!a){return}if(!this.bOne&&typeof this.curSiteInd!="undefined"&&this.sites[this.curSiteInd]&&this.sites[this.curSiteInd].row){BX.removeClass(this.sites[this.curSiteInd].row,"bxfm-ss-checked")}this.value=a.id;this.curSiteInd=b;BX("bx_copy_to").value=a.dir;BX("bx_copy_to").focus();if(this.bOne){return}this.pTitle.innerHTML=a.id.toUpperCase();if(this.sites[b].row){BX.addClass(this.sites[b].row,"bxfm-ss-checked")}},OnKeyDown:function(a){if(!a){a=window.event}if(window.oBXFileDialog&&window.oBXFileDialog.bOpened){return}if(a.keyCode==27){return this.ClosePopup()}}};var BXFMArcTypeSel=function(b){this.pDiv=b.pDiv;this.arcTypes=b.types;this.bPack=b.bPack;this.typeChangeCallback=b.typeChangeCallback;var a=this.arcTypes.length;if(a==1){this.bOne=true;BX.addClass(this.pDiv,"bx-fm-non-selectable");this.pDiv.innerHTML=this.arcTypes[0].text.toUpperCase();return this.SetArcType(0,false)}this.pTitle=this.pDiv.appendChild(BX.create("DIV"));BX.bind(this.pDiv,"click",BX.proxy(this.ShowPopup,this));this.id=b.id||"arc_type_pack";this.SetArcType(0,false)};BXFMArcTypeSel.prototype={ShowPopup:function(){if(this.bShowed){return this.ClosePopup()}this.bShowed=true;var b=this;if(!this.bCreated){this.CreatePopup()}var a=BX.pos(this.pDiv);this.Popup.style.display="block";this.Popup.style.zIndex=1200;this.Popup.style.top=(a.top+18)+"px";this.Popup.style.left=a.left+"px";BX.WindowManager.disableKeyCheck();setTimeout(function(){BX.bind(document,"click",BX.proxy(b.ClosePopup,b))},100);BX.bind(document,"keydown",BX.proxy(this.OnKeyDown,this))},ClosePopup:function(){BX.unbind(document,"click",BX.proxy(this.ClosePopup,this));BX.unbind(document,"keydown",BX.proxy(this.OnKeyDown,this));setTimeout(function(){BX.WindowManager.enableKeyCheck()},200);if(!this.Popup){return}this.Popup.style.display="none";this.bShowed=false},CreatePopup:function(){var e=this,b,d,c,a=this.arcTypes.length;this.Popup=document.body.appendChild(BX.create("DIV",{props:{className:"bxfm-at-is-popup"}}));this.Popup.style.width="260px";this.bCreated=true;for(c=0;c<a;c++){b=this.arcTypes[c];d=this.Popup.appendChild(BX.create("DIV",{props:{id:"bx_"+this.id+"_"+c,title:BX.util.htmlspecialchars(b.text),className:"bxfm-arc-type-it"},events:{mouseover:function(){BX.addClass(this,"bxfm-at-over")},mouseout:function(){BX.removeClass(this,"bxfm-at-over")},click:function(){var f=this.id.substr(("bx_"+e.id+"_").length);e.SetArcType(parseInt(f),true);e.ClosePopup()}}}));d.appendChild(BX.create("DIV",{props:{className:"bxfm-text-overflow"},text:b.text}));if(this.curArcTypeInd===c){BX.addClass(d,"bxfm-at-checked")}this.arcTypes[c].row=d}},SetArcType:function(b){var a=this.arcTypes[b];if(!a){return}if(!this.bOne&&typeof this.curArcTypeInd!="undefined"&&this.arcTypes[this.curArcTypeInd]&&this.arcTypes[this.curArcTypeInd].row){BX.removeClass(this.arcTypes[this.curArcTypeInd].row,"bxfm-at-checked")}this.value=a.id;this.curArcTypeInd=b;if(this.bOne){return}this.pTitle.innerHTML=a.text.toUpperCase();if(this.bPack){this.typeChangeCallback(this.pTitle.innerHTML)}if(this.arcTypes[b].row){BX.addClass(this.arcTypes[b].row,"bxfm-at-checked")}},OnKeyDown:function(a){if(!a){a=window.event}if(window.oBXFileDialog&&window.oBXFileDialog.bOpened){return}if(a.keyCode==27){return this.ClosePopup()}}};