function BXMedialibAdmin(a){window.MLItems={};this.arCollections=window.MLCollections;this.arItemsCollList={};this.oConfig=a;this.sessid=this.oConfig.sessid;this.zIndex=1000;this.arItems={};this.curColl=this.oConfig.curColl;this.arExt=this.oConfig.strExt.split(",")}BXMedialibAdmin.prototype={OnStart:function(){this.pCollCont=BX("ml_coll_cont");this.pBread=BX("ml_breadcrumbs");this.Types=this.oConfig.Types;this.curType="";this.requestTypes=[];this.imageTypeId=0;var c,a,e,f,b,d;for(c=0,a=this.Types.length;c<a;c++){f=[];e=this.Types[c].ext.split(",");for(b=0;b<e.length;b++){d=BX.util.trim(e[b]);if(d.length>0){f.push(d.toLowerCase())}}this.Types[c].arExt=f;if(this.Types[c].system&&this.Types[c].code=="image"){this.imageTypeId=this.Types[c].id;this.requestTypes.push(0)}this.requestTypes.push(this.Types[c].id)}this.InitMultiaction();this.InitContextMenu();this.InitTypeSelector();this.Search=new BXMLSearch(this);this.BuildCollections();if(this.curColl>0){this.SelectCollection(this.curColl,true);this.OpenCollection(this.curColl)}if(BX("mlsd_item")){document.body.appendChild(BX("mlsd_item").parentNode)}},BuildCollections:function(){this.oCollections={};this.arCollectionsTree=[];this.bNoCollections=true;var e=[],d,c=0,b,a=this.arCollections.length;for(b=0;b<a;b++){if(!this.BuildCollection(this.arCollections[b],b)){e.push([this.arCollections[b],b])}}while(e.length>0&&c<50){a=e.length;d=[];for(b=0;b<a;b++){if(!this.BuildCollection(e[b][0],e[b][1])){d.push(e[b])}}e=d;c++}this.bRedrawCollections=true;if(this.bNoCollections){BX("ml_no_colection_notice").style.display="block"}},BuildCollection:function(f,e){if(!f){return false}if(!this.CheckMLType(f.type)){return true}if(this.bNoCollections){this.bNoCollections=false;BX("ml_no_colection_notice").style.display="none"}var n,b,m=this,c;f.parent=parseInt(f.parent);if(!f.parent){n=this.pCollCont;b=0;c=this.arCollectionsTree}else{if(this.oCollections[f.parent]){n=this.oCollections[f.parent].pCollsCont;b=this.oCollections[f.parent].level+1;this.oCollections[f.parent].childCount++;if(this.oCollections[f.parent].childCount==1){this.oCollections[f.parent].icon.className="ml-col-icon-closed"}c=this._ReqFindChildCol(this.arCollectionsTree,f.parent)}else{return false}}c.push({id:f.id,child:[]});if(n){var l="",k,d=BX.create("DIV",{props:{id:"ml_coll_title_"+f.id}}),j=d.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-icon ml-col-icon-closed"}})),g={length:0},a=d.appendChild(BX.create("INPUT",{props:{type:"checkbox",value:"c_"+f.id}})),o=d.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-menu",id:"mlccm_"+f.id}})),q=d.appendChild(BX.create("SPAN",{props:{title:bxspcharsback(f.desc||f.name)},text:f.name})),h=BX.create("DIV"),p=h.appendChild(BX.create("TABLE"));itemsTd=p.insertRow(-1).insertCell(-1),colsTd=p.insertRow(-1).insertCell(-1),cellX=p.insertRow(-1).insertCell(-1);itemsTd.className="ml-coll-items-cont";colsTd.className="ml-coll-cols-cont";cellX.className="ml-coll-cols-cell-x";for(k=0;k<10;k++){l+="<img src='/bitrix/images/1.gif' />"}cellX.innerHTML=l;if(g.del=!this.UserCan(f,"del")){g.length++}if(g.edit=!this.UserCan(f,"edit")){g.length++}if(g.add_col=!this.UserCan(f,"new_col")){g.length++}if(g.add_item=!this.UserCan(f,"new_item")){g.length++}if(g.access=!this.UserCan(f,"access")){g.length++}if(g.length<5){o.onmouseover=function(){BX.addClass(this,"ml-col-menu-over")};o.onmouseout=function(){BX.removeClass(this,"ml-col-menu-over")};o.onclick=function(i){m.oColMenu.Show({pElement:this,arHideItems:g});return BX.PreventDefault(i)}}else{o.className="ml-col-menu ml-col-menu-dis"}a.onclick=function(r){var s=this.value.substr("c_".length);if(!this.checked){var i=m.GetCollection(s);if(i&&i.parent>0&&m.oCollections[i.parent]){m.oCollections[i.parent].pCheck.checked=false}}m.CheckAllCollChild(s,!!this.checked,true);if(!r){r=window.event}if(r.stopPropagation){r.stopPropagation()}else{r.cancelBubble=true}};m._SetColTitleLevel(d,h,b);d.onclick=function(){m.OpenCollection(this.id.substr("ml_coll_title_".length),true)};j.onclick=function(i){m.OpenCollection(this.parentNode.id.substr("ml_coll_title_".length),false,true);return BX.PreventDefault(i||window.event)};n.appendChild(d);n.appendChild(h);this.oCollections[f.id]={ind:e,pTitle:d,pChildCont:h,pCollsCont:colsTd,pItemsCont:itemsTd,icon:j,level:b,childCount:0,bOpened:false,pCheck:a};return true}},ReNewCollectionTree:function(){this.bRedrawCollections=true;this.arCollectionsTree=[];var e=[],d,c=0,b,a=this.arCollections.length;for(b=0;b<a;b++){if(!this.CheckMLType(this.arCollections[b].type)){continue}if(!this.ReNewCol4Tree(this.arCollections[b])){e.push(this.arCollections[b])}}while(e.length>0&&c<50){a=e.length;d=[];for(b=0;b<a;b++){if(!this.ReNewCol4Tree(e[b])){d.push(e[b])}}e=d;c++}},ReNewCol4Tree:function(c){var a=parseInt(c.parent),b;if(!a){b=this.arCollectionsTree}else{if(this.oCollections[a]){b=this._ReqFindChildCol(this.arCollectionsTree,a)}}if(!b){return false}b.push({id:c.id,child:[]});return true},SelectCollection:function(f,b){var e=this.oCollections[f];if(!e||this.SelectedColId==f){return}this.DeSelectCollection(false);this.SelectedColId=f;BX.addClass(e.pTitle,"mlcollt-active");BX.addClass(e.pChildCont,"mlcollt-active-ch");var d=this.GetCollsCrumbs(f);this.BuildCrumbs(d);if(b){var c,a=d.length;for(c=1;c<a;c++){if(!this.oCollections[d[c].id].bOpened){this.OpenCollection(d[c].id)}}}},DeSelectCollection:function(a){if(this.SelectedColId&&this.oCollections[this.SelectedColId]){BX.removeClass(this.oCollections[this.SelectedColId].pTitle,"mlcollt-active");BX.removeClass(this.oCollections[this.SelectedColId].pChildCont,"mlcollt-active-ch")}if(a!==false){while(this.pBread.childNodes.length>0){this.pBread.removeChild(this.pBread.firstChild)}}},UserCan:function(c,b){var a;if(typeof c!=="object"){if(c===0){a=this.oConfig.rootAccess}else{c=this.GetCollection(c);if(typeof c!=="object"){return false}a=c.access}}else{a=c.access}return a&&a[b]==="1"},GetCollsCrumbs:function(c){var b=[],a;while(c){a=this.GetCollection(c);if(a){b.push(a);c=a.parent}else{c=false}}return b},BuildCrumbs:function(d){while(this.pBread.childNodes.length>0){this.pBread.removeChild(this.pBread.firstChild)}var e=this,c,b,a=d.length;for(b=a-1;b>=0;b--){c=d[b];if(!c||typeof c!="object"){continue}pCr=this.pBread.appendChild(BX.create("DIV",{props:{className:"ml-crumb",id:"ml_crumb_"+c.id,title:c.desc},text:c.name}));if(b>0){this.pBread.appendChild(BX.create("DIV",{props:{className:"ml-crumb-sep"}})).appendChild(document.createTextNode(" "));pCr.onclick=function(){e.SelectCollection(this.id.substr("ml_crumb_".length))}}else{pCr.style.cursor="default"}}return d},GetCollection:function(c){if(this.oCollections[c]){return this.arCollections[this.oCollections[c].ind]}var b,a=this.arCollections.length;for(b=0;b<a;b++){if(this.arCollections[b].id==c){return this.arCollections[b]}}return false},_ReqFindChildCol:function(a,e){var d,b=a.length,c=false;for(d=0;d<b;d++){if(a[d].id==e){c=a[d].child;break}else{if(a[d].child.length>0){c=this._ReqFindChildCol(a[d].child,e);if(c){break}}}}return c},_ReqBuildCollSelect:function(d,m,a,n){if(!a){a=0}var h,e=m.length,f=d.options.length,g,k,b;if(n==true){var c=1;while(d.options[c]){d.options[c]=null}}for(h=0;h<e;h++){col=this.GetCollection(m[h].id);if(col){k="";for(g=0;g<a;g++){k+=" . "}k+=bxspcharsback(col.name);b=new Option(k,m[h].id);b.title=bxspcharsback(col.name);d.options.add(b);if(m[h].child.length>0){this._ReqBuildCollSelect(d,m[h].child,a+1)}}}},OpenCollection:function(d,a,b){var c=this.oCollections[d];if(!c||typeof c!="object"){return}if(!c.bOpened||!b){if(a){this.SelectCollection(d)}c.icon.className="ml-col-icon ml-col-icon-opened";c.pChildCont.style.display="block";if(c.childCount>0){c.pCollsCont.style.display="block"}this.ShowItems(d)}else{c.pChildCont.style.display="none";c.icon.className="ml-col-icon ml-col-icon-closed"}c.bOpened=!c.bOpened},DelCollection:function(g){if(g>0&&confirm(ML_MESS.DelCollectionConf)){var d=[];if(this.oCollections[g].childCount>0){var e=this.oCollections[g].pChildCont.getElementsByTagName("DIV"),c,a=e.length,b;for(c=0;c<a;c++){if(e[c].id.substr(0,14)=="ml_coll_title_"){b=parseInt(e[c].id.substr(14));if(b>0){d.push(b)}}}}var f=this;this.Request({action:"del_collection",postData:{id:g,child_cols:d},handler:function(){if(window.bx_req_res){f.CSDelCollection(g,d)}}})}},_IncreaseCollChild:function(c,a){var b=this.oCollections[c];if(b){if(a!==-1){b.childCount++;if(b.childCount>0){b.icon.className="ml-col-icon "+(b.bOpened?"ml-col-icon-opened":"ml-col-icon-closed")}}else{b.childCount--;if(b.childCount<=0){b.icon.className="ml-col-icon"}}}},_SetColTitleLevel:function(a,b,c){a.className="ml-coll-title mlcolllevel-"+(c>3?3:c);b.className="ml-coll-child-cont mlchlevel-"+(c>3?3:c);if(c>=3){a.childNodes[1].className="ml-smaller-title"}},SaveCollection:function(){var b=this.EditCollDialog,c=this,a={name:encodeURIComponent(b.pName.value),desc:encodeURIComponent(b.pDesc.value),keywords:encodeURIComponent(b.pKeys.value),parent:b.pParent.value,type:b.typeId};if(b.pName.value==""){alert(ML_MESS.ColNameError);b.pName.focus();return false}if(!b.bNew){a.id=b.oCol.id}this.Request({action:"edit_collection",postData:a,handler:function(){if(window.bx_req_res!==false){c.CloseEditCollDialog();var h={id:window.bx_req_res.id,name:b.pName.value,desc:b.pDesc.value,date:"",keywords:b.pKeys.value,parent:a.parent,access:window.bx_req_res.access,type:b.typeId};if(b.bNew){if(c.bNoCollections){return c.Refresh({curColl:h.id})}c.arCollections.push(h);c.BuildCollection(h,c.arCollections.length-1)}else{var f=c.oCollections[h.id].pTitle,d=c.oCollections[h.id].pChildCont,e=c.arCollections[c.oCollections[h.id].ind].parent,g=h.parent||0;if(c.arCollections[c.oCollections[h.id].ind].parent!=g){c._IncreaseCollChild(e,-1);c._IncreaseCollChild(g);var i=g==0?c.pCollCont:c.oCollections[g].pChildCont;i.appendChild(f);i.appendChild(d);var j=g==0?0:c.oCollections[g].level+1;c.oCollections[h.id].level=j;c._SetColTitleLevel(f,d,j)}c.arCollections[c.oCollections[h.id].ind]=h;f.childNodes[3].innerHTML=BX.util.htmlspecialchars(h.name);f.title=h.desc||h.name}c.ReNewCollectionTree();c.SelectCollection(h.id)}else{alert("error")}}})},OpenEditCollDialog:function(f){if(!f){f={}}if(!this.EditCollDialog){this.CreateEditCollDialog()}this.EditCollDialog.bNew=!f.id;var g=600,e=this.EditCollDialog,a=BX.GetWindowSize(),d=parseInt(a.scrollLeft+a.innerWidth/2-e.width/2),c=parseInt(a.scrollTop+a.innerHeight/2-e.height/2);if(this.bRedrawCollections){this._ReqBuildCollSelect(e.pParent,this.arCollectionsTree,0,true);this.bRedrawCollections=false}e.Overlay.Show({zIndex:g-10});e.pWnd.style.zIndex=g;e.pWnd.style.display="block";this.EditCollDialog.bFocusKeywords=false;if(!e.bNew){var b=this.GetCollection(f.id);e.pName.value=bxspcharsback(b.name);e.pDesc.value=bxspcharsback(b.desc);e.pKeys.value=bxspcharsback(b.keywords);e.pParent.value=b.parent||0;this.EditCollDialog.oCol=b}else{e.pName.value="";e.pDesc.value="";e.pKeys.value="";if(!f.parentCol&&f.bGetSelCol&&this.SelectedColId&&this.oCollections[this.SelectedColId]){f.parentCol=this.SelectedColId}if(f.parentCol>0&&this.UserCan(f.parentCol,"new_col")){e.pParent.value=f.parentCol}var b=this.GetCollection(f.parentCol);if(b&&b.keywords){e.pKeys.value=b.keywords}}e.typeId=this.curType.id||"";e.pName.onchange();e.pName.focus();jsFloatDiv.Show(this.EditCollDialog.pWnd,d,c);BX.bind(document,"keypress",window.MlEdColOnKeypress)},CreateEditCollDialog:function(b){var c=this,a={width:360,height:230,pWnd:BX("mlsd_coll"),pTitle:BX("mlsd_coll_title"),pName:BX("mlsd_coll_name"),pDesc:BX("mlsd_coll_desc"),pKeys:BX("mlsd_coll_keywords"),pParent:BX("mlsd_coll_parent"),Overlay:new BXOverlay({id:"bxml_ed_col_overlay"})};a.pName.onkeydown=a.pName.onchange=function(){setTimeout(function(){var e=c.EditCollDialog,f=bxhtmlspecialchars(e.pName.value),d=e.bNew?ML_MESS.NewCollection:ML_MESS.Collection;e.pTitle.title=d+(f.length>0?": "+e.pName.value:"");e.pTitle.innerHTML=d+(f.length>0?": "+f:"")},20)};a.pKeys.onchange=a.pKeys.onblur=function(){c.EditCollDialog.bFocusKeywords=true};a.pParent.onchange=function(){if(!c.EditCollDialog.bNew&&this.value==c.EditCollDialog.oCol.parent){return true}if(c.EditCollDialog.bNew&&!c.UserCan(parseInt(this.value),"new_col")||!c.EditCollDialog.bNew&&!c.UserCan(parseInt(this.value),"edit")){c._SetFirstAvailableCol();return alert(ML_MESS.CollAccessDenied3)}if(c.EditCollDialog.oCol){var e=c._ReqFindChildCol(c.arCollectionsTree,c.EditCollDialog.oCol.id);if(!e||c._ReqFindChildCol(e,this.value)){alert(ML_MESS.ColLocEr2);this.value=c.EditCollDialog.oCol.parent||0;return true}}if(!c.EditCollDialog.bNew&&c.EditCollDialog.oCol.id==this.value){alert(ML_MESS.ColLocEr);this.value=c.EditCollDialog.oCol.parent||0}if(c.EditCollDialog.bNew&&!c.EditCollDialog.bFocusKeywords&&this.value>0){var d=c.GetCollection(this.value);if(d&&d.keywords){a.pKeys.value=d.keywords}}};BX("mlsd_coll_save").onclick=function(){c.SaveCollection()};BX("mlsd_coll_cancel").onclick=function(){c.CloseEditCollDialog()};BX("mlsd_coll_close").onclick=function(){c.CloseEditCollDialog()};this.bRedrawCollections=true;window.MlEdColOnKeypress=function(d){if(!d){d=window.event}if(d&&d.keyCode==27){c.CloseEditCollDialog()}};a.pWnd.style.width=a.width+"px";a.pWnd.style.height="auto";a.pWnd.style.minHeight="10px";this.EditCollDialog=a},CloseEditCollDialog:function(){this.EditCollDialog.pWnd.style.display="none";jsFloatDiv.Close(this.EditCollDialog.pWnd);this.EditCollDialog.Overlay.Hide();BX.unbind(document,"keypress",window.MlEdColOnKeypress)},_SetFirstAvailableCol:function(b){var e=this.EditCollDialog,b=e.bNew?"new_col":"edit",f,c,d,a=e.pParent.options.length;if(!e.bNew&&e.oCol.parent){e.pParent.value=e.oCol.parent}if(this.oConfig.rootAccess[b]){e.pParent.value=0}else{for(d=0;d<a;d++){f=e.pParent.options[d].value;c=this.GetCollection(f);if(c&&c.access&&c.access[b]){e.pParent.value=f;return}}}},ShowItems:function(d){var c=this,b=this.GetCollection(d),a={edit:this.UserCan(b,"edit_item"),del:this.UserCan(b,"del_item")};if(typeof MLItems[d]=="object"){return this.DisplayItems({Items:MLItems[d],id:d,Access:a})}this.Request({action:"get_items",postData:{col_id:d},handler:function(){if(!window.MLItems[d]){return false}c.DisplayItems({Items:MLItems[d],id:d,Access:a})}})},DisplayItems:function(c){var f=c.id,d=this.oCollections[f].pItemsCont;d.style.display="block";while(d.firstChild){d.removeChild(d.lastChild)}this.arItems[f]={};if(c.Items&&c.Items.length){var b,a=c.Items.length,e=false;if(this.arLoadItems[f]){e=true}for(b=0;b<a;b++){this.DisplayItem({Item:c.Items[b],pCont:d,bCheck:e,id:f,Access:c.Access})}}},DisplayItem:function(j){var k=j.Item,i=this,n=this.oConfig.thumbWidth,g=this.oConfig.thumbHeight,e=BX.create("DIV",{props:{id:"ml_item_"+k.id,className:"ml-item-cont",title:bxspcharsback(k.name)},style:{width:(n+15)+"px",height:(g+35)+"px"}}),b=e.appendChild(BX.create("INPUT",{props:{type:"checkbox",className:"item-checkbox",value:j.id+"|"+k.id}})),p=e.appendChild(BX.create("IMG",{props:{src:k.thumb_path||"/bitrix/images/1.gif",className:"ml-item-thumb"}})),d=e.appendChild(BX.create("DIV",{props:{className:"ml-item-title"},style:{width:(n+8)+"px"}}));var c=k.thumb_path||k.path;if(k.type=="image"&&c){p.style.backgroundImage="url('"+c+"')"}k.trueHeight=j.Item.height;if(!k.thumb_path||!k.width||!k.height){BX.addClass(p,"ml-item-no-thumb");k.height=100}if(k.width<n&&k.height<g){var a=Math.round((g-k.height)/2);if(a>0){p.style.marginTop=a+"px"}}d.appendChild(document.createTextNode(bxspcharsback(k.name)));if(j.bCheck){b.checked=true}b.onclick=function(){if(!this.checked&&i.oCollections[j.id]){i.oCollections[j.id].pCheck.checked=false}i.EnableMultiAction(this.checked||i.AskAllCheckBoxes())};var f=e.appendChild(BX.create("DIV",{props:{className:"ml-item-but-cont"}}));var l=f.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-item-view",title:ML_MESS.ViewItem}}));l.onclick=function(h){var q=this.parentNode.parentNode.id.substr("ml_item_".length);i.GetItemCollList(q,"OpenViewItDialog",{id:q,colId:j.id,Access:j.Access,bSearch:j.bSearch});return BX.PreventDefault(h)};e.ondblclick=function(h){var q=this.id.substr("ml_item_".length);i.GetItemCollList(q,"OpenViewItDialog",{id:q,colId:j.id,Access:j.Access,bSearch:j.bSearch});return BX.PreventDefault(h)};if(j.Access.edit||j.Access.del){if(j.Access.edit){var m=f.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-item-edit",title:ML_MESS.EditItem}}));m.onclick=function(h){var q=this.parentNode.parentNode.id.substr("ml_item_".length);i.GetItemCollList(q,"OpenEditItemDialog",{id:q,colId:j.id,bSearch:j.bSearch});return BX.PreventDefault(h||window.event)}}if(j.Access.del){var o=f.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-item-del",title:ML_MESS.DelItem}}));o.onclick=function(h){var q=this.parentNode.parentNode.id.substr("ml_item_".length);i.GetItemCollList(q,"DelItem",{id:q,colId:j.id,bSearch:j.bSearch});return BX.PreventDefault(h||window.event)}}else{b.disabled=true;b.checked=false}e.onmouseover=function(){BX.addClass(this,"ml-item-cont-over")};e.onmouseout=function(){BX.removeClass(this,"ml-item-cont-over")}}e.onclick=function(q){if(!q){q=window.event}var h=q.target||q.srcElement;if(h.nodeType==3){h=h.parentNode}if(h&&h.nodeName&&h.nodeName.toLowerCase()!="input"&&j.Access.del){b.checked=!b.checked}b.onclick()};if(!j.bSearch){this.arItems[j.id][k.id]={oItem:k,pWnd:e}}j.pCont.appendChild(e)},OpenViewItDialog:function(d){if(!this.ViewItDialog){this.CreateViewItDialog(d)}var e,b,a,f=600,c=this.ViewItDialog;if(d.bSearch){a=window.MLSearchResult.length;for(b=0;b<a;b++){if(window.MLSearchResult[b].id==d.id){e=window.MLSearchResult[b];break}}}else{if(MLItems[d.colId]){a=MLItems[d.colId].length;for(b=0;b<a;b++){if(MLItems[d.colId][b].id==d.id){e=MLItems[d.colId][b];break}}}}if(!e){return}c.oItem=e;c.colId=d.colId;c.Overlay.Show({zIndex:f-10});c.pWnd.style.zIndex=f;c.pDel.style.display=d.Access.del?"inline":"none";c.pEdit.style.display=d.Access.edit?"inline":"none";c.pWnd.style.display="block";c.pWnd.style.visibility="hidden";c.bOpened=true;this.SetItemInfo(e)},CreateViewItDialog:function(b){var c=this,a={width:100,height:100,pWnd:BX("mlsd_view_item"),pItemCont:BX("mlsd_item_cont"),pInfoCont:BX("mlsd_info_cont"),pName:BX("mlvi_info_name"),pCols:BX("mlvi_info_colls"),pKeys:BX("mlvi_info_keys"),pDesc:BX("mlvi_info_desc"),pDetails:BX("mlvi_info_details"),pDel:BX("mlsd_viewit_del"),pEdit:BX("mlsd_viewit_edit"),pLink:BX("mlvi_info_link"),pCopyLink:BX("mlvi_info_copy_link"),pCopyInput:BX("mlvi_info_copy_input"),pExt:BX("mlvi_info_ext"),Overlay:new BXOverlay({id:"bxml_viewit_overlay"})};BX("mlsd_viewit_cancel").onclick=function(){c.CloseViewItDialog()};BX("mlsd_viewit_close").onclick=function(){c.CloseViewItDialog()};a.pDel.onclick=function(d){c.DelItem({id:c.ViewItDialog.oItem.id,colId:c.ViewItDialog.colId})};a.pEdit.onclick=function(d){c.CloseViewItDialog();c.OpenEditItemDialog({id:c.ViewItDialog.oItem.id,colId:c.ViewItDialog.colId,bSearch:b.bSearch})};window.MlViewItOnKeypress=function(d){if(!d){d=window.event}if(d&&d.keyCode==27){c.CloseViewItDialog()}};this.ViewItDialog=a},CloseViewItDialog:function(){this.ViewItDialog.bOpened=false;this.ViewItDialog.pWnd.style.display="none";this.ViewItDialog.pCopyInput.style.display="none";if((typeof videojs!=="undefined")&&(player=BX.findChild(BX("mlsd_item_cont"),{"class":"video-js"},false))){videojs(player.id).pause()}if(player=BX.findChild(BX("mlsd_item_cont"),{tag:"div"},false)&&typeof jwplayer!=="undefined"){jwplayer(player.id).stop()}jsFloatDiv.Close(this.ViewItDialog.pWnd);this.ViewItDialog.Overlay.Hide();BX.unbind(document,"keypress",window.MlViewItOnKeypress)},SetItemInfo:function(h){var g=this,b=this.ViewItDialog,o=this.arItemsCollList[h.id],k="",f,d=o.length,n,c;b.pName.innerHTML=BX.util.htmlspecialchars(h.name);b.pName.title=h.name;b.pLink.onclick=function(){jsUtils.Redirect([],"fileman_file_download.php?path="+BX.util.urlencode(h.path))};b.pCopyLink.onclick=function(){b.pCopyInput.value=h.path.substr(0,1)!=="/"?h.path:window.location.protocol+"//"+window.location.host+h.path;b.pCopyInput.style.display="block";b.pCopyInput.select()};if(h.keywords.length>0){b.pKeys.parentNode.className="small-grey";b.pKeys.innerHTML=BX.util.htmlspecialchars(h.keywords);b.pKeys.title=h.keywords}else{b.pKeys.parentNode.className="ml-info-keys-h"}if(h.desc.length>0){b.pDesc.innerHTML=BX.util.htmlspecialchars(h.desc.replace(/\n/g,"<br />"));b.pDesc.parentNode.className="small-grey"}else{b.pDesc.parentNode.className="ml-info-desc-h"}for(var e=b.pCols.childNodes.length-1;e>0;e--){if(b.pCols.childNodes[e].nodeName.toLowerCase()!="span"){b.pCols.removeChild(b.pCols.childNodes[e])}}for(f=0;f<d;f++){k+=BX.util.htmlspecialcharsback(this.GetCollection(o[f]).name+(f!=d-1?", ":""))}b.pCols.appendChild(document.createTextNode(k));var m=ML_MESS.FileExt+": "+h.path.substr(h.path.lastIndexOf(".")+1);m+="<br />"+ML_MESS.DateModified+": "+h.date_mod;if(h.file_size){m+="<br />"+ML_MESS.FileSize+": "+h.file_size}if(h.width&&h.height){m+="<br />"+ML_MESS.ImageSize+": "+h.width+" x "+h.trueHeight+" px"}b.pDetails.innerHTML=m;this.SetItemHTML(h)},SetItemHTML:function(b){var a=this.ViewItDialog,c=this;this.Request({action:"get_item_view",postData:{id:b.id},handler:function(){var n=window.bx_req_res.html;var e=[],d,j,l,f;while((d=n.indexOf("<script>"))!=-1){var j=n.indexOf("<\/script>",d);if(j==-1){break}e[e.length]=n.substr(d+8,j-d-8);n=n.substr(0,d)+n.substr(j+9)}for(var l=0,f=e.length;l<f;l++){if(e[l]!=""){jsUtils.EvalGlobal(e[l])}}a.pItemCont.innerHTML=n;var m=parseInt(window.bx_req_res.width)||100,h=parseInt(window.bx_req_res.height)||50;if(m<100){m=100}if(a.pDesc&&parseInt(a.pDesc.offsetHeight)>(h-200)){a.pDesc.style.height=(h>=400?h-200:200)+"px";a.pDesc.style.overflow="auto"}var o=parseInt(a.pInfoCont.offsetHeight)||0,q=80+(h>o?h:o),k=270+m,r=BX.GetWindowSize(),g=parseInt(r.scrollLeft+r.innerWidth/2-k/2),p=parseInt(r.scrollTop+r.innerHeight/2-q/2);a.pWnd.style.width=k+"px";a.pWnd.style.height=q+"px";a.pWnd.style.overflow="hidden";jsFloatDiv.Show(a.pWnd,g,p);BX.bind(document,"keypress",window.MlViewItOnKeypress);a.pItemCont.style.width=m+"px";a.pItemCont.style.height=h+"px";a.pWnd.style.visibility="visible"}})},DelItem:function(g){if(!g.id){return}var h=this,c=false,a=this.arItemsCollList[g.id],d,b=a.length,f;for(d=0;d<b;d++){if(!this.GetCollection(a[d])){c=true;break}}if(!g.mode&&g.bSearch){return this.OpenConfirm({text:ML_MESS.DelElConfirm,but1:{text:ML_MESS.DelElConfirmYes,handler:function(){h.DelItem({id:g.id,colId:g.colId,mode:"all",bSearch:true})},width:100},width:380,height:100})}if(!g.mode){return this.OpenConfirm({text:ML_MESS.DelItConfTxt,but1:{text:ML_MESS.DelItB1,handler:function(){h.DelItem({id:g.id,colId:g.colId,mode:"current"})},width:180},but2:{text:ML_MESS.DelItB2,handler:function(){h.DelItem({id:g.id,colId:g.colId,mode:"all"})},disabled:c,width:160}})}var e=g.colId||0;this.Request({action:"del_item",postData:{id:g.id,mode:g.mode,col_id:e},handler:function(){if(window.bx_req_res==true){h.CSDelItem({id:g.id,mode:g.mode,colId:e,bSearch:g.bSearch})}else{if(window.bx_req_res!==false){return false}}}})},_ChooseKeysCount:function(d,a,e,b,c){var f=this;d.innerHTML=e;setTimeout(function(){var h=parseInt(a.offsetHeight),g=e.lastIndexOf(",");if(h>b&&g>0){f._ChooseKeysCount(d,a,BX.util.trim(e.substr(0,g)),b,true)}else{if(c){d.innerHTML+="..."}}},1)},GetItemCollList:function(d,b,a){if(!this.arItemsCollList[d]){var c=this;this.Request({action:"get_item_coll_list",postData:{id:d},handler:function(){if(!window._ml_items_colls){return false}c.arItemsCollList[d]=[];for(var f=0,e=window._ml_items_colls.length;f<e;f++){c.arItemsCollList[d].push(window._ml_items_colls[f])}c[b](a)}})}else{this[b](a)}},OpenEditItemDialog:function(h,b){if(!this.EditItemDialog){return this.CreateEditItemDialog(h)}else{if(!b){this.Request({action:"bx_test",handler:function(){}});this.EditItemDialog.alreadySubmitted=false;this.EditItemDialog.alreadyLoaded=false;this.EditItemDialog.Params=h||this.EditItemDialog.Params||{};this.EditItemDialog.pIfrm.src=this.GetRequestUrl("upload_form");return}}var g=this,a=this.EditItemDialog,c=a.Params.id,m=600,n=BX.GetWindowSize(),d=parseInt(n.scrollLeft+n.innerWidth/2-a.width/2),k=parseInt(n.scrollTop+n.innerHeight/2-a.height/2);a.bNew=!c;a.Overlay.Show({zIndex:m-10});a.pWnd.style.zIndex=m;a.pWnd.style.display="block";this.EditItemDialog.bShow=true;a.arColls={};a.colLength=0;if(!a.bNew){if(a.Params.bSearch){var f,e;e=window.MLSearchResult.length;for(f=0;f<e;f++){if(window.MLSearchResult[f].id==c){j=window.MLSearchResult[f];break}}}else{var j=this.arItems[a.Params.colId][c].oItem}a.pPCFileCont.style.display=a.pLoadFDLink.style.display=a.pFDFileCont.style.display=a.pLoadPCLink.style.display="none";a.pFNFileCont.style.display="block";a.pChangeFileLink.style.display="inline";a.pChangeFileLinkBack.style.display="none";a.pFileName.innerHTML=j.file_name;this._AddItemsCollections(this.arItemsCollList[c]);a.pName.value=bxspcharsback(j.name);a.pDesc.value=bxspcharsback(j.desc);a.pKeys.value=bxspcharsback(j.keywords);if(j.width&&j.height){a.pSize.style.display="block";a.pSize.innerHTML=j.width+" x "+j.trueHeight}else{a.pSize.style.display="none"}if(j.thumb_path){a.pThumb.src=j.thumb_path;a.pNoPreview.style.display="none";if(j.width>146||j.height>136){if(j.width-j.height>0){a.pThumb.style.width="146px"}else{a.pThumb.style.height="136px"}}else{if(j.height<126){a.pThumb.style.marginTop=Math.round((126-j.height)/2)+"px"}}}a.oItem=j}else{a.pFNFileCont.style.display="none";a.pChangeFileLink.style.display="none";a.pChangeFileLinkBack.style.display="none";a.pFileName.innerHTML="";a.pName.value="";a.pDesc.value="";a.pKeys.value="";a.pSize.style.display="none";if(!a.Params.parentCol&&a.Params.bGetSelCol&&this.SelectedColId&&this.oCollections[this.SelectedColId]){a.Params.parentCol=this.SelectedColId}if(a.Params.parentCol>0&&this.UserCan(a.Params.parentCol,"new_item")){this._AddItemsCollections([a.Params.parentCol])}}this._ReHeightEditDialog();a.pName.onchange();jsFloatDiv.Show(a.pWnd,d,k);window.MlEdItemOnKeypress=function(i){if(!i){i=window.event}if(i&&i.keyCode==27){g.CloseEditItemDialog()}};BX.bind(document,"keypress",window.MlEdItemOnKeypress)},CreateEditItemDialog:function(b){var c=this,a={Params:b||false,width:420,height:350,pWnd:BX("mlsd_item"),pTitle:BX("mlsd_item_title"),pIfrm:BX("mlsd_iframe_upload"),Overlay:new BXOverlay({id:"bxml_ed_it_overlay"})};a.pIfrm.src=this.GetRequestUrl("upload_form");var c=this;if(BX.browser.IsIE()){a.pIfrm.onreadystatechange=function(){c.EditItemDialogOnload()}}else{a.pIfrm.onload=function(){c.EditItemDialogOnload()}}BX("mlsd_item_cancel").onclick=BX("mlsd_item_close").onclick=function(){c.CloseEditItemDialog()};a.pWnd.style.width=a.width+"px";a.pWnd.style.height=a.height+"px";this.EditItemDialog=a},EditItemDialogOnload:function(){var b=this,a=this.EditItemDialog;a.pFrameDoc=a.pIfrm.contentDocument||a.pIfrm.contentWindow.document;a.pName=a.pFrameDoc.getElementById("mlsd_item_name");a.bFocusKeywords=false;if(!a.pName&&!this.EditItemDialog.alreadyLoaded){return}if(!a.pName&&this.EditItemDialog.alreadyLoaded&&!this.EditItemDialog.alreadySubmitted){this.EditItemDialog.alreadySubmitted=true;return setTimeout(function(){b.CSEditItem(top.bx_req_res,top._ml_items_colls)},50)}if(this.EditItemDialog.alreadyLoaded||this.EditItemDialog.alreadySubmitted){return}this.EditItemDialog.alreadyLoaded=true;a.pDesc=a.pFrameDoc.getElementById("mlsd_item_desc");a.pKeys=a.pFrameDoc.getElementById("mlsd_item_keywords");a.pColSelect=a.pFrameDoc.getElementById("mlsd_coll_sel");a.pItCollCont=a.pColSelect.parentNode.parentNode;a.pFNFileCont=a.pFrameDoc.getElementById("mlsd_fname_cont");a.pPCFileCont=a.pFrameDoc.getElementById("mlsd_load_cont");a.pFDFileCont=a.pFrameDoc.getElementById("mlsd_select_cont");a.pLoadFile=a.pFrameDoc.getElementById("ml_load_file");a.pLoadMaxSize=a.pFrameDoc.getElementById("ml_load_max_size");a.pChangeFileLink=a.pFrameDoc.getElementById("mlsd_fname_change");a.pChangeFileLinkBack=a.pFrameDoc.getElementById("mlsd_fname_change_back");a.pLoadPCLink=a.pFrameDoc.getElementById("mlsd_select_pc");a.pLoadFDLink=a.pFrameDoc.getElementById("mlsd_select_fd");a.pItemColls=a.pFrameDoc.getElementById("mlsd_item_collections");a.pFileName=a.pFrameDoc.getElementById("ml_file_name");a.pId=a.pFrameDoc.getElementById("mlsd_item_id");a.pNoPreview=a.pFrameDoc.getElementById("mlsd_no_preview");a.pFileName=a.pFrameDoc.getElementById("ml_file_name");a.pThumb=a.pFrameDoc.getElementById("mlsd_item_thumb");a.pSize=a.pFrameDoc.getElementById("mlsd_item_size");a.pItemPath=a.pFrameDoc.getElementById("mlsd_item_path");a.pOpenFD=a.pFrameDoc.getElementById("mlsd_open_fd");a.pSourceType=a.pFrameDoc.getElementById("mlsd_source_type");a.pSaveBut=BX("mlsd_item_save");a.pForm=a.pFrameDoc.forms.ml_item_form;a.pTbl=a.pForm.firstChild;a.pItemPath.onchange=a.pLoadFile.onchange=function(){var c=this.value;if(!c||c.length<=0){return}c=c.replace(/\\/g,"/");c=c.substr(c.lastIndexOf("/")+1);a.pName.value=c;a.pName.onchange()};a.pName.onkeydown=a.pName.onchange=function(){setTimeout(function(){var d=b.EditItemDialog,e=bxhtmlspecialchars(d.pName.value),c=d.bNew?ML_MESS.NewItem:ML_MESS.Item;d.pTitle.title=c+(e.length>0?": "+d.pName.value:"");d.pTitle.innerHTML=c+(e.length>0?": "+e:"")},20)};a.pLoadFDLink.onclick=function(){a.pPCFileCont.style.display=a.pLoadFDLink.style.display="none";a.pFDFileCont.style.display="block";a.pLoadPCLink.style.display="inline";a.pSourceType.value="FD"};a.pLoadPCLink.onclick=function(){a.pPCFileCont.style.display="block";a.pLoadFDLink.style.display="inline";a.pFDFileCont.style.display=a.pLoadPCLink.style.display="none";a.pSourceType.value="PC"};a.pChangeFileLink.onclick=function(){a.pFNFileCont.style.display="none";a.pChangeFileLink.style.display="none";a.pChangeFileLinkBack.style.display="inline";a.pLoadPCLink.onclick()};a.pChangeFileLinkBack.onclick=function(){a.pPCFileCont.style.display=a.pLoadFDLink.style.display=a.pFDFileCont.style.display=a.pLoadPCLink.style.display="none";a.pFNFileCont.style.display="block";a.pChangeFileLink.style.display="inline";a.pChangeFileLinkBack.style.display="none";a.pSourceType.value="N"};a.pColSelect.onchange=function(){b._AddCollToItem(this.value);this.value=0};a.pSaveBut.onclick=function(){if(b.EditItemDialogOnsubmit()){a.pForm.submit();b.CloseEditItemDialog()}};a.pOpenFD.onclick=window.mlOpenFileDialog;window.mlOnFileDialogSave=function(e,f,d){var c=(f=="/"?"":f)+"/"+e;a.pItemPath.value=c;a.pItemPath.focus();a.pItemPath.select()};a.pKeys.onchange=a.pKeys.onblur=function(){b.EditItemDialog.bFocusKeywords=true};this._ReqBuildCollSelect(a.pColSelect,this.arCollectionsTree,0,true);this.OpenEditItemDialog(false,true)},EditItemDialogOnsubmit:function(){var d=this.EditItemDialog,f,a=this.EditItemDialog.arColls,e="";for(f in a){if(a[f]&&typeof a[f]=="object"&&a[f].pWnd){e+=(e==""?"":",")+f}}var b=d.pSourceType.value=="PC"?d.pLoadFile.value:d.pItemPath.value;if((d.bNew||b!=="")&&!this.CheckFileExt(b)){alert(ML_MESS.ItemExtError);return}if((d.bNew||b!=="")&&!this.CheckFileExt(b,this.curType.arExt)&&!confirm(ML_MESS.CheckExtTypeConf)){return false}if(d.bNew){var c=true;if(b==""){alert(ML_MESS.ItSourceError)}else{c=false}if(c){if(d.pSourceType.value=="PC"){d.pLoadPCLink.onclick();d.pLoadFile.focus()}else{d.pLoadFDLink.onclick();d.pItemPath.focus()}return false}}if(d.pName.value==""){alert(ML_MESS.ItNameError);d.pName.focus();return false}if(e==""){alert(ML_MESS.ItCollsError);d.pColSelect.focus();return false}if(!this.EditItemDialog.bNew){this.EditItemDialog.pId.value=this.EditItemDialog.oItem.id}this.EditItemDialog.pItemColls.value=e;return true},CloseEditItemDialog:function(){this.EditItemDialog.bShow=false;this.EditItemDialog.Params=false;this.EditItemDialog.pWnd.style.display="none";jsFloatDiv.Close(this.EditItemDialog.pWnd);this.EditItemDialog.Overlay.Hide();BX.unbind(document,"keypress",window.MlEdItemOnKeypress)},_AddItemsCollections:function(c){var b,a=c.length;for(b=0;b<a;b++){this._AddCollToItem(c[b],false)}},_AddCollToItem:function(a,c){if(this.EditItemDialog.arColls[a]){return}if(this.EditItemDialog.bNew&&!this.UserCan(parseInt(a),"new_item")||!this.EditItemDialog.bNew&&!this.UserCan(parseInt(a),"edit_item")){return alert(ML_MESS.CollAccessDenied4)}var b=this.GetCollection(a);if(!b){return}var f,d,g=this,k=this.EditItemDialog.pColSelect,j=BX.create("DIV",{props:{className:"mlsd-ch-col",title:b.name}},this.EditItemDialog.pFrameDoc),e=j.appendChild(BX.create("SPAN",{text:b.name},this.EditItemDialog.pFrameDoc)),h=j.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-del",title:ML_MESS.DelColFromItem,id:"mlsd_it_"+a}},this.EditItemDialog.pFrameDoc));if(b.keywords&&this.EditItemDialog.bNew&&!this.EditItemDialog.bFocusKeywords){this.AppendKeywords(this.EditItemDialog.pKeys,b.keywords)}this.EditItemDialog.pItCollCont.onmouseover=function(i){};this.EditItemDialog.pItCollCont.onmouseout=function(i){};j.onmouseover=function(i){BX.addClass(this,"col-over")};j.onmouseout=function(i){parent.BX.removeClass(this,"col-over")};h.onclick=function(i){var l=this.id.substr("mlsd_it_".length);g.EditItemDialog.pItCollCont.removeChild(g.EditItemDialog.arColls[l].pWnd);g._SelectOptionInColList(g.EditItemDialog.pColSelect,l,false);g.EditItemDialog.arColls[l]=null;g.EditItemDialog.colLength--;g._ReHeightEditDialog()};this.EditItemDialog.colLength++;this.EditItemDialog.pItCollCont.insertBefore(j,k.parentNode);g._SelectOptionInColList(k,a);if(c!==false){this._ReHeightEditDialog()}this.EditItemDialog.arColls[a]={pWnd:j}},_SelectOptionInColList:function(d,e,c){for(var b=0,a=d.options.length;b<a;b++){if(d.options[b].value==e){d.options[b].className=(c!==false)?"opt-checked":"";d.options[b].title=(c!==false)?ML_MESS.CheckedColTitle:"";break}}},_ReHeightEditDialog:function(){var a=Math.ceil((this.EditItemDialog.colLength+2)/4);if(a<2){a=2}var b=(a-2)*28;this.EditItemDialog.pItCollCont.style.height=a*28+"px";this.EditItemDialog.pIfrm.style.height=275+b+"px";this.EditItemDialog.pTbl.style.height=265+b+"px";this.EditItemDialog.pWnd.style.height=350+b+"px";jsFloatDiv.AdjustShadow(this.EditItemDialog.pWnd)},GetRequestUrl:function(b,a){return"/bitrix/admin/fileman_medialib.php?sessid="+(a||this.sessid)+"&lang="+this.oConfig.lang+(b?"&action="+b:"")},CheckReqLostSessid:function(a){var c="BX_ML_DUBLICATE_ACTION_REQUEST",b=a.indexOf(c);if(b==-1){return true}this.sessid=a.substring(b+c.length,a.lastIndexOf("-->"));return this.sessid},Request:function(c){this.ShowWaitWindow();var d=this,a=0,b=new JCHttpRequest();b.Action=function(f){var e=function(){d.CloseWaitWindow();if(f.indexOf("BX_ML_LOAD_OK")==-1){return alert(ML_MESS.AccessDenied)}var h=d.CheckReqLostSessid(f);if(h!==true){if(c.bRequestReply){alert(ML_MESS.SessExpired)}else{c.bRequestReply=true;setTimeout(function(){d.Request(c)},50)}return}var g=c.handler(f);if(g===false&&++a<20){setTimeout(e,3)}};setTimeout(e,10)};window.bx_req_res=false;b.Post(this.GetRequestUrl(c.action),c.postData?ConvertArray2Post(c.postData):"")},ShowWaitWindow:function(){if(window.ShowWaitWindow){ShowWaitWindow()}},CloseWaitWindow:function(){if(window.CloseWaitWindow){CloseWaitWindow()}},OpenConfirm:function(e){var j=e.width||560,c=e.height||100,i=700,d=this;if(!this.Confirm){var a={pWnd:BX("ml_colfirm_dialog"),pText:BX("ml_confd_text"),but1:BX("ml_confd_b1"),but2:BX("ml_confd_b2"),butCancel:BX("ml_confd_cancel"),Overlay:new BXOverlay({id:"bxml_conf_overlay",parCont:BX("ml_colfirm_dialog").parentNode})};a.butCancel.onclick=function(){d.CloseConfirm()}}else{var a=this.Confirm}a.pWnd.style.width=j+"px";a.pWnd.style.height=c+"px";a.pWnd.style.zIndex=i;a.pWnd.style.display="block";a.Overlay.Show({zIndex:i-10,clickCallback:{func:this.CloseConfirm,obj:this}});var f=BX.GetWindowSize(),b=parseInt(f.scrollLeft+f.innerWidth/2-j/2),g=parseInt(f.scrollTop+f.innerHeight/2-c/2);jsFloatDiv.Show(a.pWnd,b,g,0);a.but1.value=e.but1.text;a.but1.onclick=function(h){e.but1.handler(h);d.CloseConfirm()};a.but1.disabled=!!e.but1.disabled;if(e.but1.width&&!isNaN(parseInt(e.but1.width))){a.but1.style.width=parseInt(e.but1.width)+"px"}a.but1.focus();if(e.but2){a.but2.style.display="inline";a.but2.value=e.but2.text;a.but2.disabled=!!e.but2.disabled;a.but2.onclick=function(h){e.but2.handler(h);d.CloseConfirm()};if(e.but2.width&&!isNaN(parseInt(e.but2.width))){a.but2.style.width=parseInt(e.but2.width)+"px"}}else{a.but2.style.display="none"}a.pText.innerHTML=e.text;this.Confirm=a;window.MlConfDialofOnKeypress=function(h){if(!h){h=window.event}if(h&&h.keyCode==27){d.CloseConfirm()}};BX.bind(document,"keypress",window.MlConfDialofOnKeypress)},CloseConfirm:function(){this.Confirm.pWnd.style.display="none";jsFloatDiv.Close(this.Confirm.pWnd);this.Confirm.Overlay.Hide();BX.unbind(document,"keypress",window.MlConfDialofOnKeypress)},SaveSettings:function(){if(this.width&&this.height){this.userSettings.width=this.width;this.userSettings.height=this.height}this.Request({action:"save_settings",postData:this.userSettings,handler:function(){}})},CSDelCollection:function(h,e){var g=this.oCollections[h];if(g){var b=this.GetCollection(h);if(e!==false&&typeof b=="object"&&b.parent>0){this._IncreaseCollChild(parseInt(b.parent),-1)}if(this.SelectedColId&&this.SelectedColId==h){this.DeSelectCollection()}this.arCollections=BX.util.deleteFromArray(this.arCollections,g.ind);var f=g.pChildCont.parentNode;if(f){f.removeChild(g.pChildCont);f.removeChild(g.pTitle)}var d=true;for(var c=0,a=f.childNodes.length;c<a;c++){if(f.childNodes[c]&&f.childNodes[c].nodeName&&f.childNodes[c].nodeName.toUpperCase()=="DIV"){d=false;break}}if(d){return this.Refresh()}this.oCollections[h]=null;if(e){for(var c=0,a=e.length;c<a;c++){this.CSDelCollection(e[c],false)}}if(e!==false){this.ReNewCollectionTree()}}},CSDelItem:function(q){var a=q.id,r=[];if(q.colId=="search_result"){q.bSearch=true}if(q.bSearch){var o,h=window.MLSearchResult.length;for(o=0;o<h;o++){if(window.MLSearchResult[o].id==a){g=window.MLSearchResult[o];break}}}else{var c=parseInt(q.colId),g=this.arItems[c][parseInt(a)]}if(!g){return}if(this.ViewItDialog&&this.ViewItDialog.bOpened){this.CloseViewItDialog()}if(q.mode=="current"){r.push(c);this.arItemsCollList[a]=false}else{if(!this.arItemsCollList[a]){return this.GetItemCollList(a,"CSDelItem",q)}r=this.arItemsCollList[a]}var o,h=r.length,e,k,b,d;for(o=0;o<h;o++){if(MLItems[r[o]]){e=MLItems[r[o]].length;for(k=0;k<e;k++){b=MLItems[r[o]][k];if(b.id==a){MLItems[r[o]]=BX.util.deleteFromArray(MLItems[r[o]],k);break}}this.ShowItems(r[o])}}if(this.Search.bShowed){var p,m=window.MLSearchResult.length,f;for(p=0;p<m;p++){f=window.MLSearchResult[p];if(f.id==a){window.MLSearchResult=BX.util.deleteFromArray(window.MLSearchResult,p);this.Search.DisplayResult(window.MLSearchResult,this.Search.Query);break}}}},CSEditItem:function(b,n){if(!b){if(parseInt(this.EditItemDialog.pLoadFile.files[0].size)>parseInt(this.EditItemDialog.pLoadMaxSize.value)){var g=parseInt(this.EditItemDialog.pLoadMaxSize.value)/(1024*1024);return alert(ML_MESS.ItFileSizeError.replace("#FILESIZE#",g))}}if(!b||typeof n!="object"){return alert(ML_MESS.EditItemError)}var j,f=n.length,a=b.id,c,m=this.arItemsCollList[a]||[],d=m.length,o={};if(m.length>0){c=this.FindItem(m[0],a);if(c!==false){b=this._MergeItemInfo(MLItems[m[0]][c],b)}}for(j=0;j<f;j++){if(MLItems[n[j]]){c=this.FindItem(n[j],a);if(c===false){MLItems[n[j]].push(b)}else{MLItems[n[j]][c]=b}o[n[j]]=true}}for(j=0;j<d;j++){if(!o[m[j]]){c=this.FindItem(m[j],a);if(c!==false){MLItems[m[j]]=BX.util.deleteFromArray(MLItems[m[j]],c);this.ShowItems(m[j])}}}this.arItemsCollList[a]=n;for(j=0;j<f;j++){this.ShowItems(n[j])}if(this.Search.bShowed){var k,h=window.MLSearchResult.length,e;for(k=0;k<h;k++){e=window.MLSearchResult[k];if(e.id==a){b=this._MergeItemInfo(e,b);window.MLSearchResult[k]=b;window.MLSearchResult[k].collections=n;window.MLSearchResult[k].perm=e.perm;this.Search.DisplayResult(window.MLSearchResult,this.Search.Query);break}}}},_MergeItemInfo:function(c,b){if(typeof c=="object"&&typeof b=="object"){for(var a in b){if(b[a]&&(b[a].length>0||b[a]>0)){c[a]=b[a]}}}return c},FindItem:function(c,d){if(MLItems[c]&&typeof MLItems[c]=="object"&&MLItems[c].length>0){var b,a=MLItems[c].length;for(b=0;b<a;b++){el=MLItems[c][b];if(el&&el.id==d){return b}}}return false},InitMultiaction:function(){var a=this;this.pMultiActCont=BX("ml_multiaction_cnt");if(!this.pMultiActCont){return}this.pCheckAll=BX("ml_action_target");this.arLoadItems={};this.pDelBut=BX("action_delete_button");this.pCheckAll.onclick=function(){var e=!!this.checked,b=a.pCollCont.getElementsByTagName("INPUT"),d,c=b.length;for(d=0;d<c;d++){if(b[d].type=="checkbox"){b[d].checked=e}}a.EnableMultiAction(e);a.arLoadItems={};if(e){for(d=0,c=a.arCollections.length;d<c;d++){a.arLoadItems[a.arCollections[d].id]=true}}};this.pDelBut.onclick=function(){if(!a.bMultiActEnabled||!confirm(ML_MESS.MultiDelConfirm)){return}var b=a.MultiActGetSelected();a.Request({action:"multi_del",postData:{cols:b.Colls,items:b.Items},handler:function(){a.Refresh({curColl:a.SelectedColId})}})}},AskAllCheckBoxes:function(){var a=this.pCollCont.getElementsByTagName("INPUT");if(this.Search.bShowed){a=[].concat(a,this.Search.GetCheckboxes())}for(var c=0,b=a.length;c<b;c++){if(a[c].type=="checkbox"&&a[c].checked){return true}}return false},EnableMultiAction:function(a){this.bMultiActEnabled=a;if(a){BX.removeClass(this.pMultiActCont,"multi-dis")}else{BX.addClass(this.pMultiActCont,"multi-dis")}},CheckAllCollChild:function(a,j,g){var d=this.oCollections[a],b,f,e=this.arCollections.length;d.pCheck.checked=j;if(g){this.arMultiSelect={Cols:[a],Items:[],NotLoadedItems:[]}}if(d.childCount>0){for(f=0;f<e;f++){b=this.arCollections[f];if(b.parent==a){this.CheckAllCollChild(b.id,j)}}}if(typeof MLItems[a]=="undefined"){if(j){this.arLoadItems[a]=true}else{this.arLoadItems[a]=false}}else{if(typeof MLItems[a]=="object"&&MLItems[a].length>0){var h=d.pChildCont.getElementsByTagName("INPUT"),c=h.length;for(f=0;f<c;f++){if(h[f].type=="checkbox"){h[f].checked=j}}}}if(g){this.EnableMultiAction(j||this.AskAllCheckBoxes())}},MultiActGetSelected:function(){var b=[],k={},o=this.pCollCont.getElementsByTagName("INPUT"),h,e=o.length,d,q,m,a;for(h=0;h<e;h++){if(o[h].type=="checkbox"&&o[h].checked){d=o[h].value;if(d.indexOf("c_")!=-1){b.push(d.substr(2));continue}q=d.indexOf("|");if(q!=-1){m=d.substr(0,q);a=d.substr(q+1);if(!k[m]){k[m]=[]}k[m].push(a)}}}if(this.Search.bShowed){this.arChecks=false;var p=this.Search.GetCheckboxes();e=window.MLSearchResult.length;var g,c,f;for(h=0;h<e;h++){g=window.MLSearchResult[h];if(this.Search.checkedChIndex[g.id]){if(g.collections){for(f=0,c=g.collections.length;f<c;f++){m=g.collections[f];if(!k[m]){k[m]=[]}k[m].push(g.id)}}}}}return{Colls:b,Items:k}},InitContextMenu:function(){var b=this;var a=[{id:"edit",name:ML_MESS.Edit,title:ML_MESS.EditCollection,handler:function(c){b.OpenEditCollDialog({id:c.id.substr("mlccm_".length)})}},{id:"del",name:ML_MESS.Delete,title:ML_MESS.DelCollection,handler:function(c){b.DelCollection(c.id.substr("mlccm_".length))}},{id:"access",name:ML_MESS.Access,title:ML_MESS.AccessTitle,handler:function(c){window.location="/bitrix/admin/fileman_medialib_access.php?col_id="+c.id.substr("mlccm_".length)}},{id:"add_item",name:ML_MESS.AddElement,title:ML_MESS.AddElementTitle,handler:function(c){b.OpenEditItemDialog({parentCol:c.id.substr("mlccm_".length)})}},{id:"add_col",name:ML_MESS.AddCollection,title:ML_MESS.AddCollectionTitle,handler:function(c){b.OpenEditCollDialog({parentCol:c.id.substr("mlccm_".length)})}}];a.push({id:"change_type",name:ML_MESS.ChangeType,title:ML_MESS.ChangeTypeTitle,handler:function(c){b.OpenChangeTypeDialog({id:c.id.substr("mlccm_".length)})}});this.ClearOverlay=new BXOverlay({id:"bx_clear",className:"bx-clear-overlay"});this.oColMenu=new MLContextMenu({id:"coll",Items:a,Overlay:this.ClearOverlay,cmPushed:"ml-col-menu-pushed"})},Refresh:function(c){var a=c?parseInt(c.curColl):0,b=window.location.toString();if(a>0){if(b.indexOf("cur_col=")!=-1){b=b.replace(/(cur_col=)(\d)+/g,"$1"+a)}else{b+=(b.indexOf("?")==-1?"?":"&")+"cur_col="+a}}window.location=b},CheckFileExt:function(c,d){c=c.substr(c.lastIndexOf(".")+1);c=c.toLowerCase();if(!d){d=this.arExt}for(var b=0,a=d.length;b<a;b++){if(d[b]==c){return true}}return false},AppendKeywords:function(f,e){if(!f||!e){return}var g=[],c=f.value.split(",").concat(e.split(",")),d,b,a=c.length;for(b=0;b<a;b++){d=BX.util.trim(c[b]);if(d&&!BX.util.in_array(d,g)){g.push(d)}}f.value=g.join(", ")},InitTypeSelector:function(){this.bTypes=this.Types.length>1;if(this.bTypes){this.pTypeCont=BX("ml_type_cont");this.pTypeCont.style.display="block";this.oTypeSelector=new BXMLTypeSelector({oML:this,Types:this.Types,oCallback:{obj:this,func:this.TypeOnChange}});this.pTypeCont.appendChild(this.oTypeSelector.pWnd);this.oTypeSelector.SetType(this.oConfig.curTypeInd,false);this.curType=this.Types[this.oConfig.curTypeInd]}else{this.curType=this.Types[this.oConfig.curTypeInd]}},TypeOnChange:function(a){if(this.Types[a.typeInd].id!=this.curType.id){window.location="/bitrix/admin/fileman_medialib_admin.php?lang="+this.oConfig.lang+"&type="+this.Types[a.typeInd].id}},CheckMLType:function(a){a=parseInt(a);if(!this.bTypes||a==this.curType.id){return true}if((!this.curType||this.curType.code=="image"&&this.curType.system)&&(!a||a==this.curType.id)){return true}return false},OpenChangeTypeDialog:function(e){if(!e){e={}}if(!this.ChangeTypeDialog){this.CreateChangeTypeDialog()}var f=600,d=this.ChangeTypeDialog,a=BX.GetWindowSize(),c=parseInt(a.scrollLeft+a.innerWidth/2-d.width/2),b=parseInt(a.scrollTop+a.innerHeight/2-d.height/2);d.oCol=this.GetCollection(e.id);d.Overlay.Show({zIndex:f-10});d.pWnd.style.zIndex=f;d.pWnd.style.display="block";d.pType.value="none";this._TypeOnChange();jsFloatDiv.Show(this.ChangeTypeDialog.pWnd,c,b);BX.bind(document,"keypress",window.MlChTypeOnKeypress)},CreateChangeTypeDialog:function(h){var g=this,j,b,a={width:360,height:125,pWnd:BX("mlsd_change_type"),pType:BX("mlsd_chtype_type"),pParent:BX("mlsd_chtype_parent"),Overlay:new BXOverlay({id:"bxml_ch_type_overlay"})};a.pType.onchange=function(){g._TypeOnChange()};for(var f=0,c=this.Types.length;f<c;f++){if(this.Types[f].id!=this.curType.id){a.pType.options.add(new Option(this.Types[f].name,f))}}this._typeColInd={};this.arTypeCol={};var k=[],d,e=0,f,c=this.arCollections.length;for(f=0;f<c;f++){if(!this._buildTypeCol(this.arCollections[f],f)){k.push([this.arCollections[f],f])}}while(k.length>0&&e<50){c=k.length;d=[];for(f=0;f<c;f++){if(!this._buildTypeCol(k[f][0],k[f][1])){d.push(k[f])}}k=d;e++}BX("mlsd_chtype_save").onclick=function(){if(g.ChangeColType()!==false){}g.CloseChangeTypeDialog()};BX("mlsd_chtype_cancel").onclick=function(){g.CloseChangeTypeDialog()};BX("mlsd_chtype_close").onclick=function(){g.CloseChangeTypeDialog()};window.MlChTypeOnKeypress=function(i){if(!i){i=window.event}if(i&&i.keyCode==27){g.CloseChangeTypeDialog()}};a.pWnd.style.width=a.width+"px";a.pWnd.style.height=a.height+"px";this.ChangeTypeDialog=a},CloseChangeTypeDialog:function(){this.ChangeTypeDialog.pWnd.style.display="none";jsFloatDiv.Close(this.ChangeTypeDialog.pWnd);this.ChangeTypeDialog.Overlay.Hide();BX.unbind(document,"keypress",window.MlChTypeOnKeypress)},_TypeOnChange:function(){var b=this.ChangeTypeDialog.pParent;if(this.ChangeTypeDialog.pType.value=="none"){b.disabled=true;this._ReqBuildCollSelect(b,[],0,true)}else{b.disabled=false;var a=this.Types[this.ChangeTypeDialog.pType.value];this._ReqBuildCollSelect(b,this.arTypeCol[a.id]||[],0,true)}},_buildTypeCol:function(d,c){if(!d){return false}var a=d.type||this.imageTypeId,e,b;if(!this.arTypeCol[a]){this.arTypeCol[a]=[]}d.parent=parseInt(d.parent);if(!d.parent){e=0;b=this.arTypeCol[a]}else{if(this._typeColInd[d.parent]){e=this._typeColInd[d.parent].level+1;this._typeColInd[d.parent].childCount++;b=this._ReqFindChildCol(this.arTypeCol[a],d.parent)}else{return false}}if(b&&typeof b=="object"){b.push({id:d.id,child:[]})}this._typeColInd[d.id]={ind:c,level:e,childCount:0};return true},ChangeColType:function(){var e=this,d=e.ChangeTypeDialog,c=d.pType.value,b=d.pParent.value;if(c!="none"){var a=this._IterGetChildCols(this._ReqFindChildCol(this.arCollectionsTree,d.oCol.id));if(a.length>0&&!confirm(ML_MESS.ChangeTypeChildConf)){return false}this.Request({action:"change_col_type",postData:{col:d.oCol.id,type:this.Types[c].id,parent:b,children:a},handler:function(){if(window.bx_req_res===false){alert(ML_MESS.ChangeTypeError)}else{return e.Refresh()}}})}return true},_IterGetChildCols:function(b){var d=[],c,a=b.length;for(c=0;c<a;c++){d.push(b[c].id);if(b[c].child.length>0){d=d.concat(this._IterGetChildCols(b[c].child))}}return d}};function BXMLSearch(a){this.oML=a;this.Init()}BXMLSearch.prototype={Init:function(){var a=this;this.bShowed=false;this.pInput=BX("ml_search_input");this.pButton=BX("ml_search_button");this.pResultCont=BX("ml_search_res_cont");this.pResultContDiv=BX("ml_s_res_cnt_div");this.pResultContPar=BX("ml_search_res_cont_par");this.pResultTitle=BX("ml_srch_res_title");this.pResultCheckbox=BX("ml_srch_res_check");this.pResultFlip=BX("ml_srch_res_flip");this.pResultHide=BX("ml_srch_res_hide");this.pButton.onclick=function(){if(a.pInput.value.length>0){a.Search(a.pInput.value)}};this.pInput.onkeydown=function(b){if(!b){b=window.event}if(b.keyCode==13&&this.value.length>0){a.Search(this.value)}};this.pResultHide.onclick=function(b){a.pResultContPar.style.display="none";a.bShowed=false;return BX.PreventDefault(b)};this.pResultFlip.onclick=function(b){a.OpenResultCont();return BX.PreventDefault(b)};this.pResultCheckbox.onclick=function(f){var g=this.checked,b=a.GetCheckboxes(),d,c=b.length;for(d=0;d<c;d++){b[d].checked=g&&!b[d].disabled}a.oML.EnableMultiAction(g||a.oML.AskAllCheckBoxes());if(!f){f=window.event}if(f.stopPropagation){f.stopPropagation()}else{f.cancelBubble=true}}},GetCheckboxes:function(){this.checkedChIndex={};if(!this.arChecks){this.arChecks=[];var a=this.pResultCont.getElementsByTagName("INPUT"),c,b=a.length;for(c=0;c<b;c++){if(a[c].type=="checkbox"&&a[c].value.indexOf("search_result")!=-1){this.arChecks.push(a[c]);if(a[c].checked){this.checkedChIndex[a[c].value.substr(14)]=true}}}}else{for(var c=0,b=this.arChecks.length;c<b;c++){if(this.arChecks[c].checked){this.checkedChIndex[this.arChecks[c].value.substr(14)]=true}}}return this.arChecks},Search:function(a){var b=this;window.MLSearchResult=false;this.oML.Request({action:"search",postData:{q:a},handler:function(){if(window.MLSearchResult){b.DisplayResult(window.MLSearchResult,a)}}})},DisplayResult:function(a,c){this.arChecks=false;this.bOpened=false;this.bShowed=true;this.Query=c;this.pResultContPar.style.display="block";this.OpenResultCont();this.pResultTitle.innerHTML=ML_MESS.SearchResultEx.replace("#SEARCH_QUERY#",BX.util.htmlspecialchars(c));while(this.pResultCont.firstChild){this.pResultCont.removeChild(this.pResultCont.lastChild)}var d,b=a.length;if(b>0){for(d=0;d<b;d++){this.oML.DisplayItem({bSearch:true,Item:a[d],pCont:this.pResultCont,bCheck:false,id:"search_result",Access:a[d].perm})}}else{this.pResultCont.appendChild(BX.create("DIV",{props:{className:"ml-search-no-result"},text:ML_MESS.NoResult}))}},OpenResultCont:function(){if(!this.bOpened){this.pResultFlip.className="ml-col-icon ml-col-icon-opened";this.pResultContDiv.style.display="block"}else{this.pResultContDiv.style.display="none";this.pResultFlip.className="ml-col-icon ml-col-icon-closed"}this.bOpened=!this.bOpened}};function MLContextMenu(a){this.Items=a.Items;this.oOverlay=a.Overlay;this.zIndex=a.zIndex||600;this.id=a.id||"menu";this.cmPushed=a.cmPushed;this.PreCreate()}MLContextMenu.prototype={PreCreate:function(){this.pref="ML_"+this.id+"_";this.oDiv=document.body.appendChild(BX.create("DIV",{props:{className:"bx-cm",id:this.pref+"_cont"},style:{zIndex:this.zIndex},html:'<table><tr><td class="bxcm-popup"><table id="'+this.pref+'_cont_items"><tr><td></td></tr></table></td></tr></table>'}));document.body.appendChild(BX.create("IFRAME",{props:{id:this.pref+"_frame",src:"javascript:void(0)"},style:{position:"absolute",zIndex:this.zIndex-5,left:"-1000px",top:"-1000px",visibility:"hidden"}}));this.menu=new PopupMenu(this.pref+"_cont")},Create:function(){this.BuildItems();this.bCreated=true},Show:function(e){if(!this.bCreated){this.Create()}this.oDiv.style.width=parseInt(this.oDiv.firstChild.offsetWidth)+"px";this.pElement=e.pElement;var j=jsUtils.GetRealPos(this.pElement),g=this,a=parseInt(this.oDiv.offsetWidth),d=parseInt(this.oDiv.offsetHeight),b=this.oOverlay.Show();if(this.cmPushed){BX.addClass(this.pElement,this.cmPushed)}if(e.arHideItems.length>0){var c,f=this.Items.length;for(c=0;c<f;c++){if(typeof this.Items[c]=="object"){this.Items[c].pWnd.style.display=e.arHideItems[this.Items[c].id]?"none":(BX.browser.IsIE()?"inline":"table-cell")}}}b.onclick=function(){g.Close()};window.overlay_keypress=function(h){g.OnKeyPress(h)};BX.bind(window,"keypress",window.overlay_keypress);j.top+=2;j.left+=1;this.menu.PopupShow(j)},Close:function(){this.menu.PopupHide();this.oOverlay.Hide();if(this.cmPushed){BX.removeClass(this.pElement,this.cmPushed)}BX.unbind(window,"keypress",window.overlay_keypress)},BuildItems:function(){var c=BX(this.pref+"_cont_items"),f=this.Items.length;_this=this;var d,a,e;for(d=0;d<f;d++){e=this.Items[d];a=c.insertRow(-1).insertCell(-1);if(e=="separator"){a.innerHTML='<div class="popupseparator"></div>'}else{a.innerHTML='<table class="popupitem" id="bx_cm_'+e.id+'"><tr><td class="gutter"><div class="bx-button" id="bx_btn_'+e.id+'" ></div></td><td class="item">'+e.name+"</td></tr></table>";var b=a.firstChild;b.onmouseover=function(g){this.className="popupitem popupitemover"};b.onmouseout=function(g){this.className="popupitem"};b.onclick=function(g){_this.OnClick(this)};e.pWnd=a}}this.oDiv.style.width=c.parentNode.offsetWidth;return true},OnClick:function(d){var b,c=this.Items.length,a=d.id.substring("bx_cm_".length);this.Close();for(b=0;b<c;b++){if(this.Items[b].id==a&&this.Items[b].handler){return this.Items[b].handler(this.pElement)}}},OnKeyPress:function(a){if(!a){a=window.event}if(a.keyCode==27){this.Close()}}};