function BXMediaLib(a){this.oConfig=a;window.MLItems={};this.arItemsCollList={};this.userSettings=this.oConfig.userSettings;this.arExt=this.oConfig.strExt.split(",")}BXMediaLib.prototype={Open:function(d){if(window.oBXMedialib&&oBXMedialib.bOpened){return}var k=this;this.sessid=this.oConfig.sessid;this.bOpened=true;this.width=this.userSettings.width;this.height=this.userSettings.height;this.zIndex=this.oConfig.zIndex||2050;this.Overlay=new BXOverlay({id:"bx_ml_trans_overlay"});this.bSubdialogOpened=false;this.arRedrawCollections={};this.Types=this.oConfig.Types;this.curType="";this.requestTypes=[];var c,a,f,g,b,e;for(c=0,a=this.Types.length;c<a;c++){g=[];f=this.Types[c].ext.split(",");for(b=0;b<f.length;b++){e=BX.util.trim(f[b]);if(e.length>0){g.push(e.toLowerCase())}}this.Types[c].arExt=g;if(this.Types[c].system&&this.Types[c].code=="image"){this.requestTypes.push(0)}this.requestTypes.push(this.Types[c].id)}this.Request({action:"start",postData:{types:k.requestTypes},handler:function(m){if(!window.MLCollections){return false}if(m){k.Overlay.Show({zIndex:k.zIndex-10,clickCallback:{func:k.Close,obj:k}});k.arCollections=window.MLCollections;k.pWnd=document.body.appendChild(BX.create("DIV",{props:{id:"bxmedialib",className:"bxml-dialog"}}));var i=BX.GetWindowSize(),l=parseInt(i.scrollLeft+i.innerWidth/2-k.width/2),j=parseInt(i.scrollTop+i.innerHeight/2-k.height/2);if(!k.bReadOnly){k.pDialogCont=document.body.appendChild(BX.create("DIV",{props:{className:"bxml-subdialog-cont"}}));k.pDialogCont.innerHTML=m.substring(m.indexOf("#ML_SUBDIALOGS_BEGIN#")+21,m.indexOf("#ML_SUBDIALOGS_END#"));k.pDialogCont.style.zIndex=k.zIndex+250}k.pWnd.style.zIndex=k.zIndex;k.pWnd.innerHTML=m.substring(m.indexOf("#ML_MAIN_DIALOG_BEGIN#")+22,m.indexOf("#ML_MAIN_DIALOG_END#"));jsFloatDiv.Show(k.pWnd,l,j,5,false,false);k.OnDialogOpen()}}})},Close:function(){jsFloatDiv.Close(this.pWnd);BX.unbind(document,"keypress",window.MlOnKeypress);if(this.pWnd.parentNode){this.pWnd.parentNode.removeChild(this.pWnd)}if(this.pDialogCont.parentNode){this.pDialogCont.parentNode.removeChild(this.pDialogCont)}this.Overlay.Remove();if(this.EditCollDialog){this.EditCollDialog.Overlay.Remove()}if(this.EditItemDialog){this.EditItemDialog.Overlay.Remove()}if(this.Confirm){this.Confirm.Overlay.Remove()}oBXMedialib.bOpened=false},OnDialogOpen:function(){var a=this;this.pLeftCont=BX("ml_left_cont");this.pRightCont=BX("ml_right_cont");this.pFrameTbl=BX("ml_frame");this.pCollCont=BX("ml_coll_cont");this.pHeaderCont=BX("ml_head_cont");this.pListCont=BX("ml_list_cont");this.pButCont=BX("ml_but_cont");this.Search=new BXMLSearch(this);this.pInfo={pWnd:BX("ml_info_wnd"),name:BX("ml_info_name"),desc:BX("ml_info_desc"),keywords:BX("ml_info_keys"),collections:BX("ml_info_colls"),details:BX("ml_info_details")};this.pBread=BX("ml_breadcrumbs");this.pResizer=BX("bxml_resizer");this.pResizer.onmousedown=function(){a.ResizerMouseDown()};this.pResizer.ondrag=BX.False;this.pAddNewColl=BX("ml_add_collection");this.pAddNewItem=BX("ml_add_item");this.InitTypeSelector();this.BuildCollections();if(this.userSettings.coll_id>0){this.SelectCollection(this.userSettings.coll_id,true)}if(!this.bReadOnly){this.pAddNewColl.onclick=function(b){a.OpenEditCollDialog({bGetSelCol:true});return BX.PreventDefault(b)};this.pAddNewColl.style.display=this.bCommonEdit?"inline":"none";this.pAddNewItem.onclick=function(b){a.OpenEditItemDialog({bGetSelCol:true});return BX.PreventDefault(b)};this.pAddNewItem.style.display=this.bCommonItemEdit?"inline":"none"}else{this.pAddNewColl.style.display="none";this.pAddNewItem.style.display="none"}BX("medialib_but_cancel").onclick=BX("bxml_close").onclick=function(){a.Close()};this.pButSave=BX("medialib_but_save");this.pButSave.onclick=function(){a.Submit()};if(this.bNoCollections){BX.addClass(this.pLeftCont,"ml-no-colls-sect");this.pAddNewItem.style.display="none"}window.MlOnKeypress=function(b){if(!b){b=window.event}if(b&&b.keyCode==27&&!a.bSubdialogOpened){a.Close()}};BX.bind(document,"keypress",window.MlOnKeypress);this.FillInfoPanel(false);setTimeout(function(){a.Resize(a.width,a.height)},50)},Submit:function(){if(!this.SelectedItemId||!this.oCurItems[this.SelectedItemId]||!this.oConfig.resType||!this.oConfig.arResultDest){return false}var c=this.oCurItems[this.SelectedItemId].oItem,a=this.oConfig.resType,b=this.oConfig.arResultDest;if(a=="FUNCTION"&&typeof window[b.FUNCTION_NAME]=="function"){window[b.FUNCTION_NAME]({src:c.path,name:bxspcharsback(c.name),description:bxspcharsback(c.desc),width:c.width,height:c.height,file_size:c.file_size,type:"image"})}else{if(a=="FORM"&&document.forms[b.FORM_NAME]&&document.forms[b.FORM_NAME][b.FORM_ELEMENT_NAME]){document.forms[b.FORM_NAME][b.FORM_ELEMENT_NAME].value=c.path;BX.fireEvent(document.forms[b.FORM_NAME][b.FORM_ELEMENT_NAME],"change")}else{if(a=="ID"&&BX(b.ELEMENT_ID)){BX(b.ELEMENT_ID).value=c.path;BX.fireEvent(BX(b.ELEMENT_ID),"change");if(this.oConfig.description_id.length>0&&BX(this.oConfig.description_id)){BX(this.oConfig.description_id).value=c.name}}else{alert(ML_MESS.BadSubmit)}}}this.Close()},BuildCollections:function(){this.oCollections={};this.arCollectionsTree=[];this.bCommonEdit=!!this.oConfig.rootAccess.edit||false;this.bCommonItemEdit=!!this.oConfig.rootAccess.edit_item||false;this.bNoCollections=true;var e=[],d,c=0,b,a=this.arCollections.length;for(b=0;b<a;b++){if(!this.BuildCollection(this.arCollections[b],b)){e.push([this.arCollections[b],b])}}while(e.length>0&&c<50){a=e.length;d=[];for(b=0;b<a;b++){if(!this.BuildCollection(e[b][0],e[b][1])){d.push(e[b])}}e=d;c++}this.bReadOnly=!this.bCommonEdit&&!this.bCommonItemEdit;if(this.bNoCollections){BX.addClass(this.pLeftCont,"ml-no-colls-sect");this.pAddNewItem.style.display="none"}},BuildCollection:function(e,d){if(typeof e!="object"||!this.CheckMLType(e.type)){return true}if(this.bNoCollections){this.bNoCollections=false;BX.removeClass(this.pLeftCont,"ml-no-colls-sect");this.pAddNewItem.style.display="inline"}var k,a,j=this,b;e.parent=parseInt(e.parent);if(!e.parent){k=this.pCollCont;a=0;b=this.arCollectionsTree}else{if(this.oCollections[e.parent]){k=this.oCollections[e.parent].pChildCont;a=this.oCollections[e.parent].level+1;this.oCollections[e.parent].childCount++;if(this.oCollections[e.parent].childCount==1){this.oCollections[e.parent].icon.className="ml-col-icon-closed"}b=this._ReqFindChildCol(this.arCollectionsTree,e.parent)}else{return false}}b.push({id:e.id,child:[]});this.arRedrawCollections[this.curType.id]=true;if(k){var f=this.UserCan(e,"del"),l=this.UserCan(e,"edit"),c=BX.create("DIV",{props:{id:"ml_coll_title_"+e.id}}),i=c.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-icon"}})),n=c.appendChild(BX.create("SPAN",{props:{title:bxspcharsback(e.desc||e.name)},text:e.name})),g=BX.create("DIV",{props:{className:"ml-coll-child-cont"}});if(f){var o=c.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-del",title:ML_MESS.DelCollection}}));o.onclick=function(p){j.DelCollection(this.parentNode.id.substr("ml_coll_title_".length));return BX.PreventDefault(p||window.event)}}if(l){var m=c.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-edit",title:ML_MESS.EditCollection}}));m.onclick=function(p){var q=this.parentNode.id.substr("ml_coll_title_".length);j.OpenEditCollDialog({id:q});return BX.PreventDefault(p||window.event)};this.bCommonEdit=true}if(!this.bCommonItemEdit&&this.UserCan(e,"new_item")){this.bCommonItemEdit=true}if(f||l){c.onmouseover=function(){BX.addClass(this,"mlcollt-over")};c.onmouseout=function(){BX.removeClass(this,"mlcollt-over")}}j._SetColTitleLevel(c,a);c.title=bxspcharsback(e.desc||e.name);c.onclick=function(){j.SelectCollection(this.id.substr("ml_coll_title_".length))};i.onclick=function(p){var q=this.parentNode.id.substr("ml_coll_title_".length);j.OpenCollection(q);return BX.PreventDefault(p||window.event)};k.appendChild(c);k.appendChild(g);this.oCollections[e.id]={ind:d,pTitle:c,pChildCont:g,icon:i,level:a,childCount:0,bOpened:false};return true}},ReNewCollectionTree:function(){this.arRedrawCollections[this.curType.id]=true;this.arCollectionsTree=[];var e=[],d,c=0,b,a=this.arCollections.length;for(b=0;b<a;b++){if(typeof this.arCollections[b]!="object"||!this.CheckMLType(this.arCollections[b].type)){continue}if(!this.ReNewCol4Tree(this.arCollections[b])){e.push(this.arCollections[b])}}while(e.length>0&&c<50){a=e.length;d=[];for(b=0;b<a;b++){if(!this.ReNewCol4Tree(e[b])){d.push(e[b])}}e=d;c++}},ReNewCol4Tree:function(c){var a=parseInt(c.parent),b;if(!a){b=this.arCollectionsTree}else{if(this.oCollections[a]){b=this._ReqFindChildCol(this.arCollectionsTree,a)}}if(!b){return false}b.push({id:c.id,child:[]});return true},SelectCollection:function(f,b){var e=this.oCollections[f];if(!e||this.SelectedColId==f){return}this.DeSelectCollection(false);this.SelectedColId=f;BX.addClass(e.pTitle,"mlcollt-active");var d=this.GetCollsCrumbs(f);this.BuildCrumbs(d);if(b){var c,a=d.length;for(c=1;c<a;c++){if(!this.oCollections[d[c].id].bOpened){this.OpenCollection(d[c].id)}}}this.userSettings.coll_id=f;this.ShowItems(f);this.SelectItem();this.SaveSettings()},DeSelectCollection:function(a){if(this.SelectedColId&&this.oCollections[this.SelectedColId]){BX.removeClass(this.oCollections[this.SelectedColId].pTitle,"mlcollt-active")}if(a!==false){this.BuildCrumbs([])}},UserCan:function(c,b){var a;if(typeof c!=="object"){if(c===0){a=this.oConfig.rootAccess}else{c=this.GetCollection(c);if(typeof c!=="object"){return false}a=c.access}}else{a=c.access}return a&&a[b]==="1"},GetCollsCrumbs:function(c){var b=[],a;while(c){a=this.GetCollection(c);if(a){b.push(a);c=a.parent}else{c=false}}return b},BuildCrumbs:function(d){while(this.pBread.childNodes.length>0){this.pBread.removeChild(this.pBread.firstChild)}var e=this,c,b,a=d.length;for(b=a-1;b>=0;b--){c=d[b];if(!c||typeof c!="object"){continue}pCr=this.pBread.appendChild(BX.create("DIV",{props:{className:"ml-crumb",id:"ml_crumb_"+c.id,title:c.desc},text:c.name}));if(b>0){this.pBread.appendChild(BX.create("DIV",{props:{className:"ml-crumb-sep"}})).appendChild(document.createTextNode(" "));pCr.onclick=function(){e.SelectCollection(this.id.substr("ml_crumb_".length))}}else{pCr.style.cursor="default"}}return d},GetCollection:function(c){if(this.oCollections[c]){return this.arCollections[this.oCollections[c].ind]}var b,a=this.arCollections.length;for(b=0;b<a;b++){if(this.arCollections[b].id==c){return this.arCollections[b]}}return false},_ReqFindChildCol:function(a,e){var d,b=a.length,c=false;for(d=0;d<b;d++){if(a[d].id==e){c=a[d].child;break}else{if(a[d].child.length>0){c=this._ReqFindChildCol(a[d].child,e);if(c){break}}}}return c},_ReqBuildCollSelect:function(c,m,a,n){if(!a){a=0}var g,d=m.length,e=c.options.length,f,k;if(n==true){var b=1;while(c.options[b]){c.options[b]=null}}for(g=0;g<d;g++){col=this.GetCollection(m[g].id);if(col){k="";for(f=0;f<a;f++){k+=" . "}k+=bxspcharsback(col.name);opt=new Option(k,m[g].id);opt.title=bxspcharsback(col.name);c.options.add(opt);if(m[g].child.length>0){this._ReqBuildCollSelect(c,m[g].child,a+1)}}}},OpenCollection:function(b){var a=this.oCollections[b];if(a.childCount>0){if(!a.bOpened){a.pChildCont.style.display="block";a.icon.className="ml-col-icon ml-col-icon-opened"}else{a.pChildCont.style.display="none";a.icon.className="ml-col-icon ml-col-icon-closed"}a.bOpened=!a.bOpened}},DelCollection:function(g){if(g>0&&confirm(ML_MESS.DelCollectionConf)){var d=[];if(this.oCollections[g].childCount>0){var e=this.oCollections[g].pChildCont.getElementsByTagName("DIV"),c,a=e.length,b;for(c=0;c<a;c++){if(e[c].id.substr(0,14)=="ml_coll_title_"){b=parseInt(e[c].id.substr(14));if(b>0){d.push(b)}}}}var f=this;this.Request({action:"del_collection",postData:{id:g,child_cols:d},handler:function(){if(window.bx_req_res){f.CSDelCollection(g,d)}}})}},_IncreaseCollChild:function(c,a){var b=this.oCollections[c];if(b){if(a!==-1){b.childCount++;if(b.childCount>0){b.icon.className="ml-col-icon "+(b.bOpened?"ml-col-icon-opened":"ml-col-icon-closed");if(b.bOpened){b.pChildCont.style.display="block"}}}else{b.childCount--;if(b.childCount<=0){b.icon.className="ml-col-icon";b.pChildCont.style.display="none"}}}},_SetColTitleLevel:function(a,b){a.className="ml-coll-title mlcolllevel-"+(b>3?3:b);a.childNodes[0].style.marginLeft=(3+b*8)+"px";if(b>=3){a.childNodes[1].className="ml-smaller-title"}},SaveCollection:function(){var b=this.EditCollDialog,c=this,a={name:encodeURIComponent(b.pName.value),desc:encodeURIComponent(b.pDesc.value),keywords:encodeURIComponent(b.pKeys.value),parent:b.pParent.value,type:b.typeId};if(b.pName.value==""){alert(ML_MESS.ColNameError);b.pName.focus();return false}if(!b.bNew){a.id=b.oCol.id}this.Request({action:"edit_collection",postData:a,handler:function(){if(window.bx_req_res!==false){c.CloseEditCollDialog();var i={id:window.bx_req_res.id,name:b.pName.value,desc:b.pDesc.value,date:"",keywords:b.pKeys.value,parent:a.parent,access:window.bx_req_res.access,type:b.typeId};if(b.bNew){c.bNoCollections=true;c.arCollections.push(i);c.BuildCollection(i,c.arCollections.length-1)}else{var f=c.oCollections[i.id].pTitle,d=c.oCollections[i.id].pChildCont,e=c.arCollections[c.oCollections[i.id].ind].parent,g=i.parent||0;if(c.arCollections[c.oCollections[i.id].ind].parent!=g){c._IncreaseCollChild(e,-1);c._IncreaseCollChild(g);var j=g==0?c.pCollCont:c.oCollections[g].pChildCont;j.appendChild(f);j.appendChild(d);var k=g==0?0:c.oCollections[g].level+1;c.oCollections[i.id].level=k;c._SetColTitleLevel(f,k)}c.arCollections[c.oCollections[i.id].ind]=i;f.childNodes[1].innerHTML=BX.util.htmlspecialchars(i.name);f.title=i.desc||i.name}c.ReNewCollectionTree();c.SelectCollection(i.id)}else{alert("error")}}})},OpenEditCollDialog:function(f){if(!f){f={}}if(!this.EditCollDialog){this.CreateEditCollDialog()}this.EditCollDialog.bNew=!f.id;var g=f.zIndex||this.zIndex+200,e=this.EditCollDialog,a=BX.GetWindowSize(),d=parseInt(a.scrollLeft+a.innerWidth/2-e.width/2),c=parseInt(a.scrollTop+a.innerHeight/2-e.height/2);if(this.arRedrawCollections[this.curType.id]){this._ReqBuildCollSelect(e.pParent,this.arCollectionsTree,0,true);this.arRedrawCollections[this.curType.id]=false}e.Overlay.Show({zIndex:g-10});e.pWnd.style.zIndex=g;e.pWnd.style.display="block";this.bSubdialogOpened=true;this.EditCollDialog.bFocusKeywords=false;if(!e.bNew){var b=this.GetCollection(f.id);e.pName.value=bxspcharsback(b.name);e.pDesc.value=bxspcharsback(b.desc);e.pKeys.value=bxspcharsback(b.keywords);e.pParent.value=b.parent||0;this.EditCollDialog.oCol=b}else{e.pName.value="";e.pDesc.value="";e.pKeys.value="";e.pParent.value=0;this._SetFirstAvailableCol();if(!f.parentCol&&f.bGetSelCol&&this.SelectedColId&&this.oCollections[this.SelectedColId]){f.parentCol=this.SelectedColId}if(f.parentCol>0&&this.UserCan(f.parentCol,"new_col")){e.pParent.value=f.parentCol}var b=this.GetCollection(f.parentCol);if(b&&b.keywords){e.pKeys.value=b.keywords}}e.typeId=this.curType.id||"";e.pName.onchange();jsFloatDiv.Show(this.EditCollDialog.pWnd,d,c,5,false,false);BX.bind(document,"keypress",window.MlEdColOnKeypress)},CreateEditCollDialog:function(b){var c=this,a={width:360,height:230,pWnd:BX("mlsd_coll"),pTitle:BX("mlsd_coll_title"),pName:BX("mlsd_coll_name"),pDesc:BX("mlsd_coll_desc"),pKeys:BX("mlsd_coll_keywords"),pParent:BX("mlsd_coll_parent"),Overlay:new BXOverlay({id:"bxml_ed_col_overlay"})};a.pName.onkeydown=a.pName.onchange=function(){setTimeout(function(){var e=c.EditCollDialog,f=bxhtmlspecialchars(e.pName.value),d=e.bNew?ML_MESS.NewCollection:ML_MESS.Collection;e.pTitle.title=d+(f.length>0?": "+e.pName.value:"");e.pTitle.innerHTML=d+(f.length>0?": "+f:"")},20)};a.pKeys.onchange=a.pKeys.onblur=function(){c.EditCollDialog.bFocusKeywords=true};a.pParent.onchange=function(){if(!c.EditCollDialog.bNew&&this.value==c.EditCollDialog.oCol.parent){return true}if(c.EditCollDialog.bNew&&!c.UserCan(parseInt(this.value),"new_col")||!c.EditCollDialog.bNew&&!c.UserCan(parseInt(this.value),"edit")){c._SetFirstAvailableCol();return alert(ML_MESS.CollAccessDenied3)}if(c.EditCollDialog.oCol){var e=c._ReqFindChildCol(c.arCollectionsTree,c.EditCollDialog.oCol.id);if(!e||c._ReqFindChildCol(e,this.value)){alert(ML_MESS.ColLocEr2);this.value=c.EditCollDialog.oCol.parent||0;return true}}if(!c.EditCollDialog.bNew&&c.EditCollDialog.oCol.id==this.value){alert(ML_MESS.ColLocEr);this.value=c.EditCollDialog.oCol.parent||0}if(c.EditCollDialog.bNew&&!c.EditCollDialog.bFocusKeywords&&this.value>0){var d=c.GetCollection(this.value);if(d&&d.keywords){a.pKeys.value=d.keywords}}};BX("mlsd_coll_save").onclick=function(){c.SaveCollection()};BX("mlsd_coll_cancel").onclick=function(){c.CloseEditCollDialog()};BX("mlsd_coll_close").onclick=function(){c.CloseEditCollDialog()};this.arRedrawCollections[this.curType.id]=true;window.MlEdColOnKeypress=function(d){if(!d){d=window.event}if(d&&d.keyCode==27){c.CloseEditCollDialog()}};a.pWnd.style.width=a.width+"px";a.pWnd.style.height="auto";a.pWnd.style.minHeight="10px";this.EditCollDialog=a},CloseEditCollDialog:function(){this.EditCollDialog.pWnd.style.display="none";jsFloatDiv.Close(this.EditCollDialog.pWnd);this.EditCollDialog.Overlay.Hide();this.bSubdialogOpened=false;BX.unbind(document,"keypress",window.MlEdColOnKeypress)},_SetFirstAvailableCol:function(b){var e=this.EditCollDialog,b=e.bNew?"new_col":"edit",f,c,d,a=e.pParent.options.length;if(!e.bNew&&e.oCol.parent){e.pParent.value=e.oCol.parent}if(this.oConfig.rootAccess[b]){e.pParent.value=0}else{for(d=0;d<a;d++){f=e.pParent.options[d].value;c=this.GetCollection(f);if(c&&c.access&&c.access[b]){e.pParent.value=f;return}}}},ShowItems:function(d){var c=this;if(this.currentIdShowed==d){return}var b=this.GetCollection(d),a={edit:this.UserCan(b,"edit_item"),del:this.UserCan(b,"del_item")};if(typeof MLItems[d]!=="object"){this.Request({action:"get_items",postData:{col_id:d},handler:function(){if(!window.MLItems[d]){return false}c.DisplayItems(MLItems[d],a);this.currentIdShowed=d}})}else{this.DisplayItems(MLItems[d],a);this.currentIdShowed=d}},DisplayItems:function(c,d){while(this.pListCont.childNodes[1]){this.pListCont.removeChild(this.pListCont.lastChild)}this.oCurItems={};this.pListCont.firstChild.style.display=c&&c.length?"none":"block";if(c&&c.length){var b,a=c.length;for(b=0;b<a;b++){this.DisplayItem(c[b],d)}}},DisplayItem:function(j,l,d){if(!j||typeof j!="object"){return}var i=this,n=this.oConfig.thumbWidth,g=this.oConfig.thumbHeight,e=BX.create("DIV",{props:{id:"ml_item_"+j.id,className:"ml-item-cont",title:bxspcharsback(j.name)},style:{width:(n+15)+"px",height:(g+35)+"px"}}),p=e.appendChild(BX.create("IMG",{props:{src:j.thumb_path||"/bitrix/images/1.gif",className:"ml-item-thumb"}})),c=e.appendChild(BX.create("DIV",{props:{className:"ml-item-title"},style:{width:(n+8)+"px"}}));var b=j.thumb_path||j.path;if(j.type=="image"&&b){p.style.backgroundImage="url('"+b+"')"}if(!j.thumb_path||!j.width||!j.height){BX.addClass(p,"ml-item-no-thumb");j.height=100}if(g>j.height){var a=Math.round((g-j.height)/2);if(a>0){p.style.marginTop=a+"px";p.style.marginBottom=a+"px"}}c.appendChild(document.createTextNode(bxspcharsback(j.name)));var f=e.appendChild(BX.create("DIV",{props:{className:"ml-item-but-cont"}}));var k=f.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-item-view",title:ML_MESS.ViewItem}}));k.onclick=function(q){var r=this.parentNode.parentNode.id.substr("ml_item_".length);i.GetItemCollList(r,"OpenViewItDialog",{id:r,Access:l,bSearch:d});return BX.PreventDefault(q||window.event)};if(l.edit||l.del){if(l.edit){var m=f.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-item-edit",title:ML_MESS.EditItem}}));m.onclick=function(q){var r=this.parentNode.parentNode.id.substr("ml_item_".length);i.GetItemCollList(r,"OpenEditItemDialog",{id:r});return BX.PreventDefault(q||window.event)}}if(l.del){var o=f.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-item-del",title:ML_MESS.DelItem}}));o.onclick=function(q){var r=this.parentNode.parentNode.id.substr("ml_item_".length);i.GetItemCollList(r,"DelItem",{id:r});return BX.PreventDefault(q||window.event)}}e.onmouseover=function(){BX.addClass(this,"ml-item-cont-over")};e.onmouseout=function(){BX.removeClass(this,"ml-item-cont-over")}}e.onclick=function(q){i.SelectItem(this.id.substr("ml_item_".length))};e.ondblclick=function(q){i.Submit()};this.oCurItems[j.id]={oItem:j,pWnd:e};this.pListCont.appendChild(e)},OpenViewItDialog:function(d){if(!this.ViewItDialog){this.CreateViewItDialog(d)}var e,b,a,f=600,c=this.ViewItDialog;var e=this.oCurItems[d.id].oItem;this.bSubdialogOpened=true;if(!e){return}c.oItem=e;c.colId=d.colId;c.Overlay.Show({zIndex:f-10});c.pWnd.style.zIndex=f;c.pDel.style.display=d.Access.del?"inline":"none";c.pEdit.style.display=d.Access.edit?"inline":"none";c.pWnd.style.display="block";c.pWnd.style.visibility="hidden";c.bOpened=true;this.SetItemInfo(e)},CreateViewItDialog:function(b){var c=this,a={width:100,height:100,pWnd:BX("mlsd_view_item"),pItemCont:BX("mlsd_item_cont"),pInfoCont:BX("mlsd_info_cont"),pName:BX("mlvi_info_name"),pCols:BX("mlvi_info_colls"),pKeys:BX("mlvi_info_keys"),pDesc:BX("mlvi_info_desc"),pDetails:BX("mlvi_info_details"),pDel:BX("mlsd_viewit_del"),pEdit:BX("mlsd_viewit_edit"),pLink:BX("mlvi_info_link"),pCopyLink:BX("mlvi_info_copy_link"),pCopyInput:BX("mlvi_info_copy_input"),pExt:BX("mlvi_info_ext"),Overlay:new BXOverlay({id:"bxml_viewit_overlay"})};BX("mlsd_viewit_cancel").onclick=function(){c.CloseViewItDialog()};BX("mlsd_viewit_close").onclick=function(){c.CloseViewItDialog()};a.pDel.onclick=function(d){c.DelItem({id:c.ViewItDialog.oItem.id,colId:c.ViewItDialog.colId})};a.pEdit.onclick=function(d){c.CloseViewItDialog();c.OpenEditItemDialog({id:c.ViewItDialog.oItem.id,colId:c.ViewItDialog.colId,bSearch:b.bSearch})};window.MlViewItOnKeypress=function(d){if(!d){d=window.event}if(d&&d.keyCode==27){c.CloseViewItDialog()}};this.ViewItDialog=a},CloseViewItDialog:function(){this.ViewItDialog.bOpened=false;this.bSubdialogOpened=false;this.ViewItDialog.pWnd.style.display="none";this.ViewItDialog.pCopyInput.style.display="none";jsFloatDiv.Close(this.ViewItDialog.pWnd);this.ViewItDialog.Overlay.Hide();BX.unbind(document,"keypress",window.MlViewItOnKeypress)},SetItemInfo:function(k){var g=this,b=this.ViewItDialog,p=this.arItemsCollList[k.id],m="",f,d=p.length,o,c;b.pName.innerHTML=BX.util.htmlspecialchars(k.name);b.pName.title=k.name;b.pLink.href=k.path;b.pCopyLink.onclick=function(){b.pCopyInput.value=k.path.substr(0,1)!=="/"?k.path:window.location.protocol+"//"+window.location.host+k.path;b.pCopyInput.style.display="block";b.pCopyInput.select()};if(k.keywords.length>0){b.pKeys.parentNode.className="small-grey";b.pKeys.innerHTML=BX.util.htmlspecialchars(k.keywords);b.pKeys.title=bxspcharsback(k.keywords)}else{b.pKeys.parentNode.className="ml-info-keys-h"}if(k.desc.length>0){b.pDesc.innerHTML=BX.util.htmlspecialchars(k.desc.replace(/\n/g,"<br />"));b.pDesc.parentNode.className="small-grey"}else{b.pDesc.parentNode.className="ml-info-desc-h"}for(var e=b.pCols.childNodes.length-1;e>0;e--){if(b.pCols.childNodes[e].nodeName.toLowerCase()!="span"){b.pCols.removeChild(b.pCols.childNodes[e])}}for(f=0;f<d;f++){m+=BX.util.htmlspecialcharsback(this.GetCollection(p[f]).name+(f!=d-1?", ":""))}b.pCols.appendChild(document.createTextNode(m));var n=ML_MESS.FileExt+": "+k.path.substr(k.path.lastIndexOf(".")+1);n+="<br />"+ML_MESS.DateModified+": "+k.date_mod;if(k.file_size){n+="<br />"+ML_MESS.FileSize+": "+k.file_size}if(k.width&&k.height){n+="<br />"+ML_MESS.ImageSize+": "+k.width+" x "+k.height+" px"}b.pDetails.innerHTML=n;this.SetItemHTML(k)},SetItemHTML:function(b){var a=this.ViewItDialog;this.Request({action:"get_item_view",postData:{id:b.id},handler:function(){var n=window.bx_req_res.html;var d=[],c,j,l,e;while((c=n.indexOf("<script>"))!=-1){var j=n.indexOf("<\/script>",c);if(j==-1){break}d[d.length]=n.substr(c+8,j-c-8);n=n.substr(0,c)+n.substr(j+9)}for(var l=0,e=d.length;l<e;l++){if(d[l]!=""){jsUtils.EvalGlobal(d[l])}}a.pItemCont.innerHTML=n;var m=parseInt(window.bx_req_res.width)||100,g=parseInt(window.bx_req_res.height)||50;if(m<100){m=100}if(a.pDesc&&parseInt(a.pDesc.offsetHeight)>(g-200)){a.pDesc.style.height=(g>=400?g-200:200)+"px";a.pDesc.style.overflow="auto"}var o=parseInt(a.pInfoCont.offsetHeight)||0,q=80+(g>o?g:o),k=270+m,r=BX.GetWindowSize(),f=parseInt(r.scrollLeft+r.innerWidth/2-k/2),p=parseInt(r.scrollTop+r.innerHeight/2-q/2);a.pWnd.style.width=k+"px";a.pWnd.style.height=q+"px";a.pWnd.style.overflow="hidden";jsFloatDiv.Show(a.pWnd,f,p,5,false,false);BX.bind(document,"keypress",window.MlViewItOnKeypress);a.pItemCont.style.width=m+"px";a.pItemCont.style.height=g+"px";a.pWnd.style.visibility="visible"}})},DelItem:function(g){if(!g.id){return}var j=this,c=false,a=this.arItemsCollList[g.id],d,b=a.length,f;for(d=0;d<b;d++){if(!this.GetCollection(a[d])){c=true;break}}if(!g.mode){return this.OpenConfirm({text:ML_MESS.DelItConfTxt,but1:{text:ML_MESS.DelItB1,handler:function(){j.DelItem({id:g.id,mode:"current"})}},but2:{text:ML_MESS.DelItB2,handler:function(){j.DelItem({id:g.id,mode:"all"})},disabled:c}})}var e=this.SelectedColId||0;this.Request({action:"del_item",postData:{id:g.id,mode:g.mode,col_id:e},handler:function(){if(window.bx_req_res==true){j.CSDelItem({id:g.id,mode:g.mode,colId:e})}else{if(window.bx_req_res!==false){return false}}}})},SelectItem:function(a){if(a&&this.oCurItems&&this.oCurItems[a]){if(this.SelectedItemId&&this.oCurItems[this.SelectedItemId]){BX.removeClass(this.oCurItems[this.SelectedItemId].pWnd,"ml-item-active")}this.SelectedItemId=a;BX.addClass(this.oCurItems[a].pWnd,"ml-item-active");this.GetItemCollList(a,"FillInfoPanel",this.oCurItems[a].oItem)}else{this.SelectedItemId=false;this.FillInfoPanel(false)}},FillInfoPanel:function(f){if(!f){if(this.pButSave){this.pButSave.disabled=true}BX.addClass(this.pInfo.pWnd,"ml-no-info")}else{if(this.pButSave){this.pButSave.disabled=false}var e=this,m=this.arItemsCollList[f.id],g="",d,c=m.length,k,b;BX.removeClass(this.pInfo.pWnd,"ml-no-info");this.pInfo.name.innerHTML=BX.util.htmlspecialchars(f.name);if(f.keywords.length>0){this.pInfo.keywords.parentNode.className="";this._ChooseKeysCount(e.pInfo.keywords,e.pInfo.keywords.parentNode,f.keywords,40);this.pInfo.keywords.title=bxspcharsback(f.keywords)}else{this.pInfo.keywords.parentNode.className="ml-info-keys-h"}if(f.desc.length>0){BX.removeClass(this.pInfo.desc,"mlid-scrld");this.pInfo.desc.innerHTML=BX.util.htmlspecialchars(f.desc.replace(/\n/g,"<br />"));setTimeout(function(){var a=parseInt(e.pInfo.desc.offsetHeight);if(isNaN(a)||a>55){BX.addClass(e.pInfo.desc,"mlid-scrld")}},5);this.pInfo.desc.parentNode.className=""}else{this.pInfo.desc.parentNode.className="ml-info-desc-h"}this.pInfo.collections.innerHTML="(";for(d=0;d<c;d++){b=this.GetCollection(m[d]);if(b){k=this.pInfo.collections.appendChild(BX.create("A",{props:{id:"ml_info_"+b.id,href:"javascript:void(0);",title:ML_MESS.Collection+": "+b.name,className:"ml-info-coll"},text:b.name}));k.onclick=function(){e.SelectCollection(this.id.substr("ml_info_".length),true)}}else{k=this.pInfo.collections.appendChild(BX.create("SPAN",{props:{title:ML_MESS.CollAccessDenied,className:"ml-info-coll"},text:ML_MESS.Collection+" "+m[d]}))}if(d!=c-1){this.pInfo.collections.appendChild(document.createTextNode(", "))}}this.pInfo.collections.appendChild(document.createTextNode(")"));var j=ML_MESS.DateModified+": "+f.date_mod;if(f.file_size){j+="<br />"+ML_MESS.FileSize+": "+f.file_size}if(f.width&&f.height){j+="<br />"+ML_MESS.ImageSize+": "+f.width+" x "+f.height+" px"}this.pInfo.details.innerHTML=j}},_ChooseKeysCount:function(d,a,e,b,c){var f=this;d.innerHTML=BX.util.htmlspecialchars(e);setTimeout(function(){var i=parseInt(a.offsetHeight),g=e.lastIndexOf(",");if(i>b&&g>0){f._ChooseKeysCount(d,a,BX.util.trim(e.substr(0,g)),b,true)}else{if(c){d.innerHTML+="..."}}},1)},GetItemCollList:function(d,b,a){if(!this.arItemsCollList[d]){var c=this;this.Request({action:"get_item_coll_list",postData:{id:d},handler:function(){if(!window._ml_items_colls){return false}c.arItemsCollList[d]=[];for(var f=0,e=window._ml_items_colls.length;f<e;f++){c.arItemsCollList[d].push(window._ml_items_colls[f])}c[b](a)}})}else{this[b](a)}},OpenEditItemDialog:function(e,b){if(!this.EditItemDialog){return this.CreateEditItemDialog(e)}if(!b){this.Request({action:"bx_test",handler:function(){}});this.EditItemDialog.alreadySubmitted=false;this.EditItemDialog.alreadyLoaded=false;this.EditItemDialog.Params=e||this.EditItemDialog.Params||{};this.EditItemDialog.pIfrm.src=this.GetRequestUrl("upload_form");return}var a=this.EditItemDialog,c=a.Params.id,g=e.zIndex||this.zIndex+200,j=BX.GetWindowSize(),d=parseInt(j.scrollLeft+j.innerWidth/2-a.width/2),i=parseInt(j.scrollTop+j.innerHeight/2-a.height/2);a.bNew=!c;a.Overlay.Show({zIndex:g-10});a.pWnd.style.zIndex=g;a.pWnd.style.display="block";this.EditItemDialog.bShow=true;this.bSubdialogOpened=true;a.arColls={};a.colLength=0;if(!a.bNew){var f=this.oCurItems[c].oItem;a.pPCFileCont.style.display=a.pLoadFDLink.style.display=a.pFDFileCont.style.display=a.pLoadPCLink.style.display="none";a.pFNFileCont.style.display="block";a.pChangeFileLink.style.display="inline";a.pChangeFileLinkBack.style.display="none";a.pFileName.innerHTML=f.file_name;this._AddItemsCollections(this.arItemsCollList[c]);a.pName.value=bxspcharsback(f.name);a.pDesc.value=bxspcharsback(f.desc);a.pKeys.value=bxspcharsback(f.keywords);if(f.width&&f.height){a.pSize.style.display="block";a.pSize.innerHTML=f.width+" x "+f.height}else{a.pSize.style.display="none"}if(f.thumb_path){a.pThumb.src=f.thumb_path;a.pNoPreview.style.display="none";if(f.width>146||f.height>136){if(f.width-f.height>0){a.pThumb.style.width="146px"}else{a.pThumb.style.height="136px"}}else{if(f.height<126){a.pThumb.style.marginTop=Math.round((126-f.height)/2)+"px"}}}a.oItem=f}else{a.pFNFileCont.style.display="none";a.pChangeFileLink.style.display="none";a.pChangeFileLinkBack.style.display="none";a.pFileName.innerHTML="";a.pName.value="";a.pDesc.value="";a.pKeys.value="";a.pSize.style.display="none";if(!a.Params.parentCol&&a.Params.bGetSelCol&&this.SelectedColId&&this.oCollections[this.SelectedColId]){a.Params.parentCol=this.SelectedColId}if(a.Params.parentCol>0&&this.UserCan(a.Params.parentCol,"new_item")){this._AddItemsCollections([a.Params.parentCol])}}this._ReHeightEditDialog();a.pName.onchange();jsFloatDiv.Show(a.pWnd,d,i,5,false,false);BX.bind(document,"keypress",window.MlEdItemOnKeypress)},CreateEditItemDialog:function(b){var c=this,a={Params:b||false,width:420,height:350,pWnd:BX("mlsd_item"),pTitle:BX("mlsd_item_title"),pIfrm:BX("mlsd_iframe_upload"),Overlay:new BXOverlay({id:"bxml_ed_it_overlay"})};a.pIfrm.src=this.GetRequestUrl("upload_form");var c=this;if(BX.browser.IsIE()){a.pIfrm.onreadystatechange=function(){c.EditItemDialogOnload()}}else{a.pIfrm.onload=function(){c.EditItemDialogOnload()}}BX("mlsd_item_cancel").onclick=BX("mlsd_item_close").onclick=function(){c.CloseEditItemDialog()};a.pWnd.style.width=a.width+"px";a.pWnd.style.height=a.height+"px";this.EditItemDialog=a;window.MlEdItemOnKeypress=function(d){if(!d){d=window.event}if(d&&d.keyCode==27){c.CloseEditItemDialog()}}},EditItemDialogOnload:function(b){var c=this,a=this.EditItemDialog;a.pFrameDoc=a.pIfrm.contentDocument||a.pIfrm.contentWindow.document;a.pName=a.pFrameDoc.getElementById("mlsd_item_name");a.bFocusKeywords=false;if(!a.pName&&!this.EditItemDialog.alreadySubmitted){this.EditItemDialog.alreadySubmitted=true;return setTimeout(function(){c.CSEditItem(top.bx_req_res,top._ml_items_colls)},50)}if(this.EditItemDialog.alreadyLoaded||this.EditItemDialog.alreadySubmitted){return}this.EditItemDialog.alreadyLoaded=true;a.pDesc=a.pFrameDoc.getElementById("mlsd_item_desc");a.pKeys=a.pFrameDoc.getElementById("mlsd_item_keywords");a.pColSelect=a.pFrameDoc.getElementById("mlsd_coll_sel");a.pItCollCont=a.pColSelect.parentNode.parentNode;a.pFNFileCont=a.pFrameDoc.getElementById("mlsd_fname_cont");a.pPCFileCont=a.pFrameDoc.getElementById("mlsd_load_cont");a.pFDFileCont=a.pFrameDoc.getElementById("mlsd_select_cont");a.pLoadFile=a.pFrameDoc.getElementById("ml_load_file");a.pLoadMaxSize=a.pFrameDoc.getElementById("ml_load_max_size");a.pChangeFileLink=a.pFrameDoc.getElementById("mlsd_fname_change");a.pChangeFileLinkBack=a.pFrameDoc.getElementById("mlsd_fname_change_back");a.pLoadPCLink=a.pFrameDoc.getElementById("mlsd_select_pc");a.pLoadFDLink=a.pFrameDoc.getElementById("mlsd_select_fd");a.pItemColls=a.pFrameDoc.getElementById("mlsd_item_collections");a.pFileName=a.pFrameDoc.getElementById("ml_file_name");a.pId=a.pFrameDoc.getElementById("mlsd_item_id");a.pNoPreview=a.pFrameDoc.getElementById("mlsd_no_preview");a.pFileName=a.pFrameDoc.getElementById("ml_file_name");a.pThumb=a.pFrameDoc.getElementById("mlsd_item_thumb");a.pSize=a.pFrameDoc.getElementById("mlsd_item_size");a.pItemPath=a.pFrameDoc.getElementById("mlsd_item_path");a.pOpenFD=a.pFrameDoc.getElementById("mlsd_open_fd");a.pSourceType=a.pFrameDoc.getElementById("mlsd_source_type");a.pSaveBut=BX("mlsd_item_save");a.pForm=a.pFrameDoc.forms.ml_item_form;a.pTbl=a.pForm.firstChild;a.pItemPath.onchange=a.pLoadFile.onchange=function(){var d=this.value;if(!d||d.length<=0){return}d=d.replace(/\\/g,"/");d=d.substr(d.lastIndexOf("/")+1);a.pName.value=d;a.pName.onchange()};a.pName.onkeydown=a.pName.onchange=function(){setTimeout(function(){var e=c.EditItemDialog,f=bxhtmlspecialchars(e.pName.value),d=e.bNew?ML_MESS.NewItem:ML_MESS.Item;e.pTitle.title=d+(f.length>0?": "+e.pName.value:"");e.pTitle.innerHTML=d+(f.length>0?": "+f:"")},20)};a.pLoadFDLink.onclick=function(){a.pPCFileCont.style.display=a.pLoadFDLink.style.display="none";a.pFDFileCont.style.display="block";a.pLoadPCLink.style.display="inline";a.pSourceType.value="FD"};a.pLoadPCLink.onclick=function(){a.pPCFileCont.style.display="block";a.pLoadFDLink.style.display="inline";a.pFDFileCont.style.display=a.pLoadPCLink.style.display="none";a.pSourceType.value="PC"};a.pChangeFileLink.onclick=function(){a.pFNFileCont.style.display="none";a.pChangeFileLink.style.display="none";a.pChangeFileLinkBack.style.display="inline";a.pLoadPCLink.onclick()};a.pChangeFileLinkBack.onclick=function(){a.pPCFileCont.style.display=a.pLoadFDLink.style.display=a.pFDFileCont.style.display=a.pLoadPCLink.style.display="none";a.pFNFileCont.style.display="block";a.pChangeFileLink.style.display="inline";a.pChangeFileLinkBack.style.display="none";a.pSourceType.value="N"};a.pColSelect.onchange=function(){c._AddCollToItem(this.value);this.value=0};a.pSaveBut.onclick=function(){if(c.EditItemDialogOnsubmit()){a.pForm.submit();c.CloseEditItemDialog()}};a.pOpenFD.onclick=window.mlOpenFileDialog;window.mlOnFileDialogSave=function(f,g,e){var d=(g=="/"?"":g)+"/"+f;a.pItemPath.value=d;a.pItemPath.focus();a.pItemPath.select();a.pItemPath.onchange();BX.fireEvent(a.pItemPath,"change")};a.pKeys.onchange=a.pKeys.onblur=function(){c.EditItemDialog.bFocusKeywords=true};this._ReqBuildCollSelect(a.pColSelect,this.arCollectionsTree,0,true);this.OpenEditItemDialog(false,true)},EditItemDialogOnsubmit:function(e){var d=this.EditItemDialog,g,a=this.EditItemDialog.arColls,f="";for(g in a){if(a[g]&&typeof a[g]=="object"&&a[g].pWnd){f+=(f==""?"":",")+g}}var b=d.pSourceType.value=="PC"?d.pLoadFile.value:d.pItemPath.value;if((d.bNew||b!=="")&&!this.CheckFileExt(b)){alert(ML_MESS.ItemExtError);return}if((d.bNew||b!=="")&&!this.CheckFileExt(b,this.curType.arExt)&&!confirm(ML_MESS.CheckExtTypeConf)){return false}if(d.bNew){var c=true;if(b==""){alert(ML_MESS.ItSourceError)}else{if(!this.CheckFileExt(b)){alert(ML_MESS.ItemExtError)}else{c=false}}if(c){if(d.pSourceType.value=="PC"){d.pLoadPCLink.onclick();d.pLoadFile.focus()}else{d.pLoadFDLink.onclick();d.pItemPath.focus()}return false}}if(d.pName.value==""){alert(ML_MESS.ItNameError);d.pName.focus();return false}if(f==""){alert(ML_MESS.ItCollsError);d.pColSelect.focus();return false}if(!this.EditItemDialog.bNew){this.EditItemDialog.pId.value=this.EditItemDialog.oItem.id}this.EditItemDialog.pItemColls.value=f;return true},CloseEditItemDialog:function(){this.EditItemDialog.bShow=false;this.EditItemDialog.Params=false;this.bSubdialogOpened=false;this.EditItemDialog.pWnd.style.display="none";jsFloatDiv.Close(this.EditItemDialog.pWnd);this.EditItemDialog.Overlay.Hide();BX.unbind(document,"keypress",window.MlEdItemOnKeypress)},_AddItemsCollections:function(c){var b,a=c.length;for(b=0;b<a;b++){this._AddCollToItem(c[b],false)}},_AddCollToItem:function(a,c){if(this.EditItemDialog.arColls[a]){return}if(this.EditItemDialog.bNew&&!this.UserCan(parseInt(a),"new_item")||!this.EditItemDialog.bNew&&!this.UserCan(parseInt(a),"edit_item")){return alert(ML_MESS.CollAccessDenied4)}var b=this.GetCollection(a);if(!b){b={}}var f,d,g=this,m=this.EditItemDialog.pColSelect,k=BX.create("DIV",{props:{className:"mlsd-ch-col",title:b.name}},this.EditItemDialog.pFrameDoc),e=k.appendChild(BX.create("SPAN",{text:b.name},this.EditItemDialog.pFrameDoc)),j=k.appendChild(BX.create("IMG",{props:{src:"/bitrix/images/1.gif",className:"ml-col-del",title:ML_MESS.DelColFromItem,id:"mlsd_it_"+a}},this.EditItemDialog.pFrameDoc));if(b&&b.name){if(c!==false&&(this.EditItemDialog.bNew&&!this.UserCan(b,"new_item")||!this.EditItemDialog.bNew&&!this.UserCan(b,"edit_item"))){return alert(ML_MESS.CollAccessDenied2)}if(b&&b.keywords&&this.EditItemDialog.bNew&&!this.EditItemDialog.bFocusKeywords){this.AppendKeywords(this.EditItemDialog.pKeys,b.keywords)}this.EditItemDialog.pItCollCont.onmouseover=function(i){};this.EditItemDialog.pItCollCont.onmouseout=function(i){};k.onmouseover=function(){BX.addClass(this,"col-over")};k.onmouseout=function(){BX.removeClass(this,"col-over")};j.onclick=function(i){var l=this.id.substr("mlsd_it_".length);g.EditItemDialog.pItCollCont.removeChild(g.EditItemDialog.arColls[l].pWnd);g._SelectOptionInColList(g.EditItemDialog.pColSelect,l,false);g.EditItemDialog.arColls[l]=null;g.EditItemDialog.colLength--;g._ReHeightEditDialog()}}else{k.title=ML_MESS.CollAccessDenied;e.innerHTML=ML_MESS.Collection+" "+a}this.EditItemDialog.colLength++;this.EditItemDialog.pItCollCont.insertBefore(k,m.parentNode);g._SelectOptionInColList(m,a);if(c!==false){this._ReHeightEditDialog()}this.EditItemDialog.arColls[a]={pWnd:k}},_SelectOptionInColList:function(d,e,c){for(var b=0,a=d.options.length;b<a;b++){if(d.options[b].value==e){d.options[b].className=(c!==false)?"opt-checked":"";d.options[b].title=(c!==false)?ML_MESS.CheckedColTitle:"";break}}},_ReHeightEditDialog:function(){var a=Math.ceil((this.EditItemDialog.colLength+2)/4);if(a<2){a=2}var b=(a-2)*28;this.EditItemDialog.pItCollCont.style.height=a*28+"px";this.EditItemDialog.pIfrm.style.height=275+b+"px";this.EditItemDialog.pTbl.style.height=265+b+"px";this.EditItemDialog.pWnd.style.height=350+b+"px";jsFloatDiv.AdjustShadow(this.EditItemDialog.pWnd)},GetRequestUrl:function(a){return"/bitrix/admin/fileman_medialib.php?sessid="+this.sessid+"&lang="+this.oConfig.lang+(a?"&action="+a:"")},CheckReqLostSessid:function(a){var c="BX_ML_DUBLICATE_ACTION_REQUEST",b=a.indexOf(c);if(b==-1){return true}this.sessid=a.substring(b+c.length,a.lastIndexOf("-->"));return this.sessid},Resize:function(a,c){if(a<565){a=565}if(c<400){c=400}this.width=a;this.height=c;this.pWnd.style.width=a+"px";this.pWnd.style.height=c+"px";jsFloatDiv.AdjustShadow(this.pWnd);var b=c-95;contW=a,rW=contW-220;this.pHeaderCont.style.width=(a-10)+"px";this.pFrameTbl.style.height=c+"px";this.pLeftCont.style.height=b+"px";this.pRightCont.style.height=b+"px";this.pRightCont.style.width=(rW+3)+"px";this.pCollCont.style.height=(b-(this.bTypes?39:0))+"px";this.pListCont.style.height=(b-110)+"px";this.pInfo.desc.style.width=(Math.round(rW/2)-10)+"px";this.pListCont.style.width=rW+"px";this.pInfo.pWnd.style.width=(rW-10)+"px";this.pButCont.style.width=contW+"px";this.pResizer.style.left=(a-20)+"px";this.pResizer.style.top=(c-20)+"px"},ResizerMouseDown:function(){var a=this;this.oPos={top:parseInt(this.pWnd.style.top,10),left:parseInt(this.pWnd.style.left,10)};window.MLResizerMouseUp=function(){a.ResizerMouseUp()};window.MLResizerMouseMove=function(b){a.ResizerMouseMove(b)};BX.bind(document,"mouseup",window.MLResizerMouseUp);BX.bind(document,"mousemove",window.MLResizerMouseMove)},ResizerMouseUp:function(){this.SaveSettings();BX.unbind(document,"mouseup",window.MLResizerMouseUp);BX.unbind(document,"mousemove",window.MLResizerMouseMove);this.SelectItem(this.SelectedItemId)},ResizerMouseMove:function(d){var b=BX.GetWindowSize(),c=d.clientX+b.scrollLeft,a=d.clientY+b.scrollTop;w=c-this.oPos.left,h=a-this.oPos.top;this.Resize(w,h)},Request:function(c){c.url=this.GetRequestUrl(c.action);if(!c.postData){c.postData={}}var d=this,a=0;var b=function(f){var e=function(){d.CloseWaitWindow();if(f.indexOf("BX_ML_LOAD_OK")==-1){return alert(ML_MESS.AccessDenied)}var i=d.CheckReqLostSessid(f);if(i!==true){if(c.bRequestReply){alert(ML_MESS.SessExpired)}else{c.bRequestReply=true;setTimeout(function(){d.Request(c)},50)}return}var g=c.handler(f);if(g===false&&++a<20){setTimeout(e,3)}};setTimeout(e,10)};window.bx_req_res=false;this.ShowWaitWindow();jsAjaxUtil.PostData(c.url,c.postData,b)},ShowWaitWindow:function(){if(window.ShowWaitWindow){ShowWaitWindow()}},CloseWaitWindow:function(){if(window.CloseWaitWindow){CloseWaitWindow()}},OpenConfirm:function(g){var b=g.width||560,c=g.height||100,i=g.zIndex||this.zIndex+100;_this=this;if(!this.Confirm){var f={pWnd:BX("ml_colfirm_dialog"),pText:BX("ml_confd_text"),but1:BX("ml_confd_b1"),but2:BX("ml_confd_b2"),butCancel:BX("ml_confd_cancel"),Overlay:new BXOverlay({id:"bxml_conf_overlay"})};f.butCancel.onclick=function(){_this.CloseConfirm()}}else{var f=this.Confirm}f.pWnd.style.width=b+"px";f.pWnd.style.height=c+"px";f.pWnd.style.zIndex=i;f.pWnd.style.display="block";f.Overlay.Show({zIndex:i-10,clickCallback:{func:this.CloseConfirm,obj:this}});this.bSubdialogOpened=true;var a=BX.GetWindowSize(),e=parseInt(a.scrollLeft+a.innerWidth/2-b/2),d=parseInt(a.scrollTop+a.innerHeight/2-c/2);jsFloatDiv.Show(f.pWnd,e,d,0,false,false);f.but1.value=g.but1.text;f.but1.onclick=function(j){g.but1.handler(j);_this.CloseConfirm()};f.but1.disabled=!!g.but1.disabled;f.but1.focus();if(g.but2){f.but2.style.display="inline";f.but2.value=g.but2.text;f.but2.disabled=!!g.but2.disabled;f.but2.onclick=function(j){g.but2.handler(j);_this.CloseConfirm()}}else{f.but2.style.display="none"}f.pText.innerHTML=g.text;this.Confirm=f;window.MlConfDialofOnKeypress=function(j){if(!j){j=window.event}if(j&&j.keyCode==27){_this.CloseConfirm()}};BX.bind(document,"keypress",window.MlConfDialofOnKeypress)},CloseConfirm:function(){this.Confirm.pWnd.style.display="none";jsFloatDiv.Close(this.Confirm.pWnd);this.Confirm.Overlay.Hide();this.bSubdialogOpened=false;BX.unbind(document,"keypress",window.MlConfDialofOnKeypress)},SaveSettings:function(){if(this.width&&this.height){this.userSettings.width=this.width;this.userSettings.height=this.height}this.Request({action:"save_settings",postData:this.userSettings,handler:function(){}})},CSDelCollection:function(j,e,d){var g=this.oCollections[j];if(g){var b=this.GetCollection(j);if(e!==false&&typeof b=="object"&&b.parent>0){this._IncreaseCollChild(parseInt(b.parent),-1)}if(this.SelectedColId&&this.SelectedColId==j){this.DeSelectCollection()}this.arCollections=BX.util.deleteFromArray(this.arCollections,g.ind);for(col_id in this.oCollections){if(this.oCollections[col_id]&&this.oCollections[col_id].ind>g.ind){this.oCollections[col_id].ind--}}var f=g.pChildCont.parentNode;if(f){f.removeChild(g.pChildCont);f.removeChild(g.pTitle)}if(d===undefined){d=true}if(f.childNodes.length>0){for(var c=0,a=f.childNodes.length;c<a;c++){if(f.childNodes[c]&&f.childNodes[c].className&&f.childNodes[c].className.indexOf("ml-no-colls")==-1){d=false;break}}}else{d=false}if(d){BX.addClass(this.pLeftCont,"ml-no-colls-sect");this.pAddNewItem.style.display="none"}this.oCollections[j]=null;if(e){for(var c=0,a=e.length;c<a;c++){this.CSDelCollection(e[c],false,d)}}if(e!==false){this.ReNewCollectionTree()}}},CSDelItem:function(m){var a=m.id,e=this.oCurItems[a],o=[];if(!e){return}if(this.ViewItDialog&&this.ViewItDialog.bOpened){this.CloseViewItDialog()}if(m.mode=="current"){o.push(parseInt(this.SelectedColId));this.arItemsCollList[a]=false}else{if(!this.arItemsCollList[a]){return this.GetItemCollList(a,"CSDelItem",m)}o=this.arItemsCollList[a]}var k,f=o.length,d,g,b,c;for(k=0;k<f;k++){if(MLItems[o[k]]){d=MLItems[o[k]].length;for(g=0;g<d;g++){b=MLItems[o[k]][g];if(b.id==a){MLItems[o[k]]=BX.util.deleteFromArray(MLItems[o[k]],g);break}}}}this.currentIdShowed=0;c=this.SelectedColId;if(c){this.SelectedColId=0;this.SelectCollection(c)}this.SelectItem()},CSEditItem:function(b,m){if(!b){if(parseInt(this.EditItemDialog.pLoadFile.files[0].size)>parseInt(this.EditItemDialog.pLoadMaxSize.value)){var g=parseInt(this.EditItemDialog.pLoadMaxSize.value)/(1024*1024);return alert(ML_MESS.ItFileSizeError.replace("#FILESIZE#",g))}}if(!b||typeof m!="object"){return alert(ML_MESS.EditItemError)}var j,f=m.length,a=b.id,d,k=this.arItemsCollList[a]||[],e=k.length,n={};if(k.length>0){d=this.FindItem(k[0],a);if(d!==false){b=this._MergeItemInfo(MLItems[k[0]][d],b)}}for(j=0;j<f;j++){if(MLItems[m[j]]){d=this.FindItem(m[j],a);if(d===false){MLItems[m[j]].push(b)}else{MLItems[m[j]][d]=b}n[m[j]]=true}}for(j=0;j<e;j++){if(!n[k[j]]){d=this.FindItem(k[j],a);if(d!==false){MLItems[k[j]]=BX.util.deleteFromArray(MLItems[k[j]],d);this.ShowItems(k[j])}}}this.currentIdShowed=0;this.arItemsCollList[a]=m;var c=this.SelectedColId;if(c){this.SelectedColId=0;this.SelectCollection(c)}this.SelectItem(a)},_MergeItemInfo:function(c,b){if(typeof c=="object"&&typeof b=="object"){for(var a in b){if(b[a]&&(b[a].length>0||b[a]>0)){c[a]=b[a]}}}return c},FindItem:function(c,d){if(MLItems[c]&&typeof MLItems[c]=="object"&&MLItems[c].length>0){var b,a=MLItems[c].length;for(b=0;b<a;b++){el=MLItems[c][b];if(el&&el.id==d){return b}}}return false},CheckFileExt:function(c,d){c=c.substr(c.lastIndexOf(".")+1);c=c.toLowerCase();if(!d){d=this.arExt}for(var b=0,a=d.length;b<a;b++){if(d[b]==c){return true}}return false},AppendKeywords:function(f,e){if(!f||!e){return}var g=[],c=f.value.split(",").concat(e.split(",")),d,b,a=c.length;for(b=0;b<a;b++){d=BX.util.trim(c[b]);if(d&&!BX.util.in_array(d,g)){g.push(d)}}f.value=g.join(", ")},InitTypeSelector:function(){this.bTypes=this.Types.length>1;if(this.bTypes){this.pTypeCont=BX("ml_type_cont");this.pTypeCont.style.display="block";this.oTypeSelector=new BXMLTypeSelector({oML:this,Types:this.Types,oCallback:{obj:this,func:this.TypeOnChange}});this.pTypeCont.appendChild(this.oTypeSelector.pWnd);this.oTypeSelector.SetType(0,false);this.curType=this.Types[0]}else{this.curType=this.Types[0]}},TypeOnChange:function(d){this.curType=this.Types[d.typeInd];var b,a=this.pCollCont.childNodes.length,c;for(b=a-1;b>=0;b--){c=this.pCollCont.childNodes[b];if(c.className.indexOf("ml-no-colls")==-1){this.pCollCont.removeChild(c)}}this.BuildCollections();this.BuildCrumbs([]);this.DisplayItems()},CheckMLType:function(a){a=parseInt(a);if(!this.bTypes||a==this.curType.id){return true}if((!this.curType||this.curType.code=="image"&&this.curType.system)&&(!a||a==this.curType.id)){return true}return false}};function BXMLSearch(a){this.oML=a;this.Init()}BXMLSearch.prototype={Init:function(){var a=this;this.bShowed=false;this.pInput=BX("medialib_search");this.pInput.onfocus=function(b){if(this.value==ML_MESS.SearchDef){this.value="";this.className="ml-search"}};this.pInput.onblur=function(b){if(this.value==ML_MESS.SearchDef||this.value==""){this.value=ML_MESS.SearchDef;this.className="ml-search ml-search-empty"}};this.pInput.onkeydown=function(b){if(!b){b=window.event}if(b.keyCode==13){if(this.value.length>0){a.Search(this.value)}return BX.PreventDefault(b)}}},Search:function(a){var b=this;window.MLSearchResult=false;this.oML.Request({action:"search",postData:{q:a,types:b.oML.requestTypes},handler:function(){if(window.MLSearchResult){b.DisplayResult(window.MLSearchResult,a)}}})},DisplayResult:function(a,c){this.bShowed=true;this.Query=c;this.oML.DeSelectCollection();this.oML.pBread.appendChild(BX.create("SPAN",{props:{className:"ml-search-title"},html:ML_MESS.SearchResultEx.replace("#SEARCH_QUERY#",c)}));while(this.oML.pListCont.childNodes[1]){this.oML.pListCont.removeChild(this.oML.pListCont.lastChild)}this.oML.oCurItems={};this.oML.pListCont.firstChild.style.display="none";var d,b=a.length;if(b>0){for(d=0;d<b;d++){this.oML.DisplayItem(a[d],a[d].perm,true)}}else{this.oML.pListCont.appendChild(BX.create("DIV",{props:{className:"ml-search-no-result"},html:ML_MESS.NoResult}))}}};