(function(a){if(BX.BlockEditorManager){return}BX.BlockEditorManager={list:{},blockList:{},get:function(b){if(this.list[b]){return this.list[b]}return null},add:function(b){if(!b.blockTypeList){b.blockTypeList=this.getBlockList()}this.list[b.id]=new BXBlockEditor(b);BX.onCustomEvent(this,"onEditorAdd",[this.list[b.id]]);return this.list[b.id]},create:function(b){if(!this.get(b.id)){return this.add(b)}else{return this.get(b.id)}},setBlockList:function(b){this.blockList=b},getBlockList:function(){return this.blockList}}})(window);function BXBlockEditor(a){this.id=a.id;this.context=a.context;this.iframe=a.iframe;this.charset=a.charset;this.previewUrl=a.previewUrl;this.saveFileUrl=a.saveFileUrl;this.site=a.site;this.resultNode=a.resultNode;this.blockTypeList=a.blockTypeList;this.disableScroll=a.disableScroll||false;this.panelList={};this.blockList=[];this.placeList=[];this.dragdrop=null;this.preview=null;this.stylistContainerNode=null;this.stylistInitedValues={};this.isInited=false;this.isTemplateMode=!!a.isTemplateMode;this.CONST_ATTR_BLOCK="data-bx-block-editor-block-type";this.CONST_ATTR_PLACE="data-bx-block-editor-place";this.CONST_ATTR_BLOCK_STATUS="data-bx-block-editor-block-status";this.CONST_ATTR_STYLIST_TAG="data-bx-stylist-container";this.CONST_ATTR_TMP_RESOURSE="data-bx-resource-temp";this.CONST_ATTR_ID_STYLIST="bxStylist";this.content=new BX.BlockEditor.Content({caller:this,textarea:this.resultNode});this.statusManager=new BXBlockEditorStatusManager({caller:this});this.cssParser=new BXBlockEditorCssParser();this.shadowNode=BX.findChild(this.context,{className:"shadow"},true);BX.addCustomEvent(this,"onLoadBefore",BX.delegate(function(){BX.addClass(this.shadowNode,"active")},this));BX.addCustomEvent(this,"onLoadAfter",BX.delegate(function(){BX.removeClass(this.shadowNode,"active")},this));BX.ready(BX.delegate(function(){if(a.url){this.load(a.url)}},this));if(this.disableScroll){BX.bind(this.iframe,"load",setTimeout(this.initResize.bind(this),1000))}}BXBlockEditor.prototype.initResize=function(){this.resize();BX.bind(this.iframe.contentWindow,"resize",BX.throttle(this.resize.bind(this),200))};BXBlockEditor.prototype.resize=function(){if(!this.disableScroll){return}var b=this.iframe.contentDocument;var a=Math.max(b.body.scrollHeight,b.documentElement.scrollHeight,b.body.offsetHeight,b.documentElement.offsetHeight,b.body.clientHeight,b.documentElement.clientHeight);if(a<=0){return}this.iframe.style.height=a+"px"};BXBlockEditor.prototype.init=function(){if(!this.isInited){this.helper=new BXBlockEditorHelper();this.initControls();this.initDragDrop();this.initEditDialog();this.initPreview();this.initTabsBlockAndStyles()}this.initPhpSlices();this.initBlockPlaces();this.initBlocks();this.initStylist();this.save();if(!this.isInited){BX.onCustomEvent(this,"onInit",[this])}this.isInited=true};BXBlockEditor.prototype.initPhpSlices=function(){this.phpParser.resetItems();var c=BX.findChildren(this.iframe.contentDocument.body,{attribute:this.phpParser.getAttrName()},true);for(var d in c){var e=c[d];var b=e.getAttribute(this.phpParser.getAttrName());var a=this.phpParser.getPhpSliceDescription(b);e.innerHTML=a.name;e.setAttribute("title",a.title);this.phpParser.addItem(e.id,b,e.outerHTML)}};BXBlockEditor.prototype.initControls=function(){this.buttonMin=BX.findChild(this.context,{className:"bx-editor-block-btn-close"},true);this.buttonMax=BX.findChild(this.context,{className:"bx-editor-block-btn-full"},true);BX.bind(this.buttonMin,"click",BX.delegate(this.close,this));BX.bind(this.buttonMax,"click",BX.delegate(this.open,this));var b=this;this.panelList.edit={};this.panelList.edit.button=BX.findChildByClassName(this.context,"bx-editor-block-btn-edit",true);this.panelList.edit.panel=BX.findChildByClassName(this.context,"edit-panel",true);BX.bind(this.panelList.edit.button,"click",function(){b.showPanel("edit")});BX.addClass(this.panelList.edit.button,"bx-editor-block-btn-active");this.panelList.edit.panel.style.display=null;this.panelList.preview={};this.panelList.preview.button=BX.findChildByClassName(this.context,"bx-editor-block-btn-preview",true);this.panelList.preview.panel=BX.findChildByClassName(this.context,"preview-panel",true);BX.bind(this.panelList.preview.button,"click",function(){b.showPreview("preview")});var a=this.context.querySelector('[data-role="block-editor-tab-btn-get-html"]');BX.clipboard.bindCopyClick(a,{text:this.getContent.bind(this)})};BXBlockEditor.prototype.initBlocks=function(){this.blockList=[];var a=BX.findChildren(this.iframe.contentDocument.body,{attribute:this.CONST_ATTR_BLOCK},true);for(var b in a){this.addBlock(a[b])}};BXBlockEditor.prototype.initStylist=function(){var b=this.iframe.contentDocument.head;this.stylistContainerNode=false;this.helper.each(b.childNodes,function(f){var g=f.nodeName;if(g=="SCRIPT"||g=="STYLE"||g=="LINK"){if(f.attributes&&f.hasAttribute&&f.hasAttribute(this.CONST_ATTR_STYLIST_TAG)){this.stylistContainerNode=f}}},this);if(!this.stylistContainerNode){this.stylistContainerNode=BX.create("STYLE");this.stylistContainerNode.setAttribute(this.CONST_ATTR_STYLIST_TAG,"item");this.stylistContainerNode.setAttribute("type","text/css");b.appendChild(this.stylistContainerNode)}this.stylistInitedValues=this.cssParser.parse(this.stylistContainerNode.innerHTML);if(!this.isInited){this.content.getStyles().forEach(function(h){var g;if(h.block){g=h.block.parameters}else{if(h.value){g=this.cssParser.parse(h.value)}}var f=this.cssParser.parse(this.stylistContainerNode.innerHTML);g=this.cssParser.mergeStyles(f,g);this.stylistContainerNode.innerHTML=this.cssParser.getCssString(g)},this)}this.placeList=[];var e=this.findStylistPlaces();for(var d in e){var c=e[d];var a=new BXBlockEditorStylist();BX.onCustomEvent(this,"onPlaceBlockCreate",[a]);a.init(c,{caller:this,type:d,controls:{}});a.styleNode=this.stylistContainerNode;a.placeNode=c;this.placeList.push(a)}BX.addCustomEvent(this.editDialog,"onPlaceEdit",BX.delegate(this.onPlaceEdit,this));BX.addCustomEvent(this.editDialog,"onPlaceHover",BX.delegate(this.onPlaceHover,this))};BXBlockEditor.prototype.findStylistPlaces=function(){var f={};var b=BX.findChild(this.iframe.contentDocument.body,{attribute:{id:this.CONST_ATTR_ID_STYLIST+"Page"}},true);if(!b){b=this.iframe.contentDocument.body}f.page=b;var e=this.iframe.contentDocument.body.querySelectorAll("[id^="+this.CONST_ATTR_ID_STYLIST+"]");for(var a=0;a<e.length;a++){var d=e.item(a);if(d&&d.id){var c=d.id.substr(this.CONST_ATTR_ID_STYLIST.length);if(c){f[c]=d}}}return f};BXBlockEditor.prototype.onPlaceHover=function(d,e){for(var b in this.placeList){var a=this.placeList[b];if(d!=a.type){continue}var c=a.node;if(e){BX.addClass(c,"bx-stylist-enter")}else{BX.removeClass(c,"bx-stylist-enter")}break}};BXBlockEditor.prototype.onPlaceEdit=function(c){for(var b in this.placeList){var a=this.placeList[b];if(c!=a.type){continue}this.editBlock(a);break}};BXBlockEditor.prototype.initBlockPlaces=function(){var c,b;var d=null;var f;var e=this.findBlockPlaces();if(this.isTemplateMode){var a={};for(f in e){b=e[f];if(!a[f]){a[f]={node:b,html:""}}if(!d){d=f}}this.content.getBlocks().forEach(function(h){var j=null;if(a[h.place]){j=h.place}else{if(a.body){j="body"}else{if(a[d]){j=d}else{return}}}var i=a[j];var g="";if(h.block){g=this.getBlockHtml(h.block.type,h.block.parameters)}else{g=this.phpParser.replacePhpByLayout(h.value)}i.html+=g},this);this.helper.each(a,function(g){if(g.html.length>0){g.node.innerHTML=""}},this);this.helper.each(a,function(h){var g=false;if(h.html.length>0){h.node.innerHTML=h.html;g=true}BX.onCustomEvent(this,"onPlaceInitBlocksContent",[h.node,g])},this)}for(f in e){b=e[f];if(b.innerHTML){b.innerHTML=b.innerHTML.trim()}this.actualizeBlockPlace(b)}};BXBlockEditor.prototype.findBlockPlaces=function(){var a={};var c={attribute:this.CONST_ATTR_PLACE};var b=BX.findChildren(this.iframe.contentDocument.body,c,true);this.helper.each(b,function(d){var e=d.getAttribute(this.CONST_ATTR_PLACE);a[e]=d},this);return a};BXBlockEditor.prototype.actualizeBlockPlace=function(a){if(!a.hasAttribute(this.CONST_ATTR_PLACE)){return false}var e;var d=BX.findChildren(a,{attribute:this.CONST_ATTR_BLOCK},true);if(d.length==0){BX.cleanNode(a)}for(var c=0;c<a.childNodes.length;c++){var b=a.childNodes.item(c);if(b&&b.nodeName=="#text"){BX.remove(b)}}if(a.childNodes.length==0){e=BX.create("DIV",{text:BX.message("BLOCK_EDITOR_PLACE_DROP_ZONE")});BX.addClass(e,"bx-editor-place");a.appendChild(e);this.dragdrop.dragdrop.addCatcher(e)}else{e=BX.findChild(a,{className:"bx-editor-place"});if(e&&a.childNodes.length>1){this.dragdrop.dragdrop.removeCatcher(e);BX.remove(e)}}return true};BXBlockEditor.prototype.initPreview=function(){this.preview=new BXBlockEditorPreview({context:this.context,caller:this,site:this.site,url:this.previewUrl})};BXBlockEditor.prototype.initTabsBlockAndStyles=function(){var g=BX.findChildByClassName(this.context,"bx-editor-block-tabs",true);var b=BX.findChildByClassName(g,"blocks",true);var j=BX.findChildByClassName(g,"styles",true);var i=BX.findChildByClassName(this.context,"edit-panel-tabs-block",true);var h=BX.findChildByClassName(this.context,"edit-panel-tabs-style",true);var e=function(){if(BX.hasClass(this,"blocks")){BX.removeClass(j,"active");i.style.display="block";h.style.display="none"}else{BX.removeClass(b,"active");i.style.display="none";h.style.display="block"}BX.addClass(this,"active")};BX.bind(b,"click",e);BX.bind(j,"click",e);var c=BX.findChildByClassName(this.context,"adm-nav-page-prev",true);var d=BX.findChildByClassName(this.context,"adm-nav-page-next",true);var f=function(k,l){var o=k.querySelector("ul.bx-block-editor-i-block-list");while(o){if(BX.style(o,"display")=="block"){break}o=o.nextElementSibling}if(o){var m;if(l){m=o.nextElementSibling}else{m=o.previousElementSibling}if(m){var n=new BX.easing({duration:200,start:{opacity:1},finish:{opacity:0},transition:BX.easing.transitions.quart,step:function(p){o.style.opacity=p.opacity},complete:function(){o.style.display="none";o.style.opacity=1;m.style.display="block"}});n.animate()}}};var a=this.context;BX.bind(c,"click",function(){f(a,false)});BX.bind(d,"click",function(){f(a,true)})};BXBlockEditor.prototype.showPanel=function(b){for(var a in this.panelList){if(a!=b){this.panelList[a].panel.style.display="none";BX.removeClass(this.panelList[a].button,"bx-editor-block-btn-active")}}BX.addClass(this.panelList[b].button,"bx-editor-block-btn-active");this.panelList[b].panel.removeAttribute("style")};BXBlockEditor.prototype.showPreview=function(a,b){if(b==undefined){b=false}this.preview.show({content:this.getContent(b)});this.showPanel(a)};BXBlockEditor.prototype.showHtml=function(a){var b=BX.findChild(this.panelList[a].panel,{tag:"textarea"},true);b.value=this.getContent();this.showPanel(a)};BXBlockEditor.prototype.initEditDialog=function(){this.editDialog=new BXBlockEditorEditDialog({context:this.context,caller:this,saveFileUrl:this.saveFileUrl});this.editDialog.caller=this;this.phpParser=new BXBlockEditorPHPParser({htmlEditor:this.editDialog.htmlEditor});this.editDialog.phpParser=this.phpParser;BX.addCustomEvent(this.editDialog,"controlChangeValue",BX.delegate(this.onEditDialogControlChangeValue,this));BX.addCustomEvent(this.editDialog,"onSave",BX.delegate(this.editBlockEnd,this));BX.addCustomEvent(this.editDialog,"onCancel",BX.delegate(this.editBlockEnd,this));BX.addCustomEvent(this,"onClose",BX.delegate(this.editDialog.save,this.editDialog));BX.bind(BX.findParent(this.resultNode,{tag:"form"}),"submit",BX.delegate(function(){this.editDialog.save(BX.delegate(function(){this.isFinalSave=true;this.save()},this))},this))};BXBlockEditor.prototype.initDragDrop=function(){this.dragdrop=new BXBlockEditorDragDrop();BX.addCustomEvent(this.dragdrop,"onZoneEnter",this.showDragDropZone);BX.addCustomEvent(this.dragdrop,"onZoneLeave",this.hideDragDropZone);BX.addCustomEvent(this.dragdrop,"onItemAdd",BX.delegate(this.onDragDropItemAdd,this));BX.addCustomEvent(this.dragdrop,"onItemMove",BX.delegate(this.onDragDropItemMove,this))};BXBlockEditor.prototype.open=function(){BX.addClass(this.context,"editing")};BXBlockEditor.prototype.close=function(){BX.onCustomEvent(this,"onClose");BX.removeClass(this.context,"editing")};BXBlockEditor.prototype.save=function(){var a=this.getContentForSave();BX.onCustomEvent(this,"onSave",[a]);if(!this.resultNode){return}this.resultNode.value=a};BXBlockEditor.prototype.load=function(a,b){BX.onCustomEvent(this,"onLoadBefore",[a,b,this]);BX.unbindAll(this.iframe);BX.bind(this.iframe,"load",BX.delegate(function(){var d=BX.loadCSS("/bitrix/js/fileman/block_editor/editor.css?r="+Math.random(),this.iframe.contentDocument,this.iframe.contentWindow);if(d){var c={attrs:{}};c.attrs[this.CONST_ATTR_TMP_RESOURSE]="bx-editor";BX.adjust(d,c)}this.init();if(BX.type.isFunction(b)){b.apply(this)}BX.onCustomEvent(this,"onLoadAfter",[a,b,this])},this));if(this.charset){a=a+"&template_charset="+this.charset}this.iframe.src=a};BXBlockEditor.prototype.getSortedBlockListWithReplacedEmptyPlaces=function(){this.helper.each(this.findBlockPlaces(),function(d,c){var a=d.querySelectorAll("["+this.CONST_ATTR_BLOCK+"]");if(a.length>0){return}if(d.children.length!=1){return}var b=this.getBlockNodeByType("text");if(b){var e=this.addBlockByNode(b,d.children[0],true);e.setContentHtml("")}},this);return this.getSortedBlockList()};BXBlockEditor.prototype.getSortedBlockList=function(){var c=[];var b=this.iframe.contentDocument.body.querySelectorAll("["+this.CONST_ATTR_BLOCK+"]");b=BX.convert.nodeListToArray(b);var a=this.statusManager.getPlaceNameList(b);b.forEach(function(e,d){if(!e.parentNode||!BX.util.in_array(e.parentNode.getAttribute(this.CONST_ATTR_PLACE),a)){return}this.helper.each(this.blockList,function(f){if(f.node!==e){return}f.sort=d;c.push(f)},this)},this);return c};BXBlockEditor.prototype.getContentForSave=function(){if(!this.isTemplateMode){return this.getContent()}else{var d=[];if(this.stylistContainerNode&&this.stylistContainerNode.innerHTML){var b=this.stylistContainerNode.innerHTML.trim();if(b){var a=this.cssParser.diffStylesAll(this.stylistInitedValues,this.cssParser.parse(b));if(a){b='<style type="text/css">\n'+this.cssParser.getCssString(a)+"\n</style>";d.push({type:"STYLES",place:"page",value:b,block:{type:"stylist",parameters:a}})}}}var c=this.isFinalSave?this.getSortedBlockListWithReplacedEmptyPlaces():this.getSortedBlockList();d=d.concat(c.map(function(e){return{type:"BLOCKS",place:e.getPlaceHolderCode(),value:e.getContentHtmlOuter(),block:{type:e.type,parameters:e.getEditValues()}}},this));return this.content.getString(d)}};BXBlockEditor.prototype.getContent=function(p){p=!!(p||null);var s=this.iframe.contentDocument.cloneNode(true);if(s.head){for(var o=0;o<s.head.childNodes.length;o++){var e=s.head.childNodes.item(o);var r=e.nodeName;r=r||"";r=r.toUpperCase();if(r=="SCRIPT"||r=="STYLE"||r=="LINK"){if(e.attributes&&e.hasAttribute){if(e.hasAttribute(this.CONST_ATTR_TMP_RESOURSE)){BX.remove(e)}else{if(e.hasAttribute(this.CONST_ATTR_STYLIST_TAG)){}}}}}}var b=BX.findChildren(s.body,{attribute:this.CONST_ATTR_PLACE},true);for(var m in b){var q=b[m];var l=BX.findChildren(q,{attribute:this.CONST_ATTR_BLOCK},true);if(l.length==0){BX.cleanNode(q)}}var d=[];if(s.body){d=BX.findChildren(s.body,{attribute:this.CONST_ATTR_BLOCK},true)}for(var h in d){var g=d[h];var a=BX.findChild(g,{className:"bx-content"},true);var f=a.childNodes;if(p&&g&&g.getAttribute&&g.getAttribute(this.CONST_ATTR_BLOCK)=="component"){f=BX.findChildren(g,{className:"bx-component"},true)}BX.cleanNode(g);BX.adjust(g,{children:f});for(var c=g.attributes.length;c>=0;c--){if(g.attributes[c]&&g.attributes[c].name!=this.CONST_ATTR_BLOCK){g.removeAttribute(g.attributes[c].name)}}}if(!p){this.phpParser.replaceLayoutBySurrogate(s.body)}result=s.documentElement.outerHTML;if(!p){result=this.phpParser.replaceSurrogateByPhp(result)}return result};BXBlockEditor.prototype.showDragDropZone=function(b,a){BX.addClass(b,"bx-dd-enter");if(a){BX.removeClass(b,"bx-dd-enter-bottom");BX.addClass(b,"bx-dd-enter-top")}else{BX.removeClass(b,"bx-dd-enter-top");BX.addClass(b,"bx-dd-enter-bottom")}};BXBlockEditor.prototype.hideDragDropZone=function(a){BX.removeClass(a,"bx-dd-enter");BX.removeClass(a,"bx-dd-enter-top");BX.removeClass(a,"bx-dd-enter-bottom")};BXBlockEditor.prototype.onDragDropItemMove=function(d,c,e){var b=d.parentNode;var f;for(var a in this.blockList){if(this.blockList[a]&&this.blockList[a].node==d){f=this.blockList[a];break}}f.onMoveHandler(c);this.helper.appendChildNode(d,c,e);this.actualizeBlockPlace(b);this.actualizeBlockPlace(c.parentNode);BX.onCustomEvent(this,"onBlockMoveAfter",[f]);this.save()};BXBlockEditor.prototype.onDragDropItemAdd=function(a,b,c){this.addBlockByNode(this.getBlockNodeByType(a),b,c);this.save()};BXBlockEditor.prototype.onEditDialogControlChangeValue=function(a,b,c){if(this.currentEditingBlock){this.currentEditingBlock.setEditValue(a,b,c)}};BXBlockEditor.prototype.getCurrentEditingBlock=function(){return this.currentEditingBlock};BXBlockEditor.prototype.getBlockHtml=function(b,a){var c=this.getBlockNodeByType(b);var d;if(b==="component"){d=new BXBlockEditorBlockComponent()}else{d=new BXBlockEditorBlock()}d.init(c,{caller:this,type:b});d.setEditValues(a);return d.getContentHtmlOuter()};BXBlockEditor.prototype.getBlockHtmlByCode=function(c){var b=this.blockTypeList[c].TYPE;var a=this.blockTypeList[c].HTML;if(b=="component"){a=this.phpParser.getComponentInclude(c)}return this.phpParser.replacePhpByLayout(a)};BXBlockEditor.prototype.getBlockNodeByType=function(d){var a={};var c=this.blockTypeList[d].TYPE;var b=this.getBlockHtmlByCode(d);a[this.CONST_ATTR_BLOCK]=c;return BX.create({tag:"DIV",attrs:a,html:b})};BXBlockEditor.prototype.addBlockByNode=function(b,a,c){var d=this.addBlock(b);d.onMoveHandler(a);this.helper.appendChildNode(b,a,c);this.actualizeBlockPlace(a.parentNode);BX.onCustomEvent(d,"onBlockCreateAfter");BX.onCustomEvent(this,"onBlockCreateAfter",[d]);return d};BXBlockEditor.prototype.addBlockByHtml=function(b,c,d){var a=BX.create({tag:"DIV",html:b});return this.addBlockByNode(a.children[0],c,d)};BXBlockEditor.prototype.addBlock=function(b){var a=b.getAttribute(this.CONST_ATTR_BLOCK);var c;BX.addClass(b,"bx-editor-block");BX.addClass(b,"bx-type-"+a);if(a==="component"){c=new BXBlockEditorBlockComponent()}else{c=new BXBlockEditorBlock()}BX.onCustomEvent(this,"onBlockCreate",[c]);c.init(b,{caller:this,type:b.getAttribute(this.CONST_ATTR_BLOCK),controls:{drag:BX.delegate(function(){},this),clone:BX.delegate(function(d){this.cloneBlock(c);return BX.PreventDefault(d)},this),edit:BX.delegate(function(d){this.editBlock(c);return BX.PreventDefault(d)},this),remove:BX.delegate(function(d){this.removeBlock(c);return BX.PreventDefault(d)},this)}});this.blockList.push(c);this.dragdrop.addItem(c.node);return c};BXBlockEditor.prototype.removeBlock=function(c){BX.onCustomEvent(this,"onBlockRemove",[c]);for(var b in this.blockList){if(c==this.blockList[b]){this.blockList.splice(b,1)}}this.dragdrop.removeItem(c.node);var a=c.node.parentNode;BX.remove(c.node);this.actualizeBlockPlace(a);this.save();this.editDialog.hide()};BXBlockEditor.prototype.cloneBlock=function(d){var b={};b[this.CONST_ATTR_BLOCK]=d.type;var a=BX.create({tag:"DIV",attrs:b,html:this.phpParser.replacePhpByLayout(d.getContentHtml())});d.node.parentNode.insertBefore(a,d.node);var c=this.addBlock(a);BX.onCustomEvent(this,"onBlockClone",[c]);this.save()};BXBlockEditor.prototype.editBlockEnd=function(a){if(!this.currentEditingBlock){return}BX.onCustomEvent(this,"onBlockEditEnd",[this.currentEditingBlock,a]);this.save();BX.removeClass(this.currentEditingBlock.node,"bx-editor-block-current-edit");this.currentEditingBlock=null};BXBlockEditor.prototype.editBlock=function(a){BX.onCustomEvent(this,"onBlockEdit",[a]);var b=this;this.editDialog.save(function(){b.currentEditingBlock=a;BX.addClass(b.currentEditingBlock.node,"bx-editor-block-current-edit");b.editDialog.load(a.getEditPropList());b.editDialog.show()})};function BXBlockEditorBlock(){this.caller=null;this.type="";this.node={};this.nodeContent={};this.editHandlerList={}}BXBlockEditorBlock.prototype.init=function(a,b){this.caller=b.caller;this.type=b.type;this.node=a;this.helper=new BXBlockEditorHelper();this.initStructure();if(b.controls){this.initControls(b.controls)}this.initEditHandlers();this.initDependencies()};BXBlockEditorBlock.prototype.initEditHandlers=function(){BX.onCustomEvent(this.caller,"onBlockInitHandlers",[this,this.type])};BXBlockEditorBlock.prototype.getPlaceHolderCode=function(){return this.node.parentNode.getAttribute(this.caller.CONST_ATTR_PLACE)};BXBlockEditorBlock.prototype.setContentHtml=function(b,a){a=!!(a||null);if(!a){b=this.caller.phpParser.replacePhpByLayout(b)}this.nodeContent.innerHTML=b};BXBlockEditorBlock.prototype.getContentHtml=function(b){b=!!(b||null);var c=BX.clone(this.nodeContent);if(!b){this.caller.phpParser.replaceLayoutBySurrogate(c)}var a=c.innerHTML;if(!a){a=""}if(!b){a=this.caller.phpParser.replaceSurrogateByPhp(a)}a=a.trim();return a};BXBlockEditorBlock.prototype.getContentHtmlOuter=function(a){var b=this.getContentHtml(a);b="<div "+this.caller.CONST_ATTR_BLOCK+'="'+this.type+'">\n'+b+"\n</div>";return b};BXBlockEditorBlock.prototype.findEditHandler=function(a){if(this.editHandlerList&&this.editHandlerList[a]){return this.editHandlerList[a]}return null};BXBlockEditorBlock.prototype.initDependencies=function(){var a={};for(var e in this.editHandlerList){var d=this.editHandlerList[e];if(!BX.type.isArray(d.reload_dependence)){continue}for(var c in d.reload_dependence){var b=d.reload_dependence[c];if(!BX.type.isArray(a[b])){a[b]=[]}a[b].push(e)}}this.dependencies=a};BXBlockEditorBlock.prototype.onMoveHandler=function(a){var b=this.node;this.helper.each(this.editHandlerList,BX.delegate(function(c){if(BX.type.isFunction(c.onMove)){this.findEditNodeList(c.className);c.onMove.apply(this,[b,a])}},this));if(BX.type.isFunction(this.onMove)){this.onMove.apply(this,[b,a])}};BXBlockEditorBlock.prototype.findEditNodeList=function(d,f){var a=[];var b=[];var e=0;if(f){f=parseInt(f)}if(d){b=BX.findChildren(this.nodeContent,{className:d},true)}else{b.push(this.nodeContent)}for(var c in b){if(f){e++;if(e<f){continue}if(e>f){break}}a.push(b[c])}return a};BXBlockEditorBlock.prototype.columnToolName="column-count";BXBlockEditorBlock.prototype.getEditValues=function(){var a=[];var c=this.getEditValue(this.columnToolName);c=c>0?c:1;for(var d in this.editHandlerList){if(!this.editHandlerList.hasOwnProperty(d)){continue}for(var b=1;b<=c;b++){var e=this.getEditValue(d,b);if(e===null||e===""){continue}a.push({code:d,value:e,column:b})}}return a};BXBlockEditorBlock.prototype.setEditValues=function(a){var b=a.filter(function(d){return d.code==this.columnToolName},this);if(b&&b[0]){var c=b[0].value;c=c>0?c:1;this.setEditValue(this.columnToolName,c)}a.forEach(function(d){this.setEditValue(d.code,d.value,d.column>0?d.column:1)},this)};BXBlockEditorBlock.prototype.setEditValue=function(g,e,f){var c=this.findEditHandler(g);if(!c){return}var a=this.findEditNodeList(c.className,f);if(!BX.type.isFunction(c.func)){return}for(var b in a){var d=a[b];c.func.apply(this,[d,g,e])}};BXBlockEditorBlock.prototype.getEditValue=function(f,e){var a=null;var c=this.findEditHandler(f);if(!c){return a}var b=this.findEditNodeList(c.className,e);if(!BX.type.isFunction(c.func)){return a}var d=b[0];if(!d){return a}a=c.func.apply(this,[d,f]);return a};BXBlockEditorBlock.prototype.getEditPropList=function(d){var a=[];d=d||[];for(var c in this.editHandlerList){if(d.length>0&&!BX.util.in_array(c,d)){continue}var b=this.editHandlerList[c];a.push({code:c,params:b.params?b.params:{},value:this.getEditValue(c),dependence:this.dependencies[c]?this.dependencies[c]:[]})}return a};BXBlockEditorBlock.prototype.initStructure=function(){var e=this.node;var d;var h=document.createElement("div");BX.addClass(h,"bx-shadow");var f=document.createElement("div");BX.addClass(f,"bx-controls");f.innerHTML='<span title="'+BX.message("BLOCK_EDITOR_BLOCK_ACTION_MOVE")+'" class="bx-editor-block-controls-btn bx-drag"></span><span title="'+BX.message("BLOCK_EDITOR_BLOCK_ACTION_REMOVE")+'" class="bx-editor-block-controls-btn bx-remove"></span><span title="'+BX.message("BLOCK_EDITOR_BLOCK_ACTION_COPY")+'" class="bx-editor-block-controls-btn bx-clone"></span><span title="'+BX.message("BLOCK_EDITOR_BLOCK_ACTION_EDIT")+'" class="bx-editor-block-controls-btn bx-edit"></span>';var g=e.innerHTML;var c=BX.create({tag:"DIV",props:{className:"bx-content"},html:g});e.innerHTML="";this.nodeContent=c;d=BX.create({tag:"DIV",props:{className:"bx-block-inside"},children:[h,c,f],style:{display:"none"}});var b=document.createElement("div");BX.addClass(b,"bx-dropzone");b.innerHTML=BX.message("BLOCK_EDITOR_PLACE_DROP_ZONE");var a=document.createElement("div");BX.addClass(a,"bx-dropzone");a.innerHTML=BX.message("BLOCK_EDITOR_PLACE_DROP_ZONE");e.appendChild(b);e.appendChild(d);e.appendChild(a);d.style.display="block"};BXBlockEditorBlock.prototype.initControls=function(e){var b=BX.findChild(this.node,{className:"bx-controls"},true);var a=BX.findChild(b,{className:"bx-remove"},true);var c=BX.findChild(b,{className:"bx-drag"},true);var f=BX.findChild(b,{className:"bx-clone"},true);var d=BX.findChild(b,{className:"bx-edit"},true);BX.bind(a,"click",e.remove);BX.bind(c,"click",e.drag);BX.bind(f,"click",e.clone);BX.bind(d,"click",e.edit);BX.bind(this.node,"click",e.edit)};function BXBlockEditorBlockComponent(){BXBlockEditorBlockComponent.superclass.constructor.call(this);this.componentDescriptionNode=null;this.init=function(d,g){g.controls.edit=BX.delegate(this.onEdit,this);BXBlockEditorBlockComponent.superclass.init.call(this,d,g);this.setContentClearPhp(this.getContentClearPhp());var f=BX.create({tag:"DIV",props:{className:"bx-component-header"}});var c=BX.create({tag:"DIV",props:{className:"bx-component-icon"}});var e=BX.create({tag:"DIV",props:{className:"bx-component-description"}});var b=BX.create({tag:"DIV",props:{className:"bx-component"},children:[f,c,e]});this.nodeContent.parentNode.insertBefore(b,this.nodeContent.nextSibling);this.componentIconNode=BX.findChildByClassName(this.node,"bx-component-icon",true);this.componentDescriptionNode=BX.findChildByClassName(this.node,"bx-component-description",true);this.componentHeaderNode=BX.findChildByClassName(this.node,"bx-component-header",true);var a=this.caller.phpParser.getPhpSliceDescription(this.getContentClearPhp());this.componentHeaderNode.innerHTML=a?a.name:this.type;this.componentDescriptionNode.innerHTML=a?a.title:this.type;BX.addCustomEvent(this,"onBlockCreateAfter",this.onBlockCreateAfter)};this.setContentClearPhp=function(a){a='<div class="bxBlockPadding">'+a+"</div>";this.setContentHtml(a)};this.getContentClearPhp=function(){return this.getContentHtml().split(/<[^?>]+>/g).join("")};this.onBlockCreateAfter=function(){this.showComponentPropertiesDialog()};this.onEdit=function(){this.showComponentPropertiesDialog()};this.showComponentPropertiesDialog=function(){this.caller.currentEditingBlock=this;var a=this;this.caller.editDialog.save();this.caller.phpParser.showComponentPropertiesDialog(this.getContentClearPhp(),function(b){a.setContentClearPhp(b);a.caller.editBlockEnd(true)},function(){a.caller.editBlockEnd(false)})}}BX.extend(BXBlockEditorBlockComponent,BXBlockEditorBlock);function BXBlockEditorStylist(){BXBlockEditorStylist.superclass.constructor.call(this);this.styleNode=null;this.placeNode=null;this.selectorTextList=[".bxBlockContentText",".bxBlockContentText p",".bxBlockContentSocial",".bxBlockContentSocial p",".bxBlockContentBoxedText",".bxBlockContentBoxedText p"];this.selectorAList=[".bxBlockSocial a",".bxBlockContentText a",".bxBlockContentBoxedText a"];this.getPlaceHolderCode=function(){};this.initStructure=function(){};this.initControls=function(){};this.getContentHtml=function(){};this.getContentHtmlOuter=function(){};this.findEditNodeList=function(a){return[this.styleNode]};this.initEditHandlers=function(){if(this.type=="page"){this.editHandlerList={"bx-stylist-bgcolor":{className:"",func:function(c,e,d){return this.css("",[""],c,"background",d)}}};var b=(function(){return function(d,c){d["bx-stylist-"+c+"-color"]={className:"",func:function(f,h,g){if(g){g+=" !important"}var e=this.css("",[c],f,"color",g);if(e){resultList=e.split(" ");e=resultList[0]}return e}};d["bx-stylist-"+c+"-font-size"]={className:"",func:function(f,h,g){if(g){g+=" !important"}var e=this.css("",[c],f,"font-size",g);if(e){resultList=e.split(" ");e=resultList[0]}return e}};d["bx-stylist-"+c+"-font-weight"]={className:"",func:function(f,h,g){if(g){g+=" !important"}var e=this.css("",[c],f,"font-weight",g);if(e){resultList=e.split(" ");e=resultList[0]}return e}};d["bx-stylist-"+c+"-font-weight"]={className:"",func:function(f,h,g){if(g){g+=" !important"}var e=this.css("",[c],f,"font-weight",g);if(e){resultList=e.split(" ");e=resultList[0]}return e}};d["bx-stylist-"+c+"-line-height"]={className:"",func:function(f,h,g){if(g){g+=" !important"}var e=this.css("",[c],f,"line-height",g);if(e){resultList=e.split(" ");e=resultList[0]}return e}};d["bx-stylist-"+c+"-text-align"]={className:"",func:function(f,h,g){if(g){g+=" !important"}var e=this.css("",[c],f,"text-align",g);if(e){resultList=e.split(" ");e=resultList[0]}return e}};return d}})();for(var a=1;a<=4;a++){this.editHandlerList=b(this.editHandlerList,"h"+a)}}else{this.editHandlerList={"bx-stylist-bgcolor":{className:"",func:function(c,e,d){return this.css("",[""],c,"background",d)}},"bx-stylist-padding-top":{className:"",func:function(c,e,d){return this.css("",[""],c,"padding-top",d)}},"bx-stylist-padding-bottom":{className:"",func:function(c,e,d){return this.css("",[""],c,"padding-bottom",d)}},"bx-stylist-text-color":{className:"",func:function(c,e,d){return this.cssTextBlock(c,"color",d)}},"bx-stylist-text-font-family":{className:"",func:function(c,e,d){return this.cssTextBlock(c,"font-family",d)}},"bx-stylist-text-font-size":{className:"",func:function(c,e,d){return this.cssTextBlock(c,"font-size",d)}},"bx-stylist-text-font-weight":{className:"",func:function(c,e,d){return this.cssTextBlock(c,"font-weight",d)}},"bx-stylist-text-line-height":{className:"",func:function(c,e,d){return this.cssTextBlock(c,"line-height",d)}},"bx-stylist-text-text-align":{className:"",func:function(c,e,d){return this.cssTextBlock(c,"text-align",d)}},"bx-stylist-a-color":{className:"",func:function(c,e,d){return this.cssATag(c,"color",d)}},"bx-stylist-a-font-weight":{className:"",func:function(c,e,d){return this.cssATag(c,"font-weight",d)}},"bx-stylist-a-text-decoration":{className:"",func:function(c,e,d){return this.cssATag(c,"text-decoration",d)}}}}};this.getSelector=function(e){var d=this.type;d=d[0].toUpperCase()+d.substring(1);var b=[];for(var c in e){var a=e[c];if(this.type=="page"){b.push("body"+(a?" ":"")+a)}b.push("#"+this.caller.CONST_ATTR_ID_STYLIST+d+(a?" ":"")+a)}return b.join(", ")};this.cssHeadTag=function(a,b,d,c){return this.css("",[a],b,d,c)};this.css=function(a,h,d,c,i){var f=this.getSelector(h);var e;if(typeof(i)!=="undefined"){var g={};g[c]=i;e=d.innerHTML;if(d.styleSheet){e=d.styleSheet.cssText}e=this.caller.cssParser.setStyle(e,a,f,g);d.innerHTML=e;if(d.styleSheet){d.styleSheet.cssText=e}}e=d.innerHTML;if(d.styleSheet){e=d.styleSheet.cssText}var b=this.caller.cssParser.getStyle(e,a,f,[c]);return b[c]};this.cssTextBlock=function(a,c,b){return this.css("",this.selectorTextList,a,c,b)};this.cssATag=function(a,c,b){return this.css("",this.selectorAList,a,c,b)}}BX.extend(BXBlockEditorStylist,BXBlockEditorBlock);function BXBlockEditorPHPParser(a){this.phpList=[];this.htmlEditor=a.htmlEditor;this.componentPropertiesDialogHandler=null;this.componentPropertiesDialogHandlerCancel=null;BX.addCustomEvent(this.htmlEditor,"OnContentChanged",BX.delegate(this.handleComponentPropertiesChange,this))}BXBlockEditorPHPParser.prototype.handleComponentPropertiesClose=function(){if(BX.type.isFunction(this.componentPropertiesDialogHandlerCancel)){this.componentPropertiesDialogHandlerCancel.call(this)}this.componentPropertiesDialogHandler=null;this.componentPropertiesDialogHandlerCancel=null};BXBlockEditorPHPParser.prototype.handleComponentPropertiesChange=function(a){if(BX.type.isFunction(this.componentPropertiesDialogHandler)){this.componentPropertiesDialogHandler.call(this,a)}this.componentPropertiesDialogHandler=null;this.componentPropertiesDialogHandlerCancel=null};BXBlockEditorPHPParser.prototype.showComponentPropertiesDialog=function(d,e,a){if(!this.htmlEditor.components.IsComponent(d)){return}this.htmlEditor.SetContent(d,true);var f=this.htmlEditor.phpParser.GetAllSurrogates();if(!f[0]){return}var g=f[0];var b=this.htmlEditor.GetBxTag(g.node);var c=this.htmlEditor.GetBxTag(b.surrogateId);this.componentPropertiesDialogHandler=e;this.componentPropertiesDialogHandlerCancel=a;this.htmlEditor.components.ShowPropertiesDialog(b.params,c);BX.addCustomEvent(this.htmlEditor.components.oPropertiesDialog.oDialog,"onWindowUnRegister",BX.proxy(this.handleComponentPropertiesClose,this))};BXBlockEditorPHPParser.prototype.replaceLayoutBySurrogate=function(b){for(var a in this.phpList){var c=this.phpList[a];var d=BX.findChild(b,{attribute:{id:c.id}},true);if(d){d.outerHTML="#"+c.id+"#"}}};BXBlockEditorPHPParser.prototype.replaceSurrogateByPhp=function(d){var a=d;for(var b in this.phpList){var c=this.phpList[b];a=a.replace("#"+c.id+"#",c.content)}return a};BXBlockEditorPHPParser.prototype.replaceLayoutByPhp=function(e){var b=e;var a=this.phpList.length;for(var c=a-1;c>=0;c--){var d=this.phpList[c];b=b.replace(d.layout,d.content)}return b};BXBlockEditorPHPParser.prototype.resetItems=function(){this.phpList=[]};BXBlockEditorPHPParser.prototype.addItem=function(c,a,b){this.phpList.push({id:c,content:a,layout:b})};BXBlockEditorPHPParser.prototype.getAttrName=function(){return"data-bx-editor-php-slice"};BXBlockEditorPHPParser.prototype.getPhpSliceDescription=function(d){var a={name:"PHP",title:"PHP"};var c=this.htmlEditor.components.IsComponent(d);if(c){var e=this.htmlEditor.components.GetComponentData(c.name);var b=e.title||c.name;var f=(e.params&&e.params.DESCRIPTION)?e.params.DESCRIPTION:f;a={name:b,title:f}}return a};BXBlockEditorPHPParser.prototype.replacePhpByLayout=function(i){var f=this.htmlEditor.phpParser.ReplacePhpBySymCode(i);for(var c in this.htmlEditor.phpParser.arScripts){var d=this.htmlEditor.phpParser.GetPhpPattern(c);var b="bx_block_php_"+Math.random();var e=this.htmlEditor.phpParser.arScripts[c];var h=this.getPhpSliceDescription(e);var a=e.replace(/&/g,"&amp;").replace(/"/g,"&quot;");var g='<span id="'+b+'" '+this.getAttrName()+'="'+a+'" class="bxhtmled-surrogate" title="'+h.title+'">'+h.name+"</span>";this.addItem(b,e,g);f=f.replace(d,g)}return f};BXBlockEditorPHPParser.prototype.getComponentInclude=function(a,b){b=b||false;var c=this.htmlEditor.components.GetOnDropHtml({name:a});if(b){c=this.replacePhpByLayout(c)}return c};