(function(){var a=window.BX;if(a.UserContentView){return}a.UserContentView={displayHeight:0,mobile:false,ajaxUrl:"/bitrix/tools/sonet_set_content_view.php",pathToUserProfile:"",inited:false,viewAreaList:[],lastViewAreaList:{},viewAreaReadList:[],viewAreaSentList:[],viewAreaAverageHeight:200,viewAreaTimePeriodMin:1000,viewAreaTimePeriodMax:10000,viewAreaTimePeriodAvg:1500,sendViewAreaTimeout:5000,commentsContainerId:null,commentsClassName:"feed-com-text-inner",commentsFullContentClassName:"feed-com-text-inner-inner",currentPopupId:null,popupList:{}};a.UserContentView.clear=function(){this.viewAreaList=[]};a.UserContentView.setDisplayHeight=function(){this.displayHeight=document.documentElement.clientHeight};a.UserContentView.init=function(c){if(this.inited){return}this.inited=true;this.setDisplayHeight();window.addEventListener("scroll",a.throttle(function(){a.UserContentView.getInViewScope()},80),{passive:true});window.addEventListener("resize",a.delegate(a.UserContentView.setDisplayHeight,this));if(a.type.isPlainObject(c)){if(a.type.isBoolean(c.mobile)){this.mobile=c.mobile}if(a.type.isNotEmptyString(c.ajaxUrl)){this.ajaxUrl=c.ajaxUrl}if(a.type.isNotEmptyString(c.commentsContainerId)){this.commentsContainerId=c.commentsContainerId}if(a.type.isNotEmptyString(c.commentsClassName)){this.commentsClassName=c.commentsClassName}if(a.type.isNotEmptyString(c.commentsFullContentClassName)){this.commentsFullContentClassName=c.commentsFullContentClassName}}if(a.browser.SupportLocalStorage()){var b=a.localStorage.get("viewedContent");if(a.type.isArray(b)){this.viewAreaSentList=b}}a.addCustomEvent(window,"OnUCRecordHasDrawn",a.delegate(this.onUCRecordHasDrawn,this));a.addCustomEvent(window,"OnUCListWasShown",a.delegate(this.OnUCListWasShown,this));if(this.mobile){a.addCustomEvent(window,"OnUCHasBeenInitialized",a.delegate(this.OnUCHasBeenInitializedMobile,this));this.sendViewAreaTimeout=1500}setTimeout(a.delegate(this.sendViewAreaData,this),this.sendViewAreaTimeout)};a.UserContentView.getInViewScopeNode=function(j){var g=a(j),h=new Date(),f=parseInt(h.getTime());if(!g){for(var b=0,e=this.viewAreaList.length;b<e;b++){if(j==this.viewAreaList[b]){delete this.viewAreaList[b]}}return}if(this.isNodeVisibleOnScreen(g)){var c=this.getXmlId(g);if(!a.type.isBoolean(this.lastViewAreaList[j])&&(!a.type.isNotEmptyString(c)||!a.util.in_array(c,this.viewAreaSentList))){setTimeout(a.delegate(function(){if(a.UserContentView.isNodeVisibleOnScreen(this)){a.UserContentView.setRead(this)}delete a.UserContentView.lastViewAreaList[this.id]},g),this.viewAreaTimePeriodAvg)}this.lastViewAreaList[j]=true}};a.UserContentView.getInViewScope=function(){for(var b=0,c=this.viewAreaList.length;b<c;b++){this.getInViewScopeNode(this.viewAreaList[b])}};a.UserContentView.getXmlId=function(b){return b.getAttribute("bx-content-view-xml-id")};a.UserContentView.getSaveValue=function(b){return(b.getAttribute("bx-content-view-save")!="N"?"Y":"N")};a.UserContentView.setRead=function(e){var d=this.getXmlId(e);if(d.length>0){var f=false;for(var b=0,c=this.viewAreaReadList.length;b<c;b++){if(this.viewAreaReadList[b].xmlId==d){f=true;break}}if(!f){this.viewAreaReadList.push({xmlId:d,save:this.getSaveValue(e)});var g={xmlId:d};a.onCustomEvent(window,"BX.UserContentView.onSetRead",[g]);if(typeof BXMobileApp!="undefined"){BXMobileApp.onCustomEvent("BX.UserContentView.onSetRead",g,true)}}}};a.UserContentView.isNodeVisibleOnScreen=function(c){var e=c.getBoundingClientRect();var d=parseInt(this.displayHeight/4);var b=parseInt(this.displayHeight*3/4);return(((e.top>0&&e.top<b)||(e.bottom>d&&e.bottom<this.displayHeight))&&(this.mobile||!((e.top<d&&e.bottom<d)||(e.top>b&&e.bottom>b))))};a.UserContentView.sendViewAreaData=function(){var d=null,b=null,e=[];for(b=0,length=this.viewAreaReadList.length;b<length;b++){d=this.viewAreaReadList[b];if(!a.util.in_array(d.xmlId,this.viewAreaSentList)){e.push(d)}}if(e.length>0&&this.ajaxUrl){var c={action:"set_content_view",sessid:a.bitrix_sessid(),site:a.message("SITE_ID"),lang:a.message("LANGUAGE_ID"),viewXMLIdList:e};if(!!this.mobile){c.mobile_action="set_content_view"}a.ajax({url:this.ajaxUrl,method:"POST",dataType:"json",data:c,onsuccess:a.delegate(function(f){if(a.type.isNotEmptyString(f.SUCCESS)&&f.SUCCESS=="Y"){for(b=0,length=e.length;b<length;b++){this.viewAreaSentList.push(e[b].xmlId)}if(a.browser.SupportLocalStorage()){a.localStorage.set("viewedContent",this.viewAreaSentList,86400)}}},this),onfailure:function(f){}})}setTimeout(a.delegate(this.sendViewAreaData,this),this.sendViewAreaTimeout)};a.UserContentView.registerViewArea=function(c,b){if(c.length>0&&!a.util.in_array(c,this.viewAreaList)&&a(c)){this.viewAreaList.push(c);this.getInViewScopeNode(c)}};a.UserContentView.onUCRecordHasDrawn=function(b,g,e){if(typeof e=="undefined"||typeof e.ACTION=="undefined"||typeof g=="undefined"){return}if(e.ACTION=="REPLY"){var d=a.delegate(function(){this.onUCRecordHasDrawnFunc(g)},this);var c=a.debounce(a.delegate(function(){a.unbind(document,"mousemove",c);d()},this),100,this);var f=a.delegate(function(){BXMobileApp.UI.Page.isVisible({callback:function(h){if(h&&h.status=="visible"){d()}else{setTimeout(f,50)}}})},this);if(this.mobile){setTimeout(f,50)}else{a.bind(document,"mousemove",c)}}};a.UserContentView.onUCRecordHasDrawnFunc=function(e){var c="record-"+e.join("-");if(a(c)){var b=a.findChild(a(c),{tag:"div",className:this.commentsClassName},true);if(b&&b.id.length>0){var d=a.findChild(b,{tag:"div",className:this.commentsFullContentClassName});a.UserContentView.registerViewArea(b.id,(d?d:null))}}};a.UserContentView.OnUCListWasShown=function(c,h,b){var g=null,e=a.findChildren(b,{tag:"div",className:this.commentsClassName},true);for(var d=0,f=e.length;d<f;d++){if(e[d].id.length>0){g=a.findChild(e[d],{tag:"div",className:this.commentsFullContentClassName});this.registerViewArea(e[d].id,(g?g:null))}}};a.UserContentView.OnUCHasBeenInitializedMobile=function(c,b){this.registerViewAreaList({containerId:this.commentsContainerId,className:this.commentsClassName,fullContentClassName:this.commentsFullContentClassName})};a.UserContentView.registerViewAreaList=function(f){if(typeof f=="undefined"||typeof f.containerId=="undefined"||typeof f.className=="undefined"){return}if(a(f.containerId)){var e=null,c=a.findChildren(a(f.containerId),{tag:"div",className:f.className},true);for(var b=0,d=c.length;b<d;b++){if(c[b].id.length>0){e=a.findChild(c[b],{tag:"div",className:f.fullContentClassName});this.registerViewArea(c[b].id,(e?e:null))}}}};a.UserContentView.liveUpdate=function(d){var b=a("feed-post-contentview-cnt-"+d.CONTENT_ID);var e=a("feed-post-contentview-cnt-wrap-"+d.CONTENT_ID);if(b&&e){var c=a.create("SPAN",{props:{className:"feed-content-view-plus-one"},style:{width:(e.clientWidth-8)+"px",height:(e.clientHeight-8)+"px"},html:"1"});e.insertBefore(c,e.firstChild);setTimeout(function(){b.innerHTML=parseInt(b.innerHTML)+1},500);setTimeout(function(){a.cleanNode(c,true)},2000)}};a.UserContentView.Counter=function(){this.contentId=null;this.nodeId=null;this.node=null;this.popup=null;this.popupTimeoutId=null;this.popupContent=null;this.hiddenCountNode=null;this.popupContentPage=1;this.popupShownIdList=[];this.pathToUserProfile=""};a.UserContentView.Counter.prototype.init=function(b){this.contentId=b.contentId;this.nodeId=b.nodeId;if(this.nodeId){this.node=a(this.nodeId);this.popupContent=a.findChild(a("bx-contentview-cnt-popup-cont-"+this.contentId),{tagName:"span",className:"bx-contentview-popup"},true,false)}if(a.type.isNotEmptyString(b.pathToUserProfile)){this.pathToUserProfile=b.pathToUserProfile}if(typeof a.PULL!="undefined"){a.PULL.extendWatch("CONTENTVIEW"+this.contentId)}this.popupScroll();a.bind(this.node,"mouseover",a.delegate(function(){clearTimeout(this.popupTimeoutId);this.popupContentPage=1;a.cleanNode(this.popupContent);this.popupContent.appendChild(a.create("SPAN",{props:{className:"bx-contentview-wait"}}));this.popupTimeoutId=setTimeout(a.delegate(function(){if(a.UserContentView.currentPopupId==this.contentId){return false}if(this.popupContentPage==1){this.list({page:1})}this.popupTimeoutId=setTimeout(a.delegate(function(){this.openPopup()},this),400)},this),400)},this));a.bind(this.node,"mouseout",a.delegate(function(){clearTimeout(this.popupTimeoutId)},this));a.bind(this.node,"click",a.delegate(function(){clearTimeout(this.popupTimeoutId);if(this.popupContentPage==1){this.list({page:1})}this.openPopup()},this))};a.UserContentView.Counter.prototype.list=function(d){var c=d.page;if(parseInt(this.node.innerHTML)==0){return false}if(c==null){c=this.popupContentPage}if(c==1){this.popupShownIdList=[]}var b={action:"get_view_list",sessid:a.bitrix_sessid(),site:a.message("SITE_ID"),lang:a.message("LANGUAGE_ID"),contentId:this.contentId,pathToUserProfile:this.pathToUserProfile,page:c};a.ajax({url:a.UserContentView.ajaxUrl,method:"POST",dataType:"json",data:b,onsuccess:a.delegate(function(h){if(parseInt(h.itemsCount)<=0&&parseInt(h.hiddenCount)<=0){return false}if(c==1){this.popupContent.innerHTML="";var f=document.createElement("span");f.className="bx-contentview-bottom_scroll";this.popupContent.appendChild(f)}this.popupContentPage+=1;var e=null;for(var g=0;g<h.items.length;g++){if(a.util.in_array(h.items[g]["ID"],this.popupShownIdList)){continue}this.popupShownIdList.push(h.items[g]["ID"]);if(h.items[g]["PHOTO_SRC"].length>0){e=a.create("IMG",{attrs:{src:h.items[g]["PHOTO_SRC"]},props:{className:"bx-contentview-popup-avatar-img"}})}else{e=a.create("IMG",{attrs:{src:"/bitrix/images/main/blank.gif"},props:{className:"bx-contentview-popup-avatar-img bx-contentview-popup-avatar-img-default"}})}this.popupContent.appendChild(a.create("A",{attrs:{href:h.items[g]["URL"],target:"_blank",title:h.items[g]["DATE_VIEW_FORMATTED"]},props:{className:"bx-contentview-popup-img"+(!!h.items[g]["TYPE"]?" bx-contentview-popup-img-"+h.items[g]["TYPE"]:"")},children:[a.create("SPAN",{props:{className:"bx-contentview-popup-avatar-new"},children:[e,a.create("SPAN",{props:{className:"bx-contentview-popup-avatar-status-icon"}})]}),a.create("SPAN",{props:{className:"bx-contentview-popup-name-new"},html:h.items[g]["FULL_NAME"]})]}))}if(parseInt(h.hiddenCount)>0){a.cleanNode(this.hiddenCountNode,true);this.hiddenCountNode=a.create("SPAN",{props:{className:"bx-contentview-popup-name-new contentview-counter-hidden"},html:a.message("SONET_CONTENTVIEW_JS_HIDDEN_COUNT").replace("#CNT#",h.hiddenCount)});this.popupContent.appendChild(this.hiddenCountNode)}this.adjustWindow();this.popupScroll()},this),onfailure:function(e){}});return false};a.UserContentView.Counter.prototype.openPopup=function(){if(parseInt(this.node.innerHTML)==0){return false}if(this.popup==null){this.popup=new a.PopupWindow("contentview-popup-"+this.contentId,this.node,{lightShadow:true,offsetLeft:5,autoHide:true,closeByEsc:true,zIndex:2005,bindOptions:{position:"top"},events:{onPopupClose:function(){a.UserContentView.currentPopupId=null},onPopupDestroy:function(){}},content:a("bx-contentview-cnt-popup-cont-"+this.contentId),className:"popup-window-contentview"});a.UserContentView.popupList[this.contentId]=this.popup;this.popup.setAngle({});a.bind(a("contentview-popup-"+this.contentId),"mouseout",a.delegate(function(){clearTimeout(this.popupTimeout);this.popupTimeout=setTimeout(a.delegate(function(){this.popup.close()},this),1000)},this));a.bind(a("contentview-popup-"+this.contentId),"mouseover",a.delegate(function(){clearTimeout(this.popupTimeout)},this))}if(a.UserContentView.currentPopupId!=null){a.UserContentView.popupList[a.UserContentView.currentPopupId].close()}a.UserContentView.currentPopupId=this.contentId;this.popup.show();this.adjustWindow()};a.UserContentView.Counter.prototype.popupScroll=function(){a.bind(this.popupContent,"scroll",a.delegate(function(){var b=a.proxy_context;if(b.scrollTop>(b.scrollHeight-b.offsetHeight)/1.5){this.list({page:null});a.unbindAll(b)}},this))};a.UserContentView.Counter.prototype.adjustWindow=function(){if(this.popup!=null){this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();this.popup.bindOptions.forceBindPosition=false}};a.addCustomEvent(window,"BX.UserContentView.onInitCall",a.delegate(a.UserContentView.init,a.UserContentView));a.addCustomEvent(window,"BX.UserContentView.onRegisterViewAreaListCall",a.delegate(a.UserContentView.registerViewAreaList,a.UserContentView));a.addCustomEvent(window,"BX.UserContentView.onClearCall",a.delegate(a.UserContentView.clear,a.UserContentView));a.addCustomEvent("onPullEvent-contentview",function(c,b){if(c=="add"){a.UserContentView.liveUpdate(b)}})})();