(function(a){if(BX.Scale.Server){return}BX.Scale.Server=function(e,j){this.hostname=e;this.ip=j.ip;this.roles={};this.bxEnvVer=j.BX_ENV_VER||false;this.bxEnvNeedUpdate=j.BX_ENV_NEED_UPDATE||false;this.roles.SERVER=new BX.Scale.Role("SERVER",e,{noActions:this.bxEnvNeedUpdate});this.bxInfoError=j.BX_INFO_ERROR||false;this.mustChangeBitrixUsrPass=j.LAST_PASSWORD_CHANGE&&j.LAST_PASSWORD_CHANGE.search(/^password must be changed/)!=-1;if(j.roles!==undefined){for(var f in BX.Scale.rolesList){if(!BX.Scale.rolesList.hasOwnProperty(f)){continue}var c={};if(f!="SERVER"){if(!j.roles[f]||typeof j.roles[f]==="function"){c.type="norole";if(BX.Scale.rolesList[f].HIDE_NOROLE){continue}}else{if(j.roles[f].type){c.type=j.roles[f].type}}}c.noActions=this.bxEnvNeedUpdate&&this.mustChangeBitrixUsrPass;c.showMenu=!this.bxInfoError&&!this.bxEnvNeedUpdate;if(f=="web"&&j.roles.mgmt!==undefined){c.noActions=true}else{if(f=="mysql"){c.state=j.BX_INFO.mysql_service_status}}this.roles[f]=new BX.Scale.Role(f,e,c)}var g={};for(var h in this.roles){if(!this.roles.hasOwnProperty(h)){continue}var d=this.roles[h].getMonitoringCategories(e);for(var b in d){if(!d.hasOwnProperty(b)){continue}if(BX.Scale.monitoringCategories[e][b]&&this.roles[h].type!="norole"){g[b]=BX.Scale.monitoringCategories[e][b]}}}if(BX.Scale.monitoringEnabled&&BX.Scale.isMonitoringDbCreated[this.hostname]){this.infoTable=new BX.Scale.InfoTable(this.hostname,g)}}this.domObj=null;this.idPrefix=e;this.showDel=j.showDel===true};BX.Scale.Server.prototype.getRolesObj=function(){var b=document.createElement("div");BX.addClass(b,"adm-scale-cont-block");for(var d in this.roles){var c=this.roles[d].getDomObj();if(c){b.appendChild(c)}}return b};BX.Scale.Server.prototype.getMenuObj=function(){var b=document.createElement("span");BX.addClass(b,"adm-scale-menu-btn");b.innerHTML=BX.message("SCALE_PANEL_JS_MENU");BX.bind(b,"click",BX.proxy(this.actionsMenuOpen,this));return b};BX.Scale.Server.prototype.actionsMenuOpen=function(e){e=e||a.event;var b=e.target||e.srcElement;var d=[];var g=this.getAviableActionsList();for(var c in g){var f=BX.Scale.actionsCollection.getObject(c);if(f){d.push({TEXT:f.name,ONCLICK:"BX.Scale.actionsCollection.getObject('"+c+"').start('"+this.hostname+"');"})}}if(!b.OPENER){BX.adminShowMenu(b,d,{active_class:"bx-adm-scale-menu-butt-active"})}else{b.OPENER.SetMenu(d)}return BX.PreventDefault(e)};BX.Scale.Server.prototype.getHeaderObj=function(){var e=document.createElement("div"),g=this;BX.addClass(e,"adm-scale-block-header");if(!BX.Scale.isObjEmpty(this.getAviableActionsList())){e.appendChild(this.getMenuObj())}var d=document.createElement("span");BX.addClass(d,"adm-scale-title");var f="";if(this.bxEnvVer){if(this.bxEnvNeedUpdate){f=BX.message("SCALE_PANEL_JS_BX_ENV_VERSION")+" <span style='color: red;' title='"+BX.message("SCALE_PANEL_JS_BX_ENV_NEED_UPDATE")+"'>"+this.bxEnvVer+" ("+BX.message("SCALE_PANEL_JS_BX_ENV_NEED_UPDATE2")+")</span>"}else{f=BX.message("SCALE_PANEL_JS_BX_ENV_VERSION")+" <span>"+this.bxEnvVer+"</span>";d.title=BX.message("SCALE_JS_SERVER_TITLE_TITLE");BX.bind(d,"click",function(h){a.location.href=BX.Scale.AdminFrame.graphPageUrl+"&SERVER_HOSTNAME="+g.hostname})}}else{if(this.bxInfoError){f="<span style='color: red;' title='"+this.bxInfoError+"'>"+BX.message("SCALE_PANEL_JS_BX_INFO_ERROR")+"</span>"}else{f="<span style='color: red;'>"+BX.message("SCALE_PANEL_JS_BX_VER_ERROR")+"</span>"}}d.innerHTML=this.hostname+" / "+this.ip+" / "+f;e.appendChild(d);if(this.showDel){var b=document.createElement("span");BX.addClass(b,"adm-scale-block-del");e.appendChild(b)}var c=document.createElement("span");BX.addClass(c,"adm-scale-img");e.appendChild(c);return e};BX.Scale.Server.prototype.getDomObj=function(){if(!this.domObj){this.domObj=document.createElement("div");this.domObj.id=this.idPrefix;BX.addClass(this.domObj,"adm-scale-block");this.domObj.appendChild(this.getHeaderObj());this.domObj.appendChild(this.getRolesObj());if(this.infoTable){this.domObj.appendChild(this.infoTable.getDomObj())}else{if(BX.Scale.bitrixEnvType!="crm"){if(!BX.Scale.monitoringEnabled){this.domObj.appendChild(BX.create("DIV",{props:{className:"adm-scale-block-bottom"},html:BX.message("SCALE_PANEL_MONITORING_DISABLED")}))}else{if(!BX.Scale.isMonitoringDbCreated[this.hostname]){this.domObj.appendChild(BX.create("DIV",{props:{className:"adm-scale-block-bottom"},html:BX.message("SCALE_PANEL_JS_MONITORING_DATABASE_CREATING")}))}}}}}return this.domObj};BX.Scale.Server.prototype.getAviableActionsList=function(){var b={DEL_SERVER:true};if(this.bxInfoError){return b}if(!this.bxEnvNeedUpdate&&!this.mustChangeBitrixUsrPass){for(var c in this.roles){if(this.roles[c].type=="norole"){continue}if(BX.Scale.rolesList[c]){var g=BX.Scale.rolesList[c];for(var f in g.ACTIONS){if(g.ACTIONS[f]=="DEL_SERVER"){var e=0;for(var d in this.roles){if(d!="SERVER"&&this.roles[d].type!="norole"){e++}}if(e>0){delete b.DEL_SERVER;continue}}if(!b[g.ACTIONS[f]]){b[g.ACTIONS[f]]=true}}}else{BX.debug("Error! Role "+this.roles[c]+" not exist")}}}else{if(this.mustChangeBitrixUsrPass){b.CHANGE_PASSWD_BITRIX=true}else{if(this.bxEnvNeedUpdate){b.UPDATE_BVM=true}}}return b};BX.Scale.Server.prototype.getMonitoringParams=function(){var b={};if(this.infoTable){b=this.infoTable.getStructure()}return b};BX.Scale.Server.prototype.setMonitoringValues=function(c){var b=false;if(this.infoTable){b=this.infoTable.setValues(c)}return b}})(window);