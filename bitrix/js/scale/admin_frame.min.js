(function(a){if(BX.Scale.AdminFrame){return}BX.Scale.AdminFrame={frameObjectName:"",srvFrameObjectName:"",currentAsyncActionBID:"",timeAsyncRefresh:20000,timeIntervalId:"",graphPageUrl:"",failureAnswersCount:0,failureAnswersCountAllow:50,nextActionId:null,init:function(c){for(var b in c){this[b]=c[b]}},build:function(){var b=BX(this.frameObjectName);if(!b){return false}this.showActions();this.showServers();return true},showServers:function(){var c=BX(this.srvFrameObjectName),e=BX.Scale.serversCollection.getObjectsList(),d=c.children[0];if(c){for(var b in e){c.insertBefore(e[b].getDomObj(),d)}}},isObjectEmpty:function(c){for(var b in c){return false}return true},showActions:function(){var b=BX(this.frameObjectName);if(!b){return false}if(!this.isObjectEmpty(BX.Scale.serversCollection.getObjectsList())){b.insertBefore(this.getMenuObj(),b.children[0])}},refreshingDataStart:function(b){BX.Scale.AdminFrame.refreshingDataIntervalId=setInterval(function(){BX.Scale.AdminFrame.refreshServersRolesLoadbars()},b)},setMonitoringValues:function(e){for(var b in e){var d=BX.Scale.serversCollection.getObject(b);if(e[b].ROLES_LOADBARS){for(var c in e[b].ROLES_LOADBARS){if(d&&d.roles&&d.roles[c]){d.roles[c].setLoadBarValue(e[b].ROLES_LOADBARS[c])}}}if(e[b].MONITORING_VALUES){d.setMonitoringValues(e[b].MONITORING_VALUES)}}},refreshServersRolesLoadbars:function(){if(!BX.Scale.AdminFrame.monitoringParams){BX.Scale.AdminFrame.monitoringParams={};var f=BX.Scale.serversCollection.getObjectsList();for(var e in f){if(!BX.Scale.isMonitoringDbCreated[e]){continue}BX.Scale.AdminFrame.monitoringParams[e]={rolesIds:[],monitoringParams:f[e].getMonitoringParams()};for(var b in f[e].roles){if(f[e].roles[b].loadBar!==null){BX.Scale.AdminFrame.monitoringParams[e].rolesIds.push(b)}}}}if(BX.Scale.isObjEmpty(BX.Scale.AdminFrame.monitoringParams)){return}var c={operation:"get_monitoring_values",servers:BX.Scale.AdminFrame.monitoringParams};var d={onsuccess:function(g){if(g){if(g.MONITORING_DATA){BX.Scale.AdminFrame.setMonitoringValues(g.MONITORING_DATA)}if(g.ERROR&&g.ERROR.length>0){BX.debug("Monitoring data error: "+g.ERROR)}}else{BX.debug("Monitoring receiving data error.")}},onfailure:function(){BX.debug("Monitoring receiving data failure.")}};BX.Scale.Communicator.sendRequest(c,d,this,false)},getMenuObj:function(){var b=document.createElement("span");BX.addClass(b,"adm-scale-menu-btn");b.innerHTML=BX.message("SCALE_PANEL_JS_GLOBAL_ACTIONS");BX.bind(b,"click",BX.proxy(this.actionsMenuOpen,this));return BX.create("div",{children:[b],style:{padding:"0 0 40px 0"}})},actionsMenuOpen:function(b){b=b||a.event;var j=b.target||b.srcElement,c=[],d=[],g={MONITORING_ENABLE:true,MONITORING_DISABLE:true,SITE_CREATE:true,SITE_DEL:true,SET_EMAIL_SETTINGS:true,CRON_SET:true,CRON_UNSET:true,HTTP_OFF:true,HTTP_ON:true,CERTIFICATES:true,UPDATE_ALL_BVMS:true,UPDATE_ALL_SYSTEMS:true},m;for(var k in g){if(!g.hasOwnProperty(k)){continue}var h=BX.Scale.actionsCollection.getObject(k);if(h){if(k=="SET_EMAIL_SETTINGS"){d=[];for(m in BX.Scale.sitesList){if(!BX.Scale.sitesList.hasOwnProperty(m)){continue}d.push({TEXT:BX.Scale.sitesList[m].NAME,ONCLICK:"BX.Scale.actionsCollection.getObject('"+k+"').start('',{SITE_NAME_CONF: '"+BX.Scale.sitesList[m].SiteName+"', SITE_NAME: '"+BX.Scale.sitesList[m].NAME+"',SMTP_HOST: BX.Scale.sitesList['"+m+"'].SMTPHost,SMTP_PORT: BX.Scale.sitesList['"+m+"'].SMTPPort,SMTP_USER: BX.Scale.sitesList['"+m+"'].SMTPUser,EMAIL: BX.Scale.sitesList['"+m+"'].EmailAddress,SMTPTLS: (BX.Scale.sitesList['"+m+"'].SMTPTLS == 'on' ? 'Y' : 'N'), USER_PASSWORD: BX.Scale.sitesList['"+m+"'].SMTPPassword, USE_AUTH: (BX.Scale.sitesList['"+m+"'].SMTP_USE_AUTH == 'Y' ? 'Y' : 'N')});"})}c.push({TEXT:h.name,MENU:d})}else{if(k=="CERTIFICATES"){var f=[];for(m in BX.Scale.sitesList){if(!BX.Scale.sitesList.hasOwnProperty(m)){continue}var i=BX.Scale.sitesList[m].EMAIL?BX.Scale.sitesList[m].EMAIL:"",l=BX.Scale.sitesList[m].DOMAINS?BX.Scale.sitesList[m].DOMAINS:"";f.push({TEXT:BX.Scale.sitesList[m].NAME,ONCLICK:"BX.Scale.actionsCollection.getObject('CERTIFICATE_LETS_ENCRYPT_CONF').start('',{SITE_NAME_CONF: '"+BX.Scale.sitesList[m].SiteName+"', SITE_NAME: '"+BX.Scale.sitesList[m].NAME+"', EMAIL: '"+i+"', DNS: '"+l+"'});"})}var e=[];for(m in BX.Scale.sitesList){if(!BX.Scale.sitesList.hasOwnProperty(m)){continue}e.push({TEXT:BX.Scale.sitesList[m].NAME,ONCLICK:"BX.Scale.actionsCollection.getObject('CERTIFICATE_SELF_CONF').start('',{SITE_NAME_CONF: '"+BX.Scale.sitesList[m].SiteName+"', SITE_NAME: '"+BX.Scale.sitesList[m].NAME+"', PRIVATE_KEY_PATH: '"+BX.Scale.sitesList[m].HTTPSPriv+"', CERTIFICATE_PATH: '"+BX.Scale.sitesList[m].HTTPSCert+"', CERTIFICATE_CHAIN_PATH: '"+BX.Scale.sitesList[m].HTTPSCertChain+"'});"})}d=[{TEXT:BX.Scale.actionsCollection.getObject("CERTIFICATE_LETS_ENCRYPT_CONF").name,MENU:f},{TEXT:BX.Scale.actionsCollection.getObject("CERTIFICATE_SELF_CONF").name,MENU:e}];c.push({TEXT:h.name,MENU:d})}else{if(k=="CRON_SET"||k=="CRON_UNSET"){d=[];for(m in BX.Scale.sitesList){if((BX.Scale.sitesList[m].CronTask=="enable"&&k=="CRON_UNSET")||(BX.Scale.sitesList[m].CronTask!="enable"&&k=="CRON_SET")){d.push({TEXT:BX.Scale.sitesList[m].NAME,ONCLICK:"BX.Scale.actionsCollection.getObject('"+k+"').start('',{VM_SITE_ID: '"+m+"'});"})}}if(d.length>0){c.push({TEXT:h.name,MENU:d})}}else{if(k=="HTTP_OFF"||k=="HTTP_ON"){d=[];for(m in BX.Scale.sitesList){if((BX.Scale.sitesList[m].HTTPS=="enable"&&k=="HTTP_ON")||(BX.Scale.sitesList[m].HTTPS!="enable"&&k=="HTTP_OFF")){d.push({TEXT:BX.Scale.sitesList[m].NAME,ONCLICK:"BX.Scale.actionsCollection.getObject('"+k+"').start('',{VM_SITE_ID: '"+m+"'});"})}}if(d.length>0){c.push({TEXT:h.name,MENU:d})}}else{if(k=="SITE_CREATE"){c.push({TEXT:h.name,MENU:[{TEXT:BX.Scale.actionsCollection.getObject("SITE_CREATE_LINK").name,ONCLICK:"BX.Scale.actionsCollection.getObject('SITE_CREATE_LINK').start();"},{TEXT:BX.Scale.actionsCollection.getObject("SITE_CREATE_KERNEL").name,ONCLICK:"BX.Scale.actionsCollection.getObject('SITE_CREATE_KERNEL').start();"}]})}else{if(k=="SITE_DEL"){d=[];for(m in BX.Scale.sitesList){d.push({TEXT:BX.Scale.sitesList[m].NAME,ONCLICK:"BX.Scale.actionsCollection.getObject('"+k+"').start('',{VM_SITE_ID: '"+m+"'})"})}c.push({TEXT:h.name,MENU:d})}else{c.push({TEXT:h.name,ONCLICK:"BX.Scale.actionsCollection.getObject('"+k+"').start();"})}}}}}}}}if(!j.OPENER){BX.adminShowMenu(j,c,{active_class:"bx-adm-scale-menu-butt-active"})}else{j.OPENER.SetMenu(c)}return BX.PreventDefault(b)},getNewServerName:function(b){if(!b){b=1}var c="server"+b;var d=BX.Scale.serversCollection.getObject(c);if(d!==false){b++;c=this.getNewServerName(b)}return c},alert:function(c,b,e){var d={title:BX.message("SCALE_PANEL_JS_CLOSE"),id:"btnClose",name:"btnClose",action:function(){this.parentWindow.Close();if(e&&typeof e==="function"){e.apply()}}};this.dialogWindow=new BX.CDialog({title:b?b:"",content:c,resizable:false,height:200,width:400,buttons:[d]});this.dialogWindow.adjustSizeEx();this.dialogWindow.Show()},confirm:function(f,e,b,g){var c={title:"OK",id:"btnOk",name:"btnOk",className:"adm-btn-save",action:function(){this.parentWindow.Close();if(b&&typeof b==="function"){b.apply()}}};var d={title:BX.message("SCALE_PANEL_JS_CANCEL"),id:"btnCancel",name:"btnCancel",action:function(){this.parentWindow.Close();if(g&&typeof g==="function"){g.apply()}}};this.dialogWindow=new BX.CDialog({title:e?e:"",content:'<div style="margin-top: 9px;">'+f+"</div>",resizable:false,height:200,width:400,buttons:[c,d]});this.dialogWindow.adjustSizeEx();this.dialogWindow.Show()},waitForAction:function(b){if(!b){return false}this.dialogWindow=new BX.CDialog({title:BX.message("SCALE_PANEL_JS_WFA_TITLE"),content:BX.message("SCALE_PANEL_JS_WFA_TEXT").replace("##BID##",b)+"<div class='bx-adm-scale-wait'></div>",resizable:false,height:200,width:400});this.dialogWindow.adjustSizeEx();this.dialogWindow.Show();this.failureAnswersCount=0;var c={operation:"check_state",bid:b};var d={onsuccess:function(f){this.failureAnswersCount=0;if(f.ACTION_STATE.status!="running"){a.location.reload(true)}},onfailure:function(f,g){BX.debug({type:f,error:g});if(this.failureAnswersCountAllow>=this.failureAnswersCount){this.failureAnswersCount++}else{a.location.reload(true)}}};var e=this;setInterval(function(){BX.Scale.Communicator.sendRequest(c,d,e,false)},e.timeAsyncRefresh);return true},waitForPageRefreshing:function(){var b=new BX.CDialog({title:BX.message("SCALE_PANEL_JS_REFRESH_TITLE"),content:'<div style="margin-top: 9px;">'+BX.message("SCALE_PANEL_JS_REFRESH_TEXT")+"</div>",resizable:false,height:200,width:400});b.adjustSizeEx();b.Show()}}})(window);