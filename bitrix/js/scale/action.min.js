(function(a){if(BX.Scale.Action){return}BX.Scale.Action=function(c,b){this.id=c;this.name=b.NAME;this.userParams=b.USER_PARAMS;this.freeParams={};if(b&&b.TYPE!==undefined){this.type=b.TYPE}else{this.type="ACTION"}if(this.type=="CHAIN"&&b.ACTIONS!==undefined){this.actions=b.ACTIONS}else{if(this.type=="MODIFYED"){this.allParams=b}}this.currentOperation="";this.paramsDialog=null;this.async=b.ASYNC=="Y";this.pageRefresh=b.PAGE_REFRESH=="Y";this.backupAlert=b.BACKUP_ALERT=="Y";this.timeToComplete=null;this.timeToCompleteInterval=null;this.extraDbConfirm=b.CHECK_EXTRA_DB_USER_ASK=="Y";this.skipConfirmation=false};BX.Scale.Action.prototype.getUserParams=function(){var b={};if(this.type=="CHAIN"){b=this.extractUserParamsFromActions()}else{b=this.userParams}return b};BX.Scale.Action.prototype.extractUserParamsFromActions=function(){var b={};for(var e in this.actions){var c=BX.Scale.actionsCollection.getObject(this.actions[e]).getUserParams();for(var d in c){b[d]=c[d]}}return b};BX.Scale.Action.prototype.start=function(h,d,f){var g=this;if(this.backupAlert&&!f){BX.Scale.AdminFrame.confirm(BX.message("SCALE_PANEL_JS_ADVICE_TO_BACKUP"),BX.message("SCALE_PANEL_JS_ADVICE_TO_BACKUP_TITLE"),function(){a.location.href="/bitrix/admin/dump.php?lang="+BX.message("LANGUAGE_ID")},function(){g.start(h,d,true)});return}if(this.extraDbConfirm){BX.Scale.AdminFrame.confirm(BX.message("SCALE_PANEL_JS_EXTRA_DB_CONFIRM"),BX.message("SCALE_PANEL_JS_EXTRA_DB_CONFIRM_TITLE"),function(){g.extraDbConfirm=false;g.skipConfirmation=true;g.start(h,d,true)});return}var b=this.getUserParams();var e={};this.currentOperation="start";if(d!==undefined){for(var c in d){if(b&&b[c]!==undefined){b[c].DEFAULT_VALUE=d[c]}else{this.freeParams[c]=d[c]}}}if(b!==undefined){this.paramsDialog=new BX.Scale.ActionParamsDialog({title:this.name,userParams:b,serverHostname:h,callback:this.sendRequest,context:this});this.paramsDialog.show()}else{if(!this.skipConfirmation){BX.Scale.AdminFrame.confirm(BX.message("SCALE_PANEL_JS_ACT_CONFIRM")+" "+this.name.toLowerCase()+"?",BX.message("SCALE_PANEL_JS_ACT_CONFIRM_TITLE"),BX.proxy(function(){this.sendRequest({serverHostname:h,freeParams:e})},this))}else{if(this.skipConfirmation){this.skipConfirmation=false;this.sendRequest({serverHostname:h,freeParams:e})}}}};BX.Scale.Action.prototype.showResultDialog=function(b){var c=new BX.Scale.ActionResultDialog({actionName:this.name,result:b,pageRefresh:this.pageRefresh});c.show()};BX.Scale.Action.prototype.showAsyncDialog=function(b){BX.Scale.ActionProcessDialog.addActionProcess(this.name);BX.Scale.AdminFrame.timeIntervalId=setInterval(BX.proxy(this.checkAsyncState,this),BX.Scale.AdminFrame.timeAsyncRefresh);if(b.ACTION_RESULT&&b.ACTION_RESULT[this.id]&&b.ACTION_RESULT[this.id].OUTPUT&&b.ACTION_RESULT[this.id].OUTPUT.DATA){if(b.ACTION_RESULT[this.id].OUTPUT.DATA.message){BX.Scale.ActionProcessDialog.addActionMessage(b.ACTION_RESULT[this.id].OUTPUT.DATA.message)}if(b.ACTION_RESULT[this.id].OUTPUT.DATA.params){if(b.ACTION_RESULT[this.id].OUTPUT.DATA.params.task_name){BX.Scale.AdminFrame.currentAsyncActionBID=b.ACTION_RESULT[this.id].OUTPUT.DATA.params.task_name}else{for(var c in b.ACTION_RESULT[this.id].OUTPUT.DATA.params){BX.Scale.AdminFrame.currentAsyncActionBID=c;break}}}}BX.Scale.ActionProcessDialog.pageRefresh=this.pageRefresh;BX.Scale.ActionProcessDialog.show();if(BX.Scale.AdminFrame.currentAsyncActionBID.length<=0){var d;if(b.ACTION_RESULT[this.id].ERROR.length>0){d=b.ACTION_RESULT[this.id].ERROR}else{if(b.ACTION_RESULT[this.id].OUTPUT&&b.ACTION_RESULT[this.id].OUTPUT.TEXT){d=b.ACTION_RESULT[this.id].OUTPUT.TEXT}else{d=BX.message("SCALE_PANEL_JS_BID_ERROR")}}BX.Scale.ActionProcessDialog.setActionResult(false,d)}};BX.Scale.Action.prototype.checkAsyncState=function(){if(BX.Scale.AdminFrame.currentAsyncActionBID.length<=0){return false}var b={operation:"check_state",bid:BX.Scale.AdminFrame.currentAsyncActionBID};var c={onsuccess:function(d){if(this.timeToCompleteInterval!==null){BX.Scale.AdminFrame.failureAnswersCount=0;clearInterval(this.timeToCompleteInterval);this.timeToComplete=null;BX.Scale.ActionProcessDialog.addActionMessage("",true)}if(d){BX.Scale.AdminFrame.failureAnswersCount=0;if(d.ERROR.length<=0&&d.ACTION_STATE&&d.ACTION_STATE.status){if(d.ACTION_STATE.status=="finished"){clearInterval(BX.Scale.AdminFrame.timeIntervalId);BX.Scale.ActionProcessDialog.setActionResult(true,BX.message("SCALE_PANEL_JS_ACT_EXEC_SUCCESS"));BX.Scale.AdminFrame.currentAsyncActionBID=""}else{if(d.ACTION_STATE.status=="error"){clearInterval(BX.Scale.AdminFrame.timeIntervalId);var f="";if(d.ACTION_STATE.error_messages){for(var e in d.ACTION_STATE.error_messages){f+=d.ACTION_STATE.error_messages[e]+"<br>"}}BX.Scale.ActionProcessDialog.setActionResult(false,f);BX.Scale.AdminFrame.currentAsyncActionBID=""}else{if(d.ACTION_STATE.status=="interrupt"){clearInterval(BX.Scale.AdminFrame.timeIntervalId);BX.Scale.ActionProcessDialog.setActionResult(false,BX.message("SCALE_PANEL_JS_ACT_EXEC_INTERRUPTED"));BX.Scale.AdminFrame.currentAsyncActionBID=""}else{if(d.ACTION_STATE.status=="running"&&d.ACTION_STATE.last_action&&d.ACTION_STATE.last_action.length>0){BX.Scale.ActionProcessDialog.addActionMessage("last operation:<br>"+d.ACTION_STATE.last_action,true)}}}}}else{if(!d.ACTION_STATE||d.ACTION_STATE.status){clearInterval(BX.Scale.AdminFrame.timeIntervalId);BX.Scale.ActionProcessDialog.setActionResult(false)}else{clearInterval(BX.Scale.AdminFrame.timeIntervalId);BX.Scale.ActionProcessDialog.setActionResult(false,BX.message("SCALE_PANEL_JS_ERROR")+" "+d.ERROR)}}}else{if(BX.Scale.AdminFrame.failureAnswersCountAllow>=BX.Scale.AdminFrame.failureAnswersCount){BX.Scale.AdminFrame.failureAnswersCount++;return}clearInterval(BX.Scale.AdminFrame.timeIntervalId);BX.Scale.ActionProcessDialog.setActionResult(false,BX.message("SCALE_PANEL_JS_ACT_EXEC_ERROR"))}},onfailure:function(g,h){var f=new Date();if(g=="processing"&&h.data&&h.data.search("SCALE_SERVER_NOT_AVAILABLE")!=-1&&(this.timeToComplete===null||f.getTime()>this.timeToComplete)){var i=this;var d=this.extractTimeToComplete(h.data);if(this.timeToComplete<d){this.timeToComplete=d}this.timeToCompleteInterval=a.setInterval(function(){var e=i.makeTimeToCompleteString(i.timeToComplete);if(e){BX.Scale.ActionProcessDialog.addActionMessage(e,true)}},1000);return}if(BX.Scale.AdminFrame.failureAnswersCountAllow>=BX.Scale.AdminFrame.failureAnswersCount){BX.Scale.AdminFrame.failureAnswersCount++;return}clearInterval(BX.Scale.AdminFrame.timeIntervalId);BX.Scale.ActionProcessDialog.setActionResult(false,BX.message("SCALE_PANEL_JS_ACT_RES_ERROR"))}};BX.Scale.Communicator.sendRequest(b,c,this,false);return true};BX.Scale.Action.prototype.sendRequest=function(d){var b={actionId:this.id,serverHostname:d.serverHostname,operation:this.currentOperation},e=this;if(d.userParams!==undefined){b.userParams=d.userParams}if(this.freeParams){b.freeParams=this.freeParams}if(this.type=="MODIFYED"){b.actionParams=this.allParams}var c={onsuccess:function(f){if(f){if(f.NEED_MORE_USER_INFO){this.startModifyed(f.NEED_MORE_USER_INFO);return}if(f.ERROR.length<=0){if(this.async){e.showAsyncDialog(f)}else{if(f.ACTION_RESULT&&f.ACTION_RESULT.COPY_KEY_TO_SERVER&&f.ACTION_RESULT.COPY_KEY_TO_SERVER.RESULT=="ERROR"&&f.ACTION_RESULT.COPY_KEY_TO_SERVER.OUTPUT.DATA.message.search(/^User must change password/)!=-1){BX.Scale.AdminFrame.alert(BX.message("SCALE_PANEL_JS_PASS_MUST_BE_CHANGED"),BX.message("SCALE_PANEL_JS_WARNING"),function(){BX.Scale.actionsCollection.getObject("CHANGE_PASSWD_FIRST").start(b.serverHostname,b.userParams);BX.Scale.AdminFrame.nextActionId="NEW_SERVER_CHAIN"})}else{if(BX.Scale.AdminFrame.nextActionId!=this.id&&BX.Scale.AdminFrame.nextActionId!==null&&BX.Scale.actionsCollection.getObject(BX.Scale.AdminFrame.nextActionId)){BX.Scale.actionsCollection.getObject(BX.Scale.AdminFrame.nextActionId).start(b.serverHostname,b.userParams);BX.Scale.AdminFrame.nextActionId=null}e.showResultDialog(f)}}}else{BX.Scale.AdminFrame.alert(f.ERROR,BX.message("SCALE_PANEL_JS_ERROR"))}}else{BX.Scale.AdminFrame.alert(BX.message("SCALE_PANEL_JS_ACT_EXEC_ERROR"),BX.message("SCALE_PANEL_JS_ERROR"))}},onfailure:function(){BX.Scale.AdminFrame.alert(BX.message("SCALE_PANEL_JS_ACT_RES_ERROR"),BX.message("SCALE_PANEL_JS_ERROR"))}};BX.Scale.Communicator.sendRequest(b,c,this,true)};BX.Scale.Action.prototype.extractTimeToComplete=function(g){if(!g||typeof g!="string"){return false}var f=new Date(),d=g.match(/availableDateTime\s=\s(\d+)/im)[1],c=g.match(/serverNow\s=\s(\d+)/im)[1],b=d-c,e=f.getTime()+b;if(f>e){e.setTime(f.getTime()+b)}return e};BX.Scale.Action.prototype.makeTimeToCompleteString=function(e){var d=new Date();if(d>e){return false}var c=e-d,b=Math.floor(c/3600000),f=Math.floor(c/60000)-b*60,g=Math.floor(c/1000)-b*3600-f*60;b=(b<10)?"0"+b:b;f=(f<10)?"0"+f:f;g=(g<10)?"0"+g:g;return BX.message("SCALE_PANEL_JS_ACT_SERVER_WILL_AVAILABLE")+"<br>"+b+" "+BX.message("SCALE_PANEL_JS_ACT_HOUR")+". "+f+" "+BX.message("SCALE_PANEL_JS_ACT_MIN")+". "+g+" "+BX.message("SCALE_PANEL_JS_ACT_SEC")+"."};BX.Scale.Action.prototype.startModifyed=function(d){delete (d.ACTION_PARAMS.MODIFYERS);d.ACTION_PARAMS.TYPE="MODIFYED";var c=BX.Scale.actionsCollection.addObject(d.ACTION_ID+"_MODIF",d.ACTION_PARAMS);var b=d.HOSTNAME||false;c.start(b,{},true)}})(window);