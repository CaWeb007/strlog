BX.namespace("BX.Sale.Admin.OrderBuyer");BX.Sale.Admin.OrderBuyer={propertyCollection:null,savedPropsCollections:{},profilesData:null,oldBuyerId:0,isFeatureSaleAccountsEnabled:false,getFieldsUpdaters:function(){return{BUYER_USER_NAME:BX.Sale.Admin.OrderBuyer.setBuyerName,BUYER_PROFILES_LIST:BX.Sale.Admin.OrderBuyer.setBuyerProfilesList,PROPERTIES_ARRAY:BX.Sale.Admin.OrderBuyer.setOrderPropsArray,PROPERTIES:BX.Sale.Admin.OrderBuyer.setOrderProps,BUYER_PROFILES_DATA:BX.Sale.Admin.OrderBuyer.setProfilesData}},setProfilesData:function(a){BX.Sale.Admin.OrderBuyer.profilesData=a;BX.Sale.Admin.OrderBuyer.onBuyerProfileChange()},setBuyerName:function(a){var d=BX("BUYER_USER_NAME"),b=BX("sale-order-buyer-find-button-wrap"),c=BX("sale-order-buyer-name-wrap");if(d){d.innerHTML=BX.util.htmlspecialchars(a)}if(a){b.style.display="none";c.style.display=""}else{b.style.display="";c.style.display="none"}},setBuyerProfilesList:function(g){var f=BX("BUYER_PROFILE_ID"),e=0;if(!f){var b=BX("BUYER_PROFILE_ID_CONTAINER");f=BX.create("select",{props:{name:"BUYER_PROFILE_ID",id:"BUYER_PROFILE_ID"}});BX.bind(f,"change",BX.Sale.Admin.OrderBuyer.onBuyerProfileChange);b.appendChild(f)}if(f.length>0){for(var c=0,a=f.length;c<a;c++){f.remove(f[c])}}if(!g){f.add(BX.create("option",{props:{value:"",text:BX.message("SALE_ORDER_BUYER_CREATE_NEW")}}));return}for(var d in g){if(!g.hasOwnProperty(d)){continue}f.add(BX.create("option",{props:{value:d,text:g[d]}}));if(d>0&&e==0){e=d}}BX.Sale.Admin.OrderBuyer.setBuyerProfileId(e);BX.Sale.Admin.OrderBuyer.showBuyerProfilesList()},setBuyerProfileId:function(b){var a=BX("BUYER_PROFILE_ID");if(a){a.value=b}},showBuyerProfilesList:function(){var a=BX("sale-order-buyer-profiles-list-row");if(a){a.style.display=""}},hideBuyerProfilesList:function(){var a=BX("sale-order-buyer-profiles-list-row");if(a){a.style.display="none"}},setOrderProps:function(c){for(var a in c){if(!c.hasOwnProperty(a)){continue}var b=BX.Sale.Admin.OrderBuyer.propertyCollection.getById(a);if(b){b.setValue(c[a])}}BX.Sale.Admin.OrderBuyer.callPropertiesUpdaters()},showChooseBuyerWindow:function(a){window.open("/bitrix/admin/user_search.php?lang="+a+"&FN="+BX.Sale.Admin.OrderEditPage.formId+"&FC=USER_ID","","scrollbars=yes,resizable=yes,width=840,height=500,top="+Math.floor((screen.height-840)/2-14)+",left="+Math.floor((screen.width-760)/2-5))},clearBuyer:function(){BX.Sale.Admin.OrderBuyer.setBuyerName("");BX.Sale.Admin.OrderBuyer.setBuyerId(0);BX.Sale.Admin.OrderBuyer.hideBuyerProfilesList();BX.Sale.Admin.OrderBuyer.setBuyerProfilesList(false);BX.Sale.Admin.OrderBuyer.onBuyerIdChange(BX("USER_ID"))},onBuyerIdChange:function(a){BX.Sale.Admin.OrderBuyer.updateBuyerProfileLink(a.value);BX("OLD_USER_ID").value=BX.Sale.Admin.OrderBuyer.oldBuyerId;BX.Sale.Admin.OrderBuyer.oldBuyerId=a.value;BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.getOrderFields({givenFields:{USER_ID:a.value,PERSON_TYPE_ID:this.getBuyerTypeId(),CURRENCY:BX.Sale.Admin.OrderEditPage.currency,ORDER_ID:BX.Sale.Admin.OrderEditPage.orderId,SITE_ID:BX.Sale.Admin.OrderEditPage.siteId,BUYER_ID_CHANGED:"Y"},demandFields:["BUYER_PROFILES_LIST","BUYER_PROFILES_DATA","BUYER_USER_NAME","BUYER_BUDGET","PROPERTIES"]}),false,true)},onBuyerTypeChange:function(b){var a=["BUYER_PROFILES_LIST","BUYER_PROFILES_DATA"];if(!BX.Sale.Admin.OrderBuyer.savedPropsCollections[b]){a.push("PROPERTIES_ARRAY")}else{BX.Sale.Admin.OrderBuyer.setOrderPropsArray()}BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({demandFields:a,operation:"BUYER_CHANGED",givenFields:{USER_ID:this.getBuyerId(),PERSON_TYPE_ID:b,SITE_ID:BX.Sale.Admin.OrderEditPage.siteId}}))},onBuyerProfileChange:function(){var c=BX.Sale.Admin.OrderBuyer.getBuyerProfileId(),a=BX.Sale.Admin.OrderBuyer.getBuyerTypeId(),b=BX.Sale.Admin.OrderBuyer.profilesData;if(b&&b[a]&&b[a][c]){BX.Sale.Admin.OrderBuyer.setOrderProps(b[a][c]);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"BUYER_PROFILE_CHANGED"}))}else{if(c!=0){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.getOrderFields({givenFields:{USER_ID:this.getBuyerId(),BUYER_PROFILE_ID:this.getBuyerProfileId()},demandFields:["PROPERTIES"]}),true)}}},getBuyerProfileId:function(){return BX.Sale.Admin.OrderEditPage.getElementValue("BUYER_PROFILE_ID")},getBuyerTypeId:function(){return BX.Sale.Admin.OrderEditPage.getElementValue("PERSON_TYPE_ID")},getBuyerId:function(){return BX.Sale.Admin.OrderEditPage.getElementValue("USER_ID")},setBuyerId:function(a){BX("USER_ID").value=a;BX.Sale.Admin.OrderBuyer.updateBuyerProfileLink(a)},updateBuyerProfileLink:function(a){if(BX.Sale.Admin.OrderBuyer.isFeatureSaleAccountsEnabled){BX("BUYER_USER_NAME").href="/bitrix/admin/sale_buyers_profile.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&USER_ID="+a}else{BX("BUYER_USER_NAME").href="/bitrix/admin/user_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&ID="+a}},setOrderPropsArray:function(e){var c=BX.Sale.Admin.OrderBuyer.getBuyerTypeId();if(!BX.Sale.Admin.OrderBuyer.savedPropsCollections[c]){BX.Sale.Admin.OrderBuyer.savedPropsCollections[c]=new BX.Sale.PropertyCollection(e)}BX.Sale.Admin.OrderBuyer.propertyCollection=BX.Sale.Admin.OrderBuyer.savedPropsCollections[c];if(!BX.Sale.Admin.OrderBuyer.propertyCollection){BX.debug("Error! Can't initialize property collection!");return}BX.Sale.Admin.OrderBuyer.callPropertiesUpdaters();var h,r,k,b;if(h=BX.Sale.Admin.OrderBuyer.propertyCollection.getUserEmail()){h.addEvent("change",function(i){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_EMAIL",h.getValue())})}if(r=BX.Sale.Admin.OrderBuyer.propertyCollection.getPhone()){r.addEvent("change",function(i){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_PHONE",r.getValue())})}if(k=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation()){k.addEvent("change",function(i){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("LOCATION",k.getValue())})}if(b=BX.Sale.Admin.OrderBuyer.propertyCollection.getPayerName()){b.addEvent("change",function(i){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_FIO",b.getValue())})}var n=BX("order_properties_container"),m,j,u=BX.Sale.Admin.OrderBuyer.propertyCollection.getGroupIterator();for(var p=0,o=n.children.length;p<o;p++){n.removeChild(n.children[0])}while(m=u()){var v=m.getName()?BX.util.htmlspecialchars(m.getName()):BX.message("SALE_ORDER_BUYER_UNKNOWN_GROUP"),d=BX.create("DIV",{props:{className:"adm-bus-table-container caption border sale-order-props-group"}}),s=BX.create("DIV",{props:{className:"adm-bus-table-caption-title"},html:v}),q=BX.create("TABLE",{props:{className:"adm-detail-content-table edit-table"}}),t=m.getIterator();q.border=0;q.cellspacing=0;q.cellpadding=0;q.width="100%";while(j=t()){var a=BX.create("tr"),f=BX.create("td",{props:{className:"adm-detail-content-cell-l"},html:BX.util.htmlspecialchars(j.getName())+":"}),g=BX.create("td",{props:{className:"adm-detail-content-cell-r"}});f.style.verticalAlign="top";f.style.paddingTop="0.8em";if(j.isRequired()){BX.addClass(f,"fwb")}f.width="40%";j.appendTo(g);a.appendChild(f);a.appendChild(g);q.appendChild(a)}d.appendChild(s);d.appendChild(q);n.appendChild(d)}},setOrderRelPropsArray:function(o){var d=BX.Sale.Admin.OrderBuyer.getBuyerTypeId();BX.Sale.Admin.OrderBuyer.savedPropsCollections[d+"_rel"]=new BX.Sale.PropertyCollection(o);BX.Sale.Admin.OrderBuyer.propertyLocCollection=BX.Sale.Admin.OrderBuyer.savedPropsCollections[d+"_rel"];if(!BX.Sale.Admin.OrderBuyer.propertyLocCollection){BX.debug("Error! Can't initialize property collection!");return}var b=BX("order_properties_container_add"),q,r,e=BX.Sale.Admin.OrderBuyer.propertyLocCollection.getGroupIterator();for(var h=0,g=b.children.length;h<g;h++){b.removeChild(b.children[0])}var p=BX.findParent(b,{attr:"data-id"},true);var a=BX("nav_relprops").parentNode;if(o.properties.length>0){BX.show(p);BX.style(a,"display","inline-block")}else{BX.hide(p);BX.hide(a)}while(q=e()){var m=BX.create("DIV",{props:{className:"adm-bus-table-container caption border sale-order-props-group"}}),k=BX.create("DIV",{props:{className:"adm-bus-table-caption-title"},html:BX.util.htmlspecialchars(q.getName())}),s=BX.create("TABLE",{props:{className:"adm-detail-content-table edit-table"}}),j=q.getIterator();s.border=0;s.cellspacing=0;s.cellpadding=0;s.width="100%";while(r=j()){var n=BX.create("tr"),f=BX.create("td",{props:{className:"adm-detail-content-cell-l"},html:BX.util.htmlspecialchars(r.getName())+":"}),c=BX.create("td",{props:{className:"adm-detail-content-cell-r"}});if(r.isRequired()){BX.addClass(f,"fwb")}f.width="40%";r.appendTo(c);n.appendChild(f);n.appendChild(c);s.appendChild(n)}m.appendChild(k);m.appendChild(s);b.appendChild(m)}},callPropertiesUpdaters:function(){var a;if(a=BX.Sale.Admin.OrderBuyer.propertyCollection.getPhone()){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_PHONE",a.getValue())}if(a=BX.Sale.Admin.OrderBuyer.propertyCollection.getUserEmail()){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_EMAIL",a.getValue())}if(a=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation()){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("LOCATION",a.getValue())}if(a=BX.Sale.Admin.OrderBuyer.propertyCollection.getPayerName()){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater("BUYER_FIO",a.getValue())}}};