BX.namespace("BX.Sale.Admin.OrderShipment");BX.Sale.Admin.OrderShipment=function(b){this.index=b.index;this.id=b.id;this.shipment_statuses=b.shipment_statuses;this.isAjax=!!b.isAjax;this.srcList=b.src_list;this.allowAvailable=!!b.canAllow;this.deductAvailable=!!b.canDeduct;this.changeStatusAvailable=!!b.canChangeStatus;this.discounts=b.discounts||{};this.discountsMode=b.discountsMode||"edit";if(this.allowAvailable){this.initFieldChangeAllowDelivery()}if(this.deductAvailable){this.initFieldChangeDeducted()}if(this.changeStatusAvailable){this.initFieldChangeStatus()}if(!!b.active&&b.templateType=="view"){this.initUpdateTrackingNumber()}this.initFieldUpdateSum();this.initChangeProfile();this.initCustomEvent();this.initToggle();this.initDeleteShipment();if(this.discounts){this.setDiscountsList(this.discounts)}var a=[];if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){a.DELIVERY_PRICE_DISCOUNT={callback:this.setDeliveryPrice,context:this}}if(!!b.calculated_price){this.setCalculatedPriceDelivery(b.calculated_price)}a["DEDUCTED_"+this.id]={callback:this.updateDeductedStatus,context:this};a["ALLOW_DELIVERY_"+this.id]={callback:this.updateAllowDeliveryStatus,context:this};a["SHIPMENT_STATUS_LIST_"+this.id]={callback:this.setShipmentStatusList,context:this};a["SHIPMENT_STATUS_"+this.id]={callback:this.setDeliveryStatus,context:this};if(b.templateType=="edit"){a.BASE_PRICE_DELIVERY={callback:this.setDeliveryBasePrice,context:this};a.CALCULATED_PRICE={callback:this.setCalculatedPriceDelivery,context:this};a.DELIVERY_ERROR={callback:BX.Sale.Admin.OrderEditPage.showDialog,context:this};a.MAP={callback:this.updateMap,context:this};a.PROFILES={callback:this.updateProfiles,context:this};a.EXTRA_SERVICES={callback:this.updateExtraService,context:this};a.DELIVERY_SERVICE_LIST={callback:this.updateDeliveryList,context:this};a.SHIPMENT_COMPANY_ID={callback:this.updateCompany,context:this};if(!!BX.Sale.Admin.OrderBuyer&&!!BX.Sale.Admin.OrderBuyer.propertyCollection){var c=BX.Sale.Admin.OrderBuyer.propertyCollection.getDeliveryLocation();if(c){c.addEvent("change",function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData(),true)})}}}a.DISCOUNTS_LIST={callback:this.setDiscountsList,context:this};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(a)};BX.Sale.Admin.OrderShipment.prototype.updateCompany=function(a){var b=BX("SHIPMENT_COMPANY_ID_"+this.index);if(b){b.innerHTML=a}};BX.Sale.Admin.OrderShipment.prototype.updateDeductedStatus=function(a){this.setDeducted({status:a})};BX.Sale.Admin.OrderShipment.prototype.updateAllowDeliveryStatus=function(a){this.setAllowDelivery({status:a})};BX.Sale.Admin.OrderShipment.prototype.initUpdateTrackingNumber=function(){var a="";var b=BX("TRACKING_NUMBER_"+this.index+"_EDIT");var d=BX("TRACKING_NUMBER_"+this.index+"_VIEW");var c=BX("TRACKING_NUMBER_PENCIL_"+this.index);if(c){BX.bind(c,"click",function(){BX.toggle(this);if(b){BX.toggle(b);BX.toggle(d);b.focus()}});BX.bind(b,"blur",BX.proxy(function(){BX.toggle(c);BX.toggle(b);d.innerHTML=b.value;BX.toggle(d);if(b.value!=a){var e={action:"saveTrackingNumber",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,trackingNumber:b.value};BX.Sale.Admin.OrderAjaxer.sendRequest(e)}},this));BX.bind(b,"focus",function(){a=b.value})}};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryList=function(b){var d=BX("DELIVERY_"+this.index);if(!d){return}var c=d.options[d.selectedIndex].value;d.innerHTML=b;for(var a in d.options){if(d.options[a].value==c){d.options[a].selected=true;break}}};BX.Sale.Admin.OrderShipment.prototype.setDiscountsList=function(a){this.discounts=a;var b=BX("sale-order-shipment-discounts-container-"+this.index),d=BX("sale-order-shipment-discounts-row-"+this.index),c="none";if(b){b=BX.cleanNode(b,false);if(a&&a.RESULT&&a.RESULT.DELIVERY&&a.RESULT.DELIVERY.length>0){b.appendChild(this.createDiscountsNode(a.RESULT.DELIVERY));c=""}}if(d&&d.previousElementSibling){d.style.display=c;d.previousElementSibling.style.display=c}};BX.Sale.Admin.OrderShipment.prototype.createDiscountsNode=function(a){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DELIVERY",a,this.discounts,this.discountsMode=="edit"?"EDIT":"VIEW")};BX.Sale.Admin.OrderShipment.prototype.updateProfiles=function(b){var f=null;var d=BX("BLOCK_DELIVERY_SERVICE_"+this.index);var g=BX("BLOCK_PROFILES_"+this.index);var a=BX("PROFILE_"+this.index);if(a){f=a.options[a.selectedIndex].value}if(g){BX.remove(g)}var e=BX.create("tr",{props:{id:"BLOCK_PROFILES_"+this.index},children:[BX.create("td",{text:BX.message("SALE_ORDER_SHIPMENT_PROFILE")+":",style:{width:"40%"},props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{html:b,props:{id:" PROFILE_SELECT_"+this.index,className:"adm-detail-content-cell-r"}})]});d.parentNode.appendChild(e);a=e.lastChild.firstChild;if(f){for(var c in a.options){if(a.options[c].value==f){a.options[c].selected=true;break}}}BX.bind(a,"change",BX.proxy(function(){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData());this.updateDeliveryLogotip()}else{this.updateDeliveryInfo()}},this))};BX.Sale.Admin.OrderShipment.prototype.updateExtraService=function(b){var a=BX("DELIVERY_INFO_"+this.index);a.innerHTML=b};BX.Sale.Admin.OrderShipment.prototype.updateShipmentStatus=function(c,a,d){var b={action:"updateShipmentStatus",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,field:c,status:a,callback:BX.proxy(function(e){this.callbackUpdateShipmentStatus(e,c,a,d)},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(b)};BX.Sale.Admin.OrderShipment.prototype.callbackUpdateShipmentStatus=function(a,e,b,f){if(a.ERROR&&a.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(a.ERROR)}else{if(a.NEED_CONFIRM&&a.NEED_CONFIRM===true){var d=false;var g=false;if(a.WARNING&&a.WARNING.length>0){g=a.WARNING}if(a.CONFIRM_TITLE&&a.CONFIRM_TITLE.length>0){d=a.CONFIRM_TITLE}if(a.CONFIRM_MESSAGE&&a.CONFIRM_MESSAGE.length>0){g=g+"<br/>"+a.CONFIRM_MESSAGE}BX.Sale.Admin.OrderEditPage.showConfirmDialog(g,d,BX.proxy(function(){this.sendStrictUpdateShipmentStatus(e,b,f)},this),function(){return})}else{this[f.callback](f.args);if(a.RESULT){BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(a.RESULT)}if(a.WARNING&&a.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(a.WARNING)}if(typeof a.MARKERS!="undefined"){var c=BX("sale-adm-order-problem-block");if(c){c.innerHTML=a.MARKERS}}}}};BX.Sale.Admin.OrderShipment.prototype.sendStrictUpdateShipmentStatus=function(c,a,d){var b={action:"updateShipmentStatus",orderId:BX("ID").value,shipmentId:BX("SHIPMENT_ID_"+this.index).value,field:c,status:a,strict:true,callback:BX.proxy(function(e){this.callbackUpdateShipmentStatus(e,c,a,d)},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(b)};BX.Sale.Admin.OrderShipment.prototype.updateMap=function(c){var b=BX.processHTML(c);var d=BX("section_map_"+this.index);d.innerHTML=b.HTML;for(var a in b.SCRIPT){BX.evalGlobal(b.SCRIPT[a]["JS"])}BX.loadCSS(b.STYLE)};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryLogotip=function(){var g=BX("DELIVERY_"+this.index);var b=BX.findParent(g,{tag:"tbody"},true);if(b.children.length>1){g=BX("PROFILE_"+this.index)}var a="";var d="";var c=0;if(this.srcList[BX(g).value]){c=BX(g).value}a=this.srcList[c]["MAIN"];d=this.srcList[c]["SHORT"];var f=BX("delivery_service_logo_"+this.index);if(!!f){f.style.background="url("+a+")"}var e=BX("delivery_service_short_logo_"+this.index);if(!!e){e.style.background="url("+d+")"}};BX.Sale.Admin.OrderShipment.prototype.initChangeProfile=function(){var a=BX("DELIVERY_"+this.index);BX.bind(a,"change",BX.proxy(function(){var e=BX("DELIVERY_INFO_"+this.index);e.innerHTML="";var g=BX("section_map_"+this.index);g.innerHTML="";var f=BX("BLOCK_PROFILES_"+this.index);if(f){BX.remove(f)}var d=BX("sale-order-shipment-discounts-row-"+this.index);if(d){BX.hide(d.previousElementSibling);BX.hide(d)}var c=BX(a).value;if(c>0){this.updateDeliveryInfo()}else{this.setDeliveryPrice(0)}},this));var b=BX("PROFILE_"+this.index);if(b){BX.bind(b,"change",BX.proxy(function(){var e=BX("DELIVERY_INFO_"+this.index);e.innerHTML="";var f=BX("section_map_"+this.index);f.innerHTML="";var d=BX("sale-order-shipment-discounts-row-"+this.index);if(d){BX.hide(d.previousElementSibling);BX.hide(d)}var c=BX(b).value;if(c>0){this.updateDeliveryInfo()}else{this.setDeliveryPrice(0)}},this))}};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeDeducted=function(){var f=BX("STATUS_DEDUCTED_"+this.index);var e=["SHORT_"+this.index,this.index];for(var b in e){var a=BX("BUTTON_DEDUCTED_"+e[b]);if(!a){continue}var d=[];if(f.value=="N"){d.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_YES"),ONCLICK:BX.proxy(function(){var g={status:"Y"};if(this.isAjax){this.updateShipmentStatus("DEDUCTED","Y",{callback:"setDeducted",args:g})}else{this.setDeducted(g)}},this)})}else{d.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_NO"),ONCLICK:BX.proxy(function(){var g={status:"N"};if(this.isAjax){this.updateShipmentStatus("DEDUCTED","N",{callback:"setDeducted",args:g})}else{this.setDeducted(g)}},this)})}var c=new BX.COpener({DIV:a.parentNode,MENU:d})}};BX.Sale.Admin.OrderShipment.prototype.setDeducted=function(d){var b=(d.status=="Y")?"YES":"NO";var f=BX("STATUS_DEDUCTED_"+this.index);var e=["SHORT_"+this.index,this.index];f.value=d.status;for(var c in e){var a=BX("BUTTON_DEDUCTED_"+e[c]);if(!a){continue}BX.html(a,BX.message("SALE_ORDER_SHIPMENT_DEDUCTED_"+b));if(d.status=="Y"){BX.removeClass(a,"notdeducted")}else{BX.addClass(a,"notdeducted")}}this.initFieldChangeDeducted()};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeStatus=function(){var k=["SHORT_"+this.index,this.index];var e=BX("STATUS_SHIPMENT_"+this.index);for(var d in k){var f=BX("BUTTON_SHIPMENT_"+k[d]);var a=[];for(var c in this.shipment_statuses){if(this.shipment_statuses[c].ID==e.value){continue}function h(i,j){var l={name:i.NAME,id:i.ID};var m={TEXT:i.NAME,ONCLICK:function(){j.updateShipmentStatus("STATUS_ID",i.ID,{callback:"setDeliveryStatus",args:l})}};a.push(m)}h(this.shipment_statuses[c],this)}if(f){if(a.length>0){var b=new BX.COpener({DIV:f.parentNode,MENU:a})}else{var g=BX.create("span",{children:[BX.create("span",{attrs:{id:f.getAttribute("id"),className:"not_active"},text:f.textContent})]});f.parentNode.parentNode.appendChild(g);BX.remove(f.parentNode)}}}};BX.Sale.Admin.OrderShipment.prototype.setDeliveryStatus=function(c){var a=BX("STATUS_SHIPMENT_"+this.index);a.value=c.id;var e=["SHORT_"+this.index,this.index];for(var b in e){var d=BX("BUTTON_SHIPMENT_"+e[b]);BX.html(d,c.name)}this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.setDeliveryBasePrice=function(a){if(BX("BASE_PRICE_DELIVERY_"+this.index)){BX("BASE_PRICE_DELIVERY_"+this.index).value=a}if(BX("BASE_PRICE_DELIVERY_T_"+this.index)){BX("BASE_PRICE_DELIVERY_T_"+this.index).innerHTML=a}};BX.Sale.Admin.OrderShipment.prototype.setDeliveryPrice=function(a){if(!BX("PRICE_DELIVERY_"+this.index)){return}BX("PRICE_DELIVERY_"+this.index).value=a};BX.Sale.Admin.OrderShipment.prototype.setCalculatedPriceDelivery=function(b){var d=BX("CUSTOM_PRICE_DELIVERY_"+this.index);if(d.value!="Y"&&BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){return}var a=BX("PRICE_DELIVERY_"+this.index);if(a){var c=BX.findParent(a,{tag:"tbody"},true);var f=BX.findChildByClassName(c,"row_set_new_delivery_price");if(f){BX.remove(f)}}BX("CALCULATED_PRICE_"+this.index).value=b;var e=BX.create("tr",{children:[BX.create("td",{html:BX.message("SALE_ORDER_SHIPMENT_NEW_PRICE_DELIVERY")+": ",props:{className:"adm-detail-content-cell-l"}}),BX.create("td",{children:[BX.create("span",{text:BX.Sale.Admin.OrderEditPage.currencyFormat(b)}),BX.create("span",{text:BX.message("SALE_ORDER_SHIPMENT_APPLY"),props:{onclick:BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_SET_NEW_PRICE"))){BX("PRICE_DELIVERY_"+this.index).value=b;BX("BASE_PRICE_DELIVERY_"+this.index).value=b;var g=BX.findChildByClassName(c,"row_set_new_delivery_price");BX.remove(g);d.value="N";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}}},this),className:"new_delivery_price_button"}})],props:{className:"adm-detail-content-cell-r"}})],props:{className:"row_set_new_delivery_price"}});c.appendChild(e)};BX.Sale.Admin.OrderShipment.prototype.updateDeliveryInfo=function(){var b=BX.Sale.Admin.OrderEditPage.getAllFormData();var a={action:"changeDeliveryService",formData:b,index:this.index,callback:BX.proxy(function(c){if(c.ERROR&&c.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(c.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(c.SHIPMENT_DATA);this.updateDeliveryLogotip();if(c.WARNING&&c.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(c.WARNING)}}},this)};if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(a,false,true)}else{BX.Sale.Admin.OrderAjaxer.sendRequest(a,false,false)}};BX.Sale.Admin.OrderShipment.prototype.getDeliveryPrice=function(){var c=BX.Sale.Admin.OrderEditPage.getAllFormData();var b={action:"getDefaultDeliveryPrice",formData:c,callback:BX.proxy(function(d){if(d.ERROR&&d.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(d.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(d.RESULT);if(d.WARNING&&d.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(d.WARNING)}}},this)};var a=(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form");BX.Sale.Admin.OrderAjaxer.sendRequest(b,false,a)};BX.Sale.Admin.OrderShipment.prototype.initCustomEvent=function(){BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(function(a){if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{this.getDeliveryPrice()}},this))};BX.Sale.Admin.OrderShipment.prototype.initFieldChangeAllowDelivery=function(){var a=BX("STATUS_ALLOW_DELIVERY_"+this.index);var f=["SHORT_"+this.index,this.index];for(var c in f){var e=BX("BUTTON_ALLOW_DELIVERY_"+f[c]);if(!e){continue}var d=[];if(a.value=="Y"){d.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_NO"),ONCLICK:BX.proxy(function(){var g={status:"N"};if(this.isAjax){this.updateShipmentStatus("ALLOW_DELIVERY","N",{callback:"setAllowDelivery",args:g})}else{this.setAllowDelivery(g)}},this)})}else{d.push({TEXT:BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_YES"),ONCLICK:BX.proxy(function(){var g={status:"Y"};if(this.isAjax){this.updateShipmentStatus("ALLOW_DELIVERY","Y",{callback:"setAllowDelivery",args:g})}else{this.setAllowDelivery(g)}this.initFieldChangeAllowDelivery()},this)})}var b=new BX.COpener({DIV:e.parentNode,MENU:d})}};BX.Sale.Admin.OrderShipment.prototype.setAllowDelivery=function(e){var b=(e.status=="Y")?"YES":"NO";var f=["SHORT_"+this.index,this.index];var a=BX("STATUS_ALLOW_DELIVERY_"+this.index);a.value=e.status;for(var c in f){var d=BX("BUTTON_ALLOW_DELIVERY_"+f[c]);if(!d){continue}BX.html(d,BX.message("SALE_ORDER_SHIPMENT_ALLOW_DELIVERY_"+b));if(e.status=="Y"){BX.removeClass(d,"notdelivery")}else{BX.addClass(d,"notdelivery")}}this.initFieldChangeAllowDelivery()};BX.Sale.Admin.OrderShipment.prototype.setShipmentStatusList=function(a){this.shipment_statuses=a;this.initFieldChangeStatus()};BX.Sale.Admin.OrderShipment.prototype.initFieldUpdateSum=function(){var b=BX("PRICE_DELIVERY_"+this.index);var a=BX("CUSTOM_PRICE_DELIVERY_"+this.index);BX.bind(b,"change",BX.proxy(function(){a.value="Y";if(BX.Sale.Admin.OrderEditPage.formId!="order_shipment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{var c=BX("sale-order-shipment-discounts-row-"+this.index);if(c){BX.hide(c.previousElementSibling);BX.hide(c)}BX("CUSTOM_PRICE_DELIVERY_"+this.index).value="Y";BX("BASE_PRICE_DELIVERY_"+this.index).value=b.value}},this))};BX.Sale.Admin.OrderShipment.prototype.initToggle=function(){var b=BX("SHIPMENT_SECTION_"+this.index);var c=BX("SHIPMENT_SECTION_SHORT_"+this.index);var a=BX("SHIPMENT_SECTION_"+this.index+"_TOGGLE");BX.bind(a,"click",BX.proxy(function(){a.innerHTML=(c.style.display!="none")?BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE"):BX.message("SALE_ORDER_SHIPMENT_BLOCK_SHIPMENT_TOGGLE_UP");BX.toggle(b);BX.toggle(c)},this))};BX.Sale.Admin.OrderShipment.prototype.initDeleteShipment=function(){var a=BX("SHIPMENT_SECTION_"+this.index+"_DELETE");BX.bind(a,"click",BX.proxy(function(){if(confirm(BX.message("SALE_ORDER_SHIPMENT_CONFIRM_DELETE_SHIPMENT"))){var b=(BX("ID"))?BX("ID").value:0;var c=(BX("SHIPMENT_ID_"+this.index))?BX("SHIPMENT_ID_"+this.index).value:0;if((b>0)&&(c>0)){var d={action:"deleteShipment",order_id:b,shipment_id:c,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(e.RESULT);BX.cleanNode(BX("shipment_container_"+this.index));if(e.WARNING&&e.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.WARNING)}}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(d)}}},this))};BX.Sale.Admin.OrderShipment.prototype.showCreateCheckWindow=function(a){ShowWaitWindow();var b={action:"addCheckShipment",shipmentId:a,callback:BX.proxy(function(c){CloseWaitWindow();if(c.ERROR&&c.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(c.ERROR)}else{var e=c.HTML;var d=new BX.CAdminDialog({content:e,title:BX.message("SALE_ORDER_SHIPMENT_CASHBOX_CHECK_ADD_WINDOW_TITLE"),resizable:false,draggable:false,height:"100",width:"516",buttons:[{title:top.BX.message("JS_CORE_WINDOW_SAVE"),id:"saveCheckBtn",name:"savebtn",className:top.BX.browser.IsIE()&&top.BX.browser.IsDoctype()&&!top.BX.browser.IsIE10()?"":"adm-btn-save"},{title:top.BX.message("JS_CORE_WINDOW_CANCEL"),id:"cancelCheckBtn",name:"cancel"}]});d.Show();BX.bind(BX("checkTypeSelect"),"change",function(){var l=this.value;var k=l.indexOf("credit")!==-1;var j=BX.findParent(this,{tag:"tr"});var m=j.nextElementSibling;var g=BX.findChildren(m,{tag:"input"},true);for(var f in g){if(g.hasOwnProperty(f)){var h=g[f].nextElementSibling;if(k){BX.addClass(h,"bx-admin-service-restricted")}else{BX.removeClass(h,"bx-admin-service-restricted")}if(g[f].checked){g[f].click()}g[f].disabled=k}}});BX.bind(BX("cancelCheckBtn"),"click",BX.delegate(function(){d.Close();d.DIV.parentNode.removeChild(d.DIV)}),this);BX.bind(BX("saveCheckBtn"),"click",BX.delegate(function(){ShowWaitWindow();var g=BX("check_shipment");var f={formData:BX.ajax.prepareForm(g),action:"saveCheck",sessid:BX.bitrix_sessid()};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_order_ajax.php",data:f,onsuccess:function(h){CloseWaitWindow();if(h.ERROR&&h.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(h.ERROR)}else{BX("SHIPMENT_CHECK_LIST_ID_"+a).innerHTML=h.CHECK_LIST_HTML;if(BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+a)!==undefined&&BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+a)!==null){BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+a).innerHTML=h.CHECK_LIST_HTML}d.Close();d.DIV.parentNode.removeChild(d.DIV)}},onfailure:function(h){CloseWaitWindow()}})}),this)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(b,true)};BX.Sale.Admin.OrderShipment.prototype.onCheckEntityChoose=function(a){var c=a.checked;var b=BX(a.id+"_type");if(b){b.disabled=!c}};BX.Sale.Admin.OrderShipment.prototype.sendQueryCheckStatus=function(a){ShowWaitWindow();var b={action:"sendQueryCheckStatus",checkId:a,callback:BX.proxy(function(c){if(c.ERROR&&c.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(c.ERROR)}else{CloseWaitWindow();var d=c.SHIPMENT_ID;BX("SHIPMENT_CHECK_LIST_ID_"+d).innerHTML=c.CHECK_LIST_HTML;if(BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+d)!==undefined&&BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+d)!==null){BX("SHIPMENT_CHECK_LIST_ID_SHORT_VIEW"+d).innerHTML=c.CHECK_LIST_HTML}}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(b,true)};BX.namespace("BX.Sale.Admin.GeneralShipment");BX.Sale.Admin.GeneralShipment={getIds:function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())},createNewShipment:function(){var a=BX("ID").value;window.location="/bitrix/admin/sale_order_shipment_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&order_id="+a+"&backurl="+encodeURIComponent(window.location.pathname+window.location.search)},findProductByBarcode:function(a){BX.hide(a.parentNode);BX.show(a.parentNode.nextElementSibling)},refreshTrackingStatus:function(h,c,b){var a="";if(b){var d=BX("order_shipment_edit_info_form");if(d){var e=d.elements["SHIPMENT["+h+"][TRACKING_NUMBER]"];if(e&&e.value){a=e.value}}}else{var g=BX("TRACKING_NUMBER_"+h+"_VIEW");if(g){a=g.innerHTML}}if(!a){alert(BX.message("SALE_ORDER_SHIPMENT_TRACKING_S_EMPTY"));return}var f={action:"refreshTrackingStatus",shipmentId:c,trackingNumber:a,callback:function(i){if(i&&!i.ERROR){if(i.TRACKING_STATUS){var j=BX("sale-order-shipment-tracking-status-"+h);if(j){j.innerHTML=i.TRACKING_STATUS}}if(i.TRACKING_DESCRIPTION){var l=BX("sale-order-shipment-tracking-description-"+h);if(l){l.innerHTML=i.TRACKING_DESCRIPTION}}if(i.TRACKING_LAST_CHANGE){var k=BX("sale-order-shipment-tracking-last-change-"+h);if(k){k.innerHTML=i.TRACKING_LAST_CHANGE}}if(i.WARNING&&i.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(i.WARNING)}}else{if(i&&i.ERROR){BX.Sale.Admin.OrderEditPage.showDialog(i.ERROR)}else{BX.debug("Error refreshing tracking status!")}}}};BX.Sale.Admin.OrderAjaxer.sendRequest(f)}};