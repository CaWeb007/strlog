BX.namespace("BX.Sale.Admin.DiscountPreset");BX.Sale.Admin.DiscountPreset.SelectProduct=(function(){var a=function(c){this.tableId="sale_discount_preset_product_table";this.emptyRowId="sale_discount_preset_product_table_empty_row";this.idPrefix="idPrefix";this.siteId=c.siteId;this.presetId=c.presetId;this.sectionCount=c.sectionCount||1;this.inputNameProduct=c.inputNameProduct||"discount_product[]";this.inputNameSection=c.inputNameSection||"discount_section[]";this.container=BX("sale_discount_preset_section_box");this.productIds={};if(c.products){for(var b in c.products){if(!c.products.hasOwnProperty(b)){continue}this.productAdd(c.products[b])}}setTimeout(BX.delegate(function(){var e=BX.findChildrenByClassName(this.container,"mli-field",true);for(var d in e){if(!e.hasOwnProperty(d)){continue}BX.adjust(e[d],{style:{width:"99%"}})}},this),200);this.setEvents()};a.prototype.setEvents=function(){BX.bind(BX("sale_discount_preset_section_add"),"click",BX.delegate(this.onClickAddSection,this));BX.bind(BX("sale_discount_preset_product_add"),"click",BX.delegate(this.onClickAddProduct,this));BX.addCustomEvent("onDeletePresetProduct",BX.delegate(this.onDeletePresetProduct,this))};a.prototype.onClickSectionToShowPopup=function(d){var e=d.srcElement||d.target;var b=e.getAttribute("data-section-number");var c="/bitrix/admin/cat_section_search.php?land=ru&discount=Y&n=sect_"+b;window.open(c,"","scrollbars=yes,resizable=yes,width=900,height=600,top="+parseInt((screen.height-500)/2-14,10)+",left="+parseInt((screen.width-600)/2-5,10));BX.PreventDefault(d)};a.prototype.onClickDeleteSection=function(b){var d=b.srcElement||b.target;var c=BX.findParent(d,{tagName:"tr"},10);if(c){BX.remove(c)}BX.PreventDefault(b)};a.prototype.onDeletePresetProduct=function(b){var c=BX(this.createProductRowId({PRODUCT_ID:b}));this.productIds[b]=false;BX.remove(c);if(BX.findChildren(BX(this.tableId),{tagName:"tbody"}).length===1){BX.show(BX(this.emptyRowId),"block")}};a.prototype.createProductRowId=function(b){return this.idPrefix+"discount-preset-product-"+(b.OFFER_ID||b.PRODUCT_ID)};a.prototype.createProductMenuContent=function(b){return[{ICON:"delete",TEXT:BX.message("JS_SALE_HANDLERS_DISCOUNTPRESET_DELETE_PRODUCT"),ACTION:"BX.onCustomEvent('onDeletePresetProduct', ["+b+"])"}]};a.prototype.createMenuCell=function(d,e){var c,b=this.createProductMenuContent((e.OFFER_ID||e.PRODUCT_ID));if(b.length<=0){return false}if(e.IS_SET_ITEM!="Y"){c=BX.create("span",{props:{className:"adm-s-order-item-title-icon"}});BX.bind(c,"click",BX.proxy(function(f){c.blur();BX.adminList.ShowMenu(c,b)},this))}else{c=BX.create("span",{html:"&nbsp;"})}return BX.create("td",{props:{className:"tac bdb-line",id:this.idPrefix+"sale-order-basket-product-"+d+"-menu"},children:[c]})};a.prototype.createFieldImage=function(d,e,c){var f,b;if(e.PICTURE_URL){f=BX.create("img",{props:{src:e.PICTURE_URL}})}else{f=BX.create("div",{props:{className:"no_foto"},text:BX.message("SALE_ORDER_BASKET_NO_PICTURE")})}if(typeof e.EDIT_PAGE_URL!="undefined"){b=BX.create("a",{props:{href:e.EDIT_PAGE_URL?e.EDIT_PAGE_URL:"",target:"_blank"},children:[f]});b.style.textAlign="center"}else{b=BX.create("div",{style:{width:"150px",textAlign:"center"},children:[f]})}return b};a.prototype.createFieldSkuProps=function(c,d,b){return this.createSkuPropsTable(c,d)};a.prototype.createSkuPropsTable=function(b,j){var k=BX.create("table"),f,d=[],l=null;if(j.SKU_PROPS){for(var h in j.SKU_PROPS){if(!j.SKU_PROPS.hasOwnProperty(h)){continue}if(!j.SKU_PROPS[h]["VALUE"]){j.SKU_PROPS[h]["VALUE"]={NAME:h}}if(j.SKU_PROPS[h]["VALUE"]["PICT"]){f='<div style="width: 17px; height: 17px; text-align: center; border: 1px solid gray;"><img  width="17" height="17" src="'+j.SKU_PROPS[h]["VALUE"]["PICT"]+'"></div>'}else{f='<div style="font-size: 9px; padding: 2px 5px; text-align: center; border: 1px solid gray;">'+BX.util.htmlspecialchars(j.SKU_PROPS[h]["VALUE"]["NAME"])+"</div>"}if(!j.SKU_PROPS[h]["NAME"]){j.SKU_PROPS[h]["NAME"]=h}var c=BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(j.SKU_PROPS[h]["NAME"])+" </span>",style:{"text-align":"left"}});k.appendChild(BX.create("tr",{children:[c,BX.create("td",{html:f})]}));d.push(j.SKU_PROPS[h]["CODE"])}}if(j.PROPS){for(var e in j.PROPS){if(!j.PROPS.hasOwnProperty(e)){continue}if(!j.PROPS[e]||d.indexOf(j.PROPS[e]["CODE"])!=-1){continue}if(!j.PROPS[e]["NAME"]){j.PROPS[e]["NAME"]=""}if(!j.PROPS[e]["VALUE"]){j.PROPS[e]["VALUE"]=""}if((j.PROPS[e]["CODE"]=="PRODUCT.XML_ID"||j.PROPS[e]["CODE"]=="CATALOG.XML_ID")){continue}var c=BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(j.PROPS[e]["NAME"])+" </span>",style:{"text-align":"left"}});var g=BX.create("tr",{children:[c,BX.create("td",{html:'<div style="font-size: 9px; padding: 2px 5px; text-align: center;">'+BX.util.htmlspecialchars(j.PROPS[e]["VALUE"])+"</div>"})]});k.appendChild(g)}}if(k.children.length){l=k}return l};a.prototype.createProductCell=function(b,i,g){var j=null,d=[],c=i[g],h="",f=this;switch(g){case"NUMBER":d.push(BX.create("span",{props:{id:i.IS_SET_ITEM!="Y"?this.idPrefix+"sale_order_product_"+b+"_number":"&nbsp;"},html:"&nbsp;"}));break;case"NAME":if(i.EDIT_PAGE_URL){e=BX.create("a",{props:{href:i.EDIT_PAGE_URL,target:"_blank"},html:BX.util.htmlspecialchars(c)})}else{e=BX.create("span",{style:{fontWeight:"bold"},html:BX.util.htmlspecialchars(i[g])})}d.push(e);break;case"IMAGE":d.push(this.createFieldImage(b,i,g));h="adm-s-order-table-ddi-table-img";break;case"PROPS":var e=this.createFieldSkuProps(b,i,g);if(e){d.push(e)}break}if(d.length>0){j=BX.create("td");if(h){BX.addClass(j,h)}while(d.length>0){j.appendChild(d.pop())}if(g=="NAME"){j.style.minWidth="250px";if(i.IS_SET_ITEM=="Y"){j.style.fontStyle="italic";j.style.paddingLeft="40px"}}}return j};a.prototype.productAdd=function(d){if(d.PRODUCT_ID&&!d.OFFER_ID){if(this.productIds[d.PRODUCT_ID]){return}this.productIds[d.PRODUCT_ID]=true}if(d.PRODUCT_ID&&d.OFFER_ID){if(this.productIds[d.OFFER_ID]){return}this.productIds[d.OFFER_ID]=true}var b=d.id;var c=this.createProductRow(b,d);BX(this.tableId).appendChild(c);BX.hide(BX(this.emptyRowId))};a.prototype.createProductRow=function(b,j){var c,f=BX.create("tbody",{props:{id:this.createProductRowId(j)},style:{textAlign:"left",borderBottom:"1px solid #DDD"}}),k=this.createMenuCell(b,j),h=BX.create("tr");if(k){h.appendChild(k)}var i,d=[];if(j.IS_SET_ITEM!="Y"){f.setAttribute("data-product-id",(j.OFFER_ID||j.PRODUCT_ID));if(j.IS_SET_PARENT&&j.OLD_PARENT_ID){f.setAttribute("data-old-parent-id-parent",j.OLD_PARENT_ID)}}else{BX.addClass(f,"bundle-child-"+j.OLD_PARENT_ID);BX.addClass(f,"basket-bundle-child-hidden");BX.addClass(f,"bundle-child")}for(var g in {IMAGE:"IMAGE",NAME:"NAME",PROPS:"PROPS"}){c=this.createProductCell(b,j,g);if(c){if(d){while(i=d.pop()){c.appendChild(i)}}h.appendChild(c)}else{var e=h.lastChild.getAttribute("colspan")||1;e++;h.lastChild.setAttribute("colspan",e)}}h.appendChild(BX.create("input",{props:{type:"hidden",name:this.inputNameProduct,value:j.OFFER_ID||j.PRODUCT_ID}}));f.appendChild(h);return f};a.prototype.getParamsByProductId=function(b,c){BX.ajax({url:"/bitrix/admin/sale_discount_preset_detail.php?lang="+BX.message.LANGUAGE_ID+"&action=getProductDetails&PRESET_ID="+BX.util.urlencode(this.presetId),method:"POST",dataType:"json",data:{productId:b.id,iblockId:c,quantity:b.quantity,sessid:BX.bitrix_sessid(),siteId:this.siteId},onsuccess:BX.delegate(function(d){this.productAdd(d)},this),onfailure:function(d){}})};a.prototype.onClickAddProduct=function(c){var d="perDayPreset.getParamsByProductId";window[d]=BX.proxy(function(f,e){this.getParamsByProductId(f,e)},this);var b=new BX.CDialog({content_url:"/bitrix/tools/sale/product_search_dialog.php?lang="+BX.message.LANGUAGE_ID+"&LID="+this.siteId+"&caller=preset_edit&allow_select_parent=Y&func_name="+d+"&STORE_FROM_ID=0",height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800});BX.addCustomEvent(b,"onWindowRegister",BX.defer(function(){b.Get().style.position="fixed";b.Get().style.top=(parseInt(b.Get().style.top)-BX.GetWindowScrollPos().scrollTop)+"px"}));b.Show();BX.PreventDefault(c)};a.prototype.onClickAddSection=function(d){if(!BX("sect_stub")){this.container.appendChild(BX.create("input",{props:{type:"hidden",id:"sect_stub",name:"sect_stub"}}))}var c="/bitrix/admin/cat_section_search.php?land=ru&discount=Y&n=sect_stub";var b=window.open(c,"","scrollbars=yes,resizable=yes,width=900,height=600,top="+parseInt((screen.height-500)/2-14,10)+",left="+parseInt((screen.width-600)/2-5,10));b.onbeforeunload=function(){if(window.jsMLI_select_section){jsMLI_select_section.AddValue(BX("sect_stub").value)}};BX.PreventDefault(d)};return a})();