BX.namespace("BX.Sale.Admin.OrderPayment");BX.Sale.Admin.OrderPayment=function(e){this.clWindow=null;this.pdWindow=null;this.rtWindow=null;this.psToReturn=e.psToReturn;this.index=e.index;this.viewForm=!!e.viewForm;this.isAvailableChangeStatus=e.isAvailableChangeStatus;if(this.isAvailableChangeStatus){if(!!e.isPaid){this.initPaidPopup()}else{this.initNotPaidPopup()}}this.initToggle();this.initReloadImg();this.initDeletePayment();this.initPaymentSum();var d=[];d.PAY_SYSTEM_LIST={callback:this.updatePaySystemList,context:this};d.PRICE_COD={callback:this.updatePriceCod,context:this};d.PAYSYSTEM_ERROR={callback:BX.Sale.Admin.OrderEditPage.showDialog,context:this};d.PAYMENT_COMPANY_ID={callback:this.updateCompany,context:this};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(d);if(this.viewForm){var c=BX("ps_update_"+this.index);var b=BX("ID");if(b){b=b.value}var a=BX("PAYMENT_ID_"+this.index);if(a){a=a.value}if(c){BX.bind(c,"click",function(){var f={action:"updatePaySystemInfo",orderId:b,paymentId:a,callback:function(g){if(g.ERROR&&g.ERROR.length>0){alert(g.ERROR)}else{location.reload()}}};BX.Sale.Admin.OrderAjaxer.sendRequest(f)})}}};BX.Sale.Admin.OrderPayment.prototype.initPaymentSum=function(){var a=BX("PAYMENT_SUM_"+this.index);if(a){BX.bind(a,"change",function(){BX.Sale.Admin.OrderEditPage.autoPriceChange=false;if(BX.Sale.Admin.OrderEditPage.formId!="order_payment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}})}};BX.Sale.Admin.OrderPayment.prototype.updateCompany=function(a){var b=BX("PAYMENT_COMPANY_ID_"+this.index);if(b){b.innerHTML=a}};BX.Sale.Admin.OrderPayment.prototype.updatePaySystemList=function(d){var b=BX("PAY_SYSTEM_ID_"+this.index);if(!b){return}var c=b.options[b.selectedIndex].value;b.innerHTML=d;for(var a in b.options){if(b.options.hasOwnProperty(a)&&b.options[a].value==c){b.options[a].selected=true;break}}this.reloadImg()};BX.Sale.Admin.OrderPayment.prototype.updatePriceCod=function(a){var c=BX("PAYMENT_PRICE_COD_"+this.index);if(c){c.value=a;var b=c.parentNode.parentNode;if(a>0){b.style.display="table-row"}else{BX.hide(b)}}};BX.Sale.Admin.OrderPayment.prototype.sendAjaxChangeStatus=function(e){var d=BX.ajax.prepareForm(BX(e.form_name));var b=BX("ID").value;var a=BX("PAYMENT_ID_"+this.index).value;var c={method:e.action,action:"updatePaymentStatus",orderId:b,paymentId:a,data:d.data,callback:BX.proxy(function(f){e.callback(f,e)},this)};if(e.strict&&e.strict===true){c.strict=e.strict}BX.Sale.Admin.OrderAjaxer.sendRequest(c)};BX.Sale.Admin.OrderPayment.prototype.initDeletePayment=function(){var a=BX("SECTION_"+this.index+"_DELETE");if(a){BX.bind(a,"click",BX.proxy(this.deletePayment,this))}};BX.Sale.Admin.OrderPayment.prototype.initToggle=function(){var a=BX("PS_INFO_"+this.index);BX.bind(a,"click",this.togglePsInfo);a=BX("SECTION_"+this.index+"_TOGGLE");BX.bind(a,"click",BX.proxy(this.togglePayment,this))};BX.Sale.Admin.OrderPayment.prototype.initReloadImg=function(){this.obj=BX("PAY_SYSTEM_ID_"+this.index);BX.bind(this.obj,"change",BX.proxy(function(){if(BX.Sale.Admin.OrderEditPage.formId!="order_payment_edit_info_form"){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData())}else{var b=BX("order_id");var a=BX("payment_id_"+this.index);var d=BX("PAYMENT_SUM_"+this.index);var c={action:"updatePriceCod",orderId:(b)?b.value:0,paymentId:(a)?a.value:0,paySystemId:this.obj.value,price:(d)?d.value:0,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{this.updatePriceCod(e.PRICE_COD)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(c)}this.reloadImg()},this))};BX.Sale.Admin.OrderPayment.prototype.deletePayment=function(){if(confirm(BX.message.PAYMENT_CONFIRM_DELETE)){var b=(BX("ID"))?BX("ID").value:0;var a=(BX("PAYMENT_ID_"+this.index))?BX("PAYMENT_ID_"+this.index).value:0;if((b>0)&&(a>0)){var c={action:"deletePayment",orderId:BX("ID").value,paymentId:BX("PAYMENT_ID_"+this.index).value,callback:BX.proxy(function(e){if(e.ERROR&&e.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(e.ERROR)}else{var f=BX.findParent(BX("payment_container_"+this.index),{tag:f});BX.cleanNode(f)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(c)}else{var d=BX.findParent(BX("payment_container_"+this.index),{tag:d});BX.cleanNode(d)}}};BX.Sale.Admin.OrderPayment.prototype.togglePsInfo=function(){var b=BX.nextSibling(this);var a=b.style.display=="none";if(a){b.style.display="table";BX.html(this,BX.message.PAYMENT_TOGGLE_UP)}else{BX.hide(b);BX.html(this,BX.message.PAYMENT_TOGGLE_DOWN)}};BX.Sale.Admin.OrderPayment.prototype.togglePayment=function(){BX.toggle(BX("SECTION_"+this.index));BX.toggle(BX("SECTION_SHORT_"+this.index));var a=BX("SECTION_"+this.index).style.display=="none";BX.html(BX("SECTION_"+this.index+"_TOGGLE"),BX.message["PAYMENT_TOGGLE_"+((a)?"DOWN":"UP")])};BX.Sale.Admin.OrderPayment.prototype.reloadImg=function(){var a=BX("LOGOTIP_"+this.index);a.style.background="url("+logoList[BX(this.obj).value]+")"};BX.Sale.Admin.OrderPayment.prototype.showReturnWindow=function(b){var k=BX.create("table",{props:{width:"100%",className:"adm-detail-content-table edit-table"}});var h=BX.create("tbody");if(b=="return"){var f=BX.create("tr",{children:[BX.create("td",{props:{className:"adm-detail-content-cell-l fwb"},text:BX.message.PAYMENT_OPERATION_TITLE+":"})]});var a=BX.create("td",{props:{className:"adm-detail-content-cell-r"}});var j=BX.create("select",{props:{id:"PAY_OPERATION_ID_"+this.index,className:"adm-bus-select",name:"PAY_RETURN_OPERATION_ID_"+this.index}});for(var d in this.psToReturn){if(!this.psToReturn.hasOwnProperty(d)){continue}var e=BX.create("option",{props:{value:d},text:this.psToReturn[d]});j.appendChild(e)}a.appendChild(j);f.appendChild(a);h.appendChild(f);f=BX.create("tr",{children:[BX.create("td",{props:{className:"adm-detail-content-cell-l fwb"},text:BX.message.PAYMENT_RETURN_NUM_DOC+":"})]});var g=BX.create("input",{props:{type:"text",className:"adm-bus-input",name:"PAY_RETURN_NUM_"+this.index,maxlength:20}});a=BX.create("td",{props:{className:"adm-detail-content-cell-r"},children:[g],text:BX.message.PAYMENT_OPERATION_TITLE+":"});f.appendChild(a);h.appendChild(f);f=BX.create("tr",{children:[BX.create("td",{props:{className:"adm-detail-content-cell-l fwb"},text:BX.message.PAYMENT_RETURN_DATE+":"})]});var c=this;a=BX.create("td",{props:{className:"adm-detail-content-cell-r tal"},children:[BX.create("div",{props:{className:"adm-input-wrap adm-calendar-second"},style:{display:"inline-block"},children:[BX.create("input",{props:{type:"text",className:"adm-input adm-calendar-to",id:"PAY_RETURN_DATE_"+this.index,name:"PAY_RETURN_DATE_"+this.index,size:15}}),BX.create("span",{props:{className:"adm-calendar-icon",title:BX.message.PAYMENT_RETURN_DATE_ALT},events:{click:function(){BX.calendar({node:this,field:"PAY_RETURN_DATE_"+c.index,form:"",bTime:false,bHideTime:false})}}})]})]});f.appendChild(a);h.appendChild(f)}f=BX.create("tr",{children:[BX.create("td",{props:{className:"adm-detail-content-cell-l fwb"},text:BX.message.PAYMENT_RETURN_COMMENT}),BX.create("td",{props:{className:"adm-detail-content-cell-r"},children:[BX.create("textarea",{props:{className:"adm-bus-textarea",id:"PAY_RETURN_COMMENT_"+this.index,name:"PAY_RETURN_COMMENT_"+this.index}})]})]});h.appendChild(f);k.appendChild(h);if(!this.rtWindow&&b=="return"){this.rtWindow=new BX.CDialog({content:BX.create("form",{props:{id:"payment_return_form_"+this.index,name:"payment_return_form_"+this.index},children:[k]}),title:BX.message.PAYMENT_WINDOW_RETURN_TITLE,width:650,height:250,resizable:false,buttons:[new BX.CWindowButton({title:BX.message.PAYMENT_WINDOW_RETURN_BUTTON_SAVE,action:BX.proxy(function(){var i={index:this.index,action:"return",form_name:"payment_return_form_"+this.index,callback:BX.proxy(function(l){if(l.ERROR&&l.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(l.ERROR)}else{this.changeNotPaidStatus("NO");this.initNotPaidPopup();BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(l.RESULT);if(typeof l.MARKERS!="undefined"){var m=BX("sale-adm-order-problem-block");if(m){m.innerHTML=l.MARKERS}}if(l.WARNING&&l.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(l.WARNING)}}},this)};this.sendAjaxChangeStatus(i);BX.WindowManager.Get().Close()},this),className:"adm-btn-save"}),BX.CDialog.btnCancel]})}else{if(!this.clWindow&&b=="cancel"){this.clWindow=new BX.CDialog({content:BX.create("form",{props:{id:"payment_cancel_form_"+this.index,name:"payment_cancel_form_"+this.index},children:[k]}),title:BX.message.PAYMENT_WINDOW_CANCEL_TITLE,width:650,height:100,resizable:false,buttons:[new BX.CWindowButton({title:BX.message.PAYMENT_WINDOW_RETURN_BUTTON_SAVE,action:BX.proxy(function(){var i={index:this.index,action:"cancel",form_name:"payment_cancel_form_"+this.index,callback:BX.proxy(function(l){if(l.ERROR&&l.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(l.ERROR)}else{this.changeNotPaidStatus("NO");this.initNotPaidPopup();BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(l.RESULT);if(typeof l.MARKERS!="undefined"){var m=BX("sale-adm-order-problem-block");if(m){m.innerHTML=l.MARKERS}}if(l.WARNING&&l.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(l.WARNING)}}},this)};this.sendAjaxChangeStatus(i);BX.WindowManager.Get().Close()},this),className:"adm-btn-save"}),BX.CDialog.btnCancel]})}}if(b=="return"){this.rtWindow.Show()}else{this.clWindow.Show()}};BX.Sale.Admin.OrderPayment.prototype.showWindowPaidPayment=function(){if(!this.pdWindow){var c=BX("AUTO_CHANGE_STATUS_ON_PAID");var f="";if(c&&c.value=="N"){var e=BX("STATUS_ID");var a=BX.findChildren(e,{tag:"option"});f+='<tr><td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message.PAYMENT_ORDER_STATUS+":</td>";f+='<td class="adm-detail-content-cell-r tal"><select name="ORDER_STATUS_ID_'+this.index+'" id="ORDER_STATUS_ID_'+this.index+'">';for(var b in a){if(!a.hasOwnProperty(b)){continue}f+=a[b].outerHTML}f+="</select></td></tr>";var g=this.index;BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters({STATUS_ID:{callback:function(h){BX("ORDER_STATUS_ID_"+g).value=h},context:this}})}var d='<table width="100%" class="adm-detail-content-table edit-table">';d+="<tbody>";d+="<tr>";d+='<td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message.PAYMENT_PAY_VOUCHER_DATE+":</td>";d+='<td class="adm-detail-content-cell-r tal"><div class="adm-input-wrap adm-calendar-second" style="display: inline-block;">';d+='<input type="text" class="adm-input adm-calendar-to" id="PAY_VOUCHER_DATE_'+this.index+'" name="PAY_VOUCHER_DATE_'+this.index+'" size="15" value="">';d+='<span class="adm-calendar-icon" title="'+BX.message.PAYMENT_RETURN_DATE_ALT+'" onclick="BX.calendar({node:this, field:\'PAY_VOUCHER_DATE_'+this.index+"', form: '', bTime: false, bHideTime: false});\"></span>";d+="</div></td></tr><tr>";d+='<td class="adm-detail-content-cell-l fwb" width="40%">'+BX.message.PAYMENT_PAY_VOUCHER_NUM+":</td>";d+='<td class="adm-detail-content-cell-r tal"><input type="text" class="adm-bus-input" value="" name="PAY_VOUCHER_NUM_'+this.index+'" id="PAY_VOUCHER_NUM_'+this.index+'" maxlength="20">';d+="</td></tr>";d+=f;d+="</tbody></table>";this.pdWindow=new BX.CDialog({content:'<form id="payment_voucher_form_'+this.index+'" name="order_new_table_settings_'+this.index+'">'+d+"</form>",title:BX.message.PAYMENT_WINDOW_VOUCHER_TITLE,width:650,height:200,resizable:false,buttons:[new BX.CWindowButton({title:BX.message.PAYMENT_WINDOW_RETURN_BUTTON_SAVE,action:BX.proxy(function(){var h={index:this.index,action:"save",form_name:"payment_voucher_form_"+this.index,callback:BX.proxy(function(i,j){this.callbackUpdatePaymentStatus(i,"YES",j)},this)};this.sendAjaxChangeStatus(h);BX.WindowManager.Get().Close()},this),className:"adm-btn-save"}),BX.CDialog.btnCancel]})}this.pdWindow.Show()};BX.Sale.Admin.OrderPayment.prototype.callbackUpdatePaymentStatus=function(a,b,e){if(a.ERROR&&a.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(a.ERROR)}else{if(a.NEED_CONFIRM&&a.NEED_CONFIRM===true){var d=false;var f=false;if(a.WARNING&&a.WARNING.length>0){f=a.WARNING}if(a.CONFIRM_TITLE&&a.CONFIRM_TITLE.length>0){d=a.CONFIRM_TITLE}if(a.CONFIRM_MESSAGE&&a.CONFIRM_MESSAGE.length>0){f=f+"<br/>"+a.CONFIRM_MESSAGE}BX.Sale.Admin.OrderEditPage.showConfirmDialog(f,d,BX.proxy(function(){this.sendStrictUpdatePaymentStatus(b,e)},this),function(){return})}else{this.changePaidStatus(b);this.initPaidPopup();BX.Sale.Admin.OrderEditPage.callFieldsUpdaters(a.RESULT);if(typeof a.MARKERS!="undefined"){var c=BX("sale-adm-order-problem-block");if(c){c.innerHTML=a.MARKERS}}if(a.WARNING&&a.WARNING.length>0){BX.Sale.Admin.OrderEditPage.showDialog(a.WARNING)}}}};BX.Sale.Admin.OrderPayment.prototype.sendStrictUpdatePaymentStatus=function(a,b){b.strict=true;this.sendAjaxChangeStatus(b)};BX.Sale.Admin.OrderPayment.prototype.changeNotPaidStatus=function(a){var c=BX("BUTTON_PAID_"+this.index);var b=BX("BUTTON_PAID_"+this.index+"_SHORT");if(c){BX.html(c,BX.message("PAYMENT_PAID_"+a));BX.addClass(c,"notpay")}if(b){BX.html(b,BX.message("PAYMENT_PAID_"+a));BX.addClass(b,"notpay")}};BX.Sale.Admin.OrderPayment.prototype.changePaidStatus=function(a){var c=BX("BUTTON_PAID_"+this.index);var b=BX("BUTTON_PAID_"+this.index+"_SHORT");if(c){BX.html(c,BX.message("PAYMENT_PAID_"+a));BX.removeClass(c,"notpay")}if(b){BX.html(b,BX.message("PAYMENT_PAID_"+a));BX.removeClass(b,"notpay")}};BX.Sale.Admin.OrderPayment.prototype.initNotPaidPopup=function(){var c=[this.index];if(this.viewForm){c.push(this.index+"_SHORT")}for(var b in c){if(!c.hasOwnProperty(b)){continue}var d=[{ID:"PAID",TEXT:BX.message("PAYMENT_PAID_YES"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showWindowPaidPayment()}else{var e=BX("PAYMENT_PAID_"+c[b]);if(e){e.value="Y"}this.changePaidStatus("YES")}},this)}];if(!this.viewForm){d.unshift({ID:"NOT_PAID",TEXT:BX.message("PAYMENT_PAID_NO"),ONCLICK:BX.proxy(function(){this.changeNotPaidStatus("NO");var e=BX("PAYMENT_PAID_"+c[b]);if(e){e.value="N"}},this)})}var a=new BX.COpener({DIV:BX("BUTTON_PAID_"+c[b]).parentNode,MENU:d})}};BX.Sale.Admin.OrderPayment.prototype.initPaidPopup=function(){var b=BX.findChildrenByClassName(BX("PAYMENT_BLOCK_STATUS_INFO_"+this.index),"not_paid",true);var e=BX.findChildrenByClassName(BX("PAYMENT_BLOCK_STATUS_INFO_"+this.index),"return",true);var d=[this.index];if(this.viewForm){d.push(this.index+"_SHORT")}var f=[{ID:"CANCEL",TEXT:BX.message("PAYMENT_PAID_CANCEL"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showReturnWindow("cancel")}else{var j=BX("PAYMENT_PAID_"+d[c]);if(j){j.value="N"}var h=BX("PAYMENT_IS_RETURN_"+d[c]);if(h){h.value="N"}var g=BX("OPERATION_ID_"+this.index);if(g){g.disabled=true}this.changeNotPaidStatus("NO");for(var k in b){if(!b.hasOwnProperty(k)){continue}BX.style(b[k],"display","table-row")}for(var k in e){if(!e.hasOwnProperty(k)){continue}BX.style(e[k],"display","none")}}},this)}];if(Object.keys(this.psToReturn).length>0){f.push({ID:"RETURN",TEXT:BX.message("PAYMENT_PAID_RETURN"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showReturnWindow("return")}else{if(BX("PAYMENT_PAID_"+d[c])){BX("PAYMENT_PAID_"+d[c]).value="N"}var g=BX("OPERATION_ID_"+this.index);if(g){g.disabled=false}var h=BX("PAYMENT_IS_RETURN_"+d[c]);if(h){h.value="Y"}this.changeNotPaidStatus("NO");for(var j in b){if(!b.hasOwnProperty(j)){continue}BX.style(b[j],"display","table-row")}for(var j in e){if(!e.hasOwnProperty(j)){continue}BX.style(e[j],"display","table-row")}BX.bind(BX("OPERATION_ID_"+this.index),"change",function(){var k=BX.findParent(this,{tag:"tr"});if(k){var i=(this.value!="Y")?"none":"table-row";BX.style(k.nextElementSibling,"display",i)}})}},this)})}if(!this.viewForm){f.unshift({ID:"PAID",TEXT:BX.message("PAYMENT_PAID_YES"),ONCLICK:BX.proxy(function(){if(this.viewForm){this.showWindowPaidPayment()}else{var h=BX("PAYMENT_PAID_"+d[c]);if(h){h.value="Y"}this.changePaidStatus("YES");var g=BX("OPERATION_ID_"+this.index);if(g){g.options[g.selectedIndex].value=""}for(var j in b){if(!b.hasOwnProperty(j)){continue}BX.style(b[j],"display","none")}for(var j in e){if(!e.hasOwnProperty(j)){continue}BX.style(e[j],"display","none")}}},this)})}for(var c in d){if(!d.hasOwnProperty(c)){continue}var a=new BX.COpener({DIV:BX("BUTTON_PAID_"+d[c]).parentNode,MENU:f})}};BX.Sale.Admin.OrderPayment.prototype.setPrice=function(a){var b=BX("PAYMENT_SUM_1");if(b&&BX.Sale.Admin.OrderEditPage.autoPriceChange){b.value=parseFloat(a).toFixed(2)}};BX.Sale.Admin.OrderPayment.prototype.getCreateOrderFieldsUpdaters=function(){return{PRICE:BX.Sale.Admin.OrderPayment.prototype.setPrice}};BX.Sale.Admin.OrderPayment.prototype.showCreateCheckWindow=function(a){ShowWaitWindow();var b={action:"addCheckPayment",paymentId:a,callback:BX.proxy(function(c){CloseWaitWindow();if(c.ERROR&&c.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(c.ERROR)}else{var e=c.HTML;var d=new BX.CAdminDialog({content:e,title:BX.message("PAYMENT_CASHBOX_CHECK_ADD_WINDOW_TITLE"),resizable:false,draggable:false,height:"100",width:"516",buttons:[{title:top.BX.message("JS_CORE_WINDOW_SAVE"),id:"saveCheckBtn",name:"savebtn",className:top.BX.browser.IsIE()&&top.BX.browser.IsDoctype()&&!top.BX.browser.IsIE10()?"":"adm-btn-save"},{title:top.BX.message("JS_CORE_WINDOW_CANCEL"),id:"cancelCheckBtn",name:"cancel"}]});d.Show();BX.bind(BX("checkTypeSelect"),"change",function(){var l=this.value;var k=l.indexOf("advance")!==-1;var j=BX.findParent(this,{tag:"tr"});var m=j.nextElementSibling;var g=BX.findChildren(m,{tag:"input"},true);for(var f in g){if(g.hasOwnProperty(f)){var h=g[f].nextElementSibling;if(k){BX.addClass(h,"bx-admin-service-restricted")}else{BX.removeClass(h,"bx-admin-service-restricted")}if(g[f].checked){g[f].click()}g[f].disabled=k}}});BX.bind(BX("cancelCheckBtn"),"click",BX.delegate(function(){d.Close();d.DIV.parentNode.removeChild(d.DIV)}),this);BX.bind(BX("saveCheckBtn"),"click",BX.delegate(function(){ShowWaitWindow();var g=BX("check_payment");var f={formData:BX.ajax.prepareForm(g),action:"saveCheck",sessid:BX.bitrix_sessid()};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_order_ajax.php",data:f,onsuccess:function(h){CloseWaitWindow();if(h.ERROR&&h.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(h.ERROR)}else{BX("PAYMENT_CHECK_LIST_ID_"+a).innerHTML=h.CHECK_LIST_HTML;if(BX("PAYMENT_CHECK_LIST_ID_SHORT_VIEW"+a)!==undefined&&BX("PAYMENT_CHECK_LIST_ID_SHORT_VIEW"+a)!==null){BX("PAYMENT_CHECK_LIST_ID_SHORT_VIEW"+a).innerHTML=h.CHECK_LIST_HTML}d.Close();d.DIV.parentNode.removeChild(d.DIV)}},onfailure:function(h){CloseWaitWindow()}})}),this)}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(b,true)};BX.Sale.Admin.OrderPayment.prototype.onCheckEntityChoose=function(b,g){var f=b.checked;var e=BX(b.id+"_type");if(e){e.disabled=!f}if(!g){var d=BX.findParent(b,{tag:"table"});var a=BX.findChildren(d,{tag:"input"},true);for(var c in a){if(a.hasOwnProperty(c)){if(a[c].id===b.id){continue}a[c].disabled=f}}}};BX.Sale.Admin.OrderPayment.prototype.sendQueryCheckStatus=function(a){ShowWaitWindow();var b={action:"sendQueryCheckStatus",checkId:a,callback:BX.proxy(function(d){if(d.ERROR&&d.ERROR.length>0){BX.Sale.Admin.OrderEditPage.showDialog(d.ERROR)}else{CloseWaitWindow();var c=d.PAYMENT_ID;BX("PAYMENT_CHECK_LIST_ID_"+c).innerHTML=d.CHECK_LIST_HTML;if(BX("PAYMENT_CHECK_LIST_ID_SHORT_VIEW"+c)!==undefined&&BX("PAYMENT_CHECK_LIST_ID_SHORT_VIEW"+c)!==null){BX("PAYMENT_CHECK_LIST_ID_SHORT_VIEW"+c).innerHTML=d.CHECK_LIST_HTML}}},this)};BX.Sale.Admin.OrderAjaxer.sendRequest(b,true)};BX.namespace("BX.Sale.Admin.GeneralPayment");BX.Sale.Admin.GeneralPayment={addNewPayment:function(e,d){var c=BX("ID");if(d=="edit"){var a=BX.findParent(e,{tag:"div"});var g=BX.findChildrenByClassName(a,"adm-bus-pay",true);var f=BX.Sale.Admin.OrderEditPage.getAllFormData();var b={method:"POST",action:"createNewPayment",index:parseInt(g.length)+1,formData:f,callback:function(h){var i=BX.processHTML(h.PAYMENT);var j=BX.create("div");j.innerHTML=i.HTML;a.insertBefore(j,e);BX.evalGlobal(i.SCRIPT[0]["JS"]);BX.Sale.Admin.OrderEditPage.unRegisterFieldUpdater("PRICE",BX.Sale.Admin.OrderPayment.prototype.setPrice)}};BX.Sale.Admin.OrderAjaxer.sendRequest(b)}else{window.location="sale_order_payment_edit.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&order_id="+c.value+"&backurl="+encodeURIComponent(window.location.pathname+window.location.search)}},useCurrentBudget:function(b){var c=BX("PAYMENT_INNER_BUDGET_ID");var h=BX("PAY_SYSTEM_ID_1");h.value=c.value;var e=BX("LOGOTIP_1");e.src=logoList[c.value];var a=BX("sale-order-financeinfo-payable");var d=BX("sale-order-financeinfo-user-budget-input");var i=parseFloat(a.value);var g=parseFloat(d.value);var f=i;if(g<i){f=g}BX.Sale.Admin.OrderEditPage.autoPriceChange=true;BX.Sale.Admin.OrderPayment.prototype.setPrice(f);BX.Sale.Admin.OrderEditPage.autoPriceChange=false;BX.Sale.Admin.OrderEditPage.showDialog(BX.message.PAYMENT_USE_INNER_BUDGET);BX.hide(b)}};