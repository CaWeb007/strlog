BX.namespace("BX.Sale.Admin.OrderBasket");BX.Sale.Admin.OrderBasket=function(c){var b,a;this.tableId=c.tableId;this.objName=c.objName;this.idPrefix=c.idPrefix;this.productMenu=c.productMenu;this.columnsCount=c.columnsCount;this.visibleColumns=c.visibleColumns;this.isShowXmlId=c.isShowXmlId;this.weightUnit=c.weightUnit;this.productsCount=0;this.customPrices={};this.createBasketBottom=c.createBasketBottom||false;this.createProductBasement=c.createProductBasement||false;this.discounts=c.discounts||false;this.iblocksSkuParams=c.iblocksSkuParams||{};this.iblocksSkuParamsOrder=c.iblocksSkuParamsOrder||{};this.mode=c.mode||"edit";this.unRemovableFields=c.unRemovableFields||[];this.formatQuantity=c.formatQuantity;this.qantityUpdaterTimeout=0;this.qantityUpdaterDelay=750;this.canSendUpdateQuantityRequest=true;this.lastChangedQuantity=false;if(c.iblocksSkuParams){for(b in c.iblocksSkuParams){if(c.iblocksSkuParams.hasOwnProperty(b)){this.setIblocksSkuParams(b,c.iblocksSkuParams[b])}}}this.fieldsUpdaters={};if(!this.products){this.products={}}if(c.productsOrder&&c.productsOrder.length){for(b=0,a=c.productsOrder.length-1;b<=a;b++){if(!!c.products[c.productsOrder[b]]){this.productSet(c.products[c.productsOrder[b]],true)}}}if(this.createBasketBottom){this.createBottomRow()}if(this.discounts){this.setDiscounts(this.discounts)}if(c.totalBlockFields){this.totalBlock=new BX.Sale.Admin.OrderBasketEditTotal({fields:c.totalBlockFields,weightUnit:this.weightUnit})}};BX.Sale.Admin.OrderBasket.prototype.getFieldsUpdaters=function(){return{SUM_PAID:{context:this,callback:this.setSumPaid},PAYABLE:{context:this,callback:this.setSumUnPaid},TOTAL_PRICES:{context:this,callback:this.setTotalPrices},DELIVERY_PRICE:{context:this,callback:this.setDeliveryPrice},DELIVERY_PRICE_DISCOUNT:{context:this,callback:this.setDeliveryPriceDiscount},BASKET:{context:this,callback:this.setBasket},DISCOUNTS_LIST:{context:this,callback:this.setDiscounts}}};BX.Sale.Admin.OrderBasket.prototype.setBasket=function(c){if(!c){return}var b,a;if(c.IBLOCKS_SKU_PARAMS){for(b in c.IBLOCKS_SKU_PARAMS){if(c.IBLOCKS_SKU_PARAMS.hasOwnProperty(b)){this.setIblocksSkuParams(b,c.IBLOCKS_SKU_PARAMS[b])}}}if(c.IBLOCKS_SKU_PARAMS_ORDER){for(b in c.IBLOCKS_SKU_PARAMS_ORDER){if(c.IBLOCKS_SKU_PARAMS_ORDER.hasOwnProperty(b)){this.setIblocksSkuParamsOrder(b,c.IBLOCKS_SKU_PARAMS_ORDER[b])}}}if(c.ITEMS&&c.ITEMS_ORDER&&c.ITEMS_ORDER.length){for(b=0,a=c.ITEMS_ORDER.length-1;b<=a;b++){if(!!c.ITEMS[c.ITEMS_ORDER[b]]){this.productSet(c.ITEMS[c.ITEMS_ORDER[b]],true)}}}else{this.showEmptyRow()}this.hideLoadingRow()};BX.Sale.Admin.OrderBasket.prototype.setTotalPrices=function(a){this.totalBlock.setFieldValue("SUM_PAID",a.SUM_PAID);this.totalBlock.setFieldValue("SUM_UNPAID",a.SUM_UNPAID)};BX.Sale.Admin.OrderBasket.prototype.setDeliveryPrice=function(a){this.totalBlock.setFieldValue("PRICE_DELIVERY",a)};BX.Sale.Admin.OrderBasket.prototype.setDeliveryPriceDiscount=function(a){this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",a)};BX.Sale.Admin.OrderBasket.prototype.setSumPaid=function(a){this.totalBlock.setFieldValue("SUM_PAID",a)};BX.Sale.Admin.OrderBasket.prototype.setSumUnPaid=function(a){this.totalBlock.setFieldValue("SUM_UNPAID",a)};BX.Sale.Admin.OrderBasket.prototype.showEmptyRow=function(){var a=BX(this.idPrefix+"sale-adm-order-edit-basket-empty-row");if(a){a.style.display=""}};BX.Sale.Admin.OrderBasket.prototype.hideEmptyRow=function(){var a=BX(this.idPrefix+"sale-adm-order-edit-basket-empty-row");if(a){a.style.display="none"}};BX.Sale.Admin.OrderBasket.prototype.hideLoadingRow=function(){var a=BX(this.idPrefix+"sale-adm-order-basket-loading-row");if(a){a.style.display="none"}};BX.Sale.Admin.OrderBasket.prototype.createBottomRow=function(e){if(!this.createBasketBottom){return}var d=BX(this.tableId),c=BX.create("td",{html:'<strong style="margin-left: 10px;">'+BX.message("SALE_ORDER_BASKET_PROD_COUNT")+':&nbsp;<span id="'+this.idPrefix+'sale-order-basket-products-count">'+this.productsCount+"</span></strong>"}),b=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-bottom-discounts"}}),a=BX.create("tbody",{props:{id:this.idPrefix+"sale-order-basket-bottom"},style:{textAlign:"left",borderBottom:"1px solid #DDD"},children:[BX.create("tr",{children:[c,b]})]});c.colSpan=this.mode=="view"?1:2;b.colSpan=this.columnsCount-1;d.appendChild(a)};BX.Sale.Admin.OrderBasket.prototype.setDiscounts=function(b){this.discounts=b;var f=BX(this.idPrefix+"sale-order-basket-bottom-discounts"),d=[];if(!b||!b.ORDER||!b.ORDER.DISCOUNT_LIST){return}for(var e=0,c=b.ORDER.DISCOUNT_LIST.length;e<c;e++){var a=b.ORDER.DISCOUNT_LIST[e];if(b.DISCOUNT_LIST&&b.DISCOUNT_LIST[a]&&b.DISCOUNT_LIST[a].ACTIONS_DESCR&&b.DISCOUNT_LIST[a].ACTIONS_DESCR.BASKET){d[e]=b.DISCOUNT_LIST[a];d[e].DESCR=b.DISCOUNT_LIST[a].ACTIONS_DESCR.BASKET}}if(f&&d){f=BX.cleanNode(f,false);f.appendChild(this.createDiscountsNodeBasket(d))}};BX.Sale.Admin.OrderBasket.prototype.createDiscountsNodeBasket=function(a){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DISCOUNT_LIST",a,this.discounts,"VIEW")};BX.Sale.Admin.OrderBasket.prototype.getProductBasketCode=function(a){if(!a.BASKET_CODE){if(a.IS_SET_ITEM=="Y"){var b=new Date();a.BASKET_CODE="set_"+b.getTime()+Math.floor(Math.random()*1000)}else{BX.debug("product.BASKET_CODE is undefined!")}}return a.BASKET_CODE};BX.Sale.Admin.OrderBasket.prototype.setProductsCount=function(b){if(!this.createBasketBottom){return}var a=BX(this.idPrefix+"sale-order-basket-products-count");if(a){a.innerHTML=b}};BX.Sale.Admin.OrderBasket.prototype.productAdd=function(d){var a=this.getProductBasketCode(d),b=BX(this.createProductRowId(a,d));if(b){return}if(parseFloat(d.PRICE)!=parseFloat(d.BASE_PRICE)&&d.CUSTOM_PRICE&&d.CUSTOM_PRICE=="Y"){this.customPrices[a]=d.PRICE}b=this.createProductRow(a,d);var c=BX(this.tableId);if(this.createBasketBottom&&(bottom=BX(this.idPrefix+"sale-order-basket-bottom"))){c.insertBefore(b,bottom)}else{c.appendChild(b)}};BX.Sale.Admin.OrderBasket.prototype.productSet=function(c,d){var b=this.getProductBasketCode(c);if(this.productsCount<=0){this.hideEmptyRow()}if(BX(this.createProductRowId(b,c))){if(d){this.productReplace(c,b)}else{this.setProductQuantity(b,this.roundQuantity(parseFloat(this.getProductQuantity(b))+parseFloat(c.QUANTITY)))}}else{this.productAdd(c);if(c.IS_SET_ITEM!="Y"){this.setProductsCount(++this.productsCount)}}if(c.SET_ITEMS&&c.SET_ITEMS.length){for(var a=c.SET_ITEMS.length-1;a>=0;a--){c.SET_ITEMS[a].BASKET_CODE="set_"+c.BASKET_CODE+"_"+c.SET_ITEMS[a].OFFER_ID;this.productSet(c.SET_ITEMS[a],true)}}this.setRowNumbers()};BX.Sale.Admin.OrderBasket.prototype.productReplace=function(c,e){var d=BX(this.createProductRowId(e,c));if(!d){return}this.onProductDelete(e);var b=this.getProductBasketCode(c),a=this.createProductRow(b,c);if(!a){return}if(!BX.hasClass(d,"basket-bundle-child-hidden")){BX.removeClass(a,"basket-bundle-child-hidden")}d.parentNode.replaceChild(a,d);this.setRowNumbers()};BX.Sale.Admin.OrderBasket.prototype.onProductDelete=function(a){BX.Sale.Admin.OrderEditPage.unRegisterProductFieldsUpdaters(a)};BX.Sale.Admin.OrderBasket.prototype.roundQuantity=function(a){if(this.formatQuantity=="AUTO"||parseInt(this.formatQuantity)<=0){a=Math.round(a*10000)/10000}else{a=Math.round(a*Math.pow(10,this.formatQuantity))/Math.pow(10,this.formatQuantity)}return a};BX.Sale.Admin.OrderBasket.prototype.getDiscountCellId=function(a){return this.idPrefix+"sale-order-basket-product-"+a+"-discount-cell"};BX.Sale.Admin.OrderBasket.prototype.createDiscountCell=function(c,e){var d=BX.create("text",{html:"&nbsp"}),b=false,a=e.SKU_PROPS&&Object.keys(e.SKU_PROPS).length>0;if(this.discounts&&this.discounts.RESULT&&this.discounts.RESULT.BASKET){d=BX.Sale.Admin.OrderEditPage.createDiscountsNode(c,"BASKET",this.discounts.RESULT.BASKET[c]?this.discounts.RESULT.BASKET[c]:{},this.discounts,"VIEW");b=this.discounts.RESULT.BASKET[c]?true:false}var f=BX.create("td",{props:{id:this.getDiscountCellId()},children:[BX.create("div",{children:[d]})]});f.colSpan=this.columnsCount-1;if(a||b){f.style.borderTop="1px solid #ddd"}return f};BX.Sale.Admin.OrderBasket.prototype.setIblocksSkuParamsOrder=function(c,e){if(!this.iblocksSkuParamsOrder){this.iblocksSkuParamsOrder={}}if(!this.iblocksSkuParamsOrder[c]){this.iblocksSkuParamsOrder[c]=[]}if(e){for(var b in e){if(!e.hasOwnProperty(b)){continue}var d=false;for(var a in this.iblocksSkuParamsOrder[c]){if(!this.iblocksSkuParamsOrder[c].hasOwnProperty(a)){continue}if(this.iblocksSkuParamsOrder[c][a]==e[b]){d=true;break}}if(!d){this.iblocksSkuParamsOrder[c][b]=e[b]}}}};BX.Sale.Admin.OrderBasket.prototype.setIblocksSkuParams=function(c,d){if(!this.iblocksSkuParams){this.iblocksSkuParams={}}if(!this.iblocksSkuParams[c]){this.iblocksSkuParams[c]={}}if(d){for(var b in d){if(!d.hasOwnProperty(b)){continue}if(this.iblocksSkuParams[c][b]!==undefined&&this.iblocksSkuParams[c][b]["VALUES"]!==undefined&&d[b]["VALUES"]!==undefined){for(var a in d[b]["VALUES"]){if(d[b]["VALUES"].hasOwnProperty(a)){this.iblocksSkuParams[c][b]["VALUES"][a]=d[b]["VALUES"][a]}}}else{this.iblocksSkuParams[c][b]=d[b]}}}};BX.Sale.Admin.OrderBasket.prototype.createProductRowBasement=function(c,e){if(!this.createProductBasement){return}var a=null,d=BX.create("tr",{props:{id:this.idPrefix+"sale-order-basket-product-"+c+"-basement",className:"bdb-line"}}),f=this.createProductBasementSkuCell(c,e),b=this.createDiscountCell(c,e);if(f&&b){d.appendChild(f);d.appendChild(b);a=d}return a};BX.Sale.Admin.OrderBasket.prototype.createProductBasementSkuCell=function(b,c){var d=this.createSkuPropsTable(b,c),a=null;if(d){a=BX.create("td",{children:[d]})}return a};BX.Sale.Admin.OrderBasket.prototype.createProductRowId=function(a,b){var c=this.idPrefix+"sale-order-basket-product-"+a;if(b){if(b.IS_SET_ITEM=="Y"&&b.PARENT_OFFER_ID){c+="-"+b.PARENT_OFFER_ID}}return c};BX.Sale.Admin.OrderBasket.prototype.createProductRow=function(a,i){var b,d=BX.create("tbody",{props:{id:this.createProductRowId(a,i)},style:{textAlign:"left",borderBottom:"1px solid #DDD"}}),j=this.createMenuCell(a,i),f=BX.create("tr");if(j){if(this.createProductBasement){j.rowSpan=2}f.appendChild(j)}var h,c=[];if(i.IS_SET_ITEM!="Y"){c=this.createHiddenFields(a,i);this.products[a]=i;d.setAttribute("data-basket-code",a);if(i.IS_SET_PARENT&&i.OLD_PARENT_ID){d.setAttribute("data-old-parent-id-parent",i.OLD_PARENT_ID)}}else{BX.addClass(d,"bundle-child-"+i.OLD_PARENT_ID);BX.addClass(d,"basket-bundle-child-hidden");BX.addClass(d,"bundle-child")}for(var e in this.visibleColumns){if(!this.visibleColumns.hasOwnProperty(e)){continue}b=this.createProductCell(a,i,e);if(b){if(c){while(h=c.pop()){b.appendChild(h)}}f.appendChild(b)}}f.setAttribute("onmouseover",this.objName+".onProductRowMouseOver(this);");f.setAttribute("onmouseout",this.objName+".onProductRowMouseOut(this);");d.appendChild(f);if((this.createProductBasement&&((i.SKU_PROPS||(i.PROPS&&i.PROPS.length>0&&this.mode=="view"))&&i.IS_SET_ITEM!="Y"))||i.DISCOUNTS){var g=this.createProductRowBasement(a,i);if(g){d.appendChild(g)}}return d};BX.Sale.Admin.OrderBasket.prototype.createHiddenFields=function(a,b){return[]};BX.Sale.Admin.OrderBasket.prototype.createMenuCell=function(c,d){var b,a=this.createProductMenuContent(c,d);if(a.length<=0){return false}if(d.IS_SET_ITEM!="Y"){b=BX.create("span",{props:{className:"adm-s-order-item-title-icon"}});BX.bind(b,"click",BX.proxy(function(f){b.blur();BX.adminList.ShowMenu(b,a)},this))}else{b=BX.create("span",{html:"&nbsp;"})}return BX.create("td",{props:{className:"tac bdb-line",id:this.idPrefix+"sale-order-basket-product-"+c+"-menu"},children:[b]})};BX.Sale.Admin.OrderBasket.prototype.onHeadMenu=function(a){BX.adminList.ShowMenu(a,[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_ROW_SETTINGS"),ACTION:this.objName+".onSettings()",DEFAULT:true}])};BX.Sale.Admin.OrderBasket.prototype.setRowNumbers=function(){if(!this.visibleColumns.NUMBER){return}var f=BX(this.tableId),d="",e=null,b=1;for(var c=0,a=f.tBodies.length;c<a;c++){if(BX.hasClass(f.tBodies[c],"bundle-child")){continue}d=f.tBodies[c].getAttribute("data-basket-code");if(!d){continue}e=BX(this.idPrefix+"sale_order_product_"+d+"_number");if(e){e.innerHTML=b++}else{BX.debug("BX.Sale.Admin.OrderBasket.prototype.setRowNumbers can't find: "+d)}}};BX.Sale.Admin.OrderBasket.prototype.getPriceCellId=function(a){return this.idPrefix+"sale-order-basket-product-"+a+"-price-cell"};BX.Sale.Admin.OrderBasket.prototype.getProductSummCellId=function(a){return this.idPrefix+"sale_order_edit_product_"+a+"_summ"};BX.Sale.Admin.OrderBasket.prototype.getQuantityCellId=function(a){return this.idPrefix+"sale-order-basket-product-"+a+"-quantity-cell"};BX.Sale.Admin.OrderBasket.prototype.createProductCell=function(t,b,o){var f=null,r=[],e=b[o],h="",p=this,a=(BX.type.isNotEmptyString(b.IS_SET_ITEM)&&b.IS_SET_ITEM==="Y");switch(o){case"NUMBER":r.push(BX.create("span",{props:{id:!a?this.idPrefix+"sale_order_product_"+t+"_number":"&nbsp;"},html:"&nbsp;"}));break;case"NAME":if(b.IS_SET_PARENT=="Y"&&b.SET_ITEMS){var j=BX.create("a",{props:{href:"javascript:void(0);",className:"dashed-link show-set-link"},html:BX.message("SALE_ORDER_BASKET_EXPAND")});BX.bind(j,"click",function(w){var i=w.target||w.srcElement;p.onToggleBundleChildren(b.OLD_PARENT_ID,i)});r.push(BX.create("div",{children:[j]}))}if(b.EDIT_PAGE_URL){if(!e){e=BX.message("SALE_ORDER_BASKET_NO_NAME")}n=BX.create("a",{props:{href:b.EDIT_PAGE_URL,target:"_blank"},html:BX.util.htmlspecialchars(e)})}else{var v=b[o]?b[o]:BX.message("SALE_ORDER_BASKET_NO_NAME");n=BX.create("span",{style:{fontWeight:"bold"},html:BX.util.htmlspecialchars(v)})}r.push(n);if(b.RECOMMENDATION&&b.RECOMMENDATION.length>0){r.push(BX.create("div",{props:{className:"bx-adm-bigdata-icon-medium-inner"}}))}break;case"QUANTITY":if(typeof b.MEASURE_TEXT!="undefined"){r.push(document.createTextNode(" "+b.MEASURE_TEXT+" "))}b.QUANTITY=this.roundQuantity(parseFloat(b.QUANTITY));if(a){n=BX.Sale.Admin.OrderBasket.prototype.createFieldQuantity(t,b,o);n.id=this.getQuantityCellId(t);r.push(n)}else{r.push(this.createFieldQuantity(t,b,o))}break;case"AVAILABLE":r.push(this.createTextField(t,b,o));break;case"PRICE":if(a){r.push(BX.Sale.Admin.OrderBasket.prototype.createFieldPrice(t,b,o))}else{var d=this.createFieldPrice(t,b,o);d.id=this.getPriceCellId(t);r.push(d)}break;case"SUM":var q;if(typeof(this.customPrices[t])=="undefined"){q=b.PRICE}else{q=this.customPrices[t]}var c=q*b.QUANTITY;r.push(BX.create("strong",{props:{id:this.getProductSummCellId(t)},html:BX.Sale.Admin.OrderEditPage.currencyFormat(c),style:{whiteSpace:"nowrap"}}));break;case"IMAGE":r.push(this.createFieldImage(t,b,o));h="adm-s-order-table-ddi-table-img";break;case"PROPS":var n=this.createFieldSkuProps(t,b,o);if(n){r.push(n)}break}if(o.indexOf("PROPERTY_")===0){var g="",l=o.substr("PROPERTY_".length);if(b.PRODUCT_PROPS_VALUES&&b.PRODUCT_PROPS_VALUES[o+"_VALUE"]){var m=[b.OFFERS_IBLOCK_ID,b.IBLOCK_ID];for(var k in m){if(!m.hasOwnProperty(k)){continue}var u=m[k];if(!u){continue}if(this.iblocksSkuParams[u]){for(var s in this.iblocksSkuParams[u]){if(!this.iblocksSkuParams[u].hasOwnProperty(s)){continue}if(this.iblocksSkuParams[u][s].CODE!=l){continue}if(!this.iblocksSkuParams[u][s].VALUES[b.PRODUCT_PROPS_VALUES[o+"_VALUE"]]){continue}if(this.iblocksSkuParams[u][s].VALUES[b.PRODUCT_PROPS_VALUES[o+"_VALUE"]]["NAME"]&&this.iblocksSkuParams[u][s].VALUES[b.PRODUCT_PROPS_VALUES[o+"_VALUE"]]["NAME"].length>0){g=this.iblocksSkuParams[u][s].VALUES[b.PRODUCT_PROPS_VALUES[o+"_VALUE"]]["NAME"]}else{g=b.PRODUCT_PROPS_VALUES[o+"_VALUE"]}if(g){g=BX.util.htmlspecialchars(g)}break}if(g.length>0){break}}}if(g.length<=0){g=b.PRODUCT_PROPS_VALUES[o+"_VALUE"]}}else{g=""}r.push(BX.create("span",{html:g}))}if(r.length>0){f=BX.create("td");if(h){BX.addClass(f,h)}while(r.length>0){f.appendChild(r.pop())}if(o=="NAME"){f.style.minWidth="250px";if(a){f.style.fontStyle="italic";f.style.paddingLeft="40px"}}}return f};BX.Sale.Admin.OrderBasket.prototype.onToggleBundleChildren=function(d,b){if(b.innerHTML==BX.message("SALE_ORDER_BASKET_TURN")){b.innerHTML=BX.message("SALE_ORDER_BASKET_EXPAND")}else{b.innerHTML=BX.message("SALE_ORDER_BASKET_TURN")}var a=BX.findChildren(BX(this.tableId),{className:"bundle-child-"+d},true);for(var c in a){if(a.hasOwnProperty(c)){BX.toggleClass(a[c],"basket-bundle-child-hidden")}}};BX.Sale.Admin.OrderBasket.prototype.createFieldSkuProps=function(b,c,a){return this.createSkuPropsTable(b,c)};BX.Sale.Admin.OrderBasket.prototype.createSkuPropsTable=function(a,h){var j=BX.create("table"),d,e=0,b=[];if(h.SKU_PROPS){for(var g in h.SKU_PROPS){if(!h.SKU_PROPS.hasOwnProperty(g)){continue}if(!h.SKU_PROPS[g]["VALUE"]){continue}if(h.SKU_PROPS[g]["VALUE"]["ID"]=="-"){continue}if(h.SKU_PROPS[g]["VALUE"]&&h.SKU_PROPS[g]["VALUE"]["PICT"]){d='<div style="width: 17px; height: 17px; text-align: center; border: 1px solid gray;"><img  width="17" height="17" src="'+h.SKU_PROPS[g]["VALUE"]["PICT"]+'"></div>'}else{if(!h.SKU_PROPS[g]["VALUE"]["NAME"]){h.SKU_PROPS[g]["VALUE"]["NAME"]=g}d='<div style="font-size: 9px; padding: 2px 5px; text-align: center; border: 1px solid gray;">'+BX.util.htmlspecialchars(h.SKU_PROPS[g]["VALUE"]["NAME"])+"</div>"}if(!h.SKU_PROPS[g]["NAME"]){h.SKU_PROPS[g]["NAME"]=g}j.appendChild(BX.create("tr",{children:[BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(h.SKU_PROPS[g]["NAME"])+": </span>"}),BX.create("td",{html:d})]}));b.push(h.SKU_PROPS[g]["CODE"]);e++}}if(h.PROPS){for(var c in h.PROPS){if(!h.PROPS.hasOwnProperty(c)){continue}if(!h.PROPS[c]||b.indexOf(h.PROPS[c]["CODE"])!=-1){continue}if(!h.PROPS[c]["NAME"]){h.PROPS[c]["NAME"]=""}if(!h.PROPS[c]["VALUE"]){h.PROPS[c]["VALUE"]=""}var f=BX.create("tr",{children:[BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(h.PROPS[c]["NAME"])+": </span>"}),BX.create("td",{html:'<div style="font-size: 9px; padding: 2px 5px; text-align: center;">'+BX.util.htmlspecialchars(h.PROPS[c]["VALUE"])+"</div>"})]});if(!this.isShowXmlId&&(h.PROPS[c]["CODE"]=="PRODUCT.XML_ID"||h.PROPS[c]["CODE"]=="CATALOG.XML_ID")){f.style.display="none"}j.appendChild(f);e++}}return j};BX.Sale.Admin.OrderBasket.prototype.createFieldQuantity=function(b,c,a){return this.createTextField(b,c,a)};BX.Sale.Admin.OrderBasket.prototype.createFieldImage=function(c,d,b){var e,a;if(d.PICTURE_URL){e=BX.create("img",{props:{src:d.PICTURE_URL}})}else{e=BX.create("div",{props:{className:"no_foto"},text:BX.message("SALE_ORDER_BASKET_NO_PICTURE")})}if(typeof d.EDIT_PAGE_URL!="undefined"){a=BX.create("a",{props:{href:d.EDIT_PAGE_URL?d.EDIT_PAGE_URL:"",target:"_blank"},children:[e]});a.style.textAlign=(this.mode=="edit"?"left":"center")}else{a=BX.create("div",{style:{width:"150px",textAlign:this.mode=="edit"?"left":"center"},children:[e]})}return a};BX.Sale.Admin.OrderBasket.prototype.createFieldPrice=function(e,g,c){var b=BX.create("span",{props:{className:"view_price"}}),f="";if(typeof g.PRICE!="undefined"){f=BX.Sale.Admin.OrderEditPage.currencyFormat(g.PRICE)}b.appendChild(BX.create("div",{html:f,style:{whiteSpace:"nowrap"}}));if(f!=""){var h="none";if(parseFloat(g.BASE_PRICE)>0&&parseFloat(g.PRICE)!=parseFloat(g.BASE_PRICE)){h=""}var d=BX.create("div",{props:{className:"base_price"},style:{display:h},children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(g.BASE_PRICE)})]}),a=BX.create("div",{props:{className:"base_price_title"},style:{display:(((g.CUSTOM_PRICE&&g.CUSTOM_PRICE=="Y")||g.NOTES)?"":"none")},text:((g.CUSTOM_PRICE&&g.CUSTOM_PRICE=="Y")?BX.message("SALE_ORDER_BASKET_BASE_CATALOG_PRICE"):g.NOTES)});b.appendChild(d);b.appendChild(a)}return b};BX.Sale.Admin.OrderBasket.prototype.createTextField=function(b,c,a){var d=typeof c[a]!="undefined"?c[a]:"";return BX.create("span",{text:d+" "})};BX.Sale.Admin.OrderBasket.prototype.onSettings=function(){this.settingsDialog.show()};BX.Sale.Admin.OrderBasket.prototype.createProductMenuContent=function(a,b){return[]};BX.Sale.Admin.OrderBasket.prototype.onProductRowMouseOver=function(a){BX.addClass(a,"tr_hover")};BX.Sale.Admin.OrderBasket.prototype.onProductRowMouseOut=function(a){BX.removeClass(a,"tr_hover")};BX.Sale.Admin.OrderBasketEdit=function(a){this.productEditDialog=new BX.Sale.Admin.OrderBasketProductEditDialog(this);BX.Sale.Admin.OrderBasket.call(this,a);this.settingsDialog=new BX.Sale.Admin.OrderBasket.SettingsDialog({basket:this})};BX.Sale.Admin.OrderBasketEdit.prototype=Object.create(BX.Sale.Admin.OrderBasket.prototype);BX.Sale.Admin.OrderBasketEdit.prototype.getProductIdBySkuProps=function(a){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.getProductIdBySkuProps(a))};BX.Sale.Admin.OrderBasketEdit.prototype.setBasket=function(c){if(!c){return}var b,a;if(c.IBLOCKS_SKU_PARAMS){for(b in c.IBLOCKS_SKU_PARAMS){if(c.IBLOCKS_SKU_PARAMS.hasOwnProperty(b)){this.setIblocksSkuParams(b,c.IBLOCKS_SKU_PARAMS[b])}}}if(c.IBLOCKS_SKU_PARAMS_ORDER){for(b in c.IBLOCKS_SKU_PARAMS_ORDER){if(c.IBLOCKS_SKU_PARAMS_ORDER.hasOwnProperty(b)){this.setIblocksSkuParamsOrder(b,c.IBLOCKS_SKU_PARAMS_ORDER[b])}}}if(typeof c.WEIGHT_FOR_HUMAN!=="undefined"){this.totalBlock.setFieldValue("WEIGHT",c.WEIGHT_FOR_HUMAN)}if(c.PRICES_UPDATED&&c.PRICES_UPDATED.length>0){for(b in c.PRICES_UPDATED){if(c.PRICES_UPDATED.hasOwnProperty(b)){this.updateProductPriceCell(c.ITEMS[b])}}for(b in c.ITEMS){if(c.ITEMS.hasOwnProperty(b)){this.updateProductDiscountsCell(c.ITEMS[b])}}if(c.NEW_ITEM_BASKET_CODE&&c.ITEMS[c.NEW_ITEM_BASKET_CODE]){this.productSet(c.ITEMS[c.NEW_ITEM_BASKET_CODE],true)}}else{if(c.LIGHT&&c.LIGHT=="Y"){for(b in this.products){if(!this.products.hasOwnProperty(b)){continue}if(typeof c.ITEMS[b]=="undefined"){this.productDelete(b)}}if(c.ADDED_PRODUCTS){for(b in c.ADDED_PRODUCTS){if(c.ADDED_PRODUCTS.hasOwnProperty(b)){this.productSet(c.ITEMS[c.ADDED_PRODUCTS[b]],true);delete (c.ITEMS[c.ADDED_PRODUCTS[b]])}}}if(c.ITEMS){for(b in c.ITEMS){if(c.ITEMS.hasOwnProperty(b)){this.productUpdateLight(c.ITEMS[b])}}}}else{if(c.ITEMS_ORDER&&c.ITEMS_ORDER.length){for(b in this.products){if(this.products.hasOwnProperty(b)){this.productDelete(b)}}for(b=0,a=c.ITEMS_ORDER.length-1;b<=a;b++){this.productSet(c.ITEMS[c.ITEMS_ORDER[b]],true)}}}}if(!c.ITEMS||!c.ITEMS_ORDER||!c.ITEMS_ORDER.length){this.showEmptyRow()}this.hideLoadingRow()};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductPriceCell=function(c){var a=this.getProductBasketCode(c),f=this.getPriceCellId(a),e=BX(f);if(!e){return}var d=this.createFieldPrice(a,c),b=e.parentNode;b.removeChild(e);b.appendChild(d);d.id=f;this.updateBasePrice(a,c);this.updateProviderData(a,c);this.updateProductSumm(a)};BX.Sale.Admin.OrderBasketEdit.prototype.updateBasePrice=function(b,d){var c=BX.Sale.Admin.OrderEditPage.getForm();var a=c.elements[this.getFieldName(b,"BASE_PRICE")];if(a){a.value=d.BASE_PRICE}var e=c.elements[this.getFieldName(b,"PRICE_BASE")];if(e){e.value=d.PRICE_BASE}};BX.Sale.Admin.OrderBasketEdit.prototype.updateProviderData=function(a,c){var b=BX.Sale.Admin.OrderEditPage.getForm(),d=b.elements[this.getFieldName(a,"PROVIDER_DATA")];if(d){d.value=c.PROVIDER_DATA}};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductDiscountsCell=function(e){var c=this.getProductBasketCode(e),f=this.getDiscountCellId(c),b=BX(f);if(!b){return}var d=this.createDiscountCell(c,e),a=b.parentNode;a.removeChild(b);a.appendChild(d);d.id=f};BX.Sale.Admin.OrderBasketEdit.prototype.productUpdateLight=function(c){var b=this.getProductBasketCode(c),a;c.NOTES=this.products[b]["NOTES"];this.updateProductPriceCell(c);this.updateProductDiscountsCell(c);this.canSendUpdateQuantityRequest=false;if(this.getProductQuantity(b)!=c.QUANTITY){this.setProductQuantity(b,c.QUANTITY)}if(this.getCustomPrice(b)!=c.CUSTOM_PRICE){this.setCustomPrice(b,c.CUSTOM_PRICE)}for(a in c){if(c.hasOwnProperty(a)){this.products[b][a]=c[a]}}if(c.SET_ITEMS){for(a in c.SET_ITEMS){if(c.SET_ITEMS.hasOwnProperty(a)){this.updateSetQuantity(c.SET_ITEMS[a],b)}}}this.canSendUpdateQuantityRequest=true};BX.Sale.Admin.OrderBasketEdit.prototype.updateSetQuantity=function(d,b){var a="set_"+b+"_"+d.OFFER_ID,e=BX(this.getQuantityCellId(a)),c=BX(this.getProductSummCellId(a));if(e){e.innerHTML=d.QUANTITY}if(c){c.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(d.QUANTITY*d.PRICE)}};BX.Sale.Admin.OrderBasketEdit.prototype.setCustomPrice=function(a,c){var b=BX.Sale.Admin.OrderEditPage.getForm();b.elements[this.getFieldName(a,"CUSTOM_PRICE")].value=c};BX.Sale.Admin.OrderBasketEdit.prototype.getCustomPrice=function(a){var b=BX.Sale.Admin.OrderEditPage.getForm();return b.elements[this.getFieldName(a,"CUSTOM_PRICE")].value};BX.Sale.Admin.OrderBasketEdit.prototype.getParamsBySkuProps=function(b){var a=false;if(this.customPrices[b.replaceBasketCode]!==undefined){a=this.customPrices[b.replaceBasketCode]}BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.addProductToBasketBySkuProps({oldProductId:b.oldProductId,oldProductIblock:b.oldProductIblock,quantity:b.quantity,replaceBasketCode:b.replaceBasketCode,skuPropsVal:b.skuPropsVal,columns:this.visibleColumns,customPrice:a}))};BX.Sale.Admin.OrderBasketEdit.prototype.getParamsByProductId=function(c,a,d){var b=false;if(this.customPrices[c.replaceBasketCode]!==undefined){b=this.customPrices[c.replaceBasketCode]}BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.addProductToBasket(c.id,c.quantity,c.replaceBasketCode,this.visibleColumns,b))};BX.Sale.Admin.OrderBasketEdit.prototype.createProductBasementSkuCell=function(a,j){var c=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-product-"+a+"-basement-sku"}}),e=BX.create("div",{props:{className:"adm-s-order-table-ddi-table-sku"}}),b=j.SKU_PROPS_POSSIBLE_VALUES,f,h;for(var d in this.iblocksSkuParamsOrder[j.OFFERS_IBLOCK_ID]){if(!this.iblocksSkuParamsOrder[j.OFFERS_IBLOCK_ID].hasOwnProperty(d)){continue}var g=this.iblocksSkuParamsOrder[j.OFFERS_IBLOCK_ID][d];if(!b[g]){continue}f=this.iblocksSkuParams[j.OFFERS_IBLOCK_ID][g]["NAME"];h=j.SKU_PROPS[g]["VALUE"]["ID"];e.appendChild(this.createSkuSelector(a,g,f,h,b[g],j))}c.appendChild(e);return c};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuSelector=function(v,c,w,q,p,a){var n=BX.create("ul",{attrs:{"data-sku-id":c}}),d="sku",b=0,l=0;for(var o in this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["ORDER"]){if(!this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["ORDER"].hasOwnProperty(o)){continue}var u=this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["ORDER"][o],k=false;for(var s in p){if(!p.hasOwnProperty(s)){continue}if(p[s]==this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["VALUES"][u]["ID"]){k=true;break}}if(!k){continue}var g,h=this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["VALUES"][u]["ID"];if(this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["VALUES"][u]["PICT"]){g='<img  src="'+this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["VALUES"][u]["PICT"]+'">'}else{d="size";g=BX.util.htmlspecialchars(this.iblocksSkuParams[a.OFFERS_IBLOCK_ID][c]["VALUES"][u]["NAME"])}var r=BX.create("span",{props:{className:"cnt"},html:g}),m=BX.create("li",{attrs:{"data-value":BX.util.htmlspecialchars(u),"data-id":h},children:[r]});if(h==q){BX.addClass(m,"bx-active");l=b}n.appendChild(m);BX.bind(r,"click",BX.delegate(function(A){var y=A.target||A.srcElement,x=y.parentNode.getAttribute("data-value")||y.parentNode.parentNode.getAttribute("data-value"),i=y.parentNode.getAttribute("data-id")||y.parentNode.parentNode.getAttribute("data-id"),z=this.getSkuProps(v,a.SKU_PROPS);x=BX.util.htmlspecialcharsback(x);if(i==q){return}z[c]=i;this.getProductIdBySkuProps({productId:a.PRODUCT_ID,iBlockId:a.OFFERS_IBLOCK_ID,skuProps:z,skuOrder:this.iblocksSkuParamsOrder[a.OFFERS_IBLOCK_ID],changedSkuId:c,callback:BX.delegate(function(B){if(!B.OFFER_ID){BX.debug("can't find product id for set of sku props");return}var C=B.OFFER_ID;for(var D in this.products){if(!this.products.hasOwnProperty(D)){continue}if(D==v){continue}if(this.products[D].OFFER_ID==C){if(!confirm(BX.message("SALE_ORDER_BASKET_POSITION_EXISTS").replace("#NAME#",this.products[D].NAME))){return}}}this.onSkuSelectorClick(v,n,c,x,i);this.onSkuPropSelect(v,C)},this)})},this));b++}var f=BX.create("div",{props:{className:"adm-s-item-detail-"+d+"-box-arrow left"},events:{click:BX.delegate(function(){this.skuSelectorScrollLeft(n,b)},this)}}),j=BX.create("div",{props:{className:"adm-s-item-detail-"+d+"-box-arrow right"},events:{click:BX.delegate(function(){this.skuSelectorScrollRight(n,b)},this)}});var e=BX.create("div",{props:{className:"adm-s-item-detail-sku"},children:[BX.create("div",{props:{className:"adm-s-item-detail-"+d+"-title"},text:w}),f,j,BX.create("div",{props:{className:"adm-s-item-detail-"+d+"-box"},children:[BX.create("div",{props:{className:"adm-s-item-detail-"+d+"-box-container"},children:[n,BX.create("input",{props:{type:"hidden",name:this.getFieldName(v,"SKU")+"["+c+"]",value:q}})]})]})]});var t=(-1)*this.skuSelectorCountScrollOffset(l,b);this.skuSelectorSetScroll(n,t);this.skuSelectorSetArrowsVisibility(n,t,b);return e};BX.Sale.Admin.OrderBasketEdit.prototype.getFieldsUpdaters=function(){return{TOTAL_PRICES:{context:this,callback:this.setTotalPrices},BASKET:{context:this,callback:this.setBasket},SUM_PAID:{context:this,callback:this.setSumPaid},PAYABLE:{context:this,callback:this.setSumUnPaid},TAX_VALUE:{context:this,callback:this.setTaxValue},DELIVERY_PRICE:{context:this,callback:this.setDeliveryPrice},DELIVERY_PRICE_DISCOUNT:{context:this,callback:this.setDeliveryPriceDiscount},"SHIPMENT[1][PRICE_DELIVERY]":{context:this,callback:this.setDeliveryPrice},COUPONS_LIST:{context:this,callback:this.setCoupons},DISCOUNTS_LIST:{context:this,callback:this.setDiscounts}}};BX.Sale.Admin.OrderBasketEdit.prototype.getProductPrice=function(a){var b=BX.Sale.Admin.OrderEditPage.getForm();return b.elements[this.getFieldName(a,"PRICE")].value};BX.Sale.Admin.OrderBasketEdit.prototype.setCoupons=function(a){return BX.Sale.Admin.OrderBasketCoupons.setCoupons(a)};BX.Sale.Admin.OrderBasketEdit.prototype.getProductQuantity=function(a){var b=BX.Sale.Admin.OrderEditPage.getForm();return b.elements[this.getFieldName(a,"QUANTITY")].value};BX.Sale.Admin.OrderBasketEdit.prototype.setProductQuantity=function(a,d){var b=BX.Sale.Admin.OrderEditPage.getForm(),c=b.elements[this.getFieldName(a,"QUANTITY")];if(!d||d<0){d=0}else{d=this.roundQuantity(d)}if(c){c.value=d}this.onProductQuantityChange({productId:a});return d};BX.Sale.Admin.OrderBasketEdit.prototype.setProductPrice=function(c,f){var e=BX.Sale.Admin.OrderEditPage.getForm(),h=e.elements[this.getFieldName(c,"PRICE")],a=e.elements[this.getFieldName(c,"BASE_PRICE")],d=BX(this.idPrefix+"sale-order-basket-product-"+c+"-base_price"),g=BX(this.idPrefix+"sale-order-basket-product-"+c+"-formatted_price");f=parseFloat(f);if(!f||f<0){f=0}else{f=parseFloat(f)}if(h){h.value=f}if(g){g.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(f)}if(this.products[c].CUSTOM_PRICE=="Y"){this.customPrices[c]=f}else{delete (this.customPrices[c])}if(a&&d){var b=parseFloat(a.value);if(b>0&&b!=f){d.style.display=""}else{d.style.display="none"}}this.onProductPriceChange({productId:c});return f};BX.Sale.Admin.OrderBasketEdit.prototype.onProductQuantityChange=function(b){var d=this.getFieldName(b.productId,"QUANTITY"),c=this,a=this.canSendUpdateQuantityRequest;clearTimeout(this.qantityUpdaterTimeout);this.qantityUpdaterTimeout=setTimeout(function(){var e=c.canSendUpdateQuantityRequest;c.canSendUpdateQuantityRequest=a;BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater(d,b.productId);c.canSendUpdateQuantityRequest=e},this.qantityUpdaterDelay)};BX.Sale.Admin.OrderBasketEdit.prototype.onProductPriceChange=function(a){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater(this.getFieldName(a.productId,"PRICE"),a.productId)};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductQuantity=function(a){this.updateProductSumm(a);if(this.canSendUpdateQuantityRequest){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"FIELD_UPDATE",updatedFieldId:"QUANTITY",productId:a}))}};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductPrice=function(a){this.updateProductSumm(a);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"FIELD_UPDATE",updatedFieldId:"PRICE",productId:a}))};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductSumm=function(a){var b=BX(this.getProductSummCellId(a));if(!b){return}b.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(this.getProductPrice(a)*this.getProductQuantity(a))};BX.Sale.Admin.OrderBasketEdit.prototype.setTotalPrices=function(a){this.totalBlock.setFieldValue("PRICE_BASKET",a.PRICE_BASKET);this.totalBlock.setFieldValue("PRICE_BASKET_DISCOUNTED",a.PRICE_BASKET_DISCOUNTED);this.totalBlock.setFieldValue("PRICE_DELIVERY",a.PRICE_DELIVERY);this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",a.PRICE_DELIVERY_DISCOUNTED);this.totalBlock.setFieldValue("TAX_VALUE",a.TAX_VALUE);this.totalBlock.setFieldValue("SUM_PAID",a.SUM_PAID);this.totalBlock.setFieldValue("SUM_UNPAID",a.SUM_UNPAID)};BX.Sale.Admin.OrderBasketEdit.prototype.setDeliveryPrice=function(a){this.totalBlock.setFieldValue("PRICE_DELIVERY",a)};BX.Sale.Admin.OrderBasketEdit.prototype.setDeliveryPriceDiscount=function(a){this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",a)};BX.Sale.Admin.OrderBasketEdit.prototype.setTaxValue=function(a){this.totalBlock.setFieldValue("TAX_VALUE",a)};BX.Sale.Admin.OrderBasketEdit.prototype.addProductSearch=function(c){var b=this.objName+".getParamsByProductId";window[b]=BX.proxy(function(e,d){this.getParamsByProductId(e,d)},this);var a=new BX.CDialog({content_url:"/bitrix/tools/sale/product_search_dialog.php?lang="+BX.Sale.Admin.OrderEditPage.languageId+"&LID="+BX.Sale.Admin.OrderEditPage.siteId+"&caller=order_edit&func_name="+b+"&STORE_FROM_ID=0",height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800});BX.addCustomEvent(a,"onWindowRegister",BX.defer(function(){a.Get().style.position="fixed";a.Get().style.top=(parseInt(a.Get().style.top)-BX.GetWindowScrollPos().scrollTop)+"px"}));a.Show()};BX.Sale.Admin.OrderBasketEdit.prototype.getCoupons=function(){var a=BX.Sale.Admin.OrderEditPage.getForm();return a.elements.COUPONS.value};BX.Sale.Admin.OrderBasketEdit.prototype.onSkuPropSelect=function(a,b){this.getParamsByProductId({id:b,quantity:this.getProductQuantity(a),replaceBasketCode:a},0)};BX.Sale.Admin.OrderBasketEdit.prototype.getSkuProps=function(d,b){var a={},e=BX.Sale.Admin.OrderEditPage.getForm();for(var c in b){if(!b.hasOwnProperty(c)){continue}var f=this.getFieldName(d,"SKU")+"["+c+"]";if(typeof e.elements[f]!="undefined"){a[c]=e.elements[f].value}}return a};BX.Sale.Admin.OrderBasketEdit.prototype.getFieldName=function(a,b){return"PRODUCT["+a+"]["+b+"]"};BX.Sale.Admin.OrderBasketEdit.prototype.productDeleteClick=function(a){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"PRODUCT_DELETE",basketCode:a}))};BX.Sale.Admin.OrderBasketEdit.prototype.productDelete=function(d){var e=BX(this.createProductRowId(d));if(!e){return}var c=e.getAttribute("data-old-parent-id-parent");if(c){var a=BX.findChildren(e.parentNode,{className:"bundle-child-"+c},false);for(var b in a){if(a.hasOwnProperty(b)){a[b].parentNode.removeChild(a[b])}}}this.onProductDelete(d);e.parentNode.removeChild(e);this.setRowNumbers();this.setProductsCount(--this.productsCount);if(this.productsCount<=0){this.showEmptyRow()}if(this.customPrices[d]){delete this.customPrices[d]}delete (this.products[d])};BX.Sale.Admin.OrderBasketEdit.prototype.onSkuSelectorClick=function(h,g,c,f,d){for(var e=0,b=g.children.length;e<b;e++){var a=g.children[e];if(a.getAttribute("data-value")!=BX.util.htmlspecialchars(f)){BX.removeClass(a,"bx-active")}else{BX.addClass(a,"bx-active")}}this.setSkuInput(h,c,d)};BX.Sale.Admin.OrderBasketEdit.prototype.setSkuInput=function(c,a,e){var b=this.getFieldName(c,"SKU")+"["+a+"]",d=BX.Sale.Admin.OrderEditPage.getForm();d.elements[b].value=e};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorSetArrowsVisibility=function(b,d,c){var e=b.parentNode.parentNode.parentNode.childNodes[1];if(c<=5||d>=0){e.style.display="none"}else{e.style.display=""}var a=b.parentNode.parentNode.parentNode.childNodes[2];if(c<=5||d<=5-c){a.style.display="none"}else{a.style.display=""}};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorScrollLeft=function(a,b){var c=this.skuSelectorGetScrollOffset(a);if(c>=0){return false}this.skuSelectorSetScroll(a,++c);this.skuSelectorSetArrowsVisibility(a,c);return true};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorScrollRight=function(a,b){var c=this.skuSelectorGetScrollOffset(a);if(c<=5-b){return false}this.skuSelectorSetScroll(a,--c);this.skuSelectorSetArrowsVisibility(a,c,b);return true};BX.Sale.Admin.OrderBasketEdit.prototype.createDiscountCell=function(c,e){var d=BX.create("text",{html:"&nbsp"}),b=false,a=e.SKU_PROPS&&Object.keys(e.SKU_PROPS).length>0;if(this.discounts&&this.discounts.RESULT&&this.discounts.RESULT.BASKET){d=BX.Sale.Admin.OrderEditPage.createDiscountsNode(c,"BASKET",this.discounts.RESULT.BASKET[c]?this.discounts.RESULT.BASKET[c]:{},this.discounts,"EDIT");b=this.discounts.RESULT.BASKET[c]?true:false}var f=BX.create("td",{props:{id:this.getDiscountCellId(c)},children:[BX.create("div",{children:[d]})]});f.colSpan=this.columnsCount-1;if(a||b){f.style.borderTop="1px solid #ddd"}return f};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorCountScrollOffset=function(d,b){var a=0;d=d+1;if(b>5&&d>2){var c=b-d;a=d-3;if(c<2){a=a-(2-c)}}return a};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorGetStepSize=function(){return 30};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorGetScrollOffset=function(b){if(!b){return false}var a=parseInt(b.style.marginLeft,10);if(!a){a=0}else{a=parseInt(a/this.skuSelectorGetStepSize(),10)}return a};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorSetScroll=function(b,a){b.style.marginLeft=a*this.skuSelectorGetStepSize()+"px"};BX.Sale.Admin.OrderBasketEdit.prototype.onCouponsRecount=function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"COUPONS_RECOUNT"}))};BX.Sale.Admin.OrderBasketEdit.prototype.createProductMenuContent=function(a){return[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_EDIT"),ACTION:this.objName+'.productEdit("'+a+'")',DEFAULT:true},{ICON:"delete",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_DELETE"),ACTION:this.objName+'.productDeleteClick("'+a+'")'}]};BX.Sale.Admin.OrderBasketEdit.prototype.productEdit=function(a){this.productEditDialog.show(a)};BX.Sale.Admin.OrderBasketEdit.prototype.createMeasureRatioNode=function(b,f,c){if(!BX.type.isElementNode(f)){return null}if(!c||c==1){return null}var a=BX.create("a",{props:{href:"javascript:void(0);",title:BX.message("SALE_ORDER_BASKET_UP_RATIO").replace("#RATIO#",c),className:"plus"}}),e=BX.create("a",{props:{href:"javascript:void(0);",title:BX.message("SALE_ORDER_BASKET_DOWN_RATIO").replace("#RATIO#",c),className:"minus"}}),d=this;BX.bind(a,"click",function(g){f.value=d.roundQuantity(parseFloat(f.value)+parseFloat(c));d.onProductQuantityChange({productId:b})});BX.bind(e,"click",function(g){f.value=d.roundQuantity(parseFloat(f.value)-parseFloat(c));d.onProductQuantityChange({productId:b})});return BX.create("div",{props:{className:"quantity_control"},children:[a,e],style:{position:"inherit",marginLeft:"3px"}})};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldQuantity=function(a,h,d){var e=typeof h.MEASURE_RATIO!="undefined"?h.MEASURE_RATIO:1,g={},i,c=this,f=BX.create("input",{props:{type:"text",name:this.getFieldName(a,"QUANTITY"),value:this.roundQuantity(h.QUANTITY),className:"tac"},style:{width:"60px"}}),b=this.createMeasureRatioNode(a,f,e);BX.bind(f,"focus",function(k){var j=f.value;BX.Sale.Admin.OrderEditPage.addRollbackMethod(function(){var l=c.canSendUpdateQuantityRequest;c.canSendUpdateQuantityRequest=false;c.setProductQuantity(a,j);setTimeout(function(){c.canSendUpdateQuantityRequest=l},1)})});BX.bind(f,"change",function(j){c.setProductQuantity(a,f.value)});BX.bind(f,"keydown",function(j){if(!j){j=window.event}if(!j){return}if(j.keyCode==13){f.blur()}});g[this.getFieldName(a,"QUANTITY")]={callback:c.updateProductQuantity,context:c};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(g);if(b){i=BX.create("span",{children:[f,b],style:{display:"inline-flex"}})}else{i=f}return i};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldPrice=function(a,o,h){var e;if(typeof(this.customPrices[a])=="undefined"){e=o.PRICE}else{e=this.customPrices[a]}var n={},g=this,b=BX.create("input",{props:{type:"text",name:this.getFieldName(a,"PRICE"),value:e,maxlength:"9",size:5}}),d=BX.create("span",{props:{className:"edit_price_product"},children:[b]}),i=BX.create("span",{props:{className:"formated_price",id:this.idPrefix+"sale-order-basket-product-"+a+"-formatted_price"},html:BX.Sale.Admin.OrderEditPage.currencyFormat(e),style:{whiteSpace:"nowrap"}}),c=BX.create("span",{props:{className:"default_price_product"},children:[i]}),l=BX.create("span",{text:""}),m=BX.create("a",{props:{href:"javascript:void(0);"},children:[BX.create("span",{props:{className:"pencil"}})]}),k=BX.create("div",{props:{className:"base_price",id:this.idPrefix+"sale-order-basket-product-"+a+"-base_price"},style:{display:((parseFloat(o.BASE_PRICE)>0&&parseFloat(o.PRICE)!=parseFloat(o.BASE_PRICE))?"":"none")},children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(o.BASE_PRICE)})]}),f=BX.create("div",{props:{className:"base_price_title"},style:{display:(((o.CUSTOM_PRICE&&o.CUSTOM_PRICE=="Y")||o.NOTES)?"":"none")},text:((o.CUSTOM_PRICE&&o.CUSTOM_PRICE=="Y")?BX.message("SALE_ORDER_BASKET_BASE_CATALOG_PRICE"):o.NOTES)}),j=BX.create("span",{props:{className:"edit_price"},children:[c,d,l,m,k,f]});b.style.width="60px";BX.bind(m,"click",function(p){g.onPriceEditEnable(j,b)});BX.bind(i,"click",function(p){g.onPriceEditEnable(j,b)});BX.bind(b,"change",function(r){var q=BX.Sale.Admin.OrderEditPage.getForm();q.elements[g.getFieldName(a,"CUSTOM_PRICE")].value="Y";var p=g.setProductPrice(a,b.value);i.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(p)});BX.bind(b,"keydown",function(p){if(!p){p=window.event}if(!p){return}if(p.keyCode==13){b.blur()}});BX.bind(b,"blur",function(p){g.onPriceEditDisable(j)});n[this.getFieldName(a,"PRICE")]={callback:g.updateProductPrice,context:g};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(n);return j};BX.Sale.Admin.OrderBasketEdit.prototype.createDiscountsNodeBasket=function(a){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DISCOUNT_LIST",a,this.discounts,"EDIT")};BX.Sale.Admin.OrderBasketEdit.prototype.getHiddenFieldsNames=function(){return["CURRENCY","PRODUCT_PROVIDER_CLASS","NAME","DETAIL_PAGE_URL","WEIGHT","CATALOG_XML_ID","NOTES","PRODUCT_XML_ID","OFFER_ID","MODULE","CUSTOM_PRICE","IS_SET_ITEM","IS_SET_PARENT","MEASURE_CODE"]};BX.Sale.Admin.OrderBasketEdit.prototype.createHiddenFields=function(c,d){var a=[];if(typeof d.CUSTOM_PRICE=="undefined"){d.CUSTOM_PRICE="N"}for(var b in d){if(!d.hasOwnProperty(b)){continue}if(!d[b]&&b!="CATALOG_XML_ID"){continue}if(b=="PROPS"){a.push(BX.create("span",{html:this.createSkuPropsHiddenHtml(c,d.PROPS,d.IS_SET_ITEM,"PROPS")}));continue}if(b=="SKU_PROPS"){a.push(BX.create("span",{html:this.createSkuPropsHiddenHtml(c,d.SKU_PROPS,d.IS_SET_ITEM,"SKU_PROPS")}));continue}if(typeof d[b]=="object"){continue}if(b=="PRICE"||b=="QUANTITY"){continue}a.push(BX.create("input",{props:{type:"hidden",name:this.getFieldName(c,b),value:d[b]}}))}return a};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuPropsHiddenHtml=function(a,k,n,o){if(!k){return""}var j=0,h=this.getFieldName(a,o),e=[],m="";if(k){for(var g in k){if(!k.hasOwnProperty(g)){continue}if(!k[g]||e.indexOf(k[g]["CODE"])!=-1){continue}if(n!="Y"){var b=k[g]["NAME"]?BX.util.htmlspecialchars(k[g]["NAME"]):"",l=k[g]["VALUE"]?BX.util.htmlspecialchars(k[g]["VALUE"]):"",d=k[g]["CODE"]?BX.util.htmlspecialchars(k[g]["CODE"]):"",f=k[g]["SORT"]?BX.util.htmlspecialchars(k[g]["SORT"]):100,c=k[g]["ID"]?BX.util.htmlspecialchars(k[g]["ID"]):0;m+='<input type="hidden" name="'+h+"["+j+'][NAME]" value="'+b+'"><input type="hidden" name="'+h+"["+j+'][VALUE]" value="'+l+'"><input type="hidden" name="'+h+"["+j+'][CODE]" value="'+d+'"><input type="hidden" name="'+h+"["+j+'][ID]" value="'+c+'"><input type="hidden" name="'+h+"["+j+'][SORT]" value="'+f+'">'}j++}}return m};BX.Sale.Admin.OrderBasketEdit.prototype.onPriceEditEnable=function(a,b){BX.addClass(a,"edit_enable");b.focus()};BX.Sale.Admin.OrderBasketEdit.prototype.onPriceEditDisable=function(a){BX.removeClass(a,"edit_enable")};BX.Sale.Admin.OrderBasketEdit.prototype.addFieldUpdater=function(a,c,b){if(!this.fieldsUpdaters[a]){this.fieldsUpdaters[a]={}}if(!this.fieldsUpdaters[a][c]){this.fieldsUpdaters[a][c]=[]}if(typeof b=="function"){this.fieldsUpdaters[a][c].push(b)}else{BX.debug("BX.Sale.Admin.OrderBasketEdit.prototype.addFieldUpdater() callback is not a function!")}};BX.Sale.Admin.OrderBasketEdit.prototype.callFieldUpdaters=function(b,e,d){if(!this.fieldsUpdaters[b]){return false}if(!this.fieldsUpdaters[b][e]){return false}var c=this.fieldsUpdaters[b][e];for(var a in c){if(!c.hasOwnProperty(a)){continue}if(typeof c[a]!="function"){continue}c[a].call(this,d)}};BX.Sale.Admin.OrderBasketEdit.prototype.setProductFieldValue=function(a,e,d){var b=BX.Sale.Admin.OrderEditPage.getForm(),c=b.elements[this.getFieldName(a,e)];if(c&&c.value){c.value=d}if(this.fieldsUpdaters[a]&&this.fieldsUpdaters[a][e]&&typeof(this.fieldsUpdaters[a][e])=="function"){this.fieldsUpdaters[a][e].call(this,d)}};BX.Sale.Admin.OrderBasketEdit.prototype.getProductFieldValue=function(b,e){var c=BX.Sale.Admin.OrderEditPage.getForm();if(!c){return""}var a="",d=c.elements[this.getFieldName(b,e)];if(d&&d.value){a=d.value}return a};BX.Sale.Admin.OrderBasketEditTotal=function(params){if(!params.fields){BX.debug("OrderBasketEditTotal:constructor() params.fields not defined!");return}this.fields={};this.formulas={};var _this=this;var getUnitOfMesure=function(fieldId){var type=_this.fields[fieldId]["type"],result="";if(type=="currency"){result=BX.Sale.Admin.OrderEditPage.currencyLang}else{if(type=="weight"){result=params.weightUnit}}return result};var getFormattedValue=function(fieldId){var value=_this.fields[fieldId]["value"],type=_this.fields[fieldId]["type"],result=value;if(type=="currency"){result=BX.Sale.Admin.OrderEditPage.currencyFormat(value,false)}else{if(type=="weight"){result=value}}return result};var setFieldView=function(fieldId){var field=BX(_this.fields[fieldId].id);if(!field){BX.debug("OrderBasketEditTotal:setFieldView() can't find field with id: \""+_this.fields[fieldId].id+'"');return false}if(_this.fields[fieldId]["edit"]){var span=BX.findChild(field,{className:"formated_field_view"},true,false);if(span){span.innerHTML=getFormattedValue(fieldId)}}else{field.innerHTML=getFormattedValue(fieldId);if(_this.fields[fieldId]["type"]!="currency"){field.innerHTML=field.innerHTML+" "+getUnitOfMesure(fieldId)}}return true};var setFieldEditable=function(fieldId){var field=BX(_this.fields[fieldId].id);if(!field){BX.debug("OrderBasketEditTotal:setFieldView() can't find field with id: \""+_this.fields[fieldId].id+'"');return false}var input=BX.create("input",{props:{type:"text",name:fieldId,value:_this.fields[fieldId].value,maxlength:"9",size:5}}),spanInput=BX.create("span",{props:{className:"edit_field"},children:[input]}),spanFormattedPrice=BX.create("span",{props:{className:"formated_field_view"},html:getFormattedValue(fieldId)}),spanView=BX.create("span",{props:{className:"view_field"},children:[spanFormattedPrice]}),unitOfMesure=BX.create("span",{text:" "+getUnitOfMesure(fieldId)+" "}),apencil=BX.create("a",{props:{href:"javascript:void(0);"},children:[BX.create("span",{props:{className:"pencil"}})]}),containerDiv=BX.create("span",{props:{className:"edit_field_container"},children:[spanView,spanInput,unitOfMesure,apencil]});input.style.width="40px";BX.bind(input,"change",function(e){_this.setFieldValue(fieldId,this.value)});BX.bind(field,"mouseover",function(e){BX.addClass(field,"edit_field_hover")});BX.bind(field,"mouseout",function(e){BX.removeClass(field,"edit_field_hover")});BX.bind(field,"click",function(e){BX.addClass(field,"edit_enabled");input.focus()});BX.bind(input,"blur",function(e){BX.removeClass(field,"edit_enabled")});field=BX.cleanNode(field,false);field.appendChild(containerDiv)};var setFormulas=function(fieldId){_this.formulas[fieldId]=_this.fields[fieldId]["formula"]};var getFormulas=function(fieldId){var result=[];for(var i in _this.formulas){if(!_this.formulas.hasOwnProperty(i)){continue}var re=new RegExp("\\W*"+fieldId+"\\W*","i");if(_this.formulas[i].search(re)!=-1){result.push(i)}}return result};var recountFormulasFieldsValues=function(fieldsIds){for(var i in fieldsIds){if(!fieldsIds.hasOwnProperty(i)){continue}var formula=_this.formulas[fieldsIds[i]],re=new RegExp("[\\w_]+","ig"),newFormula=formula.replace(re,function(fieldId){var result=_this.getFieldValue(fieldId);return result});_this.setFieldValue(fieldsIds[i],eval(newFormula))}};var setField=function(fieldId,fieldParams){var re=new RegExp("[^\\w_]+","ig");if(fieldId.search(re)!=-1){BX.debug("OrderBasketEditTotal:setField() wrong field id!")}_this.fields[fieldId]=fieldParams;if(fieldParams.edit){setFieldEditable(fieldId)}if(fieldParams.formula){setFormulas(fieldId)}};for(var fieldId in params.fields){if(params.fields.hasOwnProperty(fieldId)){setField(fieldId,params.fields[fieldId])}}this.setFieldValue=function(fieldId,value){if(typeof(_this.fields[fieldId])!="undefined"){_this.fields[fieldId].value=value;if(typeof(_this.fields[fieldId]["type"]["formula"])!="undefined"){var formulasFields=getFormulas(fieldId);if(formulasFields){recountFormulasFieldsValues(formulasFields)}}if(_this.fields[fieldId]["type"]!="hidden"){setFieldView(fieldId,value)}}else{BX.debug('OrderBasketEditTotal:setFieldValue() unknown field id: "'+fieldId+'"')}};this.getFieldValue=function(fieldId){var result=false;if(typeof(this.fields[fieldId])!="undefined"){result=this.fields[fieldId].value}else{BX.debug('OrderBasketEditTotal: unknown field id: "'+fieldId+'"')}return result}};BX.Sale.Admin.OrderBasketProductEditDialog=function(d){var p=null,v=0,u=0,c=true,a=d,r=["CURRENCY","PRODUCT_PROVIDER_CLASS","NAME","DETAIL_PAGE_URL","WEIGHT","CATALOG_XML_ID","NOTES","PRODUCT_XML_ID","OFFER_ID","PRICE","QUANTITY","PROPS","MEASURE_CODE","MEASURE_TEXT","CUSTOM_PRICE","BASKET_CODE"],o=this;var i=function(w){if(!w){w=t()}v=w};var f=function(){return v};var s=function(){var w=BX("BASKET_PROP_TABLE");if(!w){BX.debug("BX.Sale.Admin.OrderBasketProductEditDialog:addPropRow() can't find props table!")}return w};var b=function(w,x){return"FORM_PROD_PROP_"+f()+"_"+w+"_"+x};var g=function(w){return BX("FORM_PROD_BASKET_"+w)};var t=function(){var w=0;do{w++}while(typeof(a.products[("n"+w)])!="undefined");return"n"+w};var q=function(){var w=[],z=["NAME","VALUE","CODE","SORT"];for(var y=0;y<u;y++){var A={};for(var x=0;x<z.length;x++){var C=b(z[x],y),B=BX(C);if(B&&typeof(B.value)!="undefined"){A[z[x]]=B.value}}w.unshift(A)}return w};var l=function(y){var x=q();y.PROPS=[];for(var w in x){if(x.hasOwnProperty(w)){if(x[w].NAME){y.PROPS.push(x[w])}}}return y};var h=function(){var z=f(),w,B=a.products[z]?a.products[z]:{MODULE:"",OFFER_ID:1,BASKET_CODE:z},x=false;for(var y in r){if(!r.hasOwnProperty(y)){continue}if(w=g(r[y])){if(r[y]=="PRICE"){var A=Math.round(parseFloat(B[r[y]])*10000),C=Math.round(parseFloat(w.value)*10000);if(A!=C){B.CUSTOM_PRICE="Y";x=true;a.customPrices[z]=w.value;if(!B.MODULE){B.BASE_PRICE=B.PRICE_BASE=w.value}}}else{if(r[y]=="CUSTOM_PRICE"){if(x){continue}}}if(w.value||(r[y]!="OFFER_ID"&&r[y]!="BASKET_CODE")){B[r[y]]=w.value}}}B.MANUALLY_EDITED="Y";if(B.BASKET_CODE!=z){BX.debug('setProductParams: product.BASKET_CODE != basketCode "'+B.BASKET_CODE+'" != "'+z+'"')}if(!B.BASKET_CODE||B.BASKET_CODE!=z){B.BASKET_CODE=z}if(c){B.OFFER_ID=parseInt(B.OFFER_ID)+z}B=l(B);a.productSet(B,!c);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"PRODUCT_ADD",productId:B.OFFER_ID}))};var n=function(){var w=a.products[f()];if(!w){BX.debug("BX.Sale.Admin.OrderBasketProductEditDialog.getProps() can't find product with basket code: \""+f()+'"');return[]}return a.products[f()]["PROPS"]};var m=function(){var w;for(var x in r){if(!r.hasOwnProperty(x)){continue}if(r[x]=="PROPS"){var y=n();for(var z in y){if(y.hasOwnProperty(z)){o.addPropRow(z,y[z])}}}else{if(w=g(r[x])){w.value=a.getProductFieldValue(f(),r[x])}}}BX("FORM_PROD_BASKET_MEASURE_CODE").disabled=(a.getProductFieldValue(f(),"PRODUCT_PROVIDER_CLASS")!="")};var e=function(){var w;for(var x in r){if(r.hasOwnProperty(x)){if(w=g(r[x])){w.value=""}}}var y=s();for(x=y.rows.length-1;x>1;x--){y.deleteRow(x)}BX("FORM_PROD_BASKET_EMPTY_PROP_ROW").style.display=""};var k=function(){var w={action:"getProductEditDialogHtml",currency:BX.Sale.Admin.OrderEditPage.currencyLang,objName:a.objName,callback:function(x){if(x&&x.DIALOG_CONTENT&&!x.ERROR){j(x.DIALOG_CONTENT)}else{if(x&&x.ERROR){BX.debug("Error receiving dialog content: "+x.ERROR)}else{BX.debug("Error receiving dialog content!")}}}};BX.Sale.Admin.OrderAjaxer.sendRequest(w)};var j=function(w){p=new BX.CDialog({content:w,title:!c?BX.message("SALE_ORDER_BASKET_PROD_EDIT"):BX.message("SALE_ORDER_BASKET_PROD_CREATE"),width:820,height:470});p.ClearButtons();p.SetButtons([{title:BX.message("SALE_ORDER_BASKET_PROD_EDIT_ITEM_SAVE"),id:"save_custom_product",action:function(){h();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);if(!c){m()}a.productEditDialog.disableButton();p.Show();BX.Sale.Admin.OrderEditPage.unBlockForm()};this.show=function(w){u=0;if(w){c=false}else{c=true}i(w);if(p==null){p=k()}else{var x;if(!c){e();m();x=BX.message("SALE_ORDER_BASKET_PROD_EDIT")}else{e();x=BX.message("SALE_ORDER_BASKET_PROD_CREATE")}p.SetTitle(x);this.disableButton();p.Show();p.adjustSize()}};this.setMeasureText=function(){var w=BX("FORM_PROD_BASKET_MEASURE_CODE"),y=BX("FORM_PROD_BASKET_MEASURE_TEXT");for(var x=0;x<w.options.length;x++){if(w.options[x].selected!=true){continue}y.value=w.options[x].innerHTML;break}};this.disableButton=function(){var w=BX("save_custom_product");if(!w){return}if(this.checkRequiredFields()){w.disabled=false}else{w.disabled=true}};this.checkRequiredFields=function(){var w=BX("FORM_PROD_BASKET_NAME"),x=BX("FORM_PROD_BASKET_PRICE"),y=BX("FORM_PROD_BASKET_QUANTITY");if(y.value.length>0&&/\D\./.test(y.value)){y.value=parseFloat(y.value)||"0"}if(x.value.length>0&&/\D\./.test(x.value)){x.value=parseFloat(x.value)||"0"}if(w.value.length<=0){return false}if(x.value.length<=0){return false}if(y.value.length<=0){return false}return true};this.addPropRow=function(y,A){var D=s();if(!y){y=u}if(u<=0){BX("FORM_PROD_BASKET_EMPTY_PROP_ROW").style.display="none"}var F={NAME:20,VALUE:20,CODE:3,SORT:2};if(!A){A={NAME:"",VALUE:"",CODE:"",SORT:""}}var E=D.insertRow(-1),C=E.insertCell(-1),w=A.NAME?BX.util.htmlspecialchars(A.NAME):"",B=A.VALUE?BX.util.htmlspecialchars(A.VALUE):"",x=A.CODE?BX.util.htmlspecialchars(A.CODE):"",z=A.SORT?BX.util.htmlspecialchars(A.SORT):100;C.innerHTML='<input type="text" maxlength="250" size="'+F.NAME+'" name="'+b("NAME",y)+'" id="'+b("NAME",y)+'" value="'+w+'" />';C=E.insertCell(-1);C.innerHTML='<input type="text" maxlength="250" size="'+F.VALUE+'" name="'+b("VALUE",y)+'" id="'+b("VALUE",y)+'" value="'+B+'" />';C=E.insertCell(-1);C.innerHTML='<input type="text" maxlength="250" size="'+F.CODE+'" name="'+b("CODE",y)+'" id="'+b("CODE",y)+'" value="'+x+'" />';C=E.insertCell(-1);C.innerHTML='<input type="text" maxlength="250" size="'+F.SORT+'" name="'+b("SORT",y)+'" id="'+b("SORT",y)+'" value="'+z+'" />';u++}};BX.Sale.Admin.OrderBasketCoupons={MODES_LIST:{CREATE:0,EDIT:1,VIEW:2},statusCouponApplyed:null,mode:null,getCouponsContainerNode:function(){return BX("sale-admin-order-coupons-container")},onSetCoupon:function(a){BX.Sale.Admin.OrderEditPage.setDiscountCheckbox(a);BX.Sale.Admin.OrderEditPage.refreshDiscounts()},onDeleteCoupon:function(a){BX.Sale.Admin.OrderAjaxer.sendRequest({action:"deleteCoupon",coupon:a,orderId:BX.Sale.Admin.OrderEditPage.orderId,userId:BX.Sale.Admin.OrderBuyer.getBuyerId(),callback:function(b){if(b&&b.ERROR){BX.Sale.Admin.OrderEditPage.showDialog("Error: can't delete coupon")}}},false,true)},onAddCoupons:function(){var a=BX("sale-admin-order-coupons");if(!a||!a.value){return}BX.Sale.Admin.OrderAjaxer.sendRequest({action:"addCoupons",coupon:a.value,orderId:BX.Sale.Admin.OrderEditPage.orderId,userId:BX.Sale.Admin.OrderBuyer.getBuyerId(),callback:function(b){if(b&&b.ERROR){BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_BASKET_ADD_COUPON_ERROR"))}}},false,true);a.value=""},addCouponRow:function(b){if(!b){return}var a=this.getCouponsContainerNode(),c;if(!a){return}c={toUse:(b.JS_STATUS==="APPLYED"),coupon:b.COUPON,title:b.JS_CHECK_CODE?b.JS_CHECK_CODE:"",discountId:b.ORDER_DISCOUNT_ID,description:"["+b.COUPON+"]"};if(b.DISCOUNT_NAME!=""){c.description+=" "+b.DISCOUNT_NAME}if(b.JS_STATUS==="BAD"){c.color="red"}else{if(b.JS_STATUS==="APPLYED"){c.color="green"}else{c.color="gray"}}if(b.DISCOUNT_SIZE){c.discountSize=b.DISCOUNT_SIZE}else{c.discountSize="0 %"}if(b.APPLY){c.APPLY=b.APPLY}else{c.APPLY="N"}c.NEW_COUPON=b.SAVED=="N";a.appendChild(this.createCouponRowNode(c))},clearCoupons:function(){var a=this.getCouponsContainerNode();if(!a){return}BX.cleanNode(a,false)},createCouponRowNode:function(d){var e="bx-bg-"+d.color,j=(this.mode===this.MODES_LIST.EDIT),f=(this.mode===this.MODES_LIST.CREATE||(this.mode===this.MODES_LIST.EDIT&&d.NEW_COUPON)),g=d.discountSize?d.discountSize:"",k=d.description?BX.util.htmlspecialchars(d.description):"",b=d.coupon?BX.util.htmlspecialchars(d.coupon):"",a=d.toUse,i=d.APPLY,c=d.discountId,h="";if(d.title){h=BX.message("SALE_ORDER_BASKET_COUPON_STATUS")+": "+BX.util.htmlspecialchars(d.title)}return BX.create("li",{props:{className:"bx-adm-pc-sale-item "+e},html:(j?'<input type="hidden" value="N" name="DISCOUNTS[COUPON_LIST]['+b+']"><input type="checkbox" data-discount-id="'+c+'" data-coupon="Y" data-discount-coupon="'+b+'" class="bx-adm-pc-input-checkbox" name="DISCOUNTS[COUPON_LIST]['+b+']" value="Y" onclick="BX.Sale.Admin.OrderBasketCoupons.onSetCoupon(event);"'+(i=="Y"?" checked":"")+' title="'+BX.message("SALE_ORDER_BASKET_COUPON_APPLY")+'">':"")+'<div class="bx-adm-pc-sale-item-block'+(j?"":" bx-amd-l0")+(f?"":" bx-adm-r0")+'" title="'+h+'"><div class="bx-adm-pc-sale-overname"><div class="bx-adm-pc-sale-cost">'+(g.length>0?g:"0")+"</div>"+k+"</div></div>"+(f?'<div class="bx-adm-pc-sale-item-remover" onclick="BX.Sale.Admin.OrderBasketCoupons.onDeleteCoupon(\''+b+'\');"  title="'+BX.message("SALE_ORDER_BASKET_COUPON_DELETE")+'"></div>':"")})},setCoupons:function(b){this.clearCoupons();if(!b){return}for(var a in b){if(b.hasOwnProperty(a)){this.addCouponRow(b[a])}}}};