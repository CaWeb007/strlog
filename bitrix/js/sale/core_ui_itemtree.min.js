BX.namespace("BX.ui");BX.ui.itemTree=function(a,b){this.parentConstruct(BX.ui.itemTree,a);BX.merge(this,{opts:{controlCheckboxes:true,useDynamicLoading:false},vars:{cache:{ceilings:{},lastPage:{},loadedFirstTime:{}}},ctrls:{},sys:{code:"item-tree"}});this.handleInitStack(b,BX.ui.itemTree,a)};BX.extend(BX.ui.itemTree,BX.ui.networkIOWidget);BX.merge(BX.ui.itemTree.prototype,{init:function(){var a=this;this.vars.loader={show:function(b){a.setCSSState("loading",b.controls.children)},hide:function(b){a.dropCSSState("loading",b.controls.children)}};this.pushFuncStack("bindEvents",BX.ui.itemTree)},bindEvents:function(){var c=this.ctrls,a=this,b=this.sys.code;BX.bindDelegate(c.scope,"click",{className:this.getControlClassName("expander")},function(){var d=BX.findParent(this,{className:a.getControlClassName("node")});if(BX.type.isElementNode(d)){a.toggleBundle(BX.data(d,"node-id"),{expander:this,node:d})}else{throw new Error("Cannot find node for expander")}});BX.bindDelegate(c.scope,"click",{className:this.getControlClassName("load-more")},function(){var d=BX.findParent(this,{className:a.getControlClassName("node")});if(BX.type.isElementNode(d)){a.loadMore(BX.data(d,"node-id"),{loadMore:this,node:d})}else{throw new Error("Cannot find node for load-more")}});BX.bindDelegate(c.scope,"click",{className:this.getControlClassName("checkbox")},function(d){a.toggleCheckbox(this)});this.bindEvent("toggle-bundle-before",this.whenExpanderToggle)},loadMore:function(e,c){var b=this,d=this.opts,a=this.vars;c.children=b.getControl("children",true,c.node);this.dropCSSState("error",c.children);this.dropCSSState("can-load-more",c.children);if(d.useDynamicLoading&&BX.type.isNotEmptyString(d.source)&&this.getCanLoadMore(e)){this.downloadItems(e,c)}},toggleBundle:function(e,h){var k=this,d=this.opts,i=this.vars,c=this.sys.code;if(!BX.type.isPlainObject(h)){h={}}if(!BX.type.isElementNode(h.node)){h.node=this.getControl('[data-node-id="'+e+'"]');if(!BX.type.isElementNode(h.node)){throw new Error("Cannot find node for id "+e)}}if(!BX.type.isElementNode(h.expander)){h.expander=this.getControl("expander",false,h.node);if(!BX.type.isElementNode(h.expander)){throw new Error("Cannot find expander for node")}}var g=false;var f="bx-ui-"+c+"-state";var b=BX.data(h.expander,f);if(typeof b!="undefined"){g=b}BX.data(h.expander,f,!g);h.checkbox=k.getControl("checkbox",true,h.node);h.children=k.getControl("children",true,h.node);var a=[!g,h];this.fireEvent("toggle-bundle-before",a);var j=function(){k.fireEvent("toggle-bundle-after",a)};if(!g&&d.useDynamicLoading&&BX.data(h.node,"is-parent")=="1"&&BX.type.isNotEmptyString(d.source)&&!i.cache.loadedFirstTime[e]&&this.getCanLoadMore(e)){this.dropCSSState("error",h.children);this.dropCSSState("can-load-more",h.children);this.downloadItems(e,h,j)}else{j()}},downloadItems:function(e,c,f){var b=this,d=this.opts,a=this.vars;b.downloadBundle({request:{ID:e},callbacks:{onLoad:function(j){if(j.items.length==0){a.cache.ceilings[e]=a.cache.lastPage[e]}else{if(typeof j.total=="number"&&d.pageSize>0){a.cache.ceilings[e]=Math.ceil(j.total/d.pageSize)}var i=b.getControl("item-pool",false,c.children);for(var g in j.items){if(j.items.hasOwnProperty(g)){var h=b.whenRenderVariant(j.items[g])[0];BX.append(h,i)}}a.cache.lastPage[e]++;if(b.getCanLoadMore(e)){this.setCSSState("can-load-more",c.children)}}a.cache.loadedFirstTime[e]=true;if(BX.type.isFunction(f)){f()}}},options:{controls:c,nodeId:e}})},toggleCheckbox:function(g){var f=this.opts,a=this,e=this.sys.code;if(!f.controlCheckboxes){return}if(!("checked" in g)){return}var d=BX.findParent(g,{className:"bx-ui-"+e+"-node"});if(typeof d=="undefined"){throw new Error("Cannot find parent node for checkbox")}var c=g.checked;var h=d.querySelectorAll('input[type="checkbox"]');if(h!=null){for(var b=0;b<h.length;b++){h[b].checked=c}}},getNavParams:function(b){var a=this.vars.cache;if(typeof a.lastPage[b.nodeId]=="undefined"){a.lastPage[b.nodeId]=0}return this.opts.paginatedRequest?{PAGE_SIZE:this.opts.pageSize,PAGE:a.lastPage[b.nodeId]}:{}},showError:function(a){this.setCSSState("error",a.options.controls.children);this.getControl("error-desc",false,a.options.controls.node).innerHTML=BX.util.htmlspecialchars(a.errors.join(", "))},manageCeiling:function(b,c){var a=this.vars;if(typeof c=="undefined"){if(typeof a.cache.ceilings[b]=="undefined"){return -1}return a.cache.ceilings[b]}a.cache.ceilings[b]=c},getCanLoadMore:function(b){var a=this.vars;if(typeof a.cache.ceilings[b]=="undefined"){return true}return a.cache.ceilings[b]>=0&&a.cache.lastPage[b]<a.cache.ceilings[b]},whenRenderVariant:function(a){return this.createNodesByTemplate("node",a,true)},whenExpanderToggle:function(b,a){BX[b?"show":"hide"](a.children)}});