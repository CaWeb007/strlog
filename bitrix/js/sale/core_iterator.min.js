BX.iterator=function(a,b){this.parentConstruct(BX.iterator,a);BX.merge(this,{opts:{source:"/somewhere.php",interval:1000,dataType:"json",method:"post",loader:null,waitAjaxOnStop:false,whenHit:function(){return true}},vars:{status:"S",running:false,timeTag:false,ajaxTag:false,step:0,fields:{},lastRequest:null,lastResponce:null,wasAborted:false},ctrls:{},sys:{code:"iterator",statuses:{stopped:"S",stopping:"I",running:"R"}}});this.handleInitStack(b,BX.iterator,a)};BX.extend(BX.iterator,BX.ui.widget);BX.merge(BX.iterator.prototype,{init:function(){var a=this.vars,b=this.opts;a.loader=typeof b.loader!="object"?{show:BX.DoNothing,hide:BX.DoNothing}:b.loader;this.fireEvent("set-status",[a.status])},start:function(a){var b=this.vars;if(b.running){return}b.running=true;b.status=this.sys.statuses.running;b.fields=BX.clone(a);this.fireEvent("set-status",[b.status]);this.query()},stop:function(){var a=this.vars,b=this.opts;clearInterval(a.timeTag);if(b.waitAjaxOnStop){a.status=this.sys.statuses.stopping;this.fireEvent("set-status",[a.status])}else{if(typeof(a.ajaxTag)!="undefined"&&a.ajaxTag.readyState<4){a.wasAborted=true;a.ajaxTag.abort()}this.stopIterator()}},refineRequest:function(a){return a},refineResponce:function(a,b){return a},getStatus:function(){return this.vars.status},getIsRunning:function(){return this.vars.status==this.sys.statuses.running||this.vars.status==this.sys.statuses.stopping},stopIterator:function(a){var b=this.vars;b.step=0;b.running=false;b.status=this.sys.statuses.stopped;this.fireEvent("set-status",[b.status,a])},query:function(){var b=this,d=this.opts,a=this.vars;a.loader.show();this.fireEvent("before-ajax-call");var c=BX.clone(a.fields);c.step=a.step;c.csrf=BX.bitrix_sessid();a.lastRequest=c;a.ajaxTag=BX.ajax({url:d.source,method:d.method,dataType:d.dataType,async:true,processData:true,emulateOnload:true,start:true,data:b.refineRequest(c),onsuccess:function(e){a.loader.hide();if(a.wasAborted){return}if(a.status==b.sys.statuses.stopping){b.stopIterator();return}e=b.refineResponce(e,c);a.lastResponce=e;if(e.result){a.step++;if(!d.whenHit.apply(b,[e,c])){b.stopIterator(e)}else{if(a.running){a.timeTag=setTimeout(function(){b.query()},d.interval)}}b.fireEvent("ajax-success")}else{b.stopIterator();var g=[];if(typeof e.errors!="undefined"){for(var f in e.errors){if(e.errors.hasOwnProperty(f)){g.push({message:e.errors[f]})}}}b.fireEvent("server-error",[g])}b.fireEvent("ajax-complete")},onfailure:function(f,e){a.loader.hide();if(a.wasAborted){return}b.stopIterator();b.fireEvent("ajax-error",[{message:f,detail:e}]);b.fireEvent("ajax-complete")}})}});