if(typeof BX.ui!="object"){BX.ui={}}BX.ui.combobox=function(a,b){this.parentConstruct(BX.ui.combobox,a);BX.merge(this,{opts:{pageSize:5,selectedItem:false,knownItems:[],selectByClick:true,chooseUsingArrows:true,selectOnEnter:true,openDdByAltArrow:true,closeDdByEscape:true,scrollToVariantOnArrow:true,closePopupOnOuterClick:true,messages:{nothingFound:"Sorry, nothing found",notSelected:"-- Not selected",error:"Error occured",clearSelection:"Deselect"},arrowScrollAdditional:0,pageUpWardOffset:0,wrapTagName:"span",dropdownHConstraint:0,dropdownHConstraintType:"max-height",inputDebounceTimeout:500,scrollThrottleTimeout:300,selectByClickTimeout:200,startSearchLen:2,bindEvents:{init:function(){this.setInitialValue()}}},vars:{opened:false,eventLock:false,displayPageMutex:false,keyboardMutex:false,allEventMutex:false,cache:{nodes:{},search:{origin:false}},applyFilter:false,filtered:[],lastSource:false,pager:false,selector:false,value:false,outSideClickScope:null},ctrls:{},sys:{code:"combobox"}});this.handleInitStack(b,BX.ui.combobox,a)};BX.extend(BX.ui.combobox,BX.ui.widget);BX.merge(BX.ui.combobox.prototype,{init:function(){var b=this,d=this.opts,a=this.vars,e=this.ctrls;var c=this.getControl("input",true);if(c==null){c=e.scope.querySelector('input[type="text"]')}if(c==null){c=e.scope.querySelector("select")}if(c==null){throw new Error("Input control still not found")}e.inputs={origin:c==null?e.scope:c};a.loader=new BX.ui.loader({timeout:500});a.loader.bindEvent("toggle",BX.proxy(this.whenLoaderToggle,b));if(typeof d.knownItems=="object"){this.fillCache(d.knownItems,false)}this.pushFuncStack("buildUpDOM",BX.ui.combobox);this.pushFuncStack("bindEvents",BX.ui.combobox)},buildUpDOM:function(){var e=this.opts,f=this.ctrls,b=this.vars,a=this,c=this.sys.code;f.container=this.getControl("container",true);if(!BX.type.isElementNode(f.container)){f.container=BX.create("div",{props:{className:"bx-ui-"+c+"-container"},style:{margin:0,padding:0,border:"none",position:"relative"}});BX.insertAfter(f.container,f.inputs.origin)}f.inputs.fake=this.getControl("fake",true);if(!BX.type.isElementNode(f.container)){var d=BX.clone(f.inputs.origin);d.removeAttribute("name");BX.adjust(d,{props:{className:"bx-ui-"+c+"-fake"}});f.container.appendChild(d);f.inputs.fake=d}BX.hide(f.inputs.origin);if(BX.browser.IsIE8()){BX.bind(f.inputs.fake,"click",function(g){BX.eventCancelBubble(g)});BX.bind(f.container,"click",function(){f.inputs.fake.focus()})}f.toggle=this.getControl("toggle",true);if(!BX.type.isElementNode(f.toggle)){f.toggle=BX.create("div",{props:{className:"bx-ui-"+c+"-toggle"},style:{position:"absolute",top:"0px",right:"0px"}});f.container.appendChild(f.toggle)}f.dropdown=this.getControl("dropdown",true);if(!BX.type.isElementNode(f.dropdown)){f.dropdown=BX.create("div",{props:{className:"bx-ui-"+c+"-dropdown"},style:{display:"none",position:"absolute"}});f.container.appendChild(f.dropdown)}if(e.dropdownHConstraint>0&&e.dropdownHConstraintType!=""){BX.style(f.dropdown,e.dropdownHConstraintType,e.dropdownHConstraint+"px")}b.pager=new BX.ui.scrollablePager({scope:f.dropdown,setTopReachedOnPage:0,eventTimeout:e.scrollThrottleTimeout,parent:a});b.selector=new BX.ui.itemSelectManager();f.nothingFound=this.getControl("nothing-found",true)},bindEvents:function(){var e=this.ctrls,d=this.opts,b=this.vars,a=this,c=this.sys.code;this.bindEventsMouse();this.bindEventsKeyboard();b.pager.bindEvent("scroll-to-top",BX.semaphore(function(){if(!this.vars.opened){return}var f=b.pager.getFreePageNumber(0);if(this.checkPageIsOutOfRange(f)){return}a.displayPage(f)},this,{limit:1,dup:"drop"}));b.pager.bindEvent("scroll-to-bottom",BX.semaphore(function(){if(!this.vars.opened){return}var f=b.pager.getFreePageNumber(1);if(this.checkPageIsOutOfRange(f)){return}a.displayPage(f)},this,{limit:1,dup:"drop"}));b.selector.bindEvent("item-select",function(g,f){a.whenToggleItemGlow(f,true)});b.selector.bindEvent("item-deselect",function(g,f){a.whenToggleItemGlow(f,false)})},bindEventsMouse:function(){var e=this.ctrls,d=this.opts,b=this.vars,a=this,c=this.sys.code;if(d.selectByClick){BX.bindDelegate(e.dropdown,"click",{className:"bx-ui-"+c+"-variant"},function(){if(b.allEventMutex){return}var g=BX.data(this,"bx-"+c+"-item-value");var f=this;if(g==a.vars.value){a.hideDropdown();return}if(typeof g!="undefined"&&typeof b.cache.nodes[g]!="undefined"){a.vars.selector.selectById(g);a.setValue(g);if(d.focusOnMouseSelect){e.inputs.fake.focus()}a.fireEvent("item-selected-by-mouse",[g,f])}else{a.setValue("")}})}if(d.closePopupOnOuterClick){if(b.allEventMutex){return}b.outSideClickScope=e.container;BX.bind(document,"click",function(f){f=f||window.event;if(!BX.isParentForNode(b.outSideClickScope,f.target||f.srcElement)){a.hideDropdown()}})}BX.bind(e.toggle,"click",function(){a.toggleDropDown()});if("value" in e.inputs.fake){BX.bind(e.inputs.fake,"click",function(){if(!b.opened&&b.value===false&&this.value.length>0){a.tryDisplayPage("search")}})}},bindEventsKeyboard:function(){var d=this.ctrls,c=this.opts,b=this.vars,a=this;if("value" in d.inputs.fake){BX.bindDebouncedChange(d.inputs.fake,function(e){if(b.allEventMutex){return}if(e.length>=c.startSearchLen){a.tryDisplayPage("search")}else{a.hideDropdown()}},function(){if(b.allEventMutex){return}if(b.value!=false&&b.value!=""){a.deselectItem()}},c.inputDebounceTimeout,d.inputs.fake);BX.bind(d.inputs.fake,"keydown",function(l){if(b.allEventMutex){return}if(b.keyboardMutex){return}var r=l.keyCode||l.which;var i=(r==38||r==40);if(c.chooseUsingArrows){if(i&&b.opened){b.selector[r==38?"selectPrevious":"selectNext"](l.shiftKey?5:1);if(c.scrollToVariantOnArrow){var h=b.selector.getSelected();if(typeof h!="undefined"){var s=h.data.node;var o=BX.pos(s,d.dropdown);var q=o.top;var p=o.height;var n=d.dropdown.clientHeight;var m=d.dropdown.scrollTop;var k=c.arrowScrollAdditional;var j=false;if(q+p>n+m){j=q+p-(n+m)+k}else{if(q<m){j=-(m-q+k)}}if(j!=false){b.pager.scrollTo(j,false,1)}}}BX.PreventDefault(l)}}if(c.openDdByAltArrow&&l.altKey&&i&&!b.opened){a.tryDisplayPage("toggle")}if(c.closeDdByEscape&&r==27&&b.opened){a.hideDropdown()}if(r==13&&c.selectOnEnter&&b.opened){var g=b.selector.getSelected();if(typeof g!="undefined"){if(g.id==a.vars.value){a.hideDropdown();return}a.setValue(g.id)}}if(r==13){BX.PreventDefault(l)}})}},addItems2Cache:function(a){this.fillCache(a)},clearCache:function(){this.vars.cache={nodes:{},search:{origin:false}}},focus:function(){this.ctrls.inputs.fake.focus()},checkDisabled:function(){},disable:function(){},enable:function(){},setValue:function(c){this.hideDropdown();this.hideNothingFound();this.setFakeInputValue("");if(c==null||typeof c=="undefined"||c.toString().length==0){this.deselectItem();return}else{if(c==this.vars.value){return}else{this.setCurrentValue("")}}var b=this.vars,d=this.ctrls,a=this;this.discoverItems(function(){if(typeof b.cache.nodes[c]=="undefined"){a.displayNothingFound()}else{a.selectItem(c)}})},getValue:function(){return this.vars.value},clearSelected:function(){this.setValue("")},getNodeByValue:function(a){return this.vars.cache.nodes[a]},setTabIndex:function(a){this.ctrls.inputs.fake.setAttribute("tabindex",a)},setTargetInputName:function(a){this.ctrls.inputs.origin.setAttribute("name",a)},cancelRequest:function(){},setTargetInputValue:function(a){this.vars.eventLock=true;this.ctrls.inputs.origin.value=a;BX.fireEvent(this.ctrls.inputs.origin,"change");this.vars.eventLock=false},setFakeInputValue:function(a){var b=this.ctrls;if("value" in b.inputs.fake){BX.data(b.inputs.fake,"bx-dc-previous-value",a);b.inputs.fake.value=a}else{if(a==""){a=this.opts.messages.notSelected}b.inputs.fake.innerHTML=BX.util.htmlspecialchars(a)}},setValueVariable:function(a){this.vars.value=a},fillCache:function(c,d){var a=this.vars;if(!c.length){return}if(!BX.type.isPlainObject(d)){d={}}d.modifyOrigin=d.modifyOrigin||a.cache.search.origin===false;var e=d.modifyOriginPosition=="prepend"?"unshift":"push";if(a.cache.search.origin===false){a.cache.search.origin=[]}for(var b in c){if(!c.hasOwnProperty(b)){continue}if(d.modifyOrigin){a.cache.search.origin[e](c[b].VALUE)}a.cache.nodes[c[b].VALUE]=c[b]}this.fireEvent("after-cache-filled",[])},getLastSource:function(){return this.vars.lastSource},toggleDropDown:function(){if(this.vars.allEventMutex){return}if(this.vars.opened){this.hideDropdown()}else{this.tryDisplayPage("toggle")}},remove:function(){if(BX.type.isDomNode(this.ctrls.scope)){this.ctrls.scope.innerHTML=""}BX.unbindAll(this);if(this.vars.pager!=null){this.vars.pager.remove();this.vars.pager=null}if(this.vars.selector!=null){this.vars.selector.remove();this.vars.selector=null}},getLastPageIndex:function(){return Math.ceil(this.vars.filtered.length/this.opts.pageSize)-1},checkPageIsFirst:function(a){return a==0},checkPageIsLast:function(a){return a==this.getLastPageIndex()},checkPageIsOutOfRange:function(a){return a<0||a>this.getLastPageIndex()},setInitialValue:function(){var a=false;if(this.opts.selectedItem!==false){a=this.opts.selectedItem}else{if(this.ctrls.inputs.origin.value.length>0){a=this.ctrls.inputs.origin.value}}if(a!==false&&typeof a!="undefined"){this.setValue(a)}},discoverItems:function(d){var c=this.vars,b=this;var a=new BX.deferred();a.done(function(e){if(typeof e!="undefined"){b.fillCache(e.items)}c.loader.hide();c.allEventMutex=false;d.call(this)});a.fail(function(){c.loader.hide();c.allEventMutex=false;b.displayNothingFound()});if(BX.util.getObjectLength(c.cache.nodes)==0){c.loader.show();c.allEventMutex=true;a.startRace(1000,false);this.fireEvent("item-list-discover",[a])}else{a.resolve()}},tryDisplayPage:function(d){var b=this.vars,a=this,c=this.ctrls.inputs.fake.value;b.applyFilter=(d=="search"&&BX.type.isNotEmptyString(c));b.lastSource=d;this.discoverItems(function(){a.fireEvent("before-display-page",[]);var h=b.applyFilter?0:a.getPageNumberOfSelected();b.filtered=[];if(b.applyFilter){var f=c.toLowerCase();for(var e in b.cache.search.origin){if(!b.cache.search.origin.hasOwnProperty(e)){continue}var g=b.cache.search.origin[e];if(b.cache.nodes[g].DISPLAY.toLowerCase().indexOf(f)==0){b.filtered.push(g)}}}else{b.filtered=b.cache.search.origin}if(b.filtered==false){b.filtered=[]}b.pager.cleanUp();b.selector.cleanUp();a.displayPage(h)})},displayPage:function(b){var a=this.getPage(b);if(a.length==0){this.displayNothingFound()}else{this.displayVariants(a,b)}},getPage:function(b){var a=this.vars,c=this.opts;return a.filtered.slice((b*c.pageSize),((b+1)*c.pageSize))},getPageNumberOfSelected:function(){if(this.vars.value==false){return 0}var a=this.vars;var c=0;for(var b in a.cache.search.origin){if(!a.cache.search.origin.hasOwnProperty(b)){continue}if(a.cache.search.origin[b]==this.vars.value){break}c++}if(c>a.cache.search.origin.length){return 0}return Math.floor(c/this.opts.pageSize)},displayNothingFound:function(){BX.cleanNode(this.ctrls.vars);if(BX.type.isElementNode(this.ctrls.nothingFound)){this.whenNothingFoundToggle(true)}else{var a=this.vars.pager;a.cleanUp();this.vars.selector.cleanUp();a.setTopReached();a.setBottomReached();a.appendPage(this.whenRenderNothingFound(this.opts.messages.nothingFound));this.showDropdown()}this.fireEvent("nothing-found")},displayVariants:function(i,l){var j=this.ctrls,n=this.vars,d=this.opts,b=this.sys.code;this.hideNothingFound();var g=[];var c=[];if(n.lastSource=="toggle"&&l==0&&n.value!==false){var a=this.createItemForPage("",{DISPLAY:d.messages.clearSelection},g,c);BX.addClass(a,"bx-ui-"+b+"-deselect-item")}var m={};for(var f in i){if(!i.hasOwnProperty(f)){continue}this.createItemForPage(i[f],n.cache.nodes[i[f]],g,c);m[n.cache.nodes[i[f]].VALUE]=g[f]}this.fireEvent("after-page-built",[l,g,c]);this.showDropdown();n.selector.addPage(c,l);if(this.checkPageIsLast(l)){n.pager.setBottomReached()}var e=this.vars.pager.getPageCount();n.pager.lockScrollEvents();n.pager.addPage(g,l);if(e==0){var h=false;if(n.value!==false){this.vars.selector.selectById(n.value);h=n.value}else{this.vars.selector.selectFirst();h=this.vars.selector.getSelected().id}if(h!==false&&typeof m[h]!="undefined"){this.vars.pager.scrollToNode(m[h])}}n.pager.unLockScrollEvents();n.pager.dispatchScrollEvents();this.fireEvent("after-page-display",[n.cache.nodes,l])},createItemForPage:function(f,a,e,d,b){var c=this.whenRenderVariant(a)[0];BX.data(c,"bx-"+this.sys.code+"-item-value",f);this.fireEvent("after-item-append",[c]);e[b?"unshift":"push"](c);d[b?"unshift":"push"]({id:f,data:{node:c}});return c},hideNothingFound:function(){if(BX.type.isElementNode(this.ctrls.nothingFound)){this.whenNothingFoundToggle(false)}},showDropdown:function(){if(this.vars.opened){return}if(this.vars.opened){return}var e=!this.vars.opened;this.vars.opened=true;BX.show(this.ctrls.dropdown);var d=BX.height(this.ctrls.dropdown);BX.hide(this.ctrls.dropdown);var a=this.ctrls.inputs.fake;var c=BX.pos(a);var b=BX.scrollTop(window)+BX.height(window)-(Math.ceil(c.top)+c.height);this.whenDropdownToggle.apply(this,[true,b-d<-20,c.height,e])},hideDropdown:function(){this.vars.opened=false;this.whenDropdownToggle.apply(this,[false,false,0,true])},deselectItem:function(){var a=this.vars,c=this.ctrls,b=this.opts;this.setCurrentValue("");this.fireEvent("after-deselect-item")},selectItem:function(b){var a=this.vars,d=this.ctrls,c=this.opts;a.value=b;d.inputs.origin.value=a.cache.nodes[b].VALUE;this.setFakeInputValue(this.whenItemSelect.apply(this,[b]));this.setCurrentValue(b);this.hideDropdown();this.fireEvent("after-select-item",[a.value])},setCurrentValue:function(b){var c=this.opts,a=this.vars;a.value=b==""?false:b;this.setTargetInputValue(b)},whenItemSelect:function(a){return this.vars.cache.nodes[a]["DISPLAY"]},whenToggleItemGlow:function(a,b){BX[b?"addClass":"removeClass"](a.node,"bx-ui-"+this.sys.code+"-variant-active")},whenDropdownToggle:function(a,b,c,d){if(a){if(d){this.whenDecideDropdownOrient(b,c,d)}BX.show(this.ctrls.dropdown)}else{BX.hide(this.ctrls.dropdown)}this.fireEvent("after-popup-toggled",[a])},whenDecideDropdownOrient:function(a,b){var d=this.ctrls;if(a){var c=BX.style(d.dropdown,"top");if(c!="auto"){BX.data(d.dropdown,"pane-top",c)}BX.style(d.dropdown,"top","auto");BX.style(d.dropdown,"bottom",(b+this.opts.pageUpWardOffset)+"px")}else{var c=BX.data(d.dropdown,"pane-top");if(typeof c!="undefined"){BX.style(d.dropdown,"top",c)}BX.style(d.dropdown,"bottom","auto")}},whenNothingFoundToggle:function(a){BX[a?"show":"hide"](this.ctrls.nothingFound)},whenRenderError:function(a){if(typeof this.tmpls.error=="string"){return this.createNodesByTemplate("error",{message:a},true)[0]}return BX.create("div",{props:{className:"bx-ui-"+this.sys.code+"-error"},text:a})},whenRenderNothingFound:function(a){if(typeof this.tmpls["nothing-found"]=="string"){return this.createNodesByTemplate("nothing-found",{message:a},true)[0]}return this.whenRenderError(a)},whenLoaderToggle:function(a){this[a?"setCSSState":"dropCSSState"]("items-discover-in-progress")},whenRenderVariant:function(a){this.fireEvent("before-render-variant",[a]);if(typeof this.tmpls["dropdown-item"]=="string"){return this.createNodesByTemplate("dropdown-item",a,true)}return[BX.create("div",{props:{className:"bx-ui-"+this.sys.code+"-variant"},text:a.DISPLAY})]}});BX.ui.itemSelectManager=function(){this.selectFirst=function(){if(this.head!=null){this.selectById(this.head.id)}};this.selectNext=function(a){this.jumpToDistance(true,a)};this.selectPrevious=function(a){this.jumpToDistance(false,a)};this.selectById=function(b){var a=this.data[b];if(typeof a=="undefined"){return}if(this.current!=null){this.fireEvent("item-deselect",[this.current.id,this.current.data])}this.fireEvent("item-select",[b,a.data]);this.current=a};this.getSelected=function(){if(this.current==null){return undefined}return{id:this.current.id,data:this.current.data}};this.addPage=function(b,a){if(this.range==false){this.appendData(b);this.range=[a,a]}else{if(a>this.range[1]){this.appendData(b);this.range[1]++}else{if(a<this.range[0]){this.prependData(b);this.range[0]--}}}};this.cleanUp=function(){this.data={};this.head=null;this.tail=null;this.current=null;this.range=false};this.remove=function(){this.cleanUp()};this.fireEvent=function(a,b,c){c=c||this;b=b||[];BX.onCustomEvent(c,"bx-ui-item-select-manager-"+a,b)},this.bindEvent=function(a,b){BX.addCustomEvent(this,"bx-ui-item-select-manager-"+a,b)},this.jumpToDistance=function(b,d){if(this.current!=null){if(!d){d=1}var c=this.current;for(var a=0;a<d;a++){if(c[b?"next":"previous"]==null){break}c=c[b?"next":"previous"]}if(c!=null){this.selectById(c.id)}}};this.appendData=function(b){for(var a=0;a<b.length;a++){this.append(b[a])}};this.prependData=function(b){for(var a=b.length-1;a>=0;a--){this.prepend(b[a])}};this.append=function(b){var a=this.tail;this.data[b.id]={id:b.id,data:b.data,next:null,previous:a};if(this.tail!=null){this.tail.next=this.data[b.id]}if(this.head==null){this.head=this.data[b.id]}this.tail=this.data[b.id];if(this.current==null){this.current=this.data[b.id]}};this.prepend=function(b){var a=this.head;this.data[b.id]={id:b.id,data:b.data,next:a,previous:null};if(this.head!=null){this.head.previous=this.data[b.id]}if(this.tail==null){this.tail=this.data[b.id]}this.head=this.data[b.id];if(this.current==null){this.current=this.data[b.id]}};this.cleanUp();return this};