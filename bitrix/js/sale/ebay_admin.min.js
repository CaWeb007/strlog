(function(a){if(!BX.Sale){BX.Sale={}}if(!BX.Sale.EbayAdmin){BX.Sale.EbayAdmin={}}BX.Sale.EbayAdmin={ajaxUrl:"/bitrix/admin/sale_ebay_ajax.php",startFeed:function(c,e,d){BX.showWait();var b={action:"startFeed",type:c,siteId:e,sessid:BX.bitrix_sessid()};if(d){b.startPos=d}BX.ajax({timeout:120,method:"POST",dataType:"json",url:BX.Sale.EbayAdmin.ajaxUrl,data:b,onsuccess:function(f){BX.closeWait();if(f&&f.COMPLETED){alert(BX.message("SALE_EBAY_EXCHANGE_OK"))}else{if(f&&f.ERROR){alert(BX.message("SALE_EBAY_EXCHANGE_ERROR")+".\n"+f.ERROR)}else{if(f){var g=f.END_ROW||0;BX.Sale.EbayAdmin.startFeed(c,g)}else{alert(BX.message("SALE_EBAY_EXCHANGE_ERROR"))}}}},onfailure:function(){BX.debug("Feed failure!")}})},addIblockSelect:function(){var b=BX("SALE_EBAY_IBLOCK_CHOOSE").lastElementChild.cloneNode(true);BX("SALE_EBAY_IBLOCK_CHOOSE").appendChild(b);if(b.firstElementChild.options["0"]){b.firstElementChild.value="0"}b.firstElementChild.name=b.firstElementChild.id=BX.Sale.EbayAdmin.iblockSelectNameIncrement(b.firstElementChild.name);b.firstElementChild.setAttribute("onchange",BX.Sale.EbayAdmin.iblockSelectNameIncrement(b.firstElementChild.getAttribute("onchange")));if(b.firstElementChild.options["0"]){b.firstElementChild.value="0"}b.lastElementChild.name=b.lastElementChild.id=BX.Sale.EbayAdmin.iblockSelectNameIncrement(b.lastElementChild.name)},iblockSelectNameIncrement:function(b){if(!b||!b.replace){return}return b.replace(/(.*)\[(\d+)\](.*)/,"$1[$21]$3")},refreshCategoriesData:function(c){BX.showWait();var b={action:"refreshCategoriesData",siteId:c,sessid:BX.bitrix_sessid()};BX.ajax({timeout:300,method:"POST",dataType:"json",url:BX.Sale.EbayAdmin.ajaxUrl,data:b,onsuccess:function(d){BX.closeWait();if(d&&d.COUNT){alert("Refreshed "+d.COUNT+" categories.")}else{if(d&&d.ERROR){alert(d.ERROR)}else{BX.debug("BX.Sale.EbayAdmin.refreshCategoriesData error!")}}},onfailure:function(){BX.debug("BX.Sale.EbayAdmin.refreshCategoriesData failure!")}})},refreshCategoriesPropsData:function(c){BX.showWait();var b={action:"refreshCategoriesPropsData",siteId:c,sessid:BX.bitrix_sessid()};BX.ajax({timeout:120,method:"POST",dataType:"json",url:BX.Sale.EbayAdmin.ajaxUrl,data:b,onsuccess:function(d){BX.closeWait();if(d&&d.COUNT){alert("Refreshed properties for "+d.COUNT+" categories.")}else{if(d&&d.ERROR){alert(d.ERROR)}else{BX.debug("BX.Sale.EbayAdmin.refreshCategoriesPropsData error!")}}},onfailure:function(){BX.debug("BX.Sale.EbayAdmin.refreshCategoriesPropsData failure!")}})},setOpenerFieldsFromHash:function(f){var b=true,e="{";if(a.location.hash){var h=a.location.hash.substring(1).split("&");for(var d in h){if(!h.hasOwnProperty(d)){continue}var g=h[d].split("=");if(!g){continue}var c=BX.Sale.EbayAdmin.setOpenerFieldFromHash(g[0],g[1]);b=b&&c;if(e!="{"){e+=", "}e+='"'+g[0]+'":"'+g[1]+'"'}}if(e!="{"){e+=", "}e+='"messageType":"'+f+'"}';if(parent.window.opener){parent.window.opener.postMessage(e,a.location.origin)}a.addEventListener("message",function(i){if(i.data=="MESSAGE_RECEIVED"){a.close()}},false);return b},setOpenerFieldFromHash:function(c,g){var b="SALE_EBAY_SETTINGS_"+c,f=null,d=false;if(parent.window.opener!==null){try{f=parent.window.opener.document.getElementById(b);d=true}catch(h){}}if(!f){f=BX(b)}if(f){g=decodeURIComponent(g);if(f.type=="text"){f.value=g}else{if(f.type=="textarea"){f.value=g}}}return d},showAlertOpener:function(b){if(parent.window.opener!==null){try{parent.window.opener.alert(b);return true}catch(c){}}a.alert(b);return false},addSftpTokenEventListener:function(c,b){a.addEventListener("message",function(f){if(f.origin==a.location.origin||f.origin=="http://www.1c-bitrix.ru.smn"||f.origin=="https://www.1c-bitrix.ru"){var d=BX("SALE_EBAY_SETTINGS_SFTP_TOKEN"),e=BX("SALE_EBAY_SETTINGS_SFTP_TOKEN_EXP"),g=JSON.parse(f.data);if(!g.messageType||g.messageType!="SFTP_TOKEN"){return}if(e&&g.SFTP_TOKEN_EXP){e.value=decodeURIComponent(g.SFTP_TOKEN_EXP)}if(d&&g.SFTP_TOKEN){d.value=decodeURIComponent(g.SFTP_TOKEN)}if((g.SFTP_ACCOUNT_STATE=="ACTIVE"||g.SFTP_ACCOUNT_STATE=="SUBSCRIBED")&&g.SFTP_TOKEN!=""){alert(c.messageOk);if(c.submit&&e&&e.form){e.form.submit()}}else{alert(c.messageError)}f.source.postMessage("MESSAGE_RECEIVED",f.origin)}},false)},addApiTokenListener:function(b){a.addEventListener("message",function(d){if(d.origin==a.location.origin||d.origin=="http://www.1c-bitrix.ru.smn"||d.origin=="http://www.1c-bitrix.ru"){var f=BX("SALE_EBAY_SETTINGS_API_TOKEN"),c=BX("SALE_EBAY_SETTINGS_API_TOKEN_EXP"),e=JSON.parse(d.data);if(!e.messageType||e.messageType!="API_TOKEN"){return}if(c&&e.API_TOKEN_EXP){c.value=decodeURIComponent(e.API_TOKEN_EXP)}if(f&&e.API_TOKEN){f.value=decodeURIComponent(e.API_TOKEN);d.source.postMessage("MESSAGE_RECEIVED",d.origin);alert(b.messageOk)}else{alert(b.messageError)}}},false)}}})(window);