BX.namespace("BX.Security.UserEdit");BX.Security.UserEdit.Otp=(function getUserOtp(d){var a=function(l,j){var n={successfulUrl:document.location.href,deactivateDays:null,availableTypes:null,ui:{activateButtonId:"otp-activate",deactivateButtonId:"otp-deactivate",defferButtonId:"otp-deffer",mandatoryActivateButtonId:"otp-mandatory-active",reinitializeButtonId:"otp-reinitialize"}};j=j||{};this._options=h(n,j);this.userId=l||0;var o={availableTypes:this._options.availableTypes,successfulUrl:this._options.successfulUrl};this.device=new b(this.userId,o);this.mobile=new e(this.userId,o);this.recovery=new c(this.userId,o);var k=null;k=d(this._options.ui.deactivateButtonId);if(k){this.initializeDeactivatePopup(k,"deactivate")}k=d(this._options.ui.defferButtonId);if(k){this.initializeDeactivatePopup(k,"deffer")}k=d(this._options.ui.mandatoryActivateButtonId);if(k){this.initializeDeactivatePopup(k,"deffer",5)}k=d(this._options.ui.activateButtonId);if(k){d.bind(k,"click",this.mobile.activateOtp.bind(this.mobile))}k=d(this._options.ui.reinitializeButtonId);if(k){d.bind(k,"click",d.proxy(function m(){var q=window.document.body.querySelectorAll('[data-show-on-reinitialize="yes"]');[].forEach.call(q,function p(r){if(r.style.display){r.style.display=""}else{r.style.display="none"}},this)},this))}};a.prototype.initializeDeactivatePopup=function(l,n,m){n=n||"deactivate";if(this._options.deactivateDays){var j=[];for(var k in this._options.deactivateDays){if(!this._options.deactivateDays.hasOwnProperty(k)){continue}if(m&&k<m){continue}j.push({TEXT:this._options.deactivateDays[k],ONCLICK:this.mobile.deactivateOtp.bind(this.mobile,null,n,k)})}d.bind(l,"click",(function(o){if(o){o.preventDefault()}d.adminShowMenu(l,j,{active_class:"",close_on_click:true})}).bind(this))}else{d.bind(l,"click",this.mobile.deactivateOtp.bind(this,null,n,m?m:0))}};var i=function(k,j){var l={actionUrl:"/bitrix/admin/security_otp.ajax.php?lang="+d.message("LANGUAGE_ID"),onCompleteCallback:d.DoNothing,ui:{showButtonId:null,id:null}};j=j||{};this._options=h(l,j);this.initialized=false;this.popup=null;this.container=null;this.errorContainer=null;this.userId=k;this.showButton=d(this._options.ui.showButtonId);this.type=null;this.typeMenu=[];d.bind(this.showButton,"click",this.show.bind(this))};i.prototype.show=function(j){if(!this.initialized){this.initialize()}else{this.cleanPopup()}this.onShow();if(j){j.preventDefault()}};i.prototype.onShow=function(){};i.prototype.onInitialize=function(){};i.prototype.getSecret=function(){};i.prototype.getType=function(){return this.type};i.prototype.initialize=function(){this.initialized=true;this.container=d(this._options.ui.id);this.popup=this.getPopup();this.errorContainer=this.container.querySelector('[data-role="error-container"]');for(var m in this._options.availableTypes){if(!this._options.availableTypes.hasOwnProperty(m)){continue}this.typeMenu.push({TEXT:this._options.availableTypes[m].title,ONCLICK:(function l(o,n){if(n===void 0){n=true}this.type=o;this.onShow(true,n)}).bind(this,this._options.availableTypes[m].type,this._options.availableTypes[m]["required_two_code"])})}var j=this.container.querySelectorAll('input[data-role="check-code"]');this.popup.ClearButtons();this.popup.SetButtons([{title:d.message("JS_CORE_WINDOW_SAVE"),id:"check-button",className:"adm-btn-save",action:(function k(n){if(n){n.preventDefault()}this.onCheck(j[0],j[1]||null)}).bind(this)},d.CDialog.btnCancel]);this.onInitialize()};i.prototype.getPopup=function(){return new d.CDialog({title:this.container.getAttribute("data-title")||"",resizable:false,content:this.container})};i.prototype.cleanPopup=function(){[].forEach.call(this.container.querySelectorAll('[data-autoclear="yes"]'),function j(k){switch(k.tagName){case"INPUT":k.value="";break;case"SELECT":break;default:d.cleanNode(k)}},this)};i.prototype.sendRequest=function(l,k,m,j){d.showWait();k=k||{};k.action=l||"check";k.sessid=d.bitrix_sessid();if(!k.userId){k.user=this.userId}k=d.ajax.prepareData(k);return d.ajax({method:"POST",dataType:"json",url:this._options.actionUrl,data:k,onsuccess:this.onRequestSuccess.bind(this,m),onfailure:this.onRequestFailed.bind(this,j)})};i.prototype.onRequestSuccess=function(k,j){d.closeWait();if(!j.status){this.onRequestFailed(null,j)}else{if(j.status!=="ok"){this.onRequestFailed(null,j)}else{k(j)}}};i.prototype.onRequestFailed=function(k,j){d.closeWait();if(!k){if(j.error){this.showError(j.error)}else{this.showError(d.message("SEC_OTP_UNKNOWN_ERROR"))}}else{k(j)}};i.prototype.showError=function(k){if(!this.errorContainer){return}var j=d.create("div",{children:[d.create("div",{text:d.message("SEC_OTP_ERROR_TITLE")}),d.create("div",{html:k})],attrs:{className:"bx-notice error"}});this.errorContainer.appendChild(j)};i.prototype.clearErrors=function(){if(!this.errorContainer){return}d.cleanNode(this.errorContainer)};i.prototype.onCheck=function(k,j){this.clearErrors();this.activate(k.value,j?j.value:"")};i.prototype.activate=function(k,j){var l={secret:this.getSecret(),type:this.getType(),sync1:k,sync2:j};this.sendRequest("check_activate",l,d.proxy(this.onFinish,this))};i.prototype.onFinish=function(){window.location.replace(this._options.successfulUrl)};i.prototype.showPopup=function(){this.popup.Show();this.popup.adjustSizeEx();d.defer(this.popup.adjustPos,this.popup)()};i.prototype.showTypeTitle=function(j){var k=this.container.querySelectorAll("[data-show-type]");[].forEach.call(k,function l(m){if(m.getAttribute("data-show-type")==j){m.style.display=""}else{m.style.display="none"}})};i.prototype.showHideRedundantCodes=function(j){var k=this.container.querySelectorAll('[data-require-two-codes="yes"]');[].forEach.call(k,function l(m){if(j){m.style.display=""}else{m.style.display="none"}})};var b=function(k,j){var l={ui:{showButtonId:"otp-connect-device",id:"otp-device-popup"}};j=j||{};j=h(l,j);this.secretCodeElement=null;this.typeElement=null;b.superclass.constructor.call(this,k,j)};d.extend(b,i);b.prototype.onShow=function(k,j){if(!k&&this.typeMenu.length){d.adminShowMenu(this.showButton,this.typeMenu,{active_class:"adm-btn-save-active"});return}this.showHideRedundantCodes(j);this.showTypeTitle(this.type);this.showPopup()};b.prototype.onInitialize=function(){this.secretCodeElement=this.container.querySelector('[data-role="secret-code"]');this.typeElement=this.container.querySelector('[data-role="type-selector"]')};b.prototype.getSecret=function(){return this.secretCodeElement.value};var e=function(k,j){var l={ui:{showButtonId:"otp-connect-mobile",id:"otp-mobile-popup"}};j=j||{};j=h(l,j);this.secret=null;this.qrCodeElement=null;this.appSecretElement=null;e.superclass.constructor.call(this,k,j)};d.extend(e,i);e.prototype.onShow=function(j){if(!j&&this.typeMenu.length){d.adminShowMenu(this.showButton,this.typeMenu,{active_class:"adm-btn-save-active"});return}this.sendRequest("get_vew_params",{type:this.type||""},(function k(l){this.secret=l.data.secret;this.type=l.data.type;this.showHideRedundantCodes(l.data.isTwoCodeRequired);this.showTypeTitle(l.data.type);this.drawQrCode(this.qrCodeElement,l.data.provisionUri);this.appSecretElement.innerHTML=d.util.htmlspecialchars(l.data.appSecretSpaced);this.showPopup()}).bind(this))};e.prototype.onInitialize=function(){this.qrCodeElement=this.container.querySelector('[data-role="qr-code-block"]');this.appSecretElement=this.container.querySelector('[data-role="app-code-block"]');d.bind(d("connect-mobile-manual-input"),"click",function(){d("connect-by-manual-input").style.display="";d("connect-by-qr").style.display="none"});d.bind(d("connect-by-manual-input"),"click",function(){d("connect-by-manual-input").style.display="none";d("connect-by-qr").style.display=""})};e.prototype.getSecret=function(){return this.secret};e.prototype.drawQrCode=function(j,k){new QRCode(j,{text:k,width:200,height:200,colorDark:"#000000",colorLight:"#ffffff",correctLevel:QRCode.CorrectLevel.H})};e.prototype.deactivateOtp=function(l,m,j){if(l){l.preventDefault()}this.sendRequest(m,{days:j},(function k(){window.location.replace(this._options.successfulUrl)}).bind(this))};e.prototype.activateOtp=function(j){if(j){j.preventDefault()}this.sendRequest("activate",null,(function k(){window.location.replace(this._options.successfulUrl)}).bind(this))};var c=function(k,j){var l={actionUrl:"/bitrix/admin/security_otp.ajax.php?lang="+d.message("LANGUAGE_ID"),publicUrl:"/bitrix/admin/security_otp_recovery_codes.php?lang="+d.message("LANGUAGE_ID"),ui:{showButtonId:"otp-show-recovery-codes",id:"otp-recovery-codes"}};j=j||{};j=h(l,j);c.superclass.constructor.call(this,k,j)};d.extend(c,i);c.prototype.onShow=function(k){k=k||null;this.sendRequest(k?"regenerate_recovery_codes":"get_recovery_codes",k?null:{allow_regenerate:"Y"},(function j(l){this.drawRecoveryCodes(l.codes);var m=document.body.querySelector('[data-role="otp-recovery-codes-warning"]');if(m){m.style.display="none"}this.showPopup()}).bind(this))};c.prototype.onInitialize=function(){this.popup.ClearButtons();this.codesContainer=this.container.querySelector('[data-role="recoverycodes-container"]');this.codesContainer.style.display="";this.codesTemplate=this.container.querySelector('[data-role="recoverycode-template"]').cloneNode(true);d.bind(this.container.querySelector('[data-role="print-codes"]'),"click",(function j(){window.open(this._options.publicUrl+"&user="+this.userId)}).bind(this));d.bind(this.container.querySelector('[data-role="save-codes"]'),"click",(function k(){window.location.href=this._options.publicUrl+"&action=download&user="+this.userId}).bind(this));d.bind(this.container.querySelector('[data-role="regenerate-codes"]'),"click",this.onShow.bind(this,true))};c.prototype.drawRecoveryCodes=function(j){[].forEach.call(this.codesContainer.querySelectorAll('[data-autoclear="yes"]'),function l(m){d.remove(m)},this);[].forEach.call(j,function k(n){var m=this.codesTemplate.cloneNode(true);if(!n.used){d.adjust(m,{text:n.value,attrs:{className:"active"}})}else{m.innerHTML="";d.adjust(m,{html:"",children:[d.create("span",{text:n.value}),d.create("span",{text:" ("+f(n.using_date)+")"})],attrs:{className:"used"}})}this.codesContainer.appendChild(m)},this)};function h(j,l){for(var k in l){if(!l.hasOwnProperty(k)){continue}if(l[k]&&l[k].constructor===Object){if(j[k]&&j[k].constructor===Object){j[k]=h(j[k],l[k])}else{j[k]=g(l[k])}}else{j[k]=l[k]}}return j}function g(j){return JSON.parse(JSON.stringify(j))}function f(j){var k=null;if(!d.isAmPmMode()){k=[["tommorow","tommorow, H:i"],["today","today, H:i"],["yesterday","yesterday, H:i"],["",d.date.convertBitrixFormat(d.message("FORMAT_DATETIME"))]]}else{k=[["tommorow","tommorow, g:i a"],["today","today, g:i a"],["yesterday","yesterday, g:i a"],["",d.date.convertBitrixFormat(d.message("FORMAT_DATETIME"))]]}return d.date.format(k,parseInt(j),d.date.convertToUTC(new Date()))}return a}(BX));