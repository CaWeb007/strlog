(function(c){if(BX.CAutoSave&&top.BX.CAutoSave){return}BX.CAutoSave=function(f){this.FORM_NAME=f.form;this.FORM_MARKER=f.form_marker;this.FORM_ID=f.form_id;this.PERIOD=f.period||[4001,20990];this.RESTORE_DATA=null;this.TIMERS=[null,null];this.bInited=false;this.bRestoreInProgress=false;this.DISABLE_STANDARD_NOTIFY=f.DISABLE_STANDARD_NOTIFY;this.NOTIFY_CONTEXT=null;BX.ready(BX.defer(this.Prepare,this));BX.garbage(BX.delegate(this.Clear,this));if(BX.type.isNotEmptyString(this.FORM_MARKER)&&BX(this.FORM_MARKER)){var e=BX(this.FORM_MARKER);if(BX(e.form)&&BX.type.isNotEmptyString(e.form.name)){BX.addCustomEvent(c.top,"onExtAutoSaveReset_"+e.form.name,BX.proxy(this.Reset,this))}}};BX.CAutoSave.prototype.Prepare=function(){var e;if(this.FORM_NAME&&BX.type.isString(this.FORM_NAME)){this.FORM=document.forms[this.FORM_NAME]}else{if(this.FORM_MARKER&&BX.type.isString(this.FORM_MARKER)){this.FORM=(BX(this.FORM_MARKER)||{form:null}).form}}if(!BX.type.isDomNode(this.FORM)){return}this.FORM.BXAUTOSAVE=this;BX.bind(this.FORM,"submit",BX.proxy(this.ClearTimers,this));for(e=0;e<this.FORM.elements.length;e++){this.RegisterInput(this.FORM.elements[e])}setTimeout(BX.delegate(this._PrepareAfter,this),10)};BX.CAutoSave.prototype.RegisterInput=function(e){if(BX.type.isString(e)){setTimeout(BX.delegate(function(){this.RegisterInput(this.FORM[e]||BX(e))},this),10)}else{if(BX.type.isDomNode(e)){if(e.type!="button"&&e.type!="submit"&&e.type!="reset"&&e.type!="image"&&e.type!="hidden"){BX.bind(e,"change",BX.proxy(this.Init,this));if(e.type=="text"||e.type=="textarea"){BX.bind(e,"keyup",BX.proxy(this.Init,this))}if(e.type=="checkbox"||e.type=="radio"){BX.bind(e,"click",BX.proxy(this.Init,this))}}}}};BX.CAutoSave.prototype.UnRegisterInput=function(e){if(BX.type.isString(e)){e=this.FORM[e]||BX(e)}if(BX.type.isDomNode(e)){BX.unbind(e,"change",BX.proxy(this.Init,this));BX.unbind(e,"keyup",BX.proxy(this.Init,this));BX.unbind(e,"click",BX.proxy(this.Init,this))}};BX.CAutoSave.prototype._PrepareAfter=function(){BX.onCustomEvent(this.FORM,"onAutoSavePrepare",[this,BX.proxy(this.Init,this)]);if(this.RESTORE_DATA){var f=this.FORM.name||Math.random();BX.addCustomEvent("onExtAutoSaveRestoreClick_"+f,BX.proxy(this.Restore,this));var e=this._NotifyContext();if(e){e.Notify(BX.message("AUTOSAVE")+' <a href="javascript:void(0)" onclick="BX.CAutoSave.Restore(\''+BX.util.urlencode(f)+"', this); return false;\">"+BX.message("AUTOSAVE_R")+"</a>")}BX.onCustomEvent(this.FORM,"onAutoSaveRestoreFound",[this,this.RESTORE_DATA])}};BX.CAutoSave.prototype.Init=function(){if(this.TIMERS[0]){clearTimeout(this.TIMERS[0]);this.TIMERS[0]=null}this.TIMERS[0]=setTimeout(BX.proxy(this.TimerHandler,this),this.PERIOD[0]);if(!this.TIMERS[1]){this.TIMERS[1]=setInterval(BX.proxy(this.Save,this),this.PERIOD[1])}BX.onCustomEvent(this.FORM,"onAutoSaveInit",[this]);return true};BX.CAutoSave.prototype.TimerHandler=function(){if(this.TIMERS[1]){clearInterval(this.TIMERS[1]);this.TIMERS[1]=null}this.Save()};BX.CAutoSave.prototype.Save=function(){if(this.FORM&&BX.isNodeInDom(this.FORM)){var h,f,k,l={autosave_id:this.FORM_ID,form_data:{}};for(h=0;h<this.FORM.elements.length;h++){k=this.FORM.elements[h];if(k.name&&k.name!="sessid"&&k.name!="lang"&&k.name!="autosave_id"){var m=k.name,e="",g=k.type.toLowerCase();switch(g){case"button":case"submit":case"reset":case"image":case"file":case"password":break;case"radio":case"checkbox":if(k.checked){e=k.value||"on"}break;case"select-multiple":m=m.substring(0,m.length-2);e=[];for(f=0;f<k.options.length;f++){if(k.options[f].selected){e.push(k.options[f].value)}}break;default:e=k.value}if(m.indexOf("[]")>0){m=d(m);if(typeof(l.form_data[m])=="undefined"){l.form_data[m]=[e]}else{l.form_data[m].push(e)}}else{l.form_data[d(m)]=e}}}BX.onCustomEvent(this.FORM,"onAutoSave",[this,l.form_data]);BX.ajax.post("/bitrix/tools/autosave.php?bxsender=core_autosave&sessid="+BX.bitrix_sessid(),l,BX.proxy(this._Save,this))}else{this.Clear()}};BX.CAutoSave.prototype.Reset=function(){if(this.FORM&&BX.isNodeInDom(this.FORM)){BX.ajax.post("/bitrix/tools/autosave.php?bxsender=core_autosave&action=reset&sessid="+BX.bitrix_sessid(),{autosave_id:this.FORM_ID},null)}};BX.CAutoSave.prototype._Save=function(e){BX.onCustomEvent(this.FORM,"onAutoSaveFinished",[this,e])};BX.CAutoSave.prototype.Restore=function(p,g){if(p){this.RESTORE_DATA=b(p)}else{if(this.FORM&&this.RESTORE_DATA){BX.onCustomEvent(this.FORM,"onAutoSaveRestore",[this,this.RESTORE_DATA]);this.bRestoreInProgress=true;for(var r=0;r<this.FORM.elements.length;r++){var k=this.FORM.elements[r];if(k&&BX.type.isDomNode(k)&&k.name){var s=undefined,l=k.name;if(k.type=="select-multiple"){l=k.name.substring(0,k.name.length-2)}s=this.RESTORE_DATA[l];if(l.indexOf("[]")>0&&BX.type.isArray(s)){s=this.RESTORE_DATA[l].shift()}if(k.type!="checkbox"&&typeof s=="undefined"){continue}var e=false;switch(k.type){case"radio":if(!k.checked&&!!(s==k.value)){e=true;BX.fireEvent(k,"click")}break;case"checkbox":if(k.checked!=!!(s==k.value)){e=true;BX.fireEvent(k,"click")}break;case"select-one":for(var m=0;m<k.options.length;m++){var f=k.options[m].selected;k.options[m].selected=!!(s==k.options[m].value);e|=k.options[m].selected!=f}break;case"select-multiple":s=this.RESTORE_DATA[k.name.substring(0,k.name.length-2)];for(m=0;m<k.options.length;m++){f=k.options[m].selected;k.options[m].selected=!!(BX.type.isArray(s)&&BX.util.in_array(k.options[m].value,s));e|=k.options[m].selected!=f}break;case"file":case"button":case"image":case"submit":case"reset":case"password":break;default:e=s!=k.value;k.value=s}if(e){BX.fireEvent(k,"change")}}}var h=this._NotifyContext();if(h){h.hideNotify(g.parentNode.parentNode)}this.bRestoreInProgress=false;BX.onCustomEvent(this.FORM,"onAutoSaveRestoreFinished",[this,this.RESTORE_DATA])}}};BX.CAutoSave.prototype._NotifyContext=function(){var e=null;if(!this.DISABLE_STANDARD_NOTIFY){if(this.NOTIFY_CONTEXT){e=this.NOTIFY_CONTEXT}else{if(BX.WindowManager&&BX.WindowManager.Get()){e=BX.WindowManager.Get()}else{if(BX.adminPanel){e=BX.adminPanel}else{if(BX.admin&&BX.admin.panel){e=BX.admin.panel}}}}this.NOTIFY_CONTEXT=e}return e};BX.CAutoSave.prototype.ClearTimers=function(){if(this.TIMERS){clearTimeout(this.TIMERS[0]);clearInterval(this.TIMERS[1])}};BX.CAutoSave.prototype.Clear=function(){if(this.FORM){this.FORM.BXAUTOSAVE=null;for(var e=0;e<this.FORM.elements.length;e++){this.UnRegisterInput(this.FORM.elements[e])}}this.ClearTimers();BX.onCustomEvent(this.FORM,"onAutoSaveClear",[this]);this.FORM=null;this.TIMERS=null};BX.CAutoSave.Restore=function(f,e){BX.onCustomEvent("onExtAutoSaveRestoreClick_"+f,[null,e])};function d(f){var e;while(e=/[^a-zA-Z0-9_\-]/.exec(f)){f=f.replace(e[0],"X"+BX.util.str_pad_left(e[0].charCodeAt(0).toString(),6,"0")+"X")}return f}function a(f){var e;while(e=/X[\d]{6}X/.exec(f)){f=f.replace(e[0],String.fromCharCode(parseInt(e[0].replace(/(^X[0]*)|(X$)/g,""))))}return f}function b(f){var g={};for(var e in f){g[a(e)]=f[e]}return g}top.BX.CAutoSave=BX.CAutoSave})(window);