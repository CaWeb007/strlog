(function(){var c=window.BX;if(c.UpdateStepperRegister){return}var a=new ((function(){var e=function(){this.length=0;this.items={};this.order=[];this.state="ready";this.finish=c.delegate(this.finish,this);this.send=c.delegate(this.send,this);this.onSuccess=c.delegate(this.onSuccess,this);this.onFailure=c.delegate(this.onFailure,this)};e.prototype={getQueue:function(d){d+="";return c.util.array_search(d,this.order)},removeItem:function(f){f+="";var d,g;if(typeof(this.items[f])!=="undefined"){d=this.items[f];g=this.getQueue(f);this.pointer-=(this.pointer>=g?1:0);delete this.items[f];this.order=c.util.deleteFromArray(this.order,g);this.length=this.order.length}return d},getItem:function(d){d+="";return this.items[d]},hasItem:function(d){d+="";return typeof(this.items[d])!=="undefined"},setItem:function(d,f){d+="";if(typeof(f)!=="undefined"){if(typeof(this.items[d])==="undefined"){this.order.push(d);this.length=this.order.length}this.items[d]=f;c.addCustomEvent(f,"onFinish",this.finish)}this.exec();return f},getFirst:function(){var d,g=null;for(var f=0;f<this.order.length;f++){d=this.order[f];if(!!d&&this.hasItem(d)){g=this.getItem(d);break}}return g},timeout:0,exec:function(){if(this.timeout>0){clearTimeout(this.timeout)}if(this.length>0){this.timeout=setTimeout(c.proxy(this.send,this),30000)}},send:function(){var f=[],g;if(this.length>0){c.onCustomEvent(this,"onPrepare",[f,this])}if(f.length>0){c.ajax({method:"POST",dataType:"json",data:{stepper:f},url:"/bitrix/tools/update.php?action=stepper",onsuccess:this.onSuccess,onfailure:this.onFailure})}},onSuccess:function(d){c.onCustomEvent(this,"onSuccess",[d,this]);this.exec()},onFailure:function(d){if(d==="processing"){d="Incorrect server response."}c.onCustomEvent(this,"onFailure",[d,this])},finish:function(d){this.removeItem(d)}};return e})()),b=(function(){var e=function(f,d){this.id=f;this.data=d;this.nodes={container:null,bar:null,steps:null,count:null};this.onPrepare=c.delegate(this.onPrepare,this);this.onSuccess=c.delegate(this.onSuccess,this);this.onFailure=c.delegate(this.onFailure,this);c.defer_proxy(this.bind,this)();a.setItem(this.id,this);c.addCustomEvent(a,"onPrepare",this.onPrepare);c.addCustomEvent(a,"onSuccess",this.onSuccess);c.addCustomEvent(a,"onFailure",this.onFailure)};e.prototype={show:function(d,g){var f=100;if(g>0){f=parseInt(d*100/g)}if(c(this.nodes.bar)){this.nodes.bar.style.width=f+"%"}if(c(this.nodes.steps)){this.nodes.steps.innerHTML=d}if(c(this.nodes.count)){this.nodes.count.innerHTML=g}},bindSteps:0,bind:function(){if(this.bindSteps>100){return}this.bindSteps++;if(c(this.id+"-steps")){this.nodes.container=c(this.id+"-container");this.nodes.bar=c(this.id+"-bar");this.nodes.steps=c(this.id+"-steps");this.nodes.count=c(this.id+"-count");this.nodes.error=c(this.id+"-error")}else{c.defer_proxy(this.bind,this)()}},hide:function(){if(c(this.nodes.container)){c.addClass(this.nodes.container,"main-stepper-hide");c.removeClass(this.nodes.container,"main-stepper-show")}},finish:function(){c.removeCustomEvent(a,"onPrepare",this.onPrepare);c.removeCustomEvent(a,"onSuccess",this.onSuccess);c.removeCustomEvent(a,"onFailure",this.onFailure);c.onCustomEvent(this,"onFinish",[this.id,this])},onPrepare:function(f){for(var d=0;d<this.data.length;d++){if(parseInt(this.data[d]["steps"])<parseInt(this.data[d]["count"])){f.push({moduleId:this.data[d]["moduleId"],"class":this.data[d]["class"]})}}},onSuccess:function(j){if(c.type.isPlainObject(j)&&j.status==="error"){this.onFailure(j.message);return}var d=[],k=[],i,f=0,h=0;for(var g=0;g<this.data.length;g++){k.push({moduleId:this.data[g]["moduleId"],"class":this.data[g]["class"],steps:parseInt(this.data[g]["steps"]),count:parseInt(this.data[g]["count"])})}if(c.type.isArray(j)){for(g=0;g<j.length;g++){for(i=0;i<k.length;i++){if(k[i]["moduleId"]===j[g]["moduleId"]&&k[i]["class"]===j[g]["class"]){d.push({moduleId:j[g]["moduleId"],"class":j[g]["class"],steps:parseInt(j[g]["steps"]),count:parseInt(j[g]["count"])});f+=parseInt(j[g]["steps"]);h+=parseInt(j[g]["count"]);k=c.util.deleteFromArray(k,i);break}}if(k.length<=0){break}}}for(i=0;i<k.length;i++){f+=k[i]["count"];h+=k[i]["count"];d.push({moduleId:k[i]["moduleId"],"class":k[i]["class"],steps:k[i]["count"],count:k[i]["count"]})}this.data=d;if(f<h&&h>0){this.show(f,h)}else{this.hide();this.finish();c.onCustomEvent(window,"onStepperHasBeenFinished",[this])}},onFailure:function(d){this.showError(d);this.finish();c.onCustomEvent(window,"onStepperHasBeenFailed",[this])},showError:function(d){if(c(this.nodes.error)){this.nodes.error.innerHTML=d}if(this.nodes.container){c.addClass(this.nodes.container,"main-stepper-error")}}};return e})();c.UpdateStepperRegister=function(e,d){new b(e,d)}})();