BX.namespace("BX.Main.SiteSpeed");BX.Main.SiteSpeed=(function(){var a=function(b,c){this.privateKey=b;this.accountId=c;this.statServerUrl=document.location.protocol+"//www.1c-bitrix.ru/buy_tmp/ba.php";this.invervals=[{title:BX.message("JS_SITE_SPEED_VERY_FAST"),color:"#d0df6c",inverval:500},{title:BX.message("JS_SITE_SPEED_FAST"),color:"#b3c636",inverval:1000},{title:BX.message("JS_SITE_SPEED_NOT_FAST"),color:"#f0d53e",inverval:1500},{title:BX.message("JS_SITE_SPEED_SLOW"),color:"#f0b23e",inverval:2000},{title:BX.message("JS_SITE_SPEED_VERY_SLOW"),color:"#f2921e",inverval:2500}]};a.prototype.drawIndicator=function(h,m){if(!h||h.result===false||!BX.type.isNumber(h.cnt)){return null}var f=BX.type.isNumber(h.p50)?h.p50:-1;BX(m).style.display="block";var k=[];var g={label:""};var b=0;var d=0;for(var j=0;j<this.invervals.length;j++){d=Math.max(d,this.invervals[j].inverval);k.push({fillAlphas:0.9,fontSize:11,labelText:this.invervals[j].title,lineAlpha:0.5,color:"#000000",lineColor:this.invervals[j].color,title:this.invervals[j].title,type:"column",valueField:j});var e=this.invervals[j].inverval-b;b=this.invervals[j].inverval;g[j]=e}var l=AmCharts.makeChart(m,{type:"serial",theme:"none",rotate:true,dataProvider:[g],valueAxes:[{id:"intervals",stackType:"100%",axisAlpha:0.5,gridAlpha:0,labelFunction:function(p,o,q){var i="";if(p===0){i="0"}else{if(p%20){return""}else{i=BX.Main.SiteSpeed.formatMilliseconds(p/100*d,1)}}return i+" "+BX.message("JS_SITE_SPEED_SECONDS_UNIT")}}],categoryField:"label",categoryAxis:{gridPosition:"start",axisAlpha:0,gridAlpha:0,position:"left"},graphs:k,marginTop:0,marginRight:15,marginLeft:10,marginBottom:30,autoMargins:false,chartCursor:{enabled:false}});if(f>0&&f<d){var n=l.getValueAxisById("intervals");var c=new AmCharts.Guide();c.value=(f/d*100);c.lineColor="#000000";c.lineAlpha=1;c.fillAlpha=0.2;c.fillColor="#000000";c.dashLength=4;c.inside=true;c.above=true;c.lineThickness=2;c.position="top";n.addGuide(c);l.validateNow()}return l};a.prototype.drawHisto=function(g,j){if(!g||g.result===false||!BX.type.isNumber(g.cnt)){return null}BX(j).style.display="block";var b=null;for(var h=0;h<g.steps.length;h++){if(g.p50<g.steps[h]){b=g.steps[h-1];break}}if(b===null){b=g.steps[g.steps.length-1]}var f=[];for(var k in g.histo){var c=g.histo[k]["cnt"];var l=g.histo[k]["cmpCnt"];var m=c>0?(l/c*100).toFixed(1):0;f.push({cnt:c,title:k,cmpCnt:l,cmpPercent:m})}var d=this.invervals[this.invervals.length-1].color;for(h=0;h<this.invervals.length;h++){if(g.p50<this.invervals[h].inverval){d=this.invervals[h].color;break}}var e=AmCharts.makeChart(j,{type:"serial",theme:"none",pathToImages:"/bitrix/js/main/amcharts/3.21/images/",dataProvider:f,startDuration:1,balloon:{maxWidth:700,textAlign:"left"},graphs:[{balloonText:"<b>[[category]]: [[value]]</b>",balloonFunction:BX.proxy(function(i,n){var p=i.values.value;var o=g.cnt>0?(p/g.cnt*100).toFixed(1):0;return"<b>"+BX.message("JS_SITE_SPEED_HITS")+": "+p+" ("+o+"%)</b><br><br>"+this.getStatTable(g.histo[i.category]["hits"],"dit")},this),colorField:"color",fillAlphas:0.9,lineAlpha:0.2,lineColor:d,type:"column",valueField:"cnt"}],chartCursor:{categoryBalloonEnabled:false,cursorAlpha:0,zoomable:false},valueAxes:[{precision:0}],categoryField:"title",categoryAxis:{gridPosition:"start",labelFunction:function(n,i,o){return BX.Main.SiteSpeed.formatMilliseconds(n,1)+" "+BX.message("JS_SITE_SPEED_SECONDS_UNIT")},guides:[{category:b,lineColor:"#000000",lineAlpha:1,fillAlpha:0.2,fillColor:"#CC0000",dashLength:2,inside:true,above:true,lineThickness:2,position:"top",labelRotation:90,label:BX.message("JS_SITE_SPEED_INDEX")}]},amExport:{}});if(BX.type.isNumber(g.compositeHits)&&g.compositeHits>0){e.addGraph({bullet:"round",lineThickness:3,bulletSize:7,bulletBorderAlpha:1,bulletColor:"#FFFFFF",useLineColorForBulletBorder:true,bulletBorderThickness:3,fillAlphas:0,lineAlpha:1,title:"Composite",valueField:"cmpCnt",balloonFunction:function(i,n){return BX.message("JS_SITE_SPEED_COMPOSITE_HITS")+": "+i.dataContext.cmpCnt+" ("+i.dataContext.cmpPercent+"%)"}})}return e};a.prototype.drawGraph=function(d,b){if(!BX.type.isArray(d)||d.length<1){return null}BX(b).style.display="block";AmCharts.shortMonthNames=[];for(var c=1;c<=12;c++){AmCharts.shortMonthNames.push(BX.message("MON_"+c))}return AmCharts.makeChart(b,{type:"serial",theme:"none",pathToImages:"/bitrix/js/main/amcharts/3.21/images/",dataDateFormat:"YYYY-MM-DD JJ:NN:SS",valueAxes:[{stackType:"regular",axisAlpha:0,position:"left",labelFunction:function(f,e,g){if(f==0){return 0}return BX.Main.SiteSpeed.formatMilliseconds(f,2)+" "+BX.message("JS_SITE_SPEED_SECONDS_UNIT")}}],legend:{equalWidths:true,position:"top",valueAlign:"left",markerType:"bubble",switchType:"v"},categoryField:"date_datetime",categoryAxis:{parseDates:true,equalSpacing:false,minPeriod:"ss",dateFormats:[{period:"fff",format:"JJ:NN"},{period:"ss",format:"JJ:NN"},{period:"mm",format:"JJ:NN"},{period:"hh",format:"JJ:NN"},{period:"DD",format:"MMM D"},{period:"WW",format:"MMM D"},{period:"MM",format:"MMM"},{period:"YYYY",format:"MMM"}]},dataProvider:d,balloon:{maxWidth:700,textAlign:"left"},graphs:[{hidden:true,fillAlphas:0.6,lineAlpha:0.4,title:"DNS",valueField:"dns",balloonText:""},{hidden:true,fillAlphas:0.6,lineAlpha:0.4,title:BX.message("JS_SITE_SPEED_TCP"),valueField:"tcp",balloonText:""},{fillAlphas:0.6,lineAlpha:0.4,title:BX.message("JS_SITE_SPEED_RESPONSE_TIME"),valueField:"srt",balloonText:""},{hidden:true,fillAlphas:0.6,lineAlpha:0.4,title:BX.message("JS_SITE_SPEED_DOWNLOAD_TIME"),valueField:"pdt",balloonText:""},{switchable:false,fillAlphas:0.6,lineAlpha:0.4,title:BX.message("JS_SITE_SPEED_PROCESSING_TIME"),valueField:"prc",balloonText:""},{stackable:false,switchable:true,lineAlpha:0.4,title:BX.message("JS_SITE_SPEED_INTERACTIVE_TIME"),valueField:"dit",bullet:"round",lineThickness:3,bulletSize:7,bulletBorderAlpha:1,useLineColorForBulletBorder:true,bulletBorderThickness:3,balloonFunction:BX.proxy(function(h,k){var g=[["dit",BX.message("JS_SITE_SPEED_INTERACTIVE_TIME")],["srt",BX.message("JS_SITE_SPEED_RESPONSE_TIME")],["dns","DNS"],["tcp",BX.message("JS_SITE_SPEED_TCP")],["pdt",BX.message("JS_SITE_SPEED_DOWNLOAD_TIME")],["prc",BX.message("JS_SITE_SPEED_PROCESSING_TIME")]];var e='<div class="site-speed-balloon-stat">';for(var j=0;j<g.length;j++){var f=g[j][1];var l=typeof(h.dataContext[g[j][0]])!=="undefined"?h.dataContext[g[j][0]]:-1;e+='<div class="site-speed-balloon-stat-item"><b>'+f+":</b>&nbsp;"+(l===0?0:BX.Main.SiteSpeed.formatMilliseconds(l,3))+" "+BX.message("JS_SITE_SPEED_SECONDS_UNIT")+"</div>"}e+="</div>";e+=this.getStatTable(h.dataContext.hits,"dit");return e},this)}],plotAreaBorderAlpha:0,chartCursor:{cursorAlpha:1,zoomable:true,categoryBalloonEnabled:false}})};a.prototype.getHistoData=function(c,d,b){BX.ajax({method:"POST",dataType:"json",url:this.statServerUrl,data:{license:this.privateKey,op:"hit_attr_distrib",attr:"dit",domain:c,aid:this.accountId,tmz:new Date().getTimezoneOffset()},onsuccess:d,onfailure:b})};a.prototype.getLastHits=function(c,d,b){BX.ajax({method:"POST",dataType:"json",url:this.statServerUrl,data:{license:this.privateKey,op:"domain_last_hits",domain:c,aid:this.accountId,tmz:new Date().getTimezoneOffset()},onsuccess:d,onfailure:b})};a.prototype.getStatTable=function(b,c){if(!BX.type.isArray(b)){return""}var e='<table class="site-speed-hits-table">';e+='<tr><th class="site-speed-page-column">'+BX.message("JS_SITE_SPEED_PAGE")+'</th><th class="site-speed-interactive-column">'+BX.message("JS_SITE_SPEED_INTERACTIVE")+'</th><th class="site-speed-response-column">'+BX.message("JS_SITE_SPEED_RESPONSE")+'</th><th class="site-speed-processing-column">'+BX.message("JS_SITE_SPEED_PROCESSING")+'</th><th class="site-speed-composite-column">'+BX.message("JS_SITE_SPEED_COMPOSITE")+"</th></tr>";b.sort(function(h,g){if(parseInt(h[c])<parseInt(g[c])){return 1}if(parseInt(h[c])>parseInt(g[c])){return -1}return 0});for(var d=0;d<b.length;d++){var f=b[d];e+='<tr><td class="site-speed-page-column">'+(d+1)+".&nbsp;"+BX.util.htmlspecialchars(decodeURIComponent(f.ru))+'</td><td class="site-speed-interactive-column">'+BX.Main.SiteSpeed.formatMilliseconds(f.dit,3)+'</td><td class="site-speed-response-column">'+BX.Main.SiteSpeed.formatMilliseconds(f.srt,3)+'</td><td class="site-speed-processing-column">'+BX.Main.SiteSpeed.formatMilliseconds(f.prc,3)+'</td><td class="site-speed-composite-column">'+(f.com==1?BX.message("JS_SITE_SPEED_COMPOSITE_YES"):BX.message("JS_SITE_SPEED_COMPOSITE_NO"))+"</td></tr>"}e+="</table>";return e};a.prototype.getInvervals=function(){return this.invervals};a.prototype.getInverval=function(b){for(var c=0;c<this.invervals.length;c++){if(b<this.invervals[c].inverval){return this.invervals[c]}}return this.invervals[this.invervals.length-1]};a.formatMilliseconds=function(c,b){c=parseInt(c,10);if(!BX.type.isNumber(c)||c<0){return -1}else{if(c===0){return 0}}b=b||2;return(c/1000).toFixed(b)};return a})();