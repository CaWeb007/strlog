(function(a){if(a.BX.webrtc){return}var b=a.BX;b.webrtc=function(){this.debug=false;this.audioMuted=false;this.videoMuted=false;this.enabled=false;this.detectedBrowser="none";this.pcConfig={};this.oneway=false;this.lastUserMediaParams={};this.pcConstraints={};this.sdpConstraints={mandatory:{OfferToReceiveAudio:true,OfferToReceiveVideo:true}};this.defaultMicrophone=null;this.defaultCamera=null;this.defaultSpeaker=null;this.enableMicAutoParameters=true;this.useFallbackConstraints=false;this.configVideo={aspectRatio:1.7777777778};this.configVideoGroup=this.configVideo;this.configVideoMobile=this.configVideo;this.configVideoAfterError={};this.callStreamSelf=null;this.callStreamMain=null;this.callStreamUsers={};this.pc={};this.pcStart={};this.connected={};this.iceCandidates={};this.initiator=false;this.callUserId=0;this.callChatId=0;this.callToGroup=false;this.callGroupUsers=[];this.callInit=false;this.callInitUserId=0;this.callActive=false;this.callVideo=false;this.callRequestUserMedia={};this.needPeerConnection=true;this.createAnswerTimeout={};this.initPeerConnectionTimeout={};this.iceCandidateTimeout={};this.pcConnectTimeout={};this.init();this.setTurnServer()};b.inheritWebrtc=function(c){c.prototype=Object.create(b.webrtc.prototype);c.prototype.constructor=c;c.prototype.parent=b.webrtc.prototype};b.webrtc.prototype.init=function(){if(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia){this.enabled=true}else{return}if(navigator.userAgent.substr(navigator.userAgent.indexOf("Firefox/")+8,2)>=27){this.detectedBrowser="firefox"}else{if(navigator.appVersion.substr(navigator.appVersion.indexOf("Chrome/")+7,2)>=29){this.detectedBrowser="chrome"}}};b.webrtc.prototype.attachMediaStream=function(c,d){c.src=URL.createObjectURL(d);if(b.type.isNotEmptyString(this.defaultSpeaker)&&c.setSinkId){this.log("Trying to set output device: "+this.defaultSpeaker);c.setSinkId(this.defaultSpeaker)}};b.webrtc.prototype.ready=function(){return this.enabled};b.webrtc.prototype.setTurnServer=function(c){if(!this.ready()){return false}c=c||{};this.turnServer=c.turnServer||"turn.calls.bitrix24.com";this.turnServerFirefox=c.turnServerFirefox||"54.217.240.163";this.turnServerLogin=c.turnServerLogin||"bitrix";this.turnServerPassword=c.turnServerPassword||"bitrix";if(this.detectedBrowser=="firefox"){this.pcConfig={iceServers:[{url:"stun:"+this.turnServerFirefox},{url:"turn:"+this.turnServerFirefox,credential:this.turnServerPassword,username:this.turnServerLogin}]};this.pcConstraints={optional:[{DtlsSrtpKeyAgreement:true}]}}else{if(this.detectedBrowser=="chrome"){this.pcConfig={iceServers:[{url:"stun:"+this.turnServer},{url:"turn:"+this.turnServerLogin+"@"+this.turnServer,username:this.turnServerLogin,credential:this.turnServerPassword}]};this.pcConstraints={optional:[{DtlsSrtpKeyAgreement:true}]}}}return true};b.webrtc.prototype.toggleAudio=function(d){if(!this.ready()){return false}d=typeof(d)!="undefined"?d:true;if(d){this.audioMuted=this.audioMuted?false:true}if(this.callStreamSelf&&this.callStreamSelf.getAudioTracks()&&this.callStreamSelf.getAudioTracks().length>0){for(var c=0;c<this.callStreamSelf.getAudioTracks().length;c++){this.callStreamSelf.getAudioTracks()[c].enabled=!this.audioMuted}}return true};b.webrtc.prototype.toggleVideo=function(d){if(!this.ready()){return false}d=typeof(d)!="undefined"?d:true;if(d){this.videoMuted=this.videoMuted?false:true}if(this.callStreamSelf&&this.callStreamSelf.getVideoTracks()&&this.callStreamSelf.getVideoTracks().length>0){for(var c=0;c<this.callStreamSelf.getVideoTracks().length;c++){this.callStreamSelf.getVideoTracks()[c].enabled=!this.videoMuted}}return true};b.webrtc.prototype.signalingReady=function(){return(this.ready()&&b.PULL&&b.PULL.getPullServerStatus())};b.webrtc.prototype.log=function(){var f="";if(b.desktop&&b.desktop.ready()){for(var c=0;c<arguments.length;c++){try{f=f+" | "+(typeof(arguments[c])=="object"?JSON.stringify(arguments[c]):arguments[c])}catch(d){f=f+" | (circular structure)"}}b.desktop.log(b.message("USER_ID")+".video.log",f.substr(3))}if(this.debug){if(console){console.log("WebRTC Log",arguments)}}};b.webrtc.prototype.startGetUserMedia=function(d,c){if(this.oneway&&!this.initiator){this.onUserMediaSuccess();return true}this.lastUserMediaParams={video:d,audio:c};if(this.callRequestUserMedia[this.callVideo?"video":"audio"]){return false}if(typeof(d)!="undefined"&&d!==true){}else{if(this.useFallbackConstraints){d=this.configVideoAfterError}else{if(this.callToGroup){d=this.configVideoGroup}else{d=this.configVideo}}}if(d&&this.defaultCamera){d.deviceId={ideal:this.defaultCamera}}c=typeof(c)!="undefined"&&c!==true?c:{};if(c&&this.defaultMicrophone){c.deviceId={ideal:this.defaultMicrophone}}if(false&&this.enableMicAutoParameters===false){c.optional=[{echoCancellation:false},{googEchoCancellation:false},{googEchoCancellation2:false},{googDAEchoCancellation:false},{googAutoGainControl:false},{googAutoGainControl2:false},{mozAutoGainControl:false},{googNoiseSuppression:false},{googNoiseSuppression2:false},{googHighpassFilter:false},{googTypingNoiseDetection:false},{googAudioMirroring:false}]}var g={audio:c,video:d};this.log('Requested access to local media with constraints:  "'+JSON.stringify(g)+'"');try{this.callRequestUserMedia[this.callVideo?"video":"audio"]=true;navigator.mediaDevices.getUserMedia(g).then(b.delegate(this.onUserMediaSuccess,this),b.delegate(this.onUserMediaError,this))}catch(f){this.debug=true;this.log("Method getUserMedia failed with exception: "+f.message)}return true};b.webrtc.prototype.onUserMediaSuccess=function(e){this.log("Media stream received");if(e&&e.getTracks){e.getTracks().forEach(function(f){this.log(b.webrtc.mediaStreamTrackToString(f))}.bind(this))}if(!this.oneway||this.initiator){this.callRequestUserMedia[this.callVideo?"video":"audio"]=false;if(this.callStreamSelf){return false}if(!this.callActive&&e){b.webrtc.stopMediaStream(e);return false}this.log("User has granted access to local media.");this.callStreamSelf=e;this.toggleAudio(false)}if(!this.needPeerConnection){return true}if(this.initiator){if(this.callToGroup){for(var d=0;d<this.callGroupUsers.length;d++){var c=this.callGroupUsers[d];if(c!=b.message("USER_ID")){clearTimeout(this.initPeerConnectionTimeout[c]);this.initPeerConnection(c)}}}else{clearTimeout(this.initPeerConnectionTimeout[this.callUserId]);this.initPeerConnection(this.callUserId)}}else{if(this.callToGroup){for(var d=0;d<this.callGroupUsers.length;d++){var c=this.callGroupUsers[d];if(c!=b.message("USER_ID")&&c!=this.callInitUserId&&!this.callStreamUsers[c]){clearTimeout(this.initPeerConnectionTimeout[c]);this.initPeerConnection(c,true)}}}}return true};b.webrtc.prototype.onUserMediaError=function(c){this.debug=true;this.callRequestUserMedia[this.callVideo?"video":"audio"]=false;if(!this.callActive){return false}this.log("Failed to get access to local media. Error code was "+JSON.stringify(c));return true};b.webrtc.prototype.initPeerConnection=function(c,d){if(!this.callActive){return false}d=d===true;if(this.debug){console.log(c,"wait initPeerConnection")}if(!this.pcStart[c]&&(!this.oneway&&this.callStreamSelf||this.oneway&&this.initiator&&this.callStreamSelf||this.oneway&&!this.initiator)){if(this.connected[c]){this.log("Creating PeerConnection.",c);this.createPeerConnection(c);if(!this.pc[c]){clearTimeout(this.initPeerConnectionTimeout[c]);this.initPeerConnectionTimeout[c]=setTimeout(b.delegate(function(){this.initPeerConnection(c,d)},this),2000);return false}this.log("Adding local stream.",c,this.pc[c]);this.pcStart[c]=true;if(this.initiator||d){this.sendOfferToPeer(c)}}else{clearTimeout(this.initPeerConnectionTimeout[c]);this.initPeerConnectionTimeout[c]=setTimeout(b.delegate(function(){this.initPeerConnection(c,d)},this),2000)}}else{if(!this.connected[c]){clearTimeout(this.initPeerConnectionTimeout[c]);this.initPeerConnectionTimeout[c]=setTimeout(b.delegate(function(){this.initPeerConnection(c,d)},this),2000)}}return true};b.webrtc.prototype.setLocalAndSend=function(c,d){if(this.pc[c]==null||!this.callActive){return false}this.log("set local description and send",c,JSON.stringify(d));this.pc[c].setLocalDescription(d,b.delegate(function(e){this.log("setLocalDescription",e)},this),b.delegate(function(e){this.log("setLocalDescription",e)},this));return true};b.webrtc.prototype.onRemoteStreamAdded=function(d,e,c){};b.webrtc.prototype.onRemoteStreamRemoved=function(c,d){};b.webrtc.prototype.onIceCandidate=function(c,d){};b.webrtc.prototype.onIceConnectionStateChange=function(c,d){};b.webrtc.prototype.onSignalingStateChange=function(c,d){};b.webrtc.prototype.peerConnectionError=function(c,d){};b.webrtc.prototype.peerConnectionReconnect=function(c){if(!this.pc[c]){return false}if((this.pc[c].iceConnectionState=="connected"||this.pc[c].iceConnectionState=="completed")&&this.pc[c].signalingState=="stable"){return false}this.log("peerConnectionReconnect",this.pc[c].iceConnectionState,this.pc[c].signalingState);this.pc[c].close();delete this.pc[c];delete this.pcStart[c];if(this.callStreamMain==this.callStreamUsers[c]){this.callStreamMain=null}this.callStreamUsers[c]=null;clearTimeout(this.initPeerConnectionTimeout[c]);return true};b.webrtc.prototype.deleteEvents=function(){this.initiator=false;this.callUserId=0;this.callChatId=0;this.callToGroup=false;this.callGroupUsers=[];this.callInit=false;this.callInitUserId=0;this.callActive=false;this.callVideo=false;this.callRequestUserMedia={};this.audioMuted=false;this.videoMuted=false;this.needPeerConnection=true;var c=0;for(c in this.pc){if(this.pc.hasOwnProperty(c)){this.pc[c].close();delete this.pc[c]}}this.pc={};this.pcStart={};this.connected={};this.iceCandidates={};for(c in this.iceCandidateTimeout){if(this.iceCandidateTimeout.hasOwnProperty(c)){clearTimeout(this.iceCandidateTimeout[c])}}this.iceCandidateTimeout={};for(c in this.pcConnectTimeout){if(this.pcConnectTimeout.hasOwnProperty(c)){clearTimeout(this.pcConnectTimeout[c])}}this.pcConnectTimeout={};for(c in this.createAnswerTimeout){if(this.createAnswerTimeout.hasOwnProperty(c)){clearTimeout(this.createAnswerTimeout[c])}}this.createAnswerTimeout={};for(c in this.initPeerConnectionTimeout){if(this.initPeerConnectionTimeout.hasOwnProperty(c)){clearTimeout(this.initPeerConnectionTimeout[c])}}this.initPeerConnectionTimeout={};if(this.callStreamSelf){b.webrtc.stopMediaStream(this.callStreamSelf);this.callStreamSelf=null}if(this.callStreamMain){b.webrtc.stopMediaStream(this.callStreamMain);this.callStreamMain=null}for(c in this.callStreamUsers){if(this.callStreamUsers.hasOwnProperty(c)){if(this.callStreamUsers[c]){b.webrtc.stopMediaStream(this.callStreamUsers[c])}delete this.callStreamUsers[c]}}};b.webrtc.prototype.mergeConstraints=function(e,d){if(!this.ready()){return false}var c=e;for(var f in d.mandatory){if(d.mandatory.hasOwnProperty(f)){c.mandatory[f]=d.mandatory[f]}}c.optional.concat(d.optional);return c};b.webrtc.prototype.sendOfferToPeer=function(c){if(!this.pc[c]){return false}var e={optional:[],mandatory:{MozDontOfferDataChannel:true}};if(this.detectedBrowser==="chrome"){for(var d in e.mandatory){if(e.mandatory.hasOwnProperty(d)){if(d.indexOf("Moz")!=-1){delete e.mandatory[d]}}}}this.log("Constraints",e);e=this.mergeConstraints(e,this.sdpConstraints);this.log("Sending offer to peer, with constraints:",c,'"'+JSON.stringify(e)+'".');this.pc[c].createOffer(b.delegate(function(f){this.setLocalAndSend(c,f)},this),b.delegate(function(f){this.log("createOffer failure",f)},this),e);return true};b.webrtc.prototype.createPeerConnection=function(c){try{this.pc[c]=new RTCPeerConnection(this.pcConfig,this.pcConstraints);this.pc[c].onicecandidate=b.delegate(function(e){this.onIceCandidateEvent(c,e)},this);this.pc[c].onaddstream=b.delegate(function(e){this.onRemoteStreamAddedEvent(c,e)},this);this.pc[c].onremovestream=b.delegate(function(e){this.onRemoteStreamRemovedEvent(c,e)},this);this.pc[c].oniceconnectionstatechange=b.delegate(function(e){this.onIceConnectionStateChangeEvent(c,e)},this);this.pc[c].onsignalingstatechange=b.delegate(function(e){this.onSignalingStateChangeEvent(c,e)},this);if(!this.oneway||this.initiator){this.pc[c].addStream(this.callStreamSelf)}this.log("Created RTCPeerConnnection for "+c+' with:\n  config: "'+JSON.stringify(this.pcConfig)+'";\n  constraints: "'+JSON.stringify(this.pcConstraints)+'".')}catch(d){if(this.callToGroup&&this.callStreamUsers[c]){return false}this.log("PeerConnection: ",JSON.stringify(this.pcConfig),JSON.stringify(this.pcConstraints));this.log("Failed to create PeerConnection, exception: "+d.message);this.peerConnectionError(c,d)}return true};b.webrtc.prototype.signalingPeerData=function(d,j){var g=JSON.parse(j);if(g.type==="offer"){if(!this.pcStart[d]){this.initPeerConnection(d)}this.createAnswer(d,g)}else{if(g.type==="answer"&&this.pcStart[d]){if(this.pc[d]==null){return false}this.pc[d].setRemoteDescription(new RTCSessionDescription(g),function(){},function(){})}else{if(g.type==="candidate"&&this.pcStart[d]){if(!this.pc[d]||this.pc[d]==null){return false}for(var c=0;c<g.candidates.length;c++){var f=new RTCIceCandidate({sdpMLineIndex:g.candidates[c].label,candidate:g.candidates[c].candidate});try{this.pc[d].addIceCandidate(f)}catch(h){this.log("Error addIceCandidate",JSON.stringify(h));this.peerConnectionReconnect(d);return false}}}else{this.log('Signaling command "'+(g&&g.type?g.type:"undefined")+'" from user "'+d+'" skip')}}}return true};b.webrtc.prototype.onRemoteStreamAddedEvent=function(d,e){if(!this.pc[d]){return false}this.log("Remote stream added",d,JSON.stringify(e));var c=false;if(!this.callStreamMain){this.callStreamMain=e.stream;c=true}this.callStreamUsers[d]=e.stream;this.onRemoteStreamAdded(d,e,c)};b.webrtc.prototype.onRemoteStreamRemovedEvent=function(c,d){if(!this.pc[c]){return false}this.callStreamUsers[c]=null;this.onRemoteStreamRemoved(c,d)};b.webrtc.prototype.onIceCandidateEvent=function(c,d){if(!this.pc[c]){return false}if(!this.iceCandidates[c]){this.iceCandidates[c]=[]}if(d.candidate){this.log("New ICE candidate: ",d.candidate);this.iceCandidates[c].push({type:"candidate",label:d.candidate.sdpMLineIndex,id:d.candidate.sdpMid,candidate:d.candidate.candidate});clearTimeout(this.iceCandidateTimeout[c]);this.iceCandidateTimeout[c]=setTimeout(b.delegate(function(){if(this.iceCandidates[c].length===0){return false}this.onIceCandidate(c,{type:"candidate",candidates:this.iceCandidates[c]});this.iceCandidates[c]=[]},this),250)}else{this.log("End of candidates of "+c)}};b.webrtc.prototype.onIceConnectionStateChangeEvent=function(c,d){clearTimeout(this.pcConnectTimeout[c]);if(!this.pc[c]||this.pc[c].iceConnectionState=="close"){return false}this.log("iceConnectionStateChange",c,this.pc[c].iceConnectionState,this.pc[c].signalingState);this.pcConnectTimeout[c]=setTimeout(b.delegate(function(){this.peerConnectionReconnect(c)},this),15000);this.onIceConnectionStateChange(c,d);return true};b.webrtc.prototype.onSignalingStateChangeEvent=function(c,d){clearTimeout(this.pcConnectTimeout[c]);if(!this.pc[c]||this.pc[c].signalingState=="close"){return false}this.log("signalingStateChange",c,this.pc[c].iceConnectionState,this.pc[c].signalingState);this.pcConnectTimeout[c]=setTimeout(b.delegate(function(){this.peerConnectionReconnect(c)},this),15000);this.onSignalingStateChange(c,d)};b.webrtc.prototype.createAnswer=function(c,d){if(!this.callActive){return false}if(!this.pcStart[c]){clearTimeout(this.createAnswerTimeout[c]);this.createAnswerTimeout[c]=setTimeout(b.delegate(function(){this.createAnswer(c,d)},this),2000);return false}this.pc[c].setRemoteDescription(new RTCSessionDescription(d),b.delegate(function(){if(!this.pc[c]){return false}this.pc[c].createAnswer(b.delegate(function(e){this.setLocalAndSend(c,e)},this),b.delegate(function(e){this.log("createAnswer failure",e)},this),this.sdpConstraints)},this),function(){});return true};b.webrtc.prototype.setDefaultCamera=function(c){this.defaultCamera=c};b.webrtc.prototype.setDefaultMicrophone=function(c){this.defaultMicrophone=c};b.webrtc.prototype.logDevices=function(){var c=this;if(navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices){c.log("Enumerating media devices");navigator.mediaDevices.enumerateDevices().then(function(d){d.forEach(function(f){try{c.log(JSON.stringify(f))}catch(g){c.log(f)}})})}else{c.log("Could not enumerate devices, api is not supported")}};b.webrtc.mediaStreamTrackToString=function(d){var c="";for(key in d){if(!b.type.isFunction(d[key])){c=c+" "+key+": "+d[key]+";"}}return c};b.webrtc.stopMediaStream=function(c){if(!(c instanceof MediaStream)){return}if(typeof c.getTracks==="undefined"){c.stop()}else{c.getTracks().forEach(function(d){d.stop()})}}})(window);