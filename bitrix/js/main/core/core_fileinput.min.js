(function(){window.BXDEBUG=true;var c=window.BX,i={},d=200;c.namespace("BX.UI");if(c.UI["FileInput"]){return}c.UI["FileInput"]=function(u,t,r,q,s){this.id=u;this.inited=false;this.uploadParams=(t||{});this.uploadParams.urlUpload="/bitrix/tools/upload.php?lang="+c.message("LANGUAGE_ID");this.uploadParams.urlCloud="/bitrix/admin/clouds_file_search.php?lang="+c.message("LANGUAGE_ID")+"&n=";this.uploadParams.maxCount=parseInt(this.uploadParams.maxCount)||0;this.onUploadDoneCounter=parseInt(this.uploadParams.maxIndex);if(this.onUploadDoneCounter>0){this.onUploadDoneCounter++}this.template=s;this.elementParams=r;this.menu=[];this.agent=null;this.container=null;c.ready(c.proxy(function(){this.init(q)},this))};c.UI.FileInput.prototype={init:function(r){this.container=c(this.id+"_block");if(!this.container){setTimeout(c.proxy(function(){this.init(r)},this),1000);return}if(i[this.id]){if(i[this.id].container===this.container){return}i[this.id].destruct()}if(!this.container.fileInputIsAppended){this.container.fileInputIsAppended=0;this.container.appendChild(c.create("INPUT",{attrs:{className:"adm-fileinput-drag-area-input",type:"file",id:this.id+"_input",multiple:(this.uploadParams.maxCount!==1),"data-fileinput":"Y"}}))}if(!c(this.id+"_input")){this.container.fileInputIsAppended++;if(this.container.fileInputIsAppended<100){setTimeout(c.proxy(function(){this.init(r)},this),500)}return}this.initFrameCounters();this.agent=c.Uploader.getInstance({id:this.id,streams:1,uploadMaxFilesize:(this.uploadParams.uploadType==="file"?c.message("phpUploadMaxFilesize"):this.uploadParams.maxSize),allowUpload:this.uploadParams.allowUpload,allowUploadExt:this.uploadParams.allowUploadExt,uploadFormData:"N",uploadMethod:"immediate",uploadFileUrl:this.uploadParams.urlUpload,showImage:true,sortItems:(this.uploadParams.allowSort==="Y"),deleteFileOnServer:false,pasteFileHashInForm:false,input:c(this.id+"_input"),dropZone:c(this.id+"_block"),placeHolder:c(this.id+"_container"),thumb:{tagName:"DIV",className:"adm-fileinput-item-wrapper"},fields:{thumb:{tagName:"DIV",template:this.template},preview:{params:{width:d,height:d},events:{}}}});i[this.id]=this;this.fileEvents={onFileIsAttached:c.delegate(this.onFileIsAttached,this),onFileIsAppended:c.delegate(this.onFileIsAppended,this),onFileIsBound:c.delegate(this.onFileIsBound,this),onFileIsReadyToFrame:c.delegate(this.onFileIsReadyToFrame,this),onUploadProgress:c.delegate(this.onUploadProgress,this),onUploadDone:c.delegate(this.onUploadDone,this),onUploadError:c.delegate(this.onUploadError,this),onUploadRestore:c.delegate(this.onUploadRestore,this)};this.agentEvents={onAttachFiles:c.delegate(this.onAttachFiles,this),onQueueIsChanged:c.delegate(this.onQueueIsChanged,this),onFileIsCreated:c.delegate(this.onFileIsCreated,this),onFileIsInited:c.delegate(this.onFileIsInited,this),onFileIsReadyToFrame:c.delegate(this.onFileIsReadyToFrame,this),onFilesPropsAreModified:c.delegate(this.onFilesPropsAreModified,this),onFileIsFramed:c.delegate(this.onFileIsFramed,this),onFilesAreFramed:c.delegate(this.onFilesAreFramed,this),onBxDragStart:c.delegate(this.onFileIsDragged,this),onError:c.delegate(this.onError,this)};if(this.uploadParams.upload){var q=this.uploadParams.upload;this.agentEvents.onPackageIsInitialized=c.delegate(function(w,v){w.post.data.signature=q;w.post.size+=("signature"+q).length;this.onUploadStart(v)},this)}for(s in this.agentEvents){if(this.agentEvents.hasOwnProperty(s)){c.addCustomEvent(this.agent,s,this.agentEvents[s])}}if(r.length>0){var u=[],t=[];this.values={};for(var s=0;s<r.length;s++){this.values[r[s]["id"]]=r[s];u.push(r[s]);t.push(c(r[s]["id"]+"Block"))}this.agent.onAttach(u,t,false)}this.initMenu(c(this.id+"_add"),this.uploadParams);this.checkUploadControl();c[this.elementParams["delete"]!==true?"addClass":"removeClass"](this.container,"adm-fileinput-non-delete");this.framedItems=new c.UploaderUtils.Hash();if(c(this.id+"ThumbModePreview")){c.bind(c(this.id+"ThumbModePreview"),"click",c.delegate(function(v){c.removeClass(c(this.id+"_mode"),"mode-file");c.removeClass(c(this.id+"_block"),"mode-file");c.addClass(c(this.id+"_mode"),"mode-pict");c.addClass(c(this.id+"_block"),"mode-pict");this.saveOptions("mode","mode-pict");return c.PreventDefault(v)},this))}if(c(this.id+"ThumbModeNonPreview")){c.bind(c(this.id+"ThumbModeNonPreview"),"click",c.delegate(function(v){c.removeClass(c(this.id+"_mode"),"mode-pict");c.removeClass(c(this.id+"_block"),"mode-pict");c.addClass(c(this.id+"_mode"),"mode-file");c.addClass(c(this.id+"_block"),"mode-file");this.saveOptions("mode","mode-file");return c.PreventDefault(v)},this))}this.inited=true},destruct:function(){var q;for(q in this.agentEvents){if(this.agentEvents.hasOwnProperty(q)){c.removeCustomEvent(this.agent,q,this.agentEvents[q])}}this.agent.destruct();this.deinitMenu(c(this.id+"_add"));c.remove(c(this.id+"_input"));delete this.noticeNode;delete this.nativeNoticeMessage;delete this.container;delete this.framedItems;c.unbindAll(c(this.id+"ThumbModePreview"));c.unbindAll(c(this.id+"ThumbModeNonPreview"));this.agent=null;delete this.agent;delete i[this.id]},checkUploadControl:function(){if(!this["noticeNode"]){this.noticeNode=c(this.id+"Notice");this.nativeNoticeMessage=c(this.id+"Notice").innerHTML}var q="adm-fileinput-drag-area adm-fileinput-drag-area-error adm-fileinput-drag-notification-count adm-fileinput-drag-area-error-permission adm-fileinput-drag-area-error-count";c.removeClass(this.container,q);if(!this.uploadParams.upload){this.noticeNode.innerHTML=c.message("JS_CORE_FI_UPLOAD_DENIED");c.addClass(this.container,"adm-fileinput-drag-area-error adm-fileinput-drag-area-error-permission")}else{if(this.uploadParams.maxCount<=0||this.uploadParams.maxCount>this.agent.getItems().length){this.noticeNode.innerHTML=this.nativeNoticeMessage;c.addClass(this.container,"adm-fileinput-drag-area")}else{if(this.uploadParams.maxCount===this.agent.getItems().length){this.noticeNode.innerHTML=c.message("JS_CORE_FI_TOO_MANY_FILES2");c.addClass(this.container,"adm-fileinput-drag-area adm-fileinput-drag-notification-count")}else{this.noticeNode.innerHTML=c.message("JS_CORE_FI_TOO_MANY_FILES3");c.addClass(this.container,"adm-fileinput-drag-area-error adm-fileinput-drag-area-error-count")}}}},saveOptions:function(q,r){c.userOptions.save("main","fileinput",q,r)},initMenu:function(s,u){s=c(s);if(!s||s.OPENER){return}this.initMenuCounter=(this.initMenuCounter||0)+1;var q,t=[];if(u.upload){q=this.id+"_menu"+this.initMenuCounter;t.push({ID:"upload",HTML:c.message("JS_CORE_FILE_UPLOAD")+'<input type="file" id="'+q+'" class="adm-fileinput-area-input" />',GLOBAL_ICON:"adm-menu-upload-pc"})}if(u.medialib||u.file_dialog){t.push({TEXT:c.message("JS_CORE_FILE_INSERT_PATH"),ONCLICK:c.proxy(this.handlerFilePath,this),GLOBAL_ICON:"adm-menu-download"})}if(t.length>0){t.push({SEPARATOR:true})}if(u.medialib){t.push({TEXT:c.message("JS_CORE_FILE_MEDIALIB"),GLOBAL_ICON:"adm-menu-upload-medialib",ONCLICK:u.medialib["click"]+"()"});window[u.medialib["handler"]]=c.delegate(this.handlerMedialib,this)}if(u.fileDialog){t.push({TEXT:c.message("JS_CORE_FILE_SITE"),GLOBAL_ICON:"adm-menu-upload-site",ONCLICK:u.fileDialog["click"]+"()"});window[u.fileDialog["handler"]]=c.delegate(this.handlerFileDialog,this)}if(u.cloud){this.__cloudClick=c.delegate(this.clickCloudPoint,this);t.push({TEXT:c.message("JS_CORE_FILE_CLOUD"),GLOBAL_ICON:"adm-menu-upload-cloud",ONCLICK:this.__cloudClick})}if(u.menu&&c.type.isArray(u.menu)){t.push({SEPARATOR:true});for(var r=0;r<=u.menu.length;r++){t.push(u.menu)}t.push({SEPARATOR:true})}else{if(u.medialib||u.file_dialog||u.cloud){t.push({SEPARATOR:true})}}if(t.length>0&&this.agent.dialogName=="BX.Uploader"){t.push({GLOBAL_ICON:"adm-menu-crop",TEXT:c.message("JS_CORE_FI_FRAME_Y"),ONCLICK:c.delegate(this.frameFiles,this),CHECKED:(this.uploadParams.frameFiles=="Y")})}if(this.elementParams.edit&&this.elementParams.description!==false){t.push({TEXT:c.message("JS_CORE_FI_PIN_DESCRIPTION"),ONCLICK:c.delegate(this.pinDescription,this),CHECKED:(this.uploadParams.pinDescription=="Y")})}if(this.elementParams["delete"]){t.push({TEXT:c.message("JS_CORE_FI_CLEAR"),ONCLICK:c.delegate(this.deleteFiles,this),GLOBAL_ICON:"adm-menu-delete"})}if(t.length>0){s.OPENER=new c.COpener({DIV:s,TYPE:"click",MENU:t,ACTIVE_CLASS:"adm-btn-active"});if(q){s.__onOpenerMenuOpen=c.delegate(function(){c.adjust(c(q).parentNode,{style:{position:"relative"}});this.agent.init(c(q));c.removeCustomEvent(s.OPENER,"onOpenerMenuOpen",s.__onOpenerMenuOpen)},this);c.addCustomEvent(s.OPENER,"onOpenerMenuOpen",s.__onOpenerMenuOpen)}}},deinitMenu:function(q){q=c(q);if(!q||!q.OPENER){return}c.removeCustomEvent(q.OPENER,"onOpenerMenuOpen",q.__onOpenerMenuOpen);c.unbindAll(q.OPENER.DIV);delete q.OPENER.DIV;delete q.OPENER},handlerFilePathPopup:null,handlerFilePath:function(s){if(c.type.isArray(s)){var q=[];for(var r=0;r<s.length;r++){if(c.type.isNotEmptyString(s[r])){q.push({tmp_url:c.util.htmlspecialchars(s[r]),real_url:decodeURIComponent(s[r])})}}this.agent.onAttach(q,{})}else{this.handlerFilePathPopup=(this.handlerFilePathPopup||new g(this.id+"filePath",{onApply:c.delegate(this.handlerFilePath,this)},this.uploadParams.maxCount));this.handlerFilePathPopup.show()}},handlerMedialib:function(s){if(!c.type.isArray(s)){s=[s]}var q=[];for(var r=0;r<s.length;r++){if(s[r]){q.push({name:c.UploaderUtils.getFileNameOnly(s[r]["src"]),description:s[r]["description"],type:s[r]["type"]+"/medialib",size:s[r]["file_size"],sizeFormatted:s[r]["file_size"],tmp_url:s[r]["src"],real_url:s[r]["src"]})}}this.agent.onAttach(q,q)},handlerFileDialog:function(q,s){if(c.type.isNotEmptyString(q)&&c.type.isNotEmptyString(s)){var r={name:q,type:(c.UploaderUtils.isImageExt((q||"").lastIndexOf(".")>0?q.substr(q.lastIndexOf(".")+1):"")?"image":"notimage")+"/filedialog",tmp_url:s+"/"+q,real_url:s+"/"+q};this.agent.onAttach([r],[r])}},clickCloudPointPath:"/bitrix/admin/clouds_file_search.php?lang="+c.message("LANGUAGE_ID")+"&n=undefined",clickCloudPointBound:false,clickCloudPoint:function(){if(this.clickCloudPointBound===false){c.addCustomEvent("onCloudFileIsChosen",c.delegate(this.clickCloudPointChange,this));this.clickCloudPointBound=true}c.util.popup(this.clickCloudPointPath,710,600)},clickCloudPointChange:function(s){var q=c.UploaderUtils.getFileNameOnly(s);if(c.type.isNotEmptyString(s)){var r={name:q,type:(c.UploaderUtils.isImageExt((q||"").lastIndexOf(".")>0?q.substr(q.lastIndexOf(".")+1):"")?"image":"notimage")+"/cloudfile",tmp_url:s};this.agent.onAttach([r],[r])}},frameFlags:{hasNew:false,active:false,preparing:false,ready:false},framedItems:null,frameFiles:function(q){if(q&&!c.type.isNumber(q)&&q.type=="click"){this.uploadParams.frameFiles=(this.uploadParams.frameFiles=="Y"?"N":"Y");this.saveOptions("frameFiles",this.uploadParams.frameFiles);if(this.uploadParams.frameFiles=="N"){return false}}if(this.frameFlags.active===true&&(q||this.frameFlags.hasNew)){try{if(!this["__frameFiles"]){this["__frameFiles"]=c.delegate(function(){c.removeCustomEvent(this,"onFilesCanBeFramed",this.__frameFiles);if(this.frameFilesWaitPopup){this.frameFilesWaitPopup.close()}this.framedItems=new c.UploaderUtils.Hash();if(!this.frameFilesBound){this.frameFilesBound=true;c.addCustomEvent(j,"onDeleteItem",c.delegate(function(t){this.deleteFile(t)},this))}this.frameFlags.hasNew=false;var s=c.clone(this.uploadParams,true);s.description=this.elementParams.description;j.start(this.agent,(q||this.counters.newItemId),s);this["__frameFiles"]=null;delete this["__frameFiles"]},this)}c.removeCustomEvent(this,"onFilesCanBeFramed",this["__frameFiles"]);if(this.frameFlags.ready===true){this.__frameFiles()}else{this.frameFilesWait();c.addCustomEvent(this,"onFilesCanBeFramed",this.__frameFiles)}}catch(r){console.log(r)}}return true},pinDescription:function(q){this.uploadParams.pinDescription=(this.uploadParams.pinDescription=="Y"?"N":"Y");this.saveOptions("pinDescription",this.uploadParams.pinDescription);if(this.uploadParams.pinDescription=="Y"){if(!c.hasClass(c(this.id+"_block"),"mode-with-description")){c.addClass(c(this.id+"_block"),"mode-with-description")}}else{c.removeClass(c(this.id+"_block"),"mode-with-description")}return c.PreventDefault(q)},frameFilesWaitPopup:null,frameFilesWait:function(){if(this.frameFilesWaitPopup==null){this.frameFilesWaitPopup=c.PopupWindowManager.create("popup-frame-wait"+this.id,null,{autoHide:true,titleBar:c.message("JS_CORE_LOADING"),contentColor:"white",closeIcon:true,closeByEsc:true,zIndex:e(1),content:'<span class="adm-photoeditor-popup-frame-wait"><span></span>'+c.message("JS_CORE_FI_FRAME_IS_LOADING")+"</span>",overlay:{},events:{onPopupClose:c.proxy(function(){c.removeCustomEvent(this,"onFilesCanBeFramed",this.__frameFiles)},this)},buttons:[new c.PopupWindowButtonLink({text:c.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:c.delegate(function(){this.frameFilesWaitPopup.close()},this)}})]})}this.frameFilesWaitPopup.show()},initFrameCounters:function(){this.counters={images:{created:new c.UploaderUtils.Hash(),ready:new c.UploaderUtils.Hash()},uploaded:new c.UploaderUtils.Hash(),newItemOrder:0,newItemId:0}},incrementFrameCounter:function(r,q){if(q.dialogName=="BX.UploaderImage"){if(this.values&&this.values[q.id]){this.counters.uploaded.setItem(r,q.dialogName)}else{if(!this.counters.uploaded.hasItem(r)||this.counters.uploaded.getItem(r)!==q.dialogName){if(this.frameFlags.hasNew!==true){this.frameFlags.hasNew=true;this.counters.newItemOrder=this.counters.images.created.length;this.counters.newItemId=r}}}q.canvasIsReady=false;this.frameFlags.active=true;this.frameFlags.ready=false;this.counters.images.created.setItem(r,r)}},decrementFrameCounters:function(r,q){if(q.dialogName=="BX.UploaderImage"){this.counters.images.created.removeItem(r);this.counters.images.ready.removeItem(r);this.frameFlags.active=(this.counters.images.created.length>0)}},amountFrameCounter:function(r,q){if(q.dialogName=="BX.UploaderImage"){q.canvasIsReady=true;if(this.counters.uploaded.hasItem(r)){c.onCustomEvent(this.agent,"onFileIsReadyToFrame",[r,q])}}},onFileIsReadyToFrame:function(r,q){if(q.dialogName=="BX.UploaderImage"&&this.counters.images.created.hasItem(r)){this.counters.images.ready.setItem(r,r);this.frameFlags.ready=(this.counters.images.created.length==this.counters.images.ready.length);if(this.frameFlags.ready){c.onCustomEvent(this,"onFilesCanBeFramed",[this])}}},deleteFiles:function(){var q=this.agent.getItems(),r;while((r=q.getFirst())&&r){this.deleteFile(r,true)}},onQueueIsChanged:function(){if(this.inited===true&&this.uploadParams.maxCount>0){this.checkUploadControl()}},onAttachFiles:function(r){var q=false;if(r&&this.inited===true&&this.uploadParams.maxCount>0){if(this.uploadParams.maxCount==1&&r.length>0){while(this.agent.getItems().length>0){this.deleteFile(this.agent.getItems().getFirst(),true)}while(r.length>1){r.pop()}}var s=this.uploadParams.maxCount-this.agent.getItems().length;s=(s>0?s:0);while(r.length>s){r.pop();q=true}}if(q){this.onError(c.message("JS_CORE_FI_TOO_MANY_FILES").replace("#amount#",this.uploadParams.maxCount),true)}return r},onFileIsCreated:function(s,r){if(this.inited===true){r.IND=this.onUploadDoneCounter++}if(r.file.preview_url&&r.file.width>0&&r.file.height>0){c.addCustomEvent(r,"onFileCanvasIsLoaded",c.proxy(function(){r.file.tmp_url=r.file["~tmp_url"];delete r.file["~tmp_url"];r.file.width=r.file["~width"];r.file.height=r.file["~height"];delete r.file["~width"];delete r.file["~height"];r.canvasIsLoaded=true;this.replaceHint(r)},this));r.file["~tmp_url"]=r.file.tmp_url;r.file.tmp_url=r.file.preview_url;r.file["~width"]=r.file.width;r.file["~height"]=r.file.height;delete r.file.preview_url}else{if(r.dialogName=="BX.UploaderImage"){c.addCustomEvent(r,"onFileCanvasIsLoaded",c.proxy(function(){r.canvasIsLoaded=true;this.replaceHint(r)},this))}}r.description=(c.type.isNotEmptyString(r.file.description)?r.file.description:"");this.incrementFrameCounter(s,r);for(var q in this["fileEvents"]){if(this["fileEvents"].hasOwnProperty(q)){if(this["fileEvents"][q]){c.addCustomEvent(r,q,this.fileEvents[q])}}}},onFileIsInited:function(r,q){this.amountFrameCounter(r,q)},onFileIsAppended:function(r,q){this.bindFile(q)},onFileIsBound:function(r,q){this.bindFile(q)},onFileIsAttached:function(r,q){if(q.file.sizeFormatted){q.size=q.file.sizeFormatted;delete q.file.sizeFormatted}this.bindFile(q);if(q.file.tmp_url){this.onUploadDone(q,{file:{uploadId:q.file.tmp_url}})}},onFilesPropsAreModified:function(s,r,q){if(q){r.description=q.description;if(c(r.id+"Description")){c(r.id+"Description").value=r.description}}},onFileIsFramed:function(t,s,q,r){if(q.width!=s.canvas.width||q.height!=s.canvas.height){c.adjust(s.canvas,{props:{width:q.width,height:q.height}})}else{c.adjust(s.canvas,{props:{width:s.canvas.width-1}});c.adjust(s.canvas,{props:{width:s.canvas.width+1}})}s.canvas.getContext("2d").drawImage(q,0,0,q.width,q.height,0,0,s.canvas.width,s.canvas.height);s.file=r;this.framedItems.setItem(s.id,s)},onFilesAreFramed:function(){if(this.framedItems&&this.framedItems.length>0){if(this.uploadParams.uploadType=="file"){}else{this.agent.restoreItems(this.framedItems,true,true);this.agent.submit()}}},onFileIsDragged:function(r,q){if(c.hasClass(c(this.id+"_block"),"mode-file")){c.addClass(q,"mode-file")}},onUploadStart:function(q){if(q.length>0){var t,s,r;for(r in q.items){if(q.items.hasOwnProperty(r)){s=q.items[r];t=(this.agent.getItem(s.id)||{node:false}).node;if(t&&!c.hasClass(t,"adm-fileinput-item-uploading")){c.addClass(t,"adm-fileinput-item-uploading")}}}}},onUploadProgress:function(s,q){var r=this.agent.getItem(s.id).node;if(!r.hasAttribute("bx-progress-bound")){r.setAttribute("bx-progress-bound","Y");c.addClass(r,"adm-fileinput-item-uploading")}q=(q<5?5:(q>100?100:q));q=Math.ceil(q);if(c(s.id+"Progress",true)){c(s.id+"Progress",true).style.width=q+"%"}},onUploadDoneCounter:0,replaceInput:function(z,v){var t=this.agent.getItem(z.id).node,x=t.__replaceInputName,r=z.id+"Value",y=c.findChild(t,{tagName:"INPUT",attr:{id:r}},true),w,u=(v&&v.file&&v.file["files"]&&v.file["files"]["default"]?v.file["files"]["default"]:false);if(!x){x=t.__replaceInputName=y.name}if(u){y.parentNode.insertBefore(c.create("INPUT",{attrs:{type:"hidden",name:x+"[name]",id:y.id,value:z.name}}),y);y.parentNode.insertBefore(c.create("INPUT",{attrs:{type:"hidden",name:x+"[type]",value:u.type}}),y);y.parentNode.insertBefore(c.create("INPUT",{attrs:{type:"hidden",name:x+"[tmp_name]",value:u.path}}),y);y.parentNode.insertBefore(c.create("INPUT",{attrs:{type:"hidden",name:x+"[size]",value:u.size}}),y);y.parentNode.insertBefore(c.create("INPUT",{attrs:{type:"hidden",name:x+"[error]",value:0}}),y)}else{y.parentNode.insertBefore(c.create("INPUT",{attrs:{type:"hidden",name:x,id:y.id,value:v.file["uploadId"]}}),y)}while(c(y)&&y.name.indexOf(x)===0){w=y.nextSibling;c.remove(y);y=w}if(this.uploadParams.maxCount<=1){var s=c.findChild(this.agent.form,{tagName:"INPUT",attr:{name:(x)}},false);if(s){c.adjust(s,{attrs:{disabled:true}});var q=x+"_del";if(x.indexOf("[")>0){q=x.substr(0,x.indexOf("["))+"_del"+x.substr(x.indexOf("["))}s=c.findChild(this.agent.form,{tagName:"INPUT",attr:{name:q}},false);if(s){c.adjust(s,{attrs:{disabled:true}})}}}},onUploadDone:function(r,u){var v=this.agent.getItem(r.id),t=v.item,s=v.node;if(t&&c(s)){var q=(u&&u.file&&u.file["files"]&&u.file["files"]["default"]?u.file["files"]["default"]:false);this.counters.uploaded.setItem(t.id,t.dialogName);if(q&&(q.wasChangedOnServer===true||(t.dialogName=="BX.UploaderImage")!==c.UploaderUtils.isImage(q.name,q.type,q.size))){this.replaceItem(t,q,s)}else{if(t.dialogName=="BX.UploaderImage"){this.amountFrameCounter(t.id,t)}}this.replaceInput(t,u);if(s.firstChild&&c.hasClass(s.firstChild,"adm-fileinput-item-saved")){c.removeClass(s.firstChild,"adm-fileinput-item-saved")}s.removeAttribute("bx-progress-bound");c.removeClass(s,"adm-fileinput-item-uploading");if(this.uploadParams.frameFiles=="Y"){this.frameFiles()}}},onUploadError:function(r,s){var q=this.agent.getItem(r.id).node;q.removeAttribute("bx-progress-bound");c.removeClass(q,"adm-fileinput-item-uploading adm-fileinput-item-image");c.addClass(q,"adm-fileinput-item-error");if(s&&s.error){q=c(r.id+"ErrorText");if(!q){q=c.create("SPAN",{attrs:{id:r.id+"ErrorText",className:"container-doc-error"}});c(r.id+"Name").parentNode.appendChild(q)}q.innerHTML=s.error}},onUploadRestore:function(){},onError:function(q,r){c.addClass(this.agent.placeHolder,"adm-fileinput-drag-area-error");if(r===true){alert(q)}else{c.debug(q)}},bindFile:function(r){var s=r.id,q=this.agent.getItem(r.id).node;if(r.dialogName=="BX.UploaderImage"){c.removeClass(q,"adm-fileinput-item-file");c.addClass(q,"adm-fileinput-item-image")}else{c.removeClass(q,"adm-fileinput-item-image");c.addClass(q,"adm-fileinput-item-file")}if(q&&!q.hasAttribute("bx-bound-editor")){q.setAttribute("bx-bound-editor","Y");if(this.agent.dialogName=="BX.UploaderSimple"){c.bind(q,"dblclick",c.delegate(function(u){var v=this.agent.getItem(r.id);if(v&&v.item.dialogName=="BX.UploaderImage"){var t=(v.item.file.real_url||v.item.file.tmp_url);if(t){c.util.popup(t)}}return c.PreventDefault(u)},this))}else{if(this.elementParams.edit){c.bind(q,"dblclick",c.delegate(function(t){c.PreventDefault(t);var u=this.agent.getItem(r.id);if(u&&u.item.dialogName=="BX.UploaderImage"){this.frameFiles(r.id)}},this))}}}if(c(s+"Edit")&&!c(s+"Edit").hasAttribute("bx-bound")){c(s+"Edit").setAttribute("bx-bound","Y");if(this.elementParams.edit){c.bind(c(s+"Edit"),"click",c.delegate(function(t){c.PreventDefault(t);var u=this.agent.getItem(r.id);if(u&&u.item.dialogName=="BX.UploaderImage"){this.frameFiles(r.id)}},this))}else{c.hide(c(s+"Edit"))}}if(c(s+"Del")&&!c(s+"Del").hasAttribute("bx-bound")){c(s+"Del").setAttribute("bx-bound","Y");c.bind(c(s+"Del"),"click",c.delegate(function(t){c.PreventDefault(t);this.deleteFile(r)},this))}if(c(s+"Description")&&!c(s+"Description").hasAttribute("bx-bound")){c(s+"Description").setAttribute("bx-bound","Y");c.bind(c(s+"Description"),"click",c.delegate(function(t){c.defer_proxy(function(){c.focus(c(s+"Description"))})();return c.PreventDefault(t)},this));c.bind(c(s+"Description"),"blur",function(){r.description=c(s+"Description").value})}this.replaceHint(r)},replaceHint:function(r){var v=r.id,q=this.agent.getItem(r.id).node;if(q.hint){q.hint.Destroy()}var u='<span class="adm-fileinput-drag-area-popup-title">'+c.util.htmlspecialchars(r.name)+"</span>";if(r.size){u+='<span class="adm-fileinput-drag-area-popup-param">'+c.message("JS_CORE_FILE_INFO_SIZE")+":&nbsp;<span>"+r.size+"</span></span>"}if(r.dialogName=="BX.UploaderImage"){var t="";if(r.file.width>0&&r.file.height>0){t=r.file.width+"x"+r.file.height}else{if(r.canvasIsLoaded&&r.canvas){t=r.canvas.width+"x"+r.canvas.height}}if(t!=""){u+='<span class="adm-fileinput-drag-area-popup-param">'+c.message("JS_CORE_FILE_INFO_DIM")+":&nbsp;<span>"+t+"</span></span>"}}if(r.description==undefined){r.description=(c(v+"Description")&&c(v+"Description").value?c(v+"Description").value:"")}if(r.description){u+='<span class="adm-fileinput-drag-area-popup-param">'+c.message("JS_CORE_FILE_DESCRIPTION")+":&nbsp;<span>"+r.description+"</span></span>"}var s=r.file?(r.file["real_url"]||r.file["tmp_url"]):"";if(s){s=c.util.htmlspecialchars(s);u+='<span class="adm-fileinput-drag-area-popup-param">'+c.message("JS_CORE_FILE_INFO_LINK")+':&nbsp;<span><a target="_blank" href="'+s.replace(/[%]/g,"%25")+'">'+s+"</a></span></span>"}q.hint=new c.CHint({parent:q,show_timeout:10,hide_timeout:200,dx:-10,preventHide:true,min_width:165,hint:u})},replaceItem:function(s,r,q){r.id=s.id;s.replaced=true;this.deleteFile(s,true);q.removeAttribute("bx-bound-editor");this.agent.onAttach([r],[q])},deleteFile:function(v,q){var w=(v?this.agent.getItem(v.id):false);if(!w){return}v=w.item;this.decrementFrameCounters(v.id,v);for(var s in this["fileEvents"]){if(this["fileEvents"].hasOwnProperty(s)){c.removeCustomEvent(v,s,this["fileEvents"][s])}}var u=w.node;if(u){if(u.hint){u.hint.Destroy()}if(v.replaced!==true){c.addClass(u,"adm-fileinput-item-remove")}}var r=(v.file["input_name"]||u.__replaceInputName),t=r+"_del";if(r&&r.indexOf("[")>0){t=r.substr(0,r.indexOf("["))+"_del"+r.substr(r.indexOf("["))}if(v.file["input_name"]){u=c.create("INPUT",{props:{name:r,type:"hidden",value:v.file["input_value"]}});this.agent.form.appendChild(u);u=c.create("INPUT",{props:{name:t,type:"hidden",value:"Y"}});this.agent.form.appendChild(u)}else{var x=c.findChild(this.agent.form,{tagName:"INPUT",attr:{name:r,disabled:true}},false);if(x){c.adjust(x,{attrs:{disabled:false}});c.adjust(c.findChild(this.agent.form,{tagName:"INPUT",attr:{name:t,disabled:true}},false),{attrs:{disabled:false}})}}if(q!==true){setTimeout(function(){v.deleteFile()},500)}else{v.deleteFile()}},destroy:function(){this.deleteFiles()}};c.UI.FileInput.getInstance=function(q){return i[q]};var g=function(u,q,s){this.single=parseInt(s)===1;this.id=u;this.number=0;this.templateNode=['<div class="adm-fileinput-item-panel"',(this.single?' style="display: none;"':""),">",'<span class="adm-fileinput-item-panel-btn adm-btn-del" id="#id#_#number#_del">&nbsp;</span>',"</div>",'<div class="adm-fileinput-urls-item">','<label for="#id#_#number#_path">',c.message("JS_CORE_FI_LINK"),"</label>",'<input id="#id#_#number#_path" type="text" value="" />',"</div>"].join("").replace(/#id#/gi,this.id);var t=(this.number++);this.number++;this.template=['<div class="adm-fileinput-urls-container" id="#id#_container">','<ol class="adm-fileinput-list adm-fileinput-urls" id="#id#_list">',"<li>",this.templateNode.replace(/#number#/gi,t+""),"</li>","</ol>",'<a href="#" id="#id#_add_point" class="adm-fileinput-item-add"',(this.single?' style="display:none"':""),">",c.message("JS_CORE_FI_ADD_LINK"),"</a>",'<div style="clear:both;"></div>',"</div>"].join("").replace(/#id#/gi,this.id);if(q){for(var r in q){if(q.hasOwnProperty&&q.hasOwnProperty(r)){c.addCustomEvent(this,r,q[r])}}}this._onAfterShow=c.delegate(this.onAfterShow,this);this._onApply=c.delegate(this.onApply,this);this._onCancel=c.delegate(this.onCancel,this);this._addRow=c.delegate(this.addRow,this);this._delRow=c.delegate(this.delRow,this)};g.prototype={popup:null,number:0,addRow:function(r){c.PreventDefault(r);var q=c(this.id+"_list"),s=(this.number++);if(q){q.appendChild(c.create("LI",{html:this.templateNode.replace(/#number#/gi,s+"")}));c.defer_proxy(function(){c.bind(c(this.id+"_"+s+"_del"),"click",this._delRow);this.bindFocus()},this)()}return false},bindFocus:function(){var r=c(this.id+"_list");if(r&&!this.single){for(var q=0;q<this.number;q++){if(c(this.id+"_"+q+"_path")){c.unbind(c(this.id+"_"+q+"_path"),"focus",this._addRow)}}for(q=this.number;q>=0;q--){if(c(this.id+"_"+q+"_path")){c.bind(c(this.id+"_"+q+"_path"),"focus",this._addRow);break}}}},delRow:function(){var s=c.proxy_context;if(c(s)){var q=c.findParent(s,{tagName:"LI"});if(c(q)){var r=(q==q.parentNode.lastChild);c.remove(q);if(r){this.bindFocus()}}}},onApply:function(){var t=c(this.id+"_list"),q=[],r;if(t){for(var s=0;s<=this.number;s++){r=(c(this.id+"_"+s+"_path")?c(this.id+"_"+s+"_path").value:"");if(r&&r.length>0){q.push(r)}}}c.onCustomEvent(this,"onApply",[q,this]);this.onCancel()},onCancel:function(){this.popup.close();this.popup.destroy();this.popup=null;this.number=0},onAfterShow:function(){c.bind(c(this.id+"_add_point"),"click",this._addRow);for(var q=0;q<=this.number;q++){if(c(this.id+"_"+q+"_del")){c.bind(c(this.id+"_"+q+"_del"),"click",this._delRow)}}this.bindFocus();c.removeCustomEvent(this.popup,"onAfterPopupShow",this._onAfterShow)},show:function(){if(this.popup===null){var q=c.create("DIV",{attrs:{id:this.id+"Proper"},style:{display:"none"},html:this.template});this.popup=c.PopupWindowManager.create("popup"+this.id,null,{autoHide:true,lightShadow:true,closeIcon:false,closeByEsc:true,zIndex:e(1),content:q,overlay:{},events:{onAfterPopupShow:this._onAfterShow},buttons:[new c.PopupWindowButton({text:c.message("JS_CORE_FI_ADD"),className:"popup-window-button-accept",events:{click:this._onApply}}),new c.PopupWindowButtonLink({text:c.message("JS_CORE_FI_CANCEL"),className:"popup-window-button-link-cancel",events:{click:this._onCancel}})]})}this.popup.show();this.popup.adjustPosition()}};var p=0,m=function(){var q=function(r){this.id="framePreset"+(p++);this.onAfterShow=c.delegate(this.onAfterShow,this);this.addRow=c.delegate(this.addRow,this);this.delRow=c.delegate(this.delRow,this);if(r){this.init(r)}};q.prototype={active:null,id:"framePreset0",values:[],valuesInner:[],popup:null,number:0,maxLength:10,getTemplateNode:function(){return["<li>",'<div class="adm-fileinput-item-panel">','<span class="adm-fileinput-item-panel-btn adm-btn-del" id="#classId##id#_del">&nbsp;</span>',"</div>",'<div class="adm-fileinput-presets-item">','<input class="adm-fileinput-presets-title" id="presets_#id#__title_" name="presets[#id#][title]" type="text" value="#title#" placeholder="',c.message("JS_CORE_FI_TITLE"),'" />','<input class="adm-fileinput-presets-width" name="presets[#id#][width]" type="text" value="#width#" placeholder="',c.message("JS_CORE_FI_WIDTH"),'" />','<input class="adm-fileinput-presets-hight" name="presets[#id#][height]" type="text" value="#height#" placeholder="',c.message("JS_CORE_FI_HEIGHT"),'" />',"</div>","</li>"].join("").replace(/#classId#/gi,this.id)},getTemplate:function(){return['<div class="adm-fileinput-presets-container" id="#classId#_container">','<form id="#classId#_form">','<ol class="adm-fileinput-list adm-fileinput-presets" id="#classId#_list">',"#nodes#","</ol>","</form>",'<a href="#" id="#classId#_add_point" class="adm-fileinput-item-add">',c.message("JS_CORE_FI_ADD_PRESET"),"</a>",'<div style="clear:both;"></div>',"</div>"].join("")},init:function(s){this.values=[];this.length=0;if(c.type.isArray(s.presets)){var t;for(var r=0;r<s.presets.length;r++){t=this.values.length;this.values.push({id:t,title:s.presets[r]["title"],width:s.presets[r]["width"],height:s.presets[r]["height"]})}this.length=this.values.length;this.setActive(s.presetActive)}},setActive:function(r){r=parseInt(r);this.activeId=this.values[r]?r:0;this.active=(this.values[this.activeId]||null)},edit:function(w){var v=c.proxy_context,t="",r=this.values;for(var u=0;u<r.length;u++){t+=this.getTemplateNode().replace(/#id#/gi,r[u]["id"]).replace(/#title#/gi,r[u]["title"]).replace(/#width#/gi,r[u]["width"]).replace(/#height#/gi,r[u]["height"])}if(this.values.length<this.maxLength&&w&&w.width&&w.height){t+=this.getTemplateNode().replace(/#id#/gi,u).replace(/#title#/gi,"").replace(/#width#/gi,w.width).replace(/#height#/gi,w.height)}if(!!this.popup){this.popup.close()}var s=c.pos(v);this.popup=new c.PopupWindow("bx-preset-popup-"+v.id,v,{lightShadow:true,offsetTop:-3,className:"bxu-poster-popup",offsetLeft:Math.ceil(s.width/2),autoHide:true,closeByEsc:true,zIndex:e(30+c.PopupWindow.getOption("popupOverlayZindex")-c.PopupWindow.getOption("popupZindex")),bindOptions:{position:"top"},overlay:false,events:{onAfterPopupShow:this.onAfterShow,onPopupClose:function(){this.destroy()},onPopupDestroy:c.proxy(function(){this.popup=null},this)},buttons:[new c.PopupWindowButton({text:c.message("CANVAS_OK"),className:"popup-window-button-accept",events:{click:c.delegate(function(){var x=c.UploaderUtils.FormToArray(c(this.id+"_form"));this.onApply(x.data);this.popup.close()},this)}}),new c.PopupWindowButtonLink({text:c.message("CANVAS_CANCEL"),className:"popup-window-button-link-cancel",events:{click:c.delegate(function(){this.popup.close()},this)}})],content:this.getTemplate().replace(/#classId#/gi,this.id).replace(/#nodes#/i,t)});this.popup.show();this.popup.setAngle({position:"bottom"});this.popup.bindOptions.forceBindPosition=true;this.popup.adjustPosition();c.focus(c("popupText"+v.id));this.popup.bindOptions.forceBindPosition=false},onAfterShow:function(){c.bind(c(this.id+"_add_point"),"click",this.addRow);var t,s=false;for(var r=0;r<this.length;r++){t=c(this.id+r+"_del");if(t){c.bind(t,"click",this.delRow);s=(s===false?0:s)+1}}if(s===false){this.addRow()}this.checkAddButton();if(c("presets_"+r+"__title_")){c.focus(c("presets_"+r+"__title_"))}},checkAddButton:function(){var r=c(this.id+"_list"),s=(this.maxLength>r.childNodes.length);if(s){c.removeClass(c(this.id+"_add_point"),"disabled")}else{c.addClass(c(this.id+"_add_point"),"disabled")}return s},addRow:function(s){c.PreventDefault(s);var r=c(this.id+"_list"),t;if(r&&this.checkAddButton()){t=this.length++;r.appendChild(c.create("LI",{html:this.getTemplateNode().replace(/^<li(.*?)>/gi,"").replace(/<\/li(.*?)>$/gi,"").replace(/#id#/gi,t).replace(/#title#/gi,"").replace(/#width#/gi,"").replace(/#height#/gi,"")}));c.defer_proxy(function(){c.bind(c(this.id+t+"_del"),"click",this.delRow)},this)()}this.checkAddButton();return false},delRow:function(){var s=c.proxy_context;if(c(s)){var r=c.findParent(s,{tagName:"LI"});if(r){c.remove(r)}}this.checkAddButton()},onApply:function(s){this.values=[];if(s&&s.presets){s.presets=c.util.array_values(s.presets);for(var t,r=0;r<s.presets.length;r++){if(s.presets[r]&&s.presets[r]["width"]>0&&s.presets[r]["height"]>0){t=this.values.length;this.values.push({id:t,width:s.presets[r]["width"],height:s.presets[r]["height"],title:(s.presets[r]["title"]||(s.presets[r]["width"]+"x"+s.presets[r]["height"]))})}}}this.save();c.onCustomEvent(this,"onApply",[this.values,this])},savedLastTime:"",save:function(){var r="";r+="&p[0][c]=main&p[0][n]=fileinput";if(this.values.length>0){for(var t,s=0;s<this.values.length;s++){for(t in this.values[s]){if(this.values[s].hasOwnProperty(t)){if(t!="id"){r+="&p[0][v][presets]["+s+"]["+t+"]="+c.util.urlencode(this.values[s][t])}}}}}else{r+="&p[0][v][presets]="}if(this.savedLastTime!=r){c.ajax({method:"GET",dataType:"html",processData:false,cache:false,url:c.userOptions.path+r+"&sessid="+c.bitrix_sessid()})}},getActive:function(){this.activeId=(this.values[this.activeId]?this.activeId:0);var r=this.values[this.activeId];if(r){r.id=this.activeId}return(r||null)}};return q}();var n,b,o=function(q){this.params=q;this.preset=n=(n||new m(q));c.addCustomEvent(this.preset,"onApply",c.delegate(this.onPresetsApply,this));this.id="FM";this.handlers={show:c.delegate(this.onShow,this),afterShow:c.delegate(this.onAfterShow,this),close:c.delegate(this.onClose,this),cancel:c.delegate(this.onCancel,this),apply:c.delegate(this.onApply,this)}};o.prototype={id:"",canvas:null,description:null,agent:null,items:null,activeItem:null,popup:null,init:function(q){if(q){this.params=q;this.preset.init(q)}this.params=(this.params||{});this.params.description=(this.params.description!==false)},start:function(s,r,u){this.init(u);this.agent=s;this.items=new c.UploaderUtils.Hash();b=(b||new c.UploaderFileCnvConstr());var q=this.agent.getItems(),t,v;q.reset();while((t=q.getNext())&&t){if(t.dialogName=="BX.UploaderImage"){v=this.id+"_"+t.id;this.items.setItem(v,{id:v,item:t,canvas:t.canvas.cloneNode(true),file:null,props:{description:t.description}});if(r==t.id){r=v}}}if(this.items.length>0){this.activeItem=(this.items.hasItem(r)?this.items.getItem(r):this.items.getFirst());this.showEditor()}},finish:function(r){if(this.items!==null&&this.agent!==null){var q;this.items.reset();while((q=this.items.getNext())&&q){if(r&&q.props){c.onCustomEvent(this.agent,"onFilesPropsAreModified",[q.item.id,q.item,q.props])}if(r&&q.file){c.onCustomEvent(this.agent,"onFileIsFramed",[q.item.id,q.item,q.canvas,q.file])}c.remove(q.canvas);delete q.canvas;delete q.file;delete q.item;delete q.props}c.onCustomEvent(this.agent,"onFilesAreFramed",[])}this.agent=null;this.items=null;this.activeItem=null},onShow:function(){},bindThumbItem:function(s){var r=c(s.id+"EditorItemCanvas");r.parentNode.replaceChild(s.canvas,r);c.addClass(s.canvas,"adm-photoeditor-preview-panel-container-img");s.canvas.setAttribute("id",s.id+"EditorItemCanvas");var q=0,t=function(u){q++;if(u){if(q>1){c.adjust(s.canvas,{props:{width:s.item.canvas.width,height:s.item.canvas.height}})}c.removeCustomEvent(s.item,"onFileIsInited",t)}s.canvas.getContext("2d").drawImage(s.item.canvas,0,0)};c.addCustomEvent(s.item,"onFileIsInited",t);t();c.removeClass(c(s.id+"EditorItem"),"adm-photoeditor-preview-panel-container-wait");c.bind(c(s.id+"EditorItem"),"click",c.proxy(function(){if(this.activeItem!==s){this.setActiveItem(s)}},this));c.bind(c(s.id+"EditorItemDelete"),"click",c.proxy(function(u){c.PreventDefault(u);this.deleteItem(s)},this))},deleteItem:function(q){if(this.activeItem==q){this.items.setPointer(q.id);var r=this.items.getNext();if(r){this.setActiveItem(r)}else{this.clearActiveItem()}}c.remove(c(q.id+"EditorItem"));q=this.items.removeItem(q.id);c.onCustomEvent(this,"onDeleteItem",[q.item])},saveActiveItem:function(r){if(this.activeItem!==null){var t=this.activeItem,s=c.UploaderUtils.scaleImage(r,{width:d,height:d});if(s.destin.width!=t.canvas.width||s.destin.height!=t.canvas.height){c.adjust(t.canvas,{props:s.destin})}else{c.adjust(t.canvas,{props:{width:t.canvas.width-1}});c.adjust(t.canvas,{props:{width:t.canvas.width+1}})}t.canvas.getContext("2d").drawImage(r,0,0,r.width,r.height,0,0,t.canvas.width,t.canvas.height);var q=r.toDataURL(t.item.file.type,0.75);t.file=c.UploaderUtils.dataURLToBlob(q);t.file.width=r.width;t.file.height=r.height}},saveActiveItemChanges:function(){if(this.activeItem!=null){this.activeItem.props.description=this.description.value;if(this.canvas.changed===true){c.onCustomEvent(this.canvas,"onChange",[this.canvas.getCanvas(),this.canvas])}}return null},clearActiveItem:function(){this.activeItem=this.saveActiveItemChanges();this.canvas.set(c.create("CANVAS"),{props:{width:100,height:100}});this.description.value=""},setActiveItem:function(r){if(this.activeItem!=r){c.onCustomEvent(this,"onActiveItemIsChanged",[r,this.activeItem]);c.onCustomEvent(this.canvas,"onCropHasToBeHidden",[]);c.onCustomEvent(this.canvas,"onActiveItemIsChanged",[]);if(this.activeItem!==null){c.removeClass(c(this.activeItem.id+"EditorItem"),"active")}this.saveActiveItemChanges()}if(!c.hasClass(c(r.id+"EditorItem"),"active")){c.addClass(c(r.id+"EditorItem"),"active")}this.activeItem=r;this.description.value=r.props.description;var q=(r.file||r.item.file);this.canvas.set(r.canvas,{props:{width:q.width,height:q.height}});if(r.canvas.width!=q.width||r.canvas.height!=q.height){r.__onload=c.proxy(function(s){if(this.activeItem==r){c.adjust(b.getCanvas(),{props:{width:s.width,height:s.height}});b.getContext().drawImage(s,0,0);this.canvas.set(b.getCanvas(),false);r.__onerror()}},this);r.__onerror=c.proxy(function(){if(this.activeItem==r){r.__onload=null;delete r.__onload;r.__onerror=null;delete r.__onerror}},this);c.defer_proxy(function(){b.push(q,r.__onload,r.__onerror)})()}},onAfterShow:function(){try{this.bindTemplate()}catch(r){this["bindTemplateCounter"]=(this["bindTemplateCounter"]||0)+1;if(this["bindTemplateCounter"]<10){setTimeout(c.proxy(this.onAfterShow,this),500)}}var q;this.items.reset();while((q=this.items.getNext())&&q){this.bindThumbItem(q)}this.canvas.setCancelNode(this.id+"cancel");this.canvas.setMapCollapsed(this.id+"MapCollapsed");this.setActiveItem(this.activeItem);c.bind(c(this.id+"turn-l"),"click",c.proxy(function(){this.rotate(false)},this.canvas));c.bind(c(this.id+"turn-r"),"click",c.proxy(function(){this.rotate(true)},this.canvas));c.bind(c(this.id+"flip-v"),"click",c.proxy(function(){this.flip(false)},this.canvas));c.bind(c(this.id+"flip-h"),"click",c.proxy(function(){this.flip(true)},this.canvas));c.bind(c(this.id+"crop"),"click",c.proxy(function(){this.crop(c.proxy_context)},this.canvas));c.bind(c(this.id+"grayscale"),"click",c.proxy(function(){this.blackAndWhite()},this.canvas));c.bind(c(this.id+"sign"),"click",c.proxy(function(){this.poster(c.proxy_context)},this.canvas));c.bind(c(this.id+"scaleIndicator"),"mousedown",c.proxy(this.canvas.scale,this.canvas));c.bind(c(this.id+"scaleWidthPlus"),"mousedown",c.proxy(function(){this.increaseScale("width",true)},this));c.bind(c(this.id+"scaleWidthPlus"),"mouseup",c.proxy(function(){this.scaleChange("width",true)},this));c.bind(c(this.id+"scaleWidth"),"focus",c.proxy(function(){this.startTraceScale("width")},this));c.bind(c(this.id+"scaleWidth"),"blur",c.proxy(function(){this.stopTraceScale("width")},this));c.bind(c(this.id+"scaleWidthMinus"),"mousedown",c.proxy(function(){this.increaseScale("width",false)},this));c.bind(c(this.id+"scaleWidthMinus"),"mouseup",c.proxy(function(){this.scaleChange("width",false)},this));c.bind(c(this.id+"scaleHeightPlus"),"mousedown",c.proxy(function(){this.increaseScale("height",true)},this));c.bind(c(this.id+"scaleHeightPlus"),"mouseup",c.proxy(function(){this.scaleChange("height",true)},this));c.bind(c(this.id+"scaleHeight"),"focus",c.proxy(function(){this.startTraceScale("height")},this));c.bind(c(this.id+"scaleHeight"),"blur",c.proxy(function(){this.stopTraceScale("height")},this));c.bind(c(this.id+"scaleHeightMinus"),"mousedown",c.proxy(function(){this.increaseScale("height",false)},this));c.bind(c(this.id+"scaleHeightMinus"),"mouseup",c.proxy(function(){this.scaleChange("height",false)},this));this.onPresetsApply();c.bind(c(this.id+"presetsValues"),"change",c.proxy(function(){this.preset.setActive(c.proxy_context.value)},this));c.bind(c(this.id+"presetInsert"),"click",c.proxy(function(){c(this.id+"scaleChained").checked=true;var s=this.preset.getActive();if(s){this.canvas.scaleInit(c(this.id+"scaleIndicator"));this.canvas.cropInsert(s,c(this.id+"crop"))}},this));c.bind(c(this.id+"presetEdit"),"click",c.proxy(this.preset.edit,this.preset));c.addCustomEvent(this.canvas,"onCropStart",c.delegate(function(){c.removeClass(c(this.id+"presetSave"),"disabled")},this));c.addCustomEvent(this.canvas,"onCropFinish",c.delegate(function(){c.addClass(c(this.id+"presetSave"),"disabled")},this));c.bind(c(this.id+"presetSave"),"click",c.proxy(function(){if(this.canvas.busy===true&&this.canvas.cropObj){this.preset.edit(this.canvas.cropObj.cropParams)}},this));c.bind(c(this.id+"editorQueueUp"),"click",c.proxy(this.up,this));c.bind(c(this.id+"editorQueueDown"),"click",c.proxy(this.down,this))},onPresetsApply:function(){var s=c(this.id+"presetsValues");if(s){var q="",t=this.preset.getActive(),r;for(r=0;r<this.preset.values.length;r++){q+='<option value="'+r+'" bx-width="'+this.preset.values[r]["width"]+'" bx-height="'+this.preset.values[r]["height"]+'"'+(r==t.id?' selected="selected"':"")+">"+n.values[r]["title"]+"("+this.preset.values[r]["width"]+"x"+this.preset.values[r]["height"]+")</option>"}s.innerHTML=q}},onApply:function(){this.saveActiveItemChanges();this.popup.onApplyFlag=true;this.popup.close()},onCancel:function(){this.popup.close()},onClose:function(){this.finish((this.popup.onApplyFlag===true));c.removeCustomEvent(this.popup,"onPopupShow",this.handlers.show);c.removeCustomEvent(this.popup,"onAfterPopupShow",this.handlers.afterShow);c.removeCustomEvent(this.popup,"onPopupClose",this.handlers.close);c.onCustomEvent(this.canvas,"onPopupClose",[]);this.popup.destroy();this.popup=null;this.slider=null},bindTemplate:function(){this.canvas=new h(this.id+"editorActive",{block:c(this.id+"editorActiveBlock"),canvas:c(this.id+"editorActiveImageCanvas"),canvasBlock:c(this.id+"editorActiveImageBlock")});c.addCustomEvent(this.canvas,"onChange",c.delegate(this.saveActiveItem,this));c.addCustomEvent(this.canvas,"onSetCanvas",c.delegate(this.scaleChangeSize,this));c.addCustomEvent(this.canvas,"onScaleCanvas",c.delegate(this.scaleChangeSize,this));this.canvas.registerWheel(c(this.id+"editorActiveBlock"));this.description=c(this.id+"editorDescription")},getTemplate:function(){var r="";var q=['<div class="adm-photoeditor-preview-panel-container adm-photoeditor-preview-panel-container-wait" id="#id#EditorItem"> 				<div class="adm-photoeditor-preview-panel-container-sub"> 					<img src="',"/bitrix/images/1.gif",'" class="adm-photoeditor-preview-panel-container-space" /> 					<span id="#id#EditorItemCanvas"></span> 					<span id="#id#EditorItemDelete" class="adm-photoeditor-preview-panel-container-close">&nbsp;</span> 				</div> 			</div>'].join(""),s;this.items.reset();while((s=this.items.getNext())&&s){r+=q.replace(/#id#/gi,s.id)}return['<div class="adm-photoeditor-container"> 			<div class="adm-photoeditor-buttons-panel"> 			<div class="adm-photoeditor-buttons-panel-save disabled" id="',this.id,"presetSave",'"><span>',c.message("JS_CORE_FI_SAVE_PRESET"),'</span></div> 			<div class="adm-photoeditor-buttons-panel-cancel disabled" id="',this.id,"cancel",'"><span>',c.message("JS_CORE_FI_CANCEL_PRESET"),'</span></div> 			<div class="adm-photoeditor-btn-wrap"> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-turn-l" id="',this.id,"turn-l",'" title="',c.message("CANVAS_TURN_L"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-turn-r" id="',this.id,"turn-r",'"title="',c.message("CANVAS_TURN_R"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-flip-v" id="',this.id,"flip-v",'" title="',c.message("CANVAS_FLIP_V"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-flip-h" id="',this.id,"flip-h",'" title="',c.message("CANVAS_FLIP_H"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-crop" id="',this.id,"crop",'" title="',c.message("CANVAS_CROP"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-grayscale" id="',this.id,"grayscale",'" title="',c.message("CANVAS_GRAYSCALE"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-sign" id="',this.id,"sign",'" title="',c.message("CANVAS_SIGN"),'"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 			</div> 			<div id="',this.id,'cropPresets"> 				<div class="adm-photoeditor-buttons-panel-cropping"> 					<span class="crop">',c.message("JS_CORE_FI_FRAMING"),'</span> 					<span class="adm-select-wrap"> 						<select class="adm-select" id="',this.id,'presetsValues"></select> 						</span> 				</div> 				<div class="adm-photoeditor-btn-wrap"> 					<span class="adm-photoeditor-btn adm-photoeditor-btn-cut" id="',this.id,'presetInsert" title="',c.message("JS_CORE_FI_USE_PRESET"),'"> 						<span class="adm-photoeditor-btn-icon"></span> 					</span> 					<span class="adm-photoeditor-btn adm-photoeditor-btn-edit" id="',this.id,'presetEdit" title="',c.message("JS_CORE_FI_EDIT_PRESET"),'"> 						<span class="adm-photoeditor-btn-icon"></span> 					</span> 				</div> 				<span class="adm-photoeditor-btn adm-photoeditor-btn-ph disabled" id="',this.id,'MapCollapsed"> 					<span class="adm-photoeditor-btn-icon"></span> 				</span> 			</div> 		</div> 		<div class="adm-photoeditor-sidebar"> 			<div class="adm-photoeditor-sidebar-options"> 				<span class="adm-photoeditor-sidebar-options-title">',c.message("JS_CORE_FI_WIDTH"),'</span> 				<span class="adm-photoeditor-plus" id="',this.id,'scaleWidthPlus">&nbsp;</span> 				<input type="number" value="0" id="',this.id,'scaleWidth" /> 				<span class="adm-photoeditor-minus" id="',this.id,'scaleWidthMinus">&nbsp;</span> 			</div> 			<div class="adm-photoeditor-sidebar-options"> 				<div class="sidebar-options-checkbox-container"> 					<input type="checkbox" value="Y" id="',this.id,'scaleChained" checked /> 					<label for="',this.id,'scaleChained"><span class="label-icon"></span></label> 				</div> 			</div> 			<div class="adm-photoeditor-sidebar-options"> 				<span class="adm-photoeditor-sidebar-options-title">',c.message("JS_CORE_FI_HEIGHT"),'</span> 				<span class="adm-photoeditor-plus" id="',this.id,'scaleHeightPlus">&nbsp;</span> 				<input type="number" value="0" id="',this.id,'scaleHeight" /> 				<span class="adm-photoeditor-minus" id="',this.id,'scaleHeightMinus">&nbsp;</span> 			</div> 			<div class="adm-photoeditor-sidebar-scale"> 				<span class="adm-photoeditor-sidebar-scale-value" style="top: 0">+100%</span> 				<span class="adm-photoeditor-sidebar-scale-value" style="top: 25%">+50%</span> 				<span class="adm-photoeditor-sidebar-scale-value" style="top: 50%">0%</span> 				<span class="adm-photoeditor-sidebar-scale-value" style="top: 75%">-50%</span> 				<span class="adm-photoeditor-sidebar-scale-value" style="top: 100%">-100%</span> 				<div class="adm-photoeditor-scale-indicator" style="top: 50%" id="',this.id,'scaleIndicator">0%</div> 			</div> 		</div> 		<div class="adm-photoeditor"> 			<div class="adm-photoeditor-preview-panel"> 				<span class="adm-photoeditor-preview-panel-arrow-top" id="',this.id,'editorQueueUp"></span> 				<div class="adm-photoeditor-preview-panel-previews" id="',this.id,'editorQueue"> 					<div class="adm-photoeditor-preview-panel-previews-inner" id="',this.id,'editorQueueInner">',r,'</div> 				</div> 				<span class="adm-photoeditor-preview-panel-arrow-bottom" id="',this.id,'editorQueueDown"></span> 			</div> 			<div class="adm-photoeditor-active-block-outer"> 				<div class="adm-photoeditor-active-block" id="',this.id,'editorActiveBlock"> 					<div class="adm-photoeditor-active-image-block" id="',this.id,'editorActiveImageBlockOuter"> 						<div class="adm-photoeditor-active-image" id="',this.id,'editorActiveImageBlock"> 							<div class="adm-photoeditor-crop" id="',this.id,'editorActiveCrop"></div> 							<canvas id="',this.id,'editorActiveImageCanvas"></canvas> 						</div> 						<div class="adm-photoeditor-active-cursor"></div> 						<div class="adm-photoeditor-active-move-cursor"></div> 					</div> 				</div> 				<div class="adm-photoeditor-desc"><input type="text" id="',this.id,'editorDescription" placeholder="',c.message("JS_CORE_FILE_DESCRIPTION"),'"></div> 			</div> 		</div> 	</div>'].join("").replace(/[\n\t]/gi,"").replace(/>\s</gi,"><")},showEditor:function(){if(!this.popup||this.popup===null){var q=c.create("DIV",{attrs:{id:this.id+"Proper",className:"bxu-edit-popup"},style:{display:"none"},html:this.getTemplate()});this.popup=c.PopupWindowManager.create("popup"+this.id,null,{className:"bxu-popup"+(this.params.description!==false?"":" bxu-popup-nondescription"),autoHide:false,lightShadow:true,closeIcon:false,closeByEsc:true,zIndex:e(1),content:q,overlay:{},events:{onPopupShow:this.handlers.show,onAfterPopupShow:this.handlers.afterShow,onPopupClose:this.handlers.close},buttons:[new c.PopupWindowButton({text:c.message("JS_CORE_WINDOW_SAVE"),className:"popup-window-button-accept",events:{click:this.handlers.apply}}),new c.PopupWindowButtonLink({text:c.message("JS_CORE_WINDOW_CANCEL"),className:"popup-window-button-link-cancel",events:{click:this.handlers.cancel}})]})}this.popup.show();this.popup.adjustPosition()},slider:null,initSliderParams:function(){if(this.slider==null){this.slider={top:0,step:30,outer:c(this.id+"editorQueue"),outerPos:c.pos(c(this.id+"editorQueue")),inner:c(this.id+"editorQueueInner"),innerPos:c.pos(c(this.id+"editorQueueInner"))};this.slider.maxHeight=Math.min((this.slider.outerPos.height-this.slider.innerPos.height),0)}return this.slider},up:function(q){if(this.initSliderParams()){this.slider.top=Math.min((this.slider.top+this.slider.step),0);this.slider.inner.style.top=this.slider.top+"px"}return c.PreventDefault(q)},down:function(q){if(this.initSliderParams()){this.slider.top=Math.max(this.slider.maxHeight,(this.slider.top-this.slider.step));this.slider.inner.style.top=this.slider.top+"px"}return c.PreventDefault(q)},lastProportion:{width:0,height:0,"~width":0,"~height":0,timeout:null},increaseScale:function(q,t){if(this.increaseScaleTimeout>0){clearTimeout(this.increaseScaleTimeout)}q=(q=="width"?"width":"height");var r=(q=="width"?c(this.id+"scaleWidth"):c(this.id+"scaleHeight")),u=this,s=function(){if(t===false){r.value=(++u.lastProportion[q])}else{if(t===true){r.value=Math.max((--u.lastProportion[q]),1)}}u.lastProportion[q]=parseInt(r.value);u.increaseScaleTimeoutCounter++;u.increaseScaleTimeout=setTimeout(s,(150-Math.min(100,u.increaseScaleTimeoutCounter*u.increaseScaleTimeoutCounter)))};this.increaseScaleTimeoutCounter=0;this.increaseScaleTimeout=setTimeout(s,50)},startTraceScale:function(q){if(this.traceScaleTimeout>0){clearTimeout(this.traceScaleTimeout)}this.traceScaleTimeout=(this.traceScaleTimeout>0?this.traceScaleTimeout:0);q=(q=="width"?"width":"height");var r=(q=="width"?c(this.id+"scaleWidth"):c(this.id+"scaleHeight"));if(this.lastProportion[q]===parseInt(r.value)){this.traceScaleTimeout++;if(this.traceScaleTimeout>5){this.traceScaleTimeout=0;this.scaleAdjust(q,null)}}else{this.traceScaleTimeout=0;this.lastProportion[q]=parseInt(r.value)}this.traceScaleTimeout=setTimeout(c.proxy(function(){this.startTraceScale(q)},this),500)},stopTraceScale:function(q){if(this.traceScaleTimeout>0){clearTimeout(this.traceScaleTimeout)}this.traceScaleTimeout=0;this.scaleAdjust(q,null)},scaleChange:function(q,r){if(this.increaseScaleTimeout>0){clearTimeout(this.increaseScaleTimeout)}if(this.traceScaleTimeout>0){clearTimeout(this.traceScaleTimeout)}if(this.lastProportion.timeout===null){this.lastProportion.timeout=setTimeout(c.proxy(this.scaleAdjust,this),500)}},scaleAdjust:function(q){this.lastProportion.timeout=null;if(q>0){this.lastProportion["~width"]=this.lastProportion.width=q;this.canvas.scaleWidth(this.lastProportion.width,true,c(this.id+"scaleIndicator"))}else{if(this.lastProportion["~width"]!=this.lastProportion.width){this.lastProportion["~width"]=this.lastProportion.width;this.canvas.scaleWidth(this.lastProportion.width,this.scaleIsChained(),c(this.id+"scaleIndicator"))}if(this.lastProportion["~height"]!=this.lastProportion.height){this.lastProportion["~height"]=this.lastProportion.height;this.canvas.scaleHeight(this.lastProportion.height,this.scaleIsChained(),c(this.id+"scaleIndicator"))}}},scaleIsChained:function(){return(!!c(this.id+"scaleChained").checked)},scaleChained:function(){c(this.id+"scaleWidth").value=this.lastProportion.width},scaleChangeSize:function(q){this.lastProportion["~width"]=this.lastProportion.width=c(this.id+"scaleWidth").value=(q.width||0);this.lastProportion["~height"]=this.lastProportion.height=c(this.id+"scaleHeight").value=(q.height||0)}};var a=function(q){this.depth=q};a.prototype={id:"CanvasStack",depth:3,stack:[],number:0,init:function(){var q;while((q=this.stack.shift())&&q){c.remove(q);q=null}this.stack=[];c.onCustomEvent(this,"onChange",[this.stack.length,this.stack])},add:function(q){this.number++;var r=c.create("CANVAS",{attrs:{id:this.id+this.number},props:{width:q.width,height:q.height},style:{display:"none"}});r.getContext("2d").drawImage(q,0,0);this.stack.push(r);while(this.stack.length>this.depth){r=this.stack.shift();c.remove(r);r=null}c.onCustomEvent(this,"onChange",[this.stack.length,this.stack])},restore:function(){var q=this.stack.pop();if(q){c.onCustomEvent(this,"onRestore",[q]);c.remove(q);c.onCustomEvent(this,"onChange",[this.stack.length,this.stack])}}};var h=function(s,q){this.block=q.block;this.block.pos=c.pos(this.block);this.canvas=q.canvas;this.ctx=this.canvas.getContext("2d");this.canvasBlock=q.canvasBlock;var r=c.UploaderUtils.scaleImage(this.block.pos,{width:this.mapSize,height:this.mapSize});this.canvasMap=new l(q.block,{width:r.destin.width,height:r.destin.height,scale:r.coeff});c.addCustomEvent(this.canvasMap,"onMapPointerIsMoved",c.delegate(this.move,this));c.addCustomEvent(this.canvasMap,"onMapIsInitialised",c.delegate(function(){this.registerWheel(this.canvasMap.root)},this));this.id=s;c.bind(window,"resize",c.proxy(this.onResizeWindow,this));this.stack=new a(5);c.addCustomEvent(this.stack,"onChange",c.delegate(this.changeCancelNode,this));c.addCustomEvent(this.stack,"onRestore",c.delegate(this.restore,this));c.addCustomEvent(this,"onActiveItemIsChanged",c.delegate(this.stack.init,this.stack));c.addCustomEvent(this,"onPopupClose",c.delegate(function(){if(this.cropObj){this.cropObj.finish()}this.canvasMap.hide(false)},this))};h.prototype={registerWheel:function(q){c.bind(q,this.onWheelEvent,c.delegate(this.onWheel,this));if(this.onWheelEvent=="DOMMouseScroll"){c.bind(q,"MozMousePixelScroll",c.delegate(this.onWheel,this))}},onWheelEvent:("onwheel" in document.createElement("div")?"wheel":document.onmousewheel!==undefined?"mousewheel":"DOMMouseScroll"),onWheelMaxSpeed:50,onWheelLastEvent:0,onWheel:function(r){var s,q=(new Date()).getTime();if((q-this.onWheelLastEvent)<this.onWheelMaxSpeed){return c.PreventDefault(r)}this.onWheelLastEvent=q;if(r.deltaY){s=r.deltaY}else{if(this.onWheelEvent=="mousewheel"){s=-1/40*r.wheelDelta}else{s=r.detail}}if(s!=undefined){this.zoom(s*(-1),r)}return c.PreventDefault(r)},startScale:1,mapSize:300,onResizeWindow:function(){},setHack:{width:0,height:0},set:function(s,w){var v=(w||{props:{width:s.width,height:s.height}}),x=this.block.pos,r,q,u;if((this.setHack.width+"")==(v.props.width+"")&&(this.setHack.height+"")==(v.props.height+"")){this.setHack.width--;c.adjust(this.canvas,{props:this.setHack})}this.setHack.width=v.props.width;this.setHack.height=v.props.height;c.adjust(this.canvas,v);q=r=Math.min((this.canvas.width>0?x.width/this.canvas.width:1),(this.canvas.height>0?x.height/this.canvas.height:1));r=(0<r&&r<1?r:1);u={top:Math.ceil((x.height-this.canvas.height*r)/2),left:Math.ceil((x.width-this.canvas.width*r)/2),width:this.canvas.width,height:this.canvas.height,transform:"translate3d(0, 0, 0) scale("+r+", "+r+")"};this.zoomCounter=0;this.canvas.startScale=r;this.canvas.maxVisibleScale=q;this.canvas.scale=r;this.canvas.pos={absoluteLeft:u.left+x.left,absoluteTop:u.top+x.top,absoluteWidth:x.width,absoluteHeight:x.height,startedWidth:Math.ceil(this.canvas.width*r),startedHeight:Math.ceil(this.canvas.height*r),left:u.left,top:u.top,shiftX:0,"~shiftX":0,shiftY:0,"~shiftY":0};this.canvas.visiblePart={left:0,"~left":0,top:0,"~top":0,"~width":s.width,width:s.width,"~height":s.height,height:s.height,leftGap:this.canvas.pos.left,topGap:this.canvas.pos.top,rightGap:this.canvas.pos.absoluteWidth-this.canvas.pos.startedWidth-this.canvas.pos.left,bottomGap:this.canvas.pos.absoluteHeight-this.canvas.pos.startedHeight-this.canvas.pos.top};for(var t in u){if(u.hasOwnProperty(t)){if(u[t]>0){u[t]=u[t]+"px"}}}c.adjust(c(this.canvasBlock),{style:u});this.ctx.drawImage(s,0,0,s.width,s.height,0,0,this.canvas.width,this.canvas.height);this.canvasMap.init(this.canvas,(w?w.props:false));c.onCustomEvent(this,"onSetCanvas",[this.canvas,s]);this.changed=false},setMapCollapsed:function(q){if(this.canvasMap){this.canvasMap.registerCollapsedNode(q)}},setCancelNode:function(q){this.cancelNode=c(q);if(!c.hasClass(this.cancelNode,"disabled")){c.addClass(this.cancelNode,"disabled")}c.bind(this.cancelNode,"click",c.delegate(this.stack.restore,this.stack))},changeCancelNode:function(q){if(q){c.removeClass(this.cancelNode,"disabled")}else{if(!c.hasClass(this.cancelNode,"disabled")){c.addClass(this.cancelNode,"disabled")}}},restore:function(q){this.set(q,{props:{width:q.width,height:q.height}});c.onCustomEvent(this,"onCropHasToBeHidden",[])},cursor:{x:0,y:0},zoomEdge:2,zoomCounter:0,busy:false,zoom:function(t,q){if(this.busy!==false){return}var s=0;if(t>0&&this.zoomCounter<this.zoomEdge){s=0.1}else{if(t<0&&this.zoomCounter>0){s=-0.1}}if(s!==0){this.zoomCounter+=s;var r=this.canvas.startScale+this.zoomCounter;if(q){c.fixEventPageXY(q);this.cursor={x:Math.max(0,Math.min((q.pageX-this.canvas.pos.absoluteLeft),this.canvas.pos.absoluteWidth)),y:Math.max(0,Math.min((q.pageY-this.canvas.pos.absoluteTop),this.canvas.pos.absoluteHeight))}}this.zoomProcess(r)}},zoomProcess:function(q){this.zoomCanvas(q);if(this.canvas.scale>this.canvas.maxVisibleScale){this.canvasMap.show();this.canvasMap.zoom(this.canvas.visiblePart)}else{this.canvasMap.zoom(this.canvas.visiblePart);this.canvasMap.hide(true)}},zoomCanvas:function(s,t){if(t===true||s<=this.canvas.startScale){this.canvas.visiblePart={left:0,"~left":0,top:0,"~top":0,"~width":this.canvas.width,width:this.canvas.width,"~height":this.canvas.height,height:this.canvas.height,leftGap:this.canvas.pos.left,topGap:this.canvas.pos.top,rightGap:this.canvas.pos.absoluteWidth-this.canvas.pos.startedWidth-this.canvas.pos.left,bottomGap:this.canvas.pos.absoluteHeight-this.canvas.pos.startedHeight-this.canvas.pos.top};this.canvas.pos["~shiftX"]=0;this.canvas.pos["~shiftY"]=0;this.canvas.pos.shiftX=0;this.canvas.pos.shiftY=0;this.canvas.scale=this.canvas.startScale}else{var A=this.cursor.x,w=this.cursor.y,r=(((-1)*(this.canvas.pos["~shiftX"]||0)+A)/this.canvas.scale),z=(((-1)*(this.canvas.pos["~shiftY"]||0)+w)/this.canvas.scale),B=r*s,u=z*s,v=Math.max(B-A,0),q=Math.max(u-w,0);this.formVisiblePart(s,v,q);v*=(-1);q*=(-1);this.canvas.pos["~shiftX"]=v;this.canvas.pos["~shiftY"]=q;this.canvas.pos.shiftX=Math.ceil(v);this.canvas.pos.shiftY=Math.ceil(q);this.canvas.scale=s}this.canvasBlock.style.transform="translate3d("+this.canvas.pos.shiftX+"px, "+this.canvas.pos.shiftY+"px, 0) scale("+this.canvas.scale+", "+this.canvas.scale+")";c.onCustomEvent(this,"onCanvasPositionHasChanged",[])},formVisiblePart:function(x,z,r){var t=(z-this.canvas.pos.left),s=(r-this.canvas.pos.top);this.canvas.visiblePart["~left"]=(t>0?t:0)/x;this.canvas.visiblePart.left=Math.ceil(this.canvas.visiblePart["~left"]);this.canvas.visiblePart["~top"]=(s>0?s:0)/x;this.canvas.visiblePart.top=Math.ceil(this.canvas.visiblePart["~top"]);var v=this.canvas.width*x,u=(-1)*t,y=this.canvas.pos.absoluteWidth-(v+u);if(this.canvas.pos.absoluteWidth>v){if(u<0){v+=u}else{if(y<0){v+=y}}}else{v=this.canvas.pos.absoluteWidth;if(u>0){v-=u}else{if(y>0){v-=y}}}this.canvas.visiblePart.leftGap=u;this.canvas.visiblePart.rightGap=y;this.canvas.visiblePart["~etalonWidth"]=(this.canvas.pos.absoluteWidth/x);this.canvas.visiblePart["~width"]=(v/x);this.canvas.visiblePart.width=Math.ceil(this.canvas.visiblePart["~width"]);var q=this.canvas.height*x,w=(-1)*s,A=this.canvas.pos.absoluteHeight-(q+w);if(this.canvas.pos.absoluteHeight>q){if(w<0){q+=w}else{if(A<0){q+=A}}}else{q=this.canvas.pos.absoluteHeight;if(w>0){q-=w}else{if(A>0){q-=A}}}this.canvas.visiblePart.topGap=w;this.canvas.visiblePart.bottomGap=A;this.canvas.visiblePart["~etalonHeight"]=(this.canvas.pos.absoluteHeight/x);this.canvas.visiblePart["~height"]=(q/x);this.canvas.visiblePart.height=Math.ceil(this.canvas.visiblePart["~height"])},move:function(u){var r=Math.round(this.canvas.width*this.canvas.scale),q=Math.round(this.canvas.height*this.canvas.scale),t=(-1)*Math.ceil(u.left*this.canvas.scale),s=(-1)*Math.ceil(u.top*this.canvas.scale);if(u.right===true||(r+t)<this.canvas.pos.absoluteWidth){t=this.canvas.pos.absoluteWidth-r}if(u.bottom===true||(q+s)<this.canvas.pos.absoluteHeight){s=this.canvas.pos.absoluteHeight-q}t-=this.canvas.pos.left;s-=this.canvas.pos.top;this.formVisiblePart(this.canvas.scale,(-1)*t,(-1)*s);this.canvas.pos["~shiftX"]=t;this.canvas.pos["~shiftY"]=s;this.canvas.pos.shiftX=t;this.canvas.pos.shiftY=s;this.canvasBlock.style.transform="translate3d("+this.canvas.pos.shiftX+"px, "+this.canvas.pos.shiftY+"px, 0) scale("+this.canvas.scale+", "+this.canvas.scale+")";c.onCustomEvent(this,"onCanvasPositionHasChanged",[])},canvasesID:"canvasForEdit",copyCanvas:null,workCanvas:null,getCopyCanvas:function(){if(this.copyCanvas===null){this.copyCanvas=c.create("CANVAS",{attrs:{id:this.id+"Copy"},style:{display:"none"}})}c.adjust(this.copyCanvas,{props:{width:this.canvas.width,height:this.canvas.height}});this.copyCanvas.getContext("2d").drawImage(this.canvas,0,0);return this.copyCanvas},getCanvas:function(){return this.canvas},getWorkCanvas:function(q){if(this.workCanvas===null){this.workCanvas=c.create("CANVAS",{attrs:{id:this.id+"Work"},style:{display:"none"}})}c.adjust(this.workCanvas,{props:{width:this.canvas.width,height:this.canvas.height}});if(q){this.workCanvas.getContext("2d").drawImage(this.canvas,0,0)}return this.workCanvas},rotate:function(t){if(this.busy===true){return}var q=Math.PI/2*(t?1:-1),x=this.getCopyCanvas(),u=this.getWorkCanvas(false),s=this.canvas.height,v=this.canvas.width;c.adjust(u,{props:{width:s,height:v}});var r=u.getContext("2d");r.save();if(t){r.translate(x.height,0)}else{r.translate(0,x.width)}r.rotate(q);r.drawImage(x,0,0);r.restore();this.set(u,{props:{width:s,height:v}});this.stack.add(x);this.changed=true},poster:function(r){if(this.busy===true){return}if(!!this.posterPopup){this.posterPopup.close()}var q=c.pos(r);this.posterPopup=new c.PopupWindow("bx-poster-popup-"+r.id,r,{lightShadow:true,offsetTop:-3,className:"bxu-poster-popup",offsetLeft:Math.ceil(q.width/2),autoHide:true,closeByEsc:true,zIndex:c.PopupWindow.getOption("popupOverlayZindex")+e(2),bindOptions:{position:"top"},overlay:false,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:c.proxy(function(){this.posterPopup=null},this)},buttons:[new c.PopupWindowButton({text:c.message("CANVAS_OK"),events:{click:c.delegate(function(){var s=c("posterPopupText"+r.id);if(!!s&&s.value.length>0){this.posterApply(s.value)}this.posterPopup.close()},this)}}),new c.PopupWindowButtonLink({text:c.message("CANVAS_CANCEL"),events:{click:c.delegate(function(){this.posterPopup.close()},this)}})],content:['<div class="bxu-poster-popup-dt">',c.message("CANVAS_POSTER_SIGN"),'</div> 				<input type="text" id="posterPopupText',r.id,'" maxlength="255" value="" />'].join("")});this.posterPopup.show();this.posterPopup.setAngle({position:"bottom"});this.posterPopup.bindOptions.forceBindPosition=true;this.posterPopup.adjustPosition();c.focus(c("posterPopupText"+r.id));this.posterPopup.bindOptions.forceBindPosition=false},posterApply:function(u){if(u){this.stack.add(this.getCopyCanvas());var r=this.getWorkCanvas(true),q=r.getContext("2d"),t=Math.min(r.width,r.height)/10;q.fillStyle="black";q.fillRect(0,0,r.width,t);q.fillRect(0,r.height-2*t,r.width,2*t);q.fillRect(0,0,t,r.height);q.fillRect(r.width-t,0,t,r.height);q.strokeStyle="white";var s=5;q.strokeRect(t-s,t-s,r.width-(t*2)+2*s,r.height-(t*3)+2*s);q.fillStyle="white";q.textAlign="center";q.textBaseline="middle";q.font=t+"px marketing";q.fillText(u,r.width/2,r.height-t,r.width);this.set(r,false);this.changed=true}},blackAndWhite:function(){if(this.busy===true){return}this.stack.add(this.getCopyCanvas());var s=this.getWorkCanvas(true),q=s.getContext("2d"),u=q.getImageData(0,0,s.width,s.height),r,t;for(t=0;t<u.data.length;t+=4){r=(u.data[t]+u.data[t+1]+u.data[t+2])/3;u.data[t]=r;u.data[t+1]=r;u.data[t+2]=r}q.putImageData(u,0,0);this.set(s,false);this.changed=true},flip:function(s){if(this.busy===true){return}this.stack.add(this.getCopyCanvas());var r=this.getWorkCanvas(true),q=r.getContext("2d");q.save();if(s){q.scale(1,-1);q.translate(0,-r.height)}else{q.scale(-1,1);q.translate(-r.width,0)}q.drawImage(r,0,0);q.restore();this.set(r,false);this.changed=true},cropObj:null,cropStatus:false,cropInit:function(q){if(this.cropObj===null){this.cropObj=new f(this.id,this.canvas,c(this.id+"Crop"));this.cropObj.cropParams.topShift=parseInt(this.canvasBlock.style.top?this.canvasBlock.style.top.replace(/[a-z]+$/,""):0);this.cropObj.cropParams.leftShift=parseInt(this.canvasBlock.style.left?this.canvasBlock.style.left.replace(/[a-z]+$/,""):0);c.addCustomEvent(this,"onCropHasToBeHidden",c.delegate(this.cropObj.finish,this.cropObj));c.addCustomEvent(this.cropObj,"onCropApply",c.delegate(this.cropApply,this));c.addCustomEvent(this.cropObj,"onCropTooBig",c.delegate(this.onCropTooBig,this));c.addCustomEvent(this.cropObj,"onCropStart",c.delegate(function(){c.addClass(q,"bxu-edit-btn-active");this.cropStatus=true;this.busy=true;this.canvasMap.occupy();c.onCustomEvent(this,"onCropStart",[this.cropObj,this.cropObj.cropParams])},this));c.addCustomEvent(this.cropObj,"onCropFinish",c.delegate(function(){c.removeClass(q,"bxu-edit-btn-active");this.busy=false;this.cropStatus=false;this.canvasMap.release();c.onCustomEvent(this,"onCropFinish",[this.cropObj,this.cropObj.cropParams])},this));c.addCustomEvent(this,"onCanvasPositionHasChanged",c.delegate(this.cropObj.scale,this.cropObj))}return true},crop:function(q){if(this.cropInit(q)){this.cropObj.turn()}},onCropTooBigPopup:null,onCropTooBig:function(r,q){if(this.onCropTooBigPopup===null){this.onCropTooBigPopupApply=c.delegate(function(){var s=c.UploaderUtils.scaleImage(this.canvas,this.onCropTooBigPopup.presetParams,"circumscribed");if(s.bNeedCreatePicture){this.scaleZoom=false;this.scaleWidth(s.destin.width,true,c(this.id+"scaleIndicator"));this.scaleZoom=true}this.cropInsert(this.onCropTooBigPopup.presetParams);this.onCropTooBigPopup.close()},this);this.onCropTooBigPopupCancel=c.delegate(function(){this.onCropTooBigPopup.close()},this);this.onCropTooBigPopup=new c.PopupWindow("popupCropTooBigPopup"+this.id,null,{lightShadow:true,autoHide:true,closeByEsc:true,zIndex:e(2),overlay:{},buttons:[new c.PopupWindowButton({text:c.message("JS_CORE_FI_SCALE"),className:"popup-window-button-accept",events:{click:this.onCropTooBigPopupApply}}),new c.PopupWindowButtonLink({text:c.message("JS_CORE_FI_CANCEL"),className:"popup-window-button-link-cancel",events:{click:this.onCropTooBigPopupCancel}})],content:'<div class="adm-photoeditor-buttons-panel-cropping-too-big">'+c.message("JS_CORE_FI_PRESET_IS_TOO_BIG")+"</div>"})}this.onCropTooBigPopup.presetParams={width:r,height:q};this.onCropTooBigPopup.show()},cropApply:function(r){this.stack.add(this.getCopyCanvas());var q=this.getWorkCanvas(false);c.adjust(q,{props:{width:r.width,height:r.height}});q.getContext("2d").drawImage(this.canvas,(-1)*r.left,(-1)*r.top);this.set(q,{props:{width:r.width,height:r.height}});this.changed=true},cropInsert:function(r,q){if(r&&this.cropInit(q)){this.cropObj.insert(r.width,r.height)}},scaleObj:null,scaleInit:function(q){if(this.scaleObj===null){this.scaleObj=new k(this.id,q,this.canvas);c.addCustomEvent(this.scaleObj,"onScaleApply",c.proxy(this.scaleApply,this));c.addCustomEvent(this.scaleObj,"onScaleRestore",c.proxy(this.scaleRestore,this));c.addCustomEvent(this.scaleObj,"onScaleSuggest",c.proxy(this.scaleSuggest,this));c.addCustomEvent(this,"onSetCanvas",c.proxy(function(){this.scaleObj.restore()},this))}return true},scale:function(q){if(this.scaleInit(c.proxy_context)){this.scaleObj.start(q,this.canvas)}},scaleWidth:function(q,s,r){if(this.scaleInit(r)){this.scaleObj.scaleWidth(q,this.canvas,s)}},scaleHeight:function(q,s,r){if(this.scaleInit(r)){this.scaleObj.scaleHeight(q,this.canvas,s)}},scaleApply:function(v){this.stack.add(this.getCopyCanvas());c.show(this.scaleObj.getPreventer());var r=this.getWorkCanvas(false),q={maxVisibleScale:this.canvas.maxVisibleScale,scale:this.canvas.scale,width:this.canvas.width,height:this.canvas.height,"~shiftX":this.canvas.pos["~shiftX"],"~shiftY":this.canvas.pos["~shiftY"]};c.adjust(r,{props:{width:v.width,height:v.height}});r.getContext("2d").drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,v.width,v.height);this.set(r,{props:{width:v.width,height:v.height}});this.cursor.x=0;this.cursor.y=0;if(this.scaleZoom!==false){var s=(v.width-q.width)*q.scale,u=(v.height-q.height)*q.scale,w=Math.max(((-1)*q["~shiftX"]+(s/2)),0),t=Math.max(((-1)*q["~shiftY"]+(u/2)),0);this.canvas.pos["~shiftX"]=(-1)*w/q.scale*this.canvas.scale;this.canvas.pos["~shiftY"]=(-1)*t/q.scale*this.canvas.scale;c.addClass(this.canvasBlock,"adm-photoeditor-active-image-ascetic");this.zoomProcess(q.scale);c.removeClass(this.canvasBlock,"adm-photoeditor-active-image-ascetic")}if(this.cropObj){this.cropObj.scale()}c.hide(this.scaleObj.getPreventer());this.changed=true},scaleRestore:function(){c.onCustomEvent(this,"onScaleCanvas",arguments)},scaleSuggest:function(){c.onCustomEvent(this,"onScaleCanvas",arguments)}};var k=function(t,r,q){this.id=t;this.pointer=r;var s=c.pos(this.pointer.parentNode);this.divisionValue=s.height/200;this.process=c.delegate(this.process,this);this.finish=c.delegate(this.finish,this);if(q){this.init(q)}};k.prototype={canvas:null,divisionValue:0,value:0,minValue:0,maxValue:100,cursor:{start:0,end:0},preventer:null,params:{scaleX:1,scaleY:1,"~scaleX":1,"~scaleY":1},init:function(q){this.canvas=q;this.value=0;this.minValue=(Math.max(1/q.width,1/q.height)-1)*100;this.params.width=this.canvas.width;this.params.height=this.canvas.height;this.params["~scaleX"]=1;this.params["~scaleY"]=1;return this.block},getPreventer:function(){var q=null;if(this.preventer===null){q=c.create("DIV",{attrs:{className:"adm-photoeditor-scale-area"}});if(c(this.canvas)){this.canvas.parentNode.parentNode.insertBefore(q,this.canvas.parentNode);this.preventer=q}}return this.preventer},start:function(r,q){this.init(q);c.fixEventPageY(r);this.cursor.start=r.pageY;c.bind(document,"mousemove",this.process);c.bind(document,"mouseup",this.finish);return c.PreventDefault(r)},process:function(q){c.fixEventPageY(q);this.cursor.end=q.pageY;this.value=(this.cursor.start-this.cursor.end)/this.divisionValue;if(this.value>this.maxValue){this.value=this.maxValue}else{if(this.value<this.minValue){this.value=this.minValue}}this.setVis();return c.PreventDefault(q)},finish:function(q){c.unbind(document,"mousemove",this.process);c.unbind(document,"mouseup",this.finish);if(parseInt(this.value)!==0){this.change()}else{this.restore()}return c.PreventDefault(q)},setVis:function(){this.pointer.style.top=(50+parseInt((-1)*this.value*0.5))+"%";this.pointer.innerHTML=Math.ceil(this.value)+"%";this.params.scaleX=(1+this.value/100)*this.params["~scaleX"];this.params.scaleY=(1+this.value/100)*this.params["~scaleY"];this.params.width=Math.ceil(this.canvas.width*this.params.scaleX);this.params.height=Math.ceil(this.canvas.height*this.params.scaleY);this.canvas.style.transform="scale("+this.params.scaleX+", "+this.params.scaleY+")";c.onCustomEvent(this,"onScaleSuggest",[this.params,this.value])},scaleWidth:function(r,q,t){r=Math.ceil(r);if(r<=0){return}this.init(q);var s=this.params["~scaleX"];this.params["~scaleX"]=r/this.params.width;s=this.params["~scaleX"]-s;if(t){this.params["~scaleY"]+=s}this.setVis();this.change()},scaleHeight:function(q,r,t){q=Math.ceil(q);if(q<=0){return}this.init(r);var s=this.params["~scaleX"];this.params["~scaleY"]=q/this.params.height;s=this.params["~scaleY"]-s;if(t){this.params["~scaleX"]+=s}this.setVis();this.change()},change:function(){c.onCustomEvent(this,"onScaleApply",[this.params,this.value])},restore:function(){this.value=0;this.params["~scaleX"]=1;this.params["~scaleY"]=1;this.setVis();this.canvas.style.transform="";c.onCustomEvent(this,"onScaleRestore",[this.canvas])}};var f=function(s,r,q){this.id=s;this.canvas=r;this.block=q};f.prototype={active:false,canvas:null,root:null,preventer:null,projection:null,pointer:null,block:null,turn:function(){if(this.init()){if(this.active===false){this.start()}else{this.finish()}}},cursor:{pageX:0,pageY:0},cropParams:{width:0,height:0,top:0,left:0,topShift:0,leftShift:0,defaultWidth:0,defaultHeight:0},init:function(){if(this.preventer===null){this.root=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-area-root"},style:{position:"absolute",zIndex:c.PopupWindow.getOption("popupOverlayZindex")+e(10),boxSizing:"border-box","-webkit-user-select":"none"}});document.body.appendChild(this.root);this.preventer=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-area"}});this.apply=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-apply"},style:{zIndex:3},events:{click:c.delegate(this.cropApply,this)}});this.cancel=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-cancel"},style:{zIndex:3},events:{click:c.delegate(this.cropCancel,this)}});this.proportion=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-proportion"},style:{zIndex:3},events:{click:c.delegate(this.cropProportionActivate,this)}});this.width=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-width"}});this.height=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-height"}});this.stretchStart=c.delegate(this.stretchStart,this);this.stretch=c.delegate(this.stretch,this);this.stretchEnd=c.delegate(this.stretchEnd,this);this.leftBottom=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-left-bottom"},events:{mousedown:this.stretchStart}});this.left=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-left"},events:{mousedown:this.stretchStart}});this.leftTop=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-left-top"},events:{mousedown:this.stretchStart}});this.top=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-top"},events:{mousedown:this.stretchStart}});this.rightTop=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-right-top"},events:{mousedown:this.stretchStart}});this.right=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-right"},events:{mousedown:this.stretchStart}});this.rightBottom=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-right-bottom"},events:{mousedown:this.stretchStart}});this.bottom=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-bottom"},events:{mousedown:this.stretchStart}});this.pointer=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-pointer"},style:{position:"absolute",top:0,left:0,bottom:0,right:0,boxSizing:"border-box",zIndex:3,cursor:"pointer"},children:[this.apply,this.cancel,this.proportion,c.create("DIV",{attrs:{className:"adm-photoeditor-crop-measures"},children:[this.width,this.height]}),this.leftBottom,this.left,this.leftTop,this.top,this.rightTop,this.right,this.rightBottom,this.bottom]});this.overlayTop=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-overlay-top"}});this.overlayRight=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-overlay-right"}});this.overlayBottom=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-overlay-bottom"}});this.overlayLeft=c.create("DIV",{attrs:{className:"adm-photoeditor-crop-overlay-left"}});this.projection=c.create("DIV",{attrs:{id:"projection"},style:{position:"absolute",top:0,left:0,bottom:0,right:0,zIndex:1001,display:"none",boxSizing:"border-box"},children:[this.overlayTop,this.overlayRight,this.overlayBottom,this.overlayLeft,this.pointer]});this.projection.appendChild(this.pointer);this.root.appendChild(this.projection);this.root.appendChild(this.preventer);this.drawStart=c.delegate(this.drawStart,this);this.draw=c.delegate(this.draw,this);this.drawEnd=c.delegate(this.drawEnd,this);this.stop=c.delegate(this.stop,this);this.moveStart=c.delegate(this.moveStart,this);this.move=c.delegate(this.move,this);this.moveEnd=c.delegate(this.moveEnd,this);c.bind(this.pointer,"mousedown",this.moveStart)}return this.block},scale:function(){if(this.canvas.width<this.cropParams.width||this.canvas.height<this.cropParams.height){this.finish()}else{if(this.active===true){var s=0,q=0,r=0,t=0;if(this.projection){s=Math.ceil(parseInt(this.projection.style.left?this.projection.style.left.replace("px",""):0));r=Math.ceil(parseInt(this.projection.style.top?this.projection.style.top.replace("px",""):0))}this.showProjection();if(this.projection){q=Math.ceil((this.projection.style.left?parseInt(this.projection.style.left.replace("px","")):0));t=Math.ceil((this.projection.style.top?parseInt(this.projection.style.top.replace("px","")):0));if(s!=q){this.pointer.left=Math.max(0,(this.pointer.left+s-q))}if(t!=r){this.pointer.top=Math.max(0,(this.pointer.top+r-t))}}this.cropParams.left=Math.ceil(this.pointer.left/this.canvas.scale+this.canvas.visiblePart.left);this.cropParams.top=Math.ceil(this.pointer.top/this.canvas.scale+this.canvas.visiblePart.top);if(this.canvas.scale<1){this.cropParams.width=Math.ceil(this.pointer.width/this.canvas.scale);this.cropParams.height=Math.ceil(this.pointer.height/this.canvas.scale)}else{this.pointer.width=Math.ceil(this.cropParams.width*this.canvas.scale);this.pointer.height=Math.ceil(this.cropParams.height*this.canvas.scale)}this.setLeft(this.pointer.left,this.cropParams.left);this.setTop(this.pointer.top,this.cropParams.top);this.setWidth(this.pointer.width,this.cropParams.width);this.setHeight(this.pointer.height,this.cropParams.height)}}},drawStart:function(s){var r=0,q=0;if(s){c.fixEventPageXY(s);r=s.pageX-this.projection.pos.left;q=s.pageY-this.projection.pos.top;if(r>this.projection.pos.width||q>this.projection.pos.height){return this.finish()}this.cursor={pageX:s.pageX,pageY:s.pageY};c.PreventDefault(s)}r=(r>0?r:0);q=(q>0?q:0);this.cropParams.left=Math.ceil(r/this.canvas.scale+this.canvas.visiblePart.left);this.cropParams.top=Math.ceil(q/this.canvas.scale+this.canvas.visiblePart.top);this.cropParams.maxWidth=this.canvas.width-this.cropParams.left;this.cropParams.maxHeight=this.canvas.height-this.cropParams.top;this.cropParams.savePropotions=(this.proportion.active===true);this.setLeft(r,this.cropParams.left);this.setWidth(0,0);this.setTop(q,this.cropParams.top);this.setHeight(0,0);this.showPointer();c.bind(document,"mousemove",this.draw);return false},draw:function(s){var r=0,q=0;if(s){c.fixEventPageXY(s);r=s.pageX-this.cursor.pageX;q=s.pageY-this.cursor.pageY;c.PreventDefault(s)}this.cropParams.width=Math.ceil(r/this.canvas.scale);if(r<=0){r=0;this.cropParams.width=0}else{if(r>=(this.projection.pos.width-this.pointer.left)){r=(this.projection.pos.width-this.pointer.left);this.cropParams.width=this.cropParams.maxWidth}}this.setWidth(r,this.cropParams.width);this.cropParams.height=Math.ceil(q/this.canvas.scale);if(q<=0){q=0;this.cropParams.height=0}else{if(q>=(this.projection.pos.height-this.pointer.top)){q=(this.projection.pos.height-this.pointer.top);this.cropParams.height=this.cropParams.maxHeight}}this.setHeight(q,this.cropParams.height);return false},drawEnd:function(q){if(q){c.PreventDefault(q)}this.stop();return false},insert:function(r,q){if(!this.init()){c.DoNothing()}else{if(this.canvas.width<r||this.canvas.height<q){c.onCustomEvent(this,"onCropTooBig",[r,q])}else{this.start();this.cropProportionActivate(true);c.onCustomEvent(this,"onCropStart",[]);this.drawStart();this.cropParams.width=r;r=Math.ceil(r*this.canvas.scale);if(r<=0){r=0;this.cropParams.width=0}else{if(r>=(this.projection.pos.width-this.pointer.left)){r=(this.projection.pos.width-this.pointer.left);this.cropParams.width=this.cropParams.maxWidth}}this.setWidth(r,this.cropParams.width);this.cropParams.height=q;q=Math.ceil(q*this.canvas.scale);if(q<=0){q=0;this.cropParams.height=0}else{if(q>=(this.projection.pos.height-this.pointer.top)){q=(this.projection.pos.height-this.pointer.top);this.cropParams.height=this.cropParams.maxHeight}}this.setHeight(q,this.cropParams.height);this.drawEnd()}}},moveStart:function(q){this.cursor=null;if(q.target==this.pointer){c.fixEventPageXY(q);this.showPreventer();this.cursor={pageX:q.pageX,pageY:q.pageY,x:q.pageX-this.projection.pos.left-this.pointer.left,y:q.pageY-this.projection.pos.top-this.pointer.top};c.bind(document,"mousemove",this.move);c.bind(document,"mouseup",this.moveEnd)}},move:function(u){if(this.cursor!=null){c.fixEventPageXY(u);var r=u.pageX-this.cursor.pageX,q=u.pageY-this.cursor.pageY,t=this.pointer.left+r,s=this.pointer.top+q;this.cursor.pageX=u.pageX;this.cursor.pageY=u.pageY;if((t+this.pointer.width)>=this.projection.pos.width&&(this.canvas.visiblePart.left+this.canvas.visiblePart.width)>=this.canvas.width){t=(this.projection.pos.width-this.pointer.width);this.cropParams.left=this.canvas.width-this.cropParams.width}else{if(t<=0){t=0}else{if((t+this.pointer.width)>=this.projection.pos.width){t=(this.projection.pos.width-this.pointer.width)}}this.cropParams.left=Math.ceil(t/this.canvas.scale+this.canvas.visiblePart.left)}if((s+this.pointer.height)>=this.projection.pos.height&&(this.canvas.visiblePart.top+this.canvas.visiblePart.height)>=this.canvas.height){s=(this.projection.pos.height-this.pointer.height);this.cropParams.top=this.canvas.height-this.cropParams.height}else{if(s<=0){s=0}else{if((s+this.pointer.height)>=this.projection.pos.height){s=(this.projection.pos.height-this.pointer.height)}}this.cropParams.top=Math.ceil(s/this.canvas.scale+this.canvas.visiblePart.top)}this.setLeft(t,this.cropParams.left);this.setTop(s,this.cropParams.top)}},moveEnd:function(){this.hidePreventer();c.unbind(document,"mousemove",this.move);c.unbind(document,"mouseup",this.moveEnd)},showPointer:function(){this.block.style.display="block";this.pointer.style.display="block";this.overlayTop.style.display="block";this.overlayRight.style.display="block";this.overlayBottom.style.display="block";this.overlayLeft.style.display="block"},hidePointer:function(){this.block.style.top=0;this.block.style.bottom=0;this.block.style.width=0;this.block.style.height=0;this.block.style.display="none";this.pointer.style.display="none";this.overlayTop.style.display="none";this.overlayRight.style.display="none";this.overlayBottom.style.display="none";this.overlayLeft.style.display="none"},showProjection:function(){var r=c.pos(this.block.parentNode.parentNode,false);c.adjust(this.root,{style:{left:r.left+"px",top:r.top+"px",width:r.width+"px",height:r.height+"px",display:"block"}});var q={left:0,top:0,right:0,bottom:0,display:"block"};if(this.canvas.visiblePart.topGap>0){q.top=Math.ceil(this.canvas.visiblePart.topGap)+"px"}if(this.canvas.visiblePart.leftGap>0){q.left=Math.ceil(this.canvas.visiblePart.leftGap)+"px"}if(this.canvas.visiblePart.bottomGap>0){q.bottom=Math.ceil(this.canvas.visiblePart.bottomGap)+"px"}if(this.canvas.visiblePart.rightGap>0){q.right=Math.ceil(this.canvas.visiblePart.rightGap)+"px"}c.adjust(this.projection,{style:q});this.projection.pos=c.pos(this.projection)},hideProjection:function(){c.hide(this.root);c.hide(this.projection);c.hide(this.preventer)},showPreventer:function(){c.show(this.preventer)},hidePreventer:function(){c.hide(this.preventer)},start:function(){this.active=true;c.bind(document,"mousedown",this.drawStart);c.bind(document,"mouseup",this.drawEnd);this.hidePointer();this.showProjection();this.showPreventer();c.onCustomEvent(this,"onCropStart",[])},stop:function(){this.hidePreventer();c.unbind(document,"mousedown",this.drawStart);c.unbind(document,"mousemove",this.draw);c.unbind(document,"mouseup",this.drawEnd);c.onCustomEvent(this,"onCropStop",[])},finish:function(){this.active=false;this.stop();this.hidePointer();this.hideProjection();c.onCustomEvent(this,"onCropFinish",[this.cropParams])},cropApply:function(){this.finish();if(this.cropParams.width>0&&this.cropParams.height>0){c.onCustomEvent(this,"onCropApply",[this.cropParams])}},cropCancel:function(){c.onCustomEvent(this,"onCropCancel",[]);this.finish()},cropProportion:{active:false,"w/h":0,"h/w":0},cropProportionActivate:function(q){if(!(q===true||q===false)){q=this.cropProportion.active!==true}this.cropProportion.active=q;if(this.cropProportion.active){if(!c.hasClass(this.proportion,"active")){c.addClass(this.proportion,"active")}c.hide(this.left);c.hide(this.top);c.hide(this.right);c.hide(this.bottom)}else{c.removeClass(this.proportion,"active");c.show(this.left);c.show(this.top);c.show(this.right);c.show(this.bottom)}},cropProportionInit:function(){if(this.cropProportion.active!==true){this.cropProportion["w/h"]=0;this.cropProportion["h/w"]=0}else{if(this.pointer.width>0&&this.pointer.height>0){this.cropProportion["w/h"]=this.pointer.width/this.pointer.height;this.cropProportion["h/w"]=this.pointer.height/this.pointer.width}else{this.cropProportion["w/h"]=1;this.cropProportion["h/w"]=1}}},stretchPosition:null,stretchStart:function(q){c.PreventDefault(q);var r=c.proxy_context;this.stretchPosition=r.className.replace("adm-photoeditor-crop-","");this.cursor=null;if(this.stretchPosition=="left-bottom"||this.stretchPosition=="left"||this.stretchPosition=="left-top"||this.stretchPosition=="top"||this.stretchPosition=="right-top"||this.stretchPosition=="right"||this.stretchPosition=="right-bottom"||this.stretchPosition=="bottom"){c.fixEventPageXY(q);this.cropProportionInit();this.showPreventer();this.cursor={pageX:q.pageX,pageY:q.pageY,left:this.projection.pos.left+this.pointer.left,right:(this.projection.pos.left+this.pointer.left+this.pointer.width),top:this.projection.pos.top+this.pointer.top,bottom:this.projection.pos.top+this.pointer.top+this.pointer.height};c.bind(document,"mousemove",this.stretch);c.bind(document,"mouseup",this.stretchEnd)}return false},stretch:function(x){if(this.cursor!=null){c.fixEventPageXY(x);var s,w=null,t=null,v=null,q=null;this.cursor.pageX=x.pageX;this.cursor.pageY=x.pageY;if(this.stretchPosition.indexOf("left")>=0){s=(this.pointer.left+this.pointer.width);t=Math.max((this.cursor.right-x.pageX),0);t=Math.min(t,s);w=s-t}else{if(this.stretchPosition.indexOf("right")>=0){t=Math.max((x.pageX-this.cursor.left),0)}}if(t!==null){w=(w===null?this.pointer.left:w);if(t<=0){t=0}else{if(t>=(this.projection.pos.width-w)){t=(this.projection.pos.width-w)}}}if(this.stretchPosition.indexOf("top")>=0){s=this.pointer.top+this.pointer.height;q=Math.max((this.cursor.bottom-x.pageY),0);q=Math.min(q,s);v=s-q}else{if(this.stretchPosition.indexOf("bottom")>=0){q=Math.max((x.pageY-this.cursor.top),0)}}if(q!==null){v=(v===null?this.pointer.top:v);if(q<=0){q=0}else{if(q>=(this.projection.pos.height-v)){q=(this.projection.pos.height-v)}}}var u=false;if(this.cropProportion.active===true){if(t&&q){var r;if(this.cropProportion["h/w"]*t>q){r=t;t=this.cropProportion["w/h"]*q;if(this.stretchPosition.indexOf("left")>=0){w+=(r-t)}}else{r=q;q=this.cropProportion["h/w"]*t;if(this.stretchPosition.indexOf("top")>=0){v+=(r-q)}}if((this.cropProportion["h/w"]==1)){this.cropParams.left=Math.ceil(w/this.canvas.scale+this.canvas.visiblePart.left);this.cropParams.top=Math.ceil(v/this.canvas.scale+this.canvas.visiblePart.top);u=Math.min((this.canvas.width-this.cropParams.left),(this.canvas.height-this.cropParams.top))}}else{t=null;q=null}}if(t!==null){this.cropParams.left=Math.ceil(w/this.canvas.scale+this.canvas.visiblePart.left);this.cropParams.maxWidth=(u||(this.canvas.width-this.cropParams.left));this.cropParams.width=Math.ceil(t/this.canvas.scale);if(t<=0){this.cropParams.width=0}else{if(this.cropParams.width>=this.cropParams.maxWidth){this.cropParams.width=this.cropParams.maxWidth}}this.setLeft(w,this.cropParams.left);this.setWidth(t,this.cropParams.width)}if(q!==null){this.cropParams.top=Math.ceil(v/this.canvas.scale+this.canvas.visiblePart.top);this.cropParams.maxHeight=(u||(this.canvas.height-this.cropParams.top));this.cropParams.height=Math.ceil(q/this.canvas.scale);if(q<=0){this.cropParams.height=0}else{if(this.cropParams.height>=this.cropParams.maxHeight){this.cropParams.height=this.cropParams.maxHeight}}this.setTop(v,this.cropParams.top);this.setHeight(q,this.cropParams.height)}}},stretchEnd:function(){this.hidePreventer();c.unbind(document,"mousemove",this.stretch);c.unbind(document,"mouseup",this.stretchEnd)},setWidth:function(q,r){this.pointer.width=q;this.pointer.style.width=(q+"px");this.block.width=this.width.innerHTML=r;this.block.style.width=(r+"px");this.overlayTop.style.width=(this.pointer.left+this.pointer.width)+"px";this.overlayRight.style.left=(this.pointer.left+this.pointer.width)+"px"},setLeft:function(q,r){this.pointer.style.left=q+"px";this.pointer.left=q;this.block.style.left=r+"px";this.overlayTop.style.width=(this.pointer.left+this.pointer.width)+"px";this.overlayRight.style.left=(this.pointer.left+this.pointer.width)+"px";this.overlayBottom.style.left=this.pointer.left+"px";this.overlayLeft.style.width=this.pointer.left+"px"},setHeight:function(q,r){this.pointer.height=q;this.pointer.style.height=(q+"px");this.block.height=this.height.innerHTML=r;this.block.style.height=(r+"px");this.overlayRight.style.height=(this.pointer.top+q)+"px";this.overlayBottom.style.top=(this.pointer.top+q)+"px"},setTop:function(q,r){this.pointer.style.top=q+"px";this.pointer.top=q;this.block.style.top=r+"px";this.overlayTop.style.height=this.pointer.top+"px";this.overlayRight.style.height=(this.pointer.top+this.pointer.height)+"px";this.overlayBottom.style.top=(this.pointer.top+this.pointer.height)+"px";this.overlayLeft.style.top=this.pointer.top+"px"}};var l=function(r,q){this.block=r;this.id=this.block.id+"Map";if(c(this.id+"Root")){this.root=c(this.id+"Root")}else{this.root=c.create("DIV",{style:{display:"none",position:"absolute",zIndex:c.PopupWindow.getOption("popupOverlayZindex")+e(20)},attrs:{id:this.id+"Root",className:"adm-photoeditor-active-map-root"},html:['<div class="adm-photoeditor-active-map-block" id="',this.id,'Block"> 					<div class="adm-photoeditor-active-map"> 						<div class="adm-photoeditor-active-map-image"> 							<canvas id="',this.id,'Canvas"></canvas> 						</div> 						<div class="adm-photoeditor-active-map-area"></div> 						<div class="adm-photoeditor-active-map-pointer"></div> 					</div> 					<div class="adm-photoeditor-active-map-handle" id="',this.id,'Resizer"> 				</div> 				</div>'].join("").replace(/[\n\t]/gi,"").replace(/>\s</gi,"><")});document.body.appendChild(this.root)}this.moveStart=c.delegate(this.moveStart,this);this.move=c.delegate(this.move,this);this.moveEnd=c.delegate(this.moveEnd,this);this._bindNodes=c.delegate(this.bindNodes,this);c.defer_proxy(this._bindNodes)(q);c.bind(window,"resize",c.proxy(this.onResizeWindow,this));return this};l.prototype={bindNodesCounter:0,bindNodes:function(q){this.bindNodesCounter++;if(this.bindNodesCounter>100||!c(this.id+"Canvas")){if(this.bindNodesCounter<=100){c.defer_proxy(this._bindNodes)(q)}return}this.canvasMapBlock=c(this.id+"Block");this.canvasMapResizer=c(this.id+"Resizer");c.hide(this.canvasMapResizer);this.canvasMapCover=this.canvasMapBlock.firstChild;this.canvasMap=c(this.id+"Canvas");this.canvasMapPointer=this.canvasMapBlock.firstChild.childNodes[2];this.canvasMapPointer.params=q;c.addClass(this.canvasMapPointer,"adm-photoeditor-active-map-pointer-draggable");c.bind(this.canvasMapPointer,"mousedown",this.moveStart);c.bind(this.canvasMapResizer,"mousedown",this.stretchStart);c.onCustomEvent(this,"onMapIsInitialised",[this])},init:function(r,q){if(q){var s=c.UploaderUtils.scaleImage(q,this.canvasMapPointer.params);this.root.style.display="none";this.collapsedNode.style.display="none";c.adjust(this.canvasMap,{props:s.destin});this.canvasMap.pos=null;this.options.visible=false;c.adjust(this.canvasMapCover,{style:{width:s.destin.width+"px",height:s.destin.height+"px"}});c.adjust(this.canvasMapPointer,{props:{width:s.destin.width,height:s.destin.height},style:{width:s.destin.width+"px",height:s.destin.height+"px"}});this.canvasMap.canvasProp=s.coeff}this.canvasMap.canvasWidth=r.width;this.canvasMap.canvasHeight=r.height;this.canvasMap.getContext("2d").drawImage(r,0,0,r.width,r.height,0,0,this.canvasMap.width,this.canvasMap.height)},options:{collapsed:false,collapsing:null,visible:false,busy:false,mode:"slow"},animationV:null,animationC:null,show:function(){if(this.options.visible){return}else{if(this.animationV){this.animationV.stop()}}this.options.visible=true;var q=c.pos(this.block,false);this.root.pos={top:q.top,left:(q.right-this.canvasMap.width),width:this.canvasMap.width,height:this.canvasMap.height};this.root.style.top=this.root.pos.top+"px";this.root.style.left=this.root.pos.left+"px";this.root.style.overflow="hidden";this.root.style.width=this.root.pos.width+"px";this.root.style.height=this.root.pos.height+"px";this.root.style.display=(this.options.collapsed?"none":"block");this.collapsedNode.style.display="";this.canvasMapBlock.style.top="-"+(this.canvasMap.height+1)+"px";this.canvasMapBlock.style.left=0;this.canvasMapBlock.style.width=this.canvasMap.width+"px";this.canvasMapBlock.style.height=this.canvasMap.height+"px";this.canvasMapBlock.y=(this.canvasMapBlock.y||this.canvasMap.height);this.canvasMapBlock.x=(this.canvasMapBlock.x||this.canvasMap.width);this.animationV=new c.easing({duration:200,start:{y:this.canvasMapBlock.y,x:this.canvasMapBlock.x},finish:{y:0,x:0},step:c.delegate(function(r){this.canvasMapBlock.y=r.y;this.canvasMapBlock.style.top="-"+r.y+"px"},this),complete:c.delegate(function(){this.canvasMapBlock.y=false;this.canvasMapBlock.x=false;this.canvasMapBlock.style.top=0;this.canvasMapBlock.style.left=0;this.root.style.overflow="visible";this.animationV=null},this)});this.animationV.animate()},hide:function(r){var q=c.delegate(function(){this.root.style.display="none";this.collapsedNode.style.display="none";delete this.root.pos;this.canvasMapBlock.y=false;this.canvasMapBlock.x=false;this.animationV=null},this);if(r!==true){if(this.animationV){this.animationV.stop()}this.options.visible=false;q()}else{if(this.options.visible){if(this.animationV){this.animationV.stop()}this.options.visible=false;this.root.style.overflow="hidden";this.canvasMapBlock.y=(this.canvasMapBlock.y||0);this.canvasMapBlock.x=(this.canvasMapBlock.x||0);this.animationV=new c.easing({duration:200,start:{y:this.canvasMapBlock.y,x:this.canvasMapBlock.x},finish:{y:this.canvasMap.height,x:this.canvasMap.width},step:c.delegate(function(s){this.canvasMapBlock.y=s.y;this.canvasMapBlock.style.top="-"+s.y+"px";this.canvasMapBlock.x=s.x},this),complete:q});this.animationV.animate()}else{q()}}},zoom:function(v){var r=(v&&(v["~top"]>0||v["~left"]>0||v["~width"]<this.canvasMap.canvasWidth||v["~height"]<this.canvasMap.canvasHeight));if(r){var u=Math.ceil(v["~left"]*this.canvasMap.canvasProp),t=Math.ceil(v["~top"]*this.canvasMap.canvasProp),s=Math.min(Math.ceil(v["~width"]*this.canvasMap.canvasProp),(this.canvasMap.width-u)),q=Math.min(Math.ceil(v["~height"]*this.canvasMap.canvasProp),(this.canvasMap.height-t));c.adjust(this.canvasMapPointer,{props:{etalonWidth:Math.ceil(v["~etalonWidth"]*this.canvasMap.canvasProp),etalonHeight:Math.ceil(v["~etalonHeight"]*this.canvasMap.canvasProp),"bx-left":u,"bx-top":t,width:s,height:q},style:{width:s+"px",height:q+"px",transform:"translate3d("+u+"px, "+t+"px, 0)"}})}else{c.adjust(this.canvasMapPointer,{props:{etalonWidth:this.canvasMap.width,etalonHeight:this.canvasMap.height,"bx-left":0,"bx-top":0,width:this.canvasMap.width,height:this.canvasMap.height},style:{width:this.canvasMap.width+"px",height:this.canvasMap.height+"px",transform:"translate3d(0, 0, 0)"}})}},shiftX:0,shiftY:0,moveEventTimeout:0,moveEventParams:{top:0,left:0},moveCursor:null,wSize:null,moveStart:function(q){this.moveCursor=null;if(q.target==this.canvasMapPointer){if(this.canvasMap.pos===null){this.canvasMap.pos=c.pos(this.canvasMap)}this.wSize=c.GetWindowSize();this.moveCursor={deltaX:this.canvasMap.pos.left+(this.canvasMapPointer["bx-left"]||0),deltaY:this.canvasMap.pos.top+(this.canvasMapPointer["bx-top"]||0)};this.moveCursor.x=q.clientX+this.wSize.scrollLeft-this.moveCursor.deltaX;this.moveCursor.y=q.clientY+this.wSize.scrollTop-this.moveCursor.deltaY;c.bind(document,"mousemove",this.move);c.bind(document,"mouseup",this.moveEnd)}},move:function(w){if(this.moveCursor===null){return}var s=w.clientX+this.wSize.scrollLeft,r=w.clientY+this.wSize.scrollTop,v=parseInt(this.canvasMapPointer.etalonWidth),q=parseInt(this.canvasMapPointer.etalonHeight),u=false,t=false;s-=(this.canvasMap.pos.left+this.moveCursor.x);if(s<=0){s=0}else{if(s>(this.canvasMap.width-this.canvasMapPointer.width)){s=(this.canvasMap.width-this.canvasMapPointer.width);u=true}}r-=(this.canvasMap.pos.top+this.moveCursor.y);if(r<=0){r=0}else{if(r>(this.canvasMap.height-this.canvasMapPointer.height)){r=(this.canvasMap.height-this.canvasMapPointer.height);t=true}}if(s!=this.shiftX||r!=this.shiftY){this.shiftX=s;this.shiftY=r;if(v>this.canvasMapPointer.width&&(v+s)>this.canvasMap.width){v=this.canvasMap.width-s}if(q>this.canvasMapPointer.height&&(q+r)>this.canvasMap.height){q=this.canvasMap.height-r}c.adjust(this.canvasMapPointer,{props:{"bx-left":s,"bx-top":r,width:v,height:q},style:{width:v+"px",height:q+"px",transform:"translate3d("+s+"px, "+r+"px, 0)"}});clearTimeout(this.moveEventTimeout);this.moveEventParams={"%left":s/this.canvasMap.width,"%top":r/this.canvasMap.height,left:s/this.canvasMap.canvasProp,top:r/this.canvasMap.canvasProp,right:u,bottom:t,width:v/this.canvasMap.canvasProp,height:q/this.canvasMap.canvasProp};if(!this["moveEventFunction"]){this["moveEventFunction"]=c.delegate(function(){c.onCustomEvent(this,"onMapPointerIsMoved",[this.moveEventParams])},this)}this.moveEventTimeout=setTimeout(this.moveEventFunction,100)}},moveEnd:function(){c.unbind(document,"mousemove",this.move);c.unbind(document,"mouseup",this.moveEnd)},collapsedNode:null,registerCollapsedNode:function(q){if(c(q)){this.collapsedNode=c(q);c.bind(this.collapsedNode,"click",c.delegate(function(){if(this.options.collapsed===true){this.collapse(false)}else{this.collapse(true)}},this));c.bind(this.canvasMapBlock,"dblclick",c.delegate(this.collapse,this))}this.collapseEnd()},collapseEnd:function(){if(this.options.collapsed){this.root.style.display="none";if(this.collapsedNode){c.removeClass(this.collapsedNode,"disabled")}c.removeClass(this.root,"collapse");c.addClass(this.root,"collapse2")}else{this.root.style.display="block";if(this.collapsedNode){c.addClass(this.collapsedNode,"disabled")}c.addClass(this.root,"collapse");c.removeClass(this.root,"collapse2")}this.root.style.transform="translate(0, 0) scale(1, 1)";this.root.style.opacity="1";if(this.root["~top"]){this.root.style.top=this.root["~top"];delete this.root["~top"]}this.options.collapsing=null},collapse:function(s){s=(s===true||s===false?s:(!this.options.collapsed));if(this.options.collapsing!==null||this.options.collapsed==s){return}this.options.collapsing=true;this.options.collapsed=s;var u,t,q,r;if(s){if(!this.collapsedNode||!this.root.pos){this.collapseEnd()}else{u=c.pos(this.collapsedNode,false);t=this.root.pos;q=Math.ceil((u.left+u.width/2)-(t.left+t.width/2));r=(u.width*0.7)/t.width;this.root.style.transform="translate("+q+"px, 0) scale("+r+", "+r+")";this.root.style.opacity="0";this.root["~top"]=this.root.style.top;this.root.style.top=u.top+"px";setTimeout(c.proxy(this.collapseEnd,this),700)}}else{if(this.root.pos){this.collapseEnd()}}},stretchStart:function(){},occupy:function(){this.options.busy=true},release:function(){this.options.busy=false},onResizeWindow:function(){if(this.options.visible){var q=c.pos(this.block,false);this.root.pos.top=q.top;this.root.pos.left=q.left;this.root.style.top=q.top+"px";this.root.style.left=(q.right-this.canvasMap.width)+"px"}}};var j=new o(),e=function(r){var q=Math.max(c.WindowManager.GetZIndex(),c.PopupWindow.getOption("popupOverlayZindex"))-c.PopupWindow.getOption("popupOverlayZindex")+r;return q}})();