(function(b){if(b.BX.UploaderQueue){return false}var c=b.BX,a={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,stopped:6,changed:7,uploaded:8};c.UploaderQueue=function(g,e,d){this.dialogName="BX.UploaderQueue";e=(!!e?e:{});this.limits={phpPostMaxSize:e.phpPostMaxSize,phpUploadMaxFilesize:e.phpUploadMaxFilesize,uploadMaxFilesize:(e.uploadMaxFilesize>0?e.uploadMaxFilesize:0),uploadFileWidth:(e.uploadFileWidth>0?e.uploadFileWidth:0),uploadFileHeight:(e.uploadFileHeight>0?e.uploadFileHeight:0)};this.placeHolder=c(g.placeHolder);this.showImage=(g.showImage!==false);this.sortItems=(g.sortItems!==false);this.uploader=d;this.itForUpload=new c.UploaderUtils.Hash();this.items=new c.UploaderUtils.Hash();this.itUploaded=new c.UploaderUtils.Hash();this.itFailed=new c.UploaderUtils.Hash();this.thumb={tagName:"LI",className:"bx-bxu-thumb-thumb"};if(!!g.thumb){for(var f in g.thumb){if(g.thumb.hasOwnProperty(f)&&this.thumb.hasOwnProperty(f)){this.thumb[f]=g.thumb[f]}}}c.addCustomEvent(d,"onItemIsAdded",c.delegate(this.addItem,this));c.addCustomEvent(d,"onItemsAreAdded",c.delegate(this.finishQueue,this));c.addCustomEvent(d,"onFileIsDeleted",c.delegate(this.deleteItem,this));c.addCustomEvent(d,"onFileIsReinited",c.delegate(this.reinitItem,this));this.log("Initialized");return this};c.UploaderQueue.prototype={showError:function(d){this.log("Error! "+d)},log:function(d){c.UploaderUtils.log("queue",d)},addItem:function(h,f){var e;if(!this.showImage){e=false}else{if(c.type.isDomNode(h)){e=c.UploaderUtils.isImage(h.value,null,null)}else{e=c.UploaderUtils.isImage(h.name,h.type,h.size)}}c.onCustomEvent(this.uploader,"onFileIsBeforeCreated",[h,f,e,this.uploader]);var i={copies:this.uploader.fileCopies,fields:this.uploader.fileFields},j=(e?new c.UploaderImage(h,i,this.limits,this.uploader):new c.UploaderFile(h,i,this.limits,this.uploader)),d,g,l={status:a.ready};c.onCustomEvent(j,"onFileIsAfterCreated",[j,f,l,this.uploader]);c.onCustomEvent(this.uploader,"onFileIsAfterCreated",[j,f,l,this.uploader]);this.items.setItem(j.id,j);if(f||l.status!==a.ready){this.itUploaded.setItem(j.id,j)}else{this.itForUpload.setItem(j.id,j)}if(!!this.placeHolder){if(c(f)){j.thumbNode=g=c(f);g.setAttribute("bx-bxu-item-id",j.id)}else{d=j.makeThumb();g=c.create(this.thumb.tagName,{attrs:{id:j.id+"Item","bx-bxu-item-id":j.id,className:this.thumb.className}});if(c.type.isNotEmptyString(d)){if(this.thumb.tagName=="TR"){d=d.replace(/[\n\t]/gi,"").replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1");if(!!d.trim){d=d.trim()}var m=function(r,o,p){var s=g.insertCell(-1),n={colspan:true,headers:true,accesskey:true,"class":true,contenteditable:true,contextmenu:true,dir:true,hidden:true,id:true,lang:true,spellcheck:true,style:true,tabindex:true,title:true,translate:true},q;s.innerHTML=p;o=o.split(" ");while((q=o.pop())&&q){q=q.split("=");if(q.length==2){q[0]=q[0].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");q[1]=q[1].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");if(n[q[0]]===true){s.setAttribute(q[0],q[1])}else{s[q[0]]=q[1]}}}return""},k=/^<td(.*?)>(.*?)<\/td>/i;b.data1=d;while(k.test(d)){d=d.replace(k,m)}}else{g.innerHTML=d}}else{if(c.type.isDomNode(d)){c.adjust(g,{children:[d]})}}}if(!!b.jsDD&&this.sortItems){if(!this._onbxdragstart){this._onbxdragstart=c.delegate(this.onbxdragstart,this);this._onbxdragstop=c.delegate(this.onbxdragstop,this);this._onbxdrag=c.delegate(this.onbxdrag,this);this._onbxdraghout=c.delegate(this.onbxdraghout,this);this._onbxdestdraghover=c.delegate(this.onbxdestdraghover,this);this._onbxdestdraghout=c.delegate(this.onbxdestdraghout,this);this._onbxdestdragfinish=c.delegate(this.onbxdestdragfinish,this)}c.addClass(g,"bx-drag-draggable");g.onbxdragstart=this._onbxdragstart;g.onbxdragstop=this._onbxdragstop;g.onbxdrag=this._onbxdrag;g.onbxdraghout=this._onbxdraghout;b.jsDD.registerObject(g);g.onbxdestdraghover=this._onbxdestdraghover;g.onbxdestdraghout=this._onbxdestdraghout;g.onbxdestdragfinish=this._onbxdestdragfinish;b.jsDD.registerDest(g)}g.setAttribute("bx-item-id",j.id);if(c(f)){c.onCustomEvent(this.uploader,"onFileIsBound",[j.id,j,this.caller,f]);c.onCustomEvent(j,"onFileIsBound",[j.id,j,this.caller,f])}else{if(!!f){this.placeHolder.appendChild(g);c.onCustomEvent(this.uploader,"onFileIsAttached",[j.id,j,this.caller,f]);c.onCustomEvent(j,"onFileIsAttached",[j.id,j,this.caller,f])}else{this.placeHolder.appendChild(g);c.onCustomEvent(this.uploader,"onFileIsAppended",[j.id,j,this.caller]);c.onCustomEvent(j,"onFileIsAppended",[j.id,j,this.caller])}}}c.onCustomEvent(this.uploader,"onQueueIsChanged",[this,"add",j.id,j])},getItem:function(e){var d=this.items.getItem(e);if(d){return{item:d,node:(d.thumbNode||c(e+"Item"))}}return null},onbxdragstart:function(){var g=c.proxy_context,i=(g&&g.getAttribute("bx-item-id"));if(i){var f=g.innerHTML.replace(new RegExp(i,"gi"),"DragCopy");g.__dragCopyDiv=c.create("DIV",{attrs:{className:"bx-drag-object "+g.className},style:{position:"absolute",zIndex:10,width:g.clientWidth+"px"},html:f});g.__dragCopyPos=c.pos(g);c.onCustomEvent(this.uploader,"onBxDragStart",[g,g.__dragCopyDiv]);document.body.appendChild(g.__dragCopyDiv);c.addClass(g,"bx-drag-source");var h=c("DragCopyProperCanvas"),e,d=this.items.getItem(i);if(h&&(d&&c(d.canvas))){e=d.canvas.cloneNode(true);h.parentNode.replaceChild(e,h);e.getContext("2d").drawImage(d.canvas,0,0)}}return true},onbxdragstop:function(){var d=c.proxy_context;if(d.__dragCopyDiv){c.removeClass(d,"bx-drag-source");d.__dragCopyDiv.parentNode.removeChild(d.__dragCopyDiv);d.__dragCopyDiv=null;delete d.__dragCopyDiv;delete d.__dragCopyPos}return true},onbxdrag:function(d,g){var e=c.proxy_context,f=e.__dragCopyDiv;if(f){if(e.__dragCopyPos){if(!e.__dragCopyPos.deltaX){e.__dragCopyPos.deltaX=e.__dragCopyPos.left-d}if(!e.__dragCopyPos.deltaY){e.__dragCopyPos.deltaY=e.__dragCopyPos.top-g}d+=e.__dragCopyPos.deltaX;g+=e.__dragCopyPos.deltaY}f.style.left=d+"px";f.style.top=g+"px"}},onbxdraghout:function(e,d,f){},onbxdestdraghover:function(d){if(!d||!d.hasAttribute("bx-bxu-item-id")||!this.items.hasItem(d.getAttribute("bx-bxu-item-id"))){return}var e=c.proxy_context;c.addClass(e,"bx-drag-over");return true},onbxdestdraghout:function(){var d=c.proxy_context;c.removeClass(d,"bx-drag-over");return true},onbxdestdragfinish:function(e){var m=c.proxy_context;c.removeClass(m,"bx-drag-over");if(m==e||!c.hasClass(e,"bx-drag-draggable")){return true}var d=e.getAttribute("bx-bxu-item-id");if(!this.items.hasItem(d)){return}var h=m.parentNode,f=h.childNodes.length,k,i,l,g;for(g=0;g<f;g++){if(h.childNodes[g]==m){m.number=g}else{if(h.childNodes[g]==e){e.number=g}}if(e.number>0&&m.number>0){break}}if(this.itForUpload.hasItem(d)){k=(m.number<=e.number?"beforeItem":(m.nextSibling?"afterItem":"inTheEnd"));i=null;if(k!="inTheEnd"){for(g=m.number+(k=="beforeItem"?0:1);g<f;g++){if(this.itForUpload.hasItem(h.childNodes[g].getAttribute("bx-bxu-item-id"))){i=h.childNodes[g].getAttribute("bx-bxu-item-id");break}}if(i===null){k="inTheEnd"}}l=this.itForUpload.removeItem(e.getAttribute("bx-bxu-item-id"));if(k!="inTheEnd"){this.itForUpload.insertBeforeItem(l.id,l,i)}else{this.itForUpload.setItem(l.id,l)}}k=(m.number<=e.number?"beforeItem":(m.nextSibling?"afterItem":"inTheEnd"));i=null;if(k!="inTheEnd"){for(g=m.number+(k=="beforeItem"?0:1);g<f;g++){if(this.items.hasItem(h.childNodes[g].getAttribute("bx-bxu-item-id"))){i=h.childNodes[g].getAttribute("bx-bxu-item-id");break}}if(i===null){k="inTheEnd"}}l=this.items.removeItem(e.getAttribute("bx-bxu-item-id"));if(k!="inTheEnd"){this.items.insertBeforeItem(l.id,l,i)}else{this.items.setItem(l.id,l)}e.parentNode.removeChild(e);if(m.number<=e.number){m.parentNode.insertBefore(e,m)}else{if(m.nextSibling){m.parentNode.insertBefore(e,m.nextSibling)}else{for(g=0;g<f;g++){if(h.childNodes[g]==m){m.number=g}else{if(h.childNodes[g]==e){e.number=g}}}if(m.number<=e.number){m.parentNode.insertBefore(e,m)}else{m.parentNode.appendChild(e)}}}c.onCustomEvent(m,"onFileOrderIsChanged",[m.id,m,this.caller]);c.onCustomEvent(this.uploader,"onQueueIsChanged",[this,"sort",m.id,m]);return true},deleteItem:function(g,e){var f=this.getItem(g),d;if(f&&(!this.placeHolder||((d=f.node)&&d))){if(!!d){if(!!b.jsDD){d.onmousedown=null;d.onbxdragstart=null;d.onbxdragstop=null;d.onbxdrag=null;d.onbxdraghout=null;d.onbxdestdraghover=null;d.onbxdestdraghout=null;d.onbxdestdragfinish=null;d.__bxpos=null;b.jsDD.arObjects[d.__bxddid]=null;delete b.jsDD.arObjects[d.__bxddid];b.jsDD.arDestinations[d.__bxddeid]=null;delete b.jsDD.arDestinations[d.__bxddeid]}c.unbindAll(d);if(e.replaced!==true){d.parentNode.removeChild(d)}}this.items.removeItem(g);this.itUploaded.removeItem(g);this.itFailed.removeItem(g);this.itForUpload.removeItem(g);c.onCustomEvent(this.uploader,"onQueueIsChanged",[this,"delete",g,e]);return true}return false},reinitItem:function(i,g){var f,d;if(!!this.placeHolder&&this.items.hasItem(i)&&(f=c(i+"Item"))&&f){d=g.makeThumb();if(c.type.isNotEmptyString(d)){if(this.thumb.tagName=="TR"){d=d.replace(/[\n\t]/gi,"").replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1");if(!!d.trim){d=d.trim()}var h=function(n,k,l){var o=f.insertCell(-1),j={colspan:true,headers:true,accesskey:true,"class":true,contenteditable:true,contextmenu:true,dir:true,hidden:true,id:true,lang:true,spellcheck:true,style:true,tabindex:true,title:true,translate:true},m;o.innerHTML=l;k=k.split(" ");while((m=k.pop())&&m){m=m.split("=");if(m.length==2){m[0]=m[0].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");m[1]=m[1].replace(/^(\s+)(.*?)/gi,"$2").replace(/(.*?)(\s+)$/gi,"$1").replace(/^["'](.*?)["']$/gi,"$1");if(j[m[0]]===true){o.setAttribute(m[0],m[1])}else{o[m[0]]=m[1]}}}return""},e=/^<td(.*?)>(.*?)<\/td>/i;b.data1=d;while(e.test(d)){d=d.replace(e,h)}}else{f.innerHTML=d}}else{if(c.type.isDomNode(d)){while(c(f.firstChild)){c.remove(f.firstChild)}c.adjust(f,{children:[d]})}}c.onCustomEvent(this.uploader,"onFileIsAppended",[g.id,g,this.caller]);c.onCustomEvent(g,"onFileIsAppended",[g.id,g,this.caller])}},finishQueue:function(){},clear:function(){var d;while((d=this.items.getFirst())&&!!d){this.deleteItem(d.id,d)}},restoreFiles:function(f,g,d){g=(g===true);var e=f.getFirst();while(e){if(this.items.hasItem(e.id)&&(d===true||!this.itUploaded.hasItem(e.id))&&(g||!this.itFailed.hasItem(e.id))){if(this.itFailed.hasItem(e.id)||d===true){delete e.uploadStatus;delete e.file.uploadStatus;delete e.file.firstChunk;delete e.file["package"];delete e.file.packages;if(e.file.copies){e.file.copies.reset();var h;while((h=e.file.copies.getNext())&&h){delete h.uploadStatus;delete h.firstChunk;delete h["package"];delete h.packages}e.file.copies.reset()}e.restored="Y"}else{e.restored="C"}this.itFailed.removeItem(e.id);this.itUploaded.removeItem(e.id);this.itForUpload.setItem(e.id,e);c.onCustomEvent(e,"onUploadRestore",[e])}e=f.getNext()}}};return a}(window));