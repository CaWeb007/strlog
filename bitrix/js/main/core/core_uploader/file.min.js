(function(g){if(g.BX.UploaderFile){return false}var e=(function(){var m={tags:{274:"Orientation",},getStringFromDB:function(p,s,q){var o="",r;for(r=s;r<s+q;r++){o+=String.fromCharCode(p.getUint8(r))}return o},readTags:function(n,u,w,t,q){var r=n.getUint16(w,!q),x={},s,v,p,o=0;for(p in t){if(t.hasOwnProperty(p)){o++}}for(p=0;p<r;p++){s=w+p*12+2;v=t[n.getUint16(s,!q)];x[v]=m.readTagValue(n,s,u,w,q);o--;if(o<=0){break}}return x},readTagValue:function(t,x,A,B,v){var w=t.getUint16(x+2,!v),z=t.getUint32(x+4,!v),p=t.getUint32(x+8,!v)+A,u,y,s,r,o,q;switch(w){case 1:case 7:if(z==1){return t.getUint8(x+8,!v)}else{u=z>4?p:(x+8);y=[];for(r=0;r<z;r++){y[r]=t.getUint8(u+r)}return y}case 2:u=z>4?p:(x+8);return m.getStringFromDB(t,u,z-1);case 3:if(z==1){return t.getUint16(x+8,!v)}else{u=z>2?p:(x+8);y=[];for(r=0;r<z;r++){y[r]=t.getUint16(u+2*r,!v)}return y}case 4:if(z==1){return t.getUint32(x+8,!v)}else{y=[];for(r=0;r<z;r++){y[r]=t.getUint32(p+4*r,!v)}return y}case 5:if(z==1){o=t.getUint32(p,!v);q=t.getUint32(p+4,!v);s=new Number(o/q);s.numerator=o;s.denominator=q;return s}else{y=[];for(r=0;r<z;r++){o=t.getUint32(p+8*r,!v);q=t.getUint32(p+4+8*r,!v);y[r]=new Number(o/q);y[r].numerator=o;y[r].denominator=q}return y}case 9:if(z==1){return t.getInt32(x+8,!v)}else{y=[];for(r=0;r<z;r++){y[r]=t.getInt32(p+4*r,!v)}return y}case 10:if(z==1){return t.getInt32(p,!v)/t.getInt32(p+4,!v)}else{y=[];for(r=0;r<z;r++){y[r]=t.getInt32(p+8*r,!v)/t.getInt32(p+4+8*r,!v)}return y}}},readData:function(p,r){if(m.getStringFromDB(p,r,4)!="Exif"){return false}var o,q=r+6;if(p.getUint16(q)==18761){o=false}else{if(p.getUint16(q)==19789){o=true}else{return false}}if(p.getUint16(q+2,!o)!=42){return false}var n=p.getUint32(q+4,!o);if(n<8){return false}return m.readTags(p,q,q+n,m.tags,o)},readBase64:function(s){s=s.replace(/^data\:([^\;]+)\;base64,/gmi,"");var o=g.atob(s),t=o.length,w=new Uint8Array(t);for(var r=0;r<t;r++){w[r]=o.charCodeAt(r)}var u=new DataView(w.buffer);if((u.getUint8(0)!=255)||(u.getUint8(1)!=216)){return false}var p=2,n=w.buffer.byteLength,q,v=false;while(p<n){if(u.getUint8(p)!=255){break}q=u.getUint8(p+1);if(q==225){v=m.readData(u,p+4,u.getUint16(p+2)-2);break}else{p+=2+u.getUint16(p+2)}}return v}};return function(n){if(c.type.isString(n)){try{var o=m.readBase64(n);if(o&&o.Orientation){return o.Orientation}}catch(p){}}return false}})(),i=function(r,o,n,q){var p=r.width,m=r.height;if([5,6,7,8].indexOf(q)>=0){p=r.height;m=r.width}c.adjust(o,{props:{width:p,height:m}});n.save();switch(q){case 2:n.scale(-1,1);n.translate(-o.width,0);break;case 3:n.translate(o.width,o.height);n.rotate(Math.PI);break;case 4:n.scale(-1,1);n.translate(0,o.height);n.rotate(Math.PI);break;case 5:n.scale(-1,1);n.translate(0,0);n.rotate(Math.PI/2);break;case 6:n.translate(o.width,0);n.rotate(Math.PI/2);break;case 7:n.scale(-1,1);n.translate(-o.width,o.height);n.rotate(Math.PI*3/2);break;case 8:n.translate(0,o.height);n.rotate(Math.PI*3/2);break}n.drawImage(r,0,0);n.restore()};var c=g.BX,d={"new":0,ready:1,preparing:2,inprogress:3,done:4,failed:5,stopped:6,changed:7,uploaded:8},k=(function(){var m=function(n){this.timeLimit=(typeof n==="number"&&n>0?n:50);this.status=d.ready;this.queue=new c.UploaderUtils.Hash();this.id=(new Date()).getTime()};m.prototype={counter:0,active:null,image:null,getImage:function(){if(!this.image){this.image=new Image()}return this.image},canvas:null,getCanvas:function(){if(!this.canvas){this.canvas=c.create("CANVAS",{style:{display:"none"}});document.body.appendChild(this.canvas)}return this.canvas},context:null,getContext:function(){if(!this.context&&this.getCanvas()["getContext"]){this.context=this.getCanvas().getContext("2d")}return this.context},reader:null,getReader:function(){if(!this.reader&&g.FileReader){this.reader=new FileReader()}return this.reader},load:function(o,s,r,p){if(this.active!==null||(this.getReader()&&this.getReader().readyState==1)){return}this.counter++;this.active=o;var q=this.getImage();c.unbindAll(q);q.onload=function(){};q.onerror=function(){};if(!c.browser.IsFirefox()){q.src="/bitrix/images/1.gif"}this.onload=null;delete this.onload;this.onerror=null;delete this.onerror;this.onload=c.delegate(function(t){if(t&&t.target&&t.target.src&&t.target.src.substr(-20)=="/bitrix/images/1.gif"){return}if(!!s){try{s(c.proxy_context,this.getCanvas(),this.getContext(),e((((t&&t.target&&t.target.src)?t.target.src:(c.proxy_context||null)))))}catch(t){c.debug(t)}}if(!!r){this.queue.removeItem(r);setTimeout(c.proxy(function(){this.active=null;this.exec()},this),this.timeLimit)}else{this.active=null}},this);this.onerror=c.delegate(function(){if(!!p){try{p(c.proxy_context)}catch(t){c.debug(t)}}if(!!r){this.queue.removeItem(r);setTimeout(c.proxy(function(){this.active=null;this.exec()},this),this.timeLimit)}else{this.active=null}},this);q.name=o.name;q.onload=this.onload;q.onerror=this.onerror;var n=Object.prototype.toString.call(o);if(o.tmp_url){q.src=o.tmp_url+(o.tmp_url.indexOf("?")>0?"&":"?")+"imageUploader"+this.id+this.counter}else{if(n!=="[object File]"&&n!=="[object Blob]"){this.onerror(null)}else{if(g.URL){q.src=g.URL["createObjectURL"](o)}else{if(this.getReader()!==null){this.__readerOnLoad=null;delete this.__readerOnLoad;this.__readerOnLoad=c.delegate(function(t){this.__readerOnLoad=null;delete this.__readerOnLoad;q.src=t.target.result},this);this.getReader().onloadend=this.__readerOnLoad;this.getReader().onerror=c.proxy(function(t){this.onerror(null)},this);this.getReader().readAsDataURL(o)}}}}},push:function(n,q,o){var p=c.UploaderUtils.getId();this.queue.setItem(p,[p,n,q,o]);this.exec()},exec:function(){var n=this.queue.getFirst();if(!!n){this.load(n[1],n[2],n[0],n[3])}},pack:function(n){return c.UploaderUtils.dataURLToBlob(this.getCanvas().toDataURL(n))}};return m})();c.UploaderFileCnvConstr=k;c.UploaderFileFileLoader=(function(){var m=function(n){this.timeLimit=(typeof n==="number"&&n>0?n:50);this.status=d.ready;this.queue=new c.UploaderUtils.Hash();this._exec=c.delegate(this.exec,this)};m.prototype={xhr:null,goToNext:function(n){delete this.xhr;this.xhr=null;this.queue.removeItem(n);this.status=d.ready;setTimeout(this._exec,this.timeLimit)},load:function(r,p,n,o){if(this.status!=d.ready){return}this.status=d.inprogress;var q=this;this.xhr=c.ajax({method:"GET",data:"",url:p,onsuccess:function(s){if(s===null){o(s)}else{n(s)}q.goToNext(r)},onfailure:function(s){o(s);q.goToNext(r)},start:false,preparePost:false,processData:false});this.xhr.withCredentials=true;this.xhr.responseType="blob";this.xhr.send()},push:function(p,n,o){var q=c.UploaderUtils.getId();this.queue.setItem(q,[q,p,n,o]);this.exec()},exec:function(){var n=this.queue.getFirst();if(!!n){this.load(n[0],n[1],n[2],n[3])}}};return m})();var f=new k(),j=new k(),a=new k(),b=c.create("CANVAS"),l;var h={};c.UploaderFile=function(o,p,m,n){this.dialogName=(this.dialogName?this.dialogName:"BX.UploaderFile");this.file=o;this.id=(o.id||"file"+c.UploaderUtils.getId());this.name=o.name;this.isNode=false;if(c.type.isDomNode(o)){this.isNode=true;this.name=c.UploaderUtils.getFileNameOnly(o.value);if(/\[(.+?)\]/.test(o.name)){var q=/\[(.+?)\]/.exec(o.name);this.id=q[1]}this.file.bxuHandler=this}else{if(o.tmp_url&&!o.name){this.name=c.UploaderUtils.getFileNameOnly(o.tmp_url)}}this.preview='<span id="'+this.id+'Canvas" class="bx-bxu-canvas"></span>';this.nameWithoutExt=(this.name.lastIndexOf(".")>0?this.name.substr(0,this.name.lastIndexOf(".")):this.name);this.ext=this.name.substr(this.nameWithoutExt.length+1);if(/iPhone|iPad|iPod/i.test(navigator.userAgent)&&this.nameWithoutExt=="image"){var u="mobile_"+c.date.format("Ymd_His");h[u]=(h[u]||0);this.nameWithoutExt=u+(h[u]>0?("_"+h[u]):"");this.name=this.nameWithoutExt+(c.type.isNotEmptyString(this.ext)?("."+this.ext):"");h[u]++}this.size="";if(o.size){this.size=c.UploaderUtils.getFormattedSize(o.size,0)}this.type=o.type;this.status=d["new"];this.limits=m;this.caller=n;this.fields={thumb:{tagName:"SPAN",template:'<div class="someclass">#preview#<div>#name#</div>',editorTemplate:'<div class="someeditorclass"><div>#name#</div>',className:"bx-bxu-thumb-thumb",placeHolder:null},preview:{params:{width:400,height:400},template:"#preview#",editorParams:{width:1024,height:860},editorTemplate:"<span>#preview#</span>",className:"bx-bxu-thumb-preview",placeHolder:null,events:{click:c.delegate(this.clickFile,this)},type:"html"},name:{template:"#name#",editorTemplate:'<span><input type="text" name="name" value="#name#" /></span>',className:"bx-bxu-thumb-name",placeHolder:null},type:{template:"#type#",editorTemplate:"#type#",className:"bx-bxu-thumb-type",placeHolder:null}};if(!!p.fields){var r,s;for(var t in p.fields){if(p.fields.hasOwnProperty(t)){if(!!this.fields[t]){for(r in p.fields[t]){if(p.fields[t].hasOwnProperty(r)){this.fields[t][r]=p.fields[t][r]}}}else{this.fields[t]=p.fields[t]}s=t+"";if(s.toLowerCase()!="thumb"&&s.toLowerCase()!="preview"){this[s.toLowerCase()]=(!!p.fields[t]["value"]?p.fields[t]["value"]:"");this.log(s.toLowerCase()+": "+this[s.toLowerCase()])}}}}c.onCustomEvent(this,"onFileIsCreated",[this.id,this,this.caller]);c.onCustomEvent(this.caller,"onFileIsCreated",[this.id,this,this.caller]);this.makePreview();this.preparationStatus=d.done;return this};c.UploaderFile.prototype={log:function(m){c.UploaderUtils.log("file "+this.name,m)},makeThumb:function(){var t=this.fields.thumb.template,m,u,v={},n,q;for(u in this.fields){if(this.fields.hasOwnProperty(u)){if(this.fields[u].template&&this.fields[u].template.indexOf("#"+u+"#")>=0){m=this.id+u.toUpperCase().substr(0,1)+u.substr(1);n=this.setProps(u,this[u],true);t=t.replace("#"+u+"#",'<span id="'+m+'" class="'+this.fields[u]["className"]+'">'+(c.type.isNotEmptyString(n.html)?n.html.replace("#","<\x19>"):n.html)+"</span>");for(q in n.events){if(n.events.hasOwnProperty(q)){v[q]=n.events[q]}}if(!!this.fields[u].events){v[m]=this.fields[u].events}}}}var s,p=[],r=[],o;while((s=/#([^\\<\\>\\"\\']+?)#/gi.exec(t))&&!!s){if(this[s[1]]!==undefined){t=t.replace(s[0],c.type.isNotEmptyString(this[s[1]])?this[s[1]].replace("#","<\x19>"):this[s[1]])}else{o="<\x18"+p.length+">";p.push(o);r.push(s[0]);t=t.replace(s[0],o)}}while((s=p.shift())&&s){o=r.shift();t=t.replace(s,o)}t=t.replace("<\x19>","#");if(!!this.fields.thumb.tagName){s=c.create(this.fields.thumb.tagName,{attrs:{id:(this.id+"Thumb"),className:this.fields.thumb.className},events:this.fields.thumb.events,html:t})}else{s=t}this.__makeThumbEventsObj=v;this.__makeThumbEvents=c.delegate(function(){var w,x;for(w in v){if(v.hasOwnProperty(w)&&c(w)){for(x in v[w]){if(v[w].hasOwnProperty(x)){c.bind(c(w),x,v[w][x])}}}}this.__makeThumbEvents=null;delete this.__makeThumbEvents},this);c.addCustomEvent(this,"onFileIsAppended",this.__makeThumbEvents);if(c.type.isDomNode(this.file)){if(c.type.isString(t)){this.__bindFileNode=c.delegate(function(x){var w=c(x+"Item");if(w.tagName=="TR"){w.cells[0].appendChild(this.file)}else{if(w.tagName=="TABLE"){w.rows[0].cells[0].appendChild(this.file)}else{c(x+"Item").appendChild(this.file)}}this.__bindFileNode=null;delete this.__bindFileNode},this);c.addCustomEvent(this,"onFileIsAppended",this.__bindFileNode)}else{s.appendChild(this.file)}}return s},checkProps:function(){var m=c.UploaderUtils.FormToArray({elements:[c.proxy_context]}),n;for(n in m.data){if(m.data.hasOwnProperty(n)){this[n]=m.data[n]}}},setProps:function(n,p,q){if(typeof n=="string"){if(n=="size"){p=c.UploaderUtils.getFormattedSize(this.file.size,0)}if(typeof this[n]!="undefined"&&typeof this.fields[n]!="undefined"){this[n]=p;var u=this.fields[n].template.replace("#"+n+"#",this.fields[n]["type"]==="html"?(p||""):c.util.htmlspecialchars(p||"")).replace(/#id#/gi,this.id),m,s,o,v={html:u,events:{}};this.hiddenForm=(!!this.hiddenForm?this.hiddenForm:c.create("FORM",{style:{display:"none"}}));this._checkProps=(!!this._checkProps?this._checkProps:c.delegate(this.checkProps,this));this.hiddenForm.innerHTML=u;if(this.hiddenForm.elements.length>0){for(m=0;m<this.hiddenForm.elements.length;m++){o=this.hiddenForm.elements[m];if(typeof this[o.name]!="undefined"){if(!o.hasAttribute("id")){o.setAttribute("id",this.id+n+c.UploaderUtils.getId())}v.events[o.id]={blur:this._checkProps}}}v.html=this.hiddenForm.innerHTML}if(c(this.hiddenForm)){c.remove(this.hiddenForm)}this.hiddenForm=null;delete this.hiddenForm;if(q){return v}var r=this.getPH(n);if(!!r){r.innerHTML=v.html;for(m in v.events){if(v.events.hasOwnProperty(m)){for(s in v.events[m]){if(v.events[m].hasOwnProperty(s)){c.bind(c(m),s,v.events[m][s])}}}}}}}else{if(!!n){for(var t in n){if(n.hasOwnProperty(t)){if(this.fields.hasOwnProperty(t)&&t!=="preview"){this.setProps(t,n[t])}}}}}return true},getProps:function(m){if(m=="canvas"){return c(this.id+"ProperCanvas")}else{if(typeof m=="string"){return this[m]}}var o={};for(var n in this.fields){if(this.fields.hasOwnProperty(n)&&(n!=="preview"&&n!=="thumb")){o[n]=this[n]}}o.size=this.file.size;o.type=this["type"];if(!!this.copies){var p;o.canvases={};while((p=this.copies.getNext())&&!!p){o.canvases[p.id]={width:p.width,height:p.height,name:p.name}}}return o},getThumbs:function(){return null},getPH:function(m){m=(typeof m==="string"?m:"");m=m.toLowerCase();if(this.fields.hasOwnProperty(m)){var n=m.substr(0,1).toUpperCase()+m.substr(1);this.fields[m]["placeHolder"]=c(this.id+n);return this.fields[m]["placeHolder"]}return null},clickFile:function(){return false},makePreview:function(){this.status=d.ready;c.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);c.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as a file")},preparationStatus:d.ready,deleteFile:function(){var n,m=this.__makeThumbEventsObj;for(n in this.fields){if(this.fields.hasOwnProperty(n)){if(!!this.fields[n]["placeHolder"]){this.fields[n]["placeHolder"]=null;c.unbindAll(this.fields[n]["placeHolder"]);delete this.fields[n]["placeHolder"]}}}for(n in m){if(m.hasOwnProperty(n)&&c(n)){c.unbindAll(c(n))}}this.file=null;delete this.file;c.remove(this.canvas);this.canvas=null;delete this.canvas;c.onCustomEvent(this.caller,"onFileIsDeleted",[this.id,this,this.caller]);c.onCustomEvent(this,"onFileIsDeleted",[this,this.caller])}};c.UploaderImage=function(o,r,n,m){this.dialogName="BX.UploaderImage";c.UploaderImage.superclass.constructor.apply(this,arguments);this.isImage=true;this.copies=new c.UploaderUtils.Hash();this.caller=m;if(!this.isNode&&c.Uploader.getInstanceName()=="BX.Uploader"){if(!!r.copies){var q=r.copies,s;for(var p in q){if(q.hasOwnProperty(p)&&!!q[p]){s={width:parseInt(q[p]["width"]),height:parseInt(q[p]["height"]),id:p};if(s.width>0&&s.height>0){this.copies.setItem(p,s)}}}}this.preparationStatus=d["new"];c.addCustomEvent(this,"onFileHasToBePrepared",c.delegate(function(){this.preparationStatus=d.inprogress;if(this.status!=d["new"]){j.push(this.file,c.delegate(this.makeCopies,this))}},this));c.addCustomEvent(this,"onUploadDone",c.delegate(function(){var t;while((t=this.copies.getNext())&&!!t){t.file=null;delete t.file}this.preparationStatus=d["new"]},this));this.canvas=c.create("CANVAS",{attrs:{id:this.id+"ProperCanvas"}})}else{this.preparationStatus=d.done;this.canvas=null}return this};c.extend(c.UploaderImage,c.UploaderFile);c.UploaderImage.prototype.makePreviewImageWork=function(p,o,t,r){r=parseInt(r);var u=null,n=o.width,s=o.height;if(this.file){this.file.width=o.width;this.file.height=o.height}if(!!this.canvas){i(p,o,t,r);if(this.file){this.file.width=o.width;this.file.height=o.height;if(r){this.file.exif={Orientation:r}}}this.applyFile(o,false);u=this.canvas}else{if(c(this.id+"Canvas")){var m=c.UploaderUtils.scaleImage({width:n,height:s},this.fields.preview.params),q={props:{width:m.destin.width,height:m.destin.height,src:p.src},attrs:{className:(this.file.width>this.file.height?"landscape":"portrait")}};switch(r){case 2:q.attrs.className+=" flip";break;case 3:q.attrs.className+=" rotate-180";break;case 4:q.attrs.className+=" flip-and-rotate-180";break;case 5:q.attrs.className+=" flip-and-rotate-270";break;case 6:q.attrs.className+=" rotate-90";break;case 7:q.attrs.className+=" flip-and-rotate-90";break;case 8:q.attrs.className+=" rotate-270";break}u=c.create("IMG",q)}}c.onCustomEvent(this,"onFileCanvasIsLoaded",[this.id,this,this.caller,p]);c.onCustomEvent(this.caller,"onFileCanvasIsLoaded",[this.id,this,this.caller,p]);if(c(this.id+"Canvas")){c(this.id+"Canvas").appendChild(u)}return u};c.UploaderImage.prototype.makePreviewImageLoadHandler=function(p,m,n,o){this.makePreviewImageWork(p,m,n,o);this.status=d.ready;c.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);c.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as an image with preview");if(this.preparationStatus==d.inprogress){this.makeCopies(p,m,n,o)}if(this["_makePreviewImageLoadHandler"]){this._makePreviewImageLoadHandler=null;delete this._makePreviewImageLoadHandler}if(this["_makePreviewImageFailedHandler"]){this._makePreviewImageFailedHandler=null;delete this._makePreviewImageFailedHandler}};c.UploaderImage.prototype.makePreviewImageFailedHandler=function(){this.status=d.ready;this.preparationStatus=d.done;c.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);c.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized without canvas");if(this["_makePreviewImageLoadHandler"]){this._makePreviewImageLoadHandler=null;delete this._makePreviewImageLoadHandler}if(this["_makePreviewImageFailedHandler"]){this._makePreviewImageFailedHandler=null;delete this._makePreviewImageFailedHandler}};c.UploaderImage.prototype.makePreview=function(){if(!this.isNode){this._makePreviewImageLoadHandler=c.delegate(this.makePreviewImageLoadHandler,this);this._makePreviewImageFailedHandler=c.delegate(this.makePreviewImageFailedHandler,this);f.push(this.file,this._makePreviewImageLoadHandler,this._makePreviewImageFailedHandler)}else{this.status=d.ready;c.onCustomEvent(this,"onFileIsInited",[this.id,this,this.caller]);c.onCustomEvent(this.caller,"onFileIsInited",[this.id,this,this.caller]);this.log("is initialized as an image without preview");if(this.caller.queue.placeHolder){this._onFileHasGotPreview=c.delegate(function(n,m){c.removeCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);c.removeCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview);this._makePreviewImageLoadHandler=c.delegate(function(o){o=this.makePreviewImageWork(o);c.onCustomEvent(this,"onFileHasPreview",[m.id,m,o]);delete this._makePreviewImageLoadHandler;delete this._makePreviewImageFailedHandler},this);this._makePreviewImageFailedHandler=c.delegate(function(o){delete this._makePreviewImageLoadHandler;delete this._makePreviewImageFailedHandler},this);f.push({tmp_url:m.file.url},this._makePreviewImageLoadHandler,this._makePreviewImageFailedHandler)},this);this._onFileHasNotGotPreview=c.delegate(function(m){if(m==this.id){c.removeCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);c.removeCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview)}},this);c.addCustomEvent(this,"onFileHasGotPreview",this._onFileHasGotPreview);c.addCustomEvent(this,"onFileHasNotGotPreview",this._onFileHasNotGotPreview);c.onCustomEvent(this.caller,"onFileNeedsPreview",[this.id,this,this.caller])}}return true};c.UploaderImage.prototype.checkPreview=function(){};c.UploaderImage.prototype.applyFile=function(p,r){this.checkPreview();if(!!r&&r.data){this.setProps(r.data)}var n=c.UploaderUtils.scaleImage(p,{width:this.limits.uploadFileWidth,height:this.limits.uploadFileHeight}),o=c.UploaderUtils.scaleImage(p,this.fields.preview.params),q={props:{width:o.destin.width,height:o.destin.height},attrs:{className:"bx-bxu-proper-canvas"+(o.destin.width>o.destin.height?" landscape":" portrait")}};if(n.bNeedCreatePicture||!!r){c.adjust(b,{props:{width:n.destin.width,height:n.destin.height}});l=b.getContext("2d");l.drawImage(p,n.source.x,n.source.y,n.source.width,n.source.height,n.destin.x,n.destin.y,n.destin.width,n.destin.height);var m=b.toDataURL(this.file.type);this.file=c.UploaderUtils.dataURLToBlob(m)}this.file.name=this.name;this.file.width=n.destin.width;this.file.height=n.destin.height;c.adjust(this.canvas,q);l=this.canvas.getContext("2d");l.drawImage(p,o.source.x,o.source.y,o.source.width,o.source.height,o.destin.x,o.destin.y,o.destin.width,o.destin.height);l=null;p=null;this.setProps("size");this.status=d.changed};c.UploaderImage.prototype.clickFile=function(){if(!this.canvas||!c.CanvasEditor||this.status==d["new"]){return false}if(!this.__showEditor){this.__showEditor=c.delegate(this.showEditor,this);this.eFunc={apply:c.delegate(this.applyFile,this),"delete":c.delegate(this.deleteFile,this),clear:c.delegate(function(){c.removeCustomEvent(n,"onApplyCanvas",this.eFunc.apply);c.removeCustomEvent(n,"onDeleteCanvas",this.eFunc["delete"]);c.removeCustomEvent(n,"onClose",this.eFunc.clear)},this)}}var p=this.fields.thumb.editorTemplate,m;for(var o in this.fields){if(this.fields.hasOwnProperty(o)){m=o.substr(0,1).toUpperCase()+o.substr(1);p=p.replace("#"+o+"#",(o==="preview"?"":('<span id="'+this.id+m+'Editor" class="'+this.fields[o]["className"]+'">'+this.fields[o]["editorTemplate"].replace("#"+o+"#",(!!this[o]?c.util.htmlspecialchars(this[o]):""))+"</span>")))}}c.adjust(a.getCanvas(),{props:{width:this.file.width,height:this.file.height}});a.getContext().drawImage(this.canvas,0,0,this.canvas.width,this.canvas.height,0,0,a.getCanvas().width,a.getCanvas().height);var n=c.CanvasEditor.show(a.getCanvas(),{title:this.name,template:p});c.addCustomEvent(n,"onApplyCanvas",this.eFunc.apply);c.addCustomEvent(n,"onDeleteCanvas",this.eFunc["delete"]);c.addCustomEvent(n,"onClose",this.eFunc.clear);c.onCustomEvent(this,"onCanvasEditorIsCreated",[n,this]);a.push(this.file,this.__showEditor);this.editor=n;return false};c.UploaderImage.prototype.showEditor=function(p,m,n,o){c.adjust(m,{props:{width:this.file.width,height:this.file.height}});i(p,m,n,o);this.editor.copyCanvas(m)};c.UploaderImage.prototype.makeCopies=function(p,o,t,s){var m,r,q,u,n=b.getContext("2d");i(p,b,n,s);while((m=this.copies.getNext())&&!!m){r=c.UploaderUtils.scaleImage(b,m);c.adjust(o,{props:{width:r.destin.width,height:r.destin.height}});t.drawImage(b,r.source.x,r.source.y,r.source.width,r.source.height,r.destin.x,r.destin.y,r.destin.width,r.destin.height);q=o.toDataURL(this.file.type);u=c.UploaderUtils.dataURLToBlob(q);u.width=o.width;u.height=o.height;u.name=this.name;u.thumb=m.id;u.canvases=this.copies.length;u.canvas=this.copies.pointer-1;m.file=u}this.preparationStatus=d.done};c.UploaderImage.prototype.getThumbs=function(m){if(m=="getCount"){return this.copies.length}var n=(typeof m=="string"?this.copies.getItem(m):this.copies.getNext());if(!!n){return n.file}return null};return true}(window));