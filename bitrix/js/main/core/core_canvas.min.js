(function(a){if(a.BX.CanvasEditor){return false}var d=a.BX,b={},c=function(h,t){t=(t||{});var u,w,q=[],r=h.elements.length,f=0,o=0;if(!!h){for(u=0;u<r;u++){var m=h.elements[u];if(m.disabled){continue}switch(m.type.toLowerCase()){case"text":case"textarea":case"password":case"hidden":case"select-one":q.push({name:m.name,value:m.value});o+=(m.name.length+m.value.length);break;case"file":if(!!m.files){for(w=0;w<m.files.length;w++){f++;q.push({name:m.name,value:m.files[w]});o+=m.files[w].size}}break;case"radio":case"checkbox":if(m.checked){q.push({name:m.name,value:m.value});o+=(m.name.length+m.value.length)}break;case"select-multiple":for(var s=0;s<m.options.length;s++){if(m.options[s].selected){q.push({name:m.name,value:m.options[s].value});o+=(m.name.length+m.options[s].length)}}break;default:break}}u=0;o=0;var v=t;while(u<q.length){var g=q[u].name.indexOf("[");if(g==-1){v[q[u].name]=q[u].value;v=t;u++}else{var e=q[u].name.substring(0,g);var l=q[u].name.substring(g+1);if(!v[e]){v[e]=[]}var k=l.indexOf("]");if(k==-1){v=t;u++}else{if(k==0){v=v[e];q[u].name=""+v.length}else{v=v[e];q[u].name=l.substring(0,k)+l.substring(k+1)}}}}}return{data:t,filesCount:f,roughSize:o}};d.CanvasEditor=function(e){this.previewSize={width:1024,height:860,minWidth:500,minHeight:335};this.dialogName="BX.CanvasEditor";this.id=e+"Editor";this.canvas=new d.Canvas();d.addCustomEvent(this.canvas,"onChangeSize",d.delegate(function(l,j){var o=l.props,g={width:parseInt(l.style.width.replace("px","")),height:parseInt(l.style.height.replace("px",""))},r=d.pos(this.canvas.getCanvas().parentNode.parentNode),i={style:l.style},n,m=0,h=this.canvas.getCanvas();if(j==true){if(g.height>r.height||g.width>r.width){n=d.UploaderUtils.scaleImage(o,r,"inscribed");m=n.coeff;if(!h.hasAttribute("bx-bxu-html-compression-ratio-real")){h.setAttribute("bx-bxu-html-compression-ratio-real",h.getAttribute("bx-bxu-html-compression-ratio"))}h.setAttribute("bx-bxu-html-compression-ratio",m)}else{if(h.hasAttribute("bx-bxu-html-compression-ratio-real")){m=h.getAttribute("bx-bxu-html-compression-ratio-real");h.setAttribute("bx-bxu-html-compression-ratio",m);h.removeAttribute("bx-bxu-html-compression-ratio-real")}}if(m>0){return this.canvas.setProps(o,false)}}var p=Math.ceil((r.height-g.height)/2),k=Math.ceil((r.width-g.width)/2),q=(r.width-k-g.width),f={style:{paddingTop:p+"px",paddingBottom:(r.height-p-g.height)+"px",paddingLeft:k+"px",paddingRight:q+"px"}};d.adjust(this.canvas.getCanvas().parentNode,i);d.adjust(this.canvas.getCanvas().parentNode.parentNode,f)},this));d.addCustomEvent(this.canvas,"onChangeCanvas",d.delegate(function(i){this.canvas.getCanvas().removeAttribute("bx-bxu-html-compression-ratio-real");var h=i.destin,j={},g=Math.max(h.width,this.previewSize.minWidth),f=Math.max(h.height,this.previewSize.minHeight);j.left=Math.ceil((g-h.width)/2);j.right=g-j.left-h.width;j.top=Math.ceil((f-h.height)/2);j.bottom=f-j.top-h.height;d.adjust(this.canvas.getCanvas().parentNode.parentNode,{style:{padding:""+j.top+"px "+j.right+"px "+j.bottom+"px "+j.left+"px"}})},this));this.popup=null;return this};d.CanvasEditor.prototype={onApply:function(){this.canvas.apply();d.onCustomEvent(this,"onApplyCanvas",[this.canvas.orig,c(d(this.id+"params"))])},onCancel:function(){d.onCustomEvent(this,"onCancelCanvas",[this.canvas.orig])},onDelete:function(){d.onCustomEvent(this,"onDeleteCanvas",[this.canvas.orig])},showEditor:function(h,l){l=(!!l&&typeof l=="object"?l:{template:l});d.onCustomEvent(this,"onBeforeShow");var i=d.GetWindowInnerSize();if(i.innerWidth<this.previewSize.width){this.previewSize.width=i.innerWidth}if(i.innerHeight*0.8<(this.previewSize.height)){this.previewSize.height=i.innerHeight*0.8}if(this.popup===null){var j=d.UploaderUtils.scaleImage(h,this.previewSize,"inscribed");var g=d.create("DIV",{attrs:{id:this.id+"Proper",className:"bxu-edit-popup"},style:{display:"none"},html:['<div class="bxu-edit-top"> 							<span class="bxu-edit-name" id="',this.id,'title">',d.util.htmlspecialchars(l.title),'</span> 							<span class="bxu-edit-cls" id="',this.id,'close"></span> 						</div> 						<div class="bxu-edit-img-wrap">							<div class="bxu-edit-img-wrap-in" style="position:relative; margin:0;padding:0;border:none;"> 								<div style="position:relative; margin:0;padding:0;border:none;"> 									<canvas id="',this.id,'canvas" width="',j.destin.width,'" height="',j.destin.height,'"><canvas> 								</div> 							</div> 						</div> 						<div class="bxu-edit-btn-block"> 							<div class="bxu-edit-btn-wrap"> 								<span class="bxu-edit-btn bxu-edit-btn-turn-l" id="',this.id,"turn-l",'" title="',d.message("CANVAS_TURN_L"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 								<span class="bxu-edit-btn bxu-edit-btn-turn-r" id="',this.id,"turn-r",'"title="',d.message("CANVAS_TURN_R"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 								<span class="bxu-edit-btn bxu-edit-btn-flip-v" id="',this.id,"flip-v",'" title="',d.message("CANVAS_FLIP_V"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 								<span class="bxu-edit-btn bxu-edit-btn-flip-h" id="',this.id,"flip-h",'" title="',d.message("CANVAS_FLIP_H"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 								<span class="bxu-edit-btn bxu-edit-btn-crop" id="',this.id,"crop",'" title="',d.message("CANVAS_CROP"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 								<span class="bxu-edit-btn bxu-edit-btn-grayscale" id="',this.id,"grayscale",'" title="',d.message("CANVAS_GRAYSCALE"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 								<span class="bxu-edit-btn bxu-edit-btn-sign" id="',this.id,"sign",'" title="',d.message("CANVAS_SIGN"),'"> 									<span class="bxu-edit-btn-icon"></span> 								</span> 							</div> 							<div class="bxu-edit-inp-wrap"> 								<form onsubmit="return false;" id="',this.id,'params">',(l.template||""),"</form> 							</div> 						</div>"].join("")});var k=d.delegate(function(){d(this.id+"canvas").parentNode.replaceChild(this.canvas.cnv,d(this.id+"canvas"));d.bind(d(this.id+"turn-l"),"click",d.proxy(function(){this.rotate(false)},this.canvas));d.bind(d(this.id+"turn-r"),"click",d.proxy(function(){this.rotate(true)},this.canvas));d.bind(d(this.id+"flip-v"),"click",d.proxy(function(){this.flip(false)},this.canvas));d.bind(d(this.id+"flip-h"),"click",d.proxy(function(){this.flip(true)},this.canvas));d.bind(d(this.id+"crop"),"click",d.proxy(function(){this.crop(d.proxy_context)},this.canvas));d.bind(d(this.id+"grayscale"),"click",d.proxy(function(){this.blackAndWhite()},this.canvas));d.bind(d(this.id+"sign"),"click",d.proxy(function(){this.poster(d.proxy_context)},this.canvas));d.bind(d(this.id+"close"),"click",d.proxy(this.popup.close,this.popup));d.bind(d(this.id+"params"),"submit",d.proxy(this.onApply,this));d.removeCustomEvent(this.popup,"onPopupShow",k)},this),e=d.delegate(this.onCancel,this);this.popup=d.PopupWindowManager.create("popup"+this.id,null,{className:"bxu-popup",autoHide:false,lightShadow:true,closeIcon:false,closeByEsc:true,zIndex:1,content:g,overlay:{},events:{onPopupClose:d.delegate(function(){d.onCustomEvent(this,"onClose",[this]);this.canvas.reset()},this)},buttons:[new d.PopupWindowButton({text:d.message("CANVAS_OK"),className:"",events:{click:d.delegate(function(){this.onApply();d.removeCustomEvent(this.popup,"onPopupClose",e);this.popup.close()},this)}}),new d.PopupWindowButton({text:d.message("CANVAS_CANCEL"),className:"",events:{click:d.delegate(function(){this.popup.close()},this)}})]});d.addCustomEvent(this.popup,"onPopupShow",k);d.addCustomEvent(this.popup,"onPopupClose",e)}var f=d.delegate(function(){if(h!=null){this.copyCanvas(h)}d(this.id+"params").innerHTML=(l.template||"");if(!!l.template){d.defer_proxy(function(){var n=d(this.id+"params");if(!!n){for(var m=0;m<n.elements.length;m++){if(n.elements[m].type.toUpperCase()=="TEXT"||n.elements[m].tagName.toUpperCase()=="TEXTAREA"){d.focus(n.elements[m]);break}}}},this)()}d(this.id+"title").innerHTML=d.util.htmlspecialchars(l.title||"");d.removeCustomEvent(this.popup,"onAfterPopupShow",f)},this);d.addCustomEvent(this.popup,"onAfterPopupShow",f);this.popup.show();this.popup.adjustPosition();d.onCustomEvent(this,"onAfterShow");return true},copyCanvas:function(e){this.canvas.copy(e,this.previewSize)}};d.CanvasEditor.show=function(e,f,g){var h="";if(typeof g=="string"){h=g}else{if(typeof g=="object"){h=g.id}}h=(typeof h==="string"&&h.length>0?h:"default");if(!b[h]){b[h]=new d.CanvasEditor(h)}b[h].showEditor(e,f,g);return b[h]};d.CanvasEditor.replaceCanvas=function(e,f){f=(typeof f==="string"&&f.length>0?f:"default");if(!!b[f]){b[f].copyCanvas(e)}};d.Canvas=function(){this.cnv=null;this.ctx=null;this.init();return this};d.Canvas.prototype={getVisFromReal:function(f){var e=this.cnv.getAttribute("bx-bxu-html-compression-ratio");return((0<e&&e<1)?parseInt(e*f):f)},getRealFromVis:function(f){var e=this.cnv.getAttribute("bx-bxu-html-compression-ratio");return((0<e&&e<1)?parseInt(f/e):f)},setStyles:function(e){var g={width:this.getRealFromVis(e.width),height:this.getRealFromVis(e.height)},f={width:e.width+"px",height:e.height+"px"};d.adjust(this.cnv,{props:g,style:f});d.onCustomEvent(this,"onChangeSize",[{props:g,style:f}])},setProps:function(f,e){var h=({width:f.width,height:f.height}),g={width:this.getVisFromReal(f.width)+"px",height:this.getVisFromReal(f.height)+"px"};d.adjust(this.cnv,{props:h,style:g});d.onCustomEvent(this,"onChangeSize",[{props:h,style:g},e])},getCanvas:function(){return this.cnv},init:function(){this.cnv=d.create("CANVAS");d.adjust(this.cnv,{width:100,height:100});this.ctx=this.cnv.getContext("2d");this.initDnD();return this.cnv},reset:function(){this.ctx.clearRect(0,0,this.cnv.width,this.cnv.height);d.adjust(this.cnv,{width:100,height:100})},apply:function(){this.orig.width=this.cnv.width;this.orig.height=this.cnv.height;this.orig.ctx=this.orig.getContext("2d");this.orig.ctx.drawImage(this.cnv,0,0)},copy:function(e,g){this.orig=e;g=(g||{});g.width=(g.width>0?g.width:0);g.height=(g.height>0?g.height:0);var f=d.UploaderUtils.scaleImage(e,g,"inscribed");this.cnv.setAttribute("bx-bxu-html-compression-ratio",f.coeff);this.setProps(e);d.onCustomEvent(this,"onChangeCanvas",[f]);this.ctx=this.cnv.getContext("2d");this.ctx.drawImage(e,0,0);return this.cnv},poster:function(f){if(!!this.posterPopup){this.posterPopup.close()}var e=d.pos(f);this.posterPopup=new d.PopupWindow("bx-poster-popup-"+f.id,f,{lightShadow:true,offsetTop:-3,className:"bxu-poster-popup",offsetLeft:Math.ceil(e.width/2),autoHide:true,closeByEsc:true,zIndex:d.PopupWindow.defaultOptions.popupOverlayZindex-d.PopupWindow.defaultOptions.popupZindex+2,bindOptions:{position:"top"},overlay:false,events:{onPopupClose:function(){this.destroy()},onPopupDestroy:d.proxy(function(){this.posterPopup=null},this)},buttons:[new d.PopupWindowButton({text:d.message("CANVAS_OK"),events:{click:d.delegate(function(){var g=d("posterPopupText"+f.id);if(!!g&&g.value.length>0){this.posterApply(g.value)}this.posterPopup.close()},this)}}),new d.PopupWindowButton({text:d.message("CANVAS_CANCEL"),events:{click:d.delegate(function(){this.posterPopup.close()},this)}})],content:['<div class="bxu-poster-popup-dt">',d.message("CANVAS_POSTER_SIGN"),'</div> 					<input type="text" id="posterPopupText',f.id,'" maxlength="255" value="" />'].join("")});this.posterPopup.show();this.posterPopup.setAngle({position:"bottom"});this.posterPopup.bindOptions.forceBindPosition=true;this.posterPopup.adjustPosition();d.focus(d("posterPopupText"+f.id));this.posterPopup.bindOptions.forceBindPosition=false},posterApply:function(g){if(g){var f=Math.min(this.cnv.width,this.cnv.height)/10;this.ctx.fillStyle="black";this.ctx.fillRect(0,0,this.cnv.width,f);this.ctx.fillRect(0,this.cnv.height-2*f,this.cnv.width,2*f);this.ctx.fillRect(0,0,f,this.cnv.height);this.ctx.fillRect(this.cnv.width-f,0,f,this.cnv.height);this.ctx.strokeStyle="white";var e=5;this.ctx.strokeRect(f-e,f-e,this.cnv.width-(f*2)+2*e,this.cnv.height-(f*3)+2*e);this.ctx.fillStyle="white";this.ctx.textAlign="center";this.ctx.textBaseline="middle";this.ctx.font=f+"px marketing";this.ctx.fillText(g,this.cnv.width/2,this.cnv.height-f,this.cnv.width)}},blackAndWhite:function(){var g=this.ctx.getImageData(0,0,this.cnv.width,this.cnv.height),e,f;for(f=0;f<g.data.length;f+=4){e=(g.data[f]+g.data[f+1]+g.data[f+2])/3;g.data[f]=e;g.data[f+1]=e;g.data[f+2]=e}this.ctx.putImageData(g,0,0)},flip:function(e){this.ctx.save();if(e){this.ctx.scale(1,-1);this.ctx.translate(0,-this.cnv.height)}else{this.ctx.scale(-1,1);this.ctx.translate(-this.cnv.width,0)}this.ctx.drawImage(this.cnv,0,0);this.ctx.restore()},rotate:function(e){this.turn(this.cnv,this.ctx,e)},turn:function(i,g,h){var f=d.create("CANVAS",{props:{width:i.width,height:i.height},style:{display:"none"}});f.getContext("2d").drawImage(i,0,0);this.setProps({width:f.height,height:f.width},true);g.save();if(h){g.translate(this.cnv.width,0)}else{g.translate(0,this.cnv.height)}var e=Math.PI/2*(h?1:-1);g.rotate(e);g.drawImage(f,0,0);g.restore();f=null},resize:function(f){var e=d.create("CANVAS",{props:{width:this.cnv.width,height:this.cnv.height},style:{display:"none"}});e.getContext("2d").drawImage(this.cnv,0,0);this.cnv.width*=f;this.cnv.height*=f;this.ctx.save();this.ctx.scale(f,f);this.ctx.drawImage(e,0,0);this.ctx.restore();e=null},_imageDropped:function(g,e,i,h){var f=d.create("IMG",{style:{display:"none"},events:{load:d.delegate(function(){var j=(f.width>this.cnv.width/3?(this.cnv.width/3)/f.width:1),l=(f.height>this.cnv.height/3?(this.cnv.height/3)/f.height:1),k=Math.min(j,l);this.cnv.save();this.cnv.translate(e-f.width*k/2,i-f.height*k/2);this.cnv.scale(k,k);this.cnv.drawImage(f,0,0);if(h){this.cnv.strokeStyle="white";this.cnv.lineWidth=5/k;this.cnv.strokeRect(0,0,f.width,f.height)}this.cnv.restore();document.body.removeChild(f);f=null},this)}});f.src=g;document.body.appendChild(f)},initDnD:function(){if(!!d.DD&&d.type.isDomNode(this.cnv)&&this.cnv.parentNode){this.cnvDD=new d.DD.dropFiles(this.cnv.canvas);if(this.cnvDD&&this.cnvDD.supported()&&d.ajax.FormData.isSupported()){d.addCustomEvent(this.cnvDD,"dragover",d.preventDefault);d.addCustomEvent(this.cnvDD,"drop",d.delegate(function(l){d.preventDefault(l);d.fixEventPageXY(l);var k=l.dataTransfer,g=l.pageX-this.cnv.canvas.offsetLeft-this.cnv.canvas.parentNode.offsetLeft,m=l.pageY-this.cnv.canvas.offsetTop-this.cnv.canvas.parentNode.offsetTop,j=k.files;if(j.length==0){var i="application/x-moz-file-promise-url";if(k.types.contains(i)){this._imageDropped(k.getData(i),g,m,false)}}else{var h=j[0],f=new FileReader();f.onload=d.proxy(function(n){this._imageDropped(n.target.result,g,m,true);f=null},this);f.readAsDataURL(h)}},this))}}},cropParams:null,crop:function(f){if(!!f){d.addClass(f,"bxu-edit-btn-active")}var h=d.create("DIV",{attrs:{id:"crop"+this.id,className:"bx-bxu-canvas-crop-rectangle"},style:{border:"3px dashed gray",position:"absolute",display:"none",zIndex:1201}});this.cropParams={x:0,y:0,width:0,height:0,top:0,left:0,mousedown:d.delegate(function(i){d.fixEventPageXY(i);if(i.layerX||i.layerX==0){this.cropParams.left=i.layerX;this.cropParams.top=i.layerY}else{if(i.offsetX||i.offsetX==0){this.cropParams.left=i.offsetX;this.cropParams.top=i.offsetY}else{this.cropParams.top=i.pageX-this.cnv.pos.left;this.cropParams.left=i.pageY-this.cnv.pos.top}}this.cropParams["~top"]=this.cropParams.top;this.cropParams["~left"]=this.cropParams.left;this.cropParams.x=i.pageX;this.cropParams.y=i.pageY;d.bind(document,"mousemove",this.cropParams.mousemove)},this),mousemove:d.delegate(function(j){d.fixEventPageXY(j);var i=j.pageX,k=j.pageY;this.cropParams.width=(i-this.cropParams.x);if(this.cropParams.width<0){this.cropParams.left=this.cropParams["~left"]+this.cropParams.width;this.cropParams.width*=-1;if(this.cropParams.left<0){this.cropParams.left=0;this.cropParams.width=this.cropParams["~left"]}}else{this.cropParams.left=this.cropParams["~left"];if((this.cropParams.left+this.cropParams.width)>this.cnv.pos.width){this.cropParams.width=this.cnv.pos.width-this.cropParams.left}}this.cropParams.height=k-this.cropParams.y;if(this.cropParams.height<0){this.cropParams.top=this.cropParams["~top"]+this.cropParams.height;this.cropParams.height*=-1;if(this.cropParams.top<0){this.cropParams.top=0;this.cropParams.height=this.cropParams["~top"]}}else{this.cropParams.top=this.cropParams["~top"];if((this.cropParams.top+this.cropParams.height)>this.cnv.pos.height){this.cropParams.height=this.cnv.pos.height-this.cropParams.top}}d.adjust(h,{style:{left:(this.cropParams.left+"px"),top:(this.cropParams.top+"px"),width:((this.cropParams.width-(h.borderLeft+h.borderRight))+"px"),height:((this.cropParams.height-(h.borderTop+h.borderBottom))+"px"),display:"block"}})},this),mouseup:d.delegate(function(j){d.PreventDefault(j);if(this.cropParams.width>0&&this.cropParams.height>0){var i=d.create("CANVAS",{props:{width:this.cnv.width,height:this.cnv.height},style:{display:"none"}});i.getContext("2d").drawImage(this.cnv,0,0);this.setStyles(this.cropParams);this.ctx.save();this.ctx.drawImage(i,-this.getRealFromVis(this.cropParams.left),-this.getRealFromVis(this.cropParams.top));this.ctx.restore();i=null}this.cropParams.clear(j)},this),clear:d.delegate(function(i){if(!!f){d.removeClass(f,"bxu-edit-btn-active")}d.unbind(this.cnv,"mousedown",this.cropParams.mousedown);d.unbind(document,"mousemove",this.cropParams.mousemove);d.unbind(this.cnv,"mouseup",this.cropParams.mouseup);d.unbind(h,"mouseup",this.cropParams.mouseup);d.unbind(document,"mouseup",this.cropParams.mouseup);this.cnv.parentNode.style.position=this.cnv.parentNode.style._position;this.cnv.parentNode.removeChild(h);h=null;this.cropParams=null},this)};d.bind(this.cnv,"mousedown",this.cropParams.mousedown);d.bind(this.cnv,"mouseup",this.cropParams.mouseup);d.bind(h,"mouseup",this.cropParams.mouseup);d.bind(document,"mouseup",this.cropParams.mouseup);this.cnv.pos=d.pos(this.cnv);this.cnv.parentNode.style._position=this.cnv.parentNode.style.position;this.cnv.parentNode.style.position="relative";this.cnv.parentNode.appendChild(h);for(var g=0,e=["top","right","bottom","left"];g<e.length;g++){h["b"+e[g]]=parseInt(d.style(h,"border-"+e[g]+"-width"));h["b"+e[g]]=(!isNaN(h["b"+e[g]])&&h["b"+e[g]]>0?h["b"+e[g]]:0)}h.borderLeft=h.bleft;h.borderTop=h.btop;h.borderRight=h.bright;h.borderBottom=h.bbottom}}}(window));