var mp3Encoder;var mp3Buffer=[];onmessage=function(a){switch(a.data.action){case"init":init(a.data);break;case"start":start();break;case"record":record(a.data);break;case"stop":stop();break}};function init(d){var a=d.channels||1;var c=d.sampleRate||44100;var b=d.bitRate||128;if(d.type==="audio/mp3"){importScripts("/bitrix/js/main/recorder/lame.min.js");mp3Encoder=new lamejs.Mp3Encoder(a,c,b)}}function start(){mp3Buffer=[]}function record(c){var a=floatTo16BitPCM(c.input);var b=mp3Encoder.encodeBuffer(a);mp3Buffer.push(b)}function stop(){mp3Buffer.push(mp3Encoder.flush);var a=new Blob(mp3Buffer,{type:"audio/mpeg"});postMessage({action:"result",result:a});mp3Buffer=[]}function floatTo16BitPCM(b){var d=b.length;var a=new Int16Array(d);var e;for(var c=0;c<d;c++){if(b[c]>1){e=1}else{if(b[c]<-1){e=-1}else{e=b[c]}}a[c]=(e>0?e*32767:e*32768)}return a};