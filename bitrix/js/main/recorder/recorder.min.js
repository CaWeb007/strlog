(function(b){if(typeof(BX.Recorder)!=="undefined"){return}var c={"audio/mp3":true};var a={idle:0,recording:1,paused:2};BX.Recorder=function(e,d){if(!e instanceof b.MediaStream){throw"stream must be of type MediaStream"}if(!BX.type.isPlainObject(d)){d={}}this.stream=e;this.options={type:(d.type&&BX.Recorder.isTypeSupported(d.type)?d.type:"audio/mp3")};this.state=a.idle;this.audioContext=null;this.mediaStreamNode=null;this.scriptNode=null;this.worker=new b.Worker("/bitrix/js/main/recorder/encoder.js");this.worker.postMessage({action:"init",type:this.options.type});this.worker.onmessage=function(f){switch(f.data.action){case"result":BX.onCustomEvent(this,"stop",[f.data.result]);break}}.bind(this)};BX.Recorder.isSupported=function(){return(typeof(b.Blob)!=="undefined"&&typeof(b.Worker)!=="undefined"&&typeof(b.URL)!=="undefined"&&typeof(b.MediaStream)!=="undefined"&&(typeof(b.AudioContext)!=="undefined"||typeof(b.webkitAudioContext)!=="undefined"))};BX.Recorder.isTypeSupported=function(d){return(c[d]===true)};BX.Recorder.prototype.start=function(){var d=this;if(this.state!==a.idle){throw"recording can not be started right now"}this.audioContext=new (b.AudioContext||b.webkitAudioContext)();this.scriptNode=this.audioContext.createScriptProcessor(16384,1,1);this.scriptNode.connect(this.audioContext.destination);this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.stream);this.mediaStreamNode.connect(this.scriptNode);this.scriptNode.onaudioprocess=function(f){if(d.state!==a.recording){return}if(!d.worker){return}var e=f.inputBuffer.getChannelData(0);d.worker.postMessage({action:"record",input:e})};d.worker.postMessage({action:"start"});this.state=a.recording};BX.Recorder.prototype.stop=function(){if(this.state!==a.recording){throw"recording can not be stopped right now"}this.worker.postMessage({action:"stop"});if(this.scriptNode){this.scriptNode.disconnect()}if(this.mediaStreamNode){this.mediaStreamNode.disconnect()}if(this.audioContext){this.audioContext.close()}this.scriptNode=null;this.mediaStreamNode=null;this.audioContext=null;this.state=a.idle};BX.Recorder.prototype.pause=function(){if(this.state!==a.recording){throw"recording can not be paused right now"}this.state=a.paused};BX.Recorder.prototype.resume=function(){if(this.state!==a.paused){throw"recording can not be resumed right now"}this.state=a.recording};BX.Recorder.prototype.replaceStream=function(d){if(!d instanceof b.MediaStream){throw"stream must be of type MediaStream"}this.stream=d;this.mediaStreamNode.disconnect();this.mediaStreamNode=this.audioContext.createMediaStreamSource(this.stream);this.mediaStreamNode.connect(this.scriptNode)};BX.Recorder.prototype.getState=function(){return this.state};BX.Recorder.prototype.dispose=function(){this.stream=null}})(window);