(function(){BX.namespace("BX.Kanban");BX.Kanban.Grid=function(b){if(!BX.type.isPlainObject(b)){throw new Error("BX.Kanban.Grid: 'options' is not an object.")}this.options=b;if(!BX.type.isDomNode(b.renderTo)){throw new Error("BX.Kanban.Grid: 'renderTo' is not a DOMNode.")}this.renderTo=b.renderTo;this.rendered=false;this.layout={outerContainer:null,innerContainer:null,gridContainer:null,earLeft:null,earRight:null,emptyStub:null,loader:null};this.itemType=this.getItemType(b.itemType);this.columnType=this.getColumnType(b.columnType);this.messages=BX.type.isPlainObject(b.messages)?b.messages:Object.create(null);this.columns=Object.create(null);this.columnsOrder=[];this.items=Object.create(null);this.data=BX.type.isPlainObject(b.data)?b.data:Object.create(null);this.bgColor=BX.Kanban.Utils.isValidColor(b.bgColor)||b.bgColor==="transparent"?b.bgColor:"ffffff";this.earTimer=null;this.dragMode=BX.Kanban.DragMode.NONE;this.canAddColumn=false;this.canEditColumn=false;this.canSortColumn=false;this.canRemoveColumn=false;this.canAddItem=false;this.canSortItem=false;this.dropZoneArea=new BX.Kanban.DropZoneArea(this,{dropZoneType:b.dropZoneType,dropZoneTimeout:b.dropZoneTimeout});this.data=Object.create(null);this.setData(b.data);this.loadData(b);if(b.events){for(var a in b.events){if(b.events.hasOwnProperty(a)){BX.addCustomEvent(this,a,b.events[a])}}}BX.addCustomEvent(this,"Kanban.Grid:onItemDragStart",BX.delegate(this.onItemDragStart,this));BX.addCustomEvent(this,"Kanban.Grid:onItemDragStop",BX.delegate(this.onItemDragStop,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnDragStart",BX.delegate(this.onColumnDragStart,this));BX.addCustomEvent(this,"Kanban.Grid:onColumnDragStop",BX.delegate(this.onColumnDragStop,this))};BX.Kanban.DragMode={NONE:0,ITEM:1,COLUMN:2};BX.Kanban.Grid.prototype={addColumn:function(b){b=b||{};if(this.getColumn(b.id)!==null){return null}var c=this.getColumnType(b.type);var e=new c(b);if(!(e instanceof BX.Kanban.Column)){throw new Error("Column type must be an instance of BX.Kanban.Column")}e.setGrid(this);this.columns[e.getId()]=e;var d=this.getColumn(b.targetId);var a=BX.util.array_search(d,this.columnsOrder);if(a>=0){this.columnsOrder.splice(a,0,e)}else{this.columnsOrder.push(e)}if(this.isRendered()){if(d){this.getGridContainer().insertBefore(e.render(),d.getContainer())}else{this.getGridContainer().appendChild(e.render())}}return e},removeColumn:function(a){a=this.getColumn(a);if(!a){return false}this.removeColumnItems(a);this.columnsOrder=this.columnsOrder.filter(function(b){return a!==b});delete this.columns[a.getId()];BX.remove(a.getContainer());return true},updateColumn:function(b,a){b=this.getColumn(b);if(!b){return false}b.setOptions(a);b.render();return true},getNextColumnSibling:function(a){var c=this.getColumnIndex(a);var b=this.getColumns();return c!==-1&&b[c+1]?b[c+1]:null},getPreviousColumnSibling:function(a){var c=this.getColumnIndex(a);var b=this.getColumns();return c>0&&b[c-1]?b[c-1]:null},addItem:function(a){a=a||{};var b=this.getColumn(a.columnId);if(!b){return null}var e=this.getItemType(a.type);var c=new e(a);if(!(c instanceof BX.Kanban.Item)){throw new Error("Item type must be an instance of BX.Kanban.Item")}if(this.items[c.getId()]){return null}c.setGrid(this);this.items[c.getId()]=c;var d=this.getItem(a.targetId);b.addItem(c,d);return c},removeItem:function(c){var b=this.getItem(c);if(b){var a=b.getColumn();delete this.items[b.getId()];a.removeItem(b);b.dispose()}return b},removeColumnItems:function(b){b=this.getColumn(b);var a=b.getItems();b.removeItems();a.forEach(function(c){this.removeItem(c)},this)},removeItems:function(){this.getColumns().forEach(function(a){this.removeColumnItems(a)},this)},updateItem:function(b,a){b=this.getItem(b);if(!b){return false}if(BX.Kanban.Utils.isValidId(a.columnId)&&a.columnId!==b.getColumn().getId()){this.moveItem(b,this.getColumn(a.columnId),this.getItem(a.targetId))}b.setOptions(a);b.render();return true},hideItem:function(a){a=this.getItem(a);if(!a||!a.isVisible()){return false}a.setOptions({visible:false});if(a.isCountable()){a.getColumn().decrementTotal()}a.getColumn().render();return true},unhideItem:function(a){a=this.getItem(a);if(!a||a.isVisible()){return false}a.setOptions({visible:true});if(a.isCountable()){a.getColumn().incrementTotal()}a.getColumn().render();return true},getColumn:function(a){var b=a instanceof BX.Kanban.Column?a.getId():a;return this.columns[b]?this.columns[b]:null},getColumns:function(){return this.columnsOrder},getColumnsCount:function(){return this.columnsOrder.length},getColumnIndex:function(a){a=this.getColumn(a);return BX.util.array_search(a,this.getColumns())},getItem:function(a){var b=a instanceof BX.Kanban.Item?a.getId():a;return this.items[b]?this.items[b]:null},getItemByElement:function(a){if(BX.type.isDomNode(a)&&a.dataset.id&&a.dataset.type==="item"){return this.getItem(a.dataset.id)}return null},getItems:function(){return this.items},getItemType:function(b){var a=BX.Kanban.Utils.getClass(b);if(BX.type.isFunction(a)){return a}return this.itemType||BX.Kanban.Item},getColumnType:function(b){var a=BX.Kanban.Utils.getClass(b);if(BX.type.isFunction(a)){return a}return this.columnType||BX.Kanban.Column},getDropZoneArea:function(){return this.dropZoneArea},getData:function(){return this.data},setData:function(a){if(BX.type.isPlainObject(a)){this.data=a}},getBgColor:function(){return this.bgColor},getBgColorStyle:function(){return this.getBgColor()==="transparent"?this.getBgColor():"#"+this.getBgColor()},getOptions:function(){return this.options},loadData:function(b){var c=this.isRendered();this.setRenderStatus(false);var a=["canAddColumn","canEditColumn","canSortColumn","canRemoveColumn","canAddItem","canSortItem"];a.forEach(function(d){if(BX.type.isBoolean(b[d])){this[d]=b[d]}},this);if(BX.type.isArray(b.columns)){b.columns.forEach(function(d){if(d&&BX.Kanban.Utils.isValidId(d.id)&&this.getColumn(d.id)){this.updateColumn(d.id,d)}else{this.addColumn(d)}},this)}if(BX.type.isArray(b.items)){b.items.forEach(function(d){if(d&&BX.Kanban.Utils.isValidId(d.id)&&this.getItem(d.id)){this.updateItem(d.id,d)}else{this.addItem(d)}},this)}if(BX.type.isArray(b.dropZones)){b.dropZones.forEach(function(d){if(d&&BX.Kanban.Utils.isValidId(d.id)&&this.getDropZoneArea().getDropZone(d.id)){this.getDropZoneArea().updateDropZone(d.id,d)}else{this.getDropZoneArea().addDropZone(d)}},this)}if(c){this.draw()}},draw:function(){var d=document.createDocumentFragment();var b=this.getColumns();for(var a=0;a<b.length;a++){var c=b[a];d.appendChild(c.render())}BX.cleanNode(this.getGridContainer());this.getGridContainer().appendChild(d);this.getDropZoneArea().render();if(!this.isRendered()){this.renderLayout();this.adjustLayout();this.setRenderStatus(true);BX.onCustomEvent(this,"Kanban.Grid:onFirstRender",[this])}else{this.adjustLayout()}this.adjustEmptyStub();BX.onCustomEvent(this,"Kanban.Grid:onRender",[this])},renderLayout:function(){if(this.getOuterContainer().parentNode){return}var a=this.getInnerContainer();a.appendChild(this.getEmptyStub());a.appendChild(this.getLeftEar());a.appendChild(this.getRightEar());a.appendChild(this.getDropZoneArea().getContainer());a.appendChild(this.getLoader());a.appendChild(this.getGridContainer());var b=this.getOuterContainer();b.appendChild(a);this.renderTo.appendChild(this.getOuterContainer());BX.bind(window,"resize",this.adjustLayout.bind(this));BX.bind(window,"scroll",this.adjustHeight.bind(this))},isRendered:function(){return this.rendered},setRenderStatus:function(a){if(BX.type.isBoolean(a)){this.rendered=a}},getLeftEar:function(){if(this.layout.earLeft){return this.layout.earLeft}this.layout.earLeft=BX.create("div",{attrs:{className:"main-kanban-ear-left"},events:{mouseenter:this.scrollToLeft.bind(this),mouseleave:this.stopAutoScroll.bind(this)}});return this.layout.earLeft},getRightEar:function(){if(this.layout.earRight){return this.layout.earRight}this.layout.earRight=BX.create("div",{attrs:{className:"main-kanban-ear-right"},events:{mouseenter:this.scrollToRight.bind(this),mouseleave:this.stopAutoScroll.bind(this)}});return this.layout.earRight},getRenderToContainer:function(){return this.renderTo},getOuterContainer:function(){if(this.layout.outerContainer){return this.layout.outerContainer}this.layout.outerContainer=BX.create("div",{props:{className:"main-kanban"},style:{backgroundColor:this.getBgColorStyle()}});return this.layout.outerContainer},getInnerContainer:function(){if(this.layout.innerContainer){return this.layout.innerContainer}this.layout.innerContainer=BX.create("div",{props:{className:"main-kanban-inner"},style:{backgroundColor:this.getBgColorStyle()}});return this.layout.innerContainer},getGridContainer:function(){if(this.layout.gridContainer){return this.layout.gridContainer}this.layout.gridContainer=BX.create("div",{props:{className:"main-kanban-grid"},events:{scroll:this.adjustEars.bind(this)}});return this.layout.gridContainer},getEmptyStub:function(){if(this.layout.emptyStub){return this.layout.emptyStub}this.layout.emptyStub=BX.create("div",{attrs:{className:"main-kanban-no-data"},children:[BX.create("div",{attrs:{className:"main-kanban-no-data-inner"},children:[BX.create("div",{attrs:{className:"main-kanban-no-data-image"}}),BX.create("div",{attrs:{className:"main-kanban-no-data-text"},text:this.getMessage("NO_DATA")})]})]});return this.layout.emptyStub},getLoader:function(){if(this.layout.loader){return this.layout.loader}this.layout.loader=BX.create("div",{props:{className:"main-kanban-loader-container"},html:'<svg class="main-kanban-loader-circular" viewBox="25 25 50 50"><circle class="main-kanban-loader-path" cx="50" cy="50" r="20" fill="none" stroke-miterlimit="10"/></svg>'});return this.layout.loader},adjustLayout:function(){this.adjustWidth();this.adjustHeight();this.adjustEars()},adjustEars:function(){var d=this.getGridContainer();var b=d.scrollLeft;var c=b>0;var a=d.scrollWidth>(b+d.offsetWidth);this.getOuterContainer().classList[c?"add":"remove"]("main-kanban-left-ear-shown");this.getOuterContainer().classList[a?"add":"remove"]("main-kanban-right-ear-shown")},adjustWidth:function(){this.getOuterContainer().style.width=this.renderTo.offsetWidth+"px"},adjustHeight:function(){var c=this.getOuterContainer();var b=this.getInnerContainer();if(c.getBoundingClientRect().top>=15){var a=document.documentElement.clientHeight-b.getBoundingClientRect().top;b.style.height=a+"px";if(b.classList.contains("main-kanban-fixed")){BX.onCustomEvent(this,"Kanban.Grid:onFixedModeEnd",[this])}c.style.minHeight=document.documentElement.clientHeight+"px";b.style.removeProperty("top");b.style.removeProperty("left");b.style.removeProperty("width");b.classList.remove("main-kanban-fixed")}else{if(!b.classList.contains("main-kanban-fixed")){BX.onCustomEvent(this,"Kanban.Grid:onFixedModeStart",[this])}var d=this.renderTo.getBoundingClientRect();b.style.left=d.left+"px";b.style.width=d.width+"px";b.style.removeProperty("height");b.classList.add("main-kanban-fixed")}},adjustEmptyStub:function(){var a=true;var b=this.getItems();for(var d in b){var c=b[d];if(c.isVisible()){a=false;break}}this.getInnerContainer().classList[a?"add":"remove"]("main-kanban-no-data-mode")},moveItem:function(d,c,b){d=this.getItem(d);c=this.getColumn(c);b=this.getItem(b);if(!d||!c||d===b){return false}var a=d.getColumn();a.removeItem(d);c.addItem(d,b);return true},moveColumn:function(d,c){d=this.getColumn(d);c=this.getColumn(c);if(!d||d===c){return false}var b=BX.util.array_search(d,this.columnsOrder);this.columnsOrder.splice(b,1);var a=BX.util.array_search(c,this.columnsOrder);if(a>=0){this.columnsOrder.splice(a,0,d);if(this.isRendered()){d.getContainer().parentNode.insertBefore(d.getContainer(),c.getContainer())}}else{this.columnsOrder.push(d);if(this.isRendered()){d.getContainer().parentNode.appendChild(d.getContainer())}}return true},canAddColumns:function(){return this.canAddColumn},canEditColumns:function(){return this.canEditColumn},canSortColumns:function(){return this.canSortColumn},canRemoveColumns:function(){return this.canRemoveColumn},canAddItems:function(){return this.canAddItem},canSortItems:function(){return this.canSortItem},scrollToRight:function(){this.earTimer=setInterval(function(){this.getGridContainer().scrollLeft+=10}.bind(this),20)},scrollToLeft:function(){this.earTimer=setInterval(function(){this.getGridContainer().scrollLeft-=10}.bind(this),20)},stopAutoScroll:function(){clearInterval(this.earTimer);jsDD.refreshDestArea()},getDragMode:function(){return this.dragMode},getDragModeCode:function(b){for(var a in BX.Kanban.DragMode){if(BX.Kanban.DragMode[a]===b){return a}}return null},setDragMode:function(b){var a=this.getDragModeCode(b);if(a!==null){this.getOuterContainer().classList.add("main-kanban-drag-mode-"+a.toLowerCase());this.dragMode=b}},resetDragMode:function(){var a=this.getDragModeCode(this.getDragMode());if(a!==null){this.getOuterContainer().classList.remove("main-kanban-drag-mode-"+a.toLowerCase())}this.dragMode=BX.Kanban.DragMode.NONE},onItemDragStart:function(b){this.setDragMode(BX.Kanban.DragMode.ITEM);var a=this.getItems();for(var c in a){a[c].enableDropping()}this.getColumns().forEach(function(d){d.enableDropping()});this.getDropZoneArea().emptyAll();this.getDropZoneArea().show()},onItemDragStop:function(a){this.resetDragMode();this.getDropZoneArea().hide()},onColumnDragStart:function(a){this.setDragMode(BX.Kanban.DragMode.COLUMN)},onColumnDragStop:function(a){this.resetDragMode()},getEventPromise:function(b,a,g,c){var e=[];a=BX.type.isArray(a)?a:[];BX.onCustomEvent(this,b,[e].concat(a));var f=new BX.Promise();var h=f;for(var d=0;d<e.length;d++){f=f.then(e[d])}f.then(BX.type.isFunction(g)?g:null,BX.type.isFunction(c)?c:null);return h},fadeOut:function(){this.getOuterContainer().classList.add("main-kanban-faded")},fadeIn:function(){this.getOuterContainer().classList.remove("main-kanban-faded")},getMessage:function(a){return a in this.messages?this.messages[a]:BX.message("MAIN_KANBAN_"+a)}};BX.Kanban.DragEvent=function(a){this.item=null;this.targetColumn=null;this.targetItem=null;this.action=true};BX.Kanban.DragEvent.prototype={allowAction:function(){this.action=true},denyAction:function(){this.action=false},isActionAllowed:function(){return this.action},setItem:function(a){this.item=a},getItem:function(){return this.item},setTargetItem:function(a){this.targetItem=a},getTargetItem:function(){return this.targetItem},setTargetColumn:function(a){this.targetColumn=a},getTargetColumn:function(){return this.targetColumn}}})();