(function(){BX.namespace("BX.Kanban");BX.Kanban.Item=function(a){if(!BX.type.isPlainObject(a)){throw new Error("BX.Kanban.Item: 'options' is not an object.")}this.options=a;if(!BX.Kanban.Utils.isValidId(a.id)){throw new Error("BX.Kanban.Item: 'id' parameter is not valid.")}this.id=a.id;this.grid=null;this.columnId=null;this.layout={container:null,dragTarget:null,bodyContainer:null};this.dragElement=null;this.draggable=true;this.droppable=true;this.countable=true;this.visible=true;this.data=Object.create(null);this.setOptions(a)};BX.Kanban.Item.prototype={getId:function(){return this.id},getColumnId:function(){return this.columnId},setColumnId:function(a){this.columnId=a},getColumn:function(){if(this.getGrid()){return this.getGrid().getColumn(this.getColumnId())}return null},setGrid:function(a){if(a instanceof BX.Kanban.Grid){this.grid=a}},getGrid:function(){return this.grid},setOptions:function(a){if(!a){return}this.setData(a.data);this.droppable=BX.type.isBoolean(a.droppable)?a.droppable:this.droppable;this.draggable=BX.type.isBoolean(a.draggable)?a.draggable:this.draggable;this.countable=BX.type.isBoolean(a.countable)?a.countable:this.countable;this.visible=BX.type.isBoolean(a.visible)?a.visible:this.visible},getData:function(){return this.data},setData:function(a){if(BX.type.isPlainObject(a)){this.data=a}},isCountable:function(){return this.countable},isVisible:function(){return this.visible},getGridData:function(){return this.getGrid().getData()},renderLayout:function(){var a=this.getBodyContainer();BX.cleanNode(a);a.appendChild(this.render());return this.getContainer()},getContainer:function(){if(this.layout.container!==null){return this.layout.container}this.layout.container=BX.create("div",{attrs:{className:"main-kanban-item","data-id":this.getId(),"data-type":"item"},children:[this.getDragTarget(),this.getBodyContainer()]});this.makeDraggable();this.makeDroppable();return this.layout.container},getDragTarget:function(){if(!this.layout.dragTarget){this.layout.dragTarget=BX.create("div",{attrs:{className:"main-kanban-item-drag-target"}})}return this.layout.dragTarget},getDragElement:function(){return this.dragElement},getBodyContainer:function(){if(!this.layout.bodyContainer){this.layout.bodyContainer=BX.create("div",{attrs:{className:"main-kanban-item-wrapper"}})}return this.layout.bodyContainer},render:function(){if(!this.layout.content){this.layout.content=BX.create("div",{props:{className:"main-kanban-item-default"}})}this.layout.content.style.borderLeft="2px solid #"+this.getColumn().getColor();this.layout.content.textContent="#"+this.getId();return this.layout.content},dispose:function(){jsDD.unregisterDest(this.getContainer());jsDD.unregisterObject(this.getContainer())},makeDraggable:function(){if(!this.isDraggable()){return}var a=this.getContainer();a.onbxdragstart=BX.delegate(this.onDragStart,this);a.onbxdrag=BX.delegate(this.onDrag,this);a.onbxdragstop=BX.delegate(this.onDragStop,this);jsDD.registerObject(a)},makeDroppable:function(){if(!this.isDroppable()){return}var a=this.getContainer();a.onbxdestdraghover=BX.delegate(this.onDragEnter,this);a.onbxdestdraghout=BX.delegate(this.onDragLeave,this);a.onbxdestdragfinish=BX.delegate(this.onDragDrop,this);a.onbxdestdragstop=BX.delegate(this.onItemDragEnd,this);jsDD.registerDest(a,30);if(this.getGrid().getDragMode()!==BX.Kanban.DragMode.ITEM){this.disableDropping()}},disableDragging:function(){if(this.isDraggable()){jsDD.unregisterObject(this.getContainer())}},enableDragging:function(){if(this.isDraggable()){jsDD.registerObject(this.getContainer())}},disableDropping:function(){if(this.isDroppable()){jsDD.disableDest(this.getContainer())}},enableDropping:function(){if(this.isDroppable()){jsDD.enableDest(this.getContainer())}},isDraggable:function(){return this.draggable&&this.getGrid().canSortItems()},isDroppable:function(){return this.droppable},onDragStart:function(){this.getContainer().classList.add("main-kanban-item-disabled");if(!this.dragElement){var a=this.getContainer();var b=this.getBodyContainer();this.dragElement=a.cloneNode(true);this.dragElement.style.position="absolute";this.dragElement.style.width=b.offsetWidth+"px";this.dragElement.className="main-kanban-item main-kanban-item-drag";document.body.appendChild(this.dragElement)}BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStart",[this])},onDragStop:function(a,b){BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStop",[this]);this.getContainer().classList.remove("main-kanban-item-disabled");BX.remove(this.dragElement);this.dragElement=null},onDrag:function(a,b){if(this.dragElement){this.dragElement.style.left=a+"px";this.dragElement.style.top=b+"px"}},onDragEnter:function(d,b,c){var a=this.getGrid().getItemByElement(d);if(a!==this){this.showDragTarget(a.getBodyContainer().offsetHeight)}},onDragLeave:function(c,a,b){this.hideDragTarget()},onDragDrop:function(f,b,e){this.hideDragTarget();var a=this.getGrid().getItemByElement(f);var c=new BX.Kanban.DragEvent();c.setItem(a);c.setTargetColumn(this.getColumn());c.setTargetItem(this);BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onBeforeItemMoved",[c]);if(!c.isActionAllowed()){return}var d=this.getGrid().moveItem(a,this.getColumn(),this);if(d){BX.onCustomEvent(this.getGrid(),"Kanban.Grid:onItemMoved",[a,this.getColumn(),this])}},onItemDragEnd:function(c,a,b){this.disableDropping()},showDragTarget:function(a){this.getContainer().classList.add("main-kanban-item-target-shown");this.getDragTarget().style.height=a+"px"},hideDragTarget:function(){this.getContainer().classList.remove("main-kanban-item-target-shown");this.getDragTarget().style.removeProperty("height")}};BX.Kanban.DraftItem=function(a){BX.Kanban.Item.apply(this,arguments);this.asyncEventStarted=false;this.draftContainer=null;this.draftTextArea=null};BX.Kanban.DraftItem.prototype={__proto__:BX.Kanban.Item.prototype,constructor:BX.Kanban.DraftItem,render:function(){if(this.draftContainer){return this.draftContainer}this.draftContainer=BX.create("div",{props:{className:"main-kanban-item-draft"},children:[this.getDraftTextArea()]});return this.draftContainer},setGrid:function(a){BX.Kanban.Item.prototype.setGrid.apply(this,arguments);BX.addCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStart",BX.proxy(this.applyDraftEditMode,this))},getDraftTextArea:function(){if(this.draftTextArea){return this.draftTextArea}this.draftTextArea=BX.create("textarea",{attrs:{className:"main-kanban-item-draft-textarea",placeholder:this.getGrid().getMessage("ITEM_TITLE_PLACEHOLDER")},events:{blur:this.handleDraftTextAreaBlur.bind(this),keydown:this.handleDraftTextAreaKeyDown.bind(this)}});return this.draftTextArea},applyDraftEditMode:function(){if(this.asyncEventStarted){return}this.asyncEventStarted=true;var b=BX.util.trim(this.getDraftTextArea().value);if(!b.length){this.removeDraftItem();return}this.setData({title:b});this.getContainer().classList.add("main-kanban-item-draft-disabled");this.getDraftTextArea().disabled=true;var a=this.getGrid().getEventPromise("Kanban.Grid:onItemAddedAsync",null,this.onItemAddedFulfilled.bind(this),this.onItemAddedRejected.bind(this));a.fulfill(this)},onItemAddedFulfilled:function(b){if(!BX.type.isPlainObject(b)){this.removeDraftItem();return}if(!BX.Kanban.Utils.isValidId(b.targetId)){var e=this.getColumn().getNextItemSibling(this);if(e){b.targetId=e.getId()}}this.removeDraftItem();var d=this.getGrid().addItem(b);if(d&&this.getGrid().getDragMode()===BX.Kanban.DragMode.NONE){var c=this.getGrid().getColumns().some(function(f){return f.getDraftItem()!==null});if(!c){var a=d.getColumn().getNextItemSibling(d);d.getColumn().addDraftItem(a)}}},onItemAddedRejected:function(a){this.removeDraftItem()},removeDraftItem:function(){this.asyncEventStarted=true;BX.removeCustomEvent(this.getGrid(),"Kanban.Grid:onItemDragStart",BX.proxy(this.applyDraftEditMode,this));this.getColumn().removeDraftItem()},focusDraftTextArea:function(){this.getDraftTextArea().focus()},handleDraftTextAreaBlur:function(a){setTimeout(function(){this.applyDraftEditMode()}.bind(this),0)},handleDraftTextAreaKeyDown:function(a){if(a.keyCode===13){this.applyDraftEditMode()}else{if(a.keyCode===27){this.removeDraftItem()}}}}})();