AmCharts.AmExport=AmCharts.Class({construct:function(b,a){var c=this;c.DEBUG=false;c.chart=b;c.canvas=null;c.svgs=[];c.cfg={menuTop:"auto",menuLeft:"auto",menuRight:"0px",menuBottom:"0px",menuItems:[{textAlign:"center",icon:c.chart.pathToImages+"export.png",iconTitle:"Save chart as an image",format:"png"}],menuItemStyle:{backgroundColor:"transparent",rollOverBackgroundColor:"#EFEFEF",color:"#000000",rollOverColor:"#CC0000",paddingTop:"6px",paddingRight:"6px",paddingBottom:"6px",paddingLeft:"6px",marginTop:"0px",marginRight:"0px",marginBottom:"0px",marginLeft:"0px",textAlign:"left",textDecoration:"none",fontFamily:c.chart.fontFamily,fontSize:c.chart.fontSize+"px"},menuItemOutput:{backgroundColor:"#FFFFFF",fileName:"amChart",format:"png",output:"dataurlnewwindow",render:"browser",dpi:90,onclick:function(d,e,f){d.output(e)}},removeImagery:true};c.processing={buffer:[],drawn:0,timer:0};if(typeof(window.canvg)!="undefined"&&typeof(window.RGBColor)!="undefined"){c.cfg.menuItemOutput.render="canvg"}if(typeof(window.saveAs)!="undefined"){c.cfg.menuItemOutput.output="save"}if(AmCharts.isIE&&AmCharts.IEversion<10){c.cfg.menuItemOutput.output="dataurlnewwindow"}if(a){a.menuItemOutput=AmCharts.extend(c.cfg.menuItemOutput,a.menuItemOutput||{});a.menuItemStyle=AmCharts.extend(c.cfg.menuItemStyle,a.menuItemStyle||{});c.cfg=AmCharts.extend(c.cfg,a)}c.chart.AmExport=c;c.chart.addListener("rendered",function(){c.setup()});if(c.DEBUG){window.AmExport=c}},log:function(){console.log("AmExport: ",arguments)},setup:function(){var a=this;if(a.DEBUG==10){a.log("SETUP START")}if(!AmCharts.isIE||(AmCharts.isIE&&AmCharts.IEversion>9)){window.clearTimeout(a.processing.timer);a.processing.timer=setTimeout(function(){a.polifySVG();a.generateButtons();if(a.DEBUG==10){a.log("SETUP END")}},1000)}else{if(a.DEBUG==10){a.log("< IE10 NOT SUPPORTED")}}},generateBinaryArray:function(l){var h=l.length,e=new Uint8Array(h/4*3|0),g=0,k=0,m=[0,0],a=0,j=0,f,b,c,d=new Uint8Array([62,-1,-1,-1,63,52,53,54,55,56,57,58,59,60,61,-1,-1,-1,0,-1,-1,-1,0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,-1,-1,-1,-1,-1,-1,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51]);while(h--){b=l.charCodeAt(g++);f=d[b-43];if(f!==255&&f!==c){m[1]=m[0];m[0]=b;j=(j<<6)|f;a++;if(a===4){e[k++]=j>>>16;if(m[1]!==61){e[k++]=j>>>8}if(m[0]!==61){e[k++]=j}a=0}}}return e},generateBlob:function(e,c){var g=this,a=e.indexOf(",")+1,f=e.substring(0,a),d=e,b=new Blob();if(f.indexOf("base64")!=-1){d=g.generateBinaryArray(e.substring(a))}if(AmCharts.isIE&&AmCharts.IEversion<10){b.data=d;b.size=d.length;b.type=c;b.encoding="base64"}else{b=new Blob([d],{type:c})}return b},generatePDF:function(c){var f=this,b={output:function(){return""}},e=f.canvas.toDataURL("image/jpeg"),d=(f.canvas.width*25.4)/c.dpi,a=(f.canvas.height*25.4)/c.dpi;if(window.jsPDF){b=new jsPDF();if(b.addImage){b.addImage(e,"JPEG",0,0,d,a)}else{alert("Missing jsPDF plugin; Please add the 'addImage' plugin.")}}else{alert("Missing jsPDF lib; Don't forget to add the addImage plugin.")}return b},output:function(a,c){var d=this;a=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemOutput),a||{});function b(){var g=null;var e;if(d.DEBUG==10){d.log("OUTPUT",format)}if(a.format=="image/svg+xml"||a.format=="svg"){for(var f=0;f<d.processing.buffer.length;f++){g=new XMLSerializer().serializeToString(d.processing.buffer[f][0]);e=d.generateBlob(g,"image/svg+xml");if(a.output=="save"){saveAs(e,a.fileName+".svg")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e="data:image/svg+xml;base64,"+btoa(g)}else{if(a.output=="dataurlnewwindow"){window.open("data:image/svg+xml;base64,"+btoa(g))}else{if(a.output=="datauri"||a.output=="dataurl"){location.href="data:image/svg+xml;base64,"+btoa(g)}else{if(a.output=="datastream"){location.href="data:image/octet-stream;base64,"+btoa(g)}}}}}if(c){c.apply(d,[e])}}}else{if(a.format=="application/pdf"||a.format=="pdf"){g=d.generatePDF(a).output("dataurlstring");e=d.generateBlob(g,"application/pdf");if(a.output=="save"){saveAs(e,a.fileName+".pdf")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=g}else{if(a.output=="dataurlnewwindow"){window.open(g)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=g}else{if(a.output=="datastream"){location.href=g.replace("application/pdf","application/octet-stream")}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="image/png"||a.format=="png"){g=d.canvas.toDataURL("image/png");e=d.generateBlob(g,"image/png");if(a.output=="save"){saveAs(e,a.fileName+".png")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=g}else{if(a.output=="dataurlnewwindow"){window.open(g)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=g}else{if(a.output=="datastream"){location.href=g.replace("image/png","image/octet-stream")}}}}}if(c){c.apply(d,[e])}}else{if(a.format=="image/jpeg"||a.format=="jpeg"||a.format=="jpg"){g=d.canvas.toDataURL("image/jpeg");e=d.generateBlob(g,"image/jpeg");if(a.output=="save"){saveAs(e,a.fileName+".jpg")}else{if(a.output=="datastring"||a.output=="datauristring"||a.output=="dataurlstring"){e=g}else{if(a.output=="dataurlnewwindow"){window.open(g)}else{if(a.output=="datauri"||a.output=="dataurl"){location.href=g}else{if(a.output=="datastream"){location.href=g.replace("image/jpeg","image/octet-stream")}}}}}if(c){c.apply(d,[e])}}}}}}return d.generateOutput(a,b)},polifySVG:function(){var e=this;var d=e.chart.div.getElementsByTagName("svg");function c(j,f){var h=j.getElementsByTagName(f);for(var l=0;l<h.length;l++){if(e.cfg.removeImagery){h[l].parentNode.removeChild(h[l])}else{var n=document.createElement("img");var k=document.createElement("canvas");var g=k.getContext("2d");k.width=h[l].getAttribute("width");k.height=h[l].getAttribute("height");n.src=h[l].getAttribute("xlink:href");n.width=h[l].getAttribute("width");n.height=h[l].getAttribute("height");try{g.drawImage(n,0,0,n.width,n.height);datastring=k.toDataURL()}catch(m){datastring=n.src;e.log("Tainted canvas, reached browser CORS security; origin from imagery must be equal to the server!");throw new Error(m)}h[l].setAttribute("xlink:href",datastring)}if(e.DEBUG==10){e.log("POLIFIED",h[l])}}}for(var a=0;a<d.length;a++){var b=d[a].parentNode;if(e.DEBUG==10){e.log("POLIFIED",d[a])}c(d[a],"pattern");c(d[a],"image");e.svgs.push(d[a])}return d},generateOutput:function(h,l){var g=this,k=g.chart.div.getElementsByTagName("svg"),c=document.createElement("canvas"),b=c.getContext("2d"),d={y:0,x:0},f={};g.processing.buffer=[];g.processing.drawn=0;g.canvas=c;if(g.DEBUG==10){g.log("START EXPORT")}if(g.DEBUG==10){g.log("START BUFFERING")}for(var e=0;e<k.length;e++){var j=k[e].parentNode,n=Number(j.style.left.slice(0,-2)),m=Number(j.style.top.slice(0,-2));f=AmCharts.extend({},d);d.x=n?n:d.x;d.y=m?m:d.y;g.processing.buffer.push([k[e],AmCharts.extend({},d)]);if(m&&n){d=f}else{d.y+=m?0:j.offsetHeight}if(g.DEBUG==10){g.log("BUFFERED",k[e],d)}}if(g.DEBUG==10){g.log("END BUFFERING")}if(g.DEBUG==10){g.log("START DRAWING",h.render)}if(g.DEBUG==10){g.log("FILL BACKGROUND")}c.id=AmCharts.getUniqueId();c.width=g.chart.divRealWidth;c.height=g.chart.divRealHeight;if(h.backgroundColor||format=="image/jpeg"){b.fillStyle=h.backgroundColor||"#FFFFFF";b.fillRect(0,0,c.width,c.height)}function a(){var o,i,q,p;if(g.processing.buffer.length==g.processing.drawn){if(g.DEBUG==10){g.log("END DRAWING")}return l()}else{if(g.DEBUG==10){g.log("DRAW",g.processing.drawn+1,"OF",g.processing.buffer.length)}i=g.processing.buffer[g.processing.drawn];p=new XMLSerializer().serializeToString(i[0]);q=i[1];if(g.DEBUG==10){g.log("SOURCE",p)}if(h.render=="browser"){o=new Image();o.id=AmCharts.getUniqueId();p="data:image/svg+xml;base64,"+btoa(p);o.onload=function(){b.drawImage(this,i[1].x,i[1].y);g.processing.drawn++;if(g.DEBUG==10){g.log("ONLOAD",this)}a()};o.onerror=function(){if(g.DEBUG==10){g.log("ONERROR",this)}b.drawImage(this,i[1].x,i[1].y);g.processing.drawn++;a()};o.src=p;if(g.DEBUG==10){g.log("ADD",o)}if(o.complete||typeof(o.complete)=="undefined"||o.complete===undefined){if(g.DEBUG==10){g.log("FORCE ONLOAD",o)}o.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";o.src=p}}else{if(h.render=="canvg"){canvg(c,p,{offsetX:q.x,offsetY:q.y,ignoreMouse:true,ignoreAnimation:true,ignoreDimensions:true,ignoreClear:true,renderCallback:function(){g.processing.drawn++;a()}})}}}}return a()},generateButtons:function(){var d=this,c=document.createElement("div"),a=0;function b(k){var j=document.createElement("ul");j.setAttribute("style","list-style: none; margin: 0; padding: 0;");for(var f=0;f<k.length;f++){var m=document.createElement("li"),g=document.createElement("img"),l=document.createElement("a"),n=k[f],e=null,h=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemStyle),k[f]);n=AmCharts.extend(AmCharts.extend({},d.cfg.menuItemOutput),n);if(n.icon){g.alt="";g.src=n.icon;g.setAttribute("style","margin: 0 auto;border: none;outline: none");if(n.iconTitle){g.title=n.iconTitle}l.appendChild(g)}l.href="#";if(n.title){g.setAttribute("style","margin-right: 5px;");l.innerHTML+=n.title}l.setAttribute("style","display: block;");AmCharts.extend(l.style,h);l.onclick=n.onclick.bind(l,d,n);m.appendChild(l);if(n.items){e=b(n.items);m.appendChild(e);m.onmouseover=function(){e.style.display="block"};m.onmouseout=function(){e.style.display="none"};e.style.display="none"}j.appendChild(m);l.onmouseover=function(){this.style.backgroundColor=h.rollOverBackgroundColor;this.style.color=h.rollOverColor;this.style.borderColor=h.rollOverBorderColor};l.onmouseout=function(){this.style.backgroundColor=h.backgroundColor;this.style.color=h.color;this.style.borderColor=h.borderColor}}a++;if(d.DEBUG==10){d.log("MENU",j)}return j}c.setAttribute("style","position: absolute;top:"+d.cfg.menuTop+";right:"+d.cfg.menuRight+";bottom:"+d.cfg.menuBottom+";left:"+d.cfg.menuLeft+";box-shadow:0px 0px 1px 0px rgba(0,0,0,0);");c.appendChild(b(d.cfg.menuItems));d.chart.containerDiv.appendChild(c)}});