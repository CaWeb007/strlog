var BXFileDialog=function(){this.name="BXFileDialog";this.height=476;this.width=750};BXFileDialog.prototype={Open:function(d,a,b){if(!d||!a){alert("Error: Wrong params!");return}if(window.oBXFileDialog&&oBXFileDialog.bOpened){return}this.SetFocus("name");this.oConfig=d;this.UserConfig=a;this.LastSavedConfig={site:this.UserConfig.site,path:this.UserConfig.path,view:this.UserConfig.view,sort:this.UserConfig.sort,sort_order:this.UserConfig.sort_order};this.sessid=d.sessid;this.bSelectFiles=d.select.indexOf("F")!==-1;this.bSelectDirs=d.select.indexOf("D")!==-1;this.RequestUrl=this.GetRequestUrl();this.bOpened=true;var f;var c=(window.fd_float_div_cached&&this.CheckReConfig());if(c){f=document.body.appendChild(window.fd_float_div_cached)}else{if(BX("BX_file_dialog")){this.Close()}f=document.body.appendChild(document.createElement("DIV"));f.id="BX_file_dialog";f.className="editor_dialog";f.style.position="absolute";f.style.zIndex=d.zIndex||2300;f.style.overflow="hidden";f.innerHTML='<div class="title"><table cellspacing="0" width="100%" border="0">	<tr>		<td width="100%" class="title-text" onmousedown="jsFloatDiv.StartDrag(arguments[0], BX(\'BX_file_dialog\'));" id="BX_file_dialog_title">Title</td>		<td width="0%"><a id="BX_file_dialog_close" class="close" href="javascript:oBXFileDialog.Close();" onclick="oBXFileDialog.Close(); return false;"></a></td></tr></table></div><div class="content"></div>'}f.style.width=parseInt(this.width)+"px";f.style.height=parseInt(this.height)+"px";this.floatDiv=f;this.content=jsUtils.FindChildObject(this.floatDiv,"div","content");oDialogTitle=BX("BX_editor_dialog_title");var e=function(k){CloseWaitWindow();if(k){if(k.indexOf("BX_FD_LOAD_OK")==-1){alert(mess_ACCESS_DENIED);return}var h=oBXFileDialog.CheckReqLostSessid(k);if(h!==true){if(b){alert(mess_SESS_EXPIRED);return}document.body.removeChild(f);oBXFileDialog.sessid=h;oBXFileDialog.RequestUrl=oBXFileDialog.GetRequestUrl();oBXFileDialog.Open(d,a,true);return}oBXFileDialog.content.innerHTML=k}var g=jsUtils.GetWindowSize(),j=parseInt(g.scrollLeft+g.innerWidth/2-f.offsetWidth/2),i=parseInt(g.scrollTop+g.innerHeight/2-f.offsetHeight/2);jsFloatDiv.Show(f,j,i);BX.addCustomEvent(window,"onFileDialogLoaded",function(){if(window.oBXDialogTree){oBXDialogTree.SetPath(d.path||a.path||"")}});BX.onCustomEvent(window,"onAfterFileDialogShow")};ShowWaitWindow();this.SetEventHandlers();if(c){this.reConfigDialog();e();return}BX.ajax.get(this.RequestUrl+"&action=start&path="+this.oConfig.path+"&add_to_menu="+(this.oConfig.showAddToMenuTab?"1":""),e)},CheckReConfig:function(){return !(BX.browser.IsIE()||this.oConfig.operation!=window.fd_config_cached.operation||this.oConfig.allowAllFiles!=window.fd_config_cached.allowAllFiles||this.oConfig.select!=window.fd_config_cached.select||this.oConfig.lang!=window.fd_config_cached.lang||this.oConfig.showAddToMenuTab!=window.fd_config_cached.showAddToMenuTab||this.oConfig.showUploadTab!=window.fd_config_cached.showUploadTab||this.oConfig.site!=window.fd_config_cached.site)},reConfigDialog:function(){if(this.oConfig.fileFilter!=window.fd_config_cached.fileFilter){oBXDialogControls.Filter=new __FileFilter()}var a=this.oConfig.path||this.UserConfig.path||"";oBXFileDialog.SubmitFileDialog=SubmitFileDialog;if(this.oConfig.operation=="S"&&this.oConfig.showAddToMenuTab&&!window.oBXMenuHandling){window.oBXMenuHandling=new BXMenuHandling()}oBXDialogTree.SetPath(a)},Close:function(){this.SaveConfig();if(window.oBXFDContextMenu){oBXFDContextMenu.menu.PopupHide()}var a=BX("BX_file_dialog");jsFloatDiv.Close(a);oBXFileDialog.bOpened=false;jsFloatDiv.Close(this.floatDiv);a.parentNode.removeChild(a);window.fd_float_div_cached=this.floatDiv;window.fd_config_cached=this.oConfig;this.UnsetEventHandlers();if(window.fd_site_list&&window.fd_site_list.PopupHide){window.fd_site_list.PopupHide()}},GetRequestUrl:function(a,b){return"/bitrix/admin/file_dialog.php?lang="+this.oConfig.lang+"&operation="+this.oConfig.operation+"&site="+(a||this.oConfig.site)+"&sessid="+(b||this.sessid)+"&get_files="+(this.bSelectFiles?1:"")},CheckReqLostSessid:function(a){var d="BX_FD_DUBLICATE_ACTION_REQUEST",b=a.indexOf(d);if(b==-1){return true}var c=b+d.length;return a.substr(c,a.indexOf("-->")-c)},SaveConfig:function(a){if(!a){a=oBXFileDialog.UserConfig}else{oBXFileDialog.UserConfig=a}if(!this.oConfig.saveConfig||!a||!window.BXFDCompareObj||BXFDCompareObj(this.LastSavedConfig,a)){return}var b=new JCHttpRequest();b.Action=function(c){oBXFileDialog.LastSavedConfig=BXFDCopyObj(a)};b.Send(oBXFileDialog.GetRequestUrl(getSite())+"&action=set_config&path="+jsUtils.urlencode(a.path)+"&view="+a.view+"&sort="+a.sort+"&sort_order="+a.sort_order)},SetFocus:function(a){this.dialogFocus=a},SetEventHandlers:function(){window.BXFD_OnKeyDown=function(a){return oBXFileDialog.OnKeyDown(a)};jsUtils.addEvent(document,"keydown",window.BXFD_OnKeyDown)},UnsetEventHandlers:function(){jsUtils.removeEvent(document,"keydown",window.BXFD_OnKeyDown)},OnKeyDown:function(a){if(!a){a=window.event}if(!a||a.shiftKey||a.ctrlKey||a.altKey){return}if(this.dialogFocus=="tree"){oBXDialogTree.OnKeyDown(a)}else{if(this.dialogFocus=="window"){oBXDialogWindow.OnKeyDown(a)}else{if(a.keyCode==27){this.Close()}if(a.keyCode==13){if(a.target){a.targetElement=a.target}else{if(a.srcElement){a.targetElement=a.srcElement}}if(window.oBXDialogControls&&a.targetElement==oBXDialogControls.dirPath.oInput){oBXDialogTree.SetPath(oBXDialogControls.dirPath.Get())}}}}}};