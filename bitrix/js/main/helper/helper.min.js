BX.namespace("BX.Helper");BX.Helper={frameOpenUrl:"",frameNode:null,openBtn:null,popupLoader:null,langId:null,ajaxUrl:"",currentStepId:"",notifyBlock:null,notifyNum:"",notifyText:"",notifyId:0,notifyButton:"",isAdmin:"N",version:2,init:function(a){this.frameOpenUrl=a.frameOpenUrl||"";this.langId=a.langId||"";this.openBtn=a.helpBtn;this.notifyBlock=a.notifyBlock;this.ajaxUrl=a.ajaxUrl||"";this.currentStepId=a.currentStepId||"";this.notifyData=a.notifyData||null;this.runtimeUrl=a.runtimeUrl||null;this.notifyUrl=a.notifyUrl||"";this.helpUrl=a.helpUrl||"";this.notifyNum=a.notifyNum||"";this.isAdmin=(a.isAdmin&&a.isAdmin==="Y")?"Y":"N";if(this.openBtn){this.openBtn.addEventListener("click",function(){if(BX.Helper.isOpen()){BX.Helper.close()}else{BX.Helper.show()}BX.Helper.setBlueHeroView()})}BX.bind(window,"message",BX.proxy(function(d){if(!!d.origin&&d.origin.indexOf("bitrix")===-1){return}if(!d.data||typeof(d.data)!=="object"){return}if(d.data.action==="CloseHelper"){this.close()}if(d.data.action==="SetCounter"){BX.Helper.showNotification(d.data.num)}if(d.data.action==="GetVersion"){this.frameNode.contentWindow.postMessage({action:"throwVersion",version:this.version},"*")}if(d.data.action==="OpenChat"){BXIM.openMessenger(d.data.user_id)}if(d.data.action==="getMenuStructure"){if(typeof BX.Bitrix24.LeftMenuClass==="object"){if(typeof BX.Bitrix24.LeftMenuClass.getStructureForHelper==="function"){var b=BX.Bitrix24.LeftMenuClass.getStructureForHelper();this.frameNode.contentWindow.postMessage({action:"throwMenu",menu:b},"*")}}}if(d.data.action==="getNewArticleCount"){var c={action:"throwNewArticleCount",articleCount:this.notifyNum};if(this.notifyData){c.lastTimestampCheckNewArticle=this.notifyData.counter_update_date}this.frameNode.contentWindow.postMessage(c,"*")}},this));if(a.needCheckNotify==="Y"){this.checkNotification()}if(this.notifyNum>0){BX.Helper.showNotification(this.notifyNum)}},show:function(b){if(this.isOpen()){return}var a=this.frameOpenUrl+((this.frameOpenUrl.indexOf("?")<0)?"?":"&")+(BX.type.isNotEmptyString(b)?b:"");if(this.getFrame().src!==a){this.getFrame().src=a}BX.SidePanel.Instance.open(this.getSliderId(),{contentCallback:function(c){var d=new BX.Promise();d.fulfill(this.getContent());return d}.bind(this),width:860,cacheable:false,events:{onCloseComplete:function(){BX.Helper.close()},onLoad:function(){BX.Helper.showFrame()},onClose:function(){BX.Helper.frameNode.contentWindow.postMessage({action:"onCloseWidget"},"*")}}});if(this.isAdmin==="N"&&this.openBtn){BX.addClass(this.openBtn,"help-block-active")}},close:function(){BX.SidePanel.Instance.close();if(this.isAdmin==="N"){if(this.openBtn){BX.removeClass(this.openBtn,"help-block-active")}this.getFrame().classList.remove("helper-panel-iframe-show")}},getContent:function(){if(this.content){return this.content}this.content=BX.create("div",{attrs:{className:"helper-container"},children:[this.getLoader(),this.getFrame()]});return this.content},getFrame:function(){if(this.frameNode){return this.frameNode}this.frameNode=BX.create("iframe",{attrs:{className:"helper-panel-iframe",src:"about:blank"}});return this.frameNode},showFrame:function(){setTimeout(function(){this.getFrame().classList.add("helper-panel-iframe-show")}.bind(this),600)},getLoader:function(){if(this.popupLoader){return this.popupLoader}this.popupLoader=BX.create("div",{attrs:{className:"bx-help-popup-loader"},children:[BX.create("div",{attrs:{className:"bx-help-popup-loader-text"},text:BX.message("HELPER_LOADER")})]});return this.popupLoader},getSliderId:function(){return"main:helper"},getSlider:function(){return BX.SidePanel.Instance.getSlider(this.getSliderId())},isOpen:function(){return this.getSlider()&&this.getSlider().isOpen()},setBlueHeroView:function(){if(!this.currentStepId){return}BX.ajax.post(this.ajaxUrl,{sessid:BX.bitrix_sessid(),action:"setView",currentStepId:this.currentStepId},function(){})},showNotification:function(b){if(!isNaN(parseFloat(b))&&isFinite(b)&&b>0){var a='<div class="help-cl-count"><span class="help-cl-count-digit">'+(b>99?"99+":b)+"</span></div>"}else{a=""}this.notifyBlock.innerHTML=a;this.setNotification(b);this.notifyNum=b},showFlyingHero:function(url){if(!url){return}BX.ajax({method:"GET",dataType:"html",url:this.helpUrl+url,data:{},onsuccess:BX.proxy(function(res){if(res){BX.load([this.runtimeUrl],function(){eval(res)})}},this)})},setNotification:function(a,b){BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:{sessid:BX.bitrix_sessid(),action:"setNotify",num:a,time:b},onsuccess:BX.proxy(function(c){},this)})},checkNotification:function(){BX.ajax({method:"POST",dataType:"json",url:this.notifyUrl,data:this.notifyData,onsuccess:BX.proxy(function(a){if(!isNaN(a.num)){this.showNotification(a.num);if(a.id){this.notifyId=a.id;this.notifyText=a.body;this.notifyButton=a.button}if(a.url){this.showFlyingHero(a.url)}}else{this.setNotification("","hour")}},this),onfailure:BX.proxy(function(){this.setNotification("","hour")},this)})},showAnimatedHero:function(){if(!BX.browser.IsIE8()){BX.load(["/bitrix/js/main/helper/runtime.js","/bitrix/js/main/helper/hero_object.js"],function(){var b=BX.create("div",{attrs:{className:"bx-help-start",id:"bx-help-start"}});if(BX.admin&&BX.admin.panel){b.style.top=BX.admin.panel.DIV.offsetHeight+50+"px"}document.body.appendChild(b);var a=new swiffy.Stage(b,swiffyobject,{});a.setBackground(null);setTimeout(function(){a.start()},300);setTimeout(function(){b.style.display="none"},7300)})}}};