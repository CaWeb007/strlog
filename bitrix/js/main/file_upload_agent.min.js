(function(){var a=window.BX;if(a.FileUploadAgent){return}a.FileUploadAgent=function(b){this.controller=(!!b.controller)?b.controller:null;this.inputName=(!!b.inputName)?b.inputName:null;this.urlUpload=(!!b.urlUpload)?b.urlUpload:null;this.urlShow=(!!b.urlShow)?b.urlShow:null;this.values=(a.type.isArray(b.values))?b.values:[];this.fileInputID=(!!b.fileInput)?b.fileInput:null;this.fileInputName=(!!b.fileInputName)?b.fileInputName:null;this.placeholder=(!!b.placeholder)?b.placeholder:null;this.uploadDialog=(!!b.uploadDialog)?b.uploadDialog:null;this.msg=b.msg;this.fileInput=null;this.uploadFile=null;this.droppedFiles=null;this.place=null;this.progress=null;this.progressPercent=0.05;this.progressAnimation=null;this.parent=b;this.uploadResultShown=false;this.loaded=false;this.hAttachEvents=(!!b.hAttachEvents)?b.hAttachEvents:null;this.caller=(!!b.caller)?b.caller:null;this.classes=(!!b.classes?b.classes:{uploaderParent:"",uploader:"",tpl_simple:"",tpl_extended:"",selector:"",selector_active:""});this.doc_prefix=(!!b.doc_prefix?b.doc_prefix:"");if(!!b.mode){this.SelectViewVariant(b.mode)}this.id=this.getID();if(!this.parent._mkFileInput){this._mkFileInput()}if(!window.wduf_places){window.wduf_places={}}};a.FileUploadAgent.prototype.Init=function(){if(a.type.isDomNode(this.fileInput)){this.fileInput=this.fileInput}else{if(a.type.isDomNode(this.fileInputID)){this.fileInput=this.fileInputID}else{if(this.fileInputID){this.fileInput=a(this.fileInputID)}}}if(this.fileInput){if(!this.hUploaderChange){this.hUploaderChange=a.proxy(this.onUploaderChange,this)}a.bind(this.fileInput,"change",this.hUploaderChange)}if(this.hAttachEvents&&a.type.isFunction(this.hAttachEvents)){this.hAttachEvents(this)}};a.FileUploadAgent.prototype.getID=function(){return(""+new Date().getTime()).substr(6)};a.FileUploadAgent.prototype._mkClose=function(b){if(!b){return false}var g=null;var e=a.create("SPAN",{props:{className:"del-but"}});var d=a.findChild(b,{className:"loading"},true);var c=a.findChild(b,{className:"files-storage-block"},true);if(!!d){g=d}else{if(!!c){g=c}}if(!!g){var f=b;a.bind(e,"click",a.delegate(function(){this.StopUpload(f)},this));g.appendChild(e)}};a.FileUploadAgent.prototype._mkPlace=function(b,d){if(!d){d=b}if((d in window.wduf_places)&&!!window.wduf_places[d]){this.place=window.wduf_places[d];this.progress=a.findChild(this.place,{className:"load-indicator"},true)}else{this.progress=a.create("SPAN",{props:{className:"load-indicator"},style:{width:"5%"},children:[a.create("SPAN",{props:{className:"load-number"},text:"5%"})]});var c=a.create("SPAN",{props:{className:"loading-wrap"},children:[a.create("SPAN",{props:{className:"loading"}}),this.progress]});this.place=a.create("TR",{children:[a.create("TD",{props:{className:"files-name"},children:[a.create("SPAN",{props:{className:"files-text"},children:[a.create("SPAN",{props:{className:"f-wrap"},text:b})]})]}),a.create("TD",{props:{className:"files-storage"},attrs:{colspan:"2"},children:[a.create("SPAN",{text:this.msg.loading+":"}),c]})]});this._mkClose(this.place);this.placeholder.appendChild(this.place);window.wduf_places[d]=this.place}};a.FileUploadAgent.prototype._mkFileInput=function(e){var d=a.findChild(this.controller,{className:this.classes.uploaderParent},true);var c=a.findChild(d,{className:this.classes.uploader});if(c){a.remove(c)}var b=a.create("INPUT",{props:{className:this.classes.uploader},attrs:{type:"file",size:"1",multiple:"multiple"}});this.fileInput=b;this.fileInput.name=this.fileInputName;d.appendChild(this.fileInput);if(this.hUploaderChange){a.bind(this.fileInput,"change",this.hUploaderChange)}return this.fileInput};a.FileUploadAgent.prototype.onUploaderChange=function(b){if(!this.uploadDialog){return}a.onCustomEvent(this.controller.parentNode,"ChangeFileInput",[b,this.fileInput,this]);a.onCustomEvent(this,"ChangeFileInput",[b,this.fileInput,this]);this.uploadDialog.SetFileInput(this.fileInput);if(!!this.uploadDialog.dropbox){this.UploadDroppedFiles(this.fileInput.files)}else{this.uploadDialog.CallSubmit()}};a.FileUploadAgent.prototype.onUploadStart=function(b){name=b.GetUploadFileName();if((!this.uploadDialog)||(b.id!=this.uploadDialog.id)){return false}if(!this.place){this._mkPlace(name)}if(!this.uploadFile){this._mkFileInput();var c=this.GetNewObject();c.LoadDialogs(this.dialogs)}this.uploadFile=null};a.FileUploadAgent.prototype.onProgress=function(b,c){if(isNaN(b)){return}if(b>0.9&&!c){b=0.9}if(!a.fx){this.UpdateProgressIndicator(b)}else{if(!this.progressAnimation){this.progressAnimation=new a.fx({start:this.progressPercent,finish:b,allowFloat:true,type:function(d){return(a.fx.RULES.accelerated(d)+a.fx.RULES.decelerated(d))/2},time:3,step:0.01,callback:a.delegate(function(d){this.UpdateProgressIndicator(d)},this)});this.progressAnimation.start()}else{this.progressAnimation.stop(true);this.progressAnimation.options.start=+this.progressPercent;this.progressAnimation.options.finish=+b;this.progressAnimation.__checkOptions();this.progressAnimation.start()}}};a.FileUploadAgent.prototype.onUploadFinish=function(b){this.uploadResult=b;this.onProgress(2,true)};a.FileUploadAgent.prototype.UpdateProgressIndicator=function(c){if(this.progressPercent>c){return}var d=Math.ceil(c*100);if(d>100){d=100}a.style(this.progress,"width",d+"%");var b=a.findChild(this.progress,{className:"load-number"},true);b.innerHTML=d+"%";this.progressPercent=c;if(c>0.9999){if(this.uploadResult&&(!this.uploadResultShown)){this.uploadResultShown=true;if(this.uploadResult.success){this.ShowUploadedFile()}else{if(!!this.uploadResult.messages){this.ShowUploadError(this.uploadResult.messages)}}}}};a.FileUploadAgent.prototype.ShowAttachedFiles=function(){var d=null;if(!this.values){return}var c=this.values.slice();d=this.values.shift();if(!!d){if(a.type.isDomNode(d)){sID=d.id;mID=sID.match(new RegExp(this.doc_prefix+"(\\d+)"));if(!!mID){id=mID[1];this.BindLoadedFileControls(id,d)}}else{if(!d.element_id){d={element_id:d}}this.uploadResultArr=new Array();for(var b=0;b<c.length;b++){element_id=c[b];if(typeof(c[b])=="object"){element_id=c[b].element_id}this._mkPlace("",element_id);this.uploadResultArr[b]={element_id:c[b].element_id,element_url:c[b].element_url,element_name:c[b].element_name,place:this.place}}this.ShowUploadedFile(d);this.values=[]}}};a.FileUploadAgent.prototype.BindLoadedFileControls=function(c,b){this.place=b;this._mkClose(b);a.onCustomEvent(this.caller,"BindLoadedFileControls",[this,c]);this._clearPlace();setTimeout(a.delegate(this.ShowAttachedFiles,this),200)};a.FileUploadAgent.prototype.ShowUploadError=function(b){if(!!b){if(a.type.isArray(b)){b=b.join("\n")}b=b.replace("<br>","");a.remove(this.progress.parentNode);if(!!b){a.addClass(this.place,"error-load");while(this.place.cells.length>1){this.place.deleteCell(1)}var c=this.place.insertCell(-1);c.setAttribute("colspan",2);c.appendChild(a.create("SPAN",{props:{className:"info-icon"}}));c.appendChild(a.create("SPAN",{props:{className:"error-text"},text:b}));this._mkClose(this.place)}}};a.FileUploadAgent.prototype.ShowUploadedFile=function(b){if(!!b){this.uploadResult=b}a.onCustomEvent(this.caller,"ShowUploadedFile",[this])};a.FileUploadAgent.prototype.AddRowToPlaceholder=function(g){var f=a.findChildren(this.placeholder,{tagName:"TR"},true);if(!!f){for(var e=0;e<f.length;e++){if(f[e]==this.place){var d=this.placeholder.insertRow(e);d.className=g.className;d.id=g.id;var c=a.findChildren(g,{tagName:"TD"},true);if(!!c){for(var b=0;b<c.length;b++){var h=d.insertCell(-1);h.className=c[b].className;h.innerHTML=c[b].innerHTML}}a.cleanNode(this.place,true);this._clearPlace();this._mkClose(d);setTimeout(a.delegate(this.ShowAttachedFiles,this),200);break}}}};a.FileUploadAgent.prototype.AddNodeToPlaceholder=function(c){a.cleanNode(this.place,true);this._clearPlace();var b=this.placeholder.parentNode.parentNode;b.appendChild(c)};a.FileUploadAgent.prototype._clearPlace=function(){for(i in window.wduf_places){if(window.wduf_places[i]==this.place){window.wduf_places[i]=false}}this.place=null};a.FileUploadAgent.prototype.StopUpload=function(d){var b=d;a.hide(b);a.onCustomEvent(this.caller,"StopUpload",[this,b]);sID=d.id;mID=sID.match(new RegExp(this.doc_prefix+"(\\d+)"));if(!!mID){id=mID[1];var c=a("file-doc"+id);if(!!c){a.remove(c)}}};a.FileUploadAgent.prototype.LoadScript=function(b,c){if(!c){c=a.DoNothing}if(!window.loaded_scripts){window.loaded_scripts=[]}if(!a.util.in_array(b,window.loaded_scripts)){a.loadScript(b,c);window.loaded_scripts.push(b)}};a.FileUploadAgent.prototype.BindUploadEvents=function(d){this.LoadDialogsFinished();if(d.parentID!=this.id){return}this.uploadDialog=d;a.addCustomEvent(d,"uploadStart",a.delegate(this.onUploadStart,this));a.addCustomEvent(d,"progress",a.delegate(this.onProgress,this));a.addCustomEvent(d,"uploadFinish",a.delegate(this.onUploadFinish,this));if(!!this.parent.droppedFiles){for(var c=0;c<this.parent.droppedFiles.length;c++){if(!this.parent.droppedFiles[c].ready){this.parent.droppedFiles[c].ready=true;this.uploadFile=this.parent.droppedFiles[c];if((c)<this.parent.droppedFiles.length){var e=this.GetNewObject(this.parent);e.LoadDialogs(this.dialogs)}break}}if(this.uploadFile){if(this.fileInput){a.unbind(this.fileInput,"change",this.hUploaderChange)}var b=(this.uploadFile.fileName||this.uploadFile.name);this._mkPlace(b)}}if(!!this.uploadFile){this.uploadDialog.fileDropped=true;this.uploadDialog.UpdateListFiles([this.uploadFile])}};a.FileUploadAgent.prototype.UploadDroppedFiles=function(d){if(!this.uploadDialog){return}this.droppedFiles=d;if(d.length>0){for(var b=0;b<d.length;b++){this._mkPlace(d[b].fileName||d[b].name)}this.uploadDialog.SetFileInput(this.fileInput);this._mkFileInput()}var c=this.GetNewObject();c.LoadDialogs(this.dialogs)};a.FileUploadAgent.prototype.AddSelectedFiles=function(c){if(!!c&&a.type.isArray(c)&&(c.length>0)){for(i in c){if((!a(this.doc_prefix+c.id))){this._mkPlace(c[i].name,c[i].id);var b={element_id:c[i].id,element_url:c[i].link};this.values.push(b)}}if(this.values.length>0){this.ShowAttachedFiles()}}};a.FileUploadAgent.prototype.Disable=function(){a.cleanNode(this.controller);this.controller.innerHTML=this.msg.access_denied};a.FileUploadAgent.prototype.LoadUploadDialog=function(){if(!!this.caller){this.caller.GetUploadDialog(this)}};a.FileUploadAgent.prototype.SelectViewVariant=function(b){var d={simple:this.classes.tpl_simple,extended:this.classes.tpl_extended};for(i in d){var c=a.findChild(this.controller,{className:d[i]},true);if(!!c){if(b==i){a.show(c)}else{a.remove(c)}}}};a.FileUploadAgent.prototype.LoadDialogsFinished=function(){this.ShowAttachedFiles()};a.FileUploadAgent.prototype.LoadDialogs=function(e){if(this.loaded){return false}this.loaded=true;if(!e){return false}this.dialogs=e;if((e.indexOf("DropInterface")>-1)&&(!this.parent||!this.parent.droppedFiles)){if(!!window.BX.DD){var c=this.controller;if(!c){return false}var b=new a.DD.dropFiles(c);if(b&&b.supported()&&a.ajax.FormData.isSupported()){this.dropbox=b;this.Init();var d=a.findChild(this.controller,{className:this.classes.selector},true);a.addCustomEvent(b,"dropFiles",a.delegate(this.UploadDroppedFiles,this));a.addCustomEvent(b,"dragEnter",a.delegate(function(){a.addClass(d,this.classes.selector_active)},this));a.addCustomEvent(b,"dragLeave",a.delegate(function(){a.removeClass(d,this.classes.selector_active)},this))}else{this.Init()}this.LoadUploadDialog()}}else{this.LoadUploadDialog()}if(this.values.length>0){a.show(this.controller)}};a.FileUploadAgent.prototype.GetNewObject=function(b){return new a.FileUploadAgent((!!b?b:this))}})();